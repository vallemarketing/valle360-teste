"use strict";(()=>{var e={};e.id=69877,e.ids=[69877],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},11298:(e,a,t)=>{t.r(a),t.d(a,{originalPathname:()=>v,patchFetch:()=>b,requestAsyncStorage:()=>w,routeModule:()=>y,serverHooks:()=>S,staticGenerationAsyncStorage:()=>h});var i={};t.r(i),t.d(i,{POST:()=>g,dynamic:()=>u});var r=t(49303),s=t(88716),n=t(60670),l=t(87070),o=t(20344),m=t(71615),d=t(90176);let u="force-dynamic",c="Valle@Teste2024";function p(e){let a=(e||[]).map(e=>String(e).toLowerCase());return a.includes("rh")?"hr":a.some(e=>e.includes("financeiro"))?"finance":a.includes("comercial")?"sales":a.some(e=>e.includes("designer")||e.includes("design"))?"design":a.some(e=>e.includes("social")||e.includes("trafego")||e.includes("marketing"))?"social_media":"admin"}let _=[{email:"social.media@valle360.com.br",full_name:"Social Media (Teste)",department:p(["social_media"]),areas:["social_media"]},{email:"head.marketing@valle360.com.br",full_name:"Head Marketing (Teste)",department:p(["head_marketing"]),areas:["head_marketing"]},{email:"joao.comercial@valle360.com.br",full_name:"Jo\xe3o Comercial (Teste)",department:p(["comercial"]),areas:["comercial"]},{email:"maria.trafego@valle360.com.br",full_name:"Maria Tr\xe1fego (Teste)",department:p(["trafego_pago"]),areas:["trafego_pago"]},{email:"carlos.designer@valle360.com.br",full_name:"Carlos Designer (Teste)",department:p(["designer_grafico"]),areas:["designer_grafico"]},{email:"ana.head@valle360.com.br",full_name:"Ana Head Marketing (Teste)",department:p(["head_marketing"]),areas:["head_marketing"]},{email:"paula.rh@valle360.com.br",full_name:"Paula RH (Teste)",department:p(["rh"]),areas:["rh"]},{email:"roberto.financeiro@valle360.com.br",full_name:"Roberto Financeiro (Teste)",department:p(["financeiro_pagar","financeiro_receber"]),areas:["financeiro_pagar","financeiro_receber"]}];async function f(e,a){try{let{data:t}=await e.auth.admin.listUsers({page:1,perPage:5,search:a}),i=(t?.users||[]).find(e=>String(e?.email||"").toLowerCase()===a.toLowerCase());if(i?.id)return String(i.id)}catch{}for(let t=1;t<=25;t++){let{data:i,error:r}=await e.auth.admin.listUsers({page:t,perPage:200});if(r)break;let s=(i?.users||[]).find(e=>String(e?.email||"").toLowerCase()===a.toLowerCase());if(s?.id)return String(s.id);if((i?.users||[]).length<200)break}return null}async function g(e){try{let e=(0,m.cookies)(),t=(0,o.createRouteHandlerClient)({cookies:()=>e}),{data:i}=await t.auth.getUser(),r=i.user?.id;if(!r)return l.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:s,error:n}=await t.rpc("is_admin");if(n||!s)return l.NextResponse.json({error:"Acesso negado (admin)"},{status:403});let u=(0,d.t)(),p=[],g=[],y=[];async function a(e){let a=e.toLowerCase();try{let{data:e}=await u.from("users").select("id,email").eq("email",a).maybeSingle();if(e?.id)return String(e.id)}catch{}try{let{data:e}=await u.from("user_profiles").select("user_id,email,id").eq("email",a).maybeSingle();if(e?.user_id)return String(e.user_id);if(e?.id)return String(e.id)}catch{}try{let{data:e}=await u.from("employees").select("user_id,email").eq("email",a).maybeSingle();if(e?.user_id)return String(e.user_id)}catch{}try{let{data:e}=await u.from("clients").select("user_id,contact_email,email").or(`email.eq.${a},contact_email.eq.${a}`).maybeSingle();if(e?.user_id)return String(e.user_id)}catch{}return null}for(let e of _){let t=null;try{if(!(t=await f(u,e.email)||await a(e.email))){let{data:i,error:r}=await u.auth.admin.createUser({email:e.email,password:c,email_confirm:!0,user_metadata:{full_name:e.full_name,user_type:"employee",role:"employee"}});if(r||!i.user?.id){let i=String(r?.message||"");if(i.toLowerCase().includes("already been registered")||i.toLowerCase().includes("already registered")){if(!(t=await f(u,e.email)||await a(e.email)))throw Error(`Usu\xe1rio j\xe1 existe no Auth, mas n\xe3o consegui resolver o ID por email (${e.email}).`);y.push({email:e.email,warning:"Usu\xe1rio j\xe1 existia; senha foi redefinida."})}else throw Error(r?.message||`Falha ao criar auth user (${e.email})`)}else t=String(i.user.id)}t&&await u.auth.admin.updateUserById(t,{password:c,email_confirm:!0,user_metadata:{full_name:e.full_name,user_type:"employee",role:"employee"}})}catch(a){y.push({email:e.email,warning:a?.message||"Falha ao criar/reativar"});continue}if(!t){y.push({email:e.email,warning:"N\xe3o foi poss\xedvel resolver userId."});continue}await u.from("users").upsert({id:t,email:e.email,full_name:e.full_name,name:e.full_name,role:"employee",user_type:"employee",account_status:"active",is_active:!0,email_verified:!0,created_by:r,updated_at:new Date().toISOString()},{onConflict:"id"}),await u.from("user_profiles").upsert({id:t,user_id:t,email:e.email,full_name:e.full_name,user_type:"employee",role:"employee",is_active:!0,updated_at:new Date().toISOString(),metadata:{created_as_test:!0,areas:e.areas}},{onConflict:"user_id"});let i=null;try{let{data:a,error:r}=await u.from("employees").upsert({user_id:t,full_name:e.full_name,email:e.email,department:e.department,position:"Colaborador",areas:e.areas,is_active:!0,updated_at:new Date().toISOString(),metadata:{created_as_test:!0,department_label:e.department,areas:e.areas}},{onConflict:"email"}).select("id").maybeSingle();if(r)throw r;i=a}catch(r){let{data:a}=await u.from("employees").upsert({user_id:t,full_name:e.full_name,email:e.email,position:"Colaborador",is_active:!0,updated_at:new Date().toISOString()},{onConflict:"email"}).select("id").maybeSingle();i=a}g.push({email:e.email,user_id:t,employee_id:i?.id||null}),p.push({email:e.email,password:c,type:"employee"})}let w="cliente@teste.com.br",h="Cliente Teste (Provis\xf3rio)",S=await f(u,w);if(S)await u.auth.admin.updateUserById(S,{password:c,email_confirm:!0,user_metadata:{full_name:h,user_type:"client",role:"client"}});else{let{data:e,error:a}=await u.auth.admin.createUser({email:w,password:c,email_confirm:!0,user_metadata:{full_name:h,user_type:"client",role:"client"}});if(a||!e.user?.id)throw Error(a?.message||`Falha ao criar auth user (${w})`);S=String(e.user.id)}await u.from("users").upsert({id:S,email:w,full_name:h,name:h,role:"client",user_type:"client",account_status:"active",is_active:!0,email_verified:!0,created_by:r,updated_at:new Date().toISOString()},{onConflict:"id"}),await u.from("user_profiles").upsert({id:S,user_id:S,email:w,full_name:h,user_type:"client",role:"client",is_active:!0,updated_at:new Date().toISOString(),metadata:{created_as_test:!0}},{onConflict:"user_id"});let{data:v}=await u.from("clients").select("id").eq("user_id",S).maybeSingle(),b=null;if(v?.id){let{data:e}=await u.from("clients").update({company_name:h,contact_name:h,contact_email:w,email:w,status:"active",updated_at:new Date().toISOString()}).eq("id",v.id).select("id").single();b=e?.id?String(e.id):String(v.id)}else{let{data:e}=await u.from("clients").insert({user_id:S,company_name:h,contact_name:h,contact_email:w,contact_phone:"(11) 99999-0000",city:"S\xe3o Paulo",state:"SP",status:"active",email:w,whatsapp:"(11) 99999-0000",nome_fantasia:h,razao_social:`${h} Ltda`,tipo_pessoa:"juridica",cpf_cnpj:"00.000.000/0001-00",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select("id").single();b=e?.id?String(e.id):null}return p.push({email:w,password:c,type:"client"}),l.NextResponse.json({success:!0,password:c,users:g,credentials:p,warnings:y,client:{email:w,user_id:S,client_id:b}})}catch(e){return l.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let y=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/provision-test-employees/route",pathname:"/api/admin/provision-test-employees",filename:"route",bundlePath:"app/api/admin/provision-test-employees/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\provision-test-employees\\route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:w,staticGenerationAsyncStorage:h,serverHooks:S}=y,v="/api/admin/provision-test-employees/route";function b(){return(0,n.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:h})}},90176:(e,a,t)=>{t.d(a,{t:()=>r});var i=t(54128);function r(){let e="https://ikjgsqtykkhqimypacro.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!a)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,i.eI)(e,a,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var a=require("../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),i=a.X(0,[89276,55972,54128,20958],()=>t(11298));module.exports=i})();