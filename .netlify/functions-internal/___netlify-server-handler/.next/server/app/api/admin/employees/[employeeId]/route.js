"use strict";(()=>{var e={};e.id=96354,e.ids=[96354],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},4285:(e,a,o)=>{o.r(a),o.d(a,{originalPathname:()=>x,patchFetch:()=>w,requestAsyncStorage:()=>h,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f});var s={};o.r(s),o.d(s,{DELETE:()=>m,GET:()=>p,PATCH:()=>_,dynamic:()=>u});var t=o(49303),r=o(88716),n=o(60670),l=o(87070),i=o(17478),c=o(90176);let u="force-dynamic";async function d(e){let a=process.env.CPANEL_USER,o=process.env.CPANEL_PASSWORD,s=process.env.CPANEL_DOMAIN;if(console.log(`ðŸ—‘ï¸ Tentando deletar email do cPanel: ${e}`),console.log(`ðŸ“‹ cPanel configurado: ${!!a&&!!o&&!!s}`),!a||!o||!s)return console.warn("âš ï¸ Credenciais do cPanel n\xe3o configuradas"),{success:!1,message:"cPanel n\xe3o configurado"};try{let[t,r]=e.split("@");if(!t||!r)return{success:!1,message:"Email inv\xe1lido"};let n=Buffer.from(`${a}:${o}`).toString("base64"),l=s.trim();/^https?:\/\//i.test(l)||(l=`https://${l}`),(l=l.replace(/\/+$/,"")).includes(":2083")||l.includes(":2087")||(l=l.replace(/:\d+$/,"")+":2083");let i=`${l}/execute/Email/delete_pop?email=${encodeURIComponent(t)}&domain=${encodeURIComponent(r)}`;console.log(`ðŸ”— URL cPanel: ${i}`);let c=await fetch(i,{method:"GET",headers:{Authorization:`Basic ${n}`}}),u=c.headers.get("content-type")||"",d=await c.text();if(console.log(`ðŸ“¥ cPanel response status: ${c.status}`),console.log(`ðŸ“¥ cPanel response type: ${u}`),console.log(`ðŸ“¥ cPanel response: ${d.substring(0,500)}`),!u.includes("application/json"))return console.error("âŒ cPanel retornou HTML (provavelmente URL incorreta ou auth falhou)"),{success:!1,message:"cPanel retornou HTML - verifique CPANEL_DOMAIN"};let p=JSON.parse(d);if(1===p.status||p.result?.status===1)return console.log(`âœ… Email deletado do cPanel: ${e}`),{success:!0,message:"Email deletado do cPanel"};{let a=p.errors||p.result?.errors||[],o=Array.isArray(a)?a.join(", "):String(a);if(o.toLowerCase().includes("does not exist")||o.toLowerCase().includes("not found"))return console.log(`â„¹ï¸ Email j\xe1 n\xe3o existe no cPanel: ${e}`),{success:!0,message:"Email n\xe3o existe no cPanel"};return console.error("âŒ Erro ao deletar email do cPanel:",o),{success:!1,message:o||"Erro desconhecido"}}}catch(e){return console.error("âŒ Exce\xe7\xe3o ao deletar email do cPanel:",e),{success:!1,message:e.message}}}async function p(e,{params:a}){let o=await (0,i.k)(e);if(!o.ok)return o.res;let{employeeId:s}=a,t=(0,c.t)();try{let e=null,{data:a}=await t.from("employees").select("*").eq("user_id",s).single();if(a)e=a;else{let{data:a}=await t.from("employees").select("*").eq("id",s).single();a&&(e=a)}if(!e)return l.NextResponse.json({error:"Colaborador n\xe3o encontrado"},{status:404});let o=e.user_id,{data:r}=await t.from("users").select("*").eq("id",o).single(),{data:n}=await t.from("user_profiles").select("*").eq("user_id",o).single();return l.NextResponse.json({employee:e,user:r,profile:n})}catch(e){return l.NextResponse.json({error:e.message},{status:500})}}async function m(e,{params:a}){let o=await (0,i.k)(e);if(!o.ok)return o.res;let{employeeId:s}=a,t=(0,c.t)();console.log(`
${"=".repeat(50)}`),console.log(`ðŸ—‘ï¸ INICIANDO EXCLUS\xc3O DO COLABORADOR: ${s}`),console.log(`${"=".repeat(50)}
`);let r=[],n="";try{console.log("\uD83D\uDCCB 1. Buscando dados do colaborador...");let{data:e,error:a}=await t.from("employees").select("id, user_id, first_name, last_name").eq("user_id",s).single();if(a||!e){let{data:e}=await t.from("employees").select("id, user_id, first_name, last_name").eq("id",s).single();if(!e)return console.log("âŒ Colaborador n\xe3o encontrado"),l.NextResponse.json({error:"Colaborador n\xe3o encontrado"},{status:404})}let o=e?.user_id||s;r.push(`Colaborador encontrado: ${e?.first_name} ${e?.last_name}`),console.log("\uD83D\uDCE7 2. Buscando email do usu\xe1rio...");let{data:i}=await t.from("users").select("email").eq("id",o).single();if(i?.email&&(n=i.email,console.log(`   Email encontrado (users): ${n}`)),!n){let{data:e}=await t.from("user_profiles").select("email").eq("user_id",o).single();e?.email&&(n=e.email,console.log(`   Email encontrado (user_profiles): ${n}`))}if(!n)try{let{data:e}=await t.auth.admin.getUserById(o);e?.user?.email&&(n=e.user.email,console.log(`   Email encontrado (auth): ${n}`))}catch(e){console.log("   N\xe3o foi poss\xedvel buscar do auth")}if(r.push(`Email: ${n||"n\xe3o encontrado"}`),n&&n.includes("@")){console.log("\uD83D\uDDD1ï¸ 3. Deletando email do cPanel...");let e=await d(n);r.push(`cPanel: ${e.message}`),console.log(`   Resultado: ${e.message}`)}else console.log("âš ï¸ 3. Email n\xe3o encontrado, pulando cPanel"),r.push("cPanel: pulado (sem email)");console.log("\uD83D\uDDC3ï¸ 4. Deletando registros do banco...");let{error:c}=await t.from("employee_client_assignments").delete().eq("employee_id",o);c||(r.push("employee_client_assignments: deletado"),console.log("   âœ… employee_client_assignments deletado"));let{error:u}=await t.from("employees").delete().eq("user_id",o);u?console.error("   âŒ Erro ao deletar employees:",u):(r.push("employees: deletado"),console.log("   âœ… employees deletado"));let{error:p}=await t.from("user_profiles").delete().eq("user_id",o);p?console.error("   âŒ Erro ao deletar user_profiles:",p):(r.push("user_profiles: deletado"),console.log("   âœ… user_profiles deletado"));let{error:m}=await t.from("users").delete().eq("id",o);m?console.error("   âŒ Erro ao deletar users:",m):(r.push("users: deletado"),console.log("   âœ… users deletado")),console.log("\uD83D\uDD10 5. Deletando do Supabase Auth...");try{let{error:e}=await t.auth.admin.deleteUser(o);e?(r.push(`auth.users: erro - ${e.message}`),console.error("   âŒ Erro ao deletar auth:",e.message)):(r.push("auth.users: deletado"),console.log("   âœ… auth.users deletado"))}catch(e){r.push(`auth.users: exce\xe7\xe3o - ${e.message}`),console.error("   âŒ Exce\xe7\xe3o ao deletar auth:",e.message)}return console.log(`
${"=".repeat(50)}`),console.log(`âœ… EXCLUS\xc3O FINALIZADA`),console.log(`${"=".repeat(50)}
`),l.NextResponse.json({success:!0,message:"Colaborador exclu\xeddo completamente",deleted:{id:o,name:`${e?.first_name||""} ${e?.last_name||""}`.trim(),email:n},log:r})}catch(e){return console.error("âŒ ERRO FATAL na exclus\xe3o:",e),l.NextResponse.json({success:!1,error:e.message,log:r},{status:500})}}async function _(e,{params:a}){let o=await (0,i.k)(e);if(!o.ok)return o.res;let{employeeId:s}=a,t=(0,c.t)(),r=await e.json();try{let e=null,{data:a}=await t.from("employees").select("id,user_id").eq("user_id",s).single();if(a)e=a;else{let{data:a}=await t.from("employees").select("id,user_id").eq("id",s).single();a&&(e=a)}if(!e?.user_id)return l.NextResponse.json({error:"Colaborador n\xe3o encontrado"},{status:404});let o=e.user_id;(r.first_name||r.last_name||r.areas||r.whatsapp||r.personal_email||r.phone||r.cpf||r.birth_date||r.hierarchy_level||void 0!==r.salary||r.work_schedule||r.pix_key||r.pix_type||r.bank_name||r.bank_agency||r.bank_account||r.bank_account_type||r.emergency_contact_name||r.emergency_contact_phone||r.emergency_contact_relation||void 0!==r.is_active)&&await t.from("employees").update({...r.first_name&&{first_name:r.first_name},...r.last_name&&{last_name:r.last_name},...r.areas&&{areas:r.areas},...r.whatsapp&&{whatsapp:r.whatsapp},...r.personal_email&&{personal_email:r.personal_email},...r.phone&&{phone:r.phone},...r.cpf&&{cpf:r.cpf},...r.birth_date&&{birth_date:r.birth_date},...r.hierarchy_level&&{hierarchy_level:r.hierarchy_level},...void 0!==r.salary&&{salary:r.salary},...r.work_schedule&&{work_schedule:r.work_schedule},...r.pix_key&&{pix_key:r.pix_key},...r.pix_type&&{pix_type:r.pix_type},...r.bank_name&&{bank_name:r.bank_name},...r.bank_agency&&{bank_agency:r.bank_agency},...r.bank_account&&{bank_account:r.bank_account},...r.bank_account_type&&{bank_account_type:r.bank_account_type},...r.emergency_contact_name&&{emergency_contact_name:r.emergency_contact_name},...r.emergency_contact_phone&&{emergency_contact_phone:r.emergency_contact_phone},...r.emergency_contact_relation&&{emergency_contact_relation:r.emergency_contact_relation},...void 0!==r.is_active&&{is_active:r.is_active},updated_at:new Date().toISOString()}).eq("user_id",o);let n=null;if(r.personal_email){let{data:e}=await t.from("user_profiles").select("metadata").eq("user_id",o).single();n={...e?.metadata||{},personal_email:r.personal_email}}return(r.full_name||r.phone||void 0!==r.avatar_url||n)&&await t.from("user_profiles").update({...r.full_name&&{full_name:r.full_name},...r.phone&&{phone:r.phone},...void 0!==r.avatar_url&&{avatar_url:r.avatar_url},...n?{metadata:n}:{},updated_at:new Date().toISOString()}).eq("user_id",o),(r.full_name||r.phone)&&await t.from("users").update({...r.full_name&&{full_name:r.full_name,name:r.full_name},...r.phone&&{phone:r.phone},...r.account_status&&{account_status:r.account_status}}).eq("id",o),r.password&&await t.auth.admin.updateUserById(o,{password:r.password}),l.NextResponse.json({success:!0,message:"Colaborador atualizado"})}catch(e){return l.NextResponse.json({error:e.message},{status:500})}}let g=new t.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/admin/employees/[employeeId]/route",pathname:"/api/admin/employees/[employeeId]",filename:"route",bundlePath:"app/api/admin/employees/[employeeId]/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\employees\\[employeeId]\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:f,serverHooks:y}=g,x="/api/admin/employees/[employeeId]/route";function w(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},90176:(e,a,o)=>{o.d(a,{t:()=>t});var s=o(54128);function t(){let e="https://ikjgsqtykkhqimypacro.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!a)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,s.eI)(e,a,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},17478:(e,a,o)=>{o.d(a,{k:()=>l});var s=o(87070),t=o(20344),r=o(71615),n=o(54128);async function l(e){let a=(0,r.cookies)(),o=(0,t.createRouteHandlerClient)({cookies:()=>a}),l=e.headers.get("authorization")||"",i=l.toLowerCase().startsWith("bearer ")?l.slice(7).trim():null,c=i?(0,n.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${i}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):o,{data:u}=await c.auth.getUser();if(!u.user?.id)return{ok:!1,res:s.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:d,error:p}=await c.rpc("is_admin");return p||!d?{ok:!1,res:s.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:u.user.id}}}};var a=require("../../../../../webpack-runtime.js");a.C(e);var o=e=>a(a.s=e),s=a.X(0,[89276,55972,54128,20958],()=>o(4285));module.exports=s})();