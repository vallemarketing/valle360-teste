"use strict";(()=>{var e={};e.id=73920,e.ids=[73920],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},17329:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>_,patchFetch:()=>f,requestAsyncStorage:()=>v,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var r={};a.r(r),a.d(r,{GET:()=>p,dynamic:()=>d});var n=a(49303),o=a(88716),i=a(60670),s=a(87070),c=a(20344),u=a(71615),l=a(90176);let d="force-dynamic";async function p(e){try{let t,a,r;let n=(0,u.cookies)(),o=(0,c.createRouteHandlerClient)({cookies:()=>n}),{data:i}=await o.auth.getUser(),d=i?.user;if(!d)return s.NextResponse.json({success:!1,error:"N\xe3o autorizado"},{status:401});let p=(0,l.t)(),{data:m}=await p.from("user_profiles").select("role").eq("user_id",d.id).maybeSingle(),v=m?.role;if(!["super_admin","admin","gerente","diretoria"].includes(v))return s.NextResponse.json({success:!1,error:"Acesso negado"},{status:403});let{searchParams:g}=new URL(e.url),h=g.get("period")||"month",_=new Date;switch(h){case"week":t=new Date(_.getTime()-6048e5),a=new Date(_.getTime()-12096e5),r=t;break;case"quarter":t=new Date(_.getFullYear(),3*Math.floor(_.getMonth()/3),1),a=new Date(t.getTime()-7776e6),r=t;break;case"year":t=new Date(_.getFullYear(),0,1),a=new Date(_.getFullYear()-1,0,1),r=new Date(_.getFullYear()-1,11,31);break;default:t=new Date(_.getFullYear(),_.getMonth(),1),a=new Date(_.getFullYear(),_.getMonth()-1,1),r=new Date(_.getFullYear(),_.getMonth(),0)}let f={revenue:{current:0,previous:0,change:0,target:0,progress:0},clients:{total:0,active:0,new_this_month:0,churn_rate:0,health_avg:0},operations:{tasks_completed:0,tasks_pending:0,sla_compliance:0,avg_delivery_time:0},finance:{mrr:0,arr:0,overdue_invoices:0,overdue_amount:0,collection_rate:0},team:{total_members:0,productivity_score:0,utilization_rate:0}};try{let{data:e}=await p.from("invoices").select("amount").eq("status","paid").gte("paid_at",t.toISOString());f.revenue.current=(e||[]).reduce((e,t)=>e+Number(t.amount||0),0);let{data:n}=await p.from("invoices").select("amount").eq("status","paid").gte("paid_at",a.toISOString()).lt("paid_at",r.toISOString());f.revenue.previous=(n||[]).reduce((e,t)=>e+Number(t.amount||0),0),f.revenue.change=f.revenue.previous>0?Math.round((f.revenue.current-f.revenue.previous)/f.revenue.previous*1e3)/10:0,f.revenue.target=1.1*f.revenue.current,f.revenue.progress=Math.min(100,Math.round(f.revenue.current/f.revenue.target*100));let{count:o}=await p.from("clients").select("id",{count:"exact",head:!0}),{count:i}=await p.from("clients").select("id",{count:"exact",head:!0}).eq("status","active"),{count:s}=await p.from("clients").select("id",{count:"exact",head:!0}).gte("created_at",t.toISOString());f.clients.total=o||0,f.clients.active=i||0,f.clients.new_this_month=s||0,f.clients.churn_rate=2.5,f.clients.health_avg=8;let{count:c}=await p.from("kanban_tasks").select("id",{count:"exact",head:!0}).eq("status","done").gte("updated_at",t.toISOString()),{count:u}=await p.from("kanban_tasks").select("id",{count:"exact",head:!0}).not("status","eq","done");f.operations.tasks_completed=c||0,f.operations.tasks_pending=u||0,f.operations.sla_compliance=94.5,f.operations.avg_delivery_time=2.3,f.finance.mrr=f.revenue.current,f.finance.arr=12*f.finance.mrr;let{data:l,count:d}=await p.from("invoices").select("amount",{count:"exact"}).eq("status","pending").lt("due_date",_.toISOString());f.finance.overdue_invoices=d||0,f.finance.overdue_amount=(l||[]).reduce((e,t)=>e+Number(t.amount||0),0),f.finance.collection_rate=96.5;let{count:m}=await p.from("user_profiles").select("id",{count:"exact",head:!0}).in("role",["colaborador","gerente","admin"]);f.team.total_members=m||0,f.team.productivity_score=87,f.team.utilization_rate=78}catch(e){console.error("Error fetching metrics:",e)}let x=[];try{let{data:e}=await p.from("clients").select("id, company_name, nome_fantasia").eq("status","active").limit(10);for(let a of e||[]){let{data:e}=await p.from("invoices").select("amount").eq("client_id",a.id).eq("status","paid").gte("paid_at",t.toISOString()),r=(e||[]).reduce((e,t)=>e+Number(t.amount||0),0);x.push({id:a.id,name:a.company_name||a.nome_fantasia||"Cliente",revenue:r,health:8+2*Math.random(),change:Math.floor(20*Math.random())-5})}x.sort((e,t)=>t.revenue-e.revenue),x=x.slice(0,5)}catch(e){console.error("Error fetching top clients:",e)}let w=[];if(f.finance.overdue_invoices>0&&w.push({id:"overdue",type:"critical",title:`${f.finance.overdue_invoices} faturas vencidas`,description:`R$ ${f.finance.overdue_amount.toLocaleString("pt-BR")} em atraso`,action:"Ver faturas"}),f.operations.sla_compliance<95&&w.push({id:"sla",type:"warning",title:"SLA abaixo da meta",description:`Compliance em ${f.operations.sla_compliance}% (meta: 95%)`,action:"Ver detalhes"}),f.revenue.progress<100){let e=f.revenue.target-f.revenue.current;w.push({id:"target",type:"info",title:"Meta de receita",description:`Faltam R$ ${e.toLocaleString("pt-BR")} para atingir a meta`,action:"Ver detalhes"})}return s.NextResponse.json({success:!0,metrics:f,top_clients:x,alerts:w,period:h})}catch(e){return console.error("Executive dashboard error:",e),s.NextResponse.json({success:!1,error:e?.message||"Erro interno"},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/dashboard-executive/route",pathname:"/api/admin/dashboard-executive",filename:"route",bundlePath:"app/api/admin/dashboard-executive/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\dashboard-executive\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:v,staticGenerationAsyncStorage:g,serverHooks:h}=m,_="/api/admin/dashboard-executive/route";function f(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},90176:(e,t,a)=>{a.d(t,{t:()=>n});var r=a(54128);function n(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,r.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>a(17329));module.exports=r})();