"use strict";(()=>{var e={};e.id=52748,e.ids=[52748],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},61709:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>p,routeModule:()=>g,serverHooks:()=>_,staticGenerationAsyncStorage:()=>x});var i={};r.r(i),r.d(i,{POST:()=>m,dynamic:()=>d});var n=r(49303),a=r(88716),s=r(60670),o=r(87070),c=r(17478),l=r(17743),u=r(35311);let d="force-dynamic";async function m(e){let t;let r=await (0,c.k)(e);if(!r.ok)return r.res;try{t=await e.json()}catch{t={}}let i=t?.role!=null?String(t.role):"all",n=!!t?.include_market,a="all"===i?null:(0,l.U)(i);if("all"!==i&&!a)return o.NextResponse.json({success:!1,error:"role inv\xe1lido"},{status:400});let s=a?[a]:l.G,d=0,m=[];for(let e of s){let t=await (0,u.M)({role:e,actorUserId:r.userId,includeMarket:n&&"cmo"===e});d+=t.created,m.push({role:e,created:t.created,warning:t.warning||null})}return o.NextResponse.json({success:!0,created:d,perRole:m})}let g=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/csuite/insights/generate/route",pathname:"/api/admin/csuite/insights/generate",filename:"route",bundlePath:"app/api/admin/csuite/insights/generate/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\csuite\\insights\\generate\\route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:p,staticGenerationAsyncStorage:x,serverHooks:_}=g,h="/api/admin/csuite/insights/generate/route";function y(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:x})}},35311:(e,t,r)=>{r.d(t,{M:()=>o});var i=r(90176),n=r(51547),a=r(31683);async function s(e){try{let t=(0,i.t)(),{data:r}=await t.from("ai_executive_insights").select("id").eq("executive_id",e.executiveId).eq("title",e.title).gte("created_at",e.sinceIso).limit(1);return(r||[]).length>0}catch{return!1}}async function o(e){let t=(0,i.t)(),{data:r}=await t.from("ai_executives").select("*").eq("role",e.role).maybeSingle();if(!r?.id)return{created:0,warning:`Executivo ${e.role} n\xe3o encontrado em ai_executives.`};let o=await (0,a.tJ)({role:e.role,actorUserId:e.actorUserId,includePredictions:!0,touchKnowledge:!!e.actorUserId}),c=e.includeMarket?await (0,a.kG)({executiveId:String(r.id),role:e.role,query:`Tend\xeancias e benchmarks relevantes para ${e.role.toUpperCase()} em ag\xeancia de marketing (Brasil). Foque em 2025/2026.`,purpose:`Gera\xe7\xe3o de insights de mercado (${e.role})`}):null,l=`${String(r.system_prompt||"").trim()}

${a.e$}

Voc\xea vai gerar INSIGHTS PROATIVOS em JSON para o executivo.
Regras: sem mocks, sem inventar n\xfameros. Se faltar dado, cite isso e proponha como coletar.
Formato de sa\xedda: um JSON v\xe1lido com a chave "insights" (array).`,u=(await (0,n.F)({task:(0,a.Ph)(e.role),json:!0,temperature:.35,maxTokens:1200,actorUserId:e.actorUserId,entityType:"ai_executive_insights_generate",entityId:e.role,messages:[{role:"system",content:l},{role:"user",content:[`Executivo: ${e.role.toUpperCase()} (${r.name} â€” ${r.title})`,`Contexto interno (JSON):
${JSON.stringify(o).slice(0,18e3)}`,c?`Contexto de mercado (Perplexity Sonar):
${c.answer}
Fontes:
${c.sources.join("\n")}`:null,"Gere de 3 a 6 insights com recommended_actions (CTAs consultivos).",`Cada insight deve incluir:
- insight_type (risk|opportunity|performance|strategy)
- category (financial|operational|marketing|customer|hr|tech|general)
- title
- description
- confidence_score (0.00-1.00)
- impact_level (low|medium|high|critical)
- urgency (low|medium|high)
- requires_discussion (boolean)
- recommended_actions: array de objetos {label, action_type, payload, requires_external, risk_level}
`,`action_type permitido:
- create_kanban_task (interno)
- send_direct_message (interno)
- schedule_meeting (interno)
- n8n_webhook (EXTERNO; requires_external=true)
- external_email (EXTERNO; requires_external=true)
`,"IMPORTANTE: nada executa automaticamente. Apenas sugira CTAs e payloads."].filter(Boolean).join("\n\n")}]})).json||{},d=Array.isArray(u?.insights)?u.insights:Array.isArray(u)?u:[],m=new Date(Date.now()-864e5).toISOString(),g=0;for(let e of d){let i=String(e?.title||"").trim(),n=String(e?.description||"").trim();if(!i||!n||await s({executiveId:String(r.id),title:i,sinceIso:m}))continue;let a=function(e){let t=Number(e);return Number.isFinite(t)?t>1?Math.max(0,Math.min(1,t/100)):Math.max(0,Math.min(1,t)):null}(e?.confidence_score),o={executive_id:r.id,insight_type:String(e?.insight_type||"strategy"),category:String(e?.category||"general"),title:i,description:n,supporting_data:e?.supporting_data??{},data_sources:e?.data_sources??[],confidence_score:a,impact_level:e?.impact_level?String(e.impact_level):null,urgency:e?.urgency?String(e.urgency):null,recommended_actions:e?.recommended_actions??[],requires_discussion:!!e?.requires_discussion,status:"new"};try{let{error:e}=await t.from("ai_executive_insights").insert(o);!e&&g++}catch{}}return{created:g,warning:null}}}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[89276,55972,54128,20958,79263,44518],()=>r(61709));module.exports=i})();