"use strict";(()=>{var e={};e.id=2562,e.ids=[2562],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84256:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>x,patchFetch:()=>N,requestAsyncStorage:()=>y,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>h});var r={};s.r(r),s.d(r,{GET:()=>m,POST:()=>g,PUT:()=>_,dynamic:()=>p});var a=s(49303),n=s(88716),o=s(60670),i=s(87070),c=s(17478),u=s(90176),l=s(68042);async function d(e){let{url:t,key:s}=function(){let e=process.env.N8N_OUTBOUND_WEBHOOK_URL||process.env.N8N_WEBHOOK_URL||"",t=process.env.N8N_OUTBOUND_WEBHOOK_KEY||process.env.N8N_WEBHOOK_KEY||"";return{url:String(e).trim(),key:String(t).trim()}}();if(!t)return{ok:!0,skipped:!0};let r=Math.max(500,Math.min(15e3,Number(e.timeoutMs||6e3))),a={event:e.event,occurred_at:new Date().toISOString(),source:"valle360",actor_user_id:e.actorUserId??null,data:e.data||{}},n=new AbortController,o=setTimeout(()=>n.abort(),r);try{let e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",...s?{"x-api-key":s}:{}},body:JSON.stringify(a),signal:n.signal});if(!e.ok){let t=await e.text().catch(()=>"");return{ok:!1,error:`N8N webhook ${e.status}: ${t||e.statusText}`}}return{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}finally{clearTimeout(o)}}let p="force-dynamic";async function m(e){let t=await (0,c.k)(e);if(!t.ok)return t.res;try{let t=(0,u.t)(),{searchParams:s}=new URL(e.url),r=s.get("segment"),a=s.get("status"),n=s.get("min_score"),o=t.from("prospecting_leads").select("*");r&&(o=o.eq("segment",r)),a&&(o=o.eq("status",a)),n&&(o=o.gte("qualification_score",parseInt(n)));let{data:c,error:l}=await o.order("created_at",{ascending:!1});if(l)throw l;return i.NextResponse.json({success:!0,data:c})}catch(e){if(function(e){let t=String(e||"").toLowerCase();return t.includes("does not exist")||t.includes("relation")||t.includes("schema cache")||t.includes("could not find the table")}(e?.message||""))return i.NextResponse.json({success:!0,data:[],note:"Tabela prospecting_leads ainda n\xe3o existe no banco deste ambiente."});return i.NextResponse.json({success:!1,error:e.message},{status:500})}}async function g(e){let t=await (0,c.k)(e);if(!t.ok)return t.res;try{let s=(0,u.t)(),{action:r,...a}=await e.json();switch(r){case"search":{let e=String(a.segment||"").trim(),r=a.location?String(a.location).trim():void 0,n=Math.max(1,Math.min(20,Number(a.limit||10))),o=Array.isArray(a.keywords)?a.keywords.map(e=>String(e).trim()).filter(Boolean):"string"==typeof a.keywords?String(a.keywords).split(",").map(e=>e.trim()).filter(Boolean):void 0;if(!e)return i.NextResponse.json({success:!1,error:"segment \xe9 obrigat\xf3rio"},{status:400});let c=await l.h.searchLeads({industry:e,location:r,keywords:o,has_website:!0});if(!c.success)return i.NextResponse.json({success:!1,error:"Prospec\xe7\xe3o n\xe3o configurada (verifique TAVILY_API_KEY e provedor de IA)."},{status:501});let u=(c.leads||[]).slice(0,n),p=[],m=0,g=0,_=0;for(let t of u){let a=t.website?String(t.website).trim():null,n=String(t.company_name||"").trim();if(!n)continue;a||(_+=1);let i=null;if(a){let{data:e}=await s.from("prospecting_leads").select("id").eq("company_website",a).maybeSingle();e?.id&&(i=String(e.id))}let u={company_name:n,company_website:a,company_industry:t.industry||e,company_size:t.size||null,company_location:t.location?{raw:t.location}:null,contact_email:t.email||null,contact_phone:t.phone||null,source:"tavily",source_details:{source:c.source,query_segment:e,query_location:r||null,keywords:o||[]},segment:e,qualification_score:Number.isFinite(t.score)?Math.max(0,Math.min(100,Number(t.score))):0,qualification_factors:[],status:"new",tags:t.tags||[],notes:t.notes||null,estimated_services:t.ai_insights?.potential_services||[],updated_at:new Date().toISOString()};if(i){let{data:e,error:t}=await s.from("prospecting_leads").update(u).eq("id",i).select().single();!t&&e&&(g+=1,p.push(e))}else{let{data:e,error:t}=await s.from("prospecting_leads").insert(u).select().single();!t&&e&&(m+=1,p.push(e))}}return d({event:"prospecting.leads.upserted",actorUserId:t.userId,data:{segment:e,location:r||null,keywords:o||[],found:u.length,created:m,updated:g,leads:p.slice(0,20).map(e=>({id:String(e?.id||""),company_name:String(e?.company_name||""),company_website:e?.company_website?String(e.company_website):null,contact_email:e?.contact_email?String(e.contact_email):null,contact_phone:e?.contact_phone?String(e.contact_phone):null,qualification_score:Number(e?.qualification_score||0),status:String(e?.status||"new"),source:String(e?.source||"tavily")}))}}),i.NextResponse.json({success:!0,created:m,updated:g,found:u.length,data:p,note:_>0?"Leads sem website n\xe3o s\xe3o deduplicados automaticamente.":void 0})}case"contact":{let{lead_id:e}=a;if(!e)return i.NextResponse.json({success:!1,error:"lead_id \xe9 obrigat\xf3rio"},{status:400});let{error:r}=await s.from("prospecting_leads").update({status:"contacted",last_interaction_at:new Date().toISOString()}).eq("id",e);if(r)return i.NextResponse.json({success:!1,error:r.message},{status:500});return d({event:"prospecting.lead.contacted",actorUserId:t.userId,data:{lead_id:String(e)}}),i.NextResponse.json({success:!0,message:"Contato iniciado"})}case"create":{let{data:e,error:r}=await s.from("prospecting_leads").insert(a).select().single();if(r)return i.NextResponse.json({success:!1,error:r.message},{status:500});return d({event:"prospecting.lead.created",actorUserId:t.userId,data:{lead_id:String(e?.id||""),company_name:String(e?.company_name||""),company_website:e?.company_website?String(e.company_website):null,qualification_score:Number(e?.qualification_score||0),status:String(e?.status||"new")}}),i.NextResponse.json({success:!0,data:e})}default:return i.NextResponse.json({success:!1,error:"A\xe7\xe3o inv\xe1lida"},{status:400})}}catch(e){return i.NextResponse.json({success:!1,error:e.message},{status:500})}}async function _(e){let t=await (0,c.k)(e);if(!t.ok)return t.res;try{let s=(0,u.t)(),{id:r,...a}=await e.json();if(!r)return i.NextResponse.json({success:!1,error:"id \xe9 obrigat\xf3rio"},{status:400});let{data:n,error:o}=await s.from("prospecting_leads").update({...a,updated_at:new Date().toISOString()}).eq("id",r).select().single();if(o)return i.NextResponse.json({success:!1,error:o.message},{status:500});return d({event:"prospecting.lead.updated",actorUserId:t.userId,data:{lead_id:String(n?.id||r),status:n?.status?String(n.status):void 0,qualification_score:n?.qualification_score!=null?Number(n.qualification_score):void 0}}),i.NextResponse.json({success:!0,data:n})}catch(e){return i.NextResponse.json({success:!1,error:e.message},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/prospecting/route",pathname:"/api/prospecting",filename:"route",bundlePath:"app/api/prospecting/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\prospecting\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:w}=f,x="/api/prospecting/route";function N(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:h})}},17478:(e,t,s)=>{s.d(t,{k:()=>i});var r=s(87070),a=s(20344),n=s(71615),o=s(54128);async function i(e){let t=(0,n.cookies)(),s=(0,a.createRouteHandlerClient)({cookies:()=>t}),i=e.headers.get("authorization")||"",c=i.toLowerCase().startsWith("bearer ")?i.slice(7).trim():null,u=c?(0,o.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${c}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):s,{data:l}=await u.auth.getUser();if(!l.user?.id)return{ok:!1,res:r.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:d,error:p}=await u.rpc("is_admin");return p||!d?{ok:!1,res:r.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:l.user.id}}}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958,68042],()=>s(84256));module.exports=r})();