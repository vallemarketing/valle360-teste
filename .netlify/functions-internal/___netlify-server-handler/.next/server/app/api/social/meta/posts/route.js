"use strict";(()=>{var e={};e.id=41536,e.ids=[41536],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},89209:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>y,patchFetch:()=>w,requestAsyncStorage:()=>_,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g});var r={};a.r(r),a.d(r,{POST:()=>m,dynamic:()=>p});var s=a(49303),o=a(88716),i=a(60670),n=a(87070),c=a(20344),u=a(71615),d=a(52955),l=a(63032);let p="force-dynamic";async function m(e){try{let t=(0,u.cookies)(),a=(0,c.createRouteHandlerClient)({cookies:()=>t}),r=await (0,d.U)({supabase:a});if(!r.allowed)return n.NextResponse.json({error:r.reason||"Acesso negado"},{status:403});let s=await e.json(),o=s?.client_id?String(s.client_id):null,i=s?.scheduled_at||s?.scheduledAt||null,p=Array.isArray(s?.media_urls)?s.media_urls:Array.isArray(s?.mediaUrls)?s.mediaUrls:[],m=s?.caption??s?.legenda??"",h=s?.collaborators??s?.colaboradores??null,_=Array.isArray(s?.platforms)?s.platforms.map(String):[],g=Array.isArray(s?.channels)?s.channels:[],f=String(s?.mode||(i?"schedule":"publish_now")),y=!!s?.is_draft,w=String(s?.approval_status||"approved"),S=!!s?.boost_requested;if(!o)return n.NextResponse.json({error:"client_id \xe9 obrigat\xf3rio"},{status:400});if(!Array.isArray(g)||0===g.length)return n.NextResponse.json({error:"Selecione ao menos um canal"},{status:400});let k=function(e){let t=String(e?.post_type||e?.type||"").toLowerCase();return t.includes("carousel")?"carousel":t.includes("video")?"video":"image"}(s),{data:P,error:A}=await a.from("instagram_posts").insert({external_id:null,client_id:o,post_type:k,caption:m,collaborators:h,status:y?"draft":"pending"===w?"pending_approval":"schedule"===f?"scheduled":"publishing",scheduled_at:"schedule"===f?i:null,media_urls:p,created_by:r.userId,raw_payload:{...s,_backend:"meta"},platforms:_,channels:g,backend:"meta",is_draft:y,approval_status:w,boost_requested:S}).select("*").single();if(A)return n.NextResponse.json({error:A.message},{status:500});if(y||"approved"!==w)return n.NextResponse.json({success:!0,post:P,published:!1});if("schedule"===f)return n.NextResponse.json({success:!0,post:P,scheduled:!0});let b=await (0,l.G)({post:P}),v=b.ok?"published":"failed";return await a.from("instagram_posts").update({status:v,published_at:b.ok?new Date().toISOString():null,error_message:b.ok?null:b.error||"Falha ao publicar",raw_payload:{...P?.raw_payload,publish_results:b.results}}).eq("id",P.id),n.NextResponse.json({success:b.ok,post_id:P.id,results:b.results,error:b.ok?void 0:b.error})}catch(e){return n.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/social/meta/posts/route",pathname:"/api/social/meta/posts",filename:"route",bundlePath:"app/api/social/meta/posts/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\social\\meta\\posts\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:_,staticGenerationAsyncStorage:g,serverHooks:f}=h,y="/api/social/meta/posts/route";function w(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},90176:(e,t,a)=>{a.d(t,{t:()=>s});var r=a(54128);function s(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,r.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},22887:(e,t,a)=>{a.d(t,{F9:()=>s,nt:()=>o});let r="https://graph.facebook.com/v18.0";class s{constructor(e){this.accessToken=e.accessToken,this.adAccountId=e.adAccountId,this.businessAccountId=e.businessAccountId}async request(e,t={}){let a=new URL(`${r}${e}`);a.searchParams.set("access_token",this.accessToken);let s=await fetch(a.toString(),{...t,headers:{"Content-Type":"application/json",...t.headers}}),o=await s.json();if(o.error)throw Error(`Meta API Error: ${o.error.message}`);return o}async verifyToken(){return this.request("/debug_token",{method:"GET"})}async getMe(){return this.request("/me?fields=id,name,email")}async getInstagramAccount(e){return this.request(`/${e}?fields=instagram_business_account{id,username,followers_count,media_count}`)}async getInstagramInsights(e,t=["impressions","reach","profile_views"],a="day"){let r=t.join(",");return this.request(`/${e}/insights?metric=${r}&period=${a}`)}async getInstagramMedia(e,t=25){return this.request(`/${e}/media?fields=id,caption,media_type,media_url,thumbnail_url,timestamp,like_count,comments_count&limit=${t}`)}async createInstagramPost(e,t,a){let r=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify({image_url:t,caption:a})});return this.request(`/${e}/media_publish`,{method:"POST",body:JSON.stringify({creation_id:r.id})})}async createInstagramVideoPost(e,t,a){let r=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify({video_url:t,media_type:"VIDEO",caption:a})});return this.request(`/${e}/media_publish`,{method:"POST",body:JSON.stringify({creation_id:r.id})})}async createInstagramCarouselPost(e,t,a){let r=[];for(let a of t.slice(0,10)){let t=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify("video"===a.type?{video_url:a.url,media_type:"VIDEO",is_carousel_item:!0}:{image_url:a.url,is_carousel_item:!0})});r.push(t.id)}let s=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify({media_type:"CAROUSEL",caption:a,children:r.join(",")})});return this.request(`/${e}/media_publish`,{method:"POST",body:JSON.stringify({creation_id:s.id})})}async getAdCampaigns(e=["id","name","status","objective"]){if(!this.adAccountId)throw Error("Ad Account ID n\xe3o configurado");let t=e.join(",");return this.request(`/${this.adAccountId}/campaigns?fields=${t}`)}async getCampaignInsights(e,t="last_30d"){return this.request(`/${e}/insights?fields=impressions,clicks,spend,reach,cpc,cpm,ctr,conversions&date_preset=${t}`)}async getAdAccountInsights(e="last_30d"){if(!this.adAccountId)throw Error("Ad Account ID n\xe3o configurado");return this.request(`/${this.adAccountId}/insights?fields=impressions,clicks,spend,reach,actions&date_preset=${e}`)}async getPages(){return this.request("/me/accounts")}async createPagePost(e,t,a,s){let o={message:a};s&&(o.link=s);let i=new URL(`${r}/${e}/feed`);return i.searchParams.set("access_token",t),(await fetch(i.toString(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).json()}async createPagePhotoPost(e,t,a,s){let o=new URL(`${r}/${e}/photos`);o.searchParams.set("access_token",t);let i=new URLSearchParams;return i.set("url",a),s&&i.set("caption",s),i.set("published","true"),(await fetch(o.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i})).json()}async createPageVideoPost(e,t,a,s){let o=new URL(`${r}/${e}/videos`);o.searchParams.set("access_token",t);let i=new URLSearchParams;return i.set("file_url",a),s&&i.set("description",s),(await fetch(o.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i})).json()}async getPageInsights(e,t,a=["page_impressions","page_engaged_users","page_fans"],s="day"){let o=a.join(","),i=new URL(`${r}/${e}/insights`);return i.searchParams.set("access_token",t),i.searchParams.set("metric",o),i.searchParams.set("period",s),(await fetch(i.toString())).json()}}function o(e){return new s(e)}},63032:(e,t,a)=>{a.d(t,{G:()=>o});var r=a(90176),s=a(22887);async function o(e){var t;let a=(0,r.t)(),o=e.post||{},i=String(o.post_type||o.postType||"image"),n=String(o.caption||o.legenda||""),c=Array.isArray(o.media_urls)?o.media_urls.map(String):[],u=Array.isArray(t=o.channels)?t.map(e=>({account_id:String(e?.account_id||e?.accountId||e?.id||""),platform:String(e?.platform||"")})).filter(e=>e.account_id&&e.platform):[],d=e=>/\.(mp4|mov|m4v|webm)(\?|#|$)/i.test(e),l=[],p=!0,m=null;for(let e of u)try{let{data:t,error:r}=await a.from("social_connected_accounts").select("id, platform, external_account_id").eq("id",e.account_id).maybeSingle();if(r||!t)throw Error("Canal n\xe3o encontrado");let{data:o}=await a.from("social_connected_account_secrets").select("access_token, expires_at").eq("account_id",e.account_id).maybeSingle(),u=o?.access_token?String(o.access_token):"";if(!u)throw Error("Token ausente para este canal");if("instagram"===t.platform){let a=String(t.external_account_id),r=(0,s.nt)({accessToken:u});if("video"===i){if(!c[0])throw Error("media_urls[0] ausente");let t=await r.createInstagramVideoPost(a,c[0],n);l.push({platform:"instagram",account_id:e.account_id,ok:!0,result:t})}else if("carousel"===i){let t=c.slice(0,10).map(e=>({type:d(e)?"video":"image",url:e})),s=await r.createInstagramCarouselPost(a,t,n);l.push({platform:"instagram",account_id:e.account_id,ok:!0,result:s})}else{if(!c[0])throw Error("media_urls[0] ausente");let t=await r.createInstagramPost(a,c[0],n);l.push({platform:"instagram",account_id:e.account_id,ok:!0,result:t})}}else if("facebook"===t.platform){let a=String(t.external_account_id),r=(0,s.nt)({accessToken:u});if("video"===i){if(!c[0])throw Error("media_urls[0] ausente");let t=await r.createPageVideoPost(a,u,c[0],n);l.push({platform:"facebook",account_id:e.account_id,ok:!0,result:t})}else if("carousel"===i){if(!c[0])throw Error("media_urls[0] ausente");let t=await r.createPagePhotoPost(a,u,c[0],n);l.push({platform:"facebook",account_id:e.account_id,ok:!0,warning:"Carrossel Facebook: publicado apenas a primeira m\xeddia (suporte completo ser\xe1 adicionado).",result:t})}else if(c[0]){let t=await r.createPagePhotoPost(a,u,c[0],n);l.push({platform:"facebook",account_id:e.account_id,ok:!0,result:t})}else{let t=await r.createPagePost(a,u,n);l.push({platform:"facebook",account_id:e.account_id,ok:!0,result:t})}}else l.push({platform:t.platform,account_id:e.account_id,ok:!1,error:"Plataforma n\xe3o suportada no publish"}),p=!1}catch(a){p=!1;let t=a?.message||"Falha ao publicar";m=m||t,l.push({platform:e.platform,account_id:e.account_id,ok:!1,error:t})}return{ok:p,results:l,error:m}}},52955:(e,t,a)=>{a.d(t,{U:()=>i});var r=a(57157);async function s(e,t,a){try{let{data:r,error:s}=await e.rpc(t,a);if(s)return{ok:!1,error:s};return{ok:!0,data:r}}catch(e){return{ok:!1,error:e}}}function o(e){return Array.from(new Set(e))}async function i(e){let t=e.supabase,{data:a}=await t.auth.getUser(),i=a.user?.id;if(!i)return{userId:"",isSuperAdmin:!1,isAdmin:!1,allowed:!1,reason:"N\xe3o autenticado",areaKeys:[]};let n=await s(t,"is_admin"),c=!!n.ok&&!!n.data,u=await s(t,"is_super_admin"),d=!!u.ok&&!!u.data;if(c||d)return{userId:i,isSuperAdmin:d,isAdmin:c,allowed:!0,areaKeys:[]};let l=await s(t,"employee_area_keys");if(l.ok&&Array.isArray(l.data)){let e=(l.data||[]).map(e=>String(e)),t=e.includes("social_media")||e.includes("head_marketing");return{userId:i,isSuperAdmin:d,isAdmin:c,allowed:t,reason:t?void 0:"Acesso restrito: necess\xe1rio Social Media ou Head Marketing",areaKeys:o(e)}}let{data:p}=await t.from("employees").select("department, area_of_expertise, areas, is_active").eq("user_id",i).maybeSingle(),m=[];p?.department&&m.push(String(p.department)),p?.area_of_expertise&&m.push(String(p.area_of_expertise)),Array.isArray(p?.areas)&&m.push(...p.areas.map(e=>String(e)));let h=o(m.map(e=>(0,r.IY)(e)).filter(Boolean).map(e=>e)),_=h.includes("social_media")||h.includes("head_marketing");return{userId:i,isSuperAdmin:d,isAdmin:c,allowed:_,reason:_?void 0:"Acesso restrito: necess\xe1rio Social Media ou Head Marketing",areaKeys:h}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958,57157],()=>a(89209));module.exports=r})();