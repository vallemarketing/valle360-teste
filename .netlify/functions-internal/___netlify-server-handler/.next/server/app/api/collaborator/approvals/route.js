"use strict";(()=>{var e={};e.id=36373,e.ids=[36373],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},90042:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>x,requestAsyncStorage:()=>S,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>y});var a={};r.r(a),r.d(a,{GET:()=>_,dynamic:()=>u});var n=r(49303),i=r(88716),s=r(60670),o=r(87070),l=r(20344),c=r(71615),d=r(90176);let u="force-dynamic";function p(e){let t=String(e?.message||"").toLowerCase();return"42P01"===String(e?.code||"")||t.includes("relation")||t.includes("does not exist")}function m(e){return null==e?"":String(e)}async function g(){let e=(0,c.cookies)(),t=(0,l.createRouteHandlerClient)({cookies:()=>e}),{data:r}=await t.auth.getUser();return r?.user||null}async function _(e){let t=await g();if(!t)return o.NextResponse.json({success:!1,error:"N\xe3o autorizado"},{status:401});let r=(0,d.t)(),a=null;try{let e=await r.from("employees").select("id").eq("user_id",t.id).maybeSingle();if(!e.error&&e.data?.id)a=String(e.data.id);else{let e=await r.from("employees").select("id").eq("user_profile_id",t.id).maybeSingle();!e.error&&e.data?.id&&(a=String(e.data.id))}}catch{a=null}if(!a)return o.NextResponse.json({success:!1,error:"Acesso negado (colaborador n\xe3o vinculado em employees)"},{status:403});let n=[];try{let{data:e,error:t}=await r.from("employee_client_assignments").select("client_id, is_active, removed_at").eq("employee_id",a).order("assigned_at",{ascending:!1}).limit(1e3);if(t)throw t;n=Array.from(new Set((e||[]).filter(e=>e?.client_id&&e?.is_active!==!1&&!e?.removed_at).map(e=>String(e.client_id))))}catch(e){if(p(e))return o.NextResponse.json({success:!0,items:[],note:"Tabela employee_client_assignments n\xe3o existe neste ambiente."});return o.NextResponse.json({success:!1,error:e?.message||"Erro interno"},{status:500})}if(0===n.length)return o.NextResponse.json({success:!0,items:[],note:"Nenhum cliente atribu\xeddo."});let{data:i,error:s}=await r.from("kanban_columns").select("id, sla_hours").eq("stage_key","aprovacao").limit(500);if(s)return p(s)?o.NextResponse.json({success:!0,items:[],note:"Schema de kanban n\xe3o encontrado."}):o.NextResponse.json({success:!1,error:s.message},{status:500});let l=(i||[]).map(e=>String(e.id));if(0===l.length)return o.NextResponse.json({success:!0,items:[],note:"Nenhuma coluna de aprova\xe7\xe3o encontrada."});let c=[];try{let{data:e,error:t}=await r.from("kanban_tasks").select("id,title,description,client_id,created_at,updated_at,due_date,priority,tags,reference_links,assigned_to,created_by").in("column_id",l).in("client_id",n).neq("status","cancelled").order("updated_at",{ascending:!0}).limit(500);if(t)throw t;c=e||[]}catch(e){if(p(e))return o.NextResponse.json({success:!0,items:[],note:"Tabela kanban_tasks n\xe3o encontrada."});return o.NextResponse.json({success:!1,error:e?.message||"Erro interno"},{status:500})}let u=new Map;{let e=await r.from("clients").select("id, company_name").in("id",n);if(e.error){let e=await r.from("clients").select("id, nome_fantasia, razao_social").in("id",n);if(!e.error)for(let t of e.data||[])u.set(String(t.id),String(t.nome_fantasia||t.razao_social||"Cliente"))}else for(let t of e.data||[])u.set(String(t.id),String(t.company_name||"Cliente"))}let _=Array.from(new Set(c.map(e=>String(e.created_by||"")).filter(Boolean))),f=new Map;if(_.length){let{data:e}=await r.from("user_profiles").select("user_id, full_name, role").in("user_id",_);for(let t of e||[]){let e=String(t.user_id);f.set(e,String(t.full_name||"Usu\xe1rio"))}}let S=c.map(e=>{let t=(e.reference_links||{}).client_approval||{},r=(Array.isArray(t.history)?t.history:[]).filter(e=>e?.comment).slice(-10).map((t,r)=>({id:`${e.id}:${r}`,text:String(t.comment),author:String(t.by_user_id||""),authorName:String(t.by_name||"Usu\xe1rio"),isClient:!0,createdAt:String(t.at||e.updated_at||e.created_at||new Date().toISOString())}));return{id:String(e.id),title:m(e.title)||"Aprova\xe7\xe3o",description:m(e.description)||void 0,type:function(e){let t=Array.isArray(e?.tags)?e.tags.map(e=>String(e).toLowerCase()):[],r=String(e?.title||"").toLowerCase(),a=`${r} ${t.join(" ")}`;return a.includes("video")?"video":a.includes("site")||a.includes("website")?"website":a.includes("post")||a.includes("instagram")||a.includes("reel")?"post":a.includes("design")||a.includes("banner")||a.includes("criativo")?"design":"document"}(e),status:"pending",clientId:String(e.client_id),clientName:u.get(String(e.client_id))||"Cliente",createdBy:String(e.created_by||""),createdByName:f.get(String(e.created_by||""))||"Equipe",createdByArea:"Equipe",createdAt:String(e.created_at||new Date().toISOString()),updatedAt:String(e.updated_at||e.created_at||new Date().toISOString()),dueDate:t?.due_at?String(t.due_at):e.due_date?String(e.due_date):void 0,attachments:[],thumbnail:void 0,comments:r,priority:"high"===String(e.priority||"").toLowerCase()||"urgent"===String(e.priority||"").toLowerCase()?"high":"normal"}});return o.NextResponse.json({success:!0,items:S})}let f=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/collaborator/approvals/route",pathname:"/api/collaborator/approvals",filename:"route",bundlePath:"app/api/collaborator/approvals/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\collaborator\\approvals\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:S,staticGenerationAsyncStorage:y,serverHooks:h}=f,v="/api/collaborator/approvals/route";function x(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:y})}},90176:(e,t,r)=>{r.d(t,{t:()=>n});var a=r(54128);function n(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,a.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958],()=>r(90042));module.exports=a})();