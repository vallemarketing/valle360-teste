"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3709],{73997:function(e,a,t){t.d(a,{g:function(){return p}});var s=t(57437),r=t(2265),i=t(12381),l=t(69174),n=t(53113),o=t(29374),c=t(22106),d=t(48736),m=t(69658),u=t(51817),x=t(76980),g=t(32489);let h={image:["image/jpeg","image/png","image/gif","image/webp"],video:["video/mp4","video/webm","video/quicktime"],audio:["audio/mpeg","audio/wav","audio/ogg","audio/mp3"],document:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"]};function p(e){let{onAttachmentsChange:a,maxFiles:t=5,maxSizeInMB:p=50}=e,[f,v]=(0,r.useState)([]),[b,_]=(0,r.useState)(!1),y=(0,r.useRef)(null),j=e=>h.image.includes(e)?"image":h.video.includes(e)?"video":h.audio.includes(e)?"audio":h.document.includes(e)?"document":"other",w=e=>e.size>1048576*p?"Arquivo muito grande. M\xe1ximo: ".concat(p,"MB"):[...h.image,...h.video,...h.audio,...h.document].includes(e.type)?null:"Tipo de arquivo n\xe3o suportado",N=(e,a)=>new Promise(t=>{if("image"===a){let a=new FileReader;a.onloadend=()=>t(a.result),a.onerror=()=>t(void 0),a.readAsDataURL(e)}else t(void 0)}),k=async e=>{let s=Array.from(e.target.files||[]);if(f.length+s.length>t){alert("Voc\xea pode anexar no m\xe1ximo ".concat(t," arquivos por vez"));return}_(!0);let r=[];for(let e of s){let a=w(e),t=j(e.type),s=await N(e,t);r.push({id:Math.random().toString(36).substr(2,9),file:e,type:t,preview:s,error:a||void 0})}let i=[...f,...r];v(i),a(i),_(!1),y.current&&(y.current.value="")},S=e=>{let t=f.filter(a=>a.id!==e);v(t),a(t)},C=e=>{switch(e){case"image":return(0,s.jsx)(n.Z,{className:"w-4 h-4"});case"video":return(0,s.jsx)(o.Z,{className:"w-4 h-4"});case"audio":return(0,s.jsx)(c.Z,{className:"w-4 h-4"});case"document":return(0,s.jsx)(d.Z,{className:"w-4 h-4"});default:return(0,s.jsx)(m.Z,{className:"w-4 h-4"})}},I=e=>e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB";return(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{ref:y,type:"file",multiple:!0,accept:"image/*,video/*,audio/*,.pdf,.doc,.docx",onChange:k,className:"hidden",disabled:b||f.length>=t}),(0,s.jsx)(i.z,{type:"button",variant:"outline",size:"sm",onClick:()=>{var e;return null===(e=y.current)||void 0===e?void 0:e.click()},disabled:b||f.length>=t,children:b?(0,s.jsx)(u.Z,{className:"w-4 h-4 animate-spin"}):(0,s.jsx)(x.Z,{className:"w-4 h-4"})}),f.length>0&&(0,s.jsxs)(l.C,{variant:"outline",children:[f.length," arquivo",f.length>1?"s":""]})]}),f.length>0&&(0,s.jsx)("div",{className:"space-y-2",children:f.map(e=>(0,s.jsxs)("div",{className:"flex items-center gap-2 p-2 rounded-lg border ".concat(e.error?"border-red-300 bg-red-50 dark:bg-red-900/20":"border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800"),children:[e.preview&&"image"===e.type?(0,s.jsx)("img",{src:e.preview,alt:e.file.name,className:"w-12 h-12 object-cover rounded"}):(0,s.jsx)("div",{className:"w-12 h-12 flex items-center justify-center bg-gray-200 dark:bg-gray-700 rounded",children:C(e.type)}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-900 dark:text-white truncate",children:e.file.name}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("p",{className:"text-xs text-gray-500",children:I(e.file.size)}),e.error&&(0,s.jsx)("p",{className:"text-xs text-red-600 dark:text-red-400",children:e.error})]})]}),(0,s.jsx)(i.z,{type:"button",variant:"ghost",size:"sm",onClick:()=>S(e.id),children:(0,s.jsx)(g.Z,{className:"w-4 h-4"})})]},e.id))})]})}},15208:function(e,a,t){t.d(a,{I:function(){return g}});var s=t(57437),r=t(2265),i=t(92735),l=t(81706),n=t(43391),o=t(45802),c=t(32489),d=t(12381),m=t(41639),u=t(48736),x=t(69658);function g(e){let a,{attachment:t,showInline:g=!0}=e,[h,p]=(0,r.useState)(!1),[f,v]=(0,r.useState)(100),[b,_]=(0,r.useState)(!1),[y,j]=(0,r.useState)(!1),w=e=>e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB",N=async()=>{try{let e=await fetch(t.file_url),a=await e.blob(),s=window.URL.createObjectURL(a),r=document.createElement("a");r.href=s,r.download=t.file_name,document.body.appendChild(r),r.click(),window.URL.revokeObjectURL(s),document.body.removeChild(r)}catch(e){console.error("Erro ao baixar arquivo:",e)}};return(0,s.jsxs)(s.Fragment,{children:[g&&(t.mime_type.startsWith("image/")?(0,s.jsxs)("div",{className:"relative group",children:[(0,s.jsx)("img",{src:t.file_url,alt:t.file_name,className:"max-w-full max-h-96 rounded-lg cursor-pointer object-contain",onClick:()=>p(!0)}),(0,s.jsx)("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,s.jsx)(d.z,{size:"sm",variant:"secondary",onClick:e=>{e.stopPropagation(),N()},children:(0,s.jsx)(i.Z,{className:"w-4 h-4"})})}),t.width&&t.height&&(0,s.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:[t.width," \xd7 ",t.height]})]}):t.mime_type.startsWith("video/")?(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)("video",{controls:!0,className:"max-w-full max-h-96 rounded-lg",poster:t.thumbnail_url,children:[(0,s.jsx)("source",{src:t.file_url,type:t.mime_type}),"Seu navegador n\xe3o suporta v\xeddeos."]}),t.duration&&(0,s.jsx)(m.Z,{className:"absolute bottom-2 right-2 bg-black/70 text-white",children:(a=t.duration)?"".concat(Math.floor(a/60),":").concat(Math.floor(a%60).toString().padStart(2,"0")):"0:00"})]}):t.mime_type.startsWith("audio/")?(0,s.jsxs)("div",{className:"flex items-center gap-3 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg max-w-md",children:[(0,s.jsx)("div",{className:"flex-shrink-0",children:(0,s.jsx)(l.Z,{className:"w-6 h-6 text-gray-600 dark:text-gray-400"})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-900 dark:text-white truncate",children:t.file_name}),(0,s.jsxs)("audio",{controls:!0,className:"w-full mt-2",children:[(0,s.jsx)("source",{src:t.file_url,type:t.mime_type}),"Seu navegador n\xe3o suporta \xe1udio."]})]}),(0,s.jsx)(d.z,{size:"sm",variant:"ghost",onClick:N,children:(0,s.jsx)(i.Z,{className:"w-4 h-4"})})]}):"application/pdf"===t.mime_type?(0,s.jsx)("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-4 max-w-md",children:(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:"w-12 h-12 bg-red-100 dark:bg-red-900/20 rounded flex items-center justify-center",children:(0,s.jsx)(u.Z,{className:"w-6 h-6 text-red-600"})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-900 dark:text-white truncate",children:t.file_name}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:w(t.file_size)})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(d.z,{size:"sm",variant:"outline",onClick:()=>window.open(t.file_url,"_blank"),children:"Abrir"}),(0,s.jsx)(d.z,{size:"sm",variant:"outline",onClick:N,children:(0,s.jsx)(i.Z,{className:"w-4 h-4"})})]})]})}):(0,s.jsx)("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-4 max-w-md",children:(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:"w-12 h-12 bg-gray-100 dark:bg-gray-800 rounded flex items-center justify-center",children:(0,s.jsx)(x.Z,{className:"w-6 h-6 text-gray-600 dark:text-gray-400"})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-900 dark:text-white truncate",children:t.file_name}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:w(t.file_size)})]}),(0,s.jsx)(d.z,{size:"sm",variant:"outline",onClick:N,children:(0,s.jsx)(i.Z,{className:"w-4 h-4"})})]})})),h&&t.mime_type.startsWith("image/")&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4",onClick:()=>p(!1),children:(0,s.jsxs)("div",{className:"relative max-w-7xl max-h-full",onClick:e=>e.stopPropagation(),children:[(0,s.jsxs)("div",{className:"absolute top-4 right-4 flex gap-2",children:[(0,s.jsx)(d.z,{size:"sm",variant:"secondary",onClick:()=>v(Math.min(200,f+25)),children:(0,s.jsx)(n.Z,{className:"w-4 h-4"})}),(0,s.jsx)(d.z,{size:"sm",variant:"secondary",onClick:()=>v(Math.max(50,f-25)),children:(0,s.jsx)(o.Z,{className:"w-4 h-4"})}),(0,s.jsx)(d.z,{size:"sm",variant:"secondary",onClick:N,children:(0,s.jsx)(i.Z,{className:"w-4 h-4"})}),(0,s.jsx)(d.z,{size:"sm",variant:"secondary",onClick:()=>p(!1),children:(0,s.jsx)(c.Z,{className:"w-4 h-4"})})]}),(0,s.jsx)("img",{src:t.file_url,alt:t.file_name,style:{transform:"scale(".concat(f/100,")")},className:"max-w-full max-h-[90vh] object-contain transition-transform"}),(0,s.jsxs)("p",{className:"text-white text-center mt-4 text-sm",children:[t.file_name," - ",w(t.file_size)]})]})})]})}},67172:function(e,a,t){t.d(a,{l:function(){return L}});var s=t(57437),r=t(2265),i=t(5526),l=t(12381),n=t(40279),o=t(59196),c=t(30401),d=t(65621),m=t(71533),u=t(44743),x=t(94766),g=t(67438),h=t(76862),p=t(2390),f=t(79820),v=t(69174),b=t(82718),_=t(32489),y=t(70525),j=t(91723),w=t(31047);function N(e){let{isOpen:a,onClose:t,clientId:n,clientName:o,conversationId:c}=e,[d,m]=(0,r.useState)(null),[u,x]=(0,r.useState)(!0);(0,r.useEffect)(()=>{a&&g()},[a,c]);let g=async()=>{try{x(!0);let{data:e,error:a}=await i.supabase.from("direct_messages").select("from_user_id, created_at").eq("conversation_id",c).order("created_at",{ascending:!0});if(a)throw a;if(!e||0===e.length){m(null);return}let t=e.filter(e=>e.from_user_id!==n).length,s=e.filter(e=>e.from_user_id===n).length,r={};e.forEach(e=>{let a=new Date(e.created_at).toLocaleDateString("pt-BR",{weekday:"long"});r[a]=(r[a]||0)+1});let l=Object.entries(r).reduce((e,a)=>e[1]>a[1]?e:a)[0],o=0,d=0;for(let a=1;a<e.length;a++)if(e[a].from_user_id!==e[a-1].from_user_id){let t=new Date(e[a].created_at).getTime()-new Date(e[a-1].created_at).getTime();o+=t,d++}let u=d>0?Math.round(o/d/6e4):0;m({total_messages:e.length,messages_sent:t,messages_received:s,first_message_at:e[0].created_at,last_message_at:e[e.length-1].created_at,avg_response_time_minutes:u,most_active_day:l})}catch(e){console.error("Erro ao carregar estat\xedsticas:",e)}finally{x(!1)}},h=e=>new Date(e).toLocaleDateString("pt-BR",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"});return a?(0,s.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:(0,s.jsxs)(f.Zb,{className:"w-full max-w-2xl max-h-[90vh] flex flex-col",children:[(0,s.jsxs)(f.Ol,{className:"flex-shrink-0 border-b",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)(f.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(b.Z,{className:"w-5 h-5 text-blue-600"}),"Hist\xf3rico de Intera\xe7\xf5es"]}),(0,s.jsx)(l.z,{variant:"ghost",size:"sm",onClick:t,children:(0,s.jsx)(_.Z,{className:"w-5 h-5"})})]}),(0,s.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:o})]}),(0,s.jsx)(f.aY,{className:"flex-1 overflow-y-auto p-6",children:u?(0,s.jsx)("div",{className:"flex items-center justify-center py-12",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):d?(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{className:"p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,s.jsx)(b.Z,{className:"w-4 h-4 text-blue-600"}),(0,s.jsx)("span",{className:"text-xs font-medium text-blue-900 dark:text-blue-300",children:"Total de Mensagens"})]}),(0,s.jsx)("p",{className:"text-2xl font-bold text-blue-600",children:d.total_messages})]}),(0,s.jsxs)("div",{className:"p-4 bg-green-50 dark:bg-green-900/20 rounded-lg",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,s.jsx)(y.Z,{className:"w-4 h-4 text-green-600"}),(0,s.jsx)("span",{className:"text-xs font-medium text-green-900 dark:text-green-300",children:"Taxa de Resposta"})]}),(0,s.jsxs)("p",{className:"text-2xl font-bold text-green-600",children:[d.messages_received>0?Math.round(d.messages_sent/d.messages_received*100):0,"%"]})]})]}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(j.Z,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"}),(0,s.jsx)("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Tempo M\xe9dio de Resposta"})]}),(0,s.jsx)(v.C,{variant:"outline",children:(e=>{if(e<60)return"".concat(e," minutos");let a=Math.floor(e/60);if(a<24)return"".concat(a," hora").concat(a>1?"s":"");let t=Math.floor(a/24);return"".concat(t," dia").concat(t>1?"s":"")})(d.avg_response_time_minutes)})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(w.Z,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"}),(0,s.jsx)("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Dia Mais Ativo"})]}),(0,s.jsx)(v.C,{variant:"outline",className:"capitalize",children:d.most_active_day})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(b.Z,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"}),(0,s.jsx)("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Mensagens Enviadas"})]}),(0,s.jsx)(v.C,{className:"bg-blue-600 text-white",children:d.messages_sent})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(b.Z,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"}),(0,s.jsx)("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Mensagens Recebidas"})]}),(0,s.jsx)(v.C,{className:"bg-green-600 text-white",children:d.messages_received})]})]}),(0,s.jsxs)("div",{className:"border-t pt-4",children:[(0,s.jsx)("h4",{className:"font-semibold text-gray-900 dark:text-white mb-3",children:"Linha do Tempo"}),(0,s.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600 dark:text-gray-400",children:"Primeira Mensagem"}),(0,s.jsx)("span",{className:"text-gray-900 dark:text-white",children:h(d.first_message_at)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600 dark:text-gray-400",children:"\xdaltima Mensagem"}),(0,s.jsx)("span",{className:"text-gray-900 dark:text-white",children:h(d.last_message_at)})]})]})]})]}):(0,s.jsxs)("div",{className:"text-center py-12",children:[(0,s.jsx)(b.Z,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"Nenhuma intera\xe7\xe3o registrada ainda"})]})})]})}):null}var k=t(73997),S=t(15208),C=t(14946),I=t(20852),z=t(35444),E=t(66491),D=t(68934),Z=t(59304),q=t(32846),M=t(61474),T=t(23993),R=t(93825);function L(e){let{conversation:a,currentUserId:t,readOnly:f=!1}=e,[v,b]=(0,r.useState)([]),[_,y]=(0,r.useState)(""),[j,w]=(0,r.useState)(!0),[L,B]=(0,r.useState)(!1),[A,U]=(0,r.useState)(new Set),[O,F]=(0,r.useState)(!1),[P,V]=(0,r.useState)([]),[G,H]=(0,r.useState)(null),[K,W]=(0,r.useState)(new Map),X=(0,r.useRef)(null),[J,Y]=(0,r.useState)(!1),[$,Q]=(0,r.useState)(""),[ee,ea]=(0,r.useState)(null),et=(0,r.useRef)(null),es=(0,r.useRef)(null),{startTyping:er,stopTyping:ei}=(0,h.o)({userId:t}),{playNotificationSound:el}=(0,p.r)();(0,r.useEffect)(()=>{if(null==a?void 0:a.id){eo(),f||ec();let e=i.supabase.channel("direct-messages-".concat(a.id)).on("postgres_changes",{event:"INSERT",schema:"public",table:"direct_messages",filter:"conversation_id=eq.".concat(a.id)},e=>{let s=e.new;s.from_user_id!==t&&(el(a.is_client_conversation),U(e=>new Set(e).add(s.id)),setTimeout(()=>{U(e=>{let a=new Set(e);return a.delete(s.id),a})},500)),eo(),f||ec()}).on("postgres_changes",{event:"*",schema:"public",table:"message_read_receipts"},()=>{eo()}).subscribe();return()=>{i.supabase.removeChannel(e)}}},[null==a?void 0:a.id]),(0,r.useEffect)(()=>{en()},[v]);let en=()=>{var e;null===(e=et.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},eo=async()=>{try{w(!0);let{data:e,error:s}=await i.supabase.from("direct_messages").select("*").eq("conversation_id",a.id).order("created_at",{ascending:!0}).limit(100);if(s)throw s;let r=await Promise.all((e||[]).map(async e=>{let{data:a}=await i.supabase.from("message_attachments").select("*").eq("message_id",e.id).eq("message_type","direct");return{...e,attachments:a||[]}}));if(s)throw s;let l=Array.from(new Set((r||[]).map(e=>String((null==e?void 0:e.from_user_id)||"")).filter(Boolean))),n=await (0,Z.m)(i.supabase,l),o=f?r.map(e=>{var a,t;return{...e,is_read:!1,sender_name:null===(a=n.get(String(e.from_user_id)))||void 0===a?void 0:a.full_name,sender_avatar:null===(t=n.get(String(e.from_user_id)))||void 0===t?void 0:t.avatar_url}}):await Promise.all(r.map(async e=>{var s,r;let l=!1;if(e.from_user_id!==t){let{data:a}=await i.supabase.from("message_read_receipts").select("id").eq("message_id",e.id).eq("message_type","direct").eq("user_id",t).maybeSingle();l=!!a}else{let{data:t}=await i.supabase.from("message_read_receipts").select("id").eq("message_id",e.id).eq("message_type","direct").eq("user_id",a.other_user_id).maybeSingle();l=!!t}return{...e,is_read:l,sender_name:null===(s=n.get(String(e.from_user_id)))||void 0===s?void 0:s.full_name,sender_avatar:null===(r=n.get(String(e.from_user_id)))||void 0===r?void 0:r.avatar_url}}));b(o);try{let e=Array.from(new Set((o||[]).flatMap(e=>(0,M.MN)(String((null==e?void 0:e.body)||"")))));if(e.length>0){let a=await (0,Z.m)(i.supabase,e);W(a)}else W(new Map)}catch(e){}}catch(e){console.error("Erro ao carregar mensagens:",e)}finally{w(!1)}},ec=async()=>{try{await i.supabase.rpc("mark_direct_messages_as_read",{p_conversation_id:a.id,p_user_id:t})}catch(e){console.error("Erro ao marcar como lido:",e)}},ed=async e=>{if(e.preventDefault(),!f&&(_.trim()||0!==P.length)&&!L){B(!0),ei();try{let{data:e,error:s}=await i.supabase.from("direct_messages").insert({conversation_id:a.id,from_user_id:t,body:_.trim()||"(anexo)",message_type:P.length>0?"attachment":"text"}).select().single();if(s)throw s;if(P.length>0&&e)for(let s of P){let r=s.file,l="".concat(Date.now(),"-").concat(r.name),n="messages/".concat(a.id,"/").concat(l),{error:o}=await i.supabase.storage.from("attachments").upload(n,r,{cacheControl:"3600",upsert:!1});if(o){console.error("Erro ao fazer upload:",o);continue}let{data:{publicUrl:c}}=i.supabase.storage.from("attachments").getPublicUrl(n);await i.supabase.from("message_attachments").insert({message_id:e.id,message_type:"direct",file_name:r.name,file_url:c,file_type:s.type,file_size:r.size,mime_type:r.type,uploaded_by:t})}if(null==e?void 0:e.id){try{await fetch("/api/mentions/process",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({entityType:"direct_message",entityId:e.id,conversationId:a.id,otherUserId:a.other_user_id})})}catch(e){}(0,R.tC)({messageId:e.id,content:_.trim(),senderId:t,senderType:"collaborator",conversationType:a.is_client_conversation?"direct_client":"direct_team",clientId:a.is_client_conversation?a.other_user_id:void 0,conversationName:a.other_user_name||"Conversa direta"})}y(""),V([])}catch(e){console.error("Erro ao enviar mensagem:",e),alert("Erro ao enviar mensagem")}finally{B(!1)}}},em=(0,r.useMemo)(()=>{let e={userId:a.other_user_id,label:a.other_user_name||"Usu\xe1rio",email:a.other_user_email||void 0,avatarUrl:a.other_user_avatar};return e.userId?[e]:[]},[a.other_user_email,a.other_user_avatar,a.other_user_id,a.other_user_name]),eu=(0,r.useMemo)(()=>(0,T.X)(em,$),[em,$]),ex=()=>{let e=X.current;if(!e)return;let a=String(e.value||""),t="number"==typeof e.selectionStart?e.selectionStart:a.length,s=(0,M.XI)(a,t);if(!s.active){Y(!1),Q(""),ea(null);return}Y(!0),Q(s.query),ea({start:s.startIndex,end:s.endIndex})},eg=e=>{let a=X.current;if(!a||!ee)return;let t=String(a.value||""),{nextValue:s,nextCaretIndex:r}=(0,M.CE)({value:t,startIndex:ee.start,endIndex:ee.end,userId:e.userId,trailingSpace:!0});y(s),Y(!1),Q(""),ea(null),requestAnimationFrame(()=>{try{a.focus(),a.setSelectionRange(r,r)}catch(e){}})},eh=e=>{let a=document.getElementById("message-".concat(e));a&&es.current&&(a.scrollIntoView({behavior:"smooth",block:"center"}),H(e),setTimeout(()=>H(null),2e3))},ep=e=>new Date(e).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),ef=e=>{let a=new Date(e),t=new Date,s=new Date(t);return(s.setDate(s.getDate()-1),a.toDateString()===t.toDateString())?"Hoje":a.toDateString()===s.toDateString()?"Ontem":a.toLocaleDateString("pt-BR")},ev=e=>e.split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2),eb=(e,r)=>{let i=e.from_user_id===t,l=!i&&!!t&&String(e.body||"").includes("@{".concat(t,"}")),n=0===r||new Date(v[r-1].created_at).toDateString()!==new Date(e.created_at).toDateString();return(0,s.jsxs)("div",{children:[n&&(0,s.jsx)("div",{className:"flex items-center justify-center my-4",children:(0,s.jsx)("span",{className:"px-3 py-1 text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-full",children:ef(e.created_at)})}),(0,s.jsxs)("div",{id:"message-".concat(e.id),className:"flex gap-3 mb-4 group ".concat(i?"flex-row-reverse":""," ").concat(A.has(e.id)?"animate-slide-in":""," ").concat(G===e.id?"bg-yellow-100 dark:bg-yellow-900/20 p-2 rounded-lg":""," ").concat(l?"ring-2 ring-yellow-300/60 dark:ring-yellow-500/30 rounded-lg p-2":""),children:[!i&&(0,s.jsxs)("div",{className:"relative w-8 h-8 flex-shrink-0",children:[a.other_user_avatar?(0,s.jsx)("img",{src:a.other_user_avatar,alt:"",className:"w-8 h-8 rounded-full object-cover"}):(0,s.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-[#1672d6] to-[#001533] flex items-center justify-center text-xs text-white font-medium",children:ev(a.other_user_name||"U")}),(0,s.jsx)("div",{className:"absolute bottom-0 right-0",children:(0,s.jsx)(g.n,{userId:a.other_user_id,size:"sm"})})]}),(0,s.jsxs)("div",{className:"flex flex-col ".concat(i?"items-end":"items-start"," max-w-md"),children:[(0,s.jsxs)("div",{className:"rounded-2xl px-4 py-2 ".concat(i?"bg-blue-600 text-white":"bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white"),children:[e.body&&"(anexo)"!==e.body&&(0,s.jsx)("p",{className:"text-sm whitespace-pre-wrap break-words",children:(0,s.jsx)(q.d,{text:e.body,profilesById:K,highlightUserId:t||void 0})}),e.attachments&&e.attachments.length>0&&(0,s.jsx)("div",{className:"mt-2 space-y-2",children:e.attachments.map(e=>(0,s.jsx)(S.I,{attachment:e},e.id))})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 mt-1 flex-wrap",children:[(0,s.jsx)("span",{className:"text-xs text-gray-500",children:ep(e.created_at)}),i&&(0,s.jsx)("span",{title:e.is_read?"Lida":"Enviada",children:e.is_read?(0,s.jsx)(o.Z,{className:"w-3 h-3 text-blue-500"}):(0,s.jsx)(c.Z,{className:"w-3 h-3 text-gray-500"})})]}),(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsx)(I.g,{messageId:e.id,messageType:"direct",currentUserId:t,compact:!0})})]}),(0,s.jsx)("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex flex-col gap-1",children:(0,s.jsx)(D.s,{messageId:e.id,messageType:"direct",conversationId:a.id,currentUserId:t,compact:!0})})]})]},e.id)};return j?(0,s.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):(0,s.jsxs)("div",{className:"h-full flex flex-col bg-white dark:bg-gray-900",children:[(0,s.jsxs)("div",{className:"p-4 border-b flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsxs)("div",{className:"relative",children:[a.other_user_avatar?(0,s.jsx)("img",{src:a.other_user_avatar,alt:"",className:"w-10 h-10 rounded-full object-cover"}):(0,s.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-[#1672d6] to-[#001533] flex items-center justify-center text-white font-medium",children:ev(a.other_user_name)}),(0,s.jsx)("div",{className:"absolute bottom-0 right-0",children:(0,s.jsx)(g.n,{userId:a.other_user_id,size:"md"})})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("h3",{className:"font-semibold text-gray-900 dark:text-white",children:a.other_user_name}),a.is_client_conversation&&(0,s.jsx)("span",{className:"px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full",children:"Cliente"})]}),(0,s.jsx)(g.n,{userId:a.other_user_id,showLabel:!0,size:"sm"})]})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(z.w,{conversationId:a.id,conversationType:"direct",onResultClick:eh,participants:[{id:a.other_user_id,full_name:a.other_user_name}]}),a.is_client_conversation&&(0,s.jsx)(l.z,{variant:"ghost",size:"sm",onClick:()=>F(!0),title:"Hist\xf3rico de intera\xe7\xf5es",children:(0,s.jsx)(d.Z,{className:"w-5 h-5"})}),(0,s.jsx)(l.z,{variant:"ghost",size:"sm",children:(0,s.jsx)(m.Z,{className:"w-5 h-5"})})]})]}),(0,s.jsx)(E.q,{conversationId:a.id,conversationType:"direct",currentUserId:t,onMessageClick:eh}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-4",ref:es,children:[0===v.length?(0,s.jsx)("div",{className:"h-full flex items-center justify-center text-center",children:(0,s.jsxs)("div",{children:[(0,s.jsx)(u.Z,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"Nenhuma mensagem ainda"}),(0,s.jsx)("p",{className:"text-xs text-gray-400 mt-1",children:"Seja o primeiro a enviar uma mensagem!"})]})}):v.map((e,a)=>eb(e,a)),(0,s.jsx)("div",{ref:et})]}),f?(0,s.jsx)("div",{className:"px-4 py-3 border-t bg-gray-50 dark:bg-gray-900",children:(0,s.jsx)("p",{className:"text-xs text-gray-600 dark:text-gray-300",children:"Visualiza\xe7\xe3o do Super Admin: somente leitura (envio e “lido” desativados)."})}):(0,s.jsxs)("div",{className:"p-4 border-t space-y-3",children:[(0,s.jsx)(k.g,{onAttachmentsChange:V,maxFiles:5,maxSizeInMB:50}),(0,s.jsxs)("form",{onSubmit:ed,className:"flex items-start gap-2",children:[(0,s.jsx)(C.h,{onEmojiSelect:e=>{y(a=>a+e)}}),(0,s.jsxs)("div",{className:"relative flex-1",children:[(0,s.jsx)(n.II,{ref:X,value:_,onChange:e=>{y(e.target.value),e.target.value.length>0?er():ei(),requestAnimationFrame(()=>ex())},onBlur:()=>{ei(),setTimeout(()=>Y(!1),150)},onKeyUp:()=>ex(),onClick:()=>ex(),placeholder:"Digite uma mensagem... (use @ para mencionar)",disabled:L,className:"flex-1"}),J&&eu.length>0&&(0,s.jsx)("div",{className:"absolute left-0 right-0 bottom-full mb-2 z-50 rounded-lg border bg-white dark:bg-gray-900 shadow-lg overflow-hidden",children:(0,s.jsx)("div",{className:"max-h-56 overflow-y-auto",children:eu.map(e=>(0,s.jsxs)("button",{type:"button",onMouseDown:e=>e.preventDefault(),onClick:()=>eg(e),className:"w-full px-3 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-800",children:[(0,s.jsx)("div",{className:"text-sm font-medium text-gray-900 dark:text-white",children:e.label}),e.email&&(0,s.jsx)("div",{className:"text-xs text-gray-500",children:e.email})]},e.userId))})})]}),(0,s.jsx)(l.z,{type:"submit",disabled:!_.trim()&&0===P.length||L,className:"bg-blue-600 hover:bg-blue-700",children:(0,s.jsx)(u.Z,{className:"w-5 h-5"})})]})]}),a.is_client_conversation&&(0,s.jsxs)("div",{className:"px-4 py-2 bg-blue-50 dark:bg-blue-900/20 border-t flex items-center gap-2",children:[(0,s.jsx)(x.Z,{className:"w-4 h-4 text-blue-600"}),(0,s.jsx)("p",{className:"text-xs text-blue-700 dark:text-blue-300",children:"Conversando com cliente - Mensagens s\xe3o priorit\xe1rias"})]}),O&&(0,s.jsx)(N,{isOpen:O,onClose:()=>F(!1),clientId:a.other_user_id,clientName:a.other_user_name,conversationId:a.id})]})}},99851:function(e,a,t){t.d(a,{f:function(){return g}});var s=t(57437),r=t(2265),i=t(5526),l=t(69174),n=t(40279),o=t(12381),c=t(99397),d=t(73247),m=t(82718),u=t(67438),x=t(59304);function g(e){let{onSelectConversation:a,selectedConversationId:t,onNewConversation:g,currentUserId:h,filterType:p="all",peerTypeFilter:f="all",titleOverride:v,adminView:b=!1,allowedUserIds:_}=e,[y,j]=(0,r.useState)([]),[w,N]=(0,r.useState)(""),[k,S]=(0,r.useState)(!0);(0,r.useEffect)(()=>{C();let e=i.supabase.channel("direct-conversations-changes").on("postgres_changes",{event:"*",schema:"public",table:"direct_conversations"},()=>{C()}).on("postgres_changes",{event:"*",schema:"public",table:"direct_conversation_participants"},()=>{C()}).on("postgres_changes",{event:"*",schema:"public",table:"direct_messages"},()=>{C()}).subscribe();return()=>{i.supabase.removeChannel(e)}},[h]);let C=async()=>{try{S(!0);let e=[];if(b){let{data:a,error:t}=await i.supabase.from("direct_conversations").select("id, is_client_conversation, last_message_at, last_message_preview").order("last_message_at",{ascending:!1,nullsFirst:!1}).limit(200);if(t)throw t;let s=(a||[]).map(e=>e.id).filter(Boolean),{data:r}=await i.supabase.from("direct_conversation_participants").select("conversation_id, user_id").in("conversation_id",s).eq("is_active",!0),l=new Map;for(let e of r||[]){let a=String((null==e?void 0:e.conversation_id)||""),t=String((null==e?void 0:e.user_id)||"");a&&t&&l.set(a,[...l.get(a)||[],t])}let n=Array.from(new Set((r||[]).map(e=>String((null==e?void 0:e.user_id)||"")).filter(Boolean))),o=await (0,x.m)(i.supabase,n);e=(a||[]).map(e=>{let a=l.get(String(e.id))||[],t=a[0]||"";if(e.is_client_conversation){let e=a.find(e=>{var a;return(null===(a=o.get(e))||void 0===a?void 0:a.user_type)==="client"});e&&(t=e)}let s=t?o.get(t):null;return{...e,unread_count:0,other_user_id:t,other_user_name:(null==s?void 0:s.full_name)||"Conversa",other_user_email:(null==s?void 0:s.email)||"",other_user_avatar:null==s?void 0:s.avatar_url,other_user_type:(null==s?void 0:s.user_type)||""}})}else{let{data:a,error:t}=await i.supabase.from("direct_conversation_participants").select("\n            unread_count,\n            direct_conversations!inner (\n              id,\n              is_client_conversation,\n              last_message_at,\n              last_message_preview\n            )\n          ").eq("user_id",h).eq("is_active",!0);if(t)throw t;let s=(a||[]).map(e=>{var a;return null==e?void 0:null===(a=e.direct_conversations)||void 0===a?void 0:a.id}).filter(Boolean),{data:r}=await i.supabase.from("direct_conversation_participants").select("conversation_id, user_id").in("conversation_id",s).neq("user_id",h),l=new Map;for(let e of r||[])(null==e?void 0:e.conversation_id)&&(null==e?void 0:e.user_id)&&l.set(String(e.conversation_id),String(e.user_id));let n=Array.from(new Set(Array.from(l.values()))),o=await (0,x.m)(i.supabase,n);e=(a||[]).map(e=>{let a=e.direct_conversations,t=l.get(String((null==a?void 0:a.id)||""))||null;if(!(null==a?void 0:a.id)||!t)return null;let s=o.get(t);return{...a,unread_count:e.unread_count,other_user_id:t,other_user_name:(null==s?void 0:s.full_name)||"Usu\xe1rio",other_user_email:(null==s?void 0:s.email)||"",other_user_avatar:null==s?void 0:s.avatar_url,other_user_type:(null==s?void 0:s.user_type)||""}})}let a=e.filter(e=>null!==e);a.sort((e,a)=>{if(e.is_client_conversation&&!a.is_client_conversation)return -1;if(!e.is_client_conversation&&a.is_client_conversation)return 1;if(e.unread_count&&!a.unread_count)return -1;if(!e.unread_count&&a.unread_count)return 1;let t=e.last_message_at?new Date(e.last_message_at).getTime():0;return(a.last_message_at?new Date(a.last_message_at).getTime():0)-t}),j(a)}catch(e){console.error("Erro ao carregar conversas:",e)}finally{S(!1)}},I=y.filter(e=>{var a,t,s;if("clients"===p&&!e.is_client_conversation||"team"===p&&e.is_client_conversation||"client"===f&&"client"!==e.other_user_type||"non_client"===f&&"client"===e.other_user_type||_&&_.length>0&&!_.includes(e.other_user_id))return!1;if(!w)return!0;let r=w.toLowerCase();return(null===(a=e.other_user_name)||void 0===a?void 0:a.toLowerCase().includes(r))||(null===(t=e.other_user_email)||void 0===t?void 0:t.toLowerCase().includes(r))||(null===(s=e.last_message_preview)||void 0===s?void 0:s.toLowerCase().includes(r))}),z=e=>{if(!e)return"";let a=new Date(e),t=new Date().getTime()-a.getTime(),s=Math.floor(t/6e4),r=Math.floor(t/36e5),i=Math.floor(t/864e5);return s<1?"Agora":s<60?"".concat(s,"m"):r<24?"".concat(r,"h"):i<7?"".concat(i,"d"):a.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"})},E=e=>e.split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2);return k?(0,s.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):(0,s.jsxs)("div",{className:"h-full flex flex-col bg-white dark:bg-gray-900 border-r",children:[(0,s.jsxs)("div",{className:"p-4 border-b",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white flex-1",children:v||("clients"===p?"Clientes":"team"===p?"Equipe":"Conversas")}),!b&&(0,s.jsx)(o.z,{onClick:g,size:"sm",className:"bg-blue-600 hover:bg-blue-700",children:(0,s.jsx)(c.Z,{className:"w-4 h-4"})})]}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(d.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),(0,s.jsx)(n.II,{type:"text",placeholder:"Buscar conversas...",value:w,onChange:e=>N(e.target.value),className:"pl-10"})]})]}),(0,s.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===I.length?(0,s.jsxs)("div",{className:"p-8 text-center",children:[(0,s.jsx)(m.Z,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),(0,s.jsx)("p",{className:"text-sm text-gray-500",children:w?"Nenhuma conversa encontrada":"Nenhuma conversa ainda"}),!w&&(0,s.jsxs)(o.z,{onClick:g,variant:"outline",size:"sm",className:"mt-3",children:[(0,s.jsx)(c.Z,{className:"w-4 h-4 mr-2"}),"Nova Conversa"]})]}):I.map(e=>(0,s.jsx)("button",{onClick:()=>a(e),className:"w-full p-4 border-b hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors text-left ".concat(t===e.id?e.is_client_conversation?"bg-blue-50 dark:bg-blue-900/20 border-l-4 border-l-blue-600":"bg-blue-50 dark:bg-blue-900/20 border-l-4 border-l-primary":e.is_client_conversation&&e.unread_count&&e.unread_count>0?"bg-blue-50/50 dark:bg-blue-900/10 border-l-2 border-l-blue-400":""),children:(0,s.jsxs)("div",{className:"flex gap-3",children:[(0,s.jsxs)("div",{className:"relative flex-shrink-0",children:[e.other_user_avatar?(0,s.jsx)("img",{src:e.other_user_avatar,alt:"",className:"w-12 h-12 rounded-full object-cover"}):(0,s.jsx)("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-[#1672d6] to-[#001533] flex items-center justify-center text-white font-medium",children:E(e.other_user_name)}),(0,s.jsx)("div",{className:"absolute bottom-0 right-0",children:(0,s.jsx)(u.n,{userId:e.other_user_id,size:"md"})}),e.unread_count&&e.unread_count>0&&(0,s.jsx)(l.C,{className:"absolute -top-1 -right-1 h-5 min-w-5 flex items-center justify-center p-0 bg-red-600 text-white text-xs",children:e.unread_count>9?"9+":e.unread_count})]}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex items-start justify-between mb-1",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[(0,s.jsx)("span",{className:"font-medium text-gray-900 dark:text-white truncate ".concat(e.unread_count&&e.unread_count>0?"font-bold":""),children:e.other_user_name}),e.is_client_conversation&&(0,s.jsx)(l.C,{className:"text-xs flex-shrink-0 bg-blue-600 text-white border-0 shadow-sm",children:"Cliente"})]}),(0,s.jsx)("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:z(e.last_message_at)})]}),(0,s.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400 truncate mb-1",children:e.other_user_email}),e.last_message_preview&&(0,s.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 truncate ".concat(e.unread_count&&e.unread_count>0?"font-semibold text-gray-900 dark:text-white":""),children:e.last_message_preview})]})]})},e.id))})]})}},14946:function(e,a,t){t.d(a,{h:function(){return c}});var s=t(57437),r=t(2265),i=t(30166),l=t(71422),n=t(12381);let o=(0,i.default)(()=>Promise.all([t.e(4560),t.e(8497)]).then(t.bind(t,41799)),{loadableGenerated:{webpack:()=>[41799]},ssr:!1});function c(e){let{onEmojiSelect:a,buttonClassName:t}=e,[i,c]=(0,r.useState)(!1),d=(0,r.useRef)(null);return(0,r.useEffect)(()=>{function e(e){d.current&&!d.current.contains(e.target)&&c(!1)}if(i)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[i]),(0,s.jsxs)("div",{className:"relative",ref:d,children:[(0,s.jsx)(n.z,{type:"button",variant:"ghost",size:"sm",onClick:()=>c(!i),className:t,title:"Adicionar emoji",children:(0,s.jsx)(l.Z,{className:"w-5 h-5"})}),i&&(0,s.jsx)("div",{className:"absolute bottom-12 right-0 z-50 shadow-xl",children:(0,s.jsx)(o,{onEmojiClick:e=>{a(e.emoji),c(!1)},searchPlaceholder:"Buscar emoji...",previewConfig:{showPreview:!1},width:320,height:400})})]})}},19671:function(e,a,t){t.d(a,{r:function(){return O}});var s=t(57437),r=t(2265),i=t(5526),l=t(12381),n=t(40279),o=t(95805),c=t(98728),d=t(44743),m=t(59304);function u(e){let{groupId:a,currentUserId:t}=e,[l,n]=(0,r.useState)([]);(0,r.useEffect)(()=>{o();let e=i.supabase.channel("typing-".concat(a)).on("postgres_changes",{event:"*",schema:"public",table:"typing_indicators",filter:"group_id=eq.".concat(a)},()=>{o()}).subscribe(),t=setInterval(()=>{o()},2e3);return()=>{i.supabase.removeChannel(e),clearInterval(t)}},[a]);let o=async()=>{try{let{data:e,error:s}=await i.supabase.from("typing_indicators").select("user_id").eq("group_id",a).neq("user_id",t).gt("expires_at",new Date().toISOString());if(s)throw s;let r=Array.from(new Set((e||[]).map(e=>String((null==e?void 0:e.user_id)||"")).filter(Boolean))),l=await (0,m.m)(i.supabase,r),o=r.map(e=>{var a;return{user_id:e,full_name:(null===(a=l.get(e))||void 0===a?void 0:a.full_name)||"Usu\xe1rio"}});n(o)}catch(e){console.error("Erro ao carregar indicadores:",e)}};return 0===l.length?null:(0,s.jsxs)("div",{className:"px-4 py-2 text-sm text-gray-600 dark:text-gray-400 italic flex items-center gap-2",children:[(0,s.jsxs)("div",{className:"flex gap-1",children:[(0,s.jsx)("span",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),(0,s.jsx)("span",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),(0,s.jsx)("span",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),(0,s.jsxs)("span",{children:[1===l.length?"".concat(l[0].full_name," est\xe1 digitando"):2===l.length?"".concat(l[0].full_name," e ").concat(l[1].full_name," est\xe3o digitando"):"".concat(l[0].full_name," e mais ").concat(l.length-1," pessoas est\xe3o digitando"),"..."]})]})}var x=t(67438),g=t(79820),h=t(69174),p=t(88893),f=t(83229),v=t(32489),b=t(98617),_=t(48837),y=t(73247),j=t(37806),w=t(53581),N=t(17689);function k(e){let{isOpen:a,onClose:t,groupId:c,groupName:d,groupDescription:u,currentUserId:k,isAdmin:S}=e,[C,I]=(0,r.useState)([]),[z,E]=(0,r.useState)([]),[D,Z]=(0,r.useState)(""),[q,M]=(0,r.useState)(!1),[T,R]=(0,r.useState)(d),[L,B]=(0,r.useState)(u||""),[A,U]=(0,r.useState)(!1),[O,F]=(0,r.useState)("members"),[P,V]=(0,r.useState)(null),[G,H]=(0,r.useState)(!1);(0,r.useEffect)(()=>{a&&(X(),J(),K())},[a,c]);let K=async()=>{try{let{data:e,error:a}=await i.supabase.from("message_groups").select("avatar_url").eq("id",c).maybeSingle();if(a)throw a;V((null==e?void 0:e.avatar_url)||null)}catch(e){console.error("Erro ao carregar informa\xe7\xf5es do grupo:",e)}},W=async e=>{var a;let t=null===(a=e.target.files)||void 0===a?void 0:a[0];if(t&&S){H(!0);try{let e=t.name.split(".").pop(),a="".concat(c,"-").concat(Date.now(),".").concat(e),s="group-avatars/".concat(a),{error:r}=await i.supabase.storage.from("avatars").upload(s,t,{upsert:!0});if(r)throw r;let{data:{publicUrl:l}}=i.supabase.storage.from("avatars").getPublicUrl(s),{error:n}=await i.supabase.from("message_groups").update({avatar_url:l}).eq("id",c);if(n)throw n;V(l),alert("Avatar atualizado com sucesso!")}catch(e){console.error("Erro ao fazer upload:",e),alert("Erro ao fazer upload do avatar")}finally{H(!1)}}},X=async()=>{try{let{data:e,error:a}=await i.supabase.from("group_participants").select("id, user_id, role, joined_at").eq("group_id",c).eq("is_active",!0).order("role",{ascending:!1}).order("joined_at",{ascending:!0});if(a)throw a;let t=Array.from(new Set((e||[]).map(e=>String((null==e?void 0:e.user_id)||"")).filter(Boolean))),s=await (0,m.m)(i.supabase,t),r=(e||[]).map(e=>{var a,t,r;return{id:e.id,user_id:e.user_id,role:e.role,joined_at:e.joined_at,full_name:(null===(a=s.get(String(e.user_id)))||void 0===a?void 0:a.full_name)||"Usu\xe1rio",email:(null===(t=s.get(String(e.user_id)))||void 0===t?void 0:t.email)||"",avatar_url:null===(r=s.get(String(e.user_id)))||void 0===r?void 0:r.avatar_url}});I(r)}catch(e){console.error("Erro ao carregar membros:",e)}},J=async()=>{try{let e=[],a=await i.supabase.from("user_profiles").select("id, user_id, full_name, email, user_type, avatar_url, avatar").neq("user_type","client");if(a.error){let a=await i.supabase.from("user_profiles").select("id, full_name, email, user_type, avatar_url, avatar").neq("user_type","client");if(a.error)throw a.error;e=a.data||[]}else e=a.data||[];let t=new Set(C.map(e=>String(e.user_id))),s=(e||[]).map(e=>{let a=(null==e?void 0:e.user_id)?String(e.user_id):(null==e?void 0:e.id)?String(e.id):null;return a?{id:a,full_name:String((null==e?void 0:e.full_name)||"Usu\xe1rio"),email:String((null==e?void 0:e.email)||""),user_type:String((null==e?void 0:e.user_type)||""),avatar_url:(null==e?void 0:e.avatar_url)?String(e.avatar_url):(null==e?void 0:e.avatar)?String(e.avatar):void 0}:null}).filter(Boolean).filter(e=>!t.has(String(e.id)));E(s)}catch(e){console.error("Erro ao carregar usu\xe1rios:",e)}},Y=async e=>{if(!S){alert("Apenas administradores podem adicionar membros");return}U(!0);try{let{error:a}=await i.supabase.from("group_participants").insert({group_id:c,user_id:e,role:"member",is_active:!0});if(a)throw a;await X(),await J()}catch(e){console.error("Erro ao adicionar membro:",e),alert("Erro ao adicionar membro")}finally{U(!1)}},$=async(e,a)=>{if(!S){alert("Apenas administradores podem remover membros");return}if(a===k){alert("Voc\xea n\xe3o pode remover a si mesmo");return}if(confirm("Tem certeza que deseja remover este membro?")){U(!0);try{let{error:a}=await i.supabase.from("group_participants").update({is_active:!1}).eq("id",e);if(a)throw a;await X(),await J()}catch(e){console.error("Erro ao remover membro:",e),alert("Erro ao remover membro")}finally{U(!1)}}},Q=async(e,a)=>{if(!S){alert("Apenas administradores podem alterar fun\xe7\xf5es");return}U(!0);try{let{error:t}=await i.supabase.from("group_participants").update({role:"admin"===a?"member":"admin"}).eq("id",e);if(t)throw t;await X()}catch(e){console.error("Erro ao alterar fun\xe7\xe3o:",e),alert("Erro ao alterar fun\xe7\xe3o")}finally{U(!1)}},ee=async()=>{if(!S){alert("Apenas administradores podem editar informa\xe7\xf5es do grupo");return}U(!0);try{let{error:e}=await i.supabase.from("message_groups").update({name:T,description:L,updated_at:new Date().toISOString()}).eq("id",c);if(e)throw e;M(!1),alert("Informa\xe7\xf5es do grupo atualizadas!")}catch(e){console.error("Erro ao atualizar grupo:",e),alert("Erro ao atualizar informa\xe7\xf5es")}finally{U(!1)}},ea=z.filter(e=>e.full_name.toLowerCase().includes(D.toLowerCase())||e.email.toLowerCase().includes(D.toLowerCase())),et=e=>e.split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2);return a?(0,s.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:(0,s.jsxs)(g.Zb,{className:"w-full max-w-3xl max-h-[90vh] flex flex-col",children:[(0,s.jsx)(g.Ol,{className:"flex-shrink-0 border-b",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("div",{className:"flex-1",children:q?(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(n.II,{value:T,onChange:e=>R(e.target.value),className:"text-lg font-semibold"}),(0,s.jsx)(n.II,{value:L,onChange:e=>B(e.target.value),placeholder:"Descri\xe7\xe3o do grupo",className:"text-sm"})]}):(0,s.jsxs)("div",{children:[(0,s.jsxs)(g.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(o.Z,{className:"w-5 h-5"}),T,S&&(0,s.jsx)("button",{onClick:()=>M(!0),className:"ml-2 p-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded",children:(0,s.jsx)(p.Z,{className:"w-4 h-4"})})]}),L&&(0,s.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:L}),(0,s.jsxs)("p",{className:"text-xs text-gray-500 mt-2",children:[C.length," membros"]})]})}),(0,s.jsxs)("div",{className:"flex gap-2",children:[q&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(l.z,{size:"sm",onClick:ee,disabled:A,children:(0,s.jsx)(f.Z,{className:"w-4 h-4"})}),(0,s.jsx)(l.z,{size:"sm",variant:"outline",onClick:()=>{M(!1),R(d),B(u||"")},children:(0,s.jsx)(v.Z,{className:"w-4 h-4"})})]}),(0,s.jsx)(l.z,{variant:"ghost",size:"sm",onClick:t,children:(0,s.jsx)(v.Z,{className:"w-5 h-5"})})]})]})}),(0,s.jsx)("div",{className:"flex-shrink-0 border-b",children:(0,s.jsxs)("div",{className:"flex",children:[(0,s.jsxs)("button",{onClick:()=>F("members"),className:"flex-1 px-4 py-3 text-sm font-medium transition-colors ".concat("members"===O?"border-b-2 border-primary text-blue-600":"text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"),children:["Membros (",C.length,")"]}),S&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{onClick:()=>F("add"),className:"flex-1 px-4 py-3 text-sm font-medium transition-colors ".concat("add"===O?"border-b-2 border-primary text-blue-600":"text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"),children:"Adicionar Membros"}),(0,s.jsx)("button",{onClick:()=>F("settings"),className:"flex-1 px-4 py-3 text-sm font-medium transition-colors ".concat("settings"===O?"border-b-2 border-primary text-blue-600":"text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"),children:"Configura\xe7\xf5es"})]})]})}),(0,s.jsx)(g.aY,{className:"flex-1 overflow-y-auto p-0",children:"members"===O?(0,s.jsx)("div",{children:C.map(e=>(0,s.jsx)("div",{className:"p-4 border-b hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors",children:(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsxs)("div",{className:"relative",children:[e.avatar_url?(0,s.jsx)("img",{src:e.avatar_url,alt:"",className:"w-12 h-12 rounded-full object-cover"}):(0,s.jsx)("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-[#1672d6] to-[#001533] flex items-center justify-center text-white font-medium",children:et(e.full_name)}),(0,s.jsx)("div",{className:"absolute bottom-0 right-0",children:(0,s.jsx)(x.n,{userId:e.user_id,size:"md"})})]}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white truncate",children:e.full_name}),"admin"===e.role&&(0,s.jsxs)(h.C,{className:"bg-blue-600 text-white",children:[(0,s.jsx)(b.Z,{className:"w-3 h-3 mr-1"}),"Admin"]}),e.user_id===k&&(0,s.jsx)(h.C,{variant:"outline",children:"Voc\xea"})]}),(0,s.jsx)("p",{className:"text-xs text-gray-500 truncate",children:e.email}),(0,s.jsxs)("p",{className:"text-xs text-gray-400",children:["Entrou em ",new Date(e.joined_at).toLocaleDateString("pt-BR")]})]}),S&&e.user_id!==k&&(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(l.z,{size:"sm",variant:"outline",onClick:()=>Q(e.id,e.role),title:"admin"===e.role?"Remover como admin":"Promover a admin",children:(0,s.jsx)(b.Z,{className:"w-4 h-4"})}),(0,s.jsx)(l.z,{size:"sm",variant:"outline",onClick:()=>$(e.id,e.user_id),title:"Remover do grupo",className:"text-red-600 hover:bg-red-50",children:(0,s.jsx)(_.Z,{className:"w-4 h-4"})})]})]})},e.id))}):"add"===O?(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"p-4 border-b",children:(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(y.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),(0,s.jsx)(n.II,{type:"text",placeholder:"Buscar por nome ou email...",value:D,onChange:e=>Z(e.target.value),className:"pl-10"})]})}),(0,s.jsx)("div",{children:0===ea.length?(0,s.jsx)("div",{className:"p-8 text-center",children:(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"Nenhum usu\xe1rio dispon\xedvel"})}):ea.map(e=>(0,s.jsx)("div",{className:"p-4 border-b hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors",children:(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[e.avatar_url?(0,s.jsx)("img",{src:e.avatar_url,alt:"",className:"w-10 h-10 rounded-full object-cover"}):(0,s.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-[#1672d6] to-[#001533] flex items-center justify-center text-white font-medium",children:et(e.full_name)}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white truncate",children:e.full_name}),(0,s.jsx)("p",{className:"text-xs text-gray-500 truncate",children:e.email})]}),(0,s.jsxs)(l.z,{size:"sm",onClick:()=>Y(e.id),disabled:A,className:"bg-blue-600 hover:bg-blue-700",children:[(0,s.jsx)(j.Z,{className:"w-4 h-4 mr-1"}),"Adicionar"]})]})},e.id))})]}):(0,s.jsxs)("div",{className:"p-6 space-y-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Avatar do Grupo"}),(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(0,s.jsxs)("div",{className:"relative",children:[P?(0,s.jsx)("img",{src:P,alt:"Avatar do grupo",className:"w-24 h-24 rounded-full object-cover border-4 border-gray-200 dark:border-gray-700"}):(0,s.jsx)("div",{className:"w-24 h-24 rounded-full bg-gradient-to-br from-[#1672d6] to-[#001533] flex items-center justify-center border-4 border-gray-200 dark:border-gray-700",children:(0,s.jsx)(o.Z,{className:"w-12 h-12 text-white"})}),S&&(0,s.jsx)("label",{htmlFor:"avatar-upload",className:"absolute bottom-0 right-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-700 transition-colors shadow-lg",children:(0,s.jsx)(w.Z,{className:"w-4 h-4 text-white"})}),(0,s.jsx)("input",{id:"avatar-upload",type:"file",accept:"image/*",onChange:W,className:"hidden",disabled:!S||G})]}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-2",children:"Personalize o avatar do grupo"}),S&&(0,s.jsxs)("label",{htmlFor:"avatar-upload",className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors cursor-pointer",children:[(0,s.jsx)(N.Z,{className:"w-4 h-4"}),G?"Enviando...":"Carregar Imagem"]}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-2",children:"Recomendado: 256x256px, m\xe1x 2MB"})]})]})]}),(0,s.jsxs)("div",{className:"border-t pt-6",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Informa\xe7\xf5es do Grupo"}),(0,s.jsxs)("div",{className:"space-y-3 text-sm",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600 dark:text-gray-400",children:"Total de membros:"}),(0,s.jsx)("span",{className:"font-medium text-gray-900 dark:text-white",children:C.length})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600 dark:text-gray-400",children:"Administradores:"}),(0,s.jsx)("span",{className:"font-medium text-gray-900 dark:text-white",children:C.filter(e=>"admin"===e.role).length})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600 dark:text-gray-400",children:"Tipo:"}),(0,s.jsx)(h.C,{variant:"outline",children:"Grupo"})]})]})]})]})})]})}):null}var S=t(59196);function C(e){let{messageId:a,groupId:t,currentUserId:l,isOwnMessage:n}=e,[o,c]=(0,r.useState)([]),[d,u]=(0,r.useState)(!1);(0,r.useEffect)(()=>{if(n){x();let e=i.supabase.channel("seen-".concat(a)).on("postgres_changes",{event:"*",schema:"public",table:"message_read_receipts",filter:"message_id=eq.".concat(a)},()=>{x()}).subscribe();return()=>{i.supabase.removeChannel(e)}}},[a,n]);let x=async()=>{try{let{data:e,error:t}=await i.supabase.from("message_read_receipts").select("user_id, read_at").eq("message_id",a).eq("message_type","group").neq("user_id",l);if(t)throw t;let s=Array.from(new Set((e||[]).map(e=>String((null==e?void 0:e.user_id)||"")).filter(Boolean))),r=await (0,m.m)(i.supabase,s),n=(e||[]).map(e=>{let a=String(e.user_id||""),t=r.get(a);return{user_id:a,full_name:(null==t?void 0:t.full_name)||"Usu\xe1rio",avatar_url:null==t?void 0:t.avatar_url,read_at:e.read_at}});c(n)}catch(e){console.error("Erro ao carregar visualiza\xe7\xf5es:",e)}};if(!n||0===o.length)return null;let g=e=>new Date(e).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});return(0,s.jsxs)("div",{className:"relative inline-block",children:[(0,s.jsxs)("div",{className:"flex items-center gap-1 cursor-pointer",onMouseEnter:()=>u(!0),onMouseLeave:()=>u(!1),children:[(0,s.jsx)(S.Z,{className:"w-3 h-3 text-blue-500"}),(0,s.jsx)("span",{className:"text-xs text-blue-500",children:o.length})]}),d&&(0,s.jsxs)("div",{className:"absolute bottom-full right-0 mb-2 w-64 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-3 z-50",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-gray-900 dark:text-white mb-2",children:"Visto por"}),(0,s.jsx)("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:o.map(e=>(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[e.avatar_url?(0,s.jsx)("img",{src:e.avatar_url,alt:"",className:"w-6 h-6 rounded-full object-cover"}):(0,s.jsx)("div",{className:"w-6 h-6 rounded-full bg-gradient-to-br from-[#1672d6] to-[#001533] flex items-center justify-center text-xs text-white",children:e.full_name[0]}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"text-xs font-medium text-gray-900 dark:text-white truncate",children:e.full_name}),(0,s.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:g(e.read_at)})]})]},e.user_id))})]})]})}var I=t(73997),z=t(15208),E=t(14946),D=t(20852),Z=t(35444),q=t(66491),M=t(68934),T=t(76862),R=t(2390),L=t(32846),B=t(61474),A=t(23993),U=t(93825);function O(e){let{group:a,currentUserId:t,readOnly:g=!1}=e,[h,p]=(0,r.useState)([]),[f,v]=(0,r.useState)(""),[b,_]=(0,r.useState)(!0),[y,j]=(0,r.useState)(!1),[w,N]=(0,r.useState)(!1),[S,O]=(0,r.useState)(!1),[F,P]=(0,r.useState)(new Set),[V,G]=(0,r.useState)([]),[H,K]=(0,r.useState)(null),[W,X]=(0,r.useState)(new Map),J=(0,r.useRef)(null),[Y,$]=(0,r.useState)(!1),[Q,ee]=(0,r.useState)(""),[ea,et]=(0,r.useState)(null),[es,er]=(0,r.useState)([]),ei=(0,r.useRef)(null),el=(0,r.useRef)(null),en=(0,r.useRef)(0),{startTyping:eo,stopTyping:ec}=(0,T.o)({userId:t,groupId:a.id}),{playNotificationSound:ed}=(0,R.r)();(0,r.useEffect)(()=>{if(null==a?void 0:a.id){eu(),ex(),eg(),g||eh();let e=i.supabase.channel("messages-".concat(a.id)).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:"group_id=eq.".concat(a.id)},e=>{let a=e.new;a.from_user_id!==t&&(ed(),P(e=>new Set(e).add(a.id)),setTimeout(()=>{P(e=>{let t=new Set(e);return t.delete(a.id),t})},500)),eu(),g||eh()}).subscribe();return()=>{i.supabase.removeChannel(e)}}},[null==a?void 0:a.id]),(0,r.useEffect)(()=>{em()},[h]);let em=()=>{var e;null===(e=ei.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},eu=async()=>{try{_(!0);let{data:e,error:s}=await i.supabase.from("messages").select("*").eq("group_id",a.id).order("created_at",{ascending:!0}).limit(100);if(s)throw s;let r=Array.from(new Set((e||[]).map(e=>String((null==e?void 0:e.from_user_id)||"")).filter(Boolean))),l=await (0,m.m)(i.supabase,r),n=await Promise.all((e||[]).map(async e=>{var a,t;let{data:s}=await i.supabase.from("message_attachments").select("*").eq("message_id",e.id).eq("message_type","group");return{...e,sender_name:null===(a=l.get(String(e.from_user_id)))||void 0===a?void 0:a.full_name,sender_avatar:null===(t=l.get(String(e.from_user_id)))||void 0===t?void 0:t.avatar_url,attachments:s||[]}}));!b&&n.length>en.current&&n.slice(en.current).forEach(e=>{e.from_user_id!==t&&P(a=>new Set(a).add(e.id))}),en.current=n.length,p(n);try{let e=Array.from(new Set((n||[]).flatMap(e=>(0,B.MN)(String((null==e?void 0:e.body)||"")))));if(e.length>0){let a=await (0,m.m)(i.supabase,e);X(a)}else X(new Map)}catch(e){}}catch(e){console.error("Erro ao carregar mensagens:",e)}finally{_(!1)}},ex=async()=>{try{let{data:e,error:s}=await i.supabase.from("group_participants").select("role").eq("group_id",a.id).eq("user_id",t).eq("is_active",!0).maybeSingle();if(s)throw s;O((null==e?void 0:e.role)==="admin")}catch(e){console.error("Erro ao verificar admin:",e)}},eg=async()=>{try{let{data:e,error:t}=await i.supabase.from("group_participants").select("user_id").eq("group_id",a.id).eq("is_active",!0);if(t)throw t;let s=Array.from(new Set((e||[]).map(e=>String((null==e?void 0:e.user_id)||"")).filter(Boolean))),r=await (0,m.m)(i.supabase,s),l=(s||[]).map(e=>{var a;return{id:e,full_name:(null===(a=r.get(e))||void 0===a?void 0:a.full_name)||"Usu\xe1rio"}});er(l)}catch(e){console.error("Erro ao carregar participantes:",e)}},eh=async()=>{try{await i.supabase.rpc("mark_group_messages_as_read",{p_group_id:a.id,p_user_id:t})}catch(e){console.error("Erro ao marcar como lido:",e)}},ep=async e=>{if(e.preventDefault(),!g&&(f.trim()||0!==V.length)&&!y){j(!0),ec();try{let{data:e,error:s}=await i.supabase.from("messages").insert({group_id:a.id,from_user_id:t,body:f.trim()||"(anexo)",type:V.length>0?"attachment":"text"}).select().single();if(s)throw s;if(V.length>0&&e)for(let s of V){let r=s.file,l="".concat(Date.now(),"-").concat(r.name),n="messages/".concat(a.id,"/").concat(l),{error:o}=await i.supabase.storage.from("attachments").upload(n,r,{cacheControl:"3600",upsert:!1});if(o){console.error("Erro ao fazer upload:",o);continue}let{data:{publicUrl:c}}=i.supabase.storage.from("attachments").getPublicUrl(n);await i.supabase.from("message_attachments").insert({message_id:e.id,message_type:"group",file_name:r.name,file_url:c,file_type:s.type,file_size:r.size,mime_type:r.type,uploaded_by:t})}if(null==e?void 0:e.id){try{await fetch("/api/mentions/process",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({entityType:"group_message",entityId:e.id,groupId:a.id})})}catch(e){}(0,U.tC)({messageId:e.id,content:f.trim(),senderId:t,senderType:"collaborator",conversationType:"group",groupId:a.id,conversationName:a.name})}v(""),G([])}catch(e){console.error("Erro ao enviar mensagem:",e),alert("Erro ao enviar mensagem")}finally{j(!1)}}},ef=(0,r.useMemo)(()=>(es||[]).map(e=>({userId:String(e.id),label:String(e.full_name||"Usu\xe1rio")})).filter(e=>!!e.userId&&e.userId!==t),[es,t]),ev=(0,r.useMemo)(()=>(0,A.X)(ef,Q),[ef,Q]),eb=()=>{let e=J.current;if(!e)return;let a=String(e.value||""),t="number"==typeof e.selectionStart?e.selectionStart:a.length,s=(0,B.XI)(a,t);if(!s.active){$(!1),ee(""),et(null);return}$(!0),ee(s.query),et({start:s.startIndex,end:s.endIndex})},e_=e=>{let a=J.current;if(!a||!ea)return;let t=String(a.value||""),{nextValue:s,nextCaretIndex:r}=(0,B.CE)({value:t,startIndex:ea.start,endIndex:ea.end,userId:e.userId,trailingSpace:!0});v(s),$(!1),ee(""),et(null),requestAnimationFrame(()=>{try{a.focus(),a.setSelectionRange(r,r)}catch(e){}})},ey=e=>{let a=document.getElementById("message-".concat(e));a&&el.current&&(a.scrollIntoView({behavior:"smooth",block:"center"}),K(e),setTimeout(()=>K(null),2e3))},ej=e=>new Date(e).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),ew=e=>{let a=new Date(e),t=new Date,s=new Date(t);return(s.setDate(s.getDate()-1),a.toDateString()===t.toDateString())?"Hoje":a.toDateString()===s.toDateString()?"Ontem":a.toLocaleDateString("pt-BR")},eN=e=>e.split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2),ek=(e,r)=>{let i=e.from_user_id===t,l=!i&&!!t&&String(e.body||"").includes("@{".concat(t,"}")),n=0===r||new Date(h[r-1].created_at).toDateString()!==new Date(e.created_at).toDateString();return(0,s.jsxs)("div",{children:[n&&(0,s.jsx)("div",{className:"flex items-center justify-center my-4",children:(0,s.jsx)("span",{className:"px-3 py-1 text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-full",children:ew(e.created_at)})}),(0,s.jsxs)("div",{id:"message-".concat(e.id),className:"flex gap-3 mb-4 group ".concat(i?"flex-row-reverse":""," ").concat(F.has(e.id)?"animate-slide-in":""," ").concat(H===e.id?"bg-yellow-100 dark:bg-yellow-900/20 p-2 rounded-lg":""," ").concat(l?"ring-2 ring-yellow-300/60 dark:ring-yellow-500/30 rounded-lg p-2":""),style:{animation:F.has(e.id)?"slideIn 0.3s ease-out":void 0},children:[!i&&(0,s.jsxs)("div",{className:"relative w-8 h-8 flex-shrink-0",children:[e.sender_avatar?(0,s.jsx)("img",{src:e.sender_avatar,alt:"",className:"w-8 h-8 rounded-full object-cover"}):(0,s.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-[#1672d6] to-[#001533] flex items-center justify-center text-xs text-white font-medium",children:eN(e.sender_name||"U")}),(0,s.jsx)("div",{className:"absolute bottom-0 right-0",children:(0,s.jsx)(x.n,{userId:e.from_user_id,size:"sm"})})]}),(0,s.jsxs)("div",{className:"flex flex-col ".concat(i?"items-end":"items-start"," max-w-md"),children:[!i&&(0,s.jsx)("span",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1",children:e.sender_name}),(0,s.jsxs)("div",{className:"rounded-2xl px-4 py-2 ".concat(i?"bg-blue-600 text-white":"bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white"),children:[e.body&&"(anexo)"!==e.body&&(0,s.jsx)("p",{className:"text-sm whitespace-pre-wrap break-words",children:(0,s.jsx)(L.d,{text:e.body,profilesById:W,highlightUserId:t||void 0})}),e.attachments&&e.attachments.length>0&&(0,s.jsx)("div",{className:"mt-2 space-y-2",children:e.attachments.map(e=>(0,s.jsx)(z.I,{attachment:e},e.id))})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[(0,s.jsx)("span",{className:"text-xs text-gray-500",children:ej(e.created_at)}),(0,s.jsx)(C,{messageId:e.id,groupId:a.id,currentUserId:t,isOwnMessage:i})]}),(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsx)(D.g,{messageId:e.id,messageType:"group",currentUserId:t,compact:!0})})]}),S&&(0,s.jsx)("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex flex-col gap-1",children:(0,s.jsx)(M.s,{messageId:e.id,messageType:"group",conversationId:a.id,currentUserId:t,compact:!0})})]})]},e.id)};return b?(0,s.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):(0,s.jsxs)("div",{className:"h-full flex flex-col bg-white dark:bg-gray-900",children:[(0,s.jsxs)("div",{className:"p-4 border-b flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-[#1672d6] to-[#001533] flex items-center justify-center text-white",children:(0,s.jsx)(o.Z,{className:"w-5 h-5"})}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-semibold text-gray-900 dark:text-white",children:a.name}),a.description&&(0,s.jsx)("p",{className:"text-xs text-gray-500",children:a.description})]})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(Z.w,{conversationId:a.id,conversationType:"group",onResultClick:ey,participants:es}),!g&&(0,s.jsx)(l.z,{variant:"ghost",size:"sm",onClick:()=>N(!0),title:"Gerenciar grupo",children:(0,s.jsx)(c.Z,{className:"w-5 h-5"})})]})]}),(0,s.jsx)(q.q,{conversationId:a.id,conversationType:"group",currentUserId:t,onMessageClick:ey}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-4",ref:el,children:[0===h.length?(0,s.jsx)("div",{className:"h-full flex items-center justify-center text-center",children:(0,s.jsxs)("div",{children:[(0,s.jsx)(d.Z,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"Nenhuma mensagem ainda"}),(0,s.jsx)("p",{className:"text-xs text-gray-400 mt-1",children:"Seja o primeiro a enviar uma mensagem!"})]})}):h.map((e,a)=>ek(e,a)),(0,s.jsx)("div",{ref:ei})]}),!g&&(0,s.jsx)(u,{groupId:a.id,currentUserId:t}),g?(0,s.jsx)("div",{className:"px-4 py-3 border-t bg-gray-50 dark:bg-gray-900",children:(0,s.jsx)("p",{className:"text-xs text-gray-600 dark:text-gray-300",children:"Visualiza\xe7\xe3o do Super Admin: somente leitura (envio e “lido” desativados)."})}):(0,s.jsxs)("div",{className:"p-4 border-t space-y-3",children:[(0,s.jsx)(I.g,{onAttachmentsChange:G,maxFiles:5,maxSizeInMB:50}),(0,s.jsxs)("form",{onSubmit:ep,className:"flex items-start gap-2",children:[(0,s.jsx)(E.h,{onEmojiSelect:e=>{v(a=>a+e)}}),(0,s.jsxs)("div",{className:"relative flex-1",children:[(0,s.jsx)(n.II,{ref:J,value:f,onChange:e=>{v(e.target.value),e.target.value.length>0?eo():ec(),requestAnimationFrame(()=>eb())},onBlur:()=>{ec(),setTimeout(()=>$(!1),150)},onKeyUp:()=>eb(),onClick:()=>eb(),placeholder:"Digite uma mensagem... (use @ para mencionar)",disabled:y,className:"flex-1"}),Y&&ev.length>0&&(0,s.jsx)("div",{className:"absolute left-0 right-0 bottom-full mb-2 z-50 rounded-lg border bg-white dark:bg-gray-900 shadow-lg overflow-hidden",children:(0,s.jsx)("div",{className:"max-h-56 overflow-y-auto",children:ev.map(e=>(0,s.jsxs)("button",{type:"button",onMouseDown:e=>e.preventDefault(),onClick:()=>e_(e),className:"w-full px-3 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-800",children:[(0,s.jsx)("div",{className:"text-sm font-medium text-gray-900 dark:text-white",children:e.label}),e.email&&(0,s.jsx)("div",{className:"text-xs text-gray-500",children:e.email})]},e.userId))})})]}),(0,s.jsx)(l.z,{type:"submit",disabled:!f.trim()&&0===V.length||y,className:"bg-blue-600 hover:bg-blue-700",children:(0,s.jsx)(d.Z,{className:"w-5 h-5"})})]})]}),w&&(0,s.jsx)(k,{isOpen:w,onClose:()=>N(!1),groupId:a.id,groupName:a.name,groupDescription:a.description,currentUserId:t,isAdmin:S})]})}},96342:function(e,a,t){t.d(a,{c:function(){return x}});var s=t(57437),r=t(2265),i=t(5526),l=t(69174),n=t(40279),o=t(12381),c=t(95805),d=t(82718),m=t(99397),u=t(73247);function x(e){let{onSelectGroup:a,selectedGroupId:t,currentUserId:x,adminView:g=!1,onCreateGroup:h}=e,[p,f]=(0,r.useState)([]),[v,b]=(0,r.useState)(""),[_,y]=(0,r.useState)(!0);(0,r.useEffect)(()=>{j();let e=i.supabase.channel("groups-changes").on("postgres_changes",{event:"*",schema:"public",table:"message_groups"},()=>{j()}).on("postgres_changes",{event:"*",schema:"public",table:"group_participants"},()=>{j()}).on("postgres_changes",{event:"*",schema:"public",table:"messages"},()=>{j()}).subscribe();return()=>{i.supabase.removeChannel(e)}},[x]);let j=async()=>{try{y(!0);let e=[];if(g){let{data:a,error:t}=await i.supabase.from("message_groups").select("id, name, type, description, last_message_at, last_message_preview").order("last_message_at",{ascending:!1,nullsFirst:!1});if(t)throw t;e=(a||[]).map(e=>({...e,unread_count:0}))}else{let{data:a,error:t}=await i.supabase.from("group_participants").select("\n            unread_count,\n            message_groups!inner (\n              id,\n              name,\n              type,\n              description,\n              last_message_at,\n              last_message_preview\n            )\n          ").eq("user_id",x).eq("is_active",!0);if(t)throw t;e=(a||[]).map(e=>({...e.message_groups,unread_count:e.unread_count}))}e.sort((e,a)=>{let t=e.last_message_at?new Date(e.last_message_at).getTime():0;return(a.last_message_at?new Date(a.last_message_at).getTime():0)-t}),f(e)}catch(e){console.error("Erro ao carregar grupos:",e)}finally{y(!1)}},w=p.filter(e=>{var a,t,s;if(!v)return!0;let r=v.toLowerCase();return(null===(a=e.name)||void 0===a?void 0:a.toLowerCase().includes(r))||(null===(t=e.description)||void 0===t?void 0:t.toLowerCase().includes(r))||(null===(s=e.last_message_preview)||void 0===s?void 0:s.toLowerCase().includes(r))}),N=e=>{if(!e)return"";let a=new Date(e),t=new Date().getTime()-a.getTime(),s=Math.floor(t/6e4),r=Math.floor(t/36e5),i=Math.floor(t/864e5);return s<1?"Agora":s<60?"".concat(s,"m"):r<24?"".concat(r,"h"):i<7?"".concat(i,"d"):a.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"})},k=e=>{switch(e){case"general":default:return(0,s.jsx)(c.Z,{className:"w-5 h-5"});case"project":return(0,s.jsx)(d.Z,{className:"w-5 h-5"})}};return _?(0,s.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):(0,s.jsxs)("div",{className:"h-full flex flex-col bg-white dark:bg-gray-900 border-r",children:[(0,s.jsxs)("div",{className:"p-4 border-b",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white flex-1",children:"Grupos"}),h&&(0,s.jsx)(o.z,{size:"sm",onClick:h,className:"bg-primary hover:bg-[#1260b5]",title:"Criar novo grupo",children:(0,s.jsx)(m.Z,{className:"w-4 h-4"})})]}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(u.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),(0,s.jsx)(n.II,{type:"text",placeholder:"Buscar grupos...",value:v,onChange:e=>b(e.target.value),className:"pl-10"})]})]}),(0,s.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===w.length?(0,s.jsxs)("div",{className:"p-8 text-center",children:[(0,s.jsx)(d.Z,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),(0,s.jsx)("p",{className:"text-sm text-gray-500",children:v?"Nenhum grupo encontrado":"Nenhum grupo ainda"})]}):w.map(e=>(0,s.jsx)("button",{onClick:()=>a(e),className:"w-full p-4 border-b hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors text-left ".concat(t===e.id?"bg-blue-50 dark:bg-blue-900/20 border-l-4 border-l-primary":""),children:(0,s.jsxs)("div",{className:"flex gap-3",children:[(0,s.jsxs)("div",{className:"relative flex-shrink-0",children:[(0,s.jsx)("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-[#1672d6] to-[#001533] flex items-center justify-center text-white font-medium",children:k(e.type)}),e.unread_count&&e.unread_count>0&&(0,s.jsx)(l.C,{className:"absolute -top-1 -right-1 h-5 min-w-5 flex items-center justify-center p-0 bg-red-600 text-white text-xs",children:e.unread_count>9?"9+":e.unread_count})]}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex items-start justify-between mb-1",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[(0,s.jsx)("span",{className:"font-medium text-gray-900 dark:text-white truncate ".concat(e.unread_count&&e.unread_count>0?"font-bold":""),children:e.name}),"general"===e.type&&(0,s.jsx)(l.C,{variant:"outline",className:"text-xs flex-shrink-0",children:"Geral"})]}),(0,s.jsx)("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:N(e.last_message_at)})]}),e.description&&(0,s.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400 truncate mb-1",children:e.description}),e.last_message_preview&&(0,s.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 truncate ".concat(e.unread_count&&e.unread_count>0?"font-semibold text-gray-900 dark:text-white":""),children:e.last_message_preview})]})]})},e.id))})]})}},20852:function(e,a,t){t.d(a,{g:function(){return x}});var s=t(57437),r=t(2265),i=t(5526),l=t(12381),n=t(31810),o=t(88997),c=t(90132),d=t(33117),m=t(65568);let u={like:{icon:n.Z,label:"Curtir",emoji:"\uD83D\uDC4D"},love:{icon:o.Z,label:"Amar",emoji:"❤️"},laugh:{icon:c.Z,label:"Rir",emoji:"\uD83D\uDE02"},wow:{icon:o.Z,label:"Uau",emoji:"\uD83D\uDE2E"},sad:{icon:d.Z,label:"Triste",emoji:"\uD83D\uDE22"},angry:{icon:m.Z,label:"Bravo",emoji:"\uD83D\uDE20"}};function x(e){let{messageId:a,messageType:t,currentUserId:n,compact:o=!1}=e,[c,d]=(0,r.useState)([]),[m,x]=(0,r.useState)(!1),[g,h]=(0,r.useState)(null),[p,f]=(0,r.useState)(!1);(0,r.useEffect)(()=>{v();let e=i.supabase.channel("reactions-".concat(a)).on("postgres_changes",{event:"*",schema:"public",table:"message_reactions",filter:"message_id=eq.".concat(a)},()=>{v()}).subscribe();return()=>{i.supabase.removeChannel(e)}},[a]);let v=async()=>{try{let{data:e,error:s}=await i.supabase.rpc("get_message_reactions",{p_message_id:a,p_message_type:t});if(s)throw s;d(e||[]);let r=(e||[]).find(e=>e.users.some(e=>e.user_id===n));h((null==r?void 0:r.reaction_type)||null)}catch(e){console.error("Erro ao carregar rea\xe7\xf5es:",e)}},b=async e=>{if(!p){f(!0);try{let{error:s}=await i.supabase.rpc("toggle_message_reaction",{p_message_id:a,p_message_type:t,p_user_id:n,p_reaction_type:e});if(s)throw s;x(!1),await v()}catch(e){console.error("Erro ao reagir:",e)}finally{f(!1)}}},_=c.reduce((e,a)=>e+a.count,0);return o?(0,s.jsxs)("div",{className:"flex items-center gap-1 flex-wrap",children:[c.slice(0,3).map(e=>{let a=u[e.reaction_type];return(0,s.jsxs)("button",{onClick:()=>b(e.reaction_type),className:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-xs transition-colors",title:e.users.map(e=>e.full_name).join(", "),children:[(0,s.jsx)("span",{children:a.emoji}),(0,s.jsx)("span",{className:"font-medium text-gray-700 dark:text-gray-300",children:e.count})]},e.reaction_type)}),_>0&&c.length>3&&(0,s.jsxs)("span",{className:"text-xs text-gray-500",children:["+",c.length-3]})]}):(0,s.jsx)("div",{className:"relative",children:(0,s.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[c.length>0&&(0,s.jsx)("div",{className:"flex items-center gap-1 flex-wrap",children:c.map(e=>{let a=u[e.reaction_type],t=e.users.some(e=>e.user_id===n);return(0,s.jsxs)("button",{onClick:()=>b(e.reaction_type),disabled:p,className:"inline-flex items-center gap-1 px-2 py-1 rounded-full text-sm transition-all ".concat(t?"bg-amber-100 dark:bg-amber-900/30 border-2 border-primary":"bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700"),title:e.users.map(e=>e.full_name).join(", "),children:[(0,s.jsx)("span",{className:"text-base",children:a.emoji}),(0,s.jsx)("span",{className:"font-medium ".concat(t?"text-amber-700 dark:text-amber-300":"text-gray-700 dark:text-gray-300"),children:e.count})]},e.reaction_type)})}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(l.z,{variant:"ghost",size:"sm",onClick:()=>x(!m),disabled:p,className:"h-7 px-2",title:"Adicionar rea\xe7\xe3o",children:(0,s.jsx)("span",{className:"text-lg",children:"➕"})}),m&&(0,s.jsx)("div",{className:"absolute bottom-full mb-2 left-0 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 p-2 z-50",children:(0,s.jsx)("div",{className:"flex items-center gap-1",children:Object.entries(u).map(e=>{let[a,t]=e;return(0,s.jsx)("button",{onClick:()=>b(a),disabled:p,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors",title:t.label,children:(0,s.jsx)("span",{className:"text-2xl",children:t.emoji})},a)})})})]})]})})}},35444:function(e,a,t){t.d(a,{w:function(){return h}});var s=t(57437),r=t(2265),i=t(5526),l=t(12381),n=t(40279),o=t(73247),c=t(32489),d=t(3577),m=t(31047),u=t(92369),x=t(92735),g=t(74291);function h(e){let{conversationId:a,conversationType:t,onResultClick:h,participants:p=[]}=e,[f,v]=(0,r.useState)(!1),[b,_]=(0,r.useState)(""),[y,j]=(0,r.useState)([]),[w,N]=(0,r.useState)(!1),[k,S]=(0,r.useState)(!1),[C,I]=(0,r.useState)(""),[z,E]=(0,r.useState)(""),[D,Z]=(0,r.useState)(""),q=async()=>{if(b.trim()){N(!0);try{var e;let s={p_search_query:b};"group"===t?s.p_group_id=a:s.p_conversation_id=a,C&&(s.p_date_from=new Date(C).toISOString()),z&&(s.p_date_to=new Date(z).toISOString()),D&&(s.p_sender_id=D);let{data:r,error:l}=await i.supabase.rpc("group"===t?"search_group_messages":"search_direct_messages",s);if(l)throw l;j(r||[]),await i.supabase.from("message_search_history").insert({user_id:null===(e=(await i.supabase.auth.getUser()).data.user)||void 0===e?void 0:e.id,search_query:b,search_filters:{dateFrom:C,dateTo:z,selectedSender:D},results_count:(null==r?void 0:r.length)||0})}catch(e){console.error("Erro ao buscar:",e)}finally{N(!1)}}},M=async()=>{if(0===y.length)return;let e=new Blob([[["Data","Remetente","Mensagem"],...y.map(e=>[new Date(e.created_at).toLocaleString("pt-BR"),e.sender_name,e.body.replace(/"/g,'""')])].map(e=>e.map(e=>'"'.concat(e,'"')).join(",")).join("\n")],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");a.href=URL.createObjectURL(e),a.download="mensagens_".concat(new Date().toISOString().split("T")[0],".csv"),a.click()},T=(e,a)=>a?e.split(RegExp("(".concat(a,")"),"gi")).map((e,t)=>e.toLowerCase()===a.toLowerCase()?(0,s.jsx)("mark",{className:"bg-yellow-200 dark:bg-yellow-800",children:e},t):e):e;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(l.z,{variant:"ghost",size:"sm",onClick:()=>v(!0),title:"Buscar mensagens",children:(0,s.jsx)(o.Z,{className:"w-5 h-5"})}),(0,s.jsx)(g.Vq,{open:f,onOpenChange:v,children:(0,s.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-900 rounded-lg w-full max-w-2xl max-h-[80vh] flex flex-col",children:[(0,s.jsxs)("div",{className:"p-4 border-b flex items-center justify-between",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Buscar Mensagens"}),(0,s.jsx)(l.z,{variant:"ghost",size:"sm",onClick:()=>v(!1),children:(0,s.jsx)(c.Z,{className:"w-5 h-5"})})]}),(0,s.jsxs)("div",{className:"p-4 border-b space-y-3",children:[(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(n.II,{value:b,onChange:e=>_(e.target.value),onKeyDown:e=>"Enter"===e.key&&q(),placeholder:"Digite sua busca...",className:"flex-1"}),(0,s.jsx)(l.z,{onClick:q,disabled:w||!b.trim(),children:(0,s.jsx)(o.Z,{className:"w-5 h-5"})}),(0,s.jsx)(l.z,{variant:"outline",onClick:()=>S(!k),title:"Filtros",children:(0,s.jsx)(d.Z,{className:"w-5 h-5"})})]}),k&&(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1",children:[(0,s.jsx)(m.Z,{className:"w-3 h-3 inline mr-1"}),"Data Inicial"]}),(0,s.jsx)(n.II,{type:"date",value:C,onChange:e=>I(e.target.value),className:"text-sm"})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1",children:[(0,s.jsx)(m.Z,{className:"w-3 h-3 inline mr-1"}),"Data Final"]}),(0,s.jsx)(n.II,{type:"date",value:z,onChange:e=>E(e.target.value),className:"text-sm"})]}),p.length>0&&(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1",children:[(0,s.jsx)(u.Z,{className:"w-3 h-3 inline mr-1"}),"Remetente"]}),(0,s.jsxs)("select",{value:D,onChange:e=>Z(e.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900",children:[(0,s.jsx)("option",{value:"",children:"Todos"}),p.map(e=>(0,s.jsx)("option",{value:e.id,children:e.full_name},e.id))]})]})]})]}),(0,s.jsx)("div",{className:"flex-1 overflow-y-auto p-4",children:w?(0,s.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):0===y.length?(0,s.jsxs)("div",{className:"text-center py-8",children:[(0,s.jsx)(o.Z,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),(0,s.jsx)("p",{className:"text-sm text-gray-500",children:b?"Nenhum resultado encontrado":"Digite algo para buscar"})]}):(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,s.jsxs)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:[y.length," resultado(s) encontrado(s)"]}),(0,s.jsxs)(l.z,{variant:"outline",size:"sm",onClick:M,title:"Exportar resultados",children:[(0,s.jsx)(x.Z,{className:"w-4 h-4 mr-1"}),"Exportar"]})]}),y.map(e=>(0,s.jsxs)("button",{onClick:()=>{h(e.id),v(!1)},className:"w-full text-left p-3 rounded-lg bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,s.jsx)("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:e.sender_name}),(0,s.jsx)("span",{className:"text-xs text-gray-500",children:new Date(e.created_at).toLocaleDateString("pt-BR")})]}),(0,s.jsx)("p",{className:"text-sm text-gray-700 dark:text-gray-300 line-clamp-2",children:T(e.body,b)})]},e.id))]})})]})})})]})}},13486:function(e,a,t){t.d(a,{y:function(){return g}});var s=t(57437),r=t(2265),i=t(5526),l=t(79820),n=t(12381),o=t(40279),c=t(69174),d=t(82718),m=t(32489),u=t(73247),x=t(59304);function g(e){let{isOpen:a,onClose:t,onConversationCreated:g,currentUserId:h,filterType:p="all"}=e,[f,v]=(0,r.useState)([]),[b,_]=(0,r.useState)(""),[y,j]=(0,r.useState)(!1),[w,N]=(0,r.useState)("");(0,r.useEffect)(()=>{a&&(k(),S())},[a]);let k=async()=>{try{let e=await (0,x.T)(i.supabase,h);N(String((null==e?void 0:e.user_type)||""))}catch(e){N("")}},S=async()=>{try{let e=null,a=await i.supabase.from("user_profiles").select("id, user_id, full_name, email, user_type, avatar_url, avatar").order("full_name");if(a.error){let a=await i.supabase.from("user_profiles").select("id, full_name, email, user_type, avatar_url, avatar").order("full_name");if(a.error)throw a.error;e=a.data||[]}else e=a.data||[];"clients"===p?e=(e||[]).filter(e=>"client"===String((null==e?void 0:e.user_type)||"")):"team"===p&&(e=(e||[]).filter(e=>"client"!==String((null==e?void 0:e.user_type)||"")));let t=(e||[]).map(e=>{let a=(null==e?void 0:e.user_id)?String(e.user_id):(null==e?void 0:e.id)?String(e.id):null;return a?{id:a,full_name:String((null==e?void 0:e.full_name)||"Usu\xe1rio"),email:String((null==e?void 0:e.email)||""),user_type:String((null==e?void 0:e.user_type)||""),avatar_url:(null==e?void 0:e.avatar_url)?String(e.avatar_url):(null==e?void 0:e.avatar)?String(e.avatar):void 0}:null}).filter(Boolean);v(t.filter(e=>e.id!==h))}catch(e){console.error("Erro ao carregar usu\xe1rios:",e)}},C=f.filter(e=>{if(!b)return!0;let a=b.toLowerCase();return e.full_name.toLowerCase().includes(a)||e.email.toLowerCase().includes(a)}),I=async e=>{j(!0);try{let a="client"===w||"client"===e.user_type,{data:t,error:s}=await i.supabase.rpc("get_or_create_direct_conversation",{p_user_id_1:h,p_user_id_2:e.id,p_is_client_conversation:a});if(s)throw s;g(t),z()}catch(e){console.error("Erro ao criar conversa:",e),alert("Erro ao criar conversa")}finally{j(!1)}},z=()=>{_(""),t()},E=e=>e.split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2),D=e=>({super_admin:"Super Admin",admin:"Admin",client:"Cliente",video_maker:"Videomaker",web_designer:"Web Designer",graphic_designer:"Designer Gr\xe1fico",social_media:"Social Media",traffic_manager:"Tr\xe1fego",marketing_head:"Head Marketing",financial:"Financeiro",hr:"RH",commercial:"Comercial"})[e]||e;return a?(0,s.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:(0,s.jsxs)(l.Zb,{className:"w-full max-w-2xl max-h-[90vh] flex flex-col",children:[(0,s.jsx)(l.Ol,{className:"flex-shrink-0 border-b",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)(l.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(d.Z,{className:"w-5 h-5"}),"clients"===p?"Nova Conversa com Cliente":"team"===p?"Nova Conversa com Equipe":"Nova Conversa"]}),(0,s.jsx)(n.z,{variant:"ghost",size:"sm",onClick:z,children:(0,s.jsx)(m.Z,{className:"w-5 h-5"})})]})}),(0,s.jsxs)(l.aY,{className:"flex-1 overflow-hidden p-0",children:[(0,s.jsx)("div",{className:"p-4 border-b",children:(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(u.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),(0,s.jsx)(o.II,{type:"text",placeholder:"Buscar por nome ou email...",value:b,onChange:e=>_(e.target.value),className:"pl-10"})]})}),(0,s.jsx)("div",{className:"overflow-y-auto",style:{maxHeight:"calc(90vh - 200px)"},children:0===C.length?(0,s.jsx)("div",{className:"p-8 text-center",children:(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"Nenhum usu\xe1rio encontrado"})}):C.map(e=>(0,s.jsx)("button",{onClick:()=>I(e),disabled:y,className:"w-full p-4 border-b hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors",children:(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[e.avatar_url?(0,s.jsx)("img",{src:e.avatar_url,alt:"",className:"w-12 h-12 rounded-full object-cover"}):(0,s.jsx)("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-[#1672d6] to-[#001533] flex items-center justify-center text-white font-medium",children:E(e.full_name)}),(0,s.jsxs)("div",{className:"flex-1 text-left",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:e.full_name}),"client"===e.user_type&&(0,s.jsx)(c.C,{className:"bg-blue-100 text-blue-700 border-blue-200",children:"Cliente"})]}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:e.email}),(0,s.jsx)("p",{className:"text-xs text-gray-400",children:D(e.user_type)})]}),(0,s.jsx)(d.Z,{className:"w-5 h-5 text-gray-400"})]})},e.id))})]})]})}):null}},68934:function(e,a,t){t.d(a,{s:function(){return d}});var s=t(57437),r=t(2265),i=t(5526),l=t(12381),n=t(40279),o=t(46506),c=t(74291);function d(e){let{messageId:a,messageType:t,conversationId:d,currentUserId:m,compact:u=!1}=e,[x,g]=(0,r.useState)(!1),[h,p]=(0,r.useState)(""),[f,v]=(0,r.useState)(!1),b=async()=>{v(!0);try{let{error:e}=await i.supabase.from("pinned_messages").insert({message_id:a,message_type:t,conversation_id:d,pinned_by:m,note:h.trim()||null});if(e){if("23505"===e.code)alert("Esta mensagem j\xe1 est\xe1 fixada!");else throw e}else g(!1),p("")}catch(e){console.error("Erro ao fixar mensagem:",e),alert("Erro ao fixar mensagem")}finally{v(!1)}};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(l.z,{variant:"ghost",size:u?"sm":"default",onClick:()=>g(!0),className:u?"h-6 w-6 p-0":"",title:"Fixar mensagem",children:(0,s.jsx)(o.Z,{className:u?"w-3 h-3":"w-4 h-4"})}),(0,s.jsx)(c.Vq,{open:x,onOpenChange:g,children:(0,s.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-900 rounded-lg w-full max-w-md p-6",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Fixar Mensagem"}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Nota (opcional)"}),(0,s.jsx)(n.II,{value:h,onChange:e=>p(e.target.value),placeholder:"Adicione uma nota explicativa...",maxLength:200}),(0,s.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:[h.length,"/200 caracteres"]})]}),(0,s.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,s.jsx)(l.z,{variant:"outline",onClick:()=>g(!1),children:"Cancelar"}),(0,s.jsx)(l.z,{onClick:b,disabled:f,children:f?"Fixando...":"Fixar"})]})]})]})})})]})}},66491:function(e,a,t){t.d(a,{q:function(){return d}});var s=t(57437),r=t(2265),i=t(5526),l=t(12381),n=t(46506),o=t(32489),c=t(59304);function d(e){let{conversationId:a,conversationType:t,currentUserId:d,onMessageClick:m}=e,[u,x]=(0,r.useState)([]),[g,h]=(0,r.useState)(!0),[p,f]=(0,r.useState)(!1);(0,r.useEffect)(()=>{b(),v();let e=i.supabase.channel("pinned-".concat(a)).on("postgres_changes",{event:"*",schema:"public",table:"pinned_messages",filter:"conversation_id=eq.".concat(a)},()=>{b()}).subscribe();return()=>{i.supabase.removeChannel(e)}},[a]);let v=async()=>{if("group"===t){let{data:e}=await i.supabase.from("group_participants").select("role").eq("group_id",a).eq("user_id",d).maybeSingle();f((null==e?void 0:e.role)==="admin")}else f(!0)},b=async()=>{try{let{data:e,error:s}=await i.supabase.from("pinned_messages").select("*").eq("conversation_id",a).eq("message_type",t).order("pinned_at",{ascending:!1});if(s)throw s;if(!e||0===e.length){x([]);return}let r=await Promise.all(e.map(async e=>{var a;let{data:s}=await i.supabase.from("group"===t?"messages":"direct_messages").select("\n              body,\n              created_at,\n              from_user_id\n            ").eq("id",e.message_id).maybeSingle(),r=(null==s?void 0:s.from_user_id)?String(s.from_user_id):"",l=await (0,c.m)(i.supabase,r?[r]:[]),n=r?null===(a=l.get(r))||void 0===a?void 0:a.full_name:void 0;return{...e,message_body:null==s?void 0:s.body,sender_name:n||"Usu\xe1rio",message_created_at:null==s?void 0:s.created_at}}));x(r)}catch(e){console.error("Erro ao carregar mensagens fixadas:",e)}},_=async e=>{try{let{error:a}=await i.supabase.from("pinned_messages").delete().eq("id",e);if(a)throw a}catch(e){console.error("Erro ao desfixar mensagem:",e)}};return 0===u.length?null:(0,s.jsx)("div",{className:"border-b bg-blue-50 dark:bg-blue-900/20",children:(0,s.jsxs)("div",{className:"p-3",children:[(0,s.jsxs)("button",{onClick:()=>h(!g),className:"w-full flex items-center justify-between text-sm font-medium text-amber-800 dark:text-amber-200 hover:text-amber-900 dark:hover:text-amber-100",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(n.Z,{className:"w-4 h-4"}),(0,s.jsxs)("span",{children:[u.length," mensagem",1!==u.length?"s":""," fixada",1!==u.length?"s":""]})]}),(0,s.jsx)("span",{className:"text-xs",children:g?"▼":"▶"})]}),g&&(0,s.jsx)("div",{className:"mt-3 space-y-2",children:u.map(e=>(0,s.jsx)("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 shadow-sm",children:(0,s.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,s.jsxs)("button",{onClick:()=>m(e.message_id),className:"flex-1 text-left",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("span",{className:"text-xs font-medium text-gray-900 dark:text-white",children:e.sender_name}),(0,s.jsx)("span",{className:"text-xs text-gray-500",children:e.message_created_at&&new Date(e.message_created_at).toLocaleDateString("pt-BR")})]}),(0,s.jsx)("p",{className:"text-sm text-gray-700 dark:text-gray-300 line-clamp-2",children:e.message_body}),e.note&&(0,s.jsxs)("p",{className:"text-xs text-blue-600 dark:text-amber-400 mt-1 italic",children:["Nota: ",e.note]})]}),p&&(0,s.jsx)(l.z,{variant:"ghost",size:"sm",onClick:()=>_(e.id),className:"h-6 w-6 p-0",title:"Desfixar mensagem",children:(0,s.jsx)(o.Z,{className:"w-4 h-4"})})]})},e.id))})]})})}},67438:function(e,a,t){t.d(a,{n:function(){return l}});var s=t(57437),r=t(2265),i=t(5526);function l(e){let{userId:a,showLabel:t=!1,size:l="sm"}=e,[n,o]=(0,r.useState)("offline"),[c,d]=(0,r.useState)("");(0,r.useEffect)(()=>{m();let e=i.supabase.channel("presence-".concat(a)).on("postgres_changes",{event:"*",schema:"public",table:"user_presence",filter:"user_id=eq.".concat(a)},()=>{m()}).subscribe();return()=>{i.supabase.removeChannel(e)}},[a]);let m=async()=>{try{let{data:e,error:t}=await i.supabase.from("user_presence").select("status, last_seen_at").eq("user_id",a).maybeSingle();if(t)throw t;e&&(o(e.status),d(e.last_seen_at))}catch(e){console.error("Erro ao carregar presen\xe7a:",e)}},u=()=>{switch(n){case"online":return"bg-green-500";case"away":return"bg-yellow-500";default:return"bg-gray-400"}},x=()=>{switch(n){case"online":return"Online";case"away":return"Ausente";default:return g()}},g=()=>{if(!c)return"Offline";let e=new Date(c),a=new Date().getTime()-e.getTime(),t=Math.floor(a/6e4),s=Math.floor(a/36e5),r=Math.floor(a/864e5);return t<1?"Agora mesmo":t<60?"Visto h\xe1 ".concat(t,"m"):s<24?"Visto h\xe1 ".concat(s,"h"):r<7?"Visto h\xe1 ".concat(r,"d"):"Offline"},h={sm:"w-2 h-2",md:"w-3 h-3",lg:"w-4 h-4"};return t?(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("div",{className:"".concat(h[l]," ").concat(u()," rounded-full")}),(0,s.jsx)("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:x()})]}):(0,s.jsx)("div",{className:"".concat(h[l]," ").concat(u()," rounded-full border-2 border-white dark:border-gray-800"),title:x()})}},74291:function(e,a,t){t.d(a,{$N:function(){return c},Be:function(){return d},Vq:function(){return l},a7:function(){return m},cN:function(){return u},cZ:function(){return n},fK:function(){return o}});var s=t(57437),r=t(32489),i=t(2265);function l(e){let{open:a,onOpenChange:t,children:r}=e;return((0,i.useEffect)(()=>(a?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[a]),a)?(0,s.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,s.jsx)("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm",onClick:()=>t(!1)}),(0,s.jsx)("div",{className:"relative z-50 w-full max-w-4xl max-h-[90vh] overflow-y-auto mx-4",children:r})]}):null}function n(e){let{children:a,onClose:t,className:i}=e;return(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow-xl border border-gray-200 dark:border-gray-800 ".concat(i||""),children:[t&&(0,s.jsx)("button",{onClick:t,className:"absolute top-4 right-4 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors",children:(0,s.jsx)(r.Z,{className:"w-5 h-5"})}),a]})}function o(e){let{children:a}=e;return(0,s.jsx)("div",{className:"px-6 py-4 border-b border-gray-200 dark:border-gray-800",children:a})}function c(e){let{children:a}=e;return(0,s.jsx)("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:a})}function d(e){let{children:a}=e;return(0,s.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-2",children:a})}function m(e){let{children:a}=e;return(0,s.jsx)("div",{className:"px-6 py-4",children:a})}function u(e){let{children:a,className:t}=e;return(0,s.jsx)("div",{className:"px-6 py-4 border-t border-gray-200 dark:border-gray-800 flex items-center justify-end gap-3 ".concat(t||""),children:a})}},2390:function(e,a,t){t.d(a,{r:function(){return r}});var s=t(2265);function r(){let e=(0,s.useRef)(null),a=(0,s.useRef)(null);return(0,s.useEffect)(()=>{e.current=new Audio("/notification.mp3"),e.current.volume=.5,a.current=new Audio("/notification.mp3"),a.current.volume=.8},[]),{playNotificationSound:function(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],s=t?a.current:e.current;s&&(s.currentTime=0,t&&(s.playbackRate=1.1),s.play().catch(e=>{console.log("N\xe3o foi poss\xedvel reproduzir o som:",e)}))}}}},76862:function(e,a,t){t.d(a,{o:function(){return i}});var s=t(2265),r=t(5526);function i(){let{userId:e,groupId:a}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(0,s.useRef)(void 0),i=(0,s.useRef)(!1),l=(0,s.useRef)(void 0);(0,s.useEffect)(()=>{if(!e)return;n(),t.current=setInterval(()=>{o("online")},3e4);let a=()=>{document.hidden?o("away"):n()},s=()=>{o("offline")};return document.addEventListener("visibilitychange",a),window.addEventListener("beforeunload",s),window.addEventListener("blur",()=>o("away")),window.addEventListener("focus",()=>n()),()=>{t.current&&clearInterval(t.current),document.removeEventListener("visibilitychange",a),window.removeEventListener("beforeunload",s),window.removeEventListener("blur",()=>o("away")),window.removeEventListener("focus",()=>n()),o("offline")}},[e]);let n=async()=>{e&&await o("online")},o=async t=>{if(e)try{await r.supabase.rpc("update_user_presence",{p_user_id:e,p_status:t,p_group_id:a||null})}catch(e){console.error("Erro ao atualizar presen\xe7a:",e)}},c=async()=>{if(e&&a&&i.current){i.current=!1,l.current&&clearTimeout(l.current);try{await r.supabase.from("typing_indicators").delete().eq("group_id",a).eq("user_id",e)}catch(e){console.error("Erro ao remover indicador:",e)}}};return{startTyping:async()=>{if(e&&a){if(l.current&&clearTimeout(l.current),!i.current){i.current=!0;try{await r.supabase.rpc("upsert_typing_indicator",{p_group_id:a,p_user_id:e})}catch(e){console.error("Erro ao registrar digita\xe7\xe3o:",e)}}l.current=setTimeout(()=>{c()},3e3)}},stopTyping:c,updatePresence:o}}},93825:function(e,a,t){t.d(a,{tC:function(){return s}});function s(e){e.content&&!(e.content.trim().length<10)&&fetch("/api/ai/analyze-message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(e=>{console.debug("[SilentAnalysis] Erro (ignorado):",e)})}}}]);