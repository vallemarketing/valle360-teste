"use strict";(()=>{var e={};e.id=96549,e.ids=[96549],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},52800:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>f,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>_,staticGenerationAsyncStorage:()=>g});var i={};a.r(i),a.d(i,{GET:()=>d,dynamic:()=>u});var n=a(49303),r=a(88716),s=a(60670),o=a(87070),c=a(17478),l=a(90176);let u="force-dynamic";async function d(e){let t=await (0,c.k)(e);if(!t.ok)return t.res;let a=(0,l.t)(),i=new Date;try{let{data:e,error:t}=await a.from("clients").select("id, company_name, contact_email, contact_phone, status, user_id").eq("is_active",!0).order("company_name",{ascending:!0}).limit(500);if(t)throw t;let n=(e||[]).map(e=>String(e.id)),{data:r}=await a.from("contracts").select("client_id, value, status").in("client_id",n).eq("status","active"),s=new Map;for(let e of r||[]){let t=String(e.client_id),a=Number(e.value||0);s.set(t,(s.get(t)||0)+a)}let{data:c}=await a.from("invoices").select("id, client_id, invoice_number, amount, due_date, paid_at, status").in("client_id",n).order("due_date",{ascending:!0}),l=new Map;for(let e of c||[]){let t=String(e.client_id);l.set(t,[...l.get(t)||[],e])}let u=(e||[]).map(e=>{let t;let a=String(e.id),n=(l.get(a)||[]).filter(e=>!e.paid_at&&"paid"!==String(e.status||"").toLowerCase()),r=n.filter(e=>{let t=new Date(String(e.due_date));return!Number.isNaN(t.getTime())&&t.getTime()<i.getTime()}),o="ok";r.length>0?o="late":n.length>0&&(o="pending");let c=n.length>0?n[0]:null,u=c?.due_date?String(c.due_date):null;if(r.length>0){let e=r.reduce((e,t)=>{let a=new Date(String(e.due_date)).getTime(),i=new Date(String(t.due_date)).getTime();return a<=i?e:t},r[0]),a=new Date(String(e.due_date));t=Number.isNaN(a.getTime())?void 0:Math.max(0,Math.floor((i.getTime()-a.getTime())/864e5))}let d=s.get(a)||0,p="late"===o?45:"pending"===o?75:92;return{id:a,name:e.company_name,email:e.contact_email,phone:e.contact_phone,contract_value:d,status:"active"===String(e.status||"active").toLowerCase()?"active":"inactive",payment_status:o,next_billing:u||new Date().toISOString().slice(0,10),health_score:p,days_late:t,user_id:e.user_id?String(e.user_id):null}});return o.NextResponse.json({success:!0,clients:u})}catch(e){return o.NextResponse.json({success:!1,error:e?.message||"Erro ao carregar clientes financeiros"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/admin/finance/clients/route",pathname:"/api/admin/finance/clients",filename:"route",bundlePath:"app/api/admin/finance/clients/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\finance\\clients\\route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:_}=p,h="/api/admin/finance/clients/route";function f(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:g})}},90176:(e,t,a)=>{a.d(t,{t:()=>n});var i=a(54128);function n(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,i.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},17478:(e,t,a)=>{a.d(t,{k:()=>o});var i=a(87070),n=a(20344),r=a(71615),s=a(54128);async function o(e){let t=(0,r.cookies)(),a=(0,n.createRouteHandlerClient)({cookies:()=>t}),o=e.headers.get("authorization")||"",c=o.toLowerCase().startsWith("bearer ")?o.slice(7).trim():null,l=c?(0,s.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${c}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):a,{data:u}=await l.auth.getUser();if(!u.user?.id)return{ok:!1,res:i.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:d,error:p}=await l.rpc("is_admin");return p||!d?{ok:!1,res:i.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:u.user.id}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),i=t.X(0,[89276,55972,54128,20958],()=>a(52800));module.exports=i})();