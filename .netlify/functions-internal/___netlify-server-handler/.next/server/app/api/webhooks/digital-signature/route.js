"use strict";(()=>{var e={};e.id=50251,e.ids=[50251],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78392:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>S,patchFetch:()=>h,requestAsyncStorage:()=>y,routeModule:()=>v,serverHooks:()=>f,staticGenerationAsyncStorage:()=>w});var a={};n.r(a),n.d(a,{POST:()=>d});var i=n(49303),o=n(88716),r=n(60670),s=n(87070);let c=(0,n(54128).eI)("https://ikjgsqtykkhqimypacro.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function d(e){try{let t=await e.json(),n=e.headers.get("x-signature-provider")||(t.event&&t.apiVersion?"docusign":t.document&&t.document.key?"clicksign":t.document_token?"autentique":t.internal_event?"internal":"unknown");console.log(`[WEBHOOK] Digital signature event from ${n}:`,t);let a=null;switch(n){case"docusign":a=function(e){let t=e.envelopeSummary?.status;return{eventType:"completed"===t?"completed":t,contractId:e.envelopeSummary?.customFields?.textCustomFields?.find(e=>"contractId"===e.name)?.value,signedBy:e.envelopeSummary?.recipients?.signers?.[0]?.email,signedAt:e.envelopeSummary?.completedDateTime,documentUrl:e.envelopeSummary?.documentsCombinedUri}}(t);break;case"clicksign":a=function(e){let t=e.event?.name;return{eventType:"close"===t?"completed":t,contractId:e.document?.external_id,signedBy:e.signer?.email,signedAt:e.event?.occurred_at,documentUrl:e.document?.downloads?.original_file_url}}(t);break;case"autentique":a=function(e){let t=e.status;return{eventType:"signed"===t?"completed":t,contractId:e.metadata?.contract_id,signedBy:e.signatories?.[0]?.email,signedAt:e.signed_at,documentUrl:e.file_url}}(t);break;case"internal":a={eventType:t.event_type,contractId:t.contract_id,signedBy:t.signed_by,signedAt:t.signed_at,signatureIp:t.signature_ip,documentUrl:void 0};break;default:return console.warn("Unknown signature provider:",n),s.NextResponse.json({error:"Unknown provider"},{status:400})}if(!a)return s.NextResponse.json({error:"Could not parse event"},{status:400});"completed"===a.eventType||"signed"===a.eventType?await l(a):"declined"===a.eventType||"voided"===a.eventType?await u(a):"viewed"===a.eventType&&await p(a);try{await c.from("webhook_logs").insert({provider:n,event_type:a.eventType,contract_id:a.contractId,payload:t,created_at:new Date().toISOString()})}catch{}return s.NextResponse.json({success:!0})}catch(e){return console.error("Webhook error:",e),s.NextResponse.json({error:e.message||"Webhook processing failed"},{status:500})}}async function l(e){let{contractId:t,signedBy:n,signedAt:a,signatureIp:i,documentUrl:o}=e;if(!t){console.error("No contract ID in signed event");return}let{data:r,error:s}=await c.from("contracts").update({status:"signed",signed_at:a||new Date().toISOString(),signed_by:n,signature_ip:i,signed_document_url:o,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(s){console.error("Failed to update contract:",s);return}console.log(`[CONTRACT SIGNED] ${t} by ${n}`),await m(r)}async function u(e){let{contractId:t,signedBy:n}=e;await c.from("contracts").update({status:"cancelled",cancelled_at:new Date().toISOString(),cancellation_reason:`Declined by ${n}`}).eq("id",t),await _(t,"contract_declined",`Contrato recusado por ${n}`)}async function p(e){let{contractId:t,signedBy:n}=e;try{await c.from("contract_events").insert({contract_id:t,event_type:"viewed",event_by:n,event_at:new Date().toISOString()})}catch{}}async function m(e){await c.from("contracts").update({status:"active",activated_at:new Date().toISOString()}).eq("id",e.id);let t=e.total_value/e.duration_months,n=new Date;n.setDate(parseInt(e.payment_terms?.match(/\d+/)?.[0]||"10")),n<new Date&&n.setMonth(n.getMonth()+1);let{data:a}=await c.from("invoices").insert({contract_id:e.id,client_id:e.client_id,amount:t,due_date:n.toISOString(),status:"pending",description:`Mensalidade - ${e.services?.[0]?.name||"Servi\xe7os"}`,created_at:new Date().toISOString()}).select().single();console.log(`[INVOICE CREATED] ${a?.id} for contract ${e.id}`);try{await c.from("recurring_invoice_schedules").insert({contract_id:e.id,client_id:e.client_id,amount:t,frequency:"monthly",day_of_month:parseInt(e.payment_terms?.match(/\d+/)?.[0]||"10"),next_run:new Date(n.getTime()+2592e6).toISOString(),end_date:e.end_date,is_active:!0,created_at:new Date().toISOString()})}catch{}e.services&&e.services.length>0&&await g(e);try{await c.from("workflow_transitions").insert({from_area:"juridico",to_area:"financeiro",resource_type:"contract",resource_id:e.id,client_id:e.client_id,status:"completed",transitioned_at:new Date().toISOString()})}catch{}try{await c.from("workflow_transitions").insert({from_area:"juridico",to_area:"operacoes",resource_type:"contract",resource_id:e.id,client_id:e.client_id,status:"completed",transitioned_at:new Date().toISOString()})}catch{}await _(e.id,"contract_signed",`Contrato de ${e.client_company} assinado! Iniciar produ\xe7\xe3o.`),await _(e.id,"invoice_created",`Fatura criada para ${e.client_company} - R$ ${t.toLocaleString("pt-BR")}`)}async function g(e){let{data:t}=await c.from("clients").select("id, company_name").eq("email",e.client_email).single(),n=t?.id||e.client_id;if(!n)return;let a={"Gest\xe3o de Redes Sociais":"social_media","Tr\xe1fego Pago (Meta Ads)":"trafego_pago","Tr\xe1fego Pago (Google Ads)":"trafego_pago","Design Gr\xe1fico":"design","Cria\xe7\xe3o de Conte\xfado":"social_media","Desenvolvimento Web":"desenvolvimento",SEO:"desenvolvimento",Branding:"design"};for(let t of e.services){let i=a[t.name]||"operacoes";try{await c.from("kanban_cards").insert({title:`[NOVO CLIENTE] ${t.name} - ${e.client_company}`,description:`Iniciar servi\xe7o de ${t.name} conforme contrato.

Entregas: ${t.deliverables?.join(", ")||"Conforme briefing"}

Valor mensal: R$ ${t.monthly_value?.toLocaleString("pt-BR")||"N/A"}`,client_id:n,area:i,column:"backlog",priority:"high",due_date:new Date(Date.now()+6048e5).toISOString(),metadata:{contract_id:e.id,service_name:t.name,auto_created:!0},created_at:new Date().toISOString()})}catch(e){console.error("Failed to create task:",e)}}console.log(`[TASKS CREATED] ${e.services.length} tasks for contract ${e.id}`)}async function _(e,t,n){let{data:a}=await c.from("user_profiles").select("user_id").in("user_type",["super_admin","admin","finance","operations"]);if(a&&a.length>0){let e=a.map(e=>({user_id:e.user_id,type:t,title:t.replace("_"," ").replace(/\b\w/g,e=>e.toUpperCase()),message:n,link:"/admin/contratos",is_read:!1,created_at:new Date().toISOString()}));try{await c.from("notifications").insert(e)}catch{}}}let v=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/webhooks/digital-signature/route",pathname:"/api/webhooks/digital-signature",filename:"route",bundlePath:"app/api/webhooks/digital-signature/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\webhooks\\digital-signature\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:w,serverHooks:f}=v,S="/api/webhooks/digital-signature/route";function h(){return(0,r.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:w})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[89276,55972,54128],()=>n(78392));module.exports=a})();