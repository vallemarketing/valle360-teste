"use strict";(()=>{var e={};e.id=40366,e.ids=[40366],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},94723:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>f,patchFetch:()=>x,requestAsyncStorage:()=>v,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h});var a={};t.r(a),t.d(a,{GET:()=>_});var n=t(49303),s=t(88716),o=t(60670),i=t(87070),c=t(20344),u=t(71615);let l=process.env.CANVA_CLIENT_ID||"",p=process.env.CANVA_CLIENT_SECRET||"",d=process.env.CANVA_REDIRECT_URI||`${process.env.NEXT_PUBLIC_APP_URL}/api/oauth/canva/callback`;async function _(e){try{let r;let t=(0,c.createRouteHandlerClient)({cookies:u.cookies}),a=e.nextUrl.searchParams,n=a.get("code"),s=a.get("state"),o=a.get("error");if(o)return console.error("Canva OAuth error:",o),i.NextResponse.redirect(new URL(`/error?message=${o}`,e.url));if(!n||!s)return i.NextResponse.redirect(new URL("/error?message=missing_params",e.url));try{r=JSON.parse(Buffer.from(s,"base64url").toString())}catch{return i.NextResponse.redirect(new URL("/error?message=invalid_state",e.url))}let _=await fetch("https://api.canva.com/rest/v1/oauth/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${Buffer.from(`${l}:${p}`).toString("base64")}`},body:new URLSearchParams({grant_type:"authorization_code",code:n,redirect_uri:d})}),m=await _.json();if(!m.access_token)return console.error("Failed to get Canva tokens:",m),i.NextResponse.redirect(new URL("/error?message=token_error",e.url));let v=await fetch("https://api.canva.com/rest/v1/users/me",{headers:{Authorization:`Bearer ${m.access_token}`}}),h=await v.json(),g={user_id:r.userId,client_id:r.clientId||null,platform:"canva",account_id:h.user?.id||"unknown",account_name:h.user?.display_name||h.user?.email||"Canva User",access_token_encrypted:m.access_token,refresh_token_encrypted:m.refresh_token,token_expires_at:new Date(Date.now()+1e3*m.expires_in).toISOString(),scopes:m.scope?.split(" ")||[],connected_at:new Date().toISOString(),connected_by:r.userId,is_active:!0},{error:f}=await t.from("user_integrations").upsert(g,{onConflict:"user_id,platform"});f&&(console.error("Failed to save Canva connection:",f),await t.from("integrations").upsert({user_id:r.userId,type:"canva",config:{access_token:m.access_token,refresh_token:m.refresh_token,expires_at:new Date(Date.now()+1e3*m.expires_in).toISOString(),user_id:h.user?.id,display_name:h.user?.display_name},is_active:!0,updated_at:new Date().toISOString()},{onConflict:"user_id,type"}));try{await t.from("audit_logs").insert({user_id:r.userId,action:"integration_connected",resource_type:"canva",metadata:{display_name:h.user?.display_name,client_id:r.clientId},created_at:new Date().toISOString()})}catch{}let x=new URL(r.redirect,e.url);return x.searchParams.set("success","canva_connected"),i.NextResponse.redirect(x)}catch(r){return console.error("Canva OAuth callback error:",r),i.NextResponse.redirect(new URL("/error?message=callback_error",e.url))}}let m=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/oauth/canva/callback/route",pathname:"/api/oauth/canva/callback",filename:"route",bundlePath:"app/api/oauth/canva/callback/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\oauth\\canva\\callback\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:v,staticGenerationAsyncStorage:h,serverHooks:g}=m,f="/api/oauth/canva/callback/route";function x(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[89276,55972,54128,20958],()=>t(94723));module.exports=a})();