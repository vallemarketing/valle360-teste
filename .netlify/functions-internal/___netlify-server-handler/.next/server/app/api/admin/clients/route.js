"use strict";(()=>{var e={};e.id=78708,e.ids=[78708],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32904:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>y,patchFetch:()=>I,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>w,staticGenerationAsyncStorage:()=>v});var s={};a.r(s),a.d(s,{GET:()=>m,POST:()=>f,PUT:()=>_,dynamic:()=>u});var r=a(49303),i=a(88716),n=a(60670),o=a(87070),l=a(54128);let u="force-dynamic",d=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",c=(0,l.eI)("https://ikjgsqtykkhqimypacro.supabase.co",d||"setup-missing",{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}});async function p(e){let t=e.headers.get("authorization")||e.headers.get("Authorization"),a=t?.startsWith("Bearer ")?t.slice(7):null;if(!a)return null;let{data:{user:s}}=await c.auth.getUser(a);return s||null}async function m(e){if(!await p(e))return o.NextResponse.json({error:"N\xe3o autorizado"},{status:401});try{let{data:e,error:t}=await c.from("clients").select("id,user_id,nome_fantasia,razao_social,area_atuacao,cidade,estado,whatsapp,site,cpf_cnpj,created_at").order("created_at",{ascending:!1}).limit(500);if(t)throw t;let a=(e||[]).map(e=>e.user_id).filter(Boolean),s=[];{let e=await c.from("users").select("id,email,full_name,phone,account_status,name,role,user_type").in("id",a);s=e.error?(await c.from("users").select("id,email,name,role").in("id",a)).data||[]:e.data||[]}let r=new Map(s.map(e=>[e.id,e])),{data:i}=await c.from("contracts").select("client_id,monthly_value,start_date,status,created_at").in("client_id",(e||[]).map(e=>e.id)).order("created_at",{ascending:!1}),n=new Map;for(let e of i||[])n.has(e.client_id)||n.set(e.client_id,e);let l=(e||[]).map(e=>{let t=r.get(e.user_id)||{},a=n.get(e.id),s=e.nome_fantasia||e.razao_social||t.company_name||t.name||t.email||"Cliente",i=t.full_name||t.name||t.email||"Contato",o=t.email||"",l=t.phone||e.whatsapp||"",u=e.area_atuacao||"—",d=Number(a?.monthly_value||0),c=a?.start_date||e.created_at||new Date().toISOString(),p=function(e){let t=(e||"").toLowerCase();return t.includes("pend")?"pending":t.includes("inact")||t.includes("block")||t.includes("suspend")?"inactive":"active"}(t.account_status||(!1===t.is_active?"inactive":"active"));return{id:e.id,userId:e.user_id,companyName:s,contactName:i,email:o,phone:l,industry:u,status:p,monthlyValue:d,startDate:c,avatar:`https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(s)}`,address:e.logradouro?`${e.logradouro}, ${e.numero||""}`.trim():void 0,city:e.cidade,state:e.estado,cnpj:e.cpf_cnpj,website:e.site}});return o.NextResponse.json({clients:l})}catch(a){let{data:e}=await c.from("user_profiles").select("user_id,full_name,email,phone,user_type,is_active,metadata,created_at").in("user_type",["client","cliente"]).limit(500),t=(e||[]).map(e=>{let t=e.metadata?.company_name||e.full_name||e.email||"Cliente";return{id:e.user_id,userId:e.user_id,companyName:t,contactName:e.full_name||e.email||"Contato",email:e.email||"",phone:e.phone||"",industry:e.metadata?.industry||"—",status:!1===e.is_active?"inactive":"active",monthlyValue:0,startDate:e.created_at||new Date().toISOString(),avatar:`https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(t)}`}});return o.NextResponse.json({clients:t,warning:"fallback_user_profiles"})}}async function _(e){if(!await p(e))return o.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{userId:t,status:a}=await e.json()||{};if(!t||!a)return o.NextResponse.json({error:"userId e status s\xe3o obrigat\xf3rios"},{status:400});let s=String(a);return(await c.from("users").update({account_status:s}).eq("id",t)).error?(await c.from("user_profiles").update({is_active:"active"===s}).eq("user_id",t)).error?o.NextResponse.json({error:"Falha ao atualizar status"},{status:500}):o.NextResponse.json({success:!0,fallback:"user_profiles"}):o.NextResponse.json({success:!0})}async function f(e){let t=await p(e);if(!t)return o.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{clientId:a,features:s}=await e.json()||{};if(!a||!Array.isArray(s))return o.NextResponse.json({error:"clientId e features s\xe3o obrigat\xf3rios"},{status:400});let{data:r,error:i}=await c.from("features").select("id,code").in("code",s.map(e=>e.code));if(i)return o.NextResponse.json({error:i.message},{status:500});let n=new Map((r||[]).map(e=>[e.code,e.id])),l=s.map(e=>{let s=n.get(e.code);return s?{client_id:a,feature_id:s,is_enabled:!!e.enabled,enabled_by:"manual",enabled_by_user_id:t.id,enabled_at:e.enabled?new Date().toISOString():null}:null}).filter(Boolean);if(0===l.length)return o.NextResponse.json({success:!0,updated:0});let{error:u}=await c.from("client_features").upsert(l,{onConflict:"client_id,feature_id"});return u?o.NextResponse.json({error:u.message},{status:500}):o.NextResponse.json({success:!0,updated:l.length})}let h=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/clients/route",pathname:"/api/admin/clients",filename:"route",bundlePath:"app/api/admin/clients/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\clients\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:v,serverHooks:w}=h,y="/api/admin/clients/route";function I(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:v})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[89276,55972,54128],()=>a(32904));module.exports=s})();