"use strict";(()=>{var e={};e.id=41006,e.ids=[41006],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},73902:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>b,patchFetch:()=>S,requestAsyncStorage:()=>y,routeModule:()=>_,serverHooks:()=>w,staticGenerationAsyncStorage:()=>v});var r={};a.r(r),a.d(r,{GET:()=>g,POST:()=>m,PUT:()=>f,dynamic:()=>p});var s=a(49303),i=a(88716),o=a(60670),n=a(87070),c=a(79263),l=a(32120),u=a(20344),d=a(71615);let p="force-dynamic";async function h(){let e=(0,d.cookies)(),t=(0,u.createRouteHandlerClient)({cookies:()=>e}),{data:a}=await t.auth.getUser();if(!a.user?.id)return{ok:!1,res:n.NextResponse.json({success:!1,error:"N\xe3o autorizado"},{status:401})};let{data:r,error:s}=await t.rpc("is_admin");return s||!r?{ok:!1,res:n.NextResponse.json({success:!1,error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:a.user.id}}async function g(e){try{let t=await h();if(!t.ok)return t.res;let{searchParams:a}=new URL(e.url),r=a.get("type"),s=a.get("entity_type")||void 0,i=a.get("entity_id")||void 0,o=a.get("min_confidence"),l=await c.t.getPredictions({type:r||void 0,entity_type:s,entity_id:i,min_confidence:o?parseInt(o):void 0});return n.NextResponse.json({success:!0,predictions:l})}catch(e){return console.error("Erro ao buscar previs\xf5es:",e),n.NextResponse.json({success:!1,error:"Erro ao buscar previs\xf5es"},{status:500})}}async function m(e){try{let t=await h();if(!t.ok)return t.res;let a=await e.json(),{action:r,entity_id:s,entity_type:i,period:o}=a,u=null;switch(r){case"predict_churn":if(!s)return n.NextResponse.json({success:!1,error:"entity_id \xe9 obrigat\xf3rio para previs\xe3o de churn"},{status:400});u=await c.t.predictChurn(s);break;case"predict_conversion":if(!s)return n.NextResponse.json({success:!1,error:"entity_id \xe9 obrigat\xf3rio para previs\xe3o de convers\xe3o"},{status:400});u=await c.t.predictConversion(s);break;case"predict_delay":if(!s)return n.NextResponse.json({success:!1,error:"entity_id \xe9 obrigat\xf3rio para previs\xe3o de atraso"},{status:400});u=await c.t.predictDelay(s);break;case"predict_revenue":u=await c.t.predictRevenue(o||"month");break;case"predict_upsell":if(!s)return n.NextResponse.json({success:!1,error:"entity_id \xe9 obrigat\xf3rio para previs\xe3o de upsell"},{status:400});u=await c.t.predictUpsellOpportunities(s);break;case"calculate_health_score":if(!s)return n.NextResponse.json({success:!1,error:"entity_id \xe9 obrigat\xf3rio para Health Score"},{status:400});u=await l.J.calculateHealthScore(s);break;case"get_all_health_scores":let d=a.risk_level,p=a.min_churn_probability;u=await l.J.getAllHealthScores({risk_level:d,min_churn_probability:p});break;case"recalculate_all_scores":u={recalculated:await l.J.recalculateAllScores()};break;default:return n.NextResponse.json({success:!1,error:"A\xe7\xe3o n\xe3o reconhecida"},{status:400})}if(!u)return n.NextResponse.json({success:!1,error:"N\xe3o foi poss\xedvel gerar a previs\xe3o"},{status:500});return n.NextResponse.json({success:!0,result:u})}catch(e){return console.error("Erro na API de previs\xf5es:",e),n.NextResponse.json({success:!1,error:"Erro ao processar requisi\xe7\xe3o"},{status:500})}}async function f(e){try{let t=await h();if(!t.ok)return t.res;let{prediction_id:a,was_correct:r,actual_outcome:s}=await e.json();if(!a)return n.NextResponse.json({success:!1,error:"prediction_id \xe9 obrigat\xf3rio"},{status:400});return await c.t.recordPredictionOutcome(a,r,s),n.NextResponse.json({success:!0,message:"Feedback registrado"})}catch(e){return console.error("Erro ao registrar feedback:",e),n.NextResponse.json({success:!1,error:"Erro ao registrar feedback"},{status:500})}}let _=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/predictions/route",pathname:"/api/predictions",filename:"route",bundlePath:"app/api/predictions/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\predictions\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:y,staticGenerationAsyncStorage:v,serverHooks:w}=_,b="/api/predictions/route";function S(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:v})}},32120:(e,t,a)=>{a.d(t,{J:()=>i});var r=a(90176);class s{db(){return(0,r.t)()}async calculateHealthScore(e){try{let{data:t}=await this.db().from("clients").select("*").eq("id",e).single();if(!t)return null;let a=await this.calculateEngagementScore(e),r=await this.calculatePaymentScore(e),s=await this.calculateSatisfactionScore(e),i=await this.calculateGrowthScore(e),o=Math.round(a*this.WEIGHTS.engagement+r*this.WEIGHTS.payment+s*this.WEIGHTS.satisfaction+i*this.WEIGHTS.growth),n=this.determineRiskLevel(o),c=this.calculateChurnProbability(o,{engagement:a,payment:r,satisfaction:s,growth:i}),l=await this.generateHealthFactors(e,{engagement:a,payment:r,satisfaction:s,growth:i}),u=this.generateRecommendations(l,n),d=await this.determineTrend(e,o),p={client_id:e,client_name:t.company_name||t.name,overall_score:o,engagement_score:a,payment_score:r,satisfaction_score:s,growth_score:i,risk_level:n,factors:l,recommendations:u,last_calculated:new Date().toISOString(),trend:d,churn_probability:c};return await this.saveHealthScore(p),p}catch(e){return console.error("Erro ao calcular Health Score:",e),null}}async calculateEngagementScore(e){try{let t=new Date;t.setDate(t.getDate()-30);let{data:a}=await this.db().from("client_activities").select("*").eq("client_id",e).gte("created_at",t.toISOString());if(!a||0===a.length)return 30;let r={login:5,approval:15,message:10,meeting:20,feedback:15,support_ticket:5},s=0;for(let e of a)s+=r[e.type]||5;return Math.min(100,Math.round(s/2))}catch(e){return console.error("Erro ao calcular engagement:",e),50}}async calculatePaymentScore(e){try{let{data:t}=await this.db().from("invoices").select("*").eq("client_id",e).order("created_at",{ascending:!1}).limit(12);if(!t||0===t.length)return 70;let a=100;for(let e of t)if("overdue"===e.status)a-=20;else if("paid"===e.status&&e.paid_at){let t=new Date(e.due_date),r=new Date(e.paid_at),s=Math.ceil((r.getTime()-t.getTime())/864e5);s>0?a-=Math.min(15,2*s):a+=5}return Math.max(0,Math.min(100,a))}catch(e){return console.error("Erro ao calcular payment score:",e),50}}async calculateSatisfactionScore(e){try{let{data:t}=await this.db().from("client_feedbacks").select("*").eq("client_id",e).order("created_at",{ascending:!1}).limit(5);if(!t||0===t.length)return 60;let a=0,r=0;for(let e of t)null!==e.nps_score&&(a+=10*e.nps_score,r++),null!==e.rating&&(a+=20*e.rating,r++);if(0===r)return 60;return Math.round(a/r)}catch(e){return console.error("Erro ao calcular satisfaction:",e),50}}async calculateGrowthScore(e){try{let{data:t}=await this.db().from("client_metrics").select("*").eq("client_id",e).order("period",{ascending:!1}).limit(3);if(!t||t.length<2)return 50;let a=t[0],r=t[1],s=0,i=0;if(a.followers&&r.followers){let e=(a.followers-r.followers)/r.followers*100;s+=Math.min(100,Math.max(0,50+e)),i++}if(a.engagement_rate&&r.engagement_rate){let e=(a.engagement_rate-r.engagement_rate)/r.engagement_rate*100;s+=Math.min(100,Math.max(0,50+2*e)),i++}if(a.conversions&&r.conversions){let e=(a.conversions-r.conversions)/r.conversions*100;s+=Math.min(100,Math.max(0,50+1.5*e)),i++}if(0===i)return 50;return Math.round(s/i)}catch(e){return console.error("Erro ao calcular growth:",e),50}}determineRiskLevel(e){return e>=75?"low":e>=50?"medium":e>=25?"high":"critical"}calculateChurnProbability(e,t){let a=100-e;return t.payment<40&&(a+=15),t.engagement<30&&(a+=10),t.satisfaction<40&&(a+=15),t.growth<30&&(a+=5),t.payment>80&&(a-=10),t.satisfaction>80&&(a-=15),Math.max(0,Math.min(100,Math.round(a)))}async generateHealthFactors(e,t){let a=[];return t.engagement>=70?a.push({name:"Alto engajamento",category:"engagement",value:t.engagement,weight:this.WEIGHTS.engagement,impact:"positive",description:"Cliente muito ativo na plataforma"}):t.engagement<40&&a.push({name:"Baixo engajamento",category:"engagement",value:t.engagement,weight:this.WEIGHTS.engagement,impact:"negative",description:"Cliente pouco ativo - risco de desconex\xe3o"}),t.payment>=80?a.push({name:"Excelente hist\xf3rico de pagamento",category:"payment",value:t.payment,weight:this.WEIGHTS.payment,impact:"positive",description:"Pagamentos sempre em dia"}):t.payment<50&&a.push({name:"Hist\xf3rico de atrasos",category:"payment",value:t.payment,weight:this.WEIGHTS.payment,impact:"negative",description:"Frequentes atrasos no pagamento"}),t.satisfaction>=80?a.push({name:"Alta satisfa\xe7\xe3o",category:"satisfaction",value:t.satisfaction,weight:this.WEIGHTS.satisfaction,impact:"positive",description:"Cliente muito satisfeito com os servi\xe7os"}):t.satisfaction<50&&a.push({name:"Satisfa\xe7\xe3o em risco",category:"satisfaction",value:t.satisfaction,weight:this.WEIGHTS.satisfaction,impact:"negative",description:"Feedbacks indicam insatisfa\xe7\xe3o"}),t.growth>=70?a.push({name:"Crescimento acelerado",category:"growth",value:t.growth,weight:this.WEIGHTS.growth,impact:"positive",description:"M\xe9tricas em crescimento constante"}):t.growth<40&&a.push({name:"Estagna\xe7\xe3o",category:"growth",value:t.growth,weight:this.WEIGHTS.growth,impact:"negative",description:"M\xe9tricas estagnadas ou em queda"}),a}generateRecommendations(e,t){let a=[];for(let t of e.filter(e=>"negative"===e.impact))switch(t.category){case"engagement":a.push("Agendar reuni\xe3o de alinhamento com o cliente"),a.push("Enviar relat\xf3rio de resultados personalizado");break;case"payment":a.push("Revisar condi\xe7\xf5es de pagamento"),a.push("Oferecer desconto para regulariza\xe7\xe3o");break;case"satisfaction":a.push("Realizar pesquisa de satisfa\xe7\xe3o detalhada"),a.push("Agendar call para entender pontos de melhoria");break;case"growth":a.push("Revisar estrat\xe9gia atual"),a.push("Propor novas a\xe7\xf5es para acelerar resultados")}return"critical"===t?(a.unshift("\uD83D\uDEA8 A\xc7\xc3O URGENTE: Cliente em risco cr\xedtico de churn"),a.push("Escalar para ger\xeancia imediatamente")):"high"===t&&a.unshift("⚠️ Cliente requer aten\xe7\xe3o especial"),[...new Set(a)].slice(0,5)}async determineTrend(e,t){try{let{data:a}=await this.db().from("client_health_scores").select("overall_score").eq("client_id",e).order("last_calculated",{ascending:!1}).limit(1).single();if(!a)return"stable";let r=t-a.overall_score;if(r>=5)return"improving";if(r<=-5)return"declining";return"stable"}catch{return"stable"}}async saveHealthScore(e){try{await this.db().from("client_health_scores").upsert({client_id:e.client_id,overall_score:e.overall_score,engagement_score:e.engagement_score,payment_score:e.payment_score,satisfaction_score:e.satisfaction_score,growth_score:e.growth_score,risk_level:e.risk_level,factors:e.factors,recommendations:e.recommendations,trend:e.trend,churn_probability:e.churn_probability,last_calculated:e.last_calculated},{onConflict:"client_id"})}catch(e){console.error("Erro ao salvar Health Score:",e)}}async getAllHealthScores(e){try{let t=this.db().from("client_health_scores").select("*").order("overall_score",{ascending:!0});e?.risk_level&&(t=t.eq("risk_level",e.risk_level)),e?.min_churn_probability&&(t=t.gte("churn_probability",e.min_churn_probability));let{data:a,error:r}=await t;if(r)return console.error("Erro ao buscar Health Scores:",r),[];return a||[]}catch(e){return console.error("Erro ao buscar Health Scores:",e),[]}}async recalculateAllScores(){try{let{data:e}=await this.db().from("clients").select("id").eq("is_active",!0);if(!e)return 0;let t=0;for(let a of e)await this.calculateHealthScore(a.id),t++;return t}catch(e){return console.error("Erro ao recalcular scores:",e),0}}constructor(){this.WEIGHTS={engagement:.25,payment:.3,satisfaction:.25,growth:.2}}}let i=new s}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958,79263],()=>a(73902));module.exports=r})();