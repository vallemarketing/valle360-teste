"use strict";(()=>{var e={};e.id=97622,e.ids=[97622],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},85964:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>f,patchFetch:()=>k,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>_,staticGenerationAsyncStorage:()=>b});var n={};i.r(n),i.d(n,{POST:()=>m,dynamic:()=>u});var a=i(49303),r=i(88716),o=i(60670),s=i(87070),d=i(17478),c=i(90176),l=i(88783);let u="force-dynamic";async function m(e){let t;let i=await (0,d.k)(e);if(!i.ok)return i.res;let n=(0,c.t)();try{t=await e.json()}catch{return s.NextResponse.json({error:"Body inv\xe1lido (JSON)"},{status:400})}let a=String(t?.actionId||t?.id||"").trim(),r=String(t?.title||"").trim(),o=String(t?.description||"").trim(),u=String(t?.category||"").trim(),m=function(e){let t=String(e||"").toLowerCase();return"urgent"===t?"urgent":"high"===t?"high":"low"===t?"low":"medium"}(t?.priority);if(!r)return s.NextResponse.json({error:"title \xe9 obrigat\xf3rio"},{status:400});try{if(a){let{data:e}=await n.from("kanban_tasks").select("id, board_id").eq("reference_links->>ci_action_id",a).limit(1).maybeSingle();if(e?.id&&e?.board_id)return s.NextResponse.json({success:!0,already_executed:!0,task:{id:String(e.id),board_id:String(e.board_id)},link:`/admin/meu-kanban?boardId=${encodeURIComponent(String(e.board_id))}&taskId=${encodeURIComponent(String(e.id))}`})}let e=await (0,l.yH)(n,i.userId),t=[o||null,u?`Categoria: ${u}`:null,a?`CI Action ID: ${a}`:null,`Executado por: ${i.userId}`,`Executado em: ${new Date().toISOString()}`].filter(Boolean).join("\n"),d=await (0,l.ID)(n,{boardId:e,clientId:null,title:r,description:t,status:"todo",priority:m,area:"admin",createdBy:i.userId,referenceLinks:{source:"intelligence_center",ci_action_id:a||null,category:u||null}});return s.NextResponse.json({success:!0,already_executed:!1,task:d,link:`/admin/meu-kanban?boardId=${encodeURIComponent(String(d.board_id))}&taskId=${encodeURIComponent(String(d.id))}`})}catch(e){return s.NextResponse.json({error:e?.message||"Erro ao executar a\xe7\xe3o"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/admin/intelligence/execute/route",pathname:"/api/admin/intelligence/execute",filename:"route",bundlePath:"app/api/admin/intelligence/execute/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\intelligence\\execute\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:b,serverHooks:_}=p,f="/api/admin/intelligence/execute/route";function k(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:b})}},90176:(e,t,i)=>{i.d(t,{t:()=>a});var n=i(54128);function a(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,n.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},17478:(e,t,i)=>{i.d(t,{k:()=>s});var n=i(87070),a=i(20344),r=i(71615),o=i(54128);async function s(e){let t=(0,r.cookies)(),i=(0,a.createRouteHandlerClient)({cookies:()=>t}),s=e.headers.get("authorization")||"",d=s.toLowerCase().startsWith("bearer ")?s.slice(7).trim():null,c=d?(0,o.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${d}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):i,{data:l}=await c.auth.getUser();if(!l.user?.id)return{ok:!1,res:n.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:u,error:m}=await c.rpc("is_admin");return m||!u?{ok:!1,res:n.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:l.user.id}}},88783:(e,t,i)=>{async function n(e,t){let{data:i}=await e.from("kanban_columns").select("id,name,position").eq("board_id",t).order("position",{ascending:!0});i&&i.length>0||await e.from("kanban_columns").insert([{name:"Backlog",position:1,color:"#64748b"},{name:"A Fazer",position:2,color:"#f59e0b"},{name:"Em Progresso",position:3,color:"#3b82f6"},{name:"Em Revis\xe3o",position:4,color:"#8b5cf6"},{name:"Conclu\xeddo",position:5,color:"#22c55e"},{name:"Bloqueado",position:6,color:"#ef4444"},{name:"Cancelado",position:7,color:"#9ca3af"}].map(e=>({...e,board_id:t})))}async function a(e,t){let{data:i}=await e.from("kanban_boards").select("id").is("client_id",null).eq("name","Super Admin").limit(1).maybeSingle();if(i?.id)return await n(e,i.id),i.id;let{data:a,error:r}=await e.from("kanban_boards").insert({name:"Super Admin",description:"Quadro central do Admin",client_id:null,is_active:!0,created_by:t||null}).select("id").single();if(r)throw r;return await n(e,a.id),a.id}async function r(e,t,i){let{data:a}=await e.from("kanban_boards").select("id").eq("client_id",t).eq("name","Onboarding").limit(1).maybeSingle();if(a?.id)return await n(e,a.id),a.id;let{data:r,error:o}=await e.from("kanban_boards").insert({name:"Onboarding",description:"Fluxo inicial autom\xe1tico",client_id:t,is_active:!0,created_by:i||null}).select("id").single();if(o)throw o;return await n(e,r.id),r.id}async function o(e,t,i){let n=function(e){switch(e){case"backlog":return"Backlog";case"in_progress":return"Em Progresso";case"in_review":return"Em Revis\xe3o";case"done":return"Conclu\xeddo";case"blocked":return"Bloqueado";case"cancelled":return"Cancelado";default:return"A Fazer"}}(i),{data:a}=await e.from("kanban_columns").select("id").eq("board_id",t).eq("name",n).limit(1).maybeSingle();if(a?.id)return a.id;let{data:r}=await e.from("kanban_columns").select("id").eq("board_id",t).order("position",{ascending:!0}).limit(1).maybeSingle();if(!r?.id)throw Error("Board sem colunas");return r.id}async function s(e,t){let i=t.status||"todo",n=t.priority||"medium",a=await o(e,t.boardId,i),{data:r}=await e.from("kanban_tasks").select("position").eq("board_id",t.boardId).eq("column_id",a).order("position",{ascending:!1}).limit(1).maybeSingle(),s=Number(r?.position||0)+1,{data:d,error:c}=await e.from("kanban_tasks").insert({board_id:t.boardId,column_id:a,title:t.title,description:t.description||null,priority:n,status:i,position:s,client_id:t.clientId||null,area:t.area||null,created_by:t.createdBy||null,reference_links:t.referenceLinks||null,updated_at:new Date().toISOString()}).select("id, board_id").single();if(c)throw c;return d}i.d(t,{ID:()=>s,bI:()=>r,yH:()=>a})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),n=t.X(0,[89276,55972,54128,20958],()=>i(85964));module.exports=n})();