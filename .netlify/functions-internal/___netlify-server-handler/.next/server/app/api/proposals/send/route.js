"use strict";(()=>{var e={};e.id=39268,e.ids=[39268],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},79099:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>w,requestAsyncStorage:()=>_,routeModule:()=>x,serverHooks:()=>g,staticGenerationAsyncStorage:()=>v});var a={};r.r(a),r.d(a,{POST:()=>m,dynamic:()=>c});var o=r(49303),s=r(88716),n=r(60670),i=r(87070),p=r(20344),l=r(71615),d=r(30920),u=r(49805);let c="force-dynamic";async function m(e){let t=(0,p.createRouteHandlerClient)({cookies:l.cookies});try{let{data:r}=await t.auth.getUser(),a=r.user?.id;if(!a)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let o=await e.json(),s=o?.proposal_id||o?.proposalId||o?.id;if(!s)return i.NextResponse.json({error:"ID da proposta \xe9 obrigat\xf3rio"},{status:400});let{data:n,error:p}=await t.from("proposals").select("*").eq("id",s).single();if(p||!n)return i.NextResponse.json({error:"Proposta n\xe3o encontrada"},{status:404});if(!n.client_email)return i.NextResponse.json({error:"Email do cliente n\xe3o informado"},{status:400});let l=process.env.NEXT_PUBLIC_APP_URL||new URL(e.url).origin||"http://localhost:3000",c=`${l}/proposta/${n.magic_link_token}`,m=n.valid_until?n.valid_until:new Date(Date.now()+2592e6).toISOString(),{error:x}=await t.from("proposals").update({status:"sent",valid_until:m,updated_at:new Date().toISOString()}).eq("id",s);if(x)throw x;let _=n.sales_rep_id||n.created_by||n.user_id||null;_&&await t.from("notifications").insert({user_id:_,title:"Proposta Enviada",message:`Proposta para ${n.client_name} foi marcada como enviada.`,type:"proposal",link:"/admin/comercial/propostas",metadata:{proposal_id:s}});try{let e=await (0,d.Kn)({eventType:"proposal.sent",entityType:"proposal",entityId:s,actorUserId:a,payload:{proposal_id:s,client_email:n.client_email,client_name:n.client_name}}),t=await (0,u.Z)(e);t.ok?await (0,d.ls)(e.id):await (0,d.bT)(e.id,t.error)}catch{}return i.NextResponse.json({success:!0,proposal_link:c,message:"Proposta enviada com sucesso"})}catch(e){return console.error("Erro ao enviar proposta:",e),i.NextResponse.json({error:"Erro ao enviar proposta"},{status:500})}}let x=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/proposals/send/route",pathname:"/api/proposals/send",filename:"route",bundlePath:"app/api/proposals/send/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\proposals\\send\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:v,serverHooks:g}=x,f="/api/proposals/send/route";function w(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:v})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958,40074,38823],()=>r(79099));module.exports=a})();