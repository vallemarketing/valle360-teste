"use strict";(()=>{var e={};e.id=55312,e.ids=[55312],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},11946:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>k,requestAsyncStorage:()=>y,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>S});var a={};r.r(a),r.d(a,{GET:()=>h,POST:()=>_,dynamic:()=>m});var s=r(49303),n=r(88716),i=r(60670),o=r(87070),c=r(90176),u=r(22887),l=r(87881),d=r(17478);let m="force-dynamic";function p(e){if(!Array.isArray(e)||0===e.length)return null;let t=e[e.length-1];return"number"==typeof t?.value?t.value:t?.value??null}async function g(e){let t=Date.now(),r=(0,c.t)(),a=new Date().toISOString().slice(0,10),s=new Date().toISOString(),{data:n,error:i}=await r.from("social_connected_accounts").select(`
      id,
      client_id,
      platform,
      external_account_id,
      status,
      social_connected_account_secrets (
        access_token,
        expires_at
      )
    `).in("platform",["instagram","facebook"]).limit(2e3),{data:d}=await r.from("client_social_connections").select("*").in("platform",["instagram","facebook"]).eq("is_active",!0).limit(2e3);if(i)return o.NextResponse.json({success:!1,error:i.message},{status:500});let m=(n||[]).map(e=>{let t=Array.isArray(e?.social_connected_account_secrets)?e.social_connected_account_secrets[0]:e.social_connected_account_secrets;return{id:String(e.id),client_id:String(e.client_id),platform:String(e.platform),external_account_id:String(e.external_account_id),status:String(e.status||"active"),token:t?.access_token?String(t.access_token):"",expires_at:t?.expires_at?String(t.expires_at):null,source:"legacy"}}),g=(d||[]).map(e=>({id:String(e.id||e.account_id),client_id:String(e.client_id),platform:String(e.platform),external_account_id:String(e.account_id),status:"active",token:e.access_token?String(e.access_token):"",expires_at:e.token_expires_at?String(e.token_expires_at):null,source:"oauth"})),h=new Set,_=[...g,...m].filter(e=>{let t=`${e.platform}:${e.external_account_id}`;return!h.has(t)&&(h.add(t),!0)}),f=0,y=0,S=0,w=[];try{for(let e of _)if(e.token){f++;try{e.expires_at&&new Date(e.expires_at).getTime()<Date.now()&&(await r.from("social_connected_accounts").update({status:"expired"}).eq("id",e.id),S++)}catch{}try{let t=(0,u.nt)({accessToken:e.token}),n={},i=null;if("instagram"===e.platform){let r=await t.getInstagramInsights(e.external_account_id,["impressions","reach","profile_views"],"day");if(i=r,r?.error)throw Error(r.error?.message||"Erro Meta (instagram insights)");for(let e of Array.isArray(r?.data)?r.data:[])n[String(e?.name||"")]=p(e?.values)}else if("facebook"===e.platform){let r=await t.getPageInsights(e.external_account_id,e.token,["page_impressions","page_engaged_users","page_fans"],"day");if(i=r,r?.error)throw Error(r.error?.message||"Erro Meta (page insights)");for(let e of Array.isArray(r?.data)?r.data:[])n[String(e?.name||"")]=p(e?.values)}let{error:o}=await r.from("social_account_metrics_daily").upsert({client_id:e.client_id,account_id:e.id,platform:e.platform,metric_date:a,metrics:n,raw_payload:{collected_at:s,platform:e.platform,metrics:n,raw:i}},{onConflict:"account_id,metric_date"});if(o)throw o;y++}catch(t){w.push({account_id:e.id,platform:e.platform,error:t?.message||"Falha ao coletar m\xe9tricas"})}}let e={success:0===w.length,processed:f,upserted:y,expired:S,failed:w.length,failures:w};return await (0,l.m)({supabase:r,action:"social-metrics",status:0===w.length?"ok":"error",durationMs:Date.now()-t,responseData:{processed:f,upserted:y,expired:S,failed:w.length},errorMessage:w.length?w[0]?.error||"Falhas ao coletar m\xe9tricas":null}),o.NextResponse.json(e)}catch(e){return await (0,l.m)({supabase:r,action:"social-metrics",status:"error",durationMs:Date.now()-t,errorMessage:e?.message||"Erro interno"}),o.NextResponse.json({success:!1,error:e?.message||"Erro interno"},{status:500})}}async function h(e){return(0,l.T)(e)||g(e)}async function _(e){let t=await (0,d.k)(e);return t.ok?g(e):t.res}let f=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/cron/social-metrics/route",pathname:"/api/cron/social-metrics",filename:"route",bundlePath:"app/api/cron/social-metrics/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\cron\\social-metrics\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:S,serverHooks:w}=f,I="/api/cron/social-metrics/route";function k(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:S})}},90176:(e,t,r)=>{r.d(t,{t:()=>s});var a=r(54128);function s(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,a.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},17478:(e,t,r)=>{r.d(t,{k:()=>o});var a=r(87070),s=r(20344),n=r(71615),i=r(54128);async function o(e){let t=(0,n.cookies)(),r=(0,s.createRouteHandlerClient)({cookies:()=>t}),o=e.headers.get("authorization")||"",c=o.toLowerCase().startsWith("bearer ")?o.slice(7).trim():null,u=c?(0,i.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${c}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):r,{data:l}=await u.auth.getUser();if(!l.user?.id)return{ok:!1,res:a.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:d,error:m}=await u.rpc("is_admin");return m||!d?{ok:!1,res:a.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:l.user.id}}},87881:(e,t,r)=>{r.d(t,{T:()=>s,m:()=>n});var a=r(87070);function s(e){let t=String(process.env.CRON_SECRET||"").trim(),r=String(e.headers.get("authorization")||"").trim();return t&&r===`Bearer ${t}`?null:"1"===String(e.headers.get("x-vercel-cron")||"").trim()||String(e.headers.get("user-agent")||"").toLowerCase().includes("vercel-cron")?null:a.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}async function n(e){try{await e.supabase.from("integration_logs").insert({integration_id:"cron",action:e.action,status:e.status,request_data:e.requestData??null,response_data:e.responseData??null,error_message:e.errorMessage??null,duration_ms:Math.max(0,Math.floor(e.durationMs||0)),created_at:new Date().toISOString()})}catch{}}},22887:(e,t,r)=>{r.d(t,{F9:()=>s,nt:()=>n});let a="https://graph.facebook.com/v18.0";class s{constructor(e){this.accessToken=e.accessToken,this.adAccountId=e.adAccountId,this.businessAccountId=e.businessAccountId}async request(e,t={}){let r=new URL(`${a}${e}`);r.searchParams.set("access_token",this.accessToken);let s=await fetch(r.toString(),{...t,headers:{"Content-Type":"application/json",...t.headers}}),n=await s.json();if(n.error)throw Error(`Meta API Error: ${n.error.message}`);return n}async verifyToken(){return this.request("/debug_token",{method:"GET"})}async getMe(){return this.request("/me?fields=id,name,email")}async getInstagramAccount(e){return this.request(`/${e}?fields=instagram_business_account{id,username,followers_count,media_count}`)}async getInstagramInsights(e,t=["impressions","reach","profile_views"],r="day"){let a=t.join(",");return this.request(`/${e}/insights?metric=${a}&period=${r}`)}async getInstagramMedia(e,t=25){return this.request(`/${e}/media?fields=id,caption,media_type,media_url,thumbnail_url,timestamp,like_count,comments_count&limit=${t}`)}async createInstagramPost(e,t,r){let a=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify({image_url:t,caption:r})});return this.request(`/${e}/media_publish`,{method:"POST",body:JSON.stringify({creation_id:a.id})})}async createInstagramVideoPost(e,t,r){let a=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify({video_url:t,media_type:"VIDEO",caption:r})});return this.request(`/${e}/media_publish`,{method:"POST",body:JSON.stringify({creation_id:a.id})})}async createInstagramCarouselPost(e,t,r){let a=[];for(let r of t.slice(0,10)){let t=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify("video"===r.type?{video_url:r.url,media_type:"VIDEO",is_carousel_item:!0}:{image_url:r.url,is_carousel_item:!0})});a.push(t.id)}let s=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify({media_type:"CAROUSEL",caption:r,children:a.join(",")})});return this.request(`/${e}/media_publish`,{method:"POST",body:JSON.stringify({creation_id:s.id})})}async getAdCampaigns(e=["id","name","status","objective"]){if(!this.adAccountId)throw Error("Ad Account ID n\xe3o configurado");let t=e.join(",");return this.request(`/${this.adAccountId}/campaigns?fields=${t}`)}async getCampaignInsights(e,t="last_30d"){return this.request(`/${e}/insights?fields=impressions,clicks,spend,reach,cpc,cpm,ctr,conversions&date_preset=${t}`)}async getAdAccountInsights(e="last_30d"){if(!this.adAccountId)throw Error("Ad Account ID n\xe3o configurado");return this.request(`/${this.adAccountId}/insights?fields=impressions,clicks,spend,reach,actions&date_preset=${e}`)}async getPages(){return this.request("/me/accounts")}async createPagePost(e,t,r,s){let n={message:r};s&&(n.link=s);let i=new URL(`${a}/${e}/feed`);return i.searchParams.set("access_token",t),(await fetch(i.toString(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).json()}async createPagePhotoPost(e,t,r,s){let n=new URL(`${a}/${e}/photos`);n.searchParams.set("access_token",t);let i=new URLSearchParams;return i.set("url",r),s&&i.set("caption",s),i.set("published","true"),(await fetch(n.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i})).json()}async createPageVideoPost(e,t,r,s){let n=new URL(`${a}/${e}/videos`);n.searchParams.set("access_token",t);let i=new URLSearchParams;return i.set("file_url",r),s&&i.set("description",s),(await fetch(n.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i})).json()}async getPageInsights(e,t,r=["page_impressions","page_engaged_users","page_fans"],s="day"){let n=r.join(","),i=new URL(`${a}/${e}/insights`);return i.searchParams.set("access_token",t),i.searchParams.set("metric",n),i.searchParams.set("period",s),(await fetch(i.toString())).json()}}function n(e){return new s(e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958],()=>r(11946));module.exports=a})();