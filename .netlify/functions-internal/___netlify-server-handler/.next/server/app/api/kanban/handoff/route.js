"use strict";(()=>{var e={};e.id=13805,e.ids=[13805],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},41329:(e,a,t)=>{t.r(a),t.d(a,{originalPathname:()=>p,patchFetch:()=>y,requestAsyncStorage:()=>k,routeModule:()=>f,serverHooks:()=>b,staticGenerationAsyncStorage:()=>g});var r={};t.r(r),t.d(r,{POST:()=>m,dynamic:()=>c});var n=t(49303),i=t(88716),o=t(60670),d=t(87070),s=t(71615),_=t(20344),l=t(54128);let c="force-dynamic";async function u(e,a=400){return d.NextResponse.json({success:!1,error:e},{status:a})}async function m(e){let a;let t=(0,s.cookies)(),r=(0,_.createRouteHandlerClient)({cookies:()=>t}),{data:n,error:i}=await r.auth.getUser(),o=n?.user;if(i||!o)return u("N\xe3o autorizado",401);let{data:c}=await r.rpc("is_admin"),{data:m}=await r.rpc("is_employee");if(!c&&!m)return u("Acesso negado",403);let f=function(){let e="https://ikjgsqtykkhqimypacro.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY;return e&&a?(0,l.eI)(e,a,{auth:{persistSession:!1}}):null}();if(!f)return u("SUPABASE_SERVICE_ROLE_KEY n\xe3o configurada no servidor",500);try{a=await e.json()}catch{return u("Body inv\xe1lido (JSON)",400)}if("message_origin"===a.action){let{taskId:e,message:t}=a;if(!e)return u("taskId obrigat\xf3rio",400);if(!t?.trim())return u("message obrigat\xf3rio",400);let{data:n,error:i}=await r.from("kanban_tasks").select("id, title, board_id, assigned_to, created_by, reference_links").eq("id",e).single();if(i||!n)return u("Tarefa n\xe3o encontrada ou sem permiss\xe3o",404);let s=(n.reference_links||{})?.handoff,_=s?.source_task_id;if(!_)return u("Esta tarefa n\xe3o tem v\xednculo de handoff (origem)",400);let{data:l}=await f.from("kanban_tasks").select("id, board_id, assigned_to, created_by").eq("id",_).maybeSingle();if(!l)return u("Tarefa de origem n\xe3o encontrada (service)",500);let{data:c}=await f.from("kanban_boards").select("id, area_key, name").eq("id",l.board_id).maybeSingle(),m=new Date().toISOString(),k=[`Mensagem sobre a tarefa executora: ${n.id}`,"",t.trim()].join("\n");await f.from("kanban_task_comments").insert({task_id:_,user_id:o.id,comment:k,created_at:m});let g=l.assigned_to||l.created_by;return g?await f.from("notifications").insert({user_id:g,type:"kanban_question",title:"Pergunta na demanda",message:`Nova mensagem na demanda: ${n.title||"Tarefa"}`,is_read:!1,link:"/colaborador/kanban",metadata:{task_id:_,from_task_id:n.id},created_at:m}):await f.from("notifications").insert({user_id:null,type:"kanban_question",title:"Pergunta na demanda (\xe1rea)",message:`Nova mensagem em ${c?.name||"origem"}: ${n.title||"Tarefa"}`,is_read:!1,link:"/admin/kanban-app",metadata:{audience:"area",area:c?.area_key||null,task_id:_,from_task_id:n.id},created_at:m}),d.NextResponse.json({success:!0})}if("forward"===a.action){let{sourceTaskId:e,targetAreaKey:t,targetUserId:n,note:i}=a;if(!e)return u("sourceTaskId obrigat\xf3rio",400);if(!t)return u("targetAreaKey obrigat\xf3rio",400);let{data:s,error:_}=await r.from("kanban_tasks").select("*").eq("id",e).single();if(_||!s)return u("Tarefa de origem n\xe3o encontrada ou sem permiss\xe3o",404);let{data:l,error:c}=await f.from("kanban_boards").select("id, area_key, name").eq("area_key",t).maybeSingle();if(c||!l)return u("Board de destino n\xe3o encontrado para a \xe1rea informada",400);let{data:m,error:k}=await f.from("kanban_columns").select("id, stage_key, name").eq("board_id",l.id).eq("stage_key","demanda").maybeSingle();if(k||!m)return u('Coluna "Demanda" n\xe3o encontrada no board de destino',500);let{data:g}=await f.from("kanban_boards").select("id, area_key, name").eq("id",s.board_id).maybeSingle(),{data:b}=await f.from("kanban_columns").select("id, stage_key, name").eq("id",s.column_id).maybeSingle(),p=new Date().toISOString(),y=s.reference_links||{},w={target_task_id:null,target_board_id:l.id,target_area_key:t,target_user_id:n||null,note:i||null,forwarded_by:o.id,forwarded_at:p},h=s.title,x=[s.description||"",i?`

Nota do solicitante: ${i}`:"",`

Origem: ${g?.name||"Board"} â€¢ Tarefa ${s.id}`].join("").trim(),q={...s.reference_links||{},handoff:{source_task_id:s.id,source_board_id:s.board_id,source_column_id:s.column_id,source_area_key:g?.area_key||null,source_board_name:g?.name||null,source_stage_key:b?.stage_key||null,target_area_key:t,target_board_id:l.id,target_board_name:l.name||null,note:i||null,forwarded_by:o.id,forwarded_at:p}},{data:S,error:v}=await f.from("kanban_tasks").insert({board_id:l.id,column_id:m.id,title:h,description:x,priority:s.priority,status:s.status||"todo",tags:s.tags||[],due_date:s.due_date||null,client_id:s.client_id||null,area:t,reference_links:q,assigned_to:n||null,created_by:o.id,position:0}).select("*").single();if(v||!S)return u(v?.message||"Falha ao criar clone",500);w.target_task_id=S.id;let R={...y,handoff_children:Array.isArray(y.handoff_children)?[...y.handoff_children,w]:[w]};return await f.from("kanban_tasks").update({reference_links:R}).eq("id",s.id),n?await f.from("notifications").insert({user_id:n,type:"kanban_handoff",title:"Nova demanda recebida",message:`Voc\xea recebeu uma demanda: ${h}`,is_read:!1,link:"/colaborador/kanban",metadata:{task_id:S.id,source_task_id:s.id,target_area_key:t},created_at:p}):await f.from("notifications").insert({user_id:null,type:"kanban_handoff",title:"Nova demanda por \xe1rea",message:`Nova demanda para a \xe1rea ${l.name}: ${h}`,is_read:!1,link:"/admin/kanban-app",metadata:{audience:"area",area:t,task_id:S.id,source_task_id:s.id,target_area_key:t},created_at:p}),d.NextResponse.json({success:!0,task:S})}let{taskId:k,note:g}=a;if(!k)return u("taskId obrigat\xf3rio",400);let{data:b,error:p}=await r.from("kanban_tasks").select("*").eq("id",k).single();if(p||!b)return u("Tarefa n\xe3o encontrada ou sem permiss\xe3o",404);let y=(b.reference_links||{})?.handoff,w=y?.source_task_id;if(!w)return u("Esta tarefa n\xe3o tem v\xednculo de handoff (origem) para retornar",400);let{data:h}=await f.from("kanban_tasks").select("*").eq("id",w).maybeSingle();if(!h)return u("Tarefa de origem n\xe3o encontrada (service)",500);let{data:x}=await f.from("kanban_boards").select("id, area_key, name").eq("id",h.board_id).maybeSingle(),{data:q}=await f.from("kanban_columns").select("id, stage_key, name").eq("board_id",h.board_id).in("stage_key",["aprovacao","demanda"]).order("stage_key",{ascending:!0}).maybeSingle();if(!q)return u("N\xe3o encontrei coluna de retorno no board de origem",500);let S=new Date().toISOString(),v=`Retorno: ${b.title}`,R=[g?`Nota: ${g}

`:"",`Relacionado \xe0 tarefa executada: ${b.id}
`,`Origem (handoff): ${h.id}
`].join(""),$={handoff_return:{from_task_id:b.id,origin_task_id:h.id,returned_by:o.id,returned_at:S,note:g||null}},{data:j,error:A}=await f.from("kanban_tasks").insert({board_id:h.board_id,column_id:q.id,title:v,description:R,priority:b.priority,status:"todo",tags:Array.isArray(b.tags)?Array.from(new Set([...b.tags,"retorno"])):["retorno"],due_date:null,client_id:b.client_id||h.client_id||null,area:x?.area_key||null,reference_links:$,assigned_to:h.assigned_to||null,created_by:o.id,position:0}).select("*").single();if(A||!j)return u(A?.message||"Falha ao criar retorno",500);let N=h.assigned_to||h.created_by;return N?await f.from("notifications").insert({user_id:N,type:"kanban_return",title:"Retorno recebido",message:`Retorno da \xe1rea: ${b.title}`,is_read:!1,link:"/admin/kanban-app",metadata:{task_id:j.id,from_task_id:b.id,origin_task_id:h.id},created_at:S}):await f.from("notifications").insert({user_id:null,type:"kanban_return",title:"Retorno recebido (\xe1rea)",message:`Retorno criado no board ${x?.name||"origem"}: ${b.title}`,is_read:!1,link:"/admin/kanban-app",metadata:{audience:"area",area:x?.area_key||null,task_id:j.id,from_task_id:b.id,origin_task_id:h.id},created_at:S}),d.NextResponse.json({success:!0,task:j})}let f=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/kanban/handoff/route",pathname:"/api/kanban/handoff",filename:"route",bundlePath:"app/api/kanban/handoff/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\kanban\\handoff\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:k,staticGenerationAsyncStorage:g,serverHooks:b}=f,p="/api/kanban/handoff/route";function y(){return(0,o.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:g})}}};var a=require("../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),r=a.X(0,[89276,55972,54128,20958],()=>t(41329));module.exports=r})();