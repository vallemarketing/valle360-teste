"use strict";(()=>{var e={};e.id=20026,e.ids=[20026],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},81277:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>b,patchFetch:()=>w,requestAsyncStorage:()=>S,routeModule:()=>y,serverHooks:()=>h,staticGenerationAsyncStorage:()=>v});var i={};a.r(i),a.d(i,{GET:()=>f,dynamic:()=>u});var n=a(49303),r=a(88716),s=a(60670),l=a(87070),o=a(20344),c=a(71615),d=a(90176);let u="force-dynamic";function m(e){let t=String(e?.message||"").toLowerCase();return"42P01"===String(e?.code||"")||t.includes("relation")||t.includes("does not exist")}function p(e){let t=Number(e);return Number.isFinite(t)?t:0}async function _(e,t){let a=await e.from("clients").select("id, company_name, segment, created_at").eq("user_id",t).maybeSingle();if(!a.error&&a.data?.id)return{schema:"new",id:String(a.data.id),companyName:String(a.data.company_name||"Cliente"),segment:a.data.segment?String(a.data.segment):null,createdAt:a.data.created_at?String(a.data.created_at):null};let i=await e.from("clients").select("id, nome_fantasia, razao_social, created_at").eq("user_id",t).maybeSingle();if(i.error||!i.data?.id)return{schema:"unknown",id:null,companyName:null,segment:null,createdAt:null,error:i.error};let n=i.data;return{schema:"legacy",id:String(n.id),companyName:String(n.nome_fantasia||n.razao_social||"Cliente"),segment:null,createdAt:n.created_at?String(n.created_at):null}}async function g(e,t){let a=new Map;if(!t.length)return a;let i=await e.from("clients").select("id, company_name").in("id",t);if(!i.error){for(let e of i.data||[]){let t=e.id?String(e.id):null;t&&a.set(t,String(e.company_name||"Cliente"))}return a}let n=await e.from("clients").select("id, nome_fantasia, razao_social").in("id",t);if(!n.error)for(let e of n.data||[]){let t=e.id?String(e.id):null;t&&a.set(t,String(e.nome_fantasia||e.razao_social||"Cliente"))}return a}async function f(e){try{var t;let e=(0,c.cookies)(),a=(0,o.createRouteHandlerClient)({cookies:()=>e}),{data:i}=await a.auth.getUser(),n=i?.user;if(!n)return l.NextResponse.json({success:!1,error:"N\xe3o autorizado"},{status:401});let r=(0,d.t)(),s=await _(r,n.id);if(!s.id)return l.NextResponse.json({success:!1,error:"Cliente n\xe3o vinculado (clients.user_id)"},{status:400});let u=[],f=null;try{let{data:e,error:t}=await r.from("client_gamification_scores").select("total_points, level, badges, achievements, updated_at").eq("client_id",s.id).maybeSingle();if(t)throw t;f=e||null}catch(e){m(e)&&u.push("missing_table_client_gamification_scores"),f=null}let y=f?.total_points!=null?p(f.total_points):0,S=f?.level!=null?p(f.level):null,v=(t=f?.badges)&&Array.isArray(t)?t.map(e=>{if(!e)return null;if("string"==typeof e)return{id:e,date:null};if("object"==typeof e){let t=String(e.id||e.badge_id||e.code||"").trim();if(!t)return null;let a=e.date||e.unlocked_at||e.at||null;return{id:t,date:a?String(a):null}}return null}).filter(Boolean):[],h=[],b=null;try{let{data:e,error:t}=await r.from("client_gamification_scores").select("client_id, total_points, updated_at").order("total_points",{ascending:!1}).limit(10);if(t)throw t;let a=Array.from(new Set((e||[]).map(e=>String(e.client_id)).filter(Boolean))),i=await g(r,a);if(h=(e||[]).map((e,t)=>{let a=String(e.client_id||"");return{position:t+1,client_id:a,name:i.get(a)||"Cliente",points:p(e.total_points),isYou:a===s.id}}).filter(e=>!!e.client_id),s.id){let{count:e,error:t}=await r.from("client_gamification_scores").select("id",{count:"exact",head:!0}).gt("total_points",y);t||"number"!=typeof e||(b=e+1)}}catch(e){m(e)&&u.push("missing_table_client_gamification_scores"),h=[],b=null}let w=[];try{let{data:e}=await r.from("user_profiles").select("id").eq("user_id",n.id).maybeSingle(),t=e?.id?String(e.id):null;if(t){let{data:e,error:a}=await r.from("activity_logs").select("id, activity_type, activity_description, created_at, metadata").eq("user_id",t).order("created_at",{ascending:!1}).limit(10);if(a)throw a;let i={approval_on_time:50,invoice_paid_on_time:100,nps_response:30,referral:500,meeting_scheduled:40,profile_completed:50,message_sent:5};w=(e||[]).map(e=>{let t=String(e.activity_type||"activity"),a=e.metadata&&"number"==typeof e.metadata.points?Number(e.metadata.points):i[t]??0;return{id:String(e.id),kind:t,action:String(e.activity_description||"Atividade registrada"),points:a,date:String(e.created_at||new Date().toISOString())}})}}catch(e){m(e)&&u.push("missing_table_activity_logs"),w=[]}return l.NextResponse.json({success:!0,warnings:u,client:{id:s.id,company_name:s.companyName,segment:s.segment,created_at:s.createdAt},score:{total_points:y,stored_level:S,badges:v,achievements:Array.isArray(f?.achievements)?f.achievements:f?.achievements||[],updated_at:f?.updated_at?String(f.updated_at):null},ranking:{my_position:b,top10:h},points_history:w})}catch(e){return l.NextResponse.json({success:!1,error:e?.message||"Erro interno"},{status:500})}}let y=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/client/valle-club/route",pathname:"/api/client/valle-club",filename:"route",bundlePath:"app/api/client/valle-club/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\valle-club\\route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:S,staticGenerationAsyncStorage:v,serverHooks:h}=y,b="/api/client/valle-club/route";function w(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:v})}},90176:(e,t,a)=>{a.d(t,{t:()=>n});var i=a(54128);function n(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,i.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),i=t.X(0,[89276,55972,54128,20958],()=>a(81277));module.exports=i})();