"use strict";exports.id=40074,exports.ids=[40074],exports.modules={90176:(e,t,a)=>{a.d(t,{t:()=>r});var o=a(54128);function r(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,o.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},9792:(e,t,a)=>{a.d(t,{n:()=>l});var o=a(54128);let r="https://ikjgsqtykkhqimypacro.supabase.co",s=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI";r&&s||console.error("âŒ Goals Engine: vari\xe1veis NEXT_PUBLIC_SUPABASE_URL e/ou SUPABASE_SERVICE_ROLE_KEY n\xe3o configuradas.");let i=(0,o.eI)(r||"https://setup-missing.supabase.co",s||"setup-missing",{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}});class n{async resolveUserIdFromCollaboratorId(e){try{let{data:t}=await i.from("employees").select("user_id").eq("id",e).maybeSingle();return t?.user_id?String(t.user_id):null}catch{return null}}async getComputedHistoryFromSystem(e,t,a){let o=await this.resolveUserIdFromCollaboratorId(e);if(!o)return[];let r=new Date;r.setMonth(r.getMonth()-a);let{data:s}=await i.from("kanban_tasks").select("id, created_at, updated_at, status, assigned_to, created_by").or(`assigned_to.eq.${o},created_by.eq.${o}`).eq("status","done").gte("updated_at",r.toISOString()),n=new Map;for(let e of s||[]){let t=e.updated_at?new Date(String(e.updated_at)):null,a=e.created_at?new Date(String(e.created_at)):null;if(!t||Number.isNaN(t.getTime()))continue;let o=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`,r=n.get(o)||{count:0,avgHours:{sum:0,n:0}};if(r.count+=1,a&&!Number.isNaN(a.getTime())){let e=Math.max(0,(t.getTime()-a.getTime())/36e5);r.avgHours.sum+=e,r.avgHours.n+=1}n.set(o,r)}let l=[];for(let[a,o]of n.entries()){let[r,s]=a.split("-").map(e=>Number(e)),i=new Date(r,(s||1)-1,1).toISOString().slice(0,10),n=o.avgHours.n>0?o.avgHours.sum/o.avgHours.n:0,c={};"designer"===t?(c.pecas=o.count,c.tempo_medio=n):"social_media"===t?(c.posts=o.count,c.stories=Math.round(1.5*o.count)):"video_maker"===t?(c.videos=o.count,c.minutos_produzidos=Math.round(3*o.count)):"comercial"===t?c.leads_qualificados=o.count:c.pecas=o.count,l.push({collaborator_id:e,sector:t,period_date:i,metrics:c})}return l.sort((e,t)=>String(e.period_date).localeCompare(String(t.period_date))),l}async calculateSuggestedGoals(e,t,a="monthly"){let o=await this.getGoalConfig(t);if(!o)throw Error(`Configura\xe7\xe3o n\xe3o encontrada para o setor: ${t}`);let r=await this.getProductionHistory(e,t,3);r&&0!==r.length||(r=await this.getComputedHistoryFromSystem(e,t,3));let s=[],i=new Date().getMonth()+1;for(let e of o.metrics){let t=this.calculateMetricGoal(e,r,o,i);s.push(t)}return s}calculateMetricGoal(e,t,a,o){let r;let s=[],i=85,n=t.map(t=>t.metrics[e.name]||0).filter(e=>e>0);if(0===n.length)return{metric:e.name,suggested_target:this.getBaselineTarget(e.name,a.sector),reasoning:"Meta base definida para novos colaboradores",confidence:60,factors:["Sem hist\xf3rico de produ\xe7\xe3o"]};let l=n.reduce((e,t)=>e+t,0)/n.length;s.push(`M\xe9dia dos \xfaltimos ${n.length} per\xedodos: ${l.toFixed(1)}`);let c=this.calculateTrend(n);s.push(`Tend\xeancia: ${c>0?"+":""}${(100*c).toFixed(1)}%`);let d=a.growth_rate/100;a.always_increase&&(d=Math.max(d,a.min_growth_rate/100),s.push("Setor comercial: meta sempre crescente")),c>0?(d=Math.min(d+.5*c,a.max_growth_rate/100),s.push("Ajuste positivo por tend\xeancia de crescimento"),i+=5):c<-.1&&(d=Math.max(.7*d,a.min_growth_rate/100),s.push("Ajuste conservador por queda de desempenho"),i-=10);let u=a.seasonal_adjustments[String(o)]||1;return 1!==u&&s.push(`Ajuste sazonal: ${((u-1)*100).toFixed(0)}%`),e.inverse?(r=l*(1-.5*d)*(2-u),s.push("M\xe9trica inversa: objetivo \xe9 reduzir")):r=l*(1+d)*u,r=this.smartRound(r,e.unit),{metric:e.name,suggested_target:r,reasoning:`Baseado na m\xe9dia de ${l.toFixed(1)} ${e.unit} com crescimento de ${(100*d).toFixed(0)}%`,confidence:i,factors:s}}calculateTrend(e){if(e.length<2)return 0;let t=e.slice(0,Math.ceil(e.length/2)),a=e.slice(Math.ceil(e.length/2)),o=t.reduce((e,t)=>e+t,0)/t.length,r=a.reduce((e,t)=>e+t,0)/a.length;return 0===o?0:(r-o)/o}smartRound(e,t){return"%"===t?Math.round(10*e)/10:"R$"===t?100*Math.round(e/100):e>1e3?10*Math.round(e/10):Math.round(e)}getBaselineTarget(e,t){return({social_media:{posts:20,stories:40,engajamento:3,alcance:5e3},designer:{pecas:15,revisoes:2,tempo_medio:4,satisfacao:85},trafego:{roas:3,conversoes:50,cpc:2,investimento_gerenciado:1e4},video_maker:{videos:8,minutos_produzidos:30,views_total:1e4,satisfacao:85},comercial:{leads_qualificados:10,reunioes:8,propostas:5,fechamentos:2},rh:{contratacoes:2,tempo_vaga:30,retention_rate:90,satisfacao_onboarding:85}})[t]?.[e]||10}async getGoalConfig(e){let{data:t,error:a}=await i.from("goal_configs").select("*").eq("sector",e).single();return a||!t?(console.error("Erro ao buscar config:",a),null):t}async getProductionHistory(e,t,a=3){let o=new Date;o.setMonth(o.getMonth()-a);let{data:r,error:s}=await i.from("production_history").select("*").eq("collaborator_id",e).eq("sector",t).gte("period_date",o.toISOString().split("T")[0]).order("period_date",{ascending:!0});return s?(console.error("Erro ao buscar hist\xf3rico:",s),[]):r||[]}async createGoal(e,t,a,o="monthly"){let r,s;let n=new Date;if("weekly"===o)(s=new Date(r=new Date(n.setDate(n.getDate()-n.getDay()+1)))).setDate(s.getDate()+6);else if("monthly"===o)r=new Date(n.getFullYear(),n.getMonth(),1),s=new Date(n.getFullYear(),n.getMonth()+1,0);else{let e=Math.floor(n.getMonth()/3);r=new Date(n.getFullYear(),3*e,1),s=new Date(n.getFullYear(),(e+1)*3,0)}let l=r.toISOString().split("T")[0],c=s.toISOString().split("T")[0],{data:d}=await i.from("collaborator_goals").select("id").eq("collaborator_id",e).eq("sector",a).eq("period_type",o).eq("period_start",l).eq("period_end",c).limit(1).maybeSingle(),u=await this.calculateSuggestedGoals(e,a,o),g={},m=await this.getGoalConfig(a);u.forEach(e=>{let t=m?.metrics.find(t=>t.name===e.metric);g[e.metric]={target:e.suggested_target,current:0,unit:t?.unit||""}});let _=u.reduce((e,t)=>e+t.confidence,0)/u.length,p=u.map(e=>`${e.metric}: ${e.reasoning}`).join("; "),{data:h,error:f}=d?.id?await i.from("collaborator_goals").update({collaborator_name:t,goals:g,ai_suggested:!0,ai_confidence:_,ai_reasoning:p,adjustment_reason:null,adjusted_by:null,updated_at:new Date().toISOString()}).eq("id",d.id).select().single():await i.from("collaborator_goals").insert({collaborator_id:e,collaborator_name:t,sector:a,period_start:l,period_end:c,period_type:o,goals:g,overall_progress:0,status:"active",ai_suggested:!0,ai_confidence:_,ai_reasoning:p}).select().single();return f?(console.error("Erro ao criar meta:",f),null):h}async updateProgress(e,t,a){let o=[],{data:r,error:s}=await i.from("collaborator_goals").select("*").eq("id",e).single();if(s||!r)return{success:!1,newProgress:0,alerts:["Meta n\xe3o encontrada"]};let n=r.goals;n[t]&&(n[t].current=a);let l=await this.getGoalConfig(r.sector),c=0,d=0;Object.entries(n).forEach(([e,t])=>{let a;let o=l?.metrics.find(t=>t.name===e),r=o?.weight||1;c+=r,a=o?.inverse?t.target>0?Math.min(100,t.target/t.current*100):0:t.target>0?Math.min(100,t.current/t.target*100):0,d+=a*r});let u=c>0?d/c:0,g=r.status;u>=100?(g="completed",o.push("\uD83C\uDF89 Parab\xe9ns! Voc\xea completou sua meta!")):u>=120&&(g="exceeded",o.push("\uD83D\uDE80 Incr\xedvel! Voc\xea superou sua meta em 20%!"));let m=u>=100/30?(r.streak_days||0)+1:0,_=await this.checkAchievements(r.collaborator_id,u,m);return _.length>0&&o.push(..._.map(e=>`ðŸ† Conquista desbloqueada: ${e}!`)),await i.from("collaborator_goals").update({goals:n,overall_progress:u,status:g,streak_days:m,updated_at:new Date().toISOString()}).eq("id",e),{success:!0,newProgress:u,alerts:o}}async checkAchievements(e,t,a){let o=[],{data:r}=await i.from("goal_achievements").select("*");if(!r)return o;let{data:s}=await i.from("collaborator_achievements").select("achievement_id").eq("collaborator_id",e),n=new Set((s||[]).map(e=>e.achievement_id));for(let s of r){if(n.has(s.id))continue;let r=s.criteria,l=!1;switch(r.type){case"streak":l=a>=(r.value||7);break;case"exceed_percentage":l=t>=100+(r.value||20);break;case"first_goal":l=t>=100}l&&(await i.from("collaborator_achievements").insert({collaborator_id:e,achievement_id:s.id}),o.push(s.name))}return o}async checkAndCreateAlerts(){let{data:e}=await i.from("collaborator_goals").select("*").eq("status","active");if(!e)return;let t=new Date;for(let a of e){let e=new Date(a.period_end),o=new Date(a.period_start),r=(e.getTime()-o.getTime())/864e5,s=(t.getTime()-o.getTime())/864e5/r*100,n=a.overall_progress||0,l=n-s;l<-20&&await i.from("goal_alerts").insert({collaborator_id:a.collaborator_id,goal_id:a.id,type:"behind_schedule",severity:l<-40?"critical":"warning",title:"Meta em risco",message:`Voc\xea est\xe1 ${Math.abs(l).toFixed(0)}% abaixo do esperado para este per\xedodo. Progresso atual: ${n.toFixed(0)}%`,suggested_action:"Revisar prioridades e focar nas entregas principais"}),l>20&&n>80&&await i.from("goal_alerts").insert({collaborator_id:a.collaborator_id,goal_id:a.id,type:"exceeding",severity:"success",title:"Excelente desempenho!",message:`Voc\xea est\xe1 ${l.toFixed(0)}% acima do esperado! Continue assim!`,suggested_action:"Manter o ritmo e ajudar colegas se poss\xedvel"})}}}let l=new n}};