"use strict";(()=>{var e={};e.id=91907,e.ids=[91907],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},49682:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>_,staticGenerationAsyncStorage:()=>f});var a={};r.r(a),r.d(a,{GET:()=>p,dynamic:()=>d});var s=r(49303),i=r(88716),n=r(60670),o=r(87070),c=r(20344),l=r(71615),u=r(52955);let d="force-dynamic";async function p(e){try{let t=(0,l.cookies)(),r=(0,c.createRouteHandlerClient)({cookies:()=>t}),a=await (0,u.U)({supabase:r});if(!a.allowed)return o.NextResponse.json({error:a.reason||"Acesso negado"},{status:403});let{searchParams:s}=new URL(e.url),i=String(s.get("client_id")||"").trim();if(!i)return o.NextResponse.json({error:"client_id \xe9 obrigat\xf3rio"},{status:400});let n=Math.min(90,Math.max(1,Number(s.get("days")||30))),d=new Date;d.setDate(d.getDate()-(n-1));let p=function(e){let t=new Date(e);return t.setUTCHours(0,0,0,0),t.toISOString().slice(0,10)}(d),{data:m,error:g}=await r.from("social_account_metrics_daily").select("platform, metric_date, metrics").eq("client_id",i).gte("metric_date",p).order("metric_date",{ascending:!0}).limit(5e3);if(g)return o.NextResponse.json({error:g.message},{status:500});let f=(m||[]).map(e=>({date:String(e.metric_date),platform:String(e.platform),metrics:e.metrics||{}})),_={};for(let e of f){let t=e.date,r=e.metrics||{};_[t]||={impressions:0,reach:0,engaged:0,fans:0,profile_views:0},_[t].impressions+=Number(r.impressions??r.page_impressions??0)||0,_[t].reach+=Number(r.reach??0)||0,_[t].profile_views+=Number(r.profile_views??0)||0,_[t].engaged+=Number(r.page_engaged_users??0)||0,_[t].fans+=Number(r.page_fans??0)||0}let y=Object.keys(_).sort().map(e=>({date:e,..._[e]})),x=y.length?y[y.length-1]:null;return o.NextResponse.json({success:!0,client_id:i,range_days:n,latest:x,daily:y})}catch(e){return o.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/social/metrics/route",pathname:"/api/social/metrics",filename:"route",bundlePath:"app/api/social/metrics/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\social\\metrics\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:_}=m,y="/api/social/metrics/route";function x(){return(0,n.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:f})}},52955:(e,t,r)=>{r.d(t,{U:()=>n});var a=r(57157);async function s(e,t,r){try{let{data:a,error:s}=await e.rpc(t,r);if(s)return{ok:!1,error:s};return{ok:!0,data:a}}catch(e){return{ok:!1,error:e}}}function i(e){return Array.from(new Set(e))}async function n(e){let t=e.supabase,{data:r}=await t.auth.getUser(),n=r.user?.id;if(!n)return{userId:"",isSuperAdmin:!1,isAdmin:!1,allowed:!1,reason:"N\xe3o autenticado",areaKeys:[]};let o=await s(t,"is_admin"),c=!!o.ok&&!!o.data,l=await s(t,"is_super_admin"),u=!!l.ok&&!!l.data;if(c||u)return{userId:n,isSuperAdmin:u,isAdmin:c,allowed:!0,areaKeys:[]};let d=await s(t,"employee_area_keys");if(d.ok&&Array.isArray(d.data)){let e=(d.data||[]).map(e=>String(e)),t=e.includes("social_media")||e.includes("head_marketing");return{userId:n,isSuperAdmin:u,isAdmin:c,allowed:t,reason:t?void 0:"Acesso restrito: necess\xe1rio Social Media ou Head Marketing",areaKeys:i(e)}}let{data:p}=await t.from("employees").select("department, area_of_expertise, areas, is_active").eq("user_id",n).maybeSingle(),m=[];p?.department&&m.push(String(p.department)),p?.area_of_expertise&&m.push(String(p.area_of_expertise)),Array.isArray(p?.areas)&&m.push(...p.areas.map(e=>String(e)));let g=i(m.map(e=>(0,a.IY)(e)).filter(Boolean).map(e=>e)),f=g.includes("social_media")||g.includes("head_marketing");return{userId:n,isSuperAdmin:u,isAdmin:c,allowed:f,reason:f?void 0:"Acesso restrito: necess\xe1rio Social Media ou Head Marketing",areaKeys:g}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958,57157],()=>r(49682));module.exports=a})();