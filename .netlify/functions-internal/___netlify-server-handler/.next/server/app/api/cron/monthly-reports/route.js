"use strict";(()=>{var e={};e.id=10666,e.ids=[10666],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},6162:e=>{e.exports=require("worker_threads")},11525:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>b,patchFetch:()=>_,requestAsyncStorage:()=>f,routeModule:()=>g,serverHooks:()=>x,staticGenerationAsyncStorage:()=>F});var r={};o.r(r),o.d(r,{GET:()=>m});var a=o(49303),l=o(88716),s=o(60670),n=o(87070),i=o(54128),c=o(3370);let d=(0,i.eI)("https://ikjgsqtykkhqimypacro.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function m(e){try{if(e.headers.get("authorization")!==`Bearer ${process.env.CRON_SECRET}`&&process.env.CRON_SECRET)return n.NextResponse.json({error:"Unauthorized"},{status:401});let t=new Date,o=new Date(t.getFullYear(),t.getMonth()-1,1),r=new Date(t.getFullYear(),t.getMonth(),0),a=o.toISOString().split("T")[0],l=r.toISOString().split("T")[0];console.log(`[CRON] Generating monthly reports for ${a} to ${l}`);let{data:s,error:i}=await d.from("clients").select(`
        id,
        company_name,
        email,
        contact_name,
        client_white_label (
          primary_color,
          secondary_color,
          logo_url,
          company_name,
          report_footer
        )
      `).eq("active",!0);if(i||!s)return console.error("Failed to fetch clients:",i),n.NextResponse.json({error:"Failed to fetch clients"},{status:500});let m={total:s.length,generated:0,emailed:0,failed:0};for(let e of s)try{let r=await p(e.id,a,l),s=await u(e.id,a,l),n=await h(e.id,a,l),i={clientName:e.company_name,clientLogo:e.client_white_label?.[0]?.logo_url,period:{start:a,end:l},metrics:r,topPosts:s,platformBreakdown:n},g=e.client_white_label?.[0]?{primaryColor:e.client_white_label[0].primary_color||"#4F46E5",secondaryColor:e.client_white_label[0].secondary_color||"#6B7280",logoUrl:e.client_white_label[0].logo_url,companyName:e.client_white_label[0].company_name||"Valle360",reportFooter:e.client_white_label[0].report_footer}:void 0,f=await (0,c.m)(i,g);m.generated++;let F=`reports/${e.id}/${t.getFullYear()}/${String(t.getMonth()).padStart(2,"0")}/relatorio-${a}.pdf`,x=Buffer.from(await f.arrayBuffer());await d.storage.from("client-files").upload(F,x,{contentType:"application/pdf",upsert:!0}),await d.from("client_reports").insert({client_id:e.id,type:"monthly",period_start:a,period_end:l,file_path:F,metrics:r,generated_at:new Date().toISOString()}),e.email&&(await (0,c.U)(f,e.email,e.company_name),m.emailed++);try{await d.from("notifications").insert({user_id:e.id,type:"report_generated",title:"Relat\xf3rio mensal dispon\xedvel",message:`Seu relat\xf3rio de ${o.toLocaleDateString("pt-BR",{month:"long",year:"numeric"})} est\xe1 pronto!`,link:"/cliente/relatorios",is_read:!1,created_at:new Date().toISOString()})}catch{}console.log(`[REPORT] Generated for ${e.company_name}`)}catch(t){console.error(`Failed to generate report for ${e.id}:`,t),m.failed++}try{await d.from("cron_logs").insert({job_name:"monthly_reports",run_at:new Date().toISOString(),status:0===m.failed?"success":"partial",result:m})}catch{}return console.log("[CRON] Monthly reports complete:",m),n.NextResponse.json({success:!0,...m})}catch(e){return console.error("[CRON] Monthly reports error:",e),n.NextResponse.json({error:e.message||"Cron job failed"},{status:500})}}async function p(e,t,o){let{data:r}=await d.from("social_posts").select("*").eq("client_id",e).gte("published_at",t).lte("published_at",o),a=r?.filter(e=>"published"===e.status)||[],l=r?.filter(e=>"scheduled"===e.status)||[],s=a.reduce((e,t)=>e+(t.metrics?.likes||0)+(t.metrics?.comments||0)+(t.metrics?.shares||0),0),n=a.reduce((e,t)=>e+(t.metrics?.reach||0),0),i=a.reduce((e,t)=>e+(t.metrics?.impressions||0),0);return{totalPosts:r?.length||0,publishedPosts:a.length,scheduledPosts:l.length,engagementRate:Math.round(10*(n>0?s/n*100:0))/10,reach:n,impressions:i,likes:a.reduce((e,t)=>e+(t.metrics?.likes||0),0),comments:a.reduce((e,t)=>e+(t.metrics?.comments||0),0),shares:a.reduce((e,t)=>e+(t.metrics?.shares||0),0),followers:0,followerGrowth:0}}async function u(e,t,o){let{data:r}=await d.from("social_posts").select("*").eq("client_id",e).eq("status","published").gte("published_at",t).lte("published_at",o).order("created_at",{ascending:!1}).limit(20);return r?r.map(e=>({id:e.id,caption:e.caption||e.content||"",platform:e.platform||"instagram",engagement:((e.metrics?.likes||0)+(e.metrics?.comments||0)+(e.metrics?.shares||0))/Math.max(e.metrics?.reach||1,1)*100,reach:e.metrics?.reach||0,publishedAt:e.published_at})).sort((e,t)=>t.engagement-e.engagement).slice(0,5):[]}async function h(e,t,o){let{data:r}=await d.from("social_posts").select("platform, metrics, status").eq("client_id",e).eq("status","published").gte("published_at",t).lte("published_at",o);if(!r)return{};let a={};for(let e of r){let t=e.platform||"instagram";a[t]||(a[t]={posts:0,engagement:0,reach:0}),a[t].posts++,a[t].reach+=e.metrics?.reach||0;let o=(e.metrics?.likes||0)+(e.metrics?.comments||0)+(e.metrics?.shares||0),r=e.metrics?.reach||1;a[t].engagement+=o/r*100}for(let e of Object.keys(a))a[e].posts>0&&(a[e].engagement=Math.round(a[e].engagement/a[e].posts*10)/10);return a}let g=new a.AppRouteRouteModule({definition:{kind:l.x.APP_ROUTE,page:"/api/cron/monthly-reports/route",pathname:"/api/cron/monthly-reports",filename:"route",bundlePath:"app/api/cron/monthly-reports/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\cron\\monthly-reports\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:F,serverHooks:x}=g,b="/api/cron/monthly-reports/route";function _(){return(0,s.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:F})}},3370:(e,t,o)=>{o.d(t,{U:()=>n,m:()=>a});var r=o(17817);async function a(e,t){let o=new r.kH({orientation:"portrait",unit:"mm",format:"a4"}),a=t?.primaryColor||"#4F46E5",n=t?.secondaryColor||"#6B7280",i=t?.companyName||"Valle360",c=o.internal.pageSize.getWidth(),d=o.internal.pageSize.getHeight(),m=c-40;function p(e){let t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:79,g:70,b:229}}let u=p(a),h=p(n);o.setFillColor(u.r,u.g,u.b),o.rect(0,0,c,60,"F"),o.setTextColor(255,255,255),o.setFontSize(28),o.setFont("helvetica","bold"),o.text(i,20,38),o.setFontSize(12),o.setFont("helvetica","normal"),o.text("Social Media Performance Report",20,50),o.setTextColor(u.r,u.g,u.b),o.setFontSize(24),o.setFont("helvetica","bold"),o.text(e.clientName,20,90),o.setTextColor(h.r,h.g,h.b),o.setFontSize(12),o.setFont("helvetica","normal"),o.text(`Per\xedodo: ${s(e.period.start)} - ${s(e.period.end)}`,20,100),o.setFontSize(10),o.text(`Gerado em: ${s(new Date().toISOString())}`,20,108);let g=130,f=(m-10)/3;[{label:"Posts Publicados",value:e.metrics.publishedPosts.toString()},{label:"Taxa de Engajamento",value:`${e.metrics.engagementRate.toFixed(1)}%`},{label:"Alcance Total",value:l(e.metrics.reach)}].forEach((e,t)=>{let r=20+t*(f+5);o.setFillColor(248,250,252),o.roundedRect(r,g,f,45,3,3,"F"),o.setTextColor(u.r,u.g,u.b),o.setFontSize(22),o.setFont("helvetica","bold"),o.text(e.value,r+f/2,g+22,{align:"center"}),o.setTextColor(h.r,h.g,h.b),o.setFontSize(9),o.setFont("helvetica","normal"),o.text(e.label,r+f/2,g+35,{align:"center"})}),o.setFontSize(8),o.setTextColor(h.r,h.g,h.b);let F=t?.reportFooter||`\xa9 ${new Date().getFullYear()} ${i}. Todos os direitos reservados.`;o.text(F,c/2,d-15,{align:"center"}),o.addPage(),o.setFillColor(u.r,u.g,u.b),o.rect(0,0,c,25,"F"),o.setTextColor(255,255,255),o.setFontSize(14),o.setFont("helvetica","bold"),o.text("M\xe9tricas Detalhadas",20,17),g=40,o.setTextColor(u.r,u.g,u.b),o.setFontSize(12),o.setFont("helvetica","bold"),o.text("Engajamento",20,g),g+=10;let x=[{label:"Curtidas",value:l(e.metrics.likes)},{label:"Coment\xe1rios",value:l(e.metrics.comments)},{label:"Compartilhamentos",value:l(e.metrics.shares)},{label:"Impress\xf5es",value:l(e.metrics.impressions)}],b=(m-10)/2;return x.forEach((e,t)=>{let r=20+t%2*(b+10),a=g+40*Math.floor(t/2);o.setFillColor(248,250,252),o.roundedRect(r,a,b,35,2,2,"F"),o.setTextColor(36,36,36),o.setFontSize(16),o.setFont("helvetica","bold"),o.text(e.value,r+10,a+18),o.setTextColor(h.r,h.g,h.b),o.setFontSize(9),o.setFont("helvetica","normal"),o.text(e.label,r+10,a+28)}),g+=40*Math.ceil(x.length/2)+15,o.setTextColor(u.r,u.g,u.b),o.setFontSize(12),o.setFont("helvetica","bold"),o.text("Audi\xeancia",20,g),g+=10,[{label:"Seguidores",value:l(e.metrics.followers)},{label:"Crescimento",value:`${e.metrics.followerGrowth>=0?"+":""}${e.metrics.followerGrowth}%`}].forEach((e,t)=>{let r=20+t*(b+10);o.setFillColor(248,250,252),o.roundedRect(r,g,b,35,2,2,"F"),o.setTextColor(36,36,36),o.setFontSize(16),o.setFont("helvetica","bold"),o.text(e.value,r+10,g+18),o.setTextColor(h.r,h.g,h.b),o.setFontSize(9),o.setFont("helvetica","normal"),o.text(e.label,r+10,g+28)}),g+=55,o.setTextColor(u.r,u.g,u.b),o.setFontSize(12),o.setFont("helvetica","bold"),o.text("Desempenho por Plataforma",20,g),g+=10,o.setFillColor(u.r,u.g,u.b),o.rect(20,g,m,10,"F"),o.setTextColor(255,255,255),o.setFontSize(9),o.setFont("helvetica","bold"),o.text("Plataforma",25,g+7),o.text("Posts",80,g+7),o.text("Engajamento",120,g+7),o.text("Alcance",165,g+7),g+=10,o.setFont("helvetica","normal"),Object.entries(e.platformBreakdown).forEach(([e,t],r)=>{let a=r%2==0?255:248;o.setFillColor(a,a,a),o.rect(20,g,m,10,"F"),o.setTextColor(36,36,36),o.text(e.charAt(0).toUpperCase()+e.slice(1),25,g+7),o.text(t.posts.toString(),80,g+7),o.text(`${t.engagement.toFixed(1)}%`,120,g+7),o.text(l(t.reach),165,g+7),g+=10}),e.topPosts.length>0&&(o.addPage(),o.setFillColor(u.r,u.g,u.b),o.rect(0,0,c,25,"F"),o.setTextColor(255,255,255),o.setFontSize(14),o.setFont("helvetica","bold"),o.text("Top Posts do Per\xedodo",20,17),g=40,e.topPosts.slice(0,5).forEach((e,t)=>{o.setFillColor(248,250,252),o.roundedRect(20,g,m,45,3,3,"F"),o.setFillColor(u.r,u.g,u.b),o.circle(35,g+15,8,"F"),o.setTextColor(255,255,255),o.setFontSize(12),o.setFont("helvetica","bold"),o.text(`${t+1}`,35,g+18,{align:"center"}),o.setTextColor(u.r,u.g,u.b),o.setFontSize(8),o.setFont("helvetica","bold"),o.text(e.platform.toUpperCase(),50,g+12),o.setTextColor(36,36,36),o.setFontSize(10),o.setFont("helvetica","normal");let r=e.caption.length>80?e.caption.slice(0,80)+"...":e.caption;o.text(r,50,g+22),o.setTextColor(h.r,h.g,h.b),o.setFontSize(8),o.text(`Engajamento: ${e.engagement}% | Alcance: ${l(e.reach)} | ${s(e.publishedAt)}`,50,g+35),g+=50})),o.setFontSize(8),o.setTextColor(h.r,h.g,h.b),o.text(t?.reportFooter||`\xa9 ${new Date().getFullYear()} ${i}`,c/2,d-15,{align:"center"}),o.output("blob")}function l(e){return e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString()}function s(e){return new Date(e).toLocaleDateString("pt-BR",{day:"2-digit",month:"short",year:"numeric"})}async function n(e,t,o){let r=await e.arrayBuffer(),a=Buffer.from(r).toString("base64");await fetch("/api/email/send-report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to:t,subject:`Relat\xf3rio de Performance - ${o}`,attachments:[{filename:`relatorio-${o.toLowerCase().replace(/\s+/g,"-")}.pdf`,content:a,contentType:"application/pdf"}]})})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,17817],()=>o(11525));module.exports=r})();