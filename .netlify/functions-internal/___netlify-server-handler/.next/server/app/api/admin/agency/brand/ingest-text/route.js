"use strict";(()=>{var e={};e.id=33361,e.ids=[33361],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},30310:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{POST:()=>l,dynamic:()=>d});var a=r(49303),s=r(88716),i=r(60670),o=r(87070),c=r(17478),u=r(14065);let d="force-dynamic";async function l(e){let t;let r=await (0,c.k)(e);if(!r.ok)return r.res;try{t=await e.json()}catch{return o.NextResponse.json({success:!1,error:"Body inv\xe1lido (JSON)"},{status:400})}let n=String(t?.client_id||"").trim(),a=String(t?.content||"").trim();if(!n)return o.NextResponse.json({success:!1,error:"client_id \xe9 obrigat\xf3rio"},{status:400});if(!a)return o.NextResponse.json({success:!1,error:"content \xe9 obrigat\xf3rio"},{status:400});try{let e=await (0,u.ci)({clientId:n,title:t.title||null,content:a,sourceType:t.source_type||"manual",sourceRef:t.source_ref||null,createdByUserId:r.userId,metadata:t.metadata||{}});return o.NextResponse.json({success:!0,document_id:e.documentId,chunks_created:e.chunksCreated})}catch(e){return o.NextResponse.json({success:!1,error:String(e?.message||"Falha ao ingerir texto")},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/agency/brand/ingest-text/route",pathname:"/api/admin/agency/brand/ingest-text",filename:"route",bundlePath:"app/api/admin/agency/brand/ingest-text/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\agency\\brand\\ingest-text\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:h,serverHooks:g}=m,y="/api/admin/agency/brand/ingest-text/route";function f(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}},14065:(e,t,r)=>{r.d(t,{$y:()=>d,Lw:()=>c,ci:()=>o,jN:()=>u});var n=r(54128);function a(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase env vars not configured");return(0,n.eI)(e,t,{auth:{persistSession:!1}})}async function s(e){let t=process.env.OPENAI_API_KEY;if(!t)throw Error("OPENAI_API_KEY n\xe3o configurada");if(0===e.length)return[];let r=process.env.OPENAI_EMBEDDING_MODEL||"text-embedding-3-small",n=await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:r,input:e})});if(!n.ok){let e=await n.text();throw Error(`OpenAI embeddings failed: ${n.status} ${e}`)}let a=(await n.json()).data||[];return a.sort((e,t)=>e.index-t.index),a.map(e=>e.embedding)}function i(e){return"["+e.map(e=>e.toFixed(8)).join(",")+"]"}async function o(e){let t=a(),r=e.metadata||{},{data:n,error:o}=await t.from("brand_memory_documents").insert({client_id:e.clientId,title:e.title||null,source_type:e.sourceType||"manual",source_ref:e.sourceRef||null,raw_text:e.content,metadata:r,created_by_user_id:e.createdByUserId||null}).select("id").single();if(o||!n?.id)throw Error(`Falha ao criar documento: ${o?.message}`);let c=String(n.id),u=function(e,t=1200,r=200){let n=(e||"").trim();if(!n)return[];if(t<=0)return[n];let a=[],s=0,i=n.length;for(;s<i;){let e=Math.min(i,s+t);if(a.push(n.slice(s,e)),e>=i)break;s=Math.max(0,e-r)}return a}(e.content);if(0===u.length)return{documentId:c,chunksCreated:0};let d=await s(u),l=u.map((t,n)=>({client_id:e.clientId,document_id:c,chunk_index:n,content:t,metadata:{title:e.title,...r,chunk_size:t.length},embedding:i(d[n])})),{error:m}=await t.from("brand_memory_chunks").insert(l);if(m)throw Error(`Falha ao inserir chunks: ${m.message}`);return{documentId:c,chunksCreated:l.length}}async function c(e){let t=a(),r=e.matchCount??8,n=e.similarityThreshold??.7,[o]=await s([e.query]),{data:c,error:u}=await t.rpc("match_brand_memory_chunks",{p_client_id:e.clientId,query_embedding:i(o),match_count:r,similarity_threshold:n});if(u)throw Error(`Falha na busca: ${u.message}`);return{matches:c||[]}}async function u(e,t,r=5){if(!t)return[];try{return(await c({clientId:t,query:e,matchCount:r,similarityThreshold:.65})).matches}catch(e){return console.error("searchMemory error:",e),[]}}async function d(e){if(!e)return null;try{let t=[];for(let r of["tom de voz e personalidade da marca","valores e miss\xe3o da empresa","p\xfablico-alvo e personas","diretrizes visuais e identidade"]){let n=await u(r,e,3);t.push(...n)}if(0===t.length)return null;let r=Array.from(new Map(t.map(e=>[e.id,e])).values());return r.sort((e,t)=>t.similarity-e.similarity),r.slice(0,8).map(e=>e.content).join("\n\n---\n\n")}catch(e){return console.error("getBrandContext error:",e),null}}},17478:(e,t,r)=>{r.d(t,{k:()=>o});var n=r(87070),a=r(20344),s=r(71615),i=r(54128);async function o(e){let t=(0,s.cookies)(),r=(0,a.createRouteHandlerClient)({cookies:()=>t}),o=e.headers.get("authorization")||"",c=o.toLowerCase().startsWith("bearer ")?o.slice(7).trim():null,u=c?(0,i.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${c}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):r,{data:d}=await u.auth.getUser();if(!d.user?.id)return{ok:!1,res:n.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:l,error:m}=await u.rpc("is_admin");return m||!l?{ok:!1,res:n.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:d.user.id}}}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[89276,55972,54128,20958],()=>r(30310));module.exports=n})();