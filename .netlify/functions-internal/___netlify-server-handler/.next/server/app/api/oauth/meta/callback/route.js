"use strict";(()=>{var e={};e.id=72032,e.ids=[72032],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63810:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>k,patchFetch:()=>P,requestAsyncStorage:()=>h,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var r={};a.r(r),a.d(r,{GET:()=>p});var s=a(49303),o=a(88716),n=a(60670),c=a(87070),i=a(90176);let l=process.env.META_APP_ID||"",_=process.env.META_APP_SECRET||"",u=process.env.META_REDIRECT_URI||`${process.env.NEXT_PUBLIC_APP_URL}/api/oauth/meta/callback`,d=process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000";async function p(e){let t=(0,i.t)();try{let a;let r=e.nextUrl.searchParams.get("code"),s=e.nextUrl.searchParams.get("state");if(e.nextUrl.searchParams.get("error")){let t=e.nextUrl.searchParams.get("error_description")||"Autoriza\xe7\xe3o negada";return c.NextResponse.redirect(`${d}/cliente/redes-sociais?error=${encodeURIComponent(t)}`)}if(!r||!s)return c.NextResponse.redirect(`${d}/cliente/redes-sociais?error=Par\xe2metros inv\xe1lidos`);try{a=JSON.parse(Buffer.from(s,"base64url").toString())}catch{return c.NextResponse.redirect(`${d}/cliente/redes-sociais?error=State inv\xe1lido`)}if(Date.now()-a.timestamp>6e5)return c.NextResponse.redirect(`${d}/cliente/redes-sociais?error=Sess\xe3o expirada`);let o=new URL("https://graph.facebook.com/v18.0/oauth/access_token");o.searchParams.set("client_id",l),o.searchParams.set("client_secret",_),o.searchParams.set("redirect_uri",u),o.searchParams.set("code",r);let n=await fetch(o.toString()),i=await n.json();if(!i.access_token)return console.error("Meta token exchange failed:",i),c.NextResponse.redirect(`${d}/cliente/redes-sociais?error=Falha ao obter token`);let p=new URL("https://graph.facebook.com/v18.0/oauth/access_token");p.searchParams.set("grant_type","fb_exchange_token"),p.searchParams.set("client_id",l),p.searchParams.set("client_secret",_),p.searchParams.set("fb_exchange_token",i.access_token);let m=await fetch(p.toString()),h=await m.json(),f=h.access_token||i.access_token,g=h.expires_in||i.expires_in||3600,k=await fetch(`https://graph.facebook.com/v18.0/me/accounts?fields=id,name,access_token,instagram_business_account&access_token=${f}`),P=await k.json(),b=[];for(let e of P.data||[])if(b.push({client_id:a.clientId,platform:"facebook",account_id:e.id,account_name:e.name,access_token:e.access_token,token_expires_at:new Date(Date.now()+1e3*g).toISOString(),is_active:!0,connected_by:a.userId,connected_by_role:a.role}),e.instagram_business_account){let t=await fetch(`https://graph.facebook.com/v18.0/${e.instagram_business_account.id}?fields=id,username,profile_picture_url&access_token=${e.access_token}`),r=await t.json();b.push({client_id:a.clientId,platform:"instagram",account_id:e.instagram_business_account.id,account_name:r.username?`@${r.username}`:e.name,account_avatar:r.profile_picture_url,access_token:e.access_token,token_expires_at:new Date(Date.now()+1e3*g).toISOString(),is_active:!0,connected_by:a.userId,connected_by_role:a.role})}for(let e of b){let{error:r}=await t.from("client_social_connections").upsert(e,{onConflict:"client_id,platform,account_id"});r&&console.error("Error storing connection:",r),await t.from("social_connection_audit").insert({client_id:a.clientId,platform:e.platform,account_id:e.account_id,account_name:e.account_name,action:"connected",performed_by:a.userId,performed_by_role:a.role,metadata:{scopes:["instagram_basic","instagram_content_publish","pages_manage_posts"]}})}let x=b.length;return c.NextResponse.redirect(`${d}/cliente/${a.clientId}/redes-sociais?success=true&connected=${x}`)}catch(e){return console.error("Meta OAuth callback error:",e),c.NextResponse.redirect(`${d}/cliente/redes-sociais?error=${encodeURIComponent(e.message||"Erro desconhecido")}`)}}let m=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/oauth/meta/callback/route",pathname:"/api/oauth/meta/callback",filename:"route",bundlePath:"app/api/oauth/meta/callback/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\oauth\\meta\\callback\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:f,serverHooks:g}=m,k="/api/oauth/meta/callback/route";function P(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},90176:(e,t,a)=>{a.d(t,{t:()=>s});var r=a(54128);function s(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,r.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128],()=>a(63810));module.exports=r})();