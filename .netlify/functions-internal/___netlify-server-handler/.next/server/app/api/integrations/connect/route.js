"use strict";(()=>{var e={};e.id=36039,e.ids=[36039],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},3133:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>k,patchFetch:()=>_,requestAsyncStorage:()=>f,routeModule:()=>h,serverHooks:()=>y,staticGenerationAsyncStorage:()=>v});var a={};t.r(a),t.d(a,{POST:()=>m,dynamic:()=>d});var i=t(49303),o=t(88716),s=t(60670),n=t(87070),c=t(20344),l=t(71615);let d="force-dynamic";function u(e){return String(e||"").trim().replace(/\/+$/,"")}async function p(e){let r=function(e,r){let t=u(e),a=r.startsWith("/")?r:`/${r}`;return t.endsWith("/api")?`${t}${a}`:`${t}/api${a}`}(e.baseUrl,"/auth/login"),t=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e.email,password:e.password})}),a=await t.text();if(!t.ok)throw Error(a||`Falha no login (${t.status})`);let i=null;try{i=a?JSON.parse(a):null}catch{i=null}let o=i?.access_token||i?.accessToken||i?.token||i?.data?.access_token||i?.data?.accessToken||i?.data?.token;if(!o)throw Error("Login OK, mas n\xe3o retornou access_token/token");return String(o)}async function m(e){try{let r=(0,l.cookies)(),t=(0,c.createRouteHandlerClient)({cookies:()=>r}),{data:{user:a},error:i}=await t.auth.getUser();if(i||!a)return n.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:o,error:s}=await t.rpc("is_admin");if(s||!o)return n.NextResponse.json({error:"Acesso negado (admin)"},{status:403});let d=await e.json(),{integrationId:m,apiKey:h,apiSecret:f,accessToken:v,refreshToken:y,webhookSecret:k}=d,_=d.config||{};if(!m)return n.NextResponse.json({error:"ID da integra\xe7\xe3o \xe9 obrigat\xf3rio"},{status:400});let b=await g(m,{apiKey:h,apiSecret:f,accessToken:v},{config:_});if(!b.valid)return await t.from("integration_logs").insert({integration_id:m,action:"connect",status:"error",error_message:b.error,request_data:{hasApiKey:!!h,hasAccessToken:!!v}}),n.NextResponse.json({error:b.error,details:b.details},{status:400});let A=v;if("instagramback"===m){let e=u(_?.baseUrl);if(!e)return n.NextResponse.json({error:"Base URL \xe9 obrigat\xf3ria (config.baseUrl)"},{status:400});if(_.baseUrl=e,!A){let r=String(_?.email||"").trim(),t=String(_?.password||"").trim();if(r&&t)try{A=await p({baseUrl:e,email:r,password:t})}catch(e){return n.NextResponse.json({error:"Falha no login do InstagramBack",details:e?.message||String(e)},{status:400})}}}let x={integration_id:m,..."instagramback"===m?{display_name:"InstagramBack",category:"marketing"}:"whatsapp"===m?{display_name:"WhatsApp Business",category:"communication"}:"perplexity"===m?{display_name:"Perplexity (Sonar)",category:"ai"}:{},api_key:h??null,api_secret:f??null,access_token:A??null,refresh_token:y??null,webhook_secret:k??null,config:_||{},status:"connected",last_sync:new Date().toISOString(),error_message:null,updated_at:new Date().toISOString()},{data:I,error:S}=await t.from("integration_configs").upsert(x,{onConflict:"integration_id"}).select("integration_id, display_name, status, last_sync").single();if(S)return console.error("Erro ao atualizar integra\xe7\xe3o:",S),n.NextResponse.json({error:"Erro ao salvar configura\xe7\xe3o",details:S.message},{status:500});return await t.from("integration_logs").insert({integration_id:m,action:"connect",status:"success",response_data:{connected:!0}}),n.NextResponse.json({success:!0,message:`${I.display_name||m} conectado com sucesso`,integration:{id:I.integration_id,name:I.display_name||m,status:I.status,lastSync:I.last_sync}})}catch(e){return console.error("Erro na conex\xe3o:",e),n.NextResponse.json({error:"Erro interno do servidor",details:e.message},{status:500})}}async function g(e,r,t){let{apiKey:a,apiSecret:i,accessToken:o}=r,s=t?.config||{};switch(e){case"perplexity":if(!a||a.length<16)return{valid:!1,error:"API Key inv\xe1lida",details:'Informe a API Key do Perplexity (geralmente come\xe7a com "pplx-").'};try{let e=await fetch("https://api.perplexity.ai/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({model:String(s?.model||"sonar"),messages:[{role:"user",content:"ping"}],max_tokens:8,temperature:0})});if(!e.ok){let r=await e.text().catch(()=>"");return{valid:!1,error:"API Key inv\xe1lida ou sem permiss\xe3o",details:r.slice(0,200)}}}catch{}break;case"openai":if(!a||!a.startsWith("sk-"))return{valid:!1,error:"API Key inv\xe1lida",details:'A API Key da OpenAI deve come\xe7ar com "sk-"'};try{if(!(await fetch("https://api.openai.com/v1/models",{headers:{Authorization:`Bearer ${a}`}})).ok)return{valid:!1,error:"API Key inv\xe1lida ou sem permiss\xf5es"}}catch{return{valid:!1,error:"N\xe3o foi poss\xedvel validar a API Key"}}break;case"openrouter":if(!a||a.length<10)return{valid:!1,error:"API Key inv\xe1lida",details:"Informe a API Key do OpenRouter"};try{if(!(await fetch("https://openrouter.ai/api/v1/models",{headers:{Authorization:`Bearer ${a}`}})).ok)return{valid:!1,error:"API Key inv\xe1lida ou sem permiss\xf5es"}}catch{}break;case"anthropic":if(!a||a.length<10)return{valid:!1,error:"API Key inv\xe1lida",details:"Informe a API Key da Anthropic (Claude)"};break;case"gemini":if(!a||a.length<10)return{valid:!1,error:"API Key inv\xe1lida",details:"Informe a API Key do Google Gemini/Cloud"};break;case"stripe":if(!a||!a.startsWith("sk_live_")&&!a.startsWith("sk_test_"))return{valid:!1,error:"Secret Key inv\xe1lida",details:'A Secret Key do Stripe deve come\xe7ar com "sk_live_" ou "sk_test_"'};try{if(!(await fetch("https://api.stripe.com/v1/balance",{headers:{Authorization:`Bearer ${a}`}})).ok)return{valid:!1,error:"Secret Key inv\xe1lida ou sem permiss\xf5es"}}catch{return{valid:!1,error:"N\xe3o foi poss\xedvel validar a Secret Key"}}break;case"sendgrid":if(!a||!a.startsWith("SG."))return{valid:!1,error:"API Key inv\xe1lida",details:'A API Key do SendGrid deve come\xe7ar com "SG."'};break;case"whatsapp":{if(!o)return{valid:!1,error:"Access Token \xe9 obrigat\xf3rio"};let e=String(s?.phoneNumberId||"").trim();if(!e)return{valid:!1,error:"Phone Number ID \xe9 obrigat\xf3rio",details:"Preencha config.phoneNumberId"};try{let r=String(o||"").trim(),t=r.toLowerCase().startsWith("bearer ")?r.slice(7).trim():r,a=`https://graph.facebook.com/v20.0/${encodeURIComponent(e)}?fields=verified_name`,i=await fetch(a,{headers:{Authorization:`Bearer ${t}`}});if(!i.ok){let e=await i.text().catch(()=>"");return{valid:!1,error:"Token do WhatsApp inv\xe1lido ou sem permiss\xe3o",details:e.slice(0,200)}}}catch{}}break;case"meta_ads":case"instagram":if(!o)return{valid:!1,error:"Access Token \xe9 obrigat\xf3rio para Meta/Instagram"};break;case"google_ads":case"google_calendar":case"google_meet":if(!o)return{valid:!1,error:"Access Token \xe9 obrigat\xf3rio para servi\xe7os Google"};break;case"slack":if(!o)return{valid:!1,error:"Bot Token \xe9 obrigat\xf3rio"};break;case"instagramback":{let e=String(s?.baseUrl||"").trim(),r=String(s?.email||"").trim(),t=String(s?.password||"").trim();if(!e)return{valid:!1,error:"Base URL \xe9 obrigat\xf3ria",details:"Preencha config.baseUrl"};if(!o&&!(r&&t))return{valid:!1,error:"Informe Access Token ou Email/Senha",details:"Para InstagramBack, voc\xea pode colar o token ou informar email/senha para login autom\xe1tico."}}break;default:if(!a&&!o)return{valid:!1,error:"API Key ou Access Token \xe9 obrigat\xf3rio"}}return{valid:!0}}let h=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/integrations/connect/route",pathname:"/api/integrations/connect",filename:"route",bundlePath:"app/api/integrations/connect/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\integrations\\connect\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:v,serverHooks:y}=h,k="/api/integrations/connect/route";function _(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:v})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[89276,55972,54128,20958],()=>t(3133));module.exports=a})();