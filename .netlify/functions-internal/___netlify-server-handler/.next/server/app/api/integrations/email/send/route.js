"use strict";(()=>{var e={};e.id=298,e.ids=[298],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},65312:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>b,requestAsyncStorage:()=>y,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>x});var r={};a.r(r),a.d(r,{GET:()=>u,POST:()=>p,dynamic:()=>m});var s=a(49303),i=a(88716),o=a(60670),n=a(87070),l=a(20344),c=a(71615),d=a(46882);let m="force-dynamic";async function p(e){try{let t;let a=(0,c.cookies)(),r=(0,l.createRouteHandlerClient)({cookies:()=>a}),{data:{user:s},error:i}=await r.auth.getUser();if(i||!s)return n.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:o,error:m}=await r.from("integration_configs").select("*").eq("integration_id","sendgrid").maybeSingle(),p=process.env.SENDGRID_API_KEY||"",u=(o?.api_key||p||"").trim(),g=o?.status==="connected"&&o?.api_key?"db":p?"env":"mailto";u||(u="mailto",g="mailto");let{type:y,to:x,...f}=await e.json();if(!x)return n.NextResponse.json({error:"Destinat\xe1rio \xe9 obrigat\xf3rio"},{status:400});let h=(0,d.w2)({apiKey:u,fromEmail:o?.config?.fromEmail||process.env.SENDGRID_FROM_EMAIL||"noreply@valle360.com.br",fromName:o?.config?.fromName||process.env.SENDGRID_FROM_NAME||"Valle 360"}),b=Date.now();switch(y){case"welcome":let v=d.qC.welcome(f.name||"Cliente",f.companyName||"Valle 360");t=await h.sendEmail({to:Array.isArray(x)?x.map(e=>({email:e})):{email:x},subject:v.subject,html:v.html});break;case"notification":let j=d.qC.notification(f.title,f.message,f.actionUrl,f.actionText);t=await h.sendEmail({to:Array.isArray(x)?x.map(e=>({email:e})):{email:x},subject:j.subject,html:j.html});break;case"meeting":if(!f.date||!f.time||!f.meetLink)return n.NextResponse.json({error:"Data, hora e link da reuni\xe3o s\xe3o obrigat\xf3rios"},{status:400});let E=d.qC.meetingScheduled(f.clientName||"Cliente",f.date,f.time,f.meetLink,f.description);t=await h.sendEmail({to:Array.isArray(x)?x.map(e=>({email:e})):{email:x},subject:E.subject,html:E.html});break;case"invoice":if(!f.invoiceNumber||!f.amount||!f.dueDate||!f.paymentLink)return n.NextResponse.json({error:"Dados da fatura s\xe3o obrigat\xf3rios"},{status:400});let N=d.qC.invoice(f.clientName||"Cliente",f.invoiceNumber,f.amount,f.dueDate,f.paymentLink);t=await h.sendEmail({to:Array.isArray(x)?x.map(e=>({email:e})):{email:x},subject:N.subject,html:N.html});break;case"custom":if(!f.subject)return n.NextResponse.json({error:"Assunto \xe9 obrigat\xf3rio"},{status:400});if(!f.html&&!f.text)return n.NextResponse.json({error:"Conte\xfado (html ou text) \xe9 obrigat\xf3rio"},{status:400});t=await h.sendEmail({to:Array.isArray(x)?x.map(e=>({email:e})):{email:x},subject:f.subject,html:f.html,text:f.text,templateId:f.templateId,dynamicTemplateData:f.templateData,cc:f.cc?.map(e=>({email:e})),bcc:f.bcc?.map(e=>({email:e})),replyTo:f.replyTo?{email:f.replyTo}:void 0,categories:f.categories});break;case"bulk":if(!f.recipients||!Array.isArray(f.recipients))return n.NextResponse.json({error:"Lista de destinat\xe1rios \xe9 obrigat\xf3ria"},{status:400});t=await h.sendBulkEmail(f.recipients,{subject:f.subject,html:f.html,text:f.text,templateId:f.templateId});break;default:return n.NextResponse.json({error:"Tipo de email inv\xe1lido"},{status:400})}let w=Date.now()-b,k="error"in t?t.error:"errors"in t?t.errors.join(", "):void 0,A="boolean"==typeof t.success?t.success:0===t.failed;if(await r.from("integration_logs").insert({integration_id:"sendgrid",action:`send_${y}`,status:A?"success":"error",request_data:{type:y,to:Array.isArray(x)?x.length:1},error_message:k,duration_ms:w,response_data:{connectedVia:g}}),!A)return n.NextResponse.json({error:"Erro ao preparar email",details:k},{status:500});return n.NextResponse.json({success:!0,message:"Email pronto via mailto",mailtoUrl:t.mailtoUrl,..."bulk"===y&&{sent:t.success,failed:t.failed}})}catch(e){return console.error("Erro ao enviar email:",e),n.NextResponse.json({error:"Erro ao enviar email",details:e.message},{status:500})}}async function u(e){try{let e=(0,c.cookies)(),t=(0,l.createRouteHandlerClient)({cookies:()=>e}),{data:{user:a},error:r}=await t.auth.getUser();if(r||!a)return n.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:s}=await t.from("integration_configs").select("*").eq("integration_id","sendgrid").maybeSingle(),i=process.env.SENDGRID_API_KEY||"",o=(s?.api_key||i||"").trim(),m=o?await (0,d.w2)({apiKey:o,fromEmail:s?.config?.fromEmail||process.env.SENDGRID_FROM_EMAIL||"noreply@valle360.com.br"}).listTemplates():{templates:[]};return n.NextResponse.json({success:!0,predefined:[{id:"welcome",name:"Boas-vindas",type:"predefined"},{id:"notification",name:"Notifica\xe7\xe3o",type:"predefined"},{id:"meeting",name:"Reuni\xe3o Agendada",type:"predefined"},{id:"invoice",name:"Fatura",type:"predefined"}],sendgrid:m.templates||[]})}catch(e){return console.error("Erro ao listar templates:",e),n.NextResponse.json({error:"Erro ao listar templates",details:e.message},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/integrations/email/send/route",pathname:"/api/integrations/email/send",filename:"route",bundlePath:"app/api/integrations/email/send/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\integrations\\email\\send\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:y,staticGenerationAsyncStorage:x,serverHooks:f}=g,h="/api/integrations/email/send/route";function b(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:x})}},46882:(e,t,a)=>{a.d(t,{Rp:()=>r,qC:()=>i,w2:()=>s});class r{constructor(e){this.apiKey=e.apiKey,this.fromEmail=e.fromEmail,this.fromName=e.fromName}async request(e,t={}){let a=await fetch(`https://api.sendgrid.com/v3${e}`,{...t,headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json",...t.headers}});if(202===a.status||200===a.status||201===a.status){let e=await a.text();return e?JSON.parse(e):{success:!0}}let r=await a.json();throw Error(r.errors?.[0]?.message||"Erro na API SendGrid")}async sendEmail(e){let t=Array.isArray(e.to)?e.to:[e.to],a=t[0]?.email||"",r=e.subject||"",s=(e.text||e.html||"").replace(/<[^>]+>/g,"").trim();return{success:!0,mailtoUrl:`mailto:${a}?subject=${encodeURIComponent(r)}&body=${encodeURIComponent(s)}`}}async sendBulkEmail(e,t){return{success:0,failed:e.length,errors:["Envio em lote n\xe3o suportado via mailto. Use envio manual."]}}async listTemplates(){return this.request("/templates?generations=dynamic")}async getTemplate(e){return this.request(`/templates/${e}`)}async getStats(e,t){let a=`/stats?start_date=${e}`;return t&&(a+=`&end_date=${t}`),this.request(a)}async getCategoryStats(e,t,a){let r=`/categories/${e}/stats?start_date=${t}`;return a&&(r+=`&end_date=${a}`),this.request(r)}async addContact(e,t){let a={email:e};t?.firstName&&(a.first_name=t.firstName),t?.lastName&&(a.last_name=t.lastName),t?.customFields&&(a.custom_fields=t.customFields);let r={contacts:[a]};return t?.listIds&&(r.list_ids=t.listIds),this.request("/marketing/contacts",{method:"PUT",body:JSON.stringify(r)})}async searchContacts(e){return this.request("/marketing/contacts/search",{method:"POST",body:JSON.stringify({query:e})})}async deleteContact(e){return this.request(`/marketing/contacts?ids=${e}`,{method:"DELETE"})}async getLists(){return this.request("/marketing/lists")}async createList(e){return this.request("/marketing/lists",{method:"POST",body:JSON.stringify({name:e})})}async addToSuppressionList(e,t){let a="unsubscribes"===t?"/asm/suppressions/global":`/suppression/${t}`;await this.request(a,{method:"POST",body:JSON.stringify({recipient_emails:e})})}async getSuppressionList(e){let t="unsubscribes"===e?"/asm/suppressions/global":`/suppression/${e}`;return this.request(t)}}function s(e){return new r(e)}let i={welcome:(e,t)=>({subject:`Bem-vindo \xe0 ${t}! ðŸŽ‰`,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h1 style="color: #4370d1;">Ol\xe1, ${e}!</h1>
        <p>Seja muito bem-vindo(a) \xe0 ${t}!</p>
        <p>Estamos muito felizes em ter voc\xea conosco. A partir de agora, voc\xea ter\xe1 acesso a todas as nossas ferramentas e recursos.</p>
        <p>Se precisar de ajuda, n\xe3o hesite em entrar em contato.</p>
        <p>Abra\xe7os,<br/>Equipe ${t}</p>
      </div>
    `}),notification:(e,t,a,r)=>({subject:e,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2 style="color: #333;">${e}</h2>
        <p>${t}</p>
        ${a?`
          <p style="margin-top: 20px;">
            <a href="${a}" style="background-color: #4370d1; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
              ${r||"Ver mais"}
            </a>
          </p>
        `:""}
      </div>
    `}),meetingScheduled:(e,t,a,r,s)=>({subject:`Reuni\xe3o Agendada - ${t} \xe0s ${a}`,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2 style="color: #4370d1;">Reuni\xe3o Confirmada! ðŸ“…</h2>
        <p>Ol\xe1 ${e},</p>
        <p>Sua reuni\xe3o foi agendada com sucesso.</p>
        <div style="background-color: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
          <p><strong>Data:</strong> ${t}</p>
          <p><strong>Hor\xe1rio:</strong> ${a}</p>
          ${s?`<p><strong>Descri\xe7\xe3o:</strong> ${s}</p>`:""}
        </div>
        <p>
          <a href="${r}" style="background-color: #4370d1; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
            Entrar na Reuni\xe3o
          </a>
        </p>
        <p style="color: #666; font-size: 12px; margin-top: 20px;">
          Adicione este evento ao seu calend\xe1rio para n\xe3o esquecer!
        </p>
      </div>
    `}),invoice:(e,t,a,r,s)=>({subject:`Fatura #${t} - Pagamento Pendente`,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2 style="color: #333;">Fatura #${t}</h2>
        <p>Ol\xe1 ${e},</p>
        <p>Segue sua fatura para pagamento:</p>
        <div style="background-color: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
          <p><strong>Valor:</strong> ${a}</p>
          <p><strong>Vencimento:</strong> ${r}</p>
        </div>
        <p>
          <a href="${s}" style="background-color: #22c55e; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
            Pagar Agora
          </a>
        </p>
      </div>
    `})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>a(65312));module.exports=r})();