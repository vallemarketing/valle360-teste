"use strict";(()=>{var e={};e.id=51367,e.ids=[51367],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},12960:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>v,requestAsyncStorage:()=>l,routeModule:()=>d,serverHooks:()=>p,staticGenerationAsyncStorage:()=>g});var n={};r.r(n),r.d(n,{GET:()=>u});var o=r(49303),i=r(88716),a=r(60670),s=r(87070);let c=(0,r(54128).eI)("https://ikjgsqtykkhqimypacro.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function u(e){try{if(e.headers.get("authorization")!==`Bearer ${process.env.CRON_SECRET}`&&process.env.CRON_SECRET)return s.NextResponse.json({error:"Unauthorized"},{status:401});let t=new Date,r=t.getDate();console.log(`[CRON] Running recurring invoices for day ${r}`);let{data:n,error:o}=await c.from("recurring_invoice_schedules").select("*, contracts(client_id, client_company, services, status)").eq("is_active",!0).eq("day_of_month",r).lte("next_run",t.toISOString());if(o)return console.error("Error fetching schedules:",o),s.NextResponse.json({error:"Failed to fetch schedules"},{status:500});if(!n||0===n.length)return console.log("[CRON] No recurring invoices to generate today"),s.NextResponse.json({message:"No invoices to generate",count:0});let i=0,a=0;for(let e of n)try{if(e.contracts?.status!=="active"||e.end_date&&new Date(e.end_date)<t){await c.from("recurring_invoice_schedules").update({is_active:!1}).eq("id",e.id);continue}let r=new Date(t);r.setDate(e.day_of_month),r<t&&r.setMonth(r.getMonth()+1);let{data:n,error:o}=await c.from("invoices").insert({contract_id:e.contract_id,client_id:e.client_id,amount:e.amount,due_date:r.toISOString(),status:"pending",description:`Mensalidade - ${e.contracts?.services?.[0]?.name||"Servi\xe7os contratados"}`,reference_month:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`,auto_generated:!0,created_at:new Date().toISOString()}).select().single();if(o){console.error(`Failed to create invoice for schedule ${e.id}:`,o),a++;continue}let s=new Date(r);s.setMonth(s.getMonth()+1),await c.from("recurring_invoice_schedules").update({last_run:new Date().toISOString(),next_run:s.toISOString()}).eq("id",e.id);try{await c.from("notifications").insert({user_id:e.client_id,type:"invoice_generated",title:"Nova fatura dispon\xedvel",message:`Sua fatura de R$ ${e.amount.toLocaleString("pt-BR")} vence em ${r.toLocaleDateString("pt-BR")}`,link:"/cliente/financeiro",is_read:!1,created_at:new Date().toISOString()})}catch{}console.log(`[INVOICE] Created ${n.id} for client ${e.client_id}`),i++}catch(t){console.error(`Error processing schedule ${e.id}:`,t),a++}try{await c.from("cron_logs").insert({job_name:"recurring_invoices",run_at:new Date().toISOString(),status:0===a?"success":"partial",result:{generated:i,failed:a,total:n.length}})}catch{}return console.log(`[CRON] Completed: ${i} invoices generated, ${a} failed`),s.NextResponse.json({success:!0,generated:i,failed:a,total:n.length})}catch(e){return console.error("[CRON] Recurring invoices error:",e),s.NextResponse.json({error:e.message||"Cron job failed"},{status:500})}}let d=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/cron/recurring-invoices/route",pathname:"/api/cron/recurring-invoices",filename:"route",bundlePath:"app/api/cron/recurring-invoices/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\cron\\recurring-invoices\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:l,staticGenerationAsyncStorage:g,serverHooks:p}=d,_="/api/cron/recurring-invoices/route";function v(){return(0,a.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:g})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[89276,55972,54128],()=>r(12960));module.exports=n})();