"use strict";exports.id=96181,exports.ids=[96181],exports.modules={96181:(e,t,n)=>{n.d(t,{cv:()=>d,dH:()=>m,dT:()=>l,nJ:()=>c});var a=n(90176),i=n(30233),o=n(61894);function s(){return(0,a.t)()}let r={enabled:!0,provider:"auto",alert_on_negative:!0,alert_threshold:-.25,alert_channels:["in_app"]};async function c(e,t,n,a={}){let c=Date.now();try{let l;let m=a.clientId?await p(a.clientId):r;if(!m.enabled)return console.log("An\xe1lise de sentimento desabilitada para este cliente"),null;let d=a.provider||m.provider;if("google"===d||"auto"===d){let e=await o.su.analyzeFullText(n,{language:"pt-BR",includeClassification:!1});l={provider:"google",overall:e.summary.overallSentiment,score:e.sentiment.documentSentiment.score,confidence:Math.min(e.sentiment.documentSentiment.magnitude/2,1),details:{magnitude:e.sentiment.documentSentiment.magnitude,sentences:e.sentiment.sentences.map(e=>({text:e.text,score:e.sentiment.score}))},processingTime:Date.now()-c,language:"pt-BR"},e.entities.entities.length>0&&(l.entities=e.summary.mainEntities)}else l=await (0,i.iF)({text:n,provider:d,language:"pt-BR"});let g={source_type:e,source_id:t,source_table:a.sourceTable,content:n,content_preview:n.substring(0,200),provider:l.provider,overall_sentiment:l.overall,score:l.score,magnitude:l.details?.magnitude,confidence:l.confidence,emotions:l.details?.emotions,entities:l.entities,keywords:l.details?.keywords,summary:l.summary,client_id:a.clientId,user_id:a.userId,content_created_at:a.contentCreatedAt?.toISOString(),processing_time_ms:Date.now()-c,alert_generated:!1},{data:y,error:f}=await s().from("sentiment_analyses").insert(g).select().single();if(f)throw console.error("Erro ao salvar an\xe1lise:",f),f;return m.alert_on_negative&&l.score<m.alert_threshold&&await u(y,m),await _(e,l.overall,a.clientId),y}catch(e){return console.error("Erro na an\xe1lise autom\xe1tica de sentimento:",e),t&&await s().from("sentiment_processing_queue").update({status:"failed",last_error:e.message}).eq("source_id",t),null}}async function l(e,t,n,a={}){try{let{data:i,error:o}=await s().rpc("add_to_sentiment_queue",{p_source_type:e,p_source_id:t,p_source_table:a.sourceTable,p_content:n,p_client_id:a.clientId,p_user_id:a.userId,p_priority:a.priority||0,p_metadata:a.metadata});if(o)throw o;return i}catch(e){return console.error("Erro ao adicionar \xe0 fila:",e),null}}async function m(){try{let{data:e,error:t}=await s().rpc("get_next_sentiment_queue_item");if(t||!e||0===e.length)return null;let n=e[0],a=await c(n.source_type,n.source_id,n.content,{clientId:n.client_id,userId:n.user_id,sourceTable:n.source_table});return await s().from("sentiment_processing_queue").update({status:a?"completed":"failed",completed_at:new Date().toISOString(),result_id:a?.id}).eq("id",n.id),a}catch(e){return console.error("Erro ao processar fila:",e),null}}async function d(e=100){let t=0,n=0,a=0;for(;t<e;){let e=await m();if(null===e)break;t++,e?n++:a++,await new Promise(e=>setTimeout(e,100))}return{processed:t,successful:n,failed:a}}async function u(e,t){try{let n,a;n=e.score<-.7?"critical":e.score<-.5?"high":e.score<-.3?"medium":"low";let i="negative_feedback";"nps_response"===e.source_type?i="nps_detractor":"message"===e.source_type?i="negative_message":"support_ticket"===e.source_type&&(i="urgent_ticket");let o=`⚠️ ${{message:"Mensagem",nps_response:"Resposta NPS",task_comment:"Coment\xe1rio de Tarefa",feedback:"Feedback",review:"Review",support_ticket:"Ticket de Suporte",email:"Email"}[e.source_type]||"Conte\xfado"} com sentimento negativo detectado`;if(e.client_id){let{data:t}=await s().from("clients").select("company_name, name").eq("id",e.client_id).maybeSingle();a=t?.company_name||t?.name||void 0}let r={sentiment_analysis_id:e.id,alert_type:i,severity:n,title:o,description:`Score de sentimento: ${e.score.toFixed(2)}. Conte\xfado: "${e.content_preview}..."`,client_id:e.client_id,client_name:a,source_type:e.source_type,source_content_preview:e.content_preview,suggested_action:{message:"Entre em contato com o cliente para entender a insatisfa\xe7\xe3o",nps_response:"Agende uma liga\xe7\xe3o para recuperar este detrator",task_comment:"Verifique se h\xe1 problemas na execu\xe7\xe3o do projeto",feedback:"Analise o feedback e crie plano de a\xe7\xe3o",review:"Responda ao review e ofere\xe7a solu\xe7\xe3o",support_ticket:"Priorize a resolu\xe7\xe3o deste ticket",email:"Responda o email com prioridade"}[e.source_type]||"Analise o conte\xfado e tome a\xe7\xe3o apropriada",notification_channels:t.alert_channels},{data:c,error:l}=await s().from("sentiment_alerts").insert(r).select().single();if(l)throw l;await s().from("sentiment_analyses").update({alert_generated:!0,alert_id:c.id}).eq("id",e.id)}catch(e){console.error("Erro ao gerar alerta:",e)}}async function p(e){try{let{data:t,error:n}=await s().from("sentiment_automation_config").select("*").eq("client_id",e).single();if(n||!t)return r;return{enabled:t.enabled,provider:t.provider,alert_on_negative:t.alert_on_negative,alert_threshold:t.alert_threshold,alert_channels:t.alert_channels}}catch{return r}}async function _(e,t,n){let a=new Date().toISOString().split("T")[0];try{let{data:i}=await s().from("sentiment_daily_stats").select("id").eq("date",a).eq("client_id",n||null).single(),o=`${t}_count`,r=`${"message"===e?"messages":"nps_response"===e?"nps":"task_comment"===e?"tasks":"reviews"}_count`;i?await s().rpc("increment_sentiment_stat",{p_stat_id:i.id,p_sentiment_field:o,p_source_field:r}):await s().from("sentiment_daily_stats").insert({date:a,client_id:n,total_analyses:1,positive_count:"positive"===t?1:0,neutral_count:"neutral"===t?1:0,negative_count:"negative"===t?1:0,messages_count:"message"===e?1:0,nps_count:"nps_response"===e?1:0,tasks_count:"task_comment"===e?1:0,reviews_count:"review"===e?1:0})}catch(e){console.error("Erro ao atualizar estat\xedsticas:",e)}}},61894:(e,t,n)=>{n.d(t,{su:()=>d});let a="https://language.googleapis.com";function i(){let e=process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY||process.env.GOOGLE_NLP_API_KEY;if(!e)throw Error("Google Cloud API Key n\xe3o configurada. Configure GOOGLE_GEMINI_API_KEY ou GOOGLE_CLOUD_API_KEY.");return e}async function o(e,t="pt-BR"){let n=i(),o=await fetch(`${a}/v2/documents:analyzeSentiment?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({document:{type:"PLAIN_TEXT",content:e,languageCode:t},encodingType:"UTF8"})});if(!o.ok){let e=await o.json();throw Error(`Google NLP Error: ${e.error?.message||o.statusText}`)}let s=await o.json();return{documentSentiment:{score:s.documentSentiment?.score||0,magnitude:s.documentSentiment?.magnitude||0},sentences:(s.sentences||[]).map(e=>({text:e.text?.content||"",sentiment:{score:e.sentiment?.score||0,magnitude:e.sentiment?.magnitude||0}})),language:s.languageCode||t}}async function s(e,t="pt-BR"){let n=i(),o=await fetch(`${a}/v1/documents:analyzeEntitySentiment?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({document:{type:"PLAIN_TEXT",content:e,language:t.split("-")[0]},encodingType:"UTF8"})});if(!o.ok){let e=await o.json();throw Error(`Google NLP Error: ${e.error?.message||o.statusText}`)}let s=await o.json();return{entities:(s.entities||[]).map(e=>({name:e.name,type:e.type||"UNKNOWN",salience:e.salience||0,metadata:e.metadata||{},mentions:(e.mentions||[]).map(t=>({text:t.text?.content||e.name,type:t.type||"TYPE_UNKNOWN",probability:1})),sentiment:{score:e.sentiment?.score||0,magnitude:e.sentiment?.magnitude||0}})),language:s.language||t}}async function r(e,t="pt-BR"){let n=i(),o=await fetch(`${a}/v1/documents:analyzeSyntax?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({document:{type:"PLAIN_TEXT",content:e,language:t.split("-")[0]},encodingType:"UTF8"})});if(!o.ok){let e=await o.json();throw Error(`Google NLP Error: ${e.error?.message||o.statusText}`)}let s=await o.json();return{tokens:(s.tokens||[]).map(e=>({text:e.text?.content||"",partOfSpeech:{tag:e.partOfSpeech?.tag||"UNKNOWN",voice:e.partOfSpeech?.voice||"VOICE_UNKNOWN",tense:e.partOfSpeech?.tense||"TENSE_UNKNOWN",mood:e.partOfSpeech?.mood||"",person:e.partOfSpeech?.person||"",number:e.partOfSpeech?.number||""},lemma:e.lemma||"",dependencyEdge:{headTokenIndex:e.dependencyEdge?.headTokenIndex||0,label:e.dependencyEdge?.label||""}})),sentences:(s.sentences||[]).map(e=>({text:e.text?.content||""})),language:s.language||t}}async function c(e,t="pt-BR"){let n=i();if(e.split(/\s+/).length<20)throw Error("Classifica\xe7\xe3o de texto requer pelo menos 20 palavras.");let o=await fetch(`${a}/v1/documents:classifyText?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({document:{type:"PLAIN_TEXT",content:e,language:t.split("-")[0]},classificationModelOptions:{v2Model:{contentCategoriesVersion:"V2"}}})});if(!o.ok){let e=await o.json();throw Error(`Google NLP Error: ${e.error?.message||o.statusText}`)}return{categories:((await o.json()).categories||[]).map(e=>({name:e.name,confidence:e.confidence||0})),language:t}}async function l(e,t={}){let n,a,i;let l=t.language||"pt-BR",[m,d]=await Promise.all([o(e,l),s(e,l)]);if(t.includeSyntax)try{n=await r(e,l)}catch(e){console.warn("Erro na an\xe1lise de sintaxe:",e)}if(t.includeClassification&&e.split(/\s+/).length>=20)try{a=await c(e,l)}catch(e){console.warn("Erro na classifica\xe7\xe3o:",e)}let u=m.documentSentiment.score;i=u>.25?"positive":u<-.25?"negative":"neutral";let p=d.entities.filter(e=>e.salience>.1).slice(0,5).map(e=>{let t;return t=e.sentiment?e.sentiment.score>.25?"positive":e.sentiment.score<-.25?"negative":"neutral":"unknown",{name:e.name,type:e.type,sentiment:t}}),_=a?.categories.filter(e=>e.confidence>.5).map(e=>e.name.split("/").pop()||e.name)||[],g=[];"positive"===i?g.push("O texto expressa sentimento predominantemente positivo"):"negative"===i&&g.push("O texto expressa sentimento predominantemente negativo - requer aten\xe7\xe3o");let y=p.filter(e=>"positive"===e.sentiment),f=p.filter(e=>"negative"===e.sentiment);return y.length>0&&g.push(`Men\xe7\xf5es positivas: ${y.map(e=>e.name).join(", ")}`),f.length>0&&g.push(`Men\xe7\xf5es negativas: ${f.map(e=>e.name).join(", ")}`),{sentiment:m,entities:d,syntax:n,classification:a,summary:{overallSentiment:i,mainEntities:p,topics:_,keyInsights:g}}}async function m(e,t="pt-BR"){let n;let a=[];for(let n=0;n<e.length;n+=5){let i=e.slice(n,n+5),r=await Promise.all(i.map(async e=>{let[n,a]=await Promise.all([o(e,t),s(e,t)]);return{text:e,sentiment:n,entities:a.entities}}));a.push(...r)}let i=a.map(e=>e.sentiment.documentSentiment.score),r=i.reduce((e,t)=>e+t,0)/i.length;n=r>.25?"positive":r<-.25?"negative":"neutral";let c=new Map;return a.forEach(e=>{e.entities.forEach(e=>{let t=e.name.toLowerCase(),n=c.get(t)||{count:0,totalSentiment:0};c.set(t,{count:n.count+1,totalSentiment:n.totalSentiment+(e.sentiment?.score||0)})})}),{results:a,aggregate:{averageScore:r,overallSentiment:n,topEntities:Array.from(c.entries()).map(([e,t])=>({name:e,count:t.count,avgSentiment:t.totalSentiment/t.count})).sort((e,t)=>t.count-e.count).slice(0,10)}}}let d={analyzeSentiment:o,analyzeEntities:async function(e,t="pt-BR"){let n=i(),o=await fetch(`${a}/v2/documents:analyzeEntities?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({document:{type:"PLAIN_TEXT",content:e,languageCode:t},encodingType:"UTF8"})});if(!o.ok){let e=await o.json();throw Error(`Google NLP Error: ${e.error?.message||o.statusText}`)}let s=await o.json();return{entities:(s.entities||[]).map(e=>({name:e.name,type:e.type||"UNKNOWN",salience:e.salience||0,metadata:e.metadata||{},mentions:(e.mentions||[]).map(t=>({text:t.text?.content||e.name,type:t.type||"TYPE_UNKNOWN",probability:t.probability||0})),sentiment:e.sentiment?{score:e.sentiment.score,magnitude:e.sentiment.magnitude}:void 0})),language:s.languageCode||t}},analyzeEntitySentiment:s,analyzeSyntax:r,classifyText:c,analyzeFullText:l,analyzeBatch:m}}};