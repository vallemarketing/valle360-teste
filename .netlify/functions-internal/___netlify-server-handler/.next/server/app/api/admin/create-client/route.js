"use strict";(()=>{var e={};e.id=44462,e.ids=[44462],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},9071:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>x,requestAsyncStorage:()=>f,routeModule:()=>y,serverHooks:()=>w,staticGenerationAsyncStorage:()=>v});var r={};a.r(r),a.d(r,{POST:()=>g,dynamic:()=>_});var n=a(49303),i=a(88716),o=a(60670),s=a(87070),c=a(20344),l=a(71615),d=a(90176),u=a(30920),p=a(49805),m=a(29601);let _="force-dynamic";async function g(e){let t=(0,l.cookies)(),a=(0,c.createRouteHandlerClient)({cookies:()=>t}),{data:r}=await a.auth.getUser(),n=r.user?.id;if(!n)return s.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:i,error:o}=await a.rpc("is_admin");if(o||!i)return s.NextResponse.json({error:"Acesso negado (admin)"},{status:403});try{let{email:t,password:a,full_name:r,phone:i,company_name:o,nome_fantasia:c,razao_social:l,tipo_pessoa:_,cpf_cnpj:g,industry:y,segment:f,website:v,whatsapp:w,address:h,competitors:x,concorrentes:S,monthly_value:b,plan_id:j,services:R,servicos_contratados:O,due_day:A,dia_vencimento:N,start_date:F,data_inicio:q}=await e.json()||{};if(!t||!a)return s.NextResponse.json({error:"email e password s\xe3o obrigat\xf3rios"},{status:400});let I=(0,d.t)(),{data:k,error:D}=await I.auth.admin.createUser({email:t,password:a,email_confirm:!0,user_metadata:{full_name:r||o||c||l||t,user_type:"client"}});if(D||!k.user)return s.NextResponse.json({error:D?.message||"Falha ao criar usu\xe1rio"},{status:500});let C=k.user.id;await I.from("users").upsert({id:C,email:t,full_name:r||o||c||l||t,name:r||o||c||l||t,phone:i||w||null,user_type:"client",account_status:"active",created_by:n,created_at:new Date().toISOString()}),await I.from("user_profiles").upsert({id:C,user_id:C,email:t,full_name:r||o||c||l||t,user_type:"client",role:"client",is_active:!0,metadata:{plan_id:j||null}});let{data:P,error:M}=await I.from("clients").insert({user_id:C,company_name:o||c||l||r||t,contact_name:r||o||c||l||t,contact_email:t,contact_phone:i||w||null,industry:y||null,website:v||null,address:h||null,status:"active",monthly_value:"number"==typeof b?b:0,email:t,whatsapp:w||i||null,nome_fantasia:c||null,razao_social:l||null,tipo_pessoa:_||null,cpf_cnpj:g||null,plan_id:j||null,created_at:new Date().toISOString()}).select("*").single();if(M)return s.NextResponse.json({error:M.message||"Falha ao criar cliente"},{status:500});try{let e={};if(f&&(e.segment=String(f)),Array.isArray(x)&&(e.competitors=x.map(e=>String(e)).filter(Boolean)),"string"==typeof S&&S.trim()&&(e.concorrentes=S.trim()),Object.keys(e).length>0){let t=await I.from("clients").update(e).eq("id",P.id);if(t.error&&!String(t.error?.message||"").toLowerCase().includes("column"))throw t.error}}catch(e){console.warn("Aviso: n\xe3o foi poss\xedvel salvar segment/competitors no clients:",e)}let T=Array.isArray(R)?R:Array.isArray(O)?O:[],U="string"==typeof F?F:"string"==typeof q&&q?q:new Date().toISOString().slice(0,10);if(j||T&&T.length>0){let{data:e,error:t}=await I.from("contracts").insert({client_id:P.id,plan_id:j||null,services:T,monthly_value:"number"==typeof b?b:0,due_day:"number"==typeof A?A:"number"==typeof N?N:null,start_date:U,status:"active",active:!0,created_by:n,created_at:new Date().toISOString()}).select("id, client_id, monthly_value, due_day, start_date").single();if(t)return s.NextResponse.json({error:t.message||"Falha ao criar contrato"},{status:500});let a=new Date,r=a.toISOString().slice(0,10),i=Number(e?.due_day||5),o=new Date(a.getFullYear(),a.getMonth(),i).toISOString().slice(0,10),c=`INV-${a.getFullYear()}${String(a.getMonth()+1).padStart(2,"0")}-${String(Math.floor(9e3*Math.random())+1e3)}`,{data:l,error:d}=await I.from("invoices").insert({contract_id:e.id,client_id:e.client_id,invoice_number:c,amount:e.monthly_value||0,issue_date:r,due_date:o,status:"pending",notes:"Fatura inicial gerada automaticamente no cadastro do cliente.",created_at:new Date().toISOString()}).select("id").single();if(d)return s.NextResponse.json({error:d.message||"Falha ao criar fatura"},{status:500});await I.from("financial_transactions").insert({transaction_type:"income",category:"subscription",amount:e.monthly_value||0,description:"Receita prevista - contrato ativo (cadastro do cliente)",transaction_date:r,invoice_id:l.id,client_id:e.client_id,payment_method:null,reference_number:c,status:"pending",created_by:n,created_at:new Date().toISOString()}),await I.from("workflow_transitions").insert([{from_area:"Contratos",to_area:"Financeiro",status:"pending",trigger_event:"contract.created",data_payload:{contract_id:e.id,invoice_id:l.id,client_id:e.client_id},created_by:n},{from_area:"Financeiro",to_area:"Operacao",status:"pending",trigger_event:"invoice.created",data_payload:{contract_id:e.id,invoice_id:l.id,client_id:e.client_id},created_by:n}]),await (0,m._)(I,{title:"Cliente com contrato ativo",message:`Contrato e fatura inicial criados automaticamente para ${P.company_name||P.email}.`,type:"system",metadata:{client_id:e.client_id,contract_id:e.id,invoice_id:l.id},is_read:!1})}let $=await (0,u.Kn)({eventType:"client.created",entityType:"client",entityId:P.id,actorUserId:n,payload:{client_id:P.id,user_id:C,email:t}}),z=await (0,p.Z)($);return z.ok?await (0,u.ls)($.id):await (0,u.bT)($.id,z.error),s.NextResponse.json({success:!0,client:P,user_id:C,event_status:z.ok?"processed":"error"})}catch(e){return s.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let y=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/create-client/route",pathname:"/api/admin/create-client",filename:"route",bundlePath:"app/api/admin/create-client/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\create-client\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:v,serverHooks:w}=y,h="/api/admin/create-client/route";function x(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:v})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958,40074,38823],()=>a(9071));module.exports=r})();