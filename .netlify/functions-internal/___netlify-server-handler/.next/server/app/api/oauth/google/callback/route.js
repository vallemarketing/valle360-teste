"use strict";(()=>{var e={};e.id=29157,e.ids=[29157],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},90481:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>f,requestAsyncStorage:()=>m,routeModule:()=>_,serverHooks:()=>x,staticGenerationAsyncStorage:()=>h});var o={};r.r(o),r.d(o,{GET:()=>g});var a=r(49303),n=r(88716),s=r(60670),i=r(87070),c=r(20344),l=r(71615);let u=process.env.GOOGLE_CLIENT_ID||"",p=process.env.GOOGLE_CLIENT_SECRET||"",d=process.env.GOOGLE_REDIRECT_URI||`${process.env.NEXT_PUBLIC_APP_URL}/api/oauth/google/callback`;async function g(e){try{let t;let r=(0,c.createRouteHandlerClient)({cookies:l.cookies}),o=e.nextUrl.searchParams,a=o.get("code"),n=o.get("state"),s=o.get("error");if(s)return console.error("Google OAuth error:",s),i.NextResponse.redirect(new URL(`/error?message=${s}`,e.url));if(!a||!n)return i.NextResponse.redirect(new URL("/error?message=missing_params",e.url));try{t=JSON.parse(Buffer.from(n,"base64url").toString())}catch{return i.NextResponse.redirect(new URL("/error?message=invalid_state",e.url))}let g=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:u,client_secret:p,code:a,grant_type:"authorization_code",redirect_uri:d})}),_=await g.json();if(!_.access_token)return console.error("Failed to get Google tokens:",_),i.NextResponse.redirect(new URL("/error?message=token_error",e.url));let m=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${_.access_token}`}}),h=await m.json(),x={user_id:t.userId,client_id:t.clientId||null,platform:"google_drive",account_id:h.id,account_name:h.email,account_avatar:h.picture,access_token_encrypted:_.access_token,refresh_token_encrypted:_.refresh_token,token_expires_at:new Date(Date.now()+1e3*_.expires_in).toISOString(),scopes:_.scope?.split(" ")||[],connected_at:new Date().toISOString(),connected_by:t.userId,is_active:!0},{error:w}=await r.from("user_integrations").upsert(x,{onConflict:"user_id,platform"});w&&(console.error("Failed to save Google connection:",w),await r.from("integrations").upsert({user_id:t.userId,type:"google_drive",config:{access_token:_.access_token,refresh_token:_.refresh_token,expires_at:new Date(Date.now()+1e3*_.expires_in).toISOString(),email:h.email},is_active:!0,updated_at:new Date().toISOString()},{onConflict:"user_id,type"}));try{await r.from("audit_logs").insert({user_id:t.userId,action:"integration_connected",resource_type:"google_drive",metadata:{email:h.email,client_id:t.clientId},created_at:new Date().toISOString()})}catch{}let f=new URL(t.redirect,e.url);return f.searchParams.set("success","google_connected"),i.NextResponse.redirect(f)}catch(t){return console.error("Google OAuth callback error:",t),i.NextResponse.redirect(new URL("/error?message=callback_error",e.url))}}let _=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/oauth/google/callback/route",pathname:"/api/oauth/google/callback",filename:"route",bundlePath:"app/api/oauth/google/callback/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\oauth\\google\\callback\\route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:x}=_,w="/api/oauth/google/callback/route";function f(){return(0,s.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:h})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[89276,55972,54128,20958],()=>r(90481));module.exports=o})();