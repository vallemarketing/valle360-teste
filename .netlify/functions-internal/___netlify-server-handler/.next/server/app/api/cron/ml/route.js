"use strict";(()=>{var e={};e.id=37,e.ids=[37],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},24276:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>S,patchFetch:()=>k,requestAsyncStorage:()=>w,routeModule:()=>y,serverHooks:()=>b,staticGenerationAsyncStorage:()=>v});var r={};a.r(r),a.d(r,{GET:()=>_,POST:()=>f,dynamic:()=>g});var i=a(49303),n=a(88716),s=a(60670),o=a(87070),c=a(90176),l=a(79263),d=a(32120),u=a(87881),m=a(17478);let g="force-dynamic";function h(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}async function p(){let e=(0,c.t)(),t=new Date().toISOString(),a=new Date;a.setHours(0,0,0,0);let r=a.toISOString();async function i(t){try{let{data:a}=await e.from("super_admin_insights").select("id").eq("insight_title",t.insight_title).gte("created_at",r).limit(1);if(a&&a.length>0)return;await e.from("super_admin_insights").insert({insight_category:t.insight_category,insight_priority:t.insight_priority,insight_title:t.insight_title,insight_description:t.insight_description,affected_area:t.affected_area||null,confidence_score:t.confidence_score??70,urgency_score:t.urgency_score??65,source_type:t.source_type||"system",generated_by:t.generated_by||"system",status:"new"})}catch{}}let n=await d.J.recalculateAllScores(),{data:s}=await e.from("client_health_scores").select("client_id, client_name, overall_score, churn_probability, risk_level").order("churn_probability",{ascending:!1}).limit(5e3),o=(s||[]).map(e=>String(e.client_id)).filter(e=>h(e)),u=new Map;for(let t=0;t<o.length;t+=500){let a=o.slice(t,t+500),{data:r}=await e.from("ml_client_behavior_patterns").select("id, client_id").in("client_id",a);for(let e of r||[])e?.client_id&&e?.id&&u.set(String(e.client_id),String(e.id))}let m=e=>{let t=String(e||"").toLowerCase();return"critical"===t||"high"===t?"churn_risk":"low"===t?"satisfied":"needs_attention"},g=[],p=[];for(let e of s||[]){let a=String(e.client_id||"");if(!h(a))continue;let r=Math.max(0,Math.min(100,Number(e.churn_probability||0))),i=Math.max(0,Math.min(100,100-r)),n=Number(e.overall_score||0),s=Math.max(0,Math.min(100,n>=80?55:n>=65?35:15)),o={client_id:a,behavior_segment:m(e.risk_level),churn_risk_score:r,renewal_probability:i,upsell_probability:s,recommended_actions:[r>=70?"Agendar reuni\xe3o de reten\xe7\xe3o":null,r>=50?"Aumentar cad\xeancia de contato":null,n>=80?"Avaliar oportunidade de upsell":null].filter(Boolean),confidence_score:70,last_analyzed_at:t,updated_at:t},c=u.get(a);c?p.push({id:c,...o}):g.push(o)}for(let t=0;t<g.length;t+=500){let a=g.slice(t,t+500);a.length&&await e.from("ml_client_behavior_patterns").insert(a)}for(let t=0;t<p.length;t+=500){let a=p.slice(t,t+500);a.length&&await e.from("ml_client_behavior_patterns").upsert(a,{onConflict:"id"})}let{data:_}=await e.from("clients").select("id").limit(5e3),f=0;for(let e of _||[])e?.id&&h(String(e.id))&&await l.t.predictChurn(String(e.id))&&f++;let y=0;try{let{data:t}=await e.from("invoices").select("client_id").is("paid_at",null).limit(5e3);for(let e of Array.from(new Set((t||[]).map(e=>String(e.client_id||"")).filter(e=>h(e)))).slice(0,500))await l.t.predictPaymentRisk(e)&&y++}catch{}let w=0;try{let{data:t}=await e.from("contracts").select("client_id, value, status").eq("status","active").limit(5e3),a=new Map;for(let e of t||[]){let t=String(e?.client_id||"");h(t)&&a.set(t,(a.get(t)||0)+Number(e?.value||0))}for(let e of Array.from(a.entries()).sort((e,t)=>t[1]-e[1]).slice(0,200).map(([e])=>e))await l.t.predictLtv(e)&&w++}catch{}let v=0,b=0,S=await l.t.predictRevenue("month"),k=await l.t.predictRevenue("quarter");S&&v++,k&&v++;let M=await l.t.predictDemandCapacity("month"),x=await l.t.predictDemandCapacity("quarter");M&&b++,x&&b++;let{data:E}=await e.from("kanban_tasks").select("id").neq("status","done").limit(5e3),I=0;for(let e of E||[])e?.id&&h(String(e.id))&&await l.t.predictDelay(String(e.id))&&I++;let q=0;try{let{data:t}=await e.from("campaign_budgets").select("campaign_id, remaining_amount, budget_amount, spent_amount").order("remaining_amount",{ascending:!0}).limit(200);for(let e of Array.from(new Set((t||[]).map(e=>String(e.campaign_id||"")).filter(e=>h(e)))).slice(0,60))await l.t.predictBudgetOverrun(e)&&q++}catch{}let C=0;try{let{data:t}=await e.from("prospecting_leads").select("id").order("qualification_score",{ascending:!1}).limit(200);for(let e of t||[]){let t=String(e?.id||"");h(t)&&await l.t.predictConversion(t)&&C++}}catch{}let{data:H}=await e.from("client_health_scores").select("client_id, client_name, overall_score, churn_probability, risk_level").in("risk_level",["high","critical"]).order("churn_probability",{ascending:!1}).limit(10),R=(H||[]).map(e=>`${e.client_name||e.client_id} (${e.churn_probability||0}%)`);R.length>0&&await i({insight_category:"risk",insight_priority:"high",insight_title:"Clientes com risco elevado (ML/heur\xedstica)",insight_description:`Top clientes em risco (baseado em Health Score):
- ${R.join("\n- ")}`,affected_area:"clients",confidence_score:70,urgency_score:75,source_type:"system",generated_by:"system"});try{let{data:t}=await e.from("ml_predictions_log").select("target_id, predicted_value, predicted_at").eq("prediction_type","payment_risk").order("predicted_at",{ascending:!1}).limit(200),a=new Map;for(let e of t||[]){let t=e?.target_id?String(e.target_id):"";if(!t||!h(t)||a.has(t))continue;let r=e?.predicted_value,i="object"==typeof r&&r&&"value"in r?Number(r.value):Number(r),n="object"==typeof r&&r?String(r.entity_name||t):t;a.set(t,{id:t,name:n,risk:Number.isFinite(i)?i:0})}let r=Array.from(a.values()).sort((e,t)=>t.risk-e.risk).slice(0,5);r.length>0&&r[0].risk>=70&&await i({insight_category:"risk",insight_priority:"high",insight_title:"Risco de pagamento (clientes)",insight_description:`Top clientes com risco de pagamento elevado:
- ${r.map(e=>`${e.name} (${Math.round(e.risk)}%)`).join("\n- ")}`,affected_area:"finance",confidence_score:75,urgency_score:80})}catch{}try{let{data:t}=await e.from("ml_predictions_log").select("target_id, predicted_value, predicted_at").eq("prediction_type","budget_overrun").order("predicted_at",{ascending:!1}).limit(200),a=new Map;for(let e of t||[]){let t=e?.target_id?String(e.target_id):"";if(!t||!h(t)||a.has(t))continue;let r=e?.predicted_value,i="object"==typeof r&&r&&"value"in r?Number(r.value):Number(r),n="object"==typeof r&&r?String(r.entity_name||t):t;a.set(t,{id:t,name:n,risk:Number.isFinite(i)?i:0})}let r=Array.from(a.values()).sort((e,t)=>t.risk-e.risk).slice(0,5);r.length>0&&r[0].risk>=75&&await i({insight_category:"risk",insight_priority:"high",insight_title:"Risco de estouro de or\xe7amento (campanhas)",insight_description:`Campanhas com maior risco de estourar or\xe7amento:
- ${r.map(e=>`${e.name} (${Math.round(e.risk)}%)`).join("\n- ")}`,affected_area:"marketing",confidence_score:70,urgency_score:75})}catch{}try{let{data:t}=await e.from("ml_predictions_log").select("predicted_value, predicted_at").eq("prediction_type","demand_capacity").order("predicted_at",{ascending:!1}).limit(10),a=(t||[]).map(e=>{let t=e?.predicted_value,a="object"==typeof t&&t&&"value"in t?Number(t.value):Number(t),r="object"==typeof t&&t?String(t.recommendation||""):"";return{v:Number.isFinite(a)?a:0,rec:r}}).sort((e,t)=>t.v-e.v)[0];a&&a.v>=85&&await i({insight_category:"alert",insight_priority:"critical",insight_title:"Capacidade cr\xedtica (demanda vs capacidade)",insight_description:`Utiliza\xe7\xe3o estimada: ${Math.round(a.v)}%.
${a.rec||"Revisar prioridades e redistribuir demandas."}`,affected_area:"operations",confidence_score:70,urgency_score:90})}catch{}return{recalculatedHealthScores:n,behaviorPatternsInserted:g.length,behaviorPatternsUpdated:p.length,churnPredicted:f,paymentRiskPredicted:y,ltvPredicted:w,revenuePredicted:v,demandCapacityPredicted:b,delayPredicted:I,budgetOverrunPredicted:q,conversionPredicted:C,insertedInsight:R.length>0}}async function _(e){let t=Date.now(),a=(0,c.t)();try{let r=(0,u.T)(e);if(r)return r;let i=await p();return await (0,u.m)({supabase:a,action:"ml",status:"ok",durationMs:Date.now()-t,responseData:i}),o.NextResponse.json({success:!0,result:i})}catch(e){return await (0,u.m)({supabase:a,action:"ml",status:"error",durationMs:Date.now()-t,errorMessage:e?.message||"Erro interno"}),o.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}async function f(e){let t=Date.now(),a=(0,c.t)();try{let r=await (0,m.k)(e);if(!r.ok)return r.res;let i=await p();return await (0,u.m)({supabase:a,action:"ml",status:"ok",durationMs:Date.now()-t,requestData:{manual:!0,by:r.userId},responseData:i}),o.NextResponse.json({success:!0,result:i})}catch(e){return await (0,u.m)({supabase:a,action:"ml",status:"error",durationMs:Date.now()-t,errorMessage:e?.message||"Erro interno"}),o.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let y=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/cron/ml/route",pathname:"/api/cron/ml",filename:"route",bundlePath:"app/api/cron/ml/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\cron\\ml\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:v,serverHooks:b}=y,S="/api/cron/ml/route";function k(){return(0,s.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:v})}},32120:(e,t,a)=>{a.d(t,{J:()=>n});var r=a(90176);class i{db(){return(0,r.t)()}async calculateHealthScore(e){try{let{data:t}=await this.db().from("clients").select("*").eq("id",e).single();if(!t)return null;let a=await this.calculateEngagementScore(e),r=await this.calculatePaymentScore(e),i=await this.calculateSatisfactionScore(e),n=await this.calculateGrowthScore(e),s=Math.round(a*this.WEIGHTS.engagement+r*this.WEIGHTS.payment+i*this.WEIGHTS.satisfaction+n*this.WEIGHTS.growth),o=this.determineRiskLevel(s),c=this.calculateChurnProbability(s,{engagement:a,payment:r,satisfaction:i,growth:n}),l=await this.generateHealthFactors(e,{engagement:a,payment:r,satisfaction:i,growth:n}),d=this.generateRecommendations(l,o),u=await this.determineTrend(e,s),m={client_id:e,client_name:t.company_name||t.name,overall_score:s,engagement_score:a,payment_score:r,satisfaction_score:i,growth_score:n,risk_level:o,factors:l,recommendations:d,last_calculated:new Date().toISOString(),trend:u,churn_probability:c};return await this.saveHealthScore(m),m}catch(e){return console.error("Erro ao calcular Health Score:",e),null}}async calculateEngagementScore(e){try{let t=new Date;t.setDate(t.getDate()-30);let{data:a}=await this.db().from("client_activities").select("*").eq("client_id",e).gte("created_at",t.toISOString());if(!a||0===a.length)return 30;let r={login:5,approval:15,message:10,meeting:20,feedback:15,support_ticket:5},i=0;for(let e of a)i+=r[e.type]||5;return Math.min(100,Math.round(i/2))}catch(e){return console.error("Erro ao calcular engagement:",e),50}}async calculatePaymentScore(e){try{let{data:t}=await this.db().from("invoices").select("*").eq("client_id",e).order("created_at",{ascending:!1}).limit(12);if(!t||0===t.length)return 70;let a=100;for(let e of t)if("overdue"===e.status)a-=20;else if("paid"===e.status&&e.paid_at){let t=new Date(e.due_date),r=new Date(e.paid_at),i=Math.ceil((r.getTime()-t.getTime())/864e5);i>0?a-=Math.min(15,2*i):a+=5}return Math.max(0,Math.min(100,a))}catch(e){return console.error("Erro ao calcular payment score:",e),50}}async calculateSatisfactionScore(e){try{let{data:t}=await this.db().from("client_feedbacks").select("*").eq("client_id",e).order("created_at",{ascending:!1}).limit(5);if(!t||0===t.length)return 60;let a=0,r=0;for(let e of t)null!==e.nps_score&&(a+=10*e.nps_score,r++),null!==e.rating&&(a+=20*e.rating,r++);if(0===r)return 60;return Math.round(a/r)}catch(e){return console.error("Erro ao calcular satisfaction:",e),50}}async calculateGrowthScore(e){try{let{data:t}=await this.db().from("client_metrics").select("*").eq("client_id",e).order("period",{ascending:!1}).limit(3);if(!t||t.length<2)return 50;let a=t[0],r=t[1],i=0,n=0;if(a.followers&&r.followers){let e=(a.followers-r.followers)/r.followers*100;i+=Math.min(100,Math.max(0,50+e)),n++}if(a.engagement_rate&&r.engagement_rate){let e=(a.engagement_rate-r.engagement_rate)/r.engagement_rate*100;i+=Math.min(100,Math.max(0,50+2*e)),n++}if(a.conversions&&r.conversions){let e=(a.conversions-r.conversions)/r.conversions*100;i+=Math.min(100,Math.max(0,50+1.5*e)),n++}if(0===n)return 50;return Math.round(i/n)}catch(e){return console.error("Erro ao calcular growth:",e),50}}determineRiskLevel(e){return e>=75?"low":e>=50?"medium":e>=25?"high":"critical"}calculateChurnProbability(e,t){let a=100-e;return t.payment<40&&(a+=15),t.engagement<30&&(a+=10),t.satisfaction<40&&(a+=15),t.growth<30&&(a+=5),t.payment>80&&(a-=10),t.satisfaction>80&&(a-=15),Math.max(0,Math.min(100,Math.round(a)))}async generateHealthFactors(e,t){let a=[];return t.engagement>=70?a.push({name:"Alto engajamento",category:"engagement",value:t.engagement,weight:this.WEIGHTS.engagement,impact:"positive",description:"Cliente muito ativo na plataforma"}):t.engagement<40&&a.push({name:"Baixo engajamento",category:"engagement",value:t.engagement,weight:this.WEIGHTS.engagement,impact:"negative",description:"Cliente pouco ativo - risco de desconex\xe3o"}),t.payment>=80?a.push({name:"Excelente hist\xf3rico de pagamento",category:"payment",value:t.payment,weight:this.WEIGHTS.payment,impact:"positive",description:"Pagamentos sempre em dia"}):t.payment<50&&a.push({name:"Hist\xf3rico de atrasos",category:"payment",value:t.payment,weight:this.WEIGHTS.payment,impact:"negative",description:"Frequentes atrasos no pagamento"}),t.satisfaction>=80?a.push({name:"Alta satisfa\xe7\xe3o",category:"satisfaction",value:t.satisfaction,weight:this.WEIGHTS.satisfaction,impact:"positive",description:"Cliente muito satisfeito com os servi\xe7os"}):t.satisfaction<50&&a.push({name:"Satisfa\xe7\xe3o em risco",category:"satisfaction",value:t.satisfaction,weight:this.WEIGHTS.satisfaction,impact:"negative",description:"Feedbacks indicam insatisfa\xe7\xe3o"}),t.growth>=70?a.push({name:"Crescimento acelerado",category:"growth",value:t.growth,weight:this.WEIGHTS.growth,impact:"positive",description:"M\xe9tricas em crescimento constante"}):t.growth<40&&a.push({name:"Estagna\xe7\xe3o",category:"growth",value:t.growth,weight:this.WEIGHTS.growth,impact:"negative",description:"M\xe9tricas estagnadas ou em queda"}),a}generateRecommendations(e,t){let a=[];for(let t of e.filter(e=>"negative"===e.impact))switch(t.category){case"engagement":a.push("Agendar reuni\xe3o de alinhamento com o cliente"),a.push("Enviar relat\xf3rio de resultados personalizado");break;case"payment":a.push("Revisar condi\xe7\xf5es de pagamento"),a.push("Oferecer desconto para regulariza\xe7\xe3o");break;case"satisfaction":a.push("Realizar pesquisa de satisfa\xe7\xe3o detalhada"),a.push("Agendar call para entender pontos de melhoria");break;case"growth":a.push("Revisar estrat\xe9gia atual"),a.push("Propor novas a\xe7\xf5es para acelerar resultados")}return"critical"===t?(a.unshift("\uD83D\uDEA8 A\xc7\xc3O URGENTE: Cliente em risco cr\xedtico de churn"),a.push("Escalar para ger\xeancia imediatamente")):"high"===t&&a.unshift("⚠️ Cliente requer aten\xe7\xe3o especial"),[...new Set(a)].slice(0,5)}async determineTrend(e,t){try{let{data:a}=await this.db().from("client_health_scores").select("overall_score").eq("client_id",e).order("last_calculated",{ascending:!1}).limit(1).single();if(!a)return"stable";let r=t-a.overall_score;if(r>=5)return"improving";if(r<=-5)return"declining";return"stable"}catch{return"stable"}}async saveHealthScore(e){try{await this.db().from("client_health_scores").upsert({client_id:e.client_id,overall_score:e.overall_score,engagement_score:e.engagement_score,payment_score:e.payment_score,satisfaction_score:e.satisfaction_score,growth_score:e.growth_score,risk_level:e.risk_level,factors:e.factors,recommendations:e.recommendations,trend:e.trend,churn_probability:e.churn_probability,last_calculated:e.last_calculated},{onConflict:"client_id"})}catch(e){console.error("Erro ao salvar Health Score:",e)}}async getAllHealthScores(e){try{let t=this.db().from("client_health_scores").select("*").order("overall_score",{ascending:!0});e?.risk_level&&(t=t.eq("risk_level",e.risk_level)),e?.min_churn_probability&&(t=t.gte("churn_probability",e.min_churn_probability));let{data:a,error:r}=await t;if(r)return console.error("Erro ao buscar Health Scores:",r),[];return a||[]}catch(e){return console.error("Erro ao buscar Health Scores:",e),[]}}async recalculateAllScores(){try{let{data:e}=await this.db().from("clients").select("id").eq("is_active",!0);if(!e)return 0;let t=0;for(let a of e)await this.calculateHealthScore(a.id),t++;return t}catch(e){return console.error("Erro ao recalcular scores:",e),0}}constructor(){this.WEIGHTS={engagement:.25,payment:.3,satisfaction:.25,growth:.2}}}let n=new i},17478:(e,t,a)=>{a.d(t,{k:()=>o});var r=a(87070),i=a(20344),n=a(71615),s=a(54128);async function o(e){let t=(0,n.cookies)(),a=(0,i.createRouteHandlerClient)({cookies:()=>t}),o=e.headers.get("authorization")||"",c=o.toLowerCase().startsWith("bearer ")?o.slice(7).trim():null,l=c?(0,s.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${c}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):a,{data:d}=await l.auth.getUser();if(!d.user?.id)return{ok:!1,res:r.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:u,error:m}=await l.rpc("is_admin");return m||!u?{ok:!1,res:r.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:d.user.id}}},87881:(e,t,a)=>{a.d(t,{T:()=>i,m:()=>n});var r=a(87070);function i(e){let t=String(process.env.CRON_SECRET||"").trim(),a=String(e.headers.get("authorization")||"").trim();return t&&a===`Bearer ${t}`?null:"1"===String(e.headers.get("x-vercel-cron")||"").trim()||String(e.headers.get("user-agent")||"").toLowerCase().includes("vercel-cron")?null:r.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}async function n(e){try{await e.supabase.from("integration_logs").insert({integration_id:"cron",action:e.action,status:e.status,request_data:e.requestData??null,response_data:e.responseData??null,error_message:e.errorMessage??null,duration_ms:Math.max(0,Math.floor(e.durationMs||0)),created_at:new Date().toISOString()})}catch{}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958,79263],()=>a(24276));module.exports=r})();