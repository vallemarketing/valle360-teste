"use strict";(()=>{var e={};e.id=86014,e.ids=[86014],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},87561:e=>{e.exports=require("node:fs")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},89182:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>b,requestAsyncStorage:()=>g,routeModule:()=>_,serverHooks:()=>f,staticGenerationAsyncStorage:()=>k});var s={};r.r(s),r.d(s,{GET:()=>l,POST:()=>m,dynamic:()=>u});var n=r(49303),o=r(88716),a=r(60670),i=r(87070),d=r(96181);let u="force-dynamic";function c(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(String(e||""))}function p(e){let t=String(e||"").trim();if(t&&c(t))return t;try{return crypto.randomUUID()}catch{return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}}function x(e){let t=e.headers.get("x-api-key")||e.headers.get("authorization")?.replace("Bearer ","");return[process.env.SENTIMENT_WEBHOOK_KEY,process.env.N8N_WEBHOOK_KEY,process.env.INTERNAL_API_KEY].filter(Boolean).some(e=>e===t)}async function m(e){try{let t,r,s;if(!x(e))return i.NextResponse.json({error:"Unauthorized",message:"API Key inv\xe1lida ou n\xe3o fornecida"},{status:401});let{event:n,data:o}=await e.json();if(!n||!o)return i.NextResponse.json({error:"Bad Request",message:"event e data s\xe3o obrigat\xf3rios"},{status:400});let a=5,u=o?.message_id||o?.response_id||o?.feedback_id||o?.review_id||o?.comment_id||o?.ticket_id||o?.email_id||o?.id||null,m=o?.client_id&&c(String(o.client_id))?String(o.client_id):void 0,l=o?.user_id&&c(String(o.user_id))?String(o.user_id):void 0;switch(n){case"new_message":t="message",r=o.content||o.text||o.message,s=p(o.message_id||o.id),a=5;break;case"new_nps":case"nps_response":t="nps_response",r=o.feedback||o.comment||o.text,s=p(o.response_id||o.id),a=o.score<=6?10:o.score<=8?5:1;break;case"new_feedback":t="feedback",r=o.content||o.text||o.feedback,s=p(o.feedback_id||o.id),a=7;break;case"new_review":t="review",r=o.content||o.text||o.review,s=p(o.review_id||o.id),a=o.rating<=2?10:o.rating<=3?5:1;break;case"new_comment":case"task_comment":t="task_comment",r=o.content||o.text||o.comment,s=p(o.comment_id||o.id),a=3;break;case"support_ticket":t="support_ticket",r=o.description||o.content||o.text,s=p(o.ticket_id||o.id),a=8;break;case"email":t="email",r=o.body||o.content||o.text,s=p(o.email_id||o.id),a=4;break;default:return i.NextResponse.json({error:"Bad Request",message:`Evento n\xe3o suportado: ${n}`},{status:400})}if(!r)return i.NextResponse.json({error:"Bad Request",message:"Conte\xfado n\xe3o encontrado nos dados"},{status:400});if(!0===o.immediate||!0===o.sync){let e=await (0,d.nJ)(t,s,r,{clientId:m,userId:l,sourceTable:o.source_table,provider:o.provider});return i.NextResponse.json({success:!0,processed:!0,result:e?{id:e.id,overall_sentiment:e.overall_sentiment,score:e.score,alert_generated:e.alert_generated}:null})}{let e=await (0,d.dT)(t,s,r,{clientId:m,userId:l,sourceTable:o.source_table,priority:a,metadata:{event:n,external_source_id:u&&!c(String(u))?String(u):null,...o}});return i.NextResponse.json({success:!0,queued:!0,queue_id:e})}}catch(e){return console.error("Erro no webhook de sentimento:",e),i.NextResponse.json({error:"Internal Server Error",message:e.message},{status:500})}}async function l(e){return x(e)?i.NextResponse.json({status:"healthy",version:"1.0.0",supported_events:["new_message","new_nps","nps_response","new_feedback","new_review","new_comment","task_comment","support_ticket","email"],documentation:"/admin/integracoes/api/docs"}):i.NextResponse.json({error:"Unauthorized"},{status:401})}let _=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/sentiment/webhook/route",pathname:"/api/sentiment/webhook",filename:"route",bundlePath:"app/api/sentiment/webhook/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\sentiment\\webhook\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:k,serverHooks:f}=_,v="/api/sentiment/webhook/route";function b(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:k})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[89276,55972,54128,54214,68546,96181],()=>r(89182));module.exports=s})();