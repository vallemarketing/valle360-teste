"use strict";(()=>{var e={};e.id=57972,e.ids=[57972],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},75658:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>w,patchFetch:()=>b,requestAsyncStorage:()=>_,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f});var r={};s.r(r),s.d(r,{DELETE:()=>h,GET:()=>m,POST:()=>p});var a=s(49303),o=s(88716),i=s(60670),n=s(87070),c=s(20344),u=s(71615),d=s(90176),l=s(22887);async function p(e){try{let t;let s=(0,c.createRouteHandlerClient)({cookies:u.cookies}),r=(0,d.t)(),{data:{user:a},error:o}=await s.auth.getUser();if(o||!a)return n.NextResponse.json({success:!1,error:"N\xe3o autenticado"},{status:401});let{data:i}=await s.from("user_profiles").select("role").eq("user_id",a.id).single(),p=i?.role||"client";if(!["client","employee","super_admin"].includes(p))return n.NextResponse.json({success:!1,error:"Permiss\xe3o negada"},{status:403});let{clientId:m,platform:h,accountId:g,contentType:_,caption:f,mediaUrl:y,mediaUrls:w,link:b,scheduledFor:P}=await e.json();if(!m||!h||!g||!f)return n.NextResponse.json({success:!1,error:"clientId, platform, accountId e caption s\xe3o obrigat\xf3rios"},{status:400});if("text"!==_&&!y&&!w?.length)return n.NextResponse.json({success:!1,error:"mediaUrl ou mediaUrls \xe9 obrigat\xf3rio para posts com m\xeddia"},{status:400});let{data:x,error:R}=await r.from("client_social_connections").select("*").eq("client_id",m).eq("platform",h).eq("account_id",g).eq("is_active",!0).single();if(R||!x)return n.NextResponse.json({success:!1,error:"Conta social n\xe3o encontrada ou desconectada"},{status:404});if(x.token_expires_at&&new Date(x.token_expires_at)<new Date)return n.NextResponse.json({success:!1,error:"Token expirado. Reconecte a conta."},{status:401});if(P){if(new Date(P)<=new Date)return n.NextResponse.json({success:!1,error:"Data de agendamento deve ser no futuro"},{status:400});let{data:e,error:t}=await r.from("scheduled_posts").insert({client_id:m,platform:h,account_id:g,content_type:_,caption:f,media_url:y,media_urls:w,link:b,scheduled_for:P,status:"pending",created_by:a.id}).select("id").single();if(t)return console.error("Erro ao agendar post:",t),n.NextResponse.json({success:!1,error:"Erro ao agendar publica\xe7\xe3o"},{status:500});return n.NextResponse.json({success:!0,scheduledId:e.id})}let j=new l.F9({accessToken:x.access_token});try{if("instagram"===h)switch(_){case"image":if(!y)throw Error("mediaUrl \xe9 obrigat\xf3rio para imagens");t=(await j.createInstagramPost(g,y,f)).id;break;case"video":if(!y)throw Error("mediaUrl \xe9 obrigat\xf3rio para v\xeddeos");t=(await j.createInstagramVideoPost(g,y,f)).id;break;case"carousel":if(!w?.length)throw Error("mediaUrls \xe9 obrigat\xf3rio para carrossel");t=(await j.createInstagramCarouselPost(g,w,f)).id;break;default:return n.NextResponse.json({success:!1,error:"Instagram n\xe3o suporta posts de texto puro"},{status:400})}else if("facebook"===h)switch(_){case"text":t=(await j.createPagePost(g,x.access_token,f,b)).id;break;case"image":if(!y)throw Error("mediaUrl \xe9 obrigat\xf3rio para imagens");t=(await j.createPagePhotoPost(g,x.access_token,y,f)).id;break;case"video":if(!y)throw Error("mediaUrl \xe9 obrigat\xf3rio para v\xeddeos");t=(await j.createPageVideoPost(g,x.access_token,y,f)).id;break;default:return n.NextResponse.json({success:!1,error:"Tipo de conte\xfado n\xe3o suportado para Facebook"},{status:400})}return await r.from("social_posts_log").insert({client_id:m,platform:h,account_id:g,post_id:t,content_type:_,caption:f,media_url:y,status:"published",published_at:new Date().toISOString(),published_by:a.id}),n.NextResponse.json({success:!0,postId:t})}catch(e){return console.error("Erro ao publicar:",e),await r.from("social_posts_log").insert({client_id:m,platform:h,account_id:g,content_type:_,caption:f,media_url:y,status:"failed",error_message:e.message,created_by:a.id}),n.NextResponse.json({success:!1,error:e.message||"Erro ao publicar"},{status:500})}}catch(e){return console.error("Social publish error:",e),n.NextResponse.json({success:!1,error:e.message||"Erro interno"},{status:500})}}async function m(e){try{let t=(0,c.createRouteHandlerClient)({cookies:u.cookies}),s=(0,d.t)(),{data:{user:r},error:a}=await t.auth.getUser();if(a||!r)return n.NextResponse.json({error:"N\xe3o autenticado"},{status:401});let o=e.nextUrl.searchParams.get("client_id");if(!o)return n.NextResponse.json({error:"client_id \xe9 obrigat\xf3rio"},{status:400});let{data:i,error:l}=await s.from("scheduled_posts").select("*").eq("client_id",o).eq("status","pending").order("scheduled_for",{ascending:!0});if(l)return n.NextResponse.json({error:"Erro ao buscar posts agendados"},{status:500});return n.NextResponse.json({posts:i})}catch(e){return n.NextResponse.json({error:e.message},{status:500})}}async function h(e){try{let t=(0,c.createRouteHandlerClient)({cookies:u.cookies}),s=(0,d.t)(),{data:{user:r},error:a}=await t.auth.getUser();if(a||!r)return n.NextResponse.json({error:"N\xe3o autenticado"},{status:401});let o=e.nextUrl.searchParams.get("post_id");if(!o)return n.NextResponse.json({error:"post_id \xe9 obrigat\xf3rio"},{status:400});let{error:i}=await s.from("scheduled_posts").update({status:"cancelled"}).eq("id",o);if(i)return n.NextResponse.json({error:"Erro ao cancelar post"},{status:500});return n.NextResponse.json({success:!0})}catch(e){return n.NextResponse.json({error:e.message},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/social/publish/route",pathname:"/api/social/publish",filename:"route",bundlePath:"app/api/social/publish/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\social\\publish\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:_,staticGenerationAsyncStorage:f,serverHooks:y}=g,w="/api/social/publish/route";function b(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},90176:(e,t,s)=>{s.d(t,{t:()=>a});var r=s(54128);function a(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,r.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},22887:(e,t,s)=>{s.d(t,{F9:()=>a,nt:()=>o});let r="https://graph.facebook.com/v18.0";class a{constructor(e){this.accessToken=e.accessToken,this.adAccountId=e.adAccountId,this.businessAccountId=e.businessAccountId}async request(e,t={}){let s=new URL(`${r}${e}`);s.searchParams.set("access_token",this.accessToken);let a=await fetch(s.toString(),{...t,headers:{"Content-Type":"application/json",...t.headers}}),o=await a.json();if(o.error)throw Error(`Meta API Error: ${o.error.message}`);return o}async verifyToken(){return this.request("/debug_token",{method:"GET"})}async getMe(){return this.request("/me?fields=id,name,email")}async getInstagramAccount(e){return this.request(`/${e}?fields=instagram_business_account{id,username,followers_count,media_count}`)}async getInstagramInsights(e,t=["impressions","reach","profile_views"],s="day"){let r=t.join(",");return this.request(`/${e}/insights?metric=${r}&period=${s}`)}async getInstagramMedia(e,t=25){return this.request(`/${e}/media?fields=id,caption,media_type,media_url,thumbnail_url,timestamp,like_count,comments_count&limit=${t}`)}async createInstagramPost(e,t,s){let r=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify({image_url:t,caption:s})});return this.request(`/${e}/media_publish`,{method:"POST",body:JSON.stringify({creation_id:r.id})})}async createInstagramVideoPost(e,t,s){let r=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify({video_url:t,media_type:"VIDEO",caption:s})});return this.request(`/${e}/media_publish`,{method:"POST",body:JSON.stringify({creation_id:r.id})})}async createInstagramCarouselPost(e,t,s){let r=[];for(let s of t.slice(0,10)){let t=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify("video"===s.type?{video_url:s.url,media_type:"VIDEO",is_carousel_item:!0}:{image_url:s.url,is_carousel_item:!0})});r.push(t.id)}let a=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify({media_type:"CAROUSEL",caption:s,children:r.join(",")})});return this.request(`/${e}/media_publish`,{method:"POST",body:JSON.stringify({creation_id:a.id})})}async getAdCampaigns(e=["id","name","status","objective"]){if(!this.adAccountId)throw Error("Ad Account ID n\xe3o configurado");let t=e.join(",");return this.request(`/${this.adAccountId}/campaigns?fields=${t}`)}async getCampaignInsights(e,t="last_30d"){return this.request(`/${e}/insights?fields=impressions,clicks,spend,reach,cpc,cpm,ctr,conversions&date_preset=${t}`)}async getAdAccountInsights(e="last_30d"){if(!this.adAccountId)throw Error("Ad Account ID n\xe3o configurado");return this.request(`/${this.adAccountId}/insights?fields=impressions,clicks,spend,reach,actions&date_preset=${e}`)}async getPages(){return this.request("/me/accounts")}async createPagePost(e,t,s,a){let o={message:s};a&&(o.link=a);let i=new URL(`${r}/${e}/feed`);return i.searchParams.set("access_token",t),(await fetch(i.toString(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).json()}async createPagePhotoPost(e,t,s,a){let o=new URL(`${r}/${e}/photos`);o.searchParams.set("access_token",t);let i=new URLSearchParams;return i.set("url",s),a&&i.set("caption",a),i.set("published","true"),(await fetch(o.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i})).json()}async createPageVideoPost(e,t,s,a){let o=new URL(`${r}/${e}/videos`);o.searchParams.set("access_token",t);let i=new URLSearchParams;return i.set("file_url",s),a&&i.set("description",a),(await fetch(o.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i})).json()}async getPageInsights(e,t,s=["page_impressions","page_engaged_users","page_fans"],a="day"){let o=s.join(","),i=new URL(`${r}/${e}/insights`);return i.searchParams.set("access_token",t),i.searchParams.set("metric",o),i.searchParams.set("period",a),(await fetch(i.toString())).json()}}function o(e){return new a(e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>s(75658));module.exports=r})();