"use strict";(()=>{var e={};e.id=35407,e.ids=[35407],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},29211:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>k,patchFetch:()=>w,requestAsyncStorage:()=>y,routeModule:()=>f,serverHooks:()=>x,staticGenerationAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{GET:()=>g,POST:()=>_,dynamic:()=>c});var n=r(49303),o=r(88716),i=r(60670),s=r(87070),l=r(71615),u=r(20344),d=r(51547);let c="force-dynamic";function p(e,t=400){return s.NextResponse.json({success:!1,error:e},{status:t})}function m(e){return e.map(e=>String(e.title||"").trim()).filter(Boolean).slice(0,20)}async function g(e){let t=(0,l.cookies)(),r=(0,u.createRouteHandlerClient)({cookies:()=>t}),{data:a,error:n}=await r.auth.getUser(),o=a?.user;if(n||!o)return p("N\xe3o autorizado",401);let{data:i}=await r.rpc("is_admin"),{data:d}=await r.rpc("is_employee");if(!i&&!d)return p("Acesso negado",403);let{searchParams:c}=new URL(e.url),m=String(c.get("boardId")||"").trim();if(!m)return p("boardId \xe9 obrigat\xf3rio",400);let{data:g,error:_}=await r.from("kanban_boards").select("id, name, area_key").eq("id",m).maybeSingle();if(_||!g)return p("Board n\xe3o encontrado",404);let{data:f,error:y}=await r.from("kanban_columns").select("id, name, stage_key, sla_hours, wip_limit, position, color").eq("board_id",m).order("position");if(y)return p("Falha ao carregar colunas",500);let{data:h,error:x}=await r.from("kanban_tasks").select("id, title, due_date, priority, status, assigned_to, column_id, created_at, updated_at, reference_links").eq("board_id",m).neq("status","cancelled").limit(2e3);if(x)return p("Falha ao carregar tarefas",500);let k=new Map((f||[]).map(e=>[String(e.id),e])),w=Date.now(),v=e=>{let t=k.get(String(e.column_id)),r=String(t?.stage_key||"").toLowerCase(),a=String(t?.name||"").toLowerCase();return"finalizado"===r||a.includes("final")},I=(h||[]).length,E=(h||[]).filter(v).length,S=(h||[]).filter(e=>!v(e)&&!!e.due_date&&new Date(String(e.due_date)).getTime()<w).length,O=(h||[]).filter(e=>!v(e)).map(e=>({task:e,...function(e){let t=[],r=0,a=k.get(String(e.column_id)),n=String(a?.stage_key||"").toLowerCase(),o=e.reference_links?.client_approval?.due_at,i=o?new Date(String(o)).getTime():NaN;if("aprovacao"===n&&Number.isFinite(i)){let e=i-w;e<0?(r=Math.max(r,95),t.push("Aprova\xe7\xe3o do cliente atrasada")):e<=432e5&&(r=Math.max(r,80),t.push("Aprova\xe7\xe3o do cliente em risco (≤ 12h)"))}if(e.due_date){let a=new Date(String(e.due_date)).getTime()-w;a<0?(r=Math.max(r,100),t.push("Tarefa atrasada")):a<=864e5?(r=Math.max(r,75),t.push("Vence em 24h")):a<=2592e5&&(r=Math.max(r,55),t.push("Vence em 72h"))}let s=e.updated_at?new Date(String(e.updated_at)).getTime():NaN;if(Number.isFinite(s)){let e=(w-s)/864e5;e>=7?(r+=15,t.push("Sem atualiza\xe7\xe3o h\xe1 7d+")):e>=3&&(r+=8,t.push("Sem atualiza\xe7\xe3o h\xe1 3d+"))}let l=String(e.priority||"").toLowerCase();return"urgent"===l?(r+=10,t.push("Prioridade urgente")):"high"===l&&(r+=6,t.push("Prioridade alta")),{score:r=Math.max(0,Math.min(100,Math.round(r))),reasons:t,stage_key:n||null}}(e)})).sort((e,t)=>t.score-e.score),b=O.filter(e=>e.score>=70),j=O.filter(e=>e.score>0).slice(0,10).map(e=>({id:e.task.id,title:e.task.title,score:e.score,reasons:e.reasons,due_date:e.task.due_date||null,stage_key:e.stage_key})),P=(f||[]).filter(e=>Number(e?.wip_limit||0)>0).map(e=>{let t=(h||[]).filter(t=>String(t.column_id)===String(e.id)).length,r=Number(e.wip_limit);return{column_id:e.id,name:e.name,count:t,wip_limit:r,is_bottleneck:t>=r}}).filter(e=>e.is_bottleneck);return s.NextResponse.json({success:!0,board:g,metrics:{total:I,done:E,overdue:S,at_risk:b.length,bottlenecks:P},risk:{count:b.length,top:j}})}async function _(e){let t;let r=(0,l.cookies)(),a=(0,u.createRouteHandlerClient)({cookies:()=>r}),{data:n,error:o}=await a.auth.getUser(),i=n?.user;if(o||!i)return p("N\xe3o autorizado",401);let{data:c}=await a.rpc("is_admin"),{data:g}=await a.rpc("is_employee");if(!c&&!g)return p("Acesso negado",403);try{t=await e.json()}catch{return p("Body inv\xe1lido (JSON)",400)}if("generate_message"!==t.action)return p("action inv\xe1lida",400);let _=String(t.boardId||"").trim(),f=t.messageType,y=t.collaboratorId?String(t.collaboratorId):void 0,h=Array.isArray(t.taskIds)?t.taskIds.map(e=>String(e)).filter(Boolean):[];if(!_)return p("boardId \xe9 obrigat\xf3rio",400);if(!f)return p("messageType \xe9 obrigat\xf3rio",400);let{data:x}=await a.from("kanban_boards").select("id, name, area_key").eq("id",_).maybeSingle();if(!x)return p("Board n\xe3o encontrado",404);let k=[];if(h.length>0){let{data:e,error:t}=await a.from("kanban_tasks").select("id, title, due_date, priority, status, assigned_to, board_id, column_id").in("id",h).eq("board_id",_);if(t)return p("Falha ao carregar tarefas",500);k=e||[]}let w=()=>{let e=m(k),t=e.length?`

Demandas:
- ${e.join("\n- ")}`:"";return"praise"===f?`Ol\xe1! Passando para reconhecer seu trabalho — excelente execu\xe7\xe3o e organiza\xe7\xe3o. Obrigado por manter o ritmo e a qualidade.${t}

Se precisar de qualquer suporte, me avise.`:"approval_reminder"===f?`Ol\xe1! Tudo bem? Sua aprova\xe7\xe3o est\xe1 pendente para seguirmos com a entrega.${t}

Voc\xea consegue aprovar ou pedir ajustes ainda hoje? Isso ajuda a manter o prazo.`:`Ol\xe1! Tudo bem? Precisamos alinhar o andamento de algumas demandas para manter os prazos.${t}

Consegue me dizer o status e se existe algum impedimento?`};try{let e=m(k),t=[`Voc\xea \xe9 um gestor de opera\xe7\xf5es. Escreva uma mensagem curta em pt-BR (${"praise"===f?"elogio":"approval_reminder"===f?"cobran\xe7a_cliente":"cobran\xe7a_time"}).`,`Contexto: Board="${x.name}" area_key="${x.area_key||""}".`,y?`Destinat\xe1rio (user_id): ${y}`:"",e.length?`Demandas:
- ${e.join("\n- ")}`:"Sem lista de demandas.","Regras: tom respeitoso, objetivo, sem emojis, pedir confirma\xe7\xe3o de status e pr\xf3ximos passos."].filter(Boolean).join("\n\n"),r=await (0,d.F)({task:"kanban_message",actorUserId:i.id,entityType:"kanban_board",entityId:_,messages:[{role:"system",content:"Voc\xea \xe9 um assistente corporativo para gest\xe3o de Kanban."},{role:"user",content:t}],temperature:.4,maxTokens:400}),a=String(r.text||"").trim();return s.NextResponse.json({success:!0,message:a||w(),ai:{used:!!a,provider:r.provider,model:r.model}})}catch(e){return s.NextResponse.json({success:!0,message:w(),ai:{used:!1,error:e?.message||String(e)}})}}let f=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/kanban/insights/route",pathname:"/api/kanban/insights",filename:"route",bundlePath:"app/api/kanban/insights/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\kanban\\insights\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:x}=f,k="/api/kanban/insights/route";function w(){return(0,i.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:h})}},90176:(e,t,r)=>{r.d(t,{t:()=>n});var a=r(54128);function n(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,a.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},51547:(e,t,r)=>{r.d(t,{F:()=>w,getProviderStatus:()=>k});var a=r(90176);function n(e){let t=e.match(/\{[\s\S]*\}|\[[\s\S]*\]/);if(!t)throw Error("Resposta n\xe3o cont\xe9m JSON");return JSON.parse(t[0])}function o(e){if(!e)return null;try{return JSON.parse(e)}catch{return null}}function i(e){return e?Array.isArray(e)?e.map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?[e.trim()].filter(Boolean):[]:[]}async function s(e){try{let t=(0,a.t)();await t.from("audit_logs").insert({user_id:e.userId||null,action:e.action,entity_type:e.entityType||"ai",entity_id:e.entityId||null,old_values:null,new_values:e.newValues,ip_address:null,user_agent:null,created_at:new Date().toISOString()})}catch{}}let l=null;async function u(){if(l&&Date.now()-l.fetchedAt<6e4)return{apiKey:l.apiKey,config:l.config};let e=null,t=null;try{let r=(0,a.t)(),{data:n}=await r.from("integration_configs").select("api_key, config").eq("integration_id","openrouter").single();e=n?.api_key||null,t=n?.config||null}catch{}return e=e||process.env.OPENROUTER_API_KEY||null,l={fetchedAt:Date.now(),apiKey:e,config:t},{apiKey:e,config:t}}function d(e){return e?"string"==typeof e?o(e):"object"==typeof e?e:null:null}async function c(e="general"){let t=process.env.OPENROUTER_MODEL;if(t)return[t].filter(Boolean);let{config:r}=await u(),a=r?.model?String(r.model).trim():"";if(a)return[a];let n=o(process.env.OPENROUTER_MODEL_POLICY_JSON),s=d(r?.model_policy)||d(r?.modelPolicy)||n||{default:["openrouter/auto"],general:["openrouter/auto"],analysis:["anthropic/claude-3.5-sonnet","openrouter/auto"],strategy:["anthropic/claude-3.5-sonnet","openrouter/auto"],kanban_insights:["anthropic/claude-3.5-sonnet","openrouter/auto"],kanban_message:["openai/gpt-4o","openrouter/auto"],copywriting:["openai/gpt-4o","openrouter/auto"],sales:["openai/gpt-4o","openrouter/auto"],sentiment:["google/gemini-1.5-pro","openrouter/auto"],classification:["google/gemini-1.5-pro","openrouter/auto"],hr:["anthropic/claude-3.5-sonnet","openrouter/auto"]},l=[...i(s[e]),...i(s.default),"openrouter/auto"],c=new Set,p=[];for(let e of l){let t=String(e).trim();!t||c.has(t)||(c.add(t),p.push(t))}return p.length?p:["openrouter/auto"]}async function p(){try{let e=(0,a.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","anthropic").single();if(t?.api_key)return t.api_key}catch{}return process.env.ANTHROPIC_API_KEY||null}async function m(){try{let e=(0,a.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","openai").single();if(t?.api_key)return t.api_key}catch{}return process.env.OPENAI_API_KEY||null}async function g(){try{let e=(0,a.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","gemini").single();if(t?.api_key)return t.api_key}catch{}return process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY||null}async function _(e,t,r){let a=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json","HTTP-Referer":process.env.NEXT_PUBLIC_APP_URL||"http://localhost","X-Title":"Valle 360"},body:JSON.stringify({model:t,messages:e.messages,temperature:e.temperature??.7,max_tokens:e.maxTokens??1024,response_format:e.json?{type:"json_object"}:void 0})}),n=await a.text();if(!a.ok)throw Error(`OpenRouter error (${a.status}): ${n.slice(0,500)}`);let o=JSON.parse(n),i=o?.choices?.[0]?.message?.content||"";return{provider:"openrouter",model:o?.model||t,text:i,usage:o?.usage}}async function f(e){let{apiKey:t}=await u();if(!t)throw Error("OPENROUTER_API_KEY n\xe3o configurada");let r=await c(e.task),a=Date.now(),o=[];for(let l of r)try{let o=await _(e,l,t);return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:o.provider,model:o.model,ok:!0,ms:Date.now()-a,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json,openrouter_models_tried:r}}),e.json&&(o.json=n(o.text)),o}catch(t){var i;let e=t?.message||String(t);if(o.push({model:l,error:e}),!(!(i=function(e){let t=e.match(/OpenRouter error \\((\\d+)\\):/);if(!t?.[1])return null;let r=Number(t[1]);return Number.isFinite(r)?r:null}(e))||401!==i&&403!==i&&(429===i||408===i||i>=500&&i<=599||400===i&&/model|not found|no such|invalid/i.test(e))))break}let l=o.map(e=>`${e.model}: ${e.error}`).join(" | ");throw Error(`OpenRouter falhou em ${o.length} tentativa(s). ${l}`)}async function y(e){let t=await p();if(!t)throw Error("ANTHROPIC_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.ANTHROPIC_MODEL||"claude-3-5-sonnet-20241022"}(e.task),a=Date.now(),o=e.messages.find(e=>"system"===e.role)?.content,i=e.messages.filter(e=>"system"!==e.role).map(e=>`${e.role.toUpperCase()}: ${e.content}`).join("\n\n"),l=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":t,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:r,max_tokens:e.maxTokens??1024,temperature:e.temperature??.7,system:e.json?`${o||""}

Responda APENAS com um JSON v\xe1lido, sem texto extra.`:o,messages:[{role:"user",content:i}]})}),u=await l.text();if(!l.ok)throw Error(`Claude error (${l.status}): ${u.slice(0,500)}`);let d=JSON.parse(u),c=d?.content?.[0]?.text||"",m={provider:"claude",model:r,text:c,usage:d?.usage};return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:m.provider,model:m.model,ok:!0,ms:Date.now()-a,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(m.json=n(c)),m}async function h(e){let t=await m();if(!t)throw Error("OPENAI_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.OPENAI_MODEL||"gpt-4o-mini"}(e.task),a=Date.now(),o=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:r,messages:e.messages,temperature:e.temperature??.7,max_tokens:e.maxTokens??1024,response_format:e.json?{type:"json_object"}:void 0})}),i=await o.text();if(!o.ok)throw Error(`OpenAI error (${o.status}): ${i.slice(0,500)}`);let l=JSON.parse(i),u=l?.choices?.[0]?.message?.content||"",d={provider:"openai",model:l?.model||r,text:u,usage:l?.usage};return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:d.provider,model:d.model,ok:!0,ms:Date.now()-a,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(d.json=n(u)),d}async function x(e){let t=await g();if(!t)throw Error("GOOGLE_GEMINI_API_KEY/GOOGLE_CLOUD_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.GEMINI_MODEL||"gemini-1.5-flash"}(e.task),a=Date.now(),o=e.messages.find(e=>"system"===e.role)?.content,i=e.messages.filter(e=>"system"!==e.role).map(e=>`${e.role.toUpperCase()}: ${e.content}`).join("\n\n"),l=e.json?`${o||""}

Responda APENAS com um JSON v\xe1lido, sem texto extra.

${i}`:`${o||""}

${i}`,u=`https://generativelanguage.googleapis.com/v1beta/models/${r}:generateContent?key=${encodeURIComponent(t)}`,d=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:l}]}],generationConfig:{temperature:e.temperature??.7,maxOutputTokens:e.maxTokens??1024}})}),c=await d.text();if(!d.ok)throw Error(`Gemini error (${d.status}): ${c.slice(0,500)}`);let p=JSON.parse(c),m=p?.candidates?.[0]?.content?.parts?.map(e=>e.text).join("")||"",_={provider:"gemini",model:r,text:m,usage:p?.usageMetadata};return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:_.provider,model:_.model,ok:!0,ms:Date.now()-a,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(_.json=n(m)),_}function k(){return{openrouter:!!process.env.OPENROUTER_API_KEY,claude:!!process.env.ANTHROPIC_API_KEY,openai:!!process.env.OPENAI_API_KEY,gemini:!!(process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY)}}async function w(e){let t=e.correlationId||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),r={...e,correlationId:t},a=[];for(let e of[{provider:"openrouter",fn:f},{provider:"claude",fn:y},{provider:"openai",fn:h},{provider:"gemini",fn:x}])try{return await e.fn(r)}catch(o){let n=o?.message||String(o);a.push({provider:e.provider,error:n}),await s({userId:r.actorUserId||null,action:"ai.request_failed",entityType:r.entityType||"ai",entityId:r.entityId||null,newValues:{provider:e.provider,ok:!1,error:n.slice(0,500),task:r.task||"general",correlation_id:t,json:!!r.json}})}let n=a.map(e=>`${e.provider}: ${e.error}`).join(" | ");throw Error(`Falha em todos os provedores. ${n}`)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958],()=>r(29211));module.exports=a})();