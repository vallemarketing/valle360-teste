"use strict";(()=>{var e={};e.id=23384,e.ids=[23384],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},1575:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>v,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>g,serverHooks:()=>S,staticGenerationAsyncStorage:()=>h});var r={};a.r(r),a.d(r,{GET:()=>p,dynamic:()=>m});var i=a(49303),n=a(88716),s=a(60670),o=a(87070),l=a(20344),c=a(71615),u=a(54128),d=a(90176);let m="force-dynamic";async function _(e){try{let e=(0,c.cookies)(),t=(0,l.createRouteHandlerClient)({cookies:()=>e}),{data:a}=await t.auth.getUser();if(a?.user?.id)return a.user}catch{}let t=e.headers.get("authorization")||e.headers.get("Authorization")||"",a=t.toLowerCase().startsWith("bearer ")?t.slice(7).trim():null;if(!a)return null;let r="https://ikjgsqtykkhqimypacro.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI";if(!r||!i)return null;let n=(0,u.eI)(r,i,{global:{headers:{Authorization:`Bearer ${a}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}),{data:s}=await n.auth.getUser();return s?.user||null}async function p(e){let t=await _(e);if(!t)return o.NextResponse.json({success:!1,error:"N\xe3o autorizado"},{status:401});let a=(0,d.t)(),r=null;try{let e=await a.from("employees").select("id").eq("user_id",t.id).maybeSingle();if(!e.error&&e.data?.id)r=String(e.data.id);else if(e.error&&String(e.error.message||"").toLowerCase().includes("column")){let e=await a.from("employees").select("id").eq("user_profile_id",t.id).maybeSingle();!e.error&&e.data?.id&&(r=String(e.data.id))}}catch{r=null}if(!r)return o.NextResponse.json({success:!1,error:"Acesso negado (colaborador n\xe3o vinculado em employees)"},{status:403});let i=[];try{let{data:e,error:t}=await a.from("employee_client_assignments").select("client_id, assigned_at, role, removed_at, is_active").eq("employee_id",r).order("assigned_at",{ascending:!1}).limit(500);if(t)throw t;i=(e||[]).filter(e=>e?.client_id&&e?.is_active!==!1&&!e?.removed_at).map(e=>({client_id:String(e.client_id),assigned_at:e.assigned_at||null,role:e.role||null}))}catch(e){if(function(e){let t=String(e||"").toLowerCase();return t.includes("does not exist")||t.includes("relation")||t.includes("schema cache")||t.includes("could not find the table")||t.includes("column")||t.includes("unknown")}(e?.message||""))return o.NextResponse.json({success:!0,clients:[],note:"Tabela employee_client_assignments n\xe3o existe neste ambiente (schema de atribui\xe7\xe3o ainda n\xe3o aplicado)."});return o.NextResponse.json({success:!1,error:e?.message||"Erro interno"},{status:500})}let n=Array.from(new Set(i.map(e=>e.client_id)));if(0===n.length)return o.NextResponse.json({success:!0,clients:[],note:"Nenhum cliente atribu\xeddo a este colaborador."});let s=[],l="new";{let e=await a.from("clients").select("id, user_id, company_name, industry, segment, site, created_at").in("id",n);if(e.error){let e=await a.from("clients").select("id, user_id, nome_fantasia, razao_social, area_atuacao, cidade, estado, site, created_at").in("id",n);if(e.error)return o.NextResponse.json({success:!1,error:e.error.message},{status:500});s=e.data||[],l="legacy"}else s=e.data||[],l="new"}let c=Array.from(new Set(s.map(e=>String(e.user_id||"")).filter(Boolean))),u=[];if(c.length>0){let e=await a.from("users").select("id,email,full_name,phone,name,account_status").in("id",c);u=e.error?((await a.from("user_profiles").select("user_id,email,full_name,phone,is_active").in("user_id",c)).data||[]).map(e=>({id:e.user_id,email:e.email,full_name:e.full_name,phone:e.phone,account_status:!1===e.is_active?"inactive":"active"})):e.data||[]}let m=new Map(u.map(e=>[String(e.id),e])),p=new Map;{let e=await a.from("contracts").select("client_id, monthly_value, status, start_date, created_at").in("client_id",n);if(e.error){let e=await a.from("client_contracts").select("client_id, monthly_value, status, start_date, created_at").in("client_id",n);if(!e.error)for(let t of e.data||[])t?.client_id&&!p.has(t.client_id)&&p.set(String(t.client_id),t)}else for(let t of e.data||[])t?.client_id&&!p.has(t.client_id)&&p.set(String(t.client_id),t)}let g=new Map;{let e=await a.from("client_health_scores").select("client_id, overall_health_score, score_trend, score_change, previous_score, calculated_at").in("client_id",n);if(!e.error)for(let t of e.data||[])t?.client_id&&g.set(String(t.client_id),t)}let f=new Map(i.map(e=>[e.client_id,e.assigned_at||null])),h=s.map(e=>{let t=m.get(String(e.user_id||""))||{},a=p.get(String(e.id)),r=g.get(String(e.id)),i="new"===l?String(e.company_name||"Cliente"):String(e.nome_fantasia||e.razao_social||"Cliente"),n=String(t.full_name||t.name||i),s=String(t.email||""),o=String(t.phone||""),c=String(e.site||"").trim()||null,u=a?Number(a.monthly_value||0):null,d=a?.status?String(a.status):"—",_=r?Number(r.overall_health_score||0):null,h=r&&null!=r.score_change?Number(r.score_change||0):null,S=function(e){let t=String(e||"").toLowerCase();return"improving"===t?{trend:"up",value:0}:"declining"===t?{trend:"down",value:0}:{trend:"stable",value:0}}(r?.score_trend||null);null!=h&&(S.value=h);let v=r?.calculated_at||a?.start_date||a?.created_at||f.get(String(e.id))||e.created_at||null,y="legacy"===l&&[e.cidade,e.estado].filter(Boolean).join(", ")||"—";return{id:String(e.id),name:n,company:i,logo:`https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(i)}`,plan:d,status:null!=_&&_<60?"at_risk":"active",lastInteractionAt:v,revenue:u,revenueKnown:null!=u,performance:{trend:S.trend,value:S.value,score:_},email:s,phone:o,location:y,website:c}});return o.NextResponse.json({success:!0,clients:h})}let g=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/collaborator/clients/route",pathname:"/api/collaborator/clients",filename:"route",bundlePath:"app/api/collaborator/clients/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\collaborator\\clients\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:S}=g,v="/api/collaborator/clients/route";function y(){return(0,s.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:h})}},90176:(e,t,a)=>{a.d(t,{t:()=>i});var r=a(54128);function i(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,r.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>a(1575));module.exports=r})();