"use strict";(()=>{var e={};e.id=55476,e.ids=[55476],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},18702:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>v,patchFetch:()=>j,requestAsyncStorage:()=>w,routeModule:()=>x,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f});var r={};a.r(r),a.d(r,{POST:()=>_,dynamic:()=>m});var o=a(49303),s=a(88716),i=a(60670),n=a(87070),p=a(20344),c=a(71615),l=a(30920),d=a(49805),u=a(90176);let m="force-dynamic";async function _(e){let t=(0,p.createRouteHandlerClient)({cookies:c.cookies});try{let{magic_link_token:a,action:r,rejection_reason:o}=await e.json();if(!a)return n.NextResponse.json({error:"Token inv\xe1lido"},{status:400});let{data:s,error:i}=await t.from("proposals").select("*").eq("magic_link_token",a).single();if(i||!s)return n.NextResponse.json({error:"Proposta n\xe3o encontrada"},{status:404});if(["accepted","rejected","expired"].includes(s.status))return n.NextResponse.json({error:`Proposta j\xe1 foi ${"accepted"===s.status?"aceita":"rejected"===s.status?"rejeitada":"expirada"}`},{status:400});let p=s.valid_until?new Date(s.valid_until):null;if(p&&p<new Date)return await t.from("proposals").update({status:"expired",updated_at:new Date().toISOString()}).eq("id",s.id),n.NextResponse.json({error:"Proposta expirada"},{status:400});if("accept"===r){let{error:e}=await t.from("proposals").update({status:"accepted",updated_at:new Date().toISOString()}).eq("id",s.id);if(e)throw e;let a=s.sales_rep_id||s.created_by||s.user_id||null;a&&await t.from("notifications").insert({user_id:a,title:"\uD83C\uDF89 Proposta Aceita!",message:`${s.client_name} aceitou a proposta.`,type:"proposal_accepted",link:"/admin/comercial/propostas",metadata:{proposal_id:s.id}});try{let e=(0,u.t)(),t=await (0,l.Kn)({eventType:"proposal.accepted",entityType:"proposal",entityId:s.id,actorUserId:null,payload:{proposal_id:s.id,client_email:s.client_email,client_name:s.client_name}},e),a=await (0,d.Z)(t);a.ok?await (0,l.ls)(t.id,e):await (0,l.bT)(t.id,a.error,e)}catch{}return n.NextResponse.json({success:!0,message:"Proposta aceita com sucesso! Em breve voc\xea receber\xe1 o contrato.",next_step:"contract"})}if("reject"===r){let{error:e}=await t.from("proposals").update({status:"rejected",updated_at:new Date().toISOString()}).eq("id",s.id);if(e)throw e;let a=s.sales_rep_id||s.created_by||s.user_id||null;a&&await t.from("notifications").insert({user_id:a,title:"Proposta Rejeitada",message:`${s.client_name} rejeitou a proposta. Motivo: ${o||"N\xe3o informado"}`,type:"proposal_rejected",link:"/admin/comercial/propostas",metadata:{proposal_id:s.id}});try{let e=(0,u.t)(),t=await (0,l.Kn)({eventType:"proposal.rejected",entityType:"proposal",entityId:s.id,actorUserId:null,payload:{proposal_id:s.id,client_email:s.client_email,client_name:s.client_name,reason:o||null}},e),a=await (0,d.Z)(t);a.ok?await (0,l.ls)(t.id,e):await (0,l.bT)(t.id,a.error,e)}catch{}return n.NextResponse.json({success:!0,message:"Proposta rejeitada."})}if("view"===r)return"sent"===s.status&&await t.from("proposals").update({status:"viewed",updated_at:new Date().toISOString()}).eq("id",s.id),n.NextResponse.json({success:!0,proposal:function(e){let t=(Array.isArray(e.items)?e.items:[]).map(e=>({name:e?.name||"Servi\xe7o",description:e?.description,price:Number(e?.price||0),quantity:Number(e?.quantity||1),features:e?.features})),a=Number(e.total_value||0),r=t.reduce((e,t)=>e+Number(t.price)*Number(t.quantity||1),0)||a,o=e.valid_until?new Date(e.valid_until).toISOString():new Date(Date.now()+2592e6).toISOString();return{client_name:e.client_name,services:t,subtotal:r,discount_percent:0,discount_value:0,total:a||r,payment_terms:"Mensal",valid_until:o,notes:"",status:e.status}}(s)});return n.NextResponse.json({error:"A\xe7\xe3o inv\xe1lida"},{status:400})}catch(e){return console.error("Erro ao processar proposta:",e),n.NextResponse.json({error:"Erro ao processar proposta"},{status:500})}}let x=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/proposals/accept/route",pathname:"/api/proposals/accept",filename:"route",bundlePath:"app/api/proposals/accept/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\proposals\\accept\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:f,serverHooks:y}=x,v="/api/proposals/accept/route";function j(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958,40074,38823],()=>a(18702));module.exports=r})();