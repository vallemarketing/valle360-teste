"use strict";(()=>{var e={};e.id=64589,e.ids=[64589],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},64350:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>y,patchFetch:()=>f,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>_,staticGenerationAsyncStorage:()=>v});var n={};a.r(n),a.d(n,{GET:()=>p,dynamic:()=>d});var s=a(49303),i=a(88716),r=a(60670),o=a(87070),l=a(20344),c=a(71615),u=a(90176);let d="force-dynamic";async function p(e){try{let t;let a=(0,c.cookies)(),n=(0,l.createRouteHandlerClient)({cookies:()=>a}),{data:{user:s},error:i}=await n.auth.getUser();if(i||!s)return o.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:r}=await n.rpc("is_admin");if(!r)return o.NextResponse.json({error:"Acesso negado (admin)"},{status:403});let d=(0,u.t)(),{searchParams:p}=new URL(e.url),m=p.get("client_id"),g=p.get("period")||"7d";p.get("group_by");let v=new Date;switch(g){case"1d":t=new Date(v.getTime()-864e5);break;case"30d":t=new Date(v.getTime()-2592e6);break;case"90d":t=new Date(v.getTime()-7776e6);break;default:t=new Date(v.getTime()-6048e5)}let _=d.from("sentiment_daily_stats").select("*").gte("date",t.toISOString().split("T")[0]).order("date",{ascending:!0});m&&(_=_.eq("client_id",m));let{data:y,error:f}=await _;if(f)throw f;let h=d.from("sentiment_analyses").select("overall_sentiment, source_type, score",{count:"exact"}).gte("analyzed_at",t.toISOString());m&&(h=h.eq("client_id",m));let{data:x,count:S,error:w}=await h;if(w)throw w;let E={total:S||0,positive:0,neutral:0,negative:0,by_source:{},average_score:0},b=0;(x||[]).forEach(e=>{"positive"===e.overall_sentiment?E.positive++:"neutral"===e.overall_sentiment?E.neutral++:"negative"===e.overall_sentiment&&E.negative++,E.by_source[e.source_type]=(E.by_source[e.source_type]||0)+1,b+=e.score||0}),E.average_score=E.total>0?b/E.total:0;let R=d.from("sentiment_alerts").select("severity",{count:"exact"}).eq("status","pending");m&&(R=R.eq("client_id",m));let{data:q,count:j}=await R,A={critical:0,high:0,medium:0,low:0};(q||[]).forEach(e=>{A[e.severity]++});let{data:k}=await d.from("sentiment_analyses").select("entities").gte("analyzed_at",t.toISOString()).not("entities","is",null).limit(100),U={};(k||[]).forEach(e=>{e.entities&&Array.isArray(e.entities)&&e.entities.forEach(e=>{let t=e.name?.toLowerCase();t&&(U[t]||(U[t]={count:0,totalSentiment:0}),U[t].count++,"positive"===e.sentiment?U[t].totalSentiment+=1:"negative"===e.sentiment&&(U[t].totalSentiment-=1))})});let P=Object.entries(U).map(([e,t])=>({name:e,count:t.count,avgSentiment:t.totalSentiment/t.count})).sort((e,t)=>t.count-e.count),C=P.filter(e=>e.avgSentiment>0).slice(0,5),T=P.filter(e=>e.avgSentiment<0).slice(0,5),I=(y||[]).map(e=>({date:e.date,total:e.total_analyses,positive:e.positive_count,neutral:e.neutral_count,negative:e.negative_count,average_score:e.average_score}));return o.NextResponse.json({success:!0,period:g,totals:E,alerts:{pending:j||0,by_severity:A},trend:I,entities:{top_positive:C,top_negative:T},percentages:{positive:E.total>0?(E.positive/E.total*100).toFixed(1):0,neutral:E.total>0?(E.neutral/E.total*100).toFixed(1):0,negative:E.total>0?(E.negative/E.total*100).toFixed(1):0}})}catch(t){if(console.error("Erro ao buscar estat\xedsticas:",t),function(e){let t=String(e||"").toLowerCase();return t.includes("does not exist")||t.includes("relation")||t.includes("schema cache")||t.includes("could not find the table")}(t?.message||""))return o.NextResponse.json({success:!0,period:new URL(e.url).searchParams.get("period")||"7d",totals:{total:0,positive:0,neutral:0,negative:0,average_score:0,by_source:{}},alerts:{pending:0,by_severity:{critical:0,high:0,medium:0,low:0}},trend:[],entities:{top_positive:[],top_negative:[]},percentages:{positive:"0.0",neutral:"0.0",negative:"0.0"},note:"Schema de sentimento ainda n\xe3o foi aplicado no banco."});return o.NextResponse.json({error:"Erro interno",details:t.message},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/sentiment/stats/route",pathname:"/api/sentiment/stats",filename:"route",bundlePath:"app/api/sentiment/stats/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\sentiment\\stats\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:v,serverHooks:_}=m,y="/api/sentiment/stats/route";function f(){return(0,r.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:v})}},90176:(e,t,a)=>{a.d(t,{t:()=>s});var n=a(54128);function s(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,n.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[89276,55972,54128,20958],()=>a(64350));module.exports=n})();