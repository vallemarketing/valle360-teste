"use strict";(()=>{var e={};e.id=95592,e.ids=[95592],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},58408:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>y,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var o={};t.r(o),t.d(o,{GET:()=>p,PATCH:()=>c,dynamic:()=>u});var a=t(49303),n=t(88716),s=t(60670),i=t(87070),l=t(20344),d=t(71615);let u="force-dynamic";function _(e){let r=String(e||"").toLowerCase();return"pending"===r||"completed"===r||"error"===r?r:null}async function p(e){let r=(0,d.cookies)(),t=(0,l.createRouteHandlerClient)({cookies:()=>r}),{data:o}=await t.auth.getUser();if(!o.user?.id)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:a,error:n}=await t.rpc("is_admin");if(n||!a)return i.NextResponse.json({error:"Acesso negado (admin)"},{status:403});try{let{searchParams:r}=new URL(e.url),o=_(r.get("status"))||void 0,a=r.get("from_area")||void 0,n=r.get("to_area")||void 0,s=r.get("trigger_event")||void 0,l=Math.max(1,Math.min(500,Number(r.get("limit")||100))),d=t.from("workflow_transitions").select("*").order("created_at",{ascending:!1}).limit(l);o&&(d=d.eq("status",o)),a&&(d=d.eq("from_area",a)),n&&(d=d.eq("to_area",n)),s&&(d=d.eq("trigger_event",s));let{data:u,error:p}=await d;if(p)throw p;return i.NextResponse.json({transitions:u||[]})}catch(e){return i.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}async function c(e){let r=(0,d.cookies)(),t=(0,l.createRouteHandlerClient)({cookies:()=>r}),{data:o}=await t.auth.getUser();if(!o.user?.id)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let a=o.user.id,{data:n,error:s}=await t.rpc("is_admin");if(s||!n)return i.NextResponse.json({error:"Acesso negado (admin)"},{status:403});try{let r=await e.json(),o=r?.id,n=_(r?.status),s=r?.error_message??r?.errorMessage,l=r?.note??r?.completed_note??r?.completion_note,d=String(r?.action||"").toLowerCase()||null,u=r?.to_area??r?.toArea??r?.new_to_area??r?.newToArea??null;if(!o||!n)return i.NextResponse.json({error:"id e status s\xe3o obrigat\xf3rios"},{status:400});let{data:p}=await t.from("workflow_transitions").select("status,to_area,data_payload").eq("id",o).maybeSingle(),c=String(p?.status||"").toLowerCase(),m=String(p?.to_area||""),g=p?.data_payload||{},f=new Date().toISOString(),w=d||("pending"===n&&"completed"===c?"reopen":"pending"===n&&"error"===c?"resolve_error":null);if("pending"===n&&"reopen"===w&&"completed"!==c)return i.NextResponse.json({error:"A\xe7\xe3o inv\xe1lida: s\xf3 \xe9 poss\xedvel reabrir quando o status atual \xe9 completed"},{status:400});if("pending"===n&&"resolve_error"===w&&"error"!==c)return i.NextResponse.json({error:"A\xe7\xe3o inv\xe1lida: s\xf3 \xe9 poss\xedvel resolver erro quando o status atual \xe9 error"},{status:400});if("pending"===n&&"reroute"===w&&"pending"!==c)return i.NextResponse.json({error:"A\xe7\xe3o inv\xe1lida: s\xf3 \xe9 poss\xedvel encaminhar quando o status atual \xe9 pending"},{status:400});if("error"===n&&("mark_error"===d||null===d)&&"error"===c)return i.NextResponse.json({error:"A\xe7\xe3o inv\xe1lida: transi\xe7\xe3o j\xe1 est\xe1 em error"},{status:400});let y={status:n,error_message:"error"===n?s||"Erro informado pelo admin":null,completed_at:"completed"===n?f:null};if("error"===n){let e=l&&String(l).trim()?String(l).trim():null;e&&(y.data_payload={...g||{},marked_error_note:e,marked_error_by:a,marked_error_at:f},y.error_message=s||e)}if("completed"===n&&l&&String(l).trim()&&(y.data_payload={...g||{},completed_note:String(l),completed_by:a,completed_at:f}),"pending"===n){y.completed_at=null,y.error_message=null;let e={...g||{}},r=e.kanban_task_id||null,t=e.kanban_board_id||null,o=e.executed_at||null,n=e.executed_by||null;if(r||t||o||n){let s=Array.isArray(e.previous_executions)?e.previous_executions:[];s.push({kanban_task_id:r,kanban_board_id:t,executed_at:o,executed_by:n,reset_at:f,reset_by:a}),e.previous_executions=s,delete e.kanban_task_id,delete e.kanban_board_id,delete e.executed_at,delete e.executed_by}let s=l&&String(l).trim()?String(l).trim():null;if(s){if("resolve_error"===w)e.error_resolved_note=s,e.error_resolved_by=a,e.error_resolved_at=f;else if("reroute"===w){if(!u||!String(u).trim())return i.NextResponse.json({error:"to_area \xe9 obrigat\xf3rio para encaminhar"},{status:400});let r=String(u).trim();y.to_area=r;let t=Array.isArray(e.reroute_history)?e.reroute_history:[];t.push({from_area:m,to_area:r,note:s,rerouted_at:f,rerouted_by:a}),e.reroute_history=t,e.rerouted_from_area=m,e.rerouted_to_area=r,e.rerouted_note=s,e.rerouted_by=a,e.rerouted_at=f}else e.reopened_note=s,e.reopened_by=a,e.reopened_at=f}else if("reroute"===w){if(!u||!String(u).trim())return i.NextResponse.json({error:"to_area \xe9 obrigat\xf3rio para encaminhar"},{status:400});let r=String(u).trim();y.to_area=r;let t=Array.isArray(e.reroute_history)?e.reroute_history:[];t.push({from_area:m,to_area:r,note:null,rerouted_at:f,rerouted_by:a}),e.reroute_history=t,e.rerouted_from_area=m,e.rerouted_to_area=r,e.rerouted_note=null,e.rerouted_by=a,e.rerouted_at=f}y.data_payload=e}let{data:x,error:v}=await t.from("workflow_transitions").update(y).eq("id",o).select("*").single();if(v)throw v;try{let e=y.data_payload||g||{},r=function(e){if(!e)return null;let r=String(e);return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r)?r:null}(e?.correlation_id);await t.from("event_log").insert({event_type:"completed"===n?"workflow_transition.completed":"error"===n?"workflow_transition.marked_error":"pending"===n&&"reopen"===w?"workflow_transition.reopened":"pending"===n&&"resolve_error"===w?"workflow_transition.error_resolved":"pending"===n&&"reroute"===w?"workflow_transition.rerouted":"workflow_transition.updated",entity_type:"workflow_transition",entity_id:o,actor_user_id:a,payload:{transition_id:o,action:w,prev_status:c,next_status:n,prev_to_area:m,next_to_area:y.to_area||m,note:l||null,at:f,correlation_id:e?.correlation_id||null,client_id:e?.client_id||e?.clientId||null,proposal_id:e?.proposal_id||null,contract_id:e?.contract_id||null,invoice_id:e?.invoice_id||null},correlation_id:r,status:"processed",processed_at:f})}catch{}return i.NextResponse.json({success:!0,transition:x})}catch(e){return i.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/workflow-transitions/route",pathname:"/api/admin/workflow-transitions",filename:"route",bundlePath:"app/api/admin/workflow-transitions/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\workflow-transitions\\route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:w}=m,y="/api/admin/workflow-transitions/route";function x(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[89276,55972,54128,20958],()=>t(58408));module.exports=o})();