"use strict";(()=>{var e={};e.id=29192,e.ids=[29192],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},87561:e=>{e.exports=require("node:fs")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},33946:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>A,requestAsyncStorage:()=>b,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>y});var a={};r.r(a),r.d(a,{POST:()=>h,dynamic:()=>x});var o=r(49303),s=r(88716),n=r(60670),i=r(87070),d=r(20344),u=r(71615),l=r(98724);async function c(e,t){let r=(0,l.$J)(t);try{let t=await r.embeddings.create({model:l.JF.embedding,input:e});return{text:e,embedding:t.data[0].embedding,tokens:t.usage.total_tokens}}catch(e){throw console.error("Erro ao gerar embedding:",e),Error(`Falha ao gerar embedding: ${e.message}`)}}async function p(e,t){let r=(0,l.$J)(t);try{let t=await r.embeddings.create({model:l.JF.embedding,input:e});return t.data.map((r,a)=>({text:e[a],embedding:r.embedding,tokens:Math.floor(t.usage.total_tokens/e.length)}))}catch(e){throw console.error("Erro ao gerar embeddings em lote:",e),Error(`Falha ao gerar embeddings: ${e.message}`)}}async function m(e,t,r={}){let{topK:a=5,threshold:o=.5,apiKey:s}=r,n=await c(e,s),i=t.map(e=>e.text),d=await p(i,s);return t.map((e,t)=>({text:e.text,score:function(e,t){if(e.length!==t.length)throw Error("Vetores devem ter o mesmo tamanho");let r=0,a=0,o=0;for(let s=0;s<e.length;s++)r+=e[s]*t[s],a+=e[s]*e[s],o+=t[s]*t[s];return r/(Math.sqrt(a)*Math.sqrt(o))}(n.embedding,d[t].embedding),metadata:e.metadata})).filter(e=>e.score>=o).sort((e,t)=>t.score-e.score).slice(0,a)}async function g(e,t={}){let{numClusters:r=3,apiKey:a}=t,o=e.map(e=>e.text);return(function(e,t,r=100){let a=e.length;e[0].length;let o=[],s=new Set;for(;o.length<t;){let t=Math.floor(Math.random()*a);s.has(t)||(s.add(t),o.push([...e[t]]))}let n=Array(a).fill(0);for(let a=0;a<r;a++){let r=e.map(e=>{let t=1/0,r=0;return o.forEach((a,o)=>{let s=function(e,t){return Math.sqrt(e.reduce((e,r,a)=>e+Math.pow(r-t[a],2),0))}(e,a);s<t&&(t=s,r=o)}),r});if(function(e,t){return e.length===t.length&&e.every((e,r)=>e===t[r])}(n,r))break;n=r;for(let r=0;r<t;r++){let t=e.filter((e,t)=>n[t]===r);t.length>0&&(o[r]=t[0].map((e,r)=>t.reduce((e,t)=>e+t[r],0)/t.length))}}return o.map((e,t)=>({indices:n.map((e,r)=>e===t?r:-1).filter(e=>e>=0),centroid:e}))})((await p(o,a)).map(e=>e.embedding),r).map((t,r)=>({clusterId:r,documents:t.indices.map(t=>e[t]),centroid:t.centroid}))}let x="force-dynamic";async function h(e){try{let t;let r=(0,u.cookies)(),a=(0,d.createRouteHandlerClient)({cookies:()=>r}),{data:{user:o},error:s}=await a.auth.getUser();if(s||!o)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{action:n,data:l}=await e.json(),{data:x}=await a.from("integration_configs").select("api_key").eq("integration_id","openai").single(),h=x?.api_key||process.env.OPENAI_API_KEY;if(!h)return i.NextResponse.json({error:"OpenAI n\xe3o configurada",details:"Configure a API Key da OpenAI nas integra\xe7\xf5es"},{status:400});let f=Date.now();switch(n){case"embed":if(!l.text)return i.NextResponse.json({error:"Texto \xe9 obrigat\xf3rio"},{status:400});t=await c(l.text,h);break;case"embed_batch":if(!l.texts||!Array.isArray(l.texts))return i.NextResponse.json({error:"Array de textos \xe9 obrigat\xf3rio"},{status:400});t=await p(l.texts,h);break;case"search":if(!l.query||!l.documents)return i.NextResponse.json({error:"Query e documentos s\xe3o obrigat\xf3rios"},{status:400});t=await m(l.query,l.documents,{topK:l.topK||5,threshold:l.threshold||.5,apiKey:h});break;case"cluster":if(!l.documents||!Array.isArray(l.documents))return i.NextResponse.json({error:"Array de documentos \xe9 obrigat\xf3rio"},{status:400});t=await g(l.documents,{numClusters:l.numClusters||3,apiKey:h});break;default:return i.NextResponse.json({error:"A\xe7\xe3o inv\xe1lida"},{status:400})}let b=Date.now()-f;return await a.from("integration_logs").insert({integration_id:"openai",action:`embeddings_${n}`,status:"success",request_data:{action:n},duration_ms:b}),i.NextResponse.json({success:!0,result:t,metadata:{action:n,processingTime:b}})}catch(e){return console.error("Erro na opera\xe7\xe3o de embeddings:",e),i.NextResponse.json({error:"Erro na opera\xe7\xe3o",details:e.message},{status:500})}}let f=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/ai/embeddings/route",pathname:"/api/ai/embeddings",filename:"route",bundlePath:"app/api/ai/embeddings/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\ai\\embeddings\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:b,staticGenerationAsyncStorage:y,serverHooks:w}=f,q="/api/ai/embeddings/route";function A(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:y})}},98724:(e,t,r)=>{r.d(t,{$J:()=>s,JF:()=>n});var a=r(54214);let o=null;function s(e){let t=e||process.env.OPENAI_API_KEY;if(!t)throw Error("OpenAI API Key n\xe3o configurada");return(!o||e)&&(o=new a.ZP({apiKey:t})),o}let n={chat:"gpt-4-turbo-preview",embedding:"text-embedding-3-small",analysis:"gpt-4-turbo-preview"}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958,54214],()=>r(33946));module.exports=a})();