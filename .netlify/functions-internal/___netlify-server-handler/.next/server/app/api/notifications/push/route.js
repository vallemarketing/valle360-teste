"use strict";(()=>{var e={};e.id=36195,e.ids=[36195],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},77655:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>T,patchFetch:()=>_,requestAsyncStorage:()=>w,routeModule:()=>k,serverHooks:()=>j,staticGenerationAsyncStorage:()=>R});var a={};r.r(a),r.d(a,{DELETE:()=>E,GET:()=>x,POST:()=>h,PUT:()=>v});var n=r(49303),s=r(88716),o=r(60670),i=r(87070),c=r(90176),u=r(71615),d=r(67721);async function p(e){try{let t=(0,c.t)(),{data:r,error:a}=await t.from("notifications").insert({user_id:e.userId,type:e.type,title:e.title,body:e.body,data:e.data||{},action_url:e.actionUrl,priority:e.priority||"normal",is_read:!1,created_at:new Date().toISOString()}).select("id").single();if(a)return console.error("[PushService] Erro ao criar notifica\xe7\xe3o:",a),{success:!1,error:a.message};return{success:!0,notificationId:r?.id}}catch(e){return console.error("[PushService] Erro:",e),{success:!1,error:e.message}}}async function l(e){return p({userId:e.assigneeId,type:"task_assigned",title:"Nova tarefa atribu\xedda",body:`${e.assignerName} atribuiu a tarefa "${e.taskTitle}"${e.clientName?` para ${e.clientName}`:""}`,data:{taskId:e.taskId,assignerName:e.assignerName,clientName:e.clientName},actionUrl:`/colaborador/kanban?task=${e.taskId}`,priority:"high"})}async function m(e){return p({userId:e.recipientId,type:"new_message",title:"group"===e.conversationType?`Nova mensagem em ${e.conversationName||"grupo"}`:`Mensagem de ${e.senderName}`,body:e.messagePreview.substring(0,100)+(e.messagePreview.length>100?"...":""),data:{conversationType:e.conversationType,conversationId:e.conversationId,senderName:e.senderName},actionUrl:"group"===e.conversationType?`/app/mensagens?group=${e.conversationId}`:`/app/mensagens?conversation=${e.conversationId}`,priority:"normal"})}async function g(e){return p({userId:e.mentionedUserId,type:"mention",title:`${e.mentionerName} mencionou voc\xea`,body:e.context.substring(0,100)+(e.context.length>100?"...":""),data:{mentionerName:e.mentionerName,contextType:e.contextType,contextId:e.contextId},priority:"high"})}async function y(e){return p({userId:e.userId,type:"deadline_approaching",title:"Prazo se aproximando",body:`A tarefa "${e.taskTitle}" vence em ${e.hoursRemaining}h`,data:{taskId:e.taskId,dueDate:e.dueDate,hoursRemaining:e.hoursRemaining},actionUrl:`/colaborador/kanban?task=${e.taskId}`,priority:"high"})}async function I(e){try{let t=(0,c.t)(),{error:r}=await t.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",e);return!r}catch{return!1}}async function f(e){try{let t=(0,c.t)(),{error:r}=await t.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("user_id",e).eq("is_read",!1);return!r}catch{return!1}}async function N(){let e=(0,u.cookies)(),t=(0,d.createServerClient)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{cookies:{get:t=>e.get(t)?.value}}),{data:{user:r}}=await t.auth.getUser();return r}async function x(e){try{let t=await N();if(!t)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{searchParams:r}=new URL(e.url),a="true"===r.get("unreadOnly"),n=parseInt(r.get("limit")||"20"),s=(0,c.t)(),o=s.from("notifications").select("*").eq("user_id",t.id).order("created_at",{ascending:!1}).limit(n);a&&(o=o.eq("is_read",!1));let{data:u,error:d}=await o;if(d)return console.error("[Notifications GET] Erro:",d),i.NextResponse.json({error:"Erro ao buscar notifica\xe7\xf5es"},{status:500});let{count:p}=await s.from("notifications").select("*",{count:"exact",head:!0}).eq("user_id",t.id).eq("is_read",!1);return i.NextResponse.json({success:!0,notifications:u||[],unreadCount:p||0})}catch(e){return console.error("[Notifications GET] Erro:",e),i.NextResponse.json({success:!1,error:e.message||"Erro interno"},{status:500})}}async function h(e){try{let t;let r=await N();if(!r)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{action:a,...n}=await e.json();switch(a){case"create":t=await p({userId:n.userId||r.id,type:n.type||"system",title:n.title,body:n.body,data:n.data,actionUrl:n.actionUrl,priority:n.priority});break;case"task_assigned":t=await l({assigneeId:n.assigneeId,taskId:n.taskId,taskTitle:n.taskTitle,assignerName:n.assignerName,clientName:n.clientName});break;case"new_message":t=await m({recipientId:n.recipientId,senderName:n.senderName,messagePreview:n.messagePreview,conversationType:n.conversationType,conversationId:n.conversationId,conversationName:n.conversationName});break;case"mention":t=await g({mentionedUserId:n.mentionedUserId,mentionerName:n.mentionerName,context:n.context,contextType:n.contextType,contextId:n.contextId});break;case"deadline":t=await y({userId:n.userId,taskId:n.taskId,taskTitle:n.taskTitle,dueDate:n.dueDate,hoursRemaining:n.hoursRemaining});break;default:return i.NextResponse.json({error:"A\xe7\xe3o inv\xe1lida"},{status:400})}return i.NextResponse.json(t)}catch(e){return console.error("[Notifications POST] Erro:",e),i.NextResponse.json({success:!1,error:e.message||"Erro interno"},{status:500})}}async function v(e){try{let t=await N();if(!t)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{notificationId:r,markAll:a}=await e.json(),n=!1;if(a)n=await f(t.id);else{if(!r)return i.NextResponse.json({error:"Par\xe2metro inv\xe1lido"},{status:400});n=await I(r)}return i.NextResponse.json({success:n})}catch(e){return console.error("[Notifications PUT] Erro:",e),i.NextResponse.json({success:!1,error:e.message||"Erro interno"},{status:500})}}async function E(e){try{let t=await N();if(!t)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{searchParams:r}=new URL(e.url),a=r.get("id");if(!a)return i.NextResponse.json({error:"ID da notifica\xe7\xe3o \xe9 obrigat\xf3rio"},{status:400});let n=(0,c.t)(),{error:s}=await n.from("notifications").delete().eq("id",a).eq("user_id",t.id);if(s)return console.error("[Notifications DELETE] Erro:",s),i.NextResponse.json({error:"Erro ao deletar notifica\xe7\xe3o"},{status:500});return i.NextResponse.json({success:!0})}catch(e){return console.error("[Notifications DELETE] Erro:",e),i.NextResponse.json({success:!1,error:e.message||"Erro interno"},{status:500})}}let k=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/notifications/push/route",pathname:"/api/notifications/push",filename:"route",bundlePath:"app/api/notifications/push/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\notifications\\push\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:w,staticGenerationAsyncStorage:R,serverHooks:j}=k,T="/api/notifications/push/route";function _(){return(0,o.patchFetch)({serverHooks:j,staticGenerationAsyncStorage:R})}},90176:(e,t,r)=>{r.d(t,{t:()=>n});var a=r(54128);function n(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,a.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,39702],()=>r(77655));module.exports=a})();