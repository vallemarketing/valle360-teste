"use strict";(()=>{var e={};e.id=27618,e.ids=[27618],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},72281:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>w,requestAsyncStorage:()=>y,routeModule:()=>S,serverHooks:()=>h,staticGenerationAsyncStorage:()=>x});var a={};r.r(a),r.d(a,{POST:()=>g,dynamic:()=>m});var n=r(49303),i=r(88716),o=r(60670),s=r(87070),l=r(20344),u=r(71615),d=r(90176),p=r(57157);let m="force-dynamic";function c(e){return String(e||"").trim().toLowerCase()}async function f(){let e=(0,u.cookies)(),t=(0,l.createRouteHandlerClient)({cookies:()=>e}),{data:r}=await t.auth.getUser();if(!r.user?.id)return{ok:!1,res:s.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:a,error:n}=await t.rpc("is_admin");return n||!a?{ok:!1,res:s.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,actorUserId:r.user.id}}async function _(e){let t=(0,d.t)(),r=c(e);if(!r)return{userId:null};for(let e=1;e<=50;e++){let{data:a,error:n}=await t.auth.admin.listUsers({page:e,perPage:200});if(n)break;let i=a?.users||[],o=i.find(e=>c(String(e.email||""))===r);if(o?.id){let e=o.user_metadata||{},t=e.full_name||e.name||null;return{userId:o.id,fullName:t}}if(i.length<200)break}return{userId:null}}async function g(e){let t=await f();if(!t.ok)return t.res;try{let a=await e.json(),n=c(a?.email),i=(Array.isArray(a?.areas)?a.areas:[]).map(e=>String(e).trim()).filter(Boolean);if(!n)return s.NextResponse.json({error:"Email \xe9 obrigat\xf3rio"},{status:400});if(0===i.length)return s.NextResponse.json({error:"Selecione ao menos 1 \xe1rea"},{status:400});for(let e of i)if(!p.iN[e])return s.NextResponse.json({error:`\xc1rea inv\xe1lida: ${e}`},{status:400});let o=(0,d.t)(),l=null,u=null;{var r;let{data:e}=await o.from("users").select("id,email,full_name,name,role,user_type").eq("email",n).maybeSingle();e?.id&&(r=String(e.id),/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r))&&(l=String(e.id),u=e)}let m=null;if(!l){let e=await _(n);l=e.userId,m=e.fullName||null}if(!l)return s.NextResponse.json({error:"Usu\xe1rio n\xe3o encontrado no Auth. Confirme o email e se ele consegue logar."},{status:404});let f=(a?.fullName?String(a.fullName).trim():"")||u?.full_name||u?.name||m||n,g=["admin","super_admin"].includes(String(u?.role||"").toLowerCase())?u.role:"employee";await o.from("users").upsert({id:l,email:n,full_name:f,name:f,role:g,user_type:"employee",account_status:"active",is_active:!0,email_verified:!0,created_by:t.actorUserId,updated_at:new Date().toISOString()},{onConflict:"id"}),await o.from("user_profiles").upsert({id:l,user_id:l,email:n,full_name:f,user_type:"employee",role:"employee",is_active:!0},{onConflict:"id"});let S=i[0],y=i.join(", "),x=a?.avatarUrl?String(a.avatarUrl).trim():`https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(n)}`,h=a?.phone?String(a.phone).trim():null,{data:v}=await o.from("employees").select("id,user_id").eq("user_id",l).maybeSingle();return v?.id?await o.from("employees").update({full_name:f,email:n,phone:h,avatar:x,department:S,area_of_expertise:y,areas:i,is_active:!0,updated_at:new Date().toISOString()}).eq("id",v.id):await o.from("employees").insert({user_id:l,full_name:f,email:n,phone:h,avatar:x,department:S,position:"Colaborador",area_of_expertise:y,hire_date:new Date().toISOString().slice(0,10),is_active:!0,first_name:String(f).split(" ")[0]||f,last_name:String(f).split(" ").slice(1).join(" ")||"",whatsapp:h,admission_date:new Date().toISOString().slice(0,10),areas:i,photo_url:a?.photoUrl?String(a.photoUrl).trim():null}),s.NextResponse.json({success:!0,userId:l,email:n,fullName:f,areas:i,note:"V\xednculo conclu\xeddo. O colaborador deve ver apenas o(s) board(s) da(s) \xe1rea(s) ao logar."})}catch(e){return s.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let S=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/link-employee/route",pathname:"/api/admin/link-employee",filename:"route",bundlePath:"app/api/admin/link-employee/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\link-employee\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:x,serverHooks:h}=S,v="/api/admin/link-employee/route";function w(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:x})}},90176:(e,t,r)=>{r.d(t,{t:()=>n});var a=r(54128);function n(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,a.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958,57157],()=>r(72281));module.exports=a})();