"use strict";exports.id=79263,exports.ids=[79263],exports.modules={90176:(e,t,a)=>{a.d(t,{t:()=>r});var i=a(54128);function r(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,i.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},79263:(e,t,a)=>{a.d(t,{t:()=>n});var i=a(90176);class r{db(){return(0,i.t)()}isMissingTableError(e){let t=String(e||"").toLowerCase();return t.includes("does not exist")||t.includes("relation")||t.includes("schema cache")||t.includes("could not find the table")}clamp(e,t=0,a=100){return Number.isFinite(e)?Math.max(t,Math.min(a,e)):t}daysBetween(e,t){return Math.floor((e.getTime()-t.getTime())/864e5)}async predictChurn(e){try{let t=[],a=30;try{let{data:i}=await this.db().from("client_health_scores").select("churn_probability").eq("client_id",e).maybeSingle(),r=i?.churn_probability!=null?Number(i.churn_probability):null;null!=r&&Number.isFinite(r)&&(a=this.clamp(r,0,100),t.push({name:"Health Score (base)",weight:.35,value:a,impact:a>=60?"negative":"neutral",description:`Probabilidade de churn (health score): ${Math.round(a)}%`}))}catch(e){this.isMissingTableError(e?.message||"")}let i=await this.getEngagementMetrics(e);i.score<40&&(a+=25,t.push({name:"Baixo engajamento",weight:.25,value:i.score,impact:"negative",description:`Engajamento ${i.score}% abaixo da m\xe9dia`}));let r=await this.getPaymentHistory(e);r.late_payments>2&&(a+=20,t.push({name:"Hist\xf3rico de atrasos",weight:.2,value:r.late_payments,impact:"negative",description:`${r.late_payments} pagamentos atrasados nos \xfaltimos 6 meses`}));let n=await this.getLastContactDate(e),o=Math.floor((Date.now()-n.getTime())/864e5);o>14&&(a+=15,t.push({name:"Sem contato recente",weight:.15,value:o,impact:"negative",description:`${o} dias sem intera\xe7\xe3o`}));let s=await this.getSatisfactionScore(e);s<7&&(a+=20,t.push({name:"Baixa satisfa\xe7\xe3o",weight:.2,value:s,impact:"negative",description:`NPS ${s}/10`}));let l=await this.getMetricsTrend(e);"declining"===l.trend&&(a+=20,t.push({name:"M\xe9tricas em queda",weight:.2,value:l.change,impact:"negative",description:`Queda de ${Math.abs(l.change)}% nas m\xe9tricas`})),a=this.clamp(a,0,100);let c=Math.min(95,45+10*t.length),d={type:"churn",entity_type:"client",entity_id:e,prediction_value:a,confidence:c,factors:t,recommendation:this.generateChurnRecommendation(a,t),created_at:new Date().toISOString(),valid_until:new Date(Date.now()+2592e6).toISOString()};return await this.savePrediction(d),d}catch(e){return console.error("Erro ao prever churn:",e),null}}async predictConversion(e){try{let t=[],a=50,i=null;try{let{data:t}=await this.db().from("prospecting_leads").select("*").eq("id",e).maybeSingle();i=t||null}catch(e){if(!this.isMissingTableError(e?.message||""))throw e}if(!i){let{data:t}=await this.db().from("leads").select("*").eq("id",e).maybeSingle();i=t||null}if(!i)return null;let r=Number(i.score??i.qualification_score??0);r>=80&&(a+=20,t.push({name:"Lead qualificado",weight:.25,value:r,impact:"positive",description:`Score ${r}/100`}));let n=String(i.industry||i.company_industry||i.segment||"Outros"),o={"E-commerce":.35,SaaS:.4,Varejo:.25,Tecnologia:.45,Saúde:.3}[n]||.25;a+=30*o,t.push({name:"Taxa do setor",weight:.2,value:100*o,impact:o>.3?"positive":"neutral",description:`Setor ${n} com taxa de ${(100*o).toFixed(0)}%`});let s=await this.getLeadInteractions(e);s.total>=3&&(a+=15,t.push({name:"M\xfaltiplas intera\xe7\xf5es",weight:.2,value:s.total,impact:"positive",description:`${s.total} intera\xe7\xf5es registradas`}));let l=Math.floor((Date.now()-new Date(i.created_at).getTime())/864e5);l>30&&(a-=10,t.push({name:"Lead antigo",weight:.15,value:l,impact:"negative",description:`${l} dias no pipeline`}));let c=Math.min(90,40+12*t.length);a=this.clamp(a,0,100);let d={type:"conversion",entity_type:"lead",entity_id:e,entity_name:i.company_name||i.name||void 0,prediction_value:a,confidence:c,factors:t,recommendation:this.generateConversionRecommendation(a,i),created_at:new Date().toISOString(),valid_until:new Date(Date.now()+12096e5).toISOString()};return await this.savePrediction(d),d}catch(e){return console.error("Erro ao prever convers\xe3o:",e),null}}async predictDelay(e){try{let{data:t}=await this.db().from("kanban_tasks").select("id, title, assigned_to, priority, estimated_hours, due_date, created_at, updated_at, column_id, board_id, status").eq("id",e).maybeSingle();if(!t)return null;let a=[],i=20;if(t.assigned_to){let e=await this.getEmployeeDeliveryHistory(t.assigned_to);e.late_rate>20&&(i+=.5*e.late_rate,a.push({name:"Hist\xf3rico de atrasos",weight:.3,value:e.late_rate,impact:"negative",description:`${e.late_rate}% de entregas atrasadas`}))}if(("high"===t.priority||t.estimated_hours>8)&&(i+=15,a.push({name:"Alta complexidade",weight:.25,value:t.estimated_hours||8,impact:"negative",description:`Tarefa estimada em ${t.estimated_hours||8}h`})),t.due_date){let e=Math.floor((new Date(t.due_date).getTime()-Date.now())/864e5);e<2&&"done"!==t.status&&(i+=25,a.push({name:"Prazo iminente",weight:.25,value:e,impact:"negative",description:`Apenas ${e} dias at\xe9 o prazo`}))}let r=Math.min(85,35+15*a.length),n={type:"delay",entity_type:"task",entity_id:e,entity_name:t.title,prediction_value:this.clamp(i,0,100),confidence:r,factors:a,recommendation:i>50?"Considere realocar recursos ou ajustar prazo":"Monitorar progresso normalmente",created_at:new Date().toISOString(),valid_until:new Date(Date.now()+6048e5).toISOString()};return await this.savePrediction(n),n}catch(e){return console.error("Erro ao prever atraso:",e),null}}async predictRevenue(e){try{let t=new Date,a=new Date(t.getTime()-10368e6),i={},r=!1;try{let{data:e}=await this.db().from("invoices").select("amount, paid_at").not("paid_at","is",null).gte("paid_at",a.toISOString()).limit(5e3);for(let t of e||[]){let e=t?.paid_at?new Date(String(t.paid_at)):null;if(!e||Number.isNaN(e.getTime()))continue;let a=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`;i[a]=(i[a]||0)+Number(t?.amount||0)}r=Object.keys(i).length>0}catch(e){if(!this.isMissingTableError(e?.message||""))throw e}let n=Object.keys(i).sort().reverse(),o=n.slice(0,3).map(e=>i[e]||0),s=0,l=0;if(r&&o.length>=2&&o.some(e=>e>0))s=o.reduce((e,t)=>e+t,0)/o.length,l=this.calculateTrend(o);else try{let{data:e}=await this.db().from("contracts").select("value, status").eq("status","active").limit(5e3),t=(e||[]).reduce((e,t)=>e+Number(t?.value||0),0);if(!t)return null;s=t,l=0}catch(e){if(this.isMissingTableError(e?.message||""))return null;throw e}let c=[.9,.85,.95,1,1.05,1,.95,.9,1,1.1,1.2,1.15][new Date().getMonth()],d=s*(1+l)*c,m=[{name:"M\xe9dia hist\xf3rica",weight:.4,value:s,impact:"neutral",description:`M\xe9dia dos \xfaltimos 3 meses: R$ ${s.toLocaleString("pt-BR")}`},{name:"Tend\xeancia",weight:.35,value:100*l,impact:l>0?"positive":"negative",description:`Tend\xeancia de ${(100*l).toFixed(1)}%`},{name:"Sazonalidade",weight:.25,value:(c-1)*100,impact:c>1?"positive":"negative",description:`Ajuste sazonal de ${((c-1)*100).toFixed(0)}%`}],u={type:"revenue",entity_type:"system",entity_id:"all",entity_name:"month"===e?"Pr\xf3ximo M\xeas":"Pr\xf3ximo Trimestre",prediction_value:Math.round(d*("quarter"===e?3:1)),confidence:Math.min(80,55+(r?2*Math.min(10,n.length):0)),factors:m,recommendation:l>.05?"Tend\xeancia positiva - considere expandir capacidade":l<-.05?"Tend\xeancia negativa - revisar estrat\xe9gia comercial":"Receita est\xe1vel - manter estrat\xe9gia atual",created_at:new Date().toISOString(),valid_until:new Date(Date.now()+("month"===e?30:90)*864e5).toISOString()};return await this.savePrediction(u),u}catch(e){return console.error("Erro ao prever receita:",e),null}}async predictUpsellOpportunities(e){try{let{data:t}=await this.db().from("clients").select("*").eq("id",e).maybeSingle();if(!t)return null;let a=[];try{let{data:t}=await this.db().from("client_services").select("service_type").eq("client_id",e).limit(200);a=(t||[]).map(e=>String(e?.service_type||"")).filter(Boolean)}catch(e){this.isMissingTableError(e?.message||"")}let i=[],r=30,n={social_media:["trafego_pago","design","video"],trafego_pago:["social_media","landing_page","email_marketing"],design:["social_media","video","branding"],video:["social_media","trafego_pago"],site:["seo","trafego_pago","manutencao"]},o=[];for(let e of a)for(let t of n[e]||[])a.includes(t)||o.includes(t)||(o.push(t),r+=10);o.length>0&&i.push({name:"Servi\xe7os complementares",weight:.4,value:o.length,impact:"positive",description:`${o.length} servi\xe7os recomendados`});let s=await this.getMetricsTrend(e);"growing"===s.trend&&s.change>20&&(r+=20,i.push({name:"Cliente em crescimento",weight:.3,value:s.change,impact:"positive",description:`Crescimento de ${s.change}% - momento ideal para expandir`}));let l=Math.floor((Date.now()-new Date(t.created_at).getTime())/2592e6);l>=6&&(r+=15,i.push({name:"Cliente fidelizado",weight:.3,value:l,impact:"positive",description:`${l} meses de relacionamento`}));let c={type:"upsell",entity_type:"client",entity_id:e,entity_name:t.company_name,prediction_value:Math.min(100,r),confidence:Math.min(85,40+15*i.length),factors:i,recommendation:o.length>0?`Servi\xe7os recomendados: ${o.join(", ")}`:"Cliente j\xe1 possui pacote completo",created_at:new Date().toISOString(),valid_until:new Date(Date.now()+2592e6).toISOString()};return await this.savePrediction(c),c}catch(e){return console.error("Erro ao prever upsell:",e),null}}async predictPaymentRisk(e){try{let t=[],a=new Date,i=new Date(a.getTime()-15552e6),r=0,n=0,o=0,s=0,{data:l}=await this.db().from("clients").select("id, company_name").eq("id",e).maybeSingle();try{let{data:t}=await this.db().from("invoices").select("due_date, paid_at, status, amount").eq("client_id",e).gte("due_date",i.toISOString()).limit(5e3);for(let e of t||[]){let t=e?.due_date?new Date(String(e.due_date)):null;if(!t||Number.isNaN(t.getTime()))continue;let i=e?.paid_at?new Date(String(e.paid_at)):null,l=!!i&&!Number.isNaN(i.getTime()),c=String(e?.status||"").toLowerCase(),d=!l&&"paid"!==c;if(d&&(s+=1),l&&i.getTime()>t.getTime()&&(o+=1),d&&t.getTime()<a.getTime()){r+=1;let e=this.daysBetween(a,t);n=Math.max(n,e)}}}catch(e){if(this.isMissingTableError(e?.message||""))return null;throw e}let c=10;s>0&&(c+=10),r>0&&(c+=20*r),o>0&&(c+=10*o),n>0&&(c+=Math.min(30,1.2*n)),c=this.clamp(c,0,100),t.push({name:"Faturas em aberto",weight:.25,value:s,impact:s>0?"negative":"neutral",description:`${s} fatura(s) em aberto`}),t.push({name:"Faturas vencidas",weight:.35,value:r,impact:r>0?"negative":"neutral",description:`${r} fatura(s) vencida(s)`}),t.push({name:"Dias em atraso (m\xe1x)",weight:.25,value:n,impact:n>0?"negative":"neutral",description:n>0?`${n} dias`:"Sem atraso"}),t.push({name:"Pagamentos pagos em atraso",weight:.15,value:o,impact:o>0?"negative":"neutral",description:`${o} pagamento(s) atrasado(s) nos \xfaltimos 6 meses`});let d=c>=70?"\uD83D\uDEA8 Alto risco: acionar cobran\xe7a via Intranet/Email/WhatsApp e renegociar":c>=45?"⚠️ M\xe9dio risco: lembrar vencimento e acompanhar":"✅ Baixo risco: manter acompanhamento normal",m={type:"payment_risk",entity_type:"client",entity_id:e,entity_name:l?.company_name||void 0,prediction_value:c,confidence:Math.min(90,55+8*t.length),factors:t,recommendation:d,created_at:new Date().toISOString(),valid_until:new Date(Date.now()+12096e5).toISOString()};return await this.savePrediction(m),m}catch(e){return console.error("Erro ao prever risco de pagamento:",e),null}}async predictLtv(e){try{let t=[],{data:a}=await this.db().from("clients").select("id, company_name").eq("id",e).maybeSingle(),i=0;try{let{data:t}=await this.db().from("contracts").select("value, status").eq("client_id",e).eq("status","active").limit(2e3);i=(t||[]).reduce((e,t)=>e+Number(t?.value||0),0)}catch(e){if(!this.isMissingTableError(e?.message||""))throw e}let r=30;try{let{data:t}=await this.db().from("client_health_scores").select("churn_probability").eq("client_id",e).maybeSingle();t?.churn_probability!=null&&(r=this.clamp(Number(t.churn_probability),0,100))}catch{}let n=Math.max(.02,Math.min(.5,r/100)),o=Math.min(36,Math.max(3,Math.round(1/n))),s=Math.max(0,Math.round(i*o));t.push({name:"MRR (contratos ativos)",weight:.45,value:i,impact:i>0?"positive":"neutral",description:`MRR estimado: R$ ${i.toLocaleString("pt-BR")}`}),t.push({name:"Churn (health score)",weight:.35,value:r,impact:r>=60?"negative":"neutral",description:`Churn estimado: ${Math.round(r)}%`}),t.push({name:"Lifetime estimado (meses)",weight:.2,value:o,impact:o>=12?"positive":"neutral",description:`Lifetime estimado: ${o} meses`});let l={type:"ltv",entity_type:"client",entity_id:e,entity_name:a?.company_name||void 0,prediction_value:s,confidence:Math.min(85,50+10*t.length),factors:t,recommendation:r>=60?"Priorizar reten\xe7\xe3o para proteger LTV":"Cliente saud\xe1vel: explorar upsell/cross-sell",created_at:new Date().toISOString(),valid_until:new Date(Date.now()+2592e6).toISOString()};return await this.savePrediction(l),l}catch(e){return console.error("Erro ao prever LTV:",e),null}}async predictDemandCapacity(e="month"){try{let t=new Date,a="quarter"===e?180:90,i=new Date(t.getTime()-864e5*a),r=0,n=0;try{let{data:e}=await this.db().from("kanban_tasks").select("created_at").gte("created_at",i.toISOString()).limit(5e3);r=(e||[]).length,n=Math.round(r/Math.max(1,a/7))}catch(e){if(this.isMissingTableError(e?.message||""))return null}let o=0;try{let{data:e}=await this.db().from("employees").select("id, is_active").limit(5e3);o=(e||[]).filter(e=>e?.is_active!==!1).length}catch{o=0}let s=o>0?20*o:0,l=s>0?n/s*100:0,c=this.clamp(l,0,100),d=[{name:"Tarefas por semana",weight:.45,value:n,impact:"neutral",description:`M\xe9dia: ${n}/semana (\xfaltimos ${a} dias)`},{name:"Colaboradores ativos",weight:.25,value:o,impact:o>0?"positive":"neutral",description:`${o} colaboradores ativos`},{name:"Capacidade estimada",weight:.3,value:s,impact:s>0?"positive":"neutral",description:`Capacidade: ${s}/semana (heur\xedstica)`}],m={type:"demand_capacity",entity_type:"system",entity_id:"all",entity_name:"month"===e?"Demanda/Capacidade (30d)":"Demanda/Capacidade (trimestre)",prediction_value:c,confidence:Math.min(80,45+10*d.length),factors:d,recommendation:c>=85?"\uD83D\uDEA8 Capacidade cr\xedtica: redistribuir demandas e revisar prioridades":c>=65?"⚠️ Capacidade pressionada: planejar refor\xe7o/automa\xe7\xe3o":"✅ Capacidade saud\xe1vel",created_at:new Date().toISOString(),valid_until:new Date(Date.now()+("month"===e?30:90)*864e5).toISOString()};return await this.savePrediction(m),m}catch(e){return console.error("Erro ao prever demanda/capacidade:",e),null}}async predictBudgetOverrun(e){try{let t=[],{data:a}=await this.db().from("campaigns").select("id, name, client_id, status, start_date, end_date").eq("id",e).maybeSingle();if(!a)return null;let{data:i}=await this.db().from("campaign_budgets").select("budget_type, budget_amount, spent_amount, remaining_amount, period_start, period_end, updated_at").eq("campaign_id",e).limit(50),r=i||[];if(!r.length)return null;let n=e=>"total"===e?3:"monthly"===e?2:1,o=r.slice().sort((e,t)=>n(String(t?.budget_type||""))-n(String(e?.budget_type||"")))[0],s=Number(o?.budget_amount||0),l=Number(o?.spent_amount||0),c=o?.remaining_amount!=null?Number(o.remaining_amount):s-l;if(!Number.isFinite(s)||s<=0)return null;let d=l/s*100,m=c/s*100,u=0;u=d>=100?95+Math.min(5,(d-100)/10):this.clamp(100-m,0,95);try{let e=a?.start_date?new Date(String(a.start_date)):null,i=a?.end_date?new Date(String(a.end_date)):null;if(e&&i&&!Number.isNaN(e.getTime())&&!Number.isNaN(i.getTime())){let a=Math.max(1,this.daysBetween(i,e)),r=Math.max(0,Math.min(a,this.daysBetween(new Date,e)))/a*100;d>r+10&&(u=this.clamp(u+10,0,100)),t.push({name:"Ritmo vs tempo",weight:.2,value:Math.round(d-r),impact:d>r+10?"negative":"neutral",description:`Gasto ${d.toFixed(0)}% vs tempo ${r.toFixed(0)}%`})}}catch{}t.push({name:"Or\xe7amento",weight:.35,value:s,impact:"neutral",description:`Budget ${String(o?.budget_type||"").toUpperCase()}: R$ ${s.toLocaleString("pt-BR")}`}),t.push({name:"Gasto",weight:.35,value:l,impact:d>=80?"negative":"neutral",description:`Gasto: R$ ${l.toLocaleString("pt-BR")} (${d.toFixed(0)}%)`}),t.push({name:"Restante",weight:.1,value:c,impact:m<=20?"negative":"neutral",description:`Restante: R$ ${c.toLocaleString("pt-BR")} (${m.toFixed(0)}%)`});let p=u>=85?"\uD83D\uDEA8 Risco cr\xedtico: pausar/ajustar campanha e revisar budget com o cliente":u>=60?"⚠️ Risco m\xe9dio: otimizar criativos/segmenta\xe7\xe3o e acompanhar daily":"✅ Or\xe7amento sob controle",g={type:"budget_overrun",entity_type:"campaign",entity_id:e,entity_name:a?.name||void 0,prediction_value:this.clamp(u,0,100),confidence:Math.min(85,50+8*Math.min(5,t.length)),factors:t,recommendation:p,created_at:new Date().toISOString(),valid_until:new Date(Date.now()+6048e5).toISOString()};return await this.savePrediction(g),g}catch(e){if(this.isMissingTableError(e?.message||""))return null;return console.error("Erro ao prever estouro de or\xe7amento:",e),null}}async predictTaskBudgetOverrun(e){try{let{data:t}=await this.db().from("kanban_tasks").select("id, title, priority, estimated_hours, due_date, created_at, updated_at, status, reference_links").eq("id",e).maybeSingle();if(!t)return null;let a=t?.reference_links||{},i=a?.stage_forms||{},r=["total_budget","budget","marketing_budget","daily_budget","lifetime_budget"],n=[],o=e=>{if(e&&"object"==typeof e)for(let t of r){let a=Number(e?.[t]);Number.isFinite(a)&&a>0&&n.push(a)}};for(let e of Object.keys(i))o(i[e]);o(a);let s=n.length?Math.max(...n):null,l=Number(t?.estimated_hours||0);if(!s&&!l)return null;let c=15,d=[];null!=s&&(d.push({name:"Or\xe7amento planejado",weight:.35,value:s,impact:"neutral",description:`Or\xe7amento: R$ ${s.toLocaleString("pt-BR")}`}),s<1e3?c+=20:s<5e3?c+=12:s<15e3?c+=6:c+=3),l&&(c+=Math.min(40,3*l),d.push({name:"Esfor\xe7o estimado",weight:.3,value:l,impact:l>=12?"negative":"neutral",description:`Estimativa: ${l}h`}));let m=String(t?.priority||"").toLowerCase();if((m.includes("urgent")||m.includes("urgente")||m.includes("alta")||m.includes("high"))&&(c+=10,d.push({name:"Prioridade alta",weight:.1,value:1,impact:"negative",description:"Tarefa urgente/alta tende a sofrer scope creep e retrabalho"})),t?.due_date){let e=new Date(String(t.due_date)),a=Math.floor((e.getTime()-Date.now())/864e5);Number.isNaN(e.getTime())||(a<0?c+=30:a<=2?c+=15:a<=7&&(c+=8),d.push({name:"Proximidade do prazo",weight:.15,value:a,impact:a<=2?"negative":"neutral",description:a<0?`Atraso: ${Math.abs(a)} dias`:`${a} dias at\xe9 o prazo`}))}let u=t?.created_at?new Date(String(t.created_at)):null;if(u&&!Number.isNaN(u.getTime())){let e=this.daysBetween(new Date,u);e>21?c+=12:e>14?c+=8:e>7&&(c+=4),d.push({name:"Idade da tarefa",weight:.1,value:e,impact:e>14?"negative":"neutral",description:`${e} dias desde cria\xe7\xe3o`})}if(null!=s&&l){let e=s/Math.max(1,l);e<120?c+=18:e<200&&(c+=10),d.push({name:"Or\xe7amento por hora (heur\xedstica)",weight:.2,value:Math.round(e),impact:e<120?"negative":e<200?"neutral":"positive",description:`≈ R$ ${Math.round(e)}/h`})}let p=(c=this.clamp(c,0,100))>=75?"\uD83D\uDEA8 Alto risco: revisar escopo, aprova\xe7\xf5es e limites de budget (criar checkpoints)":c>=55?"⚠️ M\xe9dio risco: acompanhar burn semanal e evitar retrabalho":"✅ Baixo risco: manter controle normal",g={type:"budget_overrun",entity_type:"task",entity_id:e,entity_name:t?.title||void 0,prediction_value:c,confidence:Math.min(85,45+8*d.length),factors:d,recommendation:p,created_at:new Date().toISOString(),valid_until:new Date(Date.now()+12096e5).toISOString()};return await this.savePrediction(g),g}catch(e){return console.error("Erro ao prever estouro de or\xe7amento:",e),null}}async getEngagementMetrics(e){try{let t=new Date(Date.now()-12096e5).toISOString().slice(0,10),{data:a,error:i}=await this.db().from("social_account_metrics_daily").select("metrics, metric_date").eq("client_id",e).gte("metric_date",t).limit(5e3);if(i)throw i;let r=0,n=0;for(let e of a||[]){let t=e?.metrics&&"object"==typeof e.metrics?e.metrics:{};r+=Number(t.reach??t.total_reach??0),n+=Number(t.engagement??t.total_engagement??0)}if(r<=0)return{score:60};let o=n/r*100,s=this.clamp(2*o,0,100);return{score:Number.isFinite(s)?s:60}}catch(t){if(this.isMissingTableError(t?.message||""))try{let t=new Date(Date.now()-2592e6).toISOString().slice(0,10),{data:a}=await this.db().from("social_metrics").select("engagement_rate, metric_date").eq("client_id",e).gte("metric_date",t).order("metric_date",{ascending:!1}).limit(30),i=(a||[]).map(e=>Number(e?.engagement_rate||0)).filter(e=>Number.isFinite(e));if(0===i.length)return{score:60};let r=i.reduce((e,t)=>e+t,0)/i.length;return{score:this.clamp(2*r,0,100)}}catch{}return{score:60}}}async getPaymentHistory(e){let t=new Date,a=new Date(t.getTime()-15552e6);try{let{data:i,error:r}=await this.db().from("invoices").select("due_date, paid_at, status").eq("client_id",e).gte("due_date",a.toISOString()).limit(5e3);if(r)throw r;let n=0;for(let e of i||[]){let a=e?.due_date?new Date(String(e.due_date)):null;if(!a||Number.isNaN(a.getTime()))continue;let i=e?.paid_at?new Date(String(e.paid_at)):null,r=!!i&&!Number.isNaN(i.getTime()),o=String(e?.status||"").toLowerCase(),s=!r&&"paid"!==o;r&&i.getTime()>a.getTime()&&(n+=1),s&&a.getTime()<t.getTime()&&(n+=1)}return{late_payments:n}}catch(e){return this.isMissingTableError(e?.message||""),{late_payments:0}}}async getLastContactDate(e){try{let{data:t}=await this.db().from("event_log").select("created_at").eq("entity_type","client").eq("entity_id",e).order("created_at",{ascending:!1}).limit(1),a=(t||[])[0]?.created_at;if(a){let e=new Date(String(a));if(!Number.isNaN(e.getTime()))return e}}catch(e){}try{let{data:t}=await this.db().from("clients").select("updated_at, created_at").eq("id",e).maybeSingle(),a=t?.updated_at||t?.created_at||null;if(a){let e=new Date(String(a));if(!Number.isNaN(e.getTime()))return e}}catch{}return new Date(Date.now()-12096e5)}async getSatisfactionScore(e){try{let{data:t}=await this.db().from("nps_feedback").select("score, created_at").eq("client_id",e).order("created_at",{ascending:!1}).limit(3),a=(t||[]).map(e=>Number(e?.score)).filter(e=>Number.isFinite(e));if(0===a.length)return 8;let i=a.reduce((e,t)=>e+t,0)/a.length;return Math.max(0,Math.min(10,i))}catch(e){return this.isMissingTableError(e?.message||""),8}}async getMetricsTrend(e){try{let t=new Date(Date.now()-24192e5).toISOString().slice(0,10),{data:a,error:i}=await this.db().from("social_account_metrics_daily").select("metrics, metric_date").eq("client_id",e).gte("metric_date",t).order("metric_date",{ascending:!1}).limit(60);if(i)throw i;let r=a||[];if(r.length<6)return{trend:"stable",change:0};let n=r.map(e=>{let t=e?.metrics&&"object"==typeof e.metrics?e.metrics:{},a=Number(t.reach??t.total_reach??0),i=Number(t.engagement??t.total_engagement??0),r=a>0?i/a*100:0;return Number.isFinite(r)?r:0}).filter(e=>Number.isFinite(e)),o=e=>e.length?e.reduce((e,t)=>e+t,0)/e.length:0,s=o(n.slice(0,7)),l=o(n.slice(7,14)),c=l>0?(s-l)/l*100:0;return{trend:c>=5?"growing":c<=-5?"declining":"stable",change:Math.round(c)}}catch(e){return this.isMissingTableError(e?.message||""),{trend:"stable",change:0}}}async getLeadInteractions(e){try{let{data:t}=await this.db().from("prospecting_leads").select("status, last_interaction_at, source_details").eq("id",e).maybeSingle();if(!t)return{total:1};let a=String(t.status||"").toLowerCase(),i=t.last_interaction_at?new Date(String(t.last_interaction_at)):null,r=i&&!Number.isNaN(i.getTime())&&7>=this.daysBetween(new Date,i)?1:0,n=t.source_details,o=n&&"object"==typeof n&&Array.isArray(n.interactions)?n.interactions.length:0;return{total:Math.max(1,("qualified"===a?4:"contacted"===a?3:"new"===a?1:2)+r+o)}}catch(e){return this.isMissingTableError(e?.message||""),{total:1}}}async getEmployeeDeliveryHistory(e){try{let t=new Date(Date.now()-7776e6).toISOString(),{data:a}=await this.db().from("kanban_tasks").select("due_date, updated_at, status").eq("assigned_to",e).gte("updated_at",t).limit(5e3),i=(a||[]).filter(e=>"done"===String(e?.status||"").toLowerCase()).filter(e=>!!e?.due_date);if(0===i.length)return{late_rate:0};let r=i.filter(e=>{let t=new Date(String(e.due_date)),a=new Date(String(e.updated_at));return!(Number.isNaN(t.getTime())||Number.isNaN(a.getTime()))&&a.getTime()>t.getTime()}).length/i.length*100;return{late_rate:Math.round(r)}}catch(e){return this.isMissingTableError(e?.message||""),{late_rate:0}}}calculateTrend(e){if(e.length<2)return 0;let t=e.slice(0,3).reduce((e,t)=>e+t,0)/3,a=e.slice(3,6).reduce((e,t)=>e+t,0)/Math.min(3,e.length-3);return a>0?(t-a)/a:0}generateChurnRecommendation(e,t){return e>=70?"\uD83D\uDEA8 URGENTE: Agendar reuni\xe3o de reten\xe7\xe3o imediatamente":e>=50?"⚠️ Aten\xe7\xe3o: Iniciar a\xe7\xf5es preventivas de reten\xe7\xe3o":e>=30?"\uD83D\uDCCA Monitorar: Acompanhar m\xe9tricas semanalmente":"✅ Saud\xe1vel: Manter relacionamento normal"}generateConversionRecommendation(e,t){return e>=70?"\uD83C\uDFAF Alta probabilidade: Enviar proposta personalizada":e>=50?"\uD83D\uDCDE Boa chance: Agendar call de apresenta\xe7\xe3o":e>=30?"\uD83D\uDCE7 Nutrir: Continuar envio de conte\xfado relevante":"❄️ Frio: Manter em nurturing autom\xe1tico"}toDateOnly(e){try{let t=new Date(e);if(Number.isNaN(t.getTime()))return null;return t.toISOString().slice(0,10)}catch{return null}}async savePrediction(e){try{let t;let a=this.toDateOnly(e.valid_until),i=e.entity_id&&(t=e.entity_id,/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t))?e.entity_id:null,{data:r,error:n}=await this.db().from("ml_predictions_log").insert({prediction_type:e.type,prediction_target:e.entity_type,target_id:i,predicted_value:{value:e.prediction_value,factors:e.factors||[],recommendation:e.recommendation||null,entity_name:e.entity_name||null,entity_id:e.entity_id||null},predicted_probability:e.confidence,predicted_at:e.created_at,predicted_for_date:a,model_version:"heuristic_v1",features_used:(e.factors||[]).map(e=>e.name),created_by:null}).select("id").single();if(n)throw n;return r?.id&&(e.id=r.id),r?.id||null}catch(e){return console.error("Erro ao salvar previs\xe3o:",e),null}}async getPredictions(e){try{let t=this.db().from("ml_predictions_log").select("*").order("predicted_at",{ascending:!1});e?.type&&(t=t.eq("prediction_type",e.type)),e?.entity_type&&(t=t.eq("prediction_target",e.entity_type)),e?.entity_id&&(t=t.eq("target_id",e.entity_id)),e?.min_confidence&&(t=t.gte("predicted_probability",e.min_confidence));let{data:a}=await t;return(a||[]).map(e=>{let t=e.predicted_value,a="object"==typeof t&&null!==t&&"value"in t?Number(t.value):Number(t),i=(t&&"object"==typeof t?t.factors:null)||[],r=t&&"object"==typeof t?t.recommendation:void 0,n=t&&"object"==typeof t?t.entity_name:void 0,o=e.predicted_at||e.created_at||new Date().toISOString(),s=e.predicted_for_date?new Date(String(e.predicted_for_date)).toISOString():o;return{id:e.id,type:e.prediction_type,entity_type:e.prediction_target,entity_id:e.target_id,entity_name:n,prediction_value:Number.isFinite(a)?a:0,confidence:Number(e.predicted_probability||0),factors:i,recommendation:r,created_at:o,valid_until:s,was_correct:e.was_correct??void 0,actual_outcome:e.actual_value??void 0}})}catch(e){return console.error("Erro ao buscar previs\xf5es:",e),[]}}async recordPredictionOutcome(e,t,a){try{let i=new Date().toISOString();await this.db().from("ml_predictions_log").update({was_correct:t,actual_value:a??null,actual_recorded_at:i,accuracy_score:t?100:0}).eq("id",e)}catch(e){console.error("Erro ao registrar outcome:",e)}}}let n=new r}};