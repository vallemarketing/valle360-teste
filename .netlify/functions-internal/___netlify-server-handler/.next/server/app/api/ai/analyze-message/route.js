"use strict";(()=>{var e={};e.id=42414,e.ids=[42414],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},87561:e=>{e.exports=require("node:fs")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},7938:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>v});var a={};r.r(a),r.d(a,{GET:()=>m,POST:()=>d});var s=r(49303),o=r(88716),n=r(60670),i=r(87070),c=r(90176),l=r(30233);async function d(e){try{let t;let{messageId:r,content:a,senderId:s,senderType:o,conversationType:n,groupId:d,clientId:m,conversationName:p}=await e.json();if(!r||!a||!s)return i.NextResponse.json({success:!1,error:"Campos obrigat\xf3rios: messageId, content, senderId"},{status:400});if(a.trim().length<10)return i.NextResponse.json({success:!0,skipped:!0,reason:"Mensagem muito curta"});let g=(0,c.t)();try{let e=await (0,l.iF)({text:a,language:"pt-BR"});t={score:e.score,confidence:e.confidence,overall:e.overall,keywords:e.details?.keywords||[],entities:[],summary:void 0}}catch(e){console.error("[Sentiment] Erro na an\xe1lise:",e),t=function(e){let t=e.toLowerCase(),r=0,a=0,s=[];["obrigado","obrigada","excelente","\xf3timo","\xf3tima","perfeito","perfeita","incr\xedvel","maravilhoso","maravilhosa","parab\xe9ns","adorei","amei","satisfeito","satisfeita","feliz","contente","bom","boa","legal","show","top","demais","sensacional","fant\xe1stico","fant\xe1stica"].forEach(e=>{t.includes(e)&&(r++,s.push(e))}),["problema","erro","falha","ruim","p\xe9ssimo","p\xe9ssima","horr\xedvel","terr\xedvel","insatisfeito","insatisfeita","frustrado","frustrada","decepcionado","decepcionada","reclama\xe7\xe3o","reclamar","cancelar","atraso","atrasado","demora","demorado","n\xe3o funciona","n\xe3o gostei","raiva","absurdo","vergonha","inaceit\xe1vel","lament\xe1vel"].forEach(e=>{t.includes(e)&&(a++,s.push(e))});let o=r+a,n=0;return o>0&&(n=(r-a)/Math.max(o,1)),{score:n=Math.max(-1,Math.min(1,n)),magnitude:o/5*Math.abs(n),confidence:o>0?.6:.3,keywords:s.slice(0,5),entities:[],summary:o>0?`Detectadas ${r} express\xf5es positivas e ${a} negativas.`:void 0}}(a)}let v="neutral";t.score>.25?v="positive":t.score<-.25&&(v="negative");let{data:f,error:x}=await g.from("message_sentiment_analysis").insert({message_id:r,conversation_type:n,sender_type:o,sender_id:s,client_id:m||null,group_id:d||null,sentiment:v,score:t.score,confidence:t.confidence||.8,entities:t.entities||[],keywords:t.keywords||[],summary:t.summary||null,alert_generated:!1}).select().single();if(x)return console.error("[Sentiment] Erro ao salvar an\xe1lise:",x),i.NextResponse.json({success:!1,error:x.message},{status:500});return"negative"===v&&("direct_client"===n||m)&&await u(g,f,p||"Conversa",a),i.NextResponse.json({success:!0,analysisId:f?.id,sentiment:v,score:t.score})}catch(e){return console.error("[Sentiment] Erro geral:",e),i.NextResponse.json({success:!1,error:e.message||"Erro interno"},{status:500})}}async function u(e,t,r,a){try{let s="client"===t.sender_type?"Cliente com sentimento negativo":"Sentimento negativo detectado em conversa com cliente",o=`Mensagem com tom ${t.sentiment} detectada na conversa "${r}". Score: ${t.score.toFixed(2)}. Trecho: "${a.slice(0,100)}${a.length>100?"...":""}"`,n="client"===t.sender_type?"Verificar satisfa\xe7\xe3o do cliente e entrar em contato para resolver poss\xedveis problemas.":"Revisar comunica\xe7\xe3o do colaborador e orientar sobre tom adequado.";await e.from("sentiment_alerts").insert({analysis_id:t.id,alert_type:"client"===t.sender_type?"negative_client":"negative_staff",severity:t.score<-.5?"high":"medium",title:s,description:o,conversation_id:t.group_id||null,conversation_name:r,suggested_action:n,status:"pending"}),await e.from("message_sentiment_analysis").update({alert_generated:!0}).eq("id",t.id)}catch(e){console.error("[Sentiment] Erro ao gerar alerta:",e)}}async function m(){return i.NextResponse.json({status:"ok",service:"message-sentiment-analysis",timestamp:new Date().toISOString()})}let p=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/ai/analyze-message/route",pathname:"/api/ai/analyze-message",filename:"route",bundlePath:"app/api/ai/analyze-message/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\ai\\analyze-message\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:v,serverHooks:f}=p,x="/api/ai/analyze-message/route";function y(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:v})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,54214,68546],()=>r(7938));module.exports=a})();