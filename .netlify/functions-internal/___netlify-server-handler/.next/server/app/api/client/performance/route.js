"use strict";(()=>{var e={};e.id=37486,e.ids=[37486],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},25938:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>y,patchFetch:()=>A,requestAsyncStorage:()=>h,routeModule:()=>_,serverHooks:()=>f,staticGenerationAsyncStorage:()=>v});var s={};a.r(s),a.d(s,{GET:()=>g,dynamic:()=>m});var n=a(49303),i=a(88716),o=a(60670),r=a(87070),c=a(20344),l=a(71615),d=a(90176),u=a(14836);let m="force-dynamic";function p(e){let t=Number(e);return Number.isFinite(t)?t:0}async function g(e){try{let t=(0,l.cookies)(),a=(0,c.createRouteHandlerClient)({cookies:()=>t}),{data:s}=await a.auth.getUser(),n=s?.user;if(!n)return r.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let i=(0,d.t)(),{data:o,error:m}=await i.from("clients").select("id").eq("user_id",n.id).maybeSingle();if(m)return r.NextResponse.json({error:m.message},{status:500});let g=o?.id?String(o.id):null;if(!g)return r.NextResponse.json({error:"Cliente n\xe3o vinculado (clients.user_id)"},{status:400});let{searchParams:_}=new URL(e.url),h=Number(_.get("days")||30),v=Math.max(1,Math.min(365,Number.isFinite(h)?Math.floor(h):30)),f=new Date;f.setDate(f.getDate()-(v-1));let y=function(e){let t=new Date(e);return t.setUTCHours(0,0,0,0),t.toISOString().slice(0,10)}(f),A=[],C=null;try{let{data:e,error:t}=await i.from("social_account_metrics_daily").select("metric_date, metrics").eq("client_id",g).gte("metric_date",y).order("metric_date",{ascending:!0}).limit(5e3);if(t)throw t;let a={};for(let t of e||[]){let e=String(t.metric_date),s=t.metrics||{};a[e]||={impressions:0,reach:0,engaged:0,fans:0,profile_views:0},a[e].impressions+=p(s.impressions??s.page_impressions??0),a[e].reach+=p(s.reach??0),a[e].profile_views+=p(s.profile_views??0),a[e].engaged+=p(s.page_engaged_users??0),a[e].fans+=p(s.page_fans??0)}A=Object.keys(a).sort().map(e=>({date:e,...a[e]}))}catch(e){C=String(e?.message||"Falha ao carregar social_account_metrics_daily"),A=[]}let S={available:!1};try{let e=new Date().toISOString().slice(0,10),t=await u.U.generatePerformanceReport(g,"all",{start:y,end:e}),a=Array.isArray(t)?t:[],s=a.reduce((e,t)=>(e.total_spend+=p(t.total_spend),e.total_impressions+=p(t.total_impressions),e.total_clicks+=p(t.total_clicks),e.total_conversions+=p(t.total_conversions),e.avg_roas+=p(t.avg_roas),e.count+=1,e),{total_spend:0,total_impressions:0,total_clicks:0,total_conversions:0,avg_roas:0,count:0});S={available:a.length>0,reports:a,totals:{total_spend:s.total_spend,total_impressions:s.total_impressions,total_clicks:s.total_clicks,total_conversions:s.total_conversions,avg_roas:s.count?s.avg_roas/s.count:0}}}catch(e){S={available:!1,error:String(e?.message||"ads_unavailable")}}return r.NextResponse.json({success:!0,client_id:g,range_days:v,social:{daily:A,error:C},ads:S})}catch(e){return r.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let _=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/client/performance/route",pathname:"/api/client/performance",filename:"route",bundlePath:"app/api/client/performance/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\performance\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:v,serverHooks:f}=_,y="/api/client/performance/route";function A(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:v})}},90176:(e,t,a)=>{a.d(t,{t:()=>n});var s=a(54128);function n(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,s.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},14836:(e,t,a)=>{a.d(t,{U:()=>i});var s=a(1926);class n{setMetaCredentials(e){this.metaAccessToken=e}setGoogleCredentials(e){this.googleCredentials=e}async getMetaAdAccounts(e){return[{id:"act_123456789",name:"Conta Principal",currency:"BRL",timezone:"America/Sao_Paulo",status:"active",spend_cap:5e4,amount_spent:12500,balance:37500}]}async getMetaCampaigns(e){return[{id:"camp_001",account_id:e,name:"Campanha Black Friday",objective:"CONVERSIONS",status:"ACTIVE",daily_budget:500,start_time:"2024-11-20T00:00:00",stop_time:"2024-11-30T23:59:59",created_time:"2024-11-15T10:00:00",insights:{impressions:125e3,clicks:4500,ctr:3.6,spend:3500,cpc:.78,cpm:28,conversions:180,cost_per_conversion:19.44,roas:4.2,reach:85e3,frequency:1.47,date_range:{start:"2024-11-20",end:"2024-11-27"}}},{id:"camp_002",account_id:e,name:"Remarketing - Carrinho Abandonado",objective:"CONVERSIONS",status:"ACTIVE",daily_budget:200,created_time:"2024-10-01T10:00:00",insights:{impressions:45e3,clicks:2200,ctr:4.89,spend:1400,cpc:.64,cpm:31.11,conversions:95,cost_per_conversion:14.74,roas:6.8,reach:12e3,frequency:3.75,date_range:{start:"2024-11-01",end:"2024-11-27"}}}]}async createMetaCampaign(e,t){return console.log(`[META] Criando campanha: ${t.name}`),{id:`camp_${Date.now()}`,account_id:e,name:t.name||"Nova Campanha",objective:t.objective||"CONVERSIONS",status:"PAUSED",daily_budget:t.daily_budget,created_time:new Date().toISOString()}}async updateMetaCampaignStatus(e,t){return console.log(`[META] Atualizando campanha ${e} para ${t}`),!0}async getGoogleAdAccounts(e){return[{id:"123-456-7890",name:"Conta Google Ads Principal",currency:"BRL",timezone:"America/Sao_Paulo",status:"ENABLED",budget:3e4,cost:8500}]}async getGoogleCampaigns(e){return[{id:"gcamp_001",account_id:e,name:"Search - Marca",type:"SEARCH",status:"ENABLED",budget:100,bidding_strategy:"TARGET_CPA",insights:{impressions:35e3,clicks:2800,ctr:8,spend:2100,cpc:.75,cpm:60,conversions:120,cost_per_conversion:17.5,roas:5.5,date_range:{start:"2024-11-01",end:"2024-11-27"}}},{id:"gcamp_002",account_id:e,name:"Performance Max",type:"PERFORMANCE_MAX",status:"ENABLED",budget:150,bidding_strategy:"MAXIMIZE_CONVERSIONS",insights:{impressions:18e4,clicks:5400,ctr:3,spend:4200,cpc:.78,cpm:23.33,conversions:210,cost_per_conversion:20,roas:4.8,date_range:{start:"2024-11-01",end:"2024-11-27"}}}]}async createGoogleCampaign(e,t){return console.log(`[GOOGLE] Criando campanha: ${t.name}`),{id:`gcamp_${Date.now()}`,account_id:e,name:t.name||"Nova Campanha",type:t.type||"SEARCH",status:"PAUSED",budget:t.budget||100,bidding_strategy:t.bidding_strategy||"MANUAL_CPC"}}async generatePerformanceReport(e,t,a){let s=[];if("meta"===t||"all"===t)for(let t of(await this.getMetaAdAccounts(e))){let e=await this.getMetaCampaigns(t.id),n=e.reduce((e,t)=>e+(t.insights?.spend||0),0),i=e.reduce((e,t)=>e+(t.insights?.impressions||0),0),o=e.reduce((e,t)=>e+(t.insights?.clicks||0),0),r=e.reduce((e,t)=>e+(t.insights?.conversions||0),0);s.push({account_id:t.id,account_name:t.name,platform:"meta",period:`${a.start} a ${a.end}`,total_spend:n,total_impressions:i,total_clicks:o,avg_ctr:i>0?o/i*100:0,avg_cpc:o>0?n/o:0,total_conversions:r,avg_roas:this.calculateAvgRoas(e),campaigns:e.map(e=>({id:e.id,name:e.name,spend:e.insights?.spend||0,impressions:e.insights?.impressions||0,clicks:e.insights?.clicks||0,conversions:e.insights?.conversions||0})),recommendations:this.generateRecommendations(e,"meta")})}if("google"===t||"all"===t)for(let t of(await this.getGoogleAdAccounts(e))){let e=await this.getGoogleCampaigns(t.id),n=e.reduce((e,t)=>e+(t.insights?.spend||0),0),i=e.reduce((e,t)=>e+(t.insights?.impressions||0),0),o=e.reduce((e,t)=>e+(t.insights?.clicks||0),0),r=e.reduce((e,t)=>e+(t.insights?.conversions||0),0);s.push({account_id:t.id,account_name:t.name,platform:"google",period:`${a.start} a ${a.end}`,total_spend:n,total_impressions:i,total_clicks:o,avg_ctr:i>0?o/i*100:0,avg_cpc:o>0?n/o:0,total_conversions:r,avg_roas:this.calculateAvgRoas(e),campaigns:e.map(e=>({id:e.id,name:e.name,spend:e.insights?.spend||0,impressions:e.insights?.impressions||0,clicks:e.insights?.clicks||0,conversions:e.insights?.conversions||0})),recommendations:this.generateRecommendations(e,"google")})}return s}async checkBudgetAlerts(e){let t=[];for(let a of(await this.getMetaAdAccounts(e))){let e=a.spend_cap?a.amount_spent/a.spend_cap*100:0;e>=90&&t.push({account_id:a.id,platform:"meta",alert_type:e>=100?"budget_depleted":"budget_low",message:e>=100?`Or\xe7amento da conta ${a.name} esgotado!`:`Or\xe7amento da conta ${a.name} em ${e.toFixed(0)}%`,threshold_value:a.spend_cap||0,current_value:a.amount_spent,created_at:new Date().toISOString(),acknowledged:!1})}for(let a of(await this.getGoogleAdAccounts(e))){let e=a.budget?a.cost/a.budget*100:0;e>=90&&t.push({account_id:a.id,platform:"google",alert_type:e>=100?"budget_depleted":"budget_low",message:e>=100?`Or\xe7amento da conta ${a.name} esgotado!`:`Or\xe7amento da conta ${a.name} em ${e.toFixed(0)}%`,threshold_value:a.budget||0,current_value:a.cost,created_at:new Date().toISOString(),acknowledged:!1})}return t.length>0&&await s.O.from("budget_alerts").insert(t),t}async sendRechargeNotification(e,t,a){try{let{data:n}=await s.O.from("clients").select("*").eq("id",e).single();if(!n)return!1;let i=n.user_id?String(n.user_id):null;return i&&await s.O.from("notifications").insert({user_id:i,type:"budget_recharge",title:"\uD83D\uDCB0 Recarga de Or\xe7amento Necess\xe1ria",message:`O or\xe7amento da sua conta de ${"meta"===a?"Meta Ads":"Google Ads"} est\xe1 baixo. Recarregue para manter suas campanhas ativas.`,link:"/cliente/financeiro",metadata:{client_id:e,account_id:t,platform:a},is_read:!1,created_at:new Date().toISOString()}),console.log(`[NOTIFICA\xc7\xc3O] Recarga enviada para ${n.email}`),!0}catch(e){return console.error("Erro ao enviar notifica\xe7\xe3o:",e),!1}}async analyzeCompetitorAds(e){return{total_ads:Math.floor(50*Math.random())+10,active_ads:Math.floor(20*Math.random())+5,ad_formats:{image:Math.floor(15*Math.random())+5,video:Math.floor(10*Math.random())+3,carousel:Math.floor(8*Math.random())+2},themes:["Promo\xe7\xe3o","Lan\xe7amento","Institucional","Depoimentos"],avg_duration_days:Math.floor(30*Math.random())+7}}calculateAvgRoas(e){let t=e.map(e=>e.insights?.roas).filter(e=>null!=e);return 0===t.length?0:t.reduce((e,t)=>e+t,0)/t.length}generateRecommendations(e,t){let a=[];for(let t of e)t.insights&&(t.insights.ctr<1&&a.push(`${t.name}: CTR baixo (${t.insights.ctr.toFixed(2)}%). Considere revisar criativos e segmenta\xe7\xe3o.`),t.insights.cpc>2&&a.push(`${t.name}: CPC elevado (R$ ${t.insights.cpc.toFixed(2)}). Teste novos p\xfablicos ou ajuste lances.`),t.insights.roas&&t.insights.roas<2&&a.push(`${t.name}: ROAS abaixo do ideal (${t.insights.roas.toFixed(1)}x). Revise funil de convers\xe3o.`),t.insights.frequency&&t.insights.frequency>3&&a.push(`${t.name}: Frequ\xeancia alta (${t.insights.frequency.toFixed(1)}). Expanda o p\xfablico ou pause para evitar fadiga.`));return 0===a.length&&a.push("✅ Campanhas com performance saud\xe1vel. Continue monitorando."),a.slice(0,5)}}let i=new n},1926:(e,t,a)=>{a.d(t,{O:()=>o});var s=a(54128);let n="https://ikjgsqtykkhqimypacro.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI";n&&i||console.error("❌ ERRO CR\xcdTICO: Vari\xe1veis de ambiente NEXT_PUBLIC_SUPABASE_URL ou NEXT_PUBLIC_SUPABASE_ANON_KEY n\xe3o encontradas!");let o=(0,s.eI)(n||"https://setup-missing.supabase.co",i||"setup-missing",{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[89276,55972,54128,20958],()=>a(25938));module.exports=s})();