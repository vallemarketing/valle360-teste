"use strict";(()=>{var e={};e.id=85887,e.ids=[85887],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},43100:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>y,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>b,staticGenerationAsyncStorage:()=>f});var r={};s.r(r),s.d(r,{PATCH:()=>l,POST:()=>m,dynamic:()=>c});var a=s(49303),o=s(88716),n=s(60670),i=s(87070),p=s(20344),u=s(71615),d=s(39449);let c="force-dynamic";async function m(e){try{let t;let s=(0,u.cookies)(),r=(0,p.createRouteHandlerClient)({cookies:()=>s}),{data:{user:a},error:o}=await r.auth.getUser();if(o||!a)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:n,error:c}=await r.from("integration_configs").select("*").eq("integration_id","whatsapp").single();if(c||!n||"connected"!==n.status)return i.NextResponse.json({error:"WhatsApp n\xe3o est\xe1 conectado",needsSetup:!0},{status:400});let{type:m,to:l,...h}=await e.json();if(!l)return i.NextResponse.json({error:"N\xfamero de destino \xe9 obrigat\xf3rio"},{status:400});let g=(0,d.SP)({accessToken:n.access_token,phoneNumberId:n.config?.phoneNumberId}),f=Date.now();switch(m){case"text":if(!h.text)return i.NextResponse.json({error:"Texto \xe9 obrigat\xf3rio"},{status:400});t=await g.sendTextMessage(l,h.text,h.previewUrl);break;case"image":if(!h.imageUrl)return i.NextResponse.json({error:"URL da imagem \xe9 obrigat\xf3ria"},{status:400});t=await g.sendImage(l,h.imageUrl,h.caption);break;case"document":if(!h.documentUrl||!h.filename)return i.NextResponse.json({error:"URL e nome do documento s\xe3o obrigat\xf3rios"},{status:400});t=await g.sendDocument(l,h.documentUrl,h.filename,h.caption);break;case"template":if(!h.templateName)return i.NextResponse.json({error:"Nome do template \xe9 obrigat\xf3rio"},{status:400});t=await g.sendTemplate(l,h.templateName,h.languageCode||"pt_BR",h.components);break;case"buttons":if(!h.body||!h.buttons)return i.NextResponse.json({error:"Corpo e bot\xf5es s\xe3o obrigat\xf3rios"},{status:400});t=await g.sendInteractiveButtons(l,h.body,h.buttons,h.header,h.footer);break;case"list":if(!h.body||!h.buttonText||!h.sections)return i.NextResponse.json({error:"Corpo, texto do bot\xe3o e se\xe7\xf5es s\xe3o obrigat\xf3rios"},{status:400});t=await g.sendInteractiveList(l,h.body,h.buttonText,h.sections,h.header,h.footer);break;default:return i.NextResponse.json({error:"Tipo de mensagem inv\xe1lido"},{status:400})}let b=Date.now()-f;return await r.from("integration_logs").insert({integration_id:"whatsapp",action:`send_${m}`,status:"success",request_data:{to:l,type:m},response_data:{messageId:t.messages?.[0]?.id},duration_ms:b}),i.NextResponse.json({success:!0,messageId:t.messages?.[0]?.id,to:t.contacts?.[0]?.wa_id})}catch(e){return console.error("Erro ao enviar mensagem WhatsApp:",e),i.NextResponse.json({error:"Erro ao enviar mensagem",details:e.message},{status:500})}}async function l(e){try{let t=(0,u.cookies)(),s=(0,p.createRouteHandlerClient)({cookies:()=>t}),{data:{user:r},error:a}=await s.auth.getUser();if(a||!r)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:o}=await s.from("integration_configs").select("*").eq("integration_id","whatsapp").single();if(!o||"connected"!==o.status)return i.NextResponse.json({error:"WhatsApp n\xe3o est\xe1 conectado"},{status:400});let{messageId:n}=await e.json();if(!n)return i.NextResponse.json({error:"ID da mensagem \xe9 obrigat\xf3rio"},{status:400});let c=(0,d.SP)({accessToken:o.access_token,phoneNumberId:o.config?.phoneNumberId});return await c.markAsRead(n),i.NextResponse.json({success:!0})}catch(e){return console.error("Erro ao marcar como lida:",e),i.NextResponse.json({error:"Erro ao marcar como lida",details:e.message},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/integrations/whatsapp/send/route",pathname:"/api/integrations/whatsapp/send",filename:"route",bundlePath:"app/api/integrations/whatsapp/send/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\integrations\\whatsapp\\send\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:b}=h,y="/api/integrations/whatsapp/send/route";function w(){return(0,n.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:f})}},39449:(e,t,s)=>{s.d(t,{SP:()=>o,lW:()=>n,nw:()=>i});let r="https://graph.facebook.com/v18.0";class a{constructor(e){this.accessToken=e.accessToken,this.phoneNumberId=e.phoneNumberId,this.businessId=e.businessId}async request(e,t={}){let s=`${r}${e}`,a=await fetch(s,{...t,headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json",...t.headers}}),o=await a.json();if(o.error)throw Error(`WhatsApp API Error: ${o.error.message}`);return o}async sendTextMessage(e,t,s=!1){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"text",text:{preview_url:s,body:t}})})}async sendImage(e,t,s){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"image",image:{link:t,caption:s}})})}async sendDocument(e,t,s,r){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"document",document:{link:t,filename:s,caption:r}})})}async sendTemplate(e,t,s="pt_BR",r){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"template",template:{name:t,language:{code:s},components:r}})})}async sendInteractiveButtons(e,t,s,r,a){let o={type:"button",body:{text:t},action:{buttons:s.map(e=>({type:"reply",reply:{id:e.id,title:e.title}}))}};return r&&(o.header={type:"text",text:r}),a&&(o.footer={text:a}),this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"interactive",interactive:o})})}async sendInteractiveList(e,t,s,r,a,o){let n={type:"list",body:{text:t},action:{button:s,sections:r}};return a&&(n.header={type:"text",text:a}),o&&(n.footer={text:o}),this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"interactive",interactive:n})})}async markAsRead(e){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",status:"read",message_id:e})})}async uploadMedia(e,t,s){let a;let o=new FormData;return e instanceof ArrayBuffer?a=e:(Array.isArray(e),a=new Uint8Array(e)),o.append("file",new Blob([a],{type:t}),s),o.append("messaging_product","whatsapp"),o.append("type",t),(await fetch(`${r}/${this.phoneNumberId}/media`,{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`},body:o})).json()}async getMediaUrl(e){return this.request(`/${e}`)}async listTemplates(){if(!this.businessId)throw Error("Business ID n\xe3o configurado");return this.request(`/${this.businessId}/message_templates`)}async getBusinessProfile(){return this.request(`/${this.phoneNumberId}/whatsapp_business_profile?fields=about,address,description,email,profile_picture_url,websites,vertical`)}async updateBusinessProfile(e){return this.request(`/${this.phoneNumberId}/whatsapp_business_profile`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",...e})})}formatPhoneNumber(e){let t=e.replace(/\D/g,"");return!t.startsWith("55")&&t.length<=11&&(t="55"+t),t}}function o(e){return new a(e)}function n(e,t,s,r){return"subscribe"===e&&t===r?s:null}function i(e){let t=[],s=[];for(let r of e.entry)for(let e of r.changes){let r=e.value;if(r.messages)for(let e of r.messages){let s=r.contacts?.find(t=>t.wa_id===e.from);t.push({from:e.from,name:s?.profile?.name,id:e.id,timestamp:new Date(1e3*parseInt(e.timestamp)),type:e.type,content:e.text?.body||e.image||e.document||e.button||e.interactive})}if(r.statuses)for(let e of r.statuses)s.push({messageId:e.id,status:e.status,timestamp:new Date(1e3*parseInt(e.timestamp)),to:e.recipient_id,error:e.errors?.[0]?.title})}return{messages:t,statuses:s}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>s(43100));module.exports=r})();