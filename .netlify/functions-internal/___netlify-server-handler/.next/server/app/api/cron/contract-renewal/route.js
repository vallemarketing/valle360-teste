"use strict";(()=>{var e={};e.id=71247,e.ids=[71247],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61259:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>g,patchFetch:()=>S,requestAsyncStorage:()=>u,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p});var n={};a.r(n),a.d(n,{GET:()=>_,dynamic:()=>d});var r=a(49303),o=a(88716),i=a(60670),s=a(87070),c=a(90176);let d="force-dynamic";async function _(e){try{let t=e.headers.get("authorization"),a=process.env.CRON_SECRET;if(a&&t!==`Bearer ${a}`)return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let n=(0,c.t)(),r=new Date,o={FINAL_WARNING:7,SECOND_WARNING:30,FIRST_WARNING:60,AUTO_RENEW_CHECK:14},i={auto_renewed:0,notifications_sent:0,expired:0,errors:0},{data:d,error:_}=await n.from("contracts").select(`
        id,
        client_id,
        contract_number,
        end_date,
        auto_renew,
        renewal_period_months,
        status,
        monthly_value,
        services,
        clients (
          id,
          company_name,
          nome_fantasia,
          email,
          user_id
        )
      `).eq("status","active").order("end_date",{ascending:!0});if(_)throw console.error("Error fetching contracts:",_),Error(`Failed to fetch contracts: ${_.message}`);for(let e of d||[])try{let t=new Date(e.end_date),a=Math.ceil((t.getTime()-r.getTime())/864e5),s=e.clients,c=s?.company_name||s?.nome_fantasia||"Cliente";if(a<0){await n.from("contracts").update({status:"expired",updated_at:r.toISOString()}).eq("id",e.id),i.expired++;continue}if(e.auto_renew&&a<=o.AUTO_RENEW_CHECK){let a=e.renewal_period_months||12,o=new Date(t);o.setMonth(o.getMonth()+a),e.contract_number,Date.now(),await n.from("contracts").update({end_date:o.toISOString(),renewal_count:(e.renewal_count||0)+1,last_renewal_date:r.toISOString(),updated_at:r.toISOString()}).eq("id",e.id),await n.from("contract_events").insert({contract_id:e.id,event_type:"auto_renewed",description:`Contrato renovado automaticamente por ${a} meses`,new_end_date:o.toISOString(),created_at:r.toISOString()});let s=Number(e.monthly_value||0);if(s>0)for(let o=0;o<a;o++){let a=new Date(t);a.setMonth(a.getMonth()+o);let i=new Date(a);i.setDate(10),await n.from("invoices").insert({client_id:e.client_id,contract_id:e.id,invoice_number:`INV-${e.contract_number}-${a.getFullYear()}${String(a.getMonth()+1).padStart(2,"0")}`,amount:s,due_date:i.toISOString(),status:"pending",description:`Mensalidade - ${a.toLocaleString("pt-BR",{month:"long",year:"numeric"})}`,created_at:r.toISOString()})}await n.from("notifications").insert({type:"contract_auto_renewed",title:"Contrato Renovado Automaticamente",message:`O contrato de ${c} foi renovado por mais ${a} meses`,data:{contract_id:e.id,client_id:e.client_id,new_end_date:o.toISOString()},read:!1,created_at:r.toISOString()}),i.auto_renewed++;continue}let d=null;if(a===o.FINAL_WARNING?d="final_warning":a===o.SECOND_WARNING?d="second_warning":a===o.FIRST_WARNING&&(d="first_warning"),d){let{data:t}=await n.from("notifications").select("id").eq("data->contract_id",e.id).eq("data->warning_type",d).maybeSingle();if(!t){let t={first_warning:`O contrato de ${c} expira em ${o.FIRST_WARNING} dias`,second_warning:`O contrato de ${c} expira em ${o.SECOND_WARNING} dias`,final_warning:`URGENTE: O contrato de ${c} expira em ${o.FINAL_WARNING} dias!`};await n.from("notifications").insert({type:"contract_expiring",title:"Contrato Pr\xf3ximo do Vencimento",message:t[d],data:{contract_id:e.id,client_id:e.client_id,warning_type:d,days_until_expiration:a},read:!1,created_at:r.toISOString()}),"first_warning"===d&&await n.from("kanban_tasks").insert({client_id:e.client_id,title:`Renova\xe7\xe3o de Contrato - ${c}`,description:`O contrato expira em ${a} dias. Entrar em contato para negociar renova\xe7\xe3o.`,status:"backlog",priority:"high",area:"commercial",due_date:new Date(r.getTime()+12096e5).toISOString(),tags:["renova\xe7\xe3o","contrato","comercial"],metadata:{contract_id:e.id,expiration_date:e.end_date},created_at:r.toISOString()}),i.notifications_sent++}}}catch(t){console.error(`Error processing contract ${e.id}:`,t),i.errors++}return s.NextResponse.json({success:!0,processed:i,timestamp:r.toISOString()})}catch(e){return console.error("Contract renewal cron error:",e),s.NextResponse.json({success:!1,error:e?.message||"Erro interno"},{status:500})}}let l=new r.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/cron/contract-renewal/route",pathname:"/api/cron/contract-renewal",filename:"route",bundlePath:"app/api/cron/contract-renewal/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\cron\\contract-renewal\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:u,staticGenerationAsyncStorage:p,serverHooks:m}=l,g="/api/cron/contract-renewal/route";function S(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:p})}},90176:(e,t,a)=>{a.d(t,{t:()=>r});var n=a(54128);function r(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,n.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[89276,55972,54128],()=>a(61259));module.exports=n})();