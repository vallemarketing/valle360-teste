"use strict";(()=>{var e={};e.id=15009,e.ids=[15009],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},62386:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>f,requestAsyncStorage:()=>_,routeModule:()=>m,serverHooks:()=>S,staticGenerationAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{GET:()=>p,POST:()=>g,dynamic:()=>l});var s=r(49303),n=r(88716),o=r(60670),i=r(87070),c=r(20344),d=r(71615),u=r(90176);let l="force-dynamic";async function p(e){try{let e=(0,d.cookies)(),t=(0,c.createRouteHandlerClient)({cookies:()=>e}),{data:r}=await t.auth.getUser(),a=r?.user;if(!a)return i.NextResponse.json({success:!1,error:"N\xe3o autorizado"},{status:401});let s=(0,u.t)(),{data:n,error:o}=await s.from("clients").select("id").eq("user_id",a.id).maybeSingle();if(o||!n?.id)return i.NextResponse.json({success:!1,error:"Cliente n\xe3o encontrado"},{status:400});let l=0;try{let{data:e,error:t}=await s.from("client_credits").select("balance, updated_at").eq("client_id",n.id).maybeSingle();!t&&e&&(l=Number(e.balance||0))}catch(e){}let p=[],g=0;try{let{data:e,error:t}=await s.from("client_credit_transactions").select("*").eq("client_id",n.id).order("created_at",{ascending:!1}).limit(50);if(!t&&e){p=e.map(e=>({id:String(e.id),type:e.type||"usage",amount:Number(e.amount||0),description:String(e.description||""),created_at:String(e.created_at),reference_id:e.reference_id?String(e.reference_id):void 0}));let t=new Date,r=new Date(t.getFullYear(),t.getMonth(),1);g=p.filter(e=>"usage"===e.type&&new Date(e.created_at)>=r).reduce((e,t)=>e+Math.abs(t.amount),0)}}catch(e){p=[{id:"1",type:"purchase",amount:5e3,created_at:new Date().toISOString(),description:"Compra de cr\xe9ditos"},{id:"2",type:"usage",amount:-1200,created_at:new Date().toISOString(),description:"Campanha Instagram Ads"}],g=1200}let m=new Set(p.filter(e=>"usage"===e.type).map(e=>{let t=new Date(e.created_at);return`${t.getFullYear()}-${t.getMonth()}`})).size||1,_=p.filter(e=>"usage"===e.type).reduce((e,t)=>e+Math.abs(t.amount),0)/m,h=_>0?l/_:0,S=new Date,x=new Date(S.getFullYear(),S.getMonth()-1,1),f=new Date(S.getFullYear(),S.getMonth(),0),y=p.filter(e=>{let t=new Date(e.created_at);return"usage"===e.type&&t>=x&&t<=f}).reduce((e,t)=>e+Math.abs(t.amount),0),w=y>0?(g-y)/y*100:0;return i.NextResponse.json({success:!0,balance:l,stats:{monthly_usage:g,last_month_usage:y,usage_change_percent:Math.round(w),estimated_duration_months:Math.round(10*h)/10,low_balance:l<5e3},transactions:p,credit_options:[{value:5e3,bonus:0},{value:1e4,bonus:500},{value:2e4,bonus:1500},{value:5e4,bonus:5e3}]})}catch(e){return console.error("Credits API error:",e),i.NextResponse.json({success:!1,error:e?.message||"Erro interno"},{status:500})}}async function g(e){try{let t=(0,d.cookies)(),r=(0,c.createRouteHandlerClient)({cookies:()=>t}),{data:a}=await r.auth.getUser(),s=a?.user;if(!s)return i.NextResponse.json({success:!1,error:"N\xe3o autorizado"},{status:401});let{amount:n,payment_method:o}=await e.json();if(!n||n<1e3)return i.NextResponse.json({success:!1,error:"Valor m\xednimo: R$ 1.000"},{status:400});if(!o||!["pix","card","boleto"].includes(o))return i.NextResponse.json({success:!1,error:"M\xe9todo de pagamento inv\xe1lido"},{status:400});let l=(0,u.t)(),{data:p}=await l.from("clients").select("id").eq("user_id",s.id).maybeSingle();if(!p?.id)return i.NextResponse.json({success:!1,error:"Cliente n\xe3o encontrado"},{status:400});let g={5e3:0,1e4:500,2e4:1500,5e4:5e3}[n]||0,m=n+g,_=`CRD-${Date.now()}-${Math.random().toString(36).substring(2,8).toUpperCase()}`;try{await l.from("client_credit_orders").insert({id:_,client_id:p.id,amount:n,bonus:g,total_credits:m,payment_method:o,status:"pending",created_at:new Date().toISOString()})}catch(e){console.log("Credit order table not found, continuing with simulated order")}let h={order_id:_};return h="pix"===o?{...h,type:"pix",qr_code:`PIX-${_}`,qr_code_url:`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=PIX-${_}`,expiration:new Date(Date.now()+18e5).toISOString()}:"boleto"===o?{...h,type:"boleto",barcode:`23793.38128 60000.000003 00000.000400 1 ${n.toString().padStart(10,"0")}`,due_date:new Date(Date.now()+2592e5).toISOString()}:{...h,type:"card",checkout_url:`/checkout/credits/${_}`},i.NextResponse.json({success:!0,order_id:_,amount:n,bonus:g,total_credits:m,payment:h})}catch(e){return console.error("Credit purchase error:",e),i.NextResponse.json({success:!1,error:e?.message||"Erro interno"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/client/credits/route",pathname:"/api/client/credits",filename:"route",bundlePath:"app/api/client/credits/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\credits\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:h,serverHooks:S}=m,x="/api/client/credits/route";function f(){return(0,o.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:h})}},90176:(e,t,r)=>{r.d(t,{t:()=>s});var a=r(54128);function s(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,a.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958],()=>r(62386));module.exports=a})();