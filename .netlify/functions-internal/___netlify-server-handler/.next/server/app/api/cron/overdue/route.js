"use strict";(()=>{var e={};e.id=84997,e.ids=[84997],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},16079:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>E,patchFetch:()=>q,requestAsyncStorage:()=>I,routeModule:()=>S,serverHooks:()=>N,staticGenerationAsyncStorage:()=>$});var s={};a.r(s),a.d(s,{GET:()=>w,POST:()=>x,dynamic:()=>f});var r=a(49303),n=a(88716),i=a(60670),o=a(87070),d=a(54128),c=a(14399),u=a(46882),l=a(39449),p=a(87881),m=a(17478);let f="force-dynamic";function g(e,t){let a=e;for(let e of t){if(!a||"object"!=typeof a)return;a=a[e]}return a}function h(e,t,a){let s={...e||{}},r=s;for(let e=0;e<t.length-1;e++){let a=t[e];r[a]="object"==typeof r[a]&&null!==r[a]?{...r[a]}:{},r=r[a]}return r[t[t.length-1]]=a,s}function _(e){if(!e)return null;let t=new Date(String(e)).getTime();return Number.isFinite(t)?t:null}function y(e,t){let a=_(e);return!a||Date.now()-a>=t}async function b(e,t){try{let{data:a}=await e.from("integration_configs").select("status, api_key, config").eq("integration_id","sendgrid").maybeSingle(),s=(process.env.SENDGRID_API_KEY||"").trim(),r=(a?.status==="connected"?String(a?.api_key||""):"").trim()||s;r||(r="mailto");let n=(0,u.w2)({apiKey:r,fromEmail:a?.config?.fromEmail||process.env.SENDGRID_FROM_EMAIL||"noreply@valle360.com.br",fromName:a?.config?.fromName||process.env.SENDGRID_FROM_NAME||"Valle 360"}),i=u.qC.notification(t.title,t.message,t.actionUrl,"Abrir"),o=await n.sendEmail({to:{email:t.to},subject:i.subject,html:i.html});return o?.success===!0}catch{return!1}}async function k(e,t){try{let{data:a}=await e.from("integration_configs").select("status, access_token, config").eq("integration_id","whatsapp").maybeSingle();if(!a||"connected"!==a.status||!a.access_token||!a.config?.phoneNumberId)return!1;let s=(0,l.SP)({accessToken:a.access_token,phoneNumberId:a.config.phoneNumberId}),r=await s.sendTextMessage(t.to,t.text,!0);return!!r?.messages?.[0]?.id}catch{return!1}}async function v(e){let t=function(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;return e&&t?(0,d.eI)(e,t,{auth:{persistSession:!1}}):null}();if(!t)return o.NextResponse.json({success:!1,error:"SUPABASE_SERVICE_ROLE_KEY n\xe3o configurada"},{status:500});try{let a=new Date().toISOString(),s=Date.now(),r={ok:!0,ran_at:a,overdue_tasks_notified:0,overdue_approvals_notified:0,emails_sent:0,whatsapp_sent:0},{data:n}=await t.from("kanban_tasks").select(`
        id, title, due_date, assigned_to, board_id, column_id, reference_links,
        board:kanban_boards ( id, name, area_key ),
        column:kanban_columns ( id, name, stage_key )
      `).lt("due_date",a).neq("status","cancelled").limit(1e3);for(let e of n||[]){let s=String(e?.column?.stage_key||"").toLowerCase();if("finalizado"===s)continue;let n=e.reference_links||{},i=g(n,["alerts","overdue_task","last_notified_at"]);if(!y(i,864e5))continue;let o="Tarefa atrasada",d=`A tarefa "${e.title}" est\xe1 atrasada (vencimento: ${String(e.due_date).slice(0,10)}).`;e.assigned_to?await t.from("notifications").insert({user_id:String(e.assigned_to),type:"kanban_overdue",title:o,message:d,is_read:!1,link:"/colaborador/kanban",metadata:{task_id:e.id,kind:"overdue_task",board_id:e.board_id,area_key:e?.board?.area_key||null},created_at:a}):await (0,c.Q)({area:String(e?.board?.name||e?.board?.area_key||"Kanban"),title:o,message:d,link:"/admin/kanban-app",type:"kanban_overdue",metadata:{task_id:e.id,kind:"overdue_task",board_id:e.board_id,area_key:e?.board?.area_key||null}});let u=h(n,["alerts","overdue_task"],{last_notified_at:a,count:Number(g(n,["alerts","overdue_task","count"])||0)+1});await t.from("kanban_tasks").update({reference_links:u,updated_at:a}).eq("id",e.id),r.overdue_tasks_notified+=1}let{data:i}=await t.from("kanban_columns").select("id").eq("stage_key","aprovacao").limit(500),d=(i||[]).map(e=>String(e.id));if(d.length>0){let{data:e}=await t.from("kanban_tasks").select(`
          id, title, client_id, board_id, column_id, reference_links, updated_at,
          board:kanban_boards ( id, name, area_key )
        `).in("column_id",d).neq("status","cancelled").limit(1e3);for(let n of e||[]){let e=n.reference_links||{},i=g(e,["client_approval","due_at"]),o=_(i);if(!o||o>s)continue;let d=g(e,["alerts","client_approval_overdue","last_notified_at"]);if(!y(d,864e5))continue;let c=n.client_id?String(n.client_id):null;if(!c)continue;let{data:u}=await t.from("clients").select("user_id, email, contact_email, whatsapp, contact_phone, company_name, name").eq("id",c).maybeSingle();if(!u)continue;let l=u?.user_id?String(u.user_id):null;if(!l)continue;let p="Aprova\xe7\xe3o pendente (atrasada)",m=`Sua aprova\xe7\xe3o est\xe1 atrasada para seguirmos com a entrega: "${n.title}".`;await t.from("notifications").insert({user_id:l,type:"client_approval_overdue",title:p,message:m,is_read:!1,link:"/cliente/aprovacoes",metadata:{task_id:n.id,kind:"approval_overdue",board_id:n.board_id,area_key:n?.board?.area_key||null},created_at:a}),r.overdue_approvals_notified+=1;let f=process.env.NEXT_PUBLIC_APP_URL||"",v=f?`${f}/cliente/aprovacoes`:void 0,x=(u.contact_email||u.email||"").trim();x&&await b(t,{to:x,title:p,message:m,actionUrl:v})&&(r.emails_sent+=1);let w=String(u.whatsapp||u.contact_phone||"").trim();w&&await k(t,{to:w,text:`${p}

${m}${v?`

Acesse: ${v}`:""}`})&&(r.whatsapp_sent+=1);let S=h(e,["alerts","client_approval_overdue"],{last_notified_at:a,count:Number(g(e,["alerts","client_approval_overdue","count"])||0)+1});await t.from("kanban_tasks").update({reference_links:S,updated_at:a}).eq("id",n.id)}}return await (0,p.m)({supabase:t,action:"overdue",status:"ok",durationMs:Date.now()-e,responseData:{overdue_tasks_notified:r.overdue_tasks_notified,overdue_approvals_notified:r.overdue_approvals_notified,emails_sent:r.emails_sent,whatsapp_sent:r.whatsapp_sent}}),o.NextResponse.json({success:!0,result:r})}catch(a){return await (0,p.m)({supabase:t,action:"overdue",status:"error",durationMs:Date.now()-e,errorMessage:a?.message||"Erro interno"}),o.NextResponse.json({success:!1,error:a?.message||"Erro interno"},{status:500})}}async function x(e){let t=Date.now(),a=await (0,m.k)(e);return a.ok?v(t):a.res}async function w(e){let t=Date.now();return(0,p.T)(e)||v(t)}let S=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/cron/overdue/route",pathname:"/api/cron/overdue",filename:"route",bundlePath:"app/api/cron/overdue/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\cron\\overdue\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:I,staticGenerationAsyncStorage:$,serverHooks:N}=S,E="/api/cron/overdue/route";function q(){return(0,i.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:$})}},14399:(e,t,a)=>{a.d(t,{Q:()=>n});var s=a(90176);function r(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}async function n(e){let t=(0,s.t)(),{data:a}=await t.from("employees").select("user_id, department, areas, is_active").eq("is_active",!0),n=(a||[]).filter(t=>t?.user_id&&function(e,t){let a=r(e),s=t.department?r(t.department):"",n=Array.isArray(t.areas)?t.areas.map(r):[];if(!a)return!1;if(s===a||n.includes(a)||s.includes(a)||a.includes(s)||n.some(e=>e.includes(a)||a.includes(e)))return!0;let i={operacao:["operacao","operacional","ops"],financeiro:["financeiro","finance","cobranca","cobran\xe7a"],comercial:["comercial","vendas","sales"],juridico:["juridico","juridico/compliance","compliance"],contratos:["contratos","contract"],notificacoes:["notificacoes","notificacoes-e-alertas","notificacoes/alertas"],rh:["rh","people","pessoas"]}[a]||[];return!!(i.length>0&&(i.some(e=>s.includes(e))||i.some(e=>n.some(t=>t.includes(e)))))}(e.area,t)).map(e=>String(e.user_id));if(0===n.length){let a={user_id:null,title:e.title,message:e.message,type:e.type||"workflow",is_read:!1,link:e.link??"/admin/fluxos",metadata:{...e.metadata||{},area:e.area,audience:"area"},created_at:new Date().toISOString()};try{await t.from("notifications").insert(a)}catch{}return}let i=n.map(t=>({user_id:t,title:e.title,message:e.message,type:e.type||"workflow",is_read:!1,link:e.link??"/colaborador/notificacoes",metadata:{...e.metadata||{},area:e.area,audience:"area"},created_at:new Date().toISOString()}));try{await t.from("notifications").insert(i)}catch{}}},90176:(e,t,a)=>{a.d(t,{t:()=>r});var s=a(54128);function r(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,s.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},17478:(e,t,a)=>{a.d(t,{k:()=>o});var s=a(87070),r=a(20344),n=a(71615),i=a(54128);async function o(e){let t=(0,n.cookies)(),a=(0,r.createRouteHandlerClient)({cookies:()=>t}),o=e.headers.get("authorization")||"",d=o.toLowerCase().startsWith("bearer ")?o.slice(7).trim():null,c=d?(0,i.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${d}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):a,{data:u}=await c.auth.getUser();if(!u.user?.id)return{ok:!1,res:s.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:l,error:p}=await c.rpc("is_admin");return p||!l?{ok:!1,res:s.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:u.user.id}}},87881:(e,t,a)=>{a.d(t,{T:()=>r,m:()=>n});var s=a(87070);function r(e){let t=String(process.env.CRON_SECRET||"").trim(),a=String(e.headers.get("authorization")||"").trim();return t&&a===`Bearer ${t}`?null:"1"===String(e.headers.get("x-vercel-cron")||"").trim()||String(e.headers.get("user-agent")||"").toLowerCase().includes("vercel-cron")?null:s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}async function n(e){try{await e.supabase.from("integration_logs").insert({integration_id:"cron",action:e.action,status:e.status,request_data:e.requestData??null,response_data:e.responseData??null,error_message:e.errorMessage??null,duration_ms:Math.max(0,Math.floor(e.durationMs||0)),created_at:new Date().toISOString()})}catch{}}},46882:(e,t,a)=>{a.d(t,{Rp:()=>s,qC:()=>n,w2:()=>r});class s{constructor(e){this.apiKey=e.apiKey,this.fromEmail=e.fromEmail,this.fromName=e.fromName}async request(e,t={}){let a=await fetch(`https://api.sendgrid.com/v3${e}`,{...t,headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json",...t.headers}});if(202===a.status||200===a.status||201===a.status){let e=await a.text();return e?JSON.parse(e):{success:!0}}let s=await a.json();throw Error(s.errors?.[0]?.message||"Erro na API SendGrid")}async sendEmail(e){let t=Array.isArray(e.to)?e.to:[e.to],a=t[0]?.email||"",s=e.subject||"",r=(e.text||e.html||"").replace(/<[^>]+>/g,"").trim();return{success:!0,mailtoUrl:`mailto:${a}?subject=${encodeURIComponent(s)}&body=${encodeURIComponent(r)}`}}async sendBulkEmail(e,t){return{success:0,failed:e.length,errors:["Envio em lote n\xe3o suportado via mailto. Use envio manual."]}}async listTemplates(){return this.request("/templates?generations=dynamic")}async getTemplate(e){return this.request(`/templates/${e}`)}async getStats(e,t){let a=`/stats?start_date=${e}`;return t&&(a+=`&end_date=${t}`),this.request(a)}async getCategoryStats(e,t,a){let s=`/categories/${e}/stats?start_date=${t}`;return a&&(s+=`&end_date=${a}`),this.request(s)}async addContact(e,t){let a={email:e};t?.firstName&&(a.first_name=t.firstName),t?.lastName&&(a.last_name=t.lastName),t?.customFields&&(a.custom_fields=t.customFields);let s={contacts:[a]};return t?.listIds&&(s.list_ids=t.listIds),this.request("/marketing/contacts",{method:"PUT",body:JSON.stringify(s)})}async searchContacts(e){return this.request("/marketing/contacts/search",{method:"POST",body:JSON.stringify({query:e})})}async deleteContact(e){return this.request(`/marketing/contacts?ids=${e}`,{method:"DELETE"})}async getLists(){return this.request("/marketing/lists")}async createList(e){return this.request("/marketing/lists",{method:"POST",body:JSON.stringify({name:e})})}async addToSuppressionList(e,t){let a="unsubscribes"===t?"/asm/suppressions/global":`/suppression/${t}`;await this.request(a,{method:"POST",body:JSON.stringify({recipient_emails:e})})}async getSuppressionList(e){let t="unsubscribes"===e?"/asm/suppressions/global":`/suppression/${e}`;return this.request(t)}}function r(e){return new s(e)}let n={welcome:(e,t)=>({subject:`Bem-vindo \xe0 ${t}! ðŸŽ‰`,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h1 style="color: #4370d1;">Ol\xe1, ${e}!</h1>
        <p>Seja muito bem-vindo(a) \xe0 ${t}!</p>
        <p>Estamos muito felizes em ter voc\xea conosco. A partir de agora, voc\xea ter\xe1 acesso a todas as nossas ferramentas e recursos.</p>
        <p>Se precisar de ajuda, n\xe3o hesite em entrar em contato.</p>
        <p>Abra\xe7os,<br/>Equipe ${t}</p>
      </div>
    `}),notification:(e,t,a,s)=>({subject:e,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2 style="color: #333;">${e}</h2>
        <p>${t}</p>
        ${a?`
          <p style="margin-top: 20px;">
            <a href="${a}" style="background-color: #4370d1; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
              ${s||"Ver mais"}
            </a>
          </p>
        `:""}
      </div>
    `}),meetingScheduled:(e,t,a,s,r)=>({subject:`Reuni\xe3o Agendada - ${t} \xe0s ${a}`,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2 style="color: #4370d1;">Reuni\xe3o Confirmada! ðŸ“…</h2>
        <p>Ol\xe1 ${e},</p>
        <p>Sua reuni\xe3o foi agendada com sucesso.</p>
        <div style="background-color: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
          <p><strong>Data:</strong> ${t}</p>
          <p><strong>Hor\xe1rio:</strong> ${a}</p>
          ${r?`<p><strong>Descri\xe7\xe3o:</strong> ${r}</p>`:""}
        </div>
        <p>
          <a href="${s}" style="background-color: #4370d1; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
            Entrar na Reuni\xe3o
          </a>
        </p>
        <p style="color: #666; font-size: 12px; margin-top: 20px;">
          Adicione este evento ao seu calend\xe1rio para n\xe3o esquecer!
        </p>
      </div>
    `}),invoice:(e,t,a,s,r)=>({subject:`Fatura #${t} - Pagamento Pendente`,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2 style="color: #333;">Fatura #${t}</h2>
        <p>Ol\xe1 ${e},</p>
        <p>Segue sua fatura para pagamento:</p>
        <div style="background-color: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
          <p><strong>Valor:</strong> ${a}</p>
          <p><strong>Vencimento:</strong> ${s}</p>
        </div>
        <p>
          <a href="${r}" style="background-color: #22c55e; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
            Pagar Agora
          </a>
        </p>
      </div>
    `})}},39449:(e,t,a)=>{a.d(t,{SP:()=>n,lW:()=>i,nw:()=>o});let s="https://graph.facebook.com/v18.0";class r{constructor(e){this.accessToken=e.accessToken,this.phoneNumberId=e.phoneNumberId,this.businessId=e.businessId}async request(e,t={}){let a=`${s}${e}`,r=await fetch(a,{...t,headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json",...t.headers}}),n=await r.json();if(n.error)throw Error(`WhatsApp API Error: ${n.error.message}`);return n}async sendTextMessage(e,t,a=!1){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"text",text:{preview_url:a,body:t}})})}async sendImage(e,t,a){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"image",image:{link:t,caption:a}})})}async sendDocument(e,t,a,s){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"document",document:{link:t,filename:a,caption:s}})})}async sendTemplate(e,t,a="pt_BR",s){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"template",template:{name:t,language:{code:a},components:s}})})}async sendInteractiveButtons(e,t,a,s,r){let n={type:"button",body:{text:t},action:{buttons:a.map(e=>({type:"reply",reply:{id:e.id,title:e.title}}))}};return s&&(n.header={type:"text",text:s}),r&&(n.footer={text:r}),this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"interactive",interactive:n})})}async sendInteractiveList(e,t,a,s,r,n){let i={type:"list",body:{text:t},action:{button:a,sections:s}};return r&&(i.header={type:"text",text:r}),n&&(i.footer={text:n}),this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"interactive",interactive:i})})}async markAsRead(e){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",status:"read",message_id:e})})}async uploadMedia(e,t,a){let r;let n=new FormData;return e instanceof ArrayBuffer?r=e:(Array.isArray(e),r=new Uint8Array(e)),n.append("file",new Blob([r],{type:t}),a),n.append("messaging_product","whatsapp"),n.append("type",t),(await fetch(`${s}/${this.phoneNumberId}/media`,{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`},body:n})).json()}async getMediaUrl(e){return this.request(`/${e}`)}async listTemplates(){if(!this.businessId)throw Error("Business ID n\xe3o configurado");return this.request(`/${this.businessId}/message_templates`)}async getBusinessProfile(){return this.request(`/${this.phoneNumberId}/whatsapp_business_profile?fields=about,address,description,email,profile_picture_url,websites,vertical`)}async updateBusinessProfile(e){return this.request(`/${this.phoneNumberId}/whatsapp_business_profile`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",...e})})}formatPhoneNumber(e){let t=e.replace(/\D/g,"");return!t.startsWith("55")&&t.length<=11&&(t="55"+t),t}}function n(e){return new r(e)}function i(e,t,a,s){return"subscribe"===e&&t===s?a:null}function o(e){let t=[],a=[];for(let s of e.entry)for(let e of s.changes){let s=e.value;if(s.messages)for(let e of s.messages){let a=s.contacts?.find(t=>t.wa_id===e.from);t.push({from:e.from,name:a?.profile?.name,id:e.id,timestamp:new Date(1e3*parseInt(e.timestamp)),type:e.type,content:e.text?.body||e.image||e.document||e.button||e.interactive})}if(s.statuses)for(let e of s.statuses)a.push({messageId:e.id,status:e.status,timestamp:new Date(1e3*parseInt(e.timestamp)),to:e.recipient_id,error:e.errors?.[0]?.title})}return{messages:t,statuses:a}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[89276,55972,54128,20958],()=>a(16079));module.exports=s})();