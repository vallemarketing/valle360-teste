"use strict";(()=>{var e={};e.id=20798,e.ids=[20798],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},21764:e=>{e.exports=require("util")},3590:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>S,patchFetch:()=>x,requestAsyncStorage:()=>v,routeModule:()=>b,serverHooks:()=>w,staticGenerationAsyncStorage:()=>h});var r={};i.r(r),i.d(r,{POST:()=>y,dynamic:()=>_,runtime:()=>g});var a=i(49303),s=i(88716),n=i(60670),o=i(87070),c=i(54128),d=i(46691),u=i(30920),p=i(49805),l=i(14399),m=i(46882);let _="force-dynamic",g="nodejs";async function y(e){try{let t;let i="https://ikjgsqtykkhqimypacro.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!i||!r)return console.error("Supabase n\xe3o configurado"),o.NextResponse.json({error:"Configura\xe7\xe3o inv\xe1lida"},{status:500});let a=(0,c.eI)(i,r),{data:s}=await a.from("integration_configs").select("webhook_secret").eq("integration_id","stripe").single(),n=s?.webhook_secret||process.env.STRIPE_WEBHOOK_SECRET;if(!n)return console.error("Webhook secret n\xe3o configurado"),o.NextResponse.json({error:"Webhook n\xe3o configurado"},{status:400});let u=await e.text(),p=e.headers.get("stripe-signature");if(!p)return o.NextResponse.json({error:"Signature ausente"},{status:400});try{t=(0,d.MP)(u,p,n)}catch(e){return console.error("Erro na verifica\xe7\xe3o do webhook:",e.message),o.NextResponse.json({error:"Webhook inv\xe1lido"},{status:400})}let l=await f(t,a);return await a.from("integration_logs").insert({integration_id:"stripe",action:`webhook_${t.type}`,status:l.success?"success":"error",request_data:{eventId:t.id,eventType:t.type},response_data:l,error_message:l.error}),o.NextResponse.json({received:!0,processed:l.success})}catch(e){return console.error("Erro no webhook Stripe:",e),o.NextResponse.json({error:"Erro interno",details:e.message},{status:500})}}async function f(e,t){try{switch(e.type){case"checkout.session.completed":{let i=e.data.object;return"subscription"===i.mode?await t.from("subscriptions").upsert({stripe_subscription_id:i.subscription,stripe_customer_id:i.customer,user_id:i.metadata?.userId,status:"active",created_at:new Date().toISOString()}):await t.from("payments").insert({stripe_payment_intent_id:i.payment_intent,stripe_customer_id:i.customer,user_id:i.metadata?.userId,amount:i.amount_total,currency:i.currency,status:"completed",created_at:new Date().toISOString()}),{success:!0,action:"checkout_completed"}}case"payment_intent.succeeded":{let i=e.data.object;return await t.from("payments").upsert({stripe_payment_intent_id:i.id,stripe_customer_id:i.customer,amount:i.amount,currency:i.currency,status:"succeeded",updated_at:new Date().toISOString()},{onConflict:"stripe_payment_intent_id"}),{success:!0,action:"payment_succeeded"}}case"payment_intent.payment_failed":{let i=e.data.object;return await t.from("payments").upsert({stripe_payment_intent_id:i.id,status:"failed",error_message:i.last_payment_error?.message,updated_at:new Date().toISOString()},{onConflict:"stripe_payment_intent_id"}),{success:!0,action:"payment_failed"}}case"customer.subscription.created":{let i=e.data.object;return await t.from("subscriptions").upsert({stripe_subscription_id:i.id,stripe_customer_id:i.customer,status:i.status,current_period_start:new Date(1e3*i.current_period_start).toISOString(),current_period_end:new Date(1e3*i.current_period_end).toISOString(),created_at:new Date().toISOString()},{onConflict:"stripe_subscription_id"}),{success:!0,action:"subscription_created"}}case"customer.subscription.updated":{let i=e.data.object;return await t.from("subscriptions").update({status:i.status,current_period_start:new Date(1e3*i.current_period_start).toISOString(),current_period_end:new Date(1e3*i.current_period_end).toISOString(),cancel_at_period_end:i.cancel_at_period_end,updated_at:new Date().toISOString()}).eq("stripe_subscription_id",i.id),{success:!0,action:"subscription_updated"}}case"customer.subscription.deleted":{let i=e.data.object;return await t.from("subscriptions").update({status:"canceled",canceled_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("stripe_subscription_id",i.id),{success:!0,action:"subscription_canceled"}}case"invoice.paid":{let i=e.data.object,r="string"==typeof i.customer?i.customer:i.customer?.id,a="string"==typeof i.subscription?i.subscription:i.subscription?.id,s="string"!=typeof i.customer&&i.customer&&"email"in i.customer&&"string"==typeof i.customer.email?i.customer.email:void 0,n=i.customer_email??s??void 0,o=null;if(r){let{data:e}=await t.from("clients").select("id").eq("stripe_customer_id",r).limit(1).single();o=e?.id||null}if(!o&&n){let{data:e}=await t.from("clients").select("id").or(`email.eq.${n},contact_email.eq.${n}`).limit(1).single();o=e?.id||null}if(!o)return{success:!1,error:"N\xe3o foi poss\xedvel identificar client_id para invoice.paid"};let c=new Date(1e3*(i.created||Date.now()/1e3)).toISOString().slice(0,10),d=new Date(1e3*(i.due_date||i.created||Date.now()/1e3)).toISOString().slice(0,10),l=Math.round(i.amount_due||i.amount_paid||0)/100,m=null,{data:_}=await t.from("invoices").select("id, client_id, contract_id, invoice_number, amount, due_date, status").eq("stripe_invoice_id",i.id).limit(1).maybeSingle();if(!(m=_||null)){let{data:e}=await t.from("invoices").select("id, client_id, contract_id, invoice_number, amount, due_date, status").eq("client_id",o).in("status",["pending","payment_failed"]).eq("due_date",d).eq("amount",l).order("created_at",{ascending:!1}).limit(1).maybeSingle();m=e||null}if(m?.id){let{data:e,error:s}=await t.from("invoices").update({stripe_invoice_id:i.id,stripe_customer_id:r,stripe_subscription_id:a,payment_method:i.collection_method||null,amount_paid:i.amount_paid||0,currency:i.currency,status:"paid",paid_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",m.id).select("id, client_id, contract_id, invoice_number").single();if(s)throw s;m=e}else{let{data:e,error:s}=await t.from("invoices").insert({client_id:o,stripe_invoice_id:i.id,stripe_customer_id:r,stripe_subscription_id:a,invoice_number:i.number||`STRIPE-${i.id}`,amount:l,amount_paid:i.amount_paid||0,currency:i.currency,issue_date:c,due_date:d,status:"paid",paid_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select("id, client_id, contract_id, invoice_number").single();if(s)throw s;m=e}let g=await (0,u.Kn)({eventType:"invoice.paid",entityType:"invoice",entityId:m?.id,actorUserId:null,payload:{stripe_event_id:e.id,stripe_invoice_id:i.id,stripe_customer_id:r,stripe_subscription_id:a,client_id:m?.client_id||o,contract_id:m?.contract_id||null,invoice_number:m?.invoice_number||i.number,amount:l,amount_paid:i.amount_paid||0,currency:i.currency,due_date:d,customer_email:n||null}},t);try{let e=await (0,p.Z)(g);e.ok?await (0,u.ls)(g.id,t):await (0,u.bT)(g.id,e.error,t)}catch(e){await (0,u.bT)(g.id,e?.message||"Erro ao processar evento invoice.paid",t)}return{success:!0,action:"invoice_paid"}}case"invoice.payment_failed":{let i=e.data.object,r="string"==typeof i.customer?i.customer:i.customer?.id,a="string"==typeof i.subscription?i.subscription:i.subscription?.id,s="string"!=typeof i.customer&&i.customer&&"email"in i.customer&&"string"==typeof i.customer.email?i.customer.email:void 0,n=i.customer_email??s??void 0,o=null;if(r){let{data:e}=await t.from("clients").select("id").eq("stripe_customer_id",r).limit(1).single();o=e?.id||null}if(!o&&n){let{data:e}=await t.from("clients").select("id").or(`email.eq.${n},contact_email.eq.${n}`).limit(1).single();o=e?.id||null}if(!o)return{success:!1,error:"N\xe3o foi poss\xedvel identificar client_id para invoice.payment_failed"};let c=new Date(1e3*(i.due_date||i.created||Date.now()/1e3)).toISOString().slice(0,10),d=Math.round(i.amount_due||i.amount_paid||0)/100,_=null,{data:g}=await t.from("invoices").select("id, client_id, contract_id, invoice_number, amount, due_date, status").eq("stripe_invoice_id",i.id).limit(1).maybeSingle();if(!(_=g||null)){let{data:e}=await t.from("invoices").select("id, client_id, contract_id, invoice_number, amount, due_date, status").eq("client_id",o).in("status",["pending","payment_failed"]).eq("due_date",c).eq("amount",d).order("created_at",{ascending:!1}).limit(1).maybeSingle();_=e||null}if(_?.id){let{data:e,error:s}=await t.from("invoices").update({stripe_invoice_id:i.id,stripe_customer_id:r,stripe_subscription_id:a,amount_paid:i.amount_paid||0,currency:i.currency,status:"payment_failed",updated_at:new Date().toISOString()}).eq("id",_.id).select("id, client_id, contract_id, invoice_number").single();if(s)throw s;_=e}else{let{data:e,error:s}=await t.from("invoices").insert({client_id:o,stripe_invoice_id:i.id,stripe_customer_id:r,stripe_subscription_id:a,invoice_number:i.number||`STRIPE-${i.id}`,amount:d,amount_paid:i.amount_paid||0,currency:i.currency,issue_date:new Date(1e3*(i.created||Date.now()/1e3)).toISOString().slice(0,10),due_date:c,status:"payment_failed",updated_at:new Date().toISOString()}).select("id, client_id, contract_id, invoice_number").single();if(s)throw s;_=e}let y=await (0,u.Kn)({eventType:"invoice.payment_failed",entityType:"invoice",entityId:_?.id,actorUserId:null,payload:{stripe_event_id:e.id,stripe_invoice_id:i.id,stripe_customer_id:r,stripe_subscription_id:a,client_id:_?.client_id||o,contract_id:_?.contract_id||null,invoice_number:_?.invoice_number||i.number,amount:d,currency:i.currency,due_date:c,customer_email:n||null}},t);try{let e=await (0,p.Z)(y);e.ok?await (0,u.ls)(y.id,t):await (0,u.bT)(y.id,e.error,t)}catch(e){await (0,u.bT)(y.id,e?.message||"Erro ao processar evento invoice.payment_failed",t)}let f="Pagamento falhou (Stripe)",b=i?.hosted_invoice_url?String(i.hosted_invoice_url):"",v=`Falha no pagamento da fatura ${i.number||i.id} (vencimento: ${c}).`;try{await (0,l.Q)({area:"Financeiro",title:f,message:v,link:"/admin/dashboard",type:"stripe",metadata:{stripe_invoice_id:i.id,stripe_customer_id:r,client_id:_?.client_id||o,invoice_id:_?.id||null,invoice_number:i.number||null,hosted_invoice_url:b||null}})}catch{}try{let e=(process.env.SENDGRID_API_KEY||"").trim(),{data:i}=await t.from("integration_configs").select("status, api_key, config").eq("integration_id","sendgrid").maybeSingle(),r=(i?.status==="connected"?String(i?.api_key||""):"").trim(),a=i?.config?.fromEmail||process.env.SENDGRID_FROM_EMAIL||"noreply@valle360.com.br",s=i?.config?.fromName||process.env.SENDGRID_FROM_NAME||"Valle 360",n=String(process.env.FINANCE_ALERT_EMAILS||"").split(",").map(e=>e.trim()).filter(Boolean);if(n.length>0){let t=(0,m.w2)({apiKey:r||e||"mailto",fromEmail:a,fromName:s}),i=m.qC.notification(f,v,b||void 0,b?"Abrir fatura":void 0);await t.sendEmail({to:n.map(e=>({email:e})),subject:i.subject,html:i.html,categories:["valle360","stripe"]})}}catch{}return{success:!0,action:"invoice_payment_failed"}}case"customer.created":{let i=e.data.object;return i.email&&await t.from("clients").update({stripe_customer_id:i.id}).or(`email.eq.${i.email},contact_email.eq.${i.email}`),{success:!0,action:"customer_created"}}case"customer.updated":{let i=e.data.object;return await t.from("clients").update({updated_at:new Date().toISOString()}).eq("stripe_customer_id",i.id),{success:!0,action:"customer_updated"}}case"charge.dispute.created":{let i=e.data.object;return await t.from("payment_disputes").insert({stripe_dispute_id:i.id,stripe_charge_id:i.charge,amount:i.amount,currency:i.currency,reason:i.reason,status:i.status,created_at:new Date().toISOString()}),{success:!0,action:"dispute_created"}}default:return console.log(`Evento Stripe n\xe3o tratado: ${e.type}`),{success:!0,action:"ignored"}}}catch(t){return console.error(`Erro ao processar evento ${e.type}:`,t),{success:!1,error:t.message}}}let b=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\webhooks\\stripe\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:v,staticGenerationAsyncStorage:h,serverHooks:w}=b,S="/api/webhooks/stripe/route";function x(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:h})}},46882:(e,t,i)=>{i.d(t,{Rp:()=>r,qC:()=>s,w2:()=>a});class r{constructor(e){this.apiKey=e.apiKey,this.fromEmail=e.fromEmail,this.fromName=e.fromName}async request(e,t={}){let i=await fetch(`https://api.sendgrid.com/v3${e}`,{...t,headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json",...t.headers}});if(202===i.status||200===i.status||201===i.status){let e=await i.text();return e?JSON.parse(e):{success:!0}}let r=await i.json();throw Error(r.errors?.[0]?.message||"Erro na API SendGrid")}async sendEmail(e){let t=Array.isArray(e.to)?e.to:[e.to],i=t[0]?.email||"",r=e.subject||"",a=(e.text||e.html||"").replace(/<[^>]+>/g,"").trim();return{success:!0,mailtoUrl:`mailto:${i}?subject=${encodeURIComponent(r)}&body=${encodeURIComponent(a)}`}}async sendBulkEmail(e,t){return{success:0,failed:e.length,errors:["Envio em lote n\xe3o suportado via mailto. Use envio manual."]}}async listTemplates(){return this.request("/templates?generations=dynamic")}async getTemplate(e){return this.request(`/templates/${e}`)}async getStats(e,t){let i=`/stats?start_date=${e}`;return t&&(i+=`&end_date=${t}`),this.request(i)}async getCategoryStats(e,t,i){let r=`/categories/${e}/stats?start_date=${t}`;return i&&(r+=`&end_date=${i}`),this.request(r)}async addContact(e,t){let i={email:e};t?.firstName&&(i.first_name=t.firstName),t?.lastName&&(i.last_name=t.lastName),t?.customFields&&(i.custom_fields=t.customFields);let r={contacts:[i]};return t?.listIds&&(r.list_ids=t.listIds),this.request("/marketing/contacts",{method:"PUT",body:JSON.stringify(r)})}async searchContacts(e){return this.request("/marketing/contacts/search",{method:"POST",body:JSON.stringify({query:e})})}async deleteContact(e){return this.request(`/marketing/contacts?ids=${e}`,{method:"DELETE"})}async getLists(){return this.request("/marketing/lists")}async createList(e){return this.request("/marketing/lists",{method:"POST",body:JSON.stringify({name:e})})}async addToSuppressionList(e,t){let i="unsubscribes"===t?"/asm/suppressions/global":`/suppression/${t}`;await this.request(i,{method:"POST",body:JSON.stringify({recipient_emails:e})})}async getSuppressionList(e){let t="unsubscribes"===e?"/asm/suppressions/global":`/suppression/${e}`;return this.request(t)}}function a(e){return new r(e)}let s={welcome:(e,t)=>({subject:`Bem-vindo \xe0 ${t}! ðŸŽ‰`,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h1 style="color: #4370d1;">Ol\xe1, ${e}!</h1>
        <p>Seja muito bem-vindo(a) \xe0 ${t}!</p>
        <p>Estamos muito felizes em ter voc\xea conosco. A partir de agora, voc\xea ter\xe1 acesso a todas as nossas ferramentas e recursos.</p>
        <p>Se precisar de ajuda, n\xe3o hesite em entrar em contato.</p>
        <p>Abra\xe7os,<br/>Equipe ${t}</p>
      </div>
    `}),notification:(e,t,i,r)=>({subject:e,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2 style="color: #333;">${e}</h2>
        <p>${t}</p>
        ${i?`
          <p style="margin-top: 20px;">
            <a href="${i}" style="background-color: #4370d1; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
              ${r||"Ver mais"}
            </a>
          </p>
        `:""}
      </div>
    `}),meetingScheduled:(e,t,i,r,a)=>({subject:`Reuni\xe3o Agendada - ${t} \xe0s ${i}`,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2 style="color: #4370d1;">Reuni\xe3o Confirmada! ðŸ“…</h2>
        <p>Ol\xe1 ${e},</p>
        <p>Sua reuni\xe3o foi agendada com sucesso.</p>
        <div style="background-color: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
          <p><strong>Data:</strong> ${t}</p>
          <p><strong>Hor\xe1rio:</strong> ${i}</p>
          ${a?`<p><strong>Descri\xe7\xe3o:</strong> ${a}</p>`:""}
        </div>
        <p>
          <a href="${r}" style="background-color: #4370d1; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
            Entrar na Reuni\xe3o
          </a>
        </p>
        <p style="color: #666; font-size: 12px; margin-top: 20px;">
          Adicione este evento ao seu calend\xe1rio para n\xe3o esquecer!
        </p>
      </div>
    `}),invoice:(e,t,i,r,a)=>({subject:`Fatura #${t} - Pagamento Pendente`,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2 style="color: #333;">Fatura #${t}</h2>
        <p>Ol\xe1 ${e},</p>
        <p>Segue sua fatura para pagamento:</p>
        <div style="background-color: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
          <p><strong>Valor:</strong> ${i}</p>
          <p><strong>Vencimento:</strong> ${r}</p>
        </div>
        <p>
          <a href="${a}" style="background-color: #22c55e; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
            Pagar Agora
          </a>
        </p>
      </div>
    `})}},46691:(e,t,i)=>{i.d(t,{MP:()=>o,Mc:()=>n,w:()=>s});var r=i(48472);let a=null;function s(e){let t=e||process.env.STRIPE_SECRET_KEY;if(!t)throw Error("Stripe Secret Key n\xe3o configurada");return(!a||e)&&(a=new r.Z(t,{apiVersion:"2023-10-16",typescript:!0})),a}async function n(e,t){let i=s(t),r=e.lineItems.map(e=>e.priceId?{price:e.priceId,quantity:e.quantity}:{price_data:{currency:"brl",product_data:{name:e.name||"Produto"},unit_amount:e.amount||0},quantity:e.quantity});return i.checkout.sessions.create({customer:e.customerId,customer_email:e.customerEmail,line_items:r,mode:e.mode,success_url:e.successUrl,cancel_url:e.cancelUrl,metadata:e.metadata})}function o(e,t,i){return s().webhooks.constructEvent(e,t,i)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,2749,6684,48472,40074,38823],()=>i(3590));module.exports=r})();