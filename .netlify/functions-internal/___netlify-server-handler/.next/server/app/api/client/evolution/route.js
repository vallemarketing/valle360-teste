"use strict";(()=>{var e={};e.id=59784,e.ids=[59784],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},25182:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>S,requestAsyncStorage:()=>v,routeModule:()=>h,serverHooks:()=>y,staticGenerationAsyncStorage:()=>_});var i={};a.r(i),a.d(i,{GET:()=>f,dynamic:()=>d});var r=a(49303),n=a(88716),s=a(60670),o=a(87070),l=a(20344),c=a(71615),u=a(90176);let d="force-dynamic";function m(e){let t=Number(e);return Number.isFinite(t)?t:0}function p(e){let t=String(e?.message||"").toLowerCase();return"42P01"===String(e?.code||"")||t.includes("relation")||t.includes("does not exist")}function g(e){let[t,a]=e.split("-").map(e=>Number(e));if(!t||!a)return e;let i=new Date(Date.UTC(t,a-1,1)),r=new Intl.DateTimeFormat("pt-BR",{month:"short",timeZone:"America/Sao_Paulo"}).format(i).replace(".","");return(r.charAt(0).toUpperCase()+r.slice(1)).slice(0,3)}async function f(e){try{let t=(0,c.cookies)(),a=(0,l.createRouteHandlerClient)({cookies:()=>t}),{data:i}=await a.auth.getUser(),r=i?.user;if(!r)return o.NextResponse.json({success:!1,error:"N\xe3o autorizado"},{status:401});let n=(0,u.t)(),{data:s,error:d}=await n.from("clients").select("id, created_at").eq("user_id",r.id).maybeSingle();if(d)return o.NextResponse.json({success:!1,error:d.message},{status:500});let f=s?.id?String(s.id):null;if(!f)return o.NextResponse.json({success:!1,error:"Cliente n\xe3o vinculado (clients.user_id)"},{status:400});let{searchParams:h}=new URL(e.url),v=Number(h.get("months")||6),_=Math.max(1,Math.min(24,Number.isFinite(v)?Math.floor(v):6)),y=new Date,w=new Date;w.setUTCDate(1),w.setUTCMonth(w.getUTCMonth()-(_-1)),w.setUTCHours(0,0,0,0);let S=function(e,t){let a=[],i=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),1)),r=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),1)),n=i;for(;n.getTime()<=r.getTime();){let e=n.getUTCFullYear(),t=String(n.getUTCMonth()+1).padStart(2,"0");a.push(`${e}-${t}`),n=new Date(Date.UTC(e,n.getUTCMonth()+1,1))}return a}(w,y),U={};for(let e of S)U[e]={impressions:0,reach:0,engaged:0,profile_views:0,fansLast:0,fansFirst:0,days:0,hasFans:!1};let C=!1;try{let e=w.toISOString().slice(0,10),{data:t,error:a}=await n.from("social_account_metrics_daily").select("metric_date, metrics").eq("client_id",f).gte("metric_date",e).order("metric_date",{ascending:!0}).limit(5e3);if(a)throw a;for(let e of t||[]){let t=String(e.metric_date||"");if(!t)continue;let a=t.slice(0,7);if(!U[a])continue;let i=e.metrics||{},r=m(i.impressions??i.page_impressions??0),n=m(i.reach??0),s=m(i.page_engaged_users??0),o=m(i.profile_views??0),l=m(i.page_fans??0);U[a].impressions+=r,U[a].reach+=n,U[a].engaged+=s,U[a].profile_views+=o,U[a].days+=1,l&&(U[a].hasFans?U[a].fansLast=l:(U[a].fansFirst=l,U[a].fansLast=l,U[a].hasFans=!0))}C=!0,C=Object.values(U).some(e=>e.days>0)}catch(e){p(e),C=!1}let x=S.map(e=>({month:g(e),value:U[e].hasFans?U[e].fansLast:0})),T=S.map(e=>({month:g(e),value:U[e].days?Math.round(U[e].reach/U[e].days):0})),b=S.map(e=>{let t=U[e].impressions,a=t?U[e].engaged/t*100:0;return{month:g(e),value:Math.round(10*a)/10}}),q=S.map(e=>({month:g(e),value:Math.round(U[e].profile_views)})),R=[{key:"followers",unit:"",startValue:x[0]?.value||0,currentValue:x[x.length-1]?.value||0,series:x},{key:"reach_avg",unit:"",startValue:T[0]?.value||0,currentValue:T[T.length-1]?.value||0,series:T},{key:"engagement_rate",unit:"%",startValue:b[0]?.value||0,currentValue:b[b.length-1]?.value||0,series:b},{key:"profile_views",unit:"",startValue:q[0]?.value||0,currentValue:q[q.length-1]?.value||0,series:q}],A=[],D=e=>A.push(e);try{let{data:e,error:t}=await n.from("client_ai_insights").select("id,title,created_at").eq("client_id",f).order("created_at",{ascending:!1}).limit(10);if(t)throw t;for(let t of e||[])D({id:`insight:${t.id}`,date:String(t.created_at),title:t.title?`Insight gerado: ${String(t.title)}`:"Novo insight gerado",description:"A Val gerou um insight com recomenda\xe7\xf5es para o seu neg\xf3cio.",type:"growth"})}catch(e){p(e)}try{let{data:e,error:t}=await n.from("files").select("id,file_name,created_at").eq("client_id",f).order("created_at",{ascending:!1}).limit(10);if(t)throw t;for(let t of e||[])D({id:`file:${t.id}`,date:String(t.created_at),title:t.file_name?`Arquivo enviado: ${String(t.file_name)}`:"Novo arquivo enviado",description:"Um novo arquivo foi adicionado ao seu painel.",type:"feature"})}catch(e){p(e)}try{let{data:e,error:t}=await n.from("event_log").select("id,event_type,created_at,payload").order("created_at",{ascending:!1}).limit(60);if(t)throw t;for(let t of e||[]){let e=t.payload||{},a=String(e.client_id||e.clientId||"").trim();if(!a||a!==f)continue;let i=String(t.event_type||"").toLowerCase();i&&("invoice.paid"===i?D({id:`event:${t.id}`,date:String(t.created_at),title:"Pagamento confirmado",description:"Recebemos a confirma\xe7\xe3o de pagamento de uma fatura.",type:"achievement"}):i.includes("approval")?D({id:`event:${t.id}`,date:String(t.created_at),title:"Aprova\xe7\xe3o registrada",description:"Um item foi aprovado ou recebeu solicita\xe7\xe3o de ajustes.",type:"campaign"}):(i.includes("kanban")||i.includes("task"))&&D({id:`event:${t.id}`,date:String(t.created_at),title:"Atualiza\xe7\xe3o no Kanban",description:"Houve movimenta\xe7\xe3o/atualiza\xe7\xe3o em tarefas do seu projeto.",type:"feature"}))}}catch(e){p(e)}if(C){let e=S[0];D({id:"social:start",date:new Date(Date.UTC(Number(e.slice(0,4)),Number(e.slice(5,7))-1,1)).toISOString(),title:"In\xedcio do monitoramento social",description:"Come\xe7amos a coletar m\xe9tricas org\xe2nicas das suas redes sociais.",type:"feature"})}let j=Array.from(new Map(A.map(e=>[e.id,e])).values()).sort((e,t)=>new Date(t.date).getTime()-new Date(e.date).getTime()).slice(0,12);return o.NextResponse.json({success:!0,client_id:f,join_date:s?.created_at?String(s.created_at):null,months:_,hasSocial:C,metrics:R,milestones:j})}catch(e){return o.NextResponse.json({success:!1,error:e?.message||"Erro interno"},{status:500})}}let h=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/client/evolution/route",pathname:"/api/client/evolution",filename:"route",bundlePath:"app/api/client/evolution/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\evolution\\route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:v,staticGenerationAsyncStorage:_,serverHooks:y}=h,w="/api/client/evolution/route";function S(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:_})}},90176:(e,t,a)=>{a.d(t,{t:()=>r});var i=a(54128);function r(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,i.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),i=t.X(0,[89276,55972,54128,20958],()=>a(25182));module.exports=i})();