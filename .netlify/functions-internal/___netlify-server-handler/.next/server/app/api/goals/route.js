"use strict";(()=>{var e={};e.id=68677,e.ids=[68677],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},80488:(e,s,t)=>{t.r(s),t.d(s,{originalPathname:()=>h,patchFetch:()=>_,requestAsyncStorage:()=>N,routeModule:()=>y,serverHooks:()=>b,staticGenerationAsyncStorage:()=>R});var r={};t.r(r),t.d(r,{GET:()=>x,POST:()=>f,PUT:()=>j,dynamic:()=>g});var o=t(49303),a=t(88716),n=t(60670),i=t(87070),c=t(9792),u=t(54128),l=t(71615),d=t(20344),p=t(90176);let g="force-dynamic";async function m(e){let{supabaseUser:s}=function(e){let s=(0,l.cookies)(),t=(0,d.createRouteHandlerClient)({cookies:()=>s}),r=e.headers.get("authorization")||e.headers.get("Authorization")||"",o=r.toLowerCase().startsWith("bearer ")?r.slice(7).trim():null;return{supabaseUser:o?(0,u.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${o}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):t}}(e),{data:t}=await s.auth.getUser(),r=t.user?.id;if(!r)throw Error("N\xe3o autorizado");let{data:o}=await s.rpc("is_admin"),a=(0,p.t)(),{data:n}=await a.from("employees").select("id").eq("user_id",r).maybeSingle();return{userId:r,isAdmin:!!o,employeeId:n?.id?String(n.id):null}}async function x(e){try{let s=(0,p.t)(),t=await m(e),{searchParams:r}=new URL(e.url),o=r.get("collaborator_id"),a=r.get("sector"),n=r.get("status");if(!o&&!t.isAdmin&&!t.employeeId)return i.NextResponse.json({success:!1,error:"Colaborador n\xe3o vinculado (employees)"},{status:400});let c=o||t.employeeId;if(c&&t.employeeId&&c!==t.employeeId&&!t.isAdmin)return i.NextResponse.json({success:!1,error:"Acesso negado"},{status:403});let u=s.from("collaborator_goals").select("*");c&&(u=u.eq("collaborator_id",c)),a&&(u=u.eq("sector",a)),n&&(u=u.eq("status",n));let{data:l,error:d}=await u.order("created_at",{ascending:!1});if(d)return i.NextResponse.json({success:!1,error:d.message},{status:500});return i.NextResponse.json({success:!0,data:l})}catch(t){let e=String(t?.message||t),s=e.includes("N\xe3o autorizado")?401:500;return i.NextResponse.json({success:!1,error:e},{status:s})}}async function f(e){try{let s=await m(e),t=(0,p.t)(),{action:r,...o}=await e.json();switch(r){case"generate_all":{if(!s.isAdmin)return i.NextResponse.json({success:!1,error:"Acesso negado (admin)"},{status:403});let e=o.period_type||"monthly",{data:r,error:a}=await t.from("employees").select("id, user_id, full_name, area_of_expertise, department").limit(500);if(a)return i.NextResponse.json({success:!1,error:a.message},{status:500});let n=0,u=[];for(let s of r||[]){let t=String(s.full_name||"").trim()||"Colaborador",r=String(s.area_of_expertise||s.department||""),o=function(e){let s=(e||"").toLowerCase();return s.includes("social")?"social_media":s.includes("trafego")?"trafego":s.includes("video")?"video_maker":s.includes("comercial")?"comercial":(s.includes("design")||s.includes("web"),"designer")}(r),a=await c.n.createGoal(String(s.id),t,o,e);a&&(n+=1,u.push(a))}return i.NextResponse.json({success:!0,generated:n,data:u})}case"generate":{let{collaborator_id:e,collaborator_name:t,sector:r,period_type:a}=o;if(!e||!r)return i.NextResponse.json({success:!1,error:"collaborator_id e sector s\xe3o obrigat\xf3rios"},{status:400});if(String(e)!==String(s.employeeId||"")&&!s.isAdmin)return i.NextResponse.json({success:!1,error:"Acesso negado"},{status:403});let n=await c.n.createGoal(e,t||"Colaborador",r,a||"monthly");return i.NextResponse.json({success:!0,data:n})}case"suggest":{let{collaborator_id:e,sector:t,period_type:r}=o;if(!e||!t)return i.NextResponse.json({success:!1,error:"collaborator_id e sector s\xe3o obrigat\xf3rios"},{status:400});if(String(e)!==String(s.employeeId||"")&&!s.isAdmin)return i.NextResponse.json({success:!1,error:"Acesso negado"},{status:403});let a=await c.n.calculateSuggestedGoals(e,t,r||"monthly");return i.NextResponse.json({success:!0,data:a})}case"update_progress":{let{goal_id:e,metric_name:r,value:a}=o;if(!e||!r)return i.NextResponse.json({success:!1,error:"goal_id e metric_name s\xe3o obrigat\xf3rios"},{status:400});let{data:n}=await t.from("collaborator_goals").select("id, collaborator_id").eq("id",e).maybeSingle();if(!n)return i.NextResponse.json({success:!1,error:"Meta n\xe3o encontrada"},{status:404});if(String(n.collaborator_id)!==String(s.employeeId||"")&&!s.isAdmin)return i.NextResponse.json({success:!1,error:"Acesso negado"},{status:403});let u=await c.n.updateProgress(e,r,Number(a||0));return i.NextResponse.json({success:!0,data:u})}case"check_alerts":if(!s.isAdmin)return i.NextResponse.json({success:!1,error:"Acesso negado (admin)"},{status:403});return await c.n.checkAndCreateAlerts(),i.NextResponse.json({success:!0,message:"Alertas verificados"});default:return i.NextResponse.json({success:!1,error:"A\xe7\xe3o inv\xe1lida"},{status:400})}}catch(t){let e=String(t?.message||t),s=e.includes("N\xe3o autorizado")?401:500;return i.NextResponse.json({success:!1,error:e},{status:s})}}async function j(e){try{let s=await m(e),t=(0,p.t)(),{id:r,...o}=await e.json();if(!r)return i.NextResponse.json({success:!1,error:"ID da meta \xe9 obrigat\xf3rio"},{status:400});let{data:a}=await t.from("collaborator_goals").select("id, collaborator_id").eq("id",r).maybeSingle();if(!a)return i.NextResponse.json({success:!1,error:"Meta n\xe3o encontrada"},{status:404});if(String(a.collaborator_id)!==String(s.employeeId||"")&&!s.isAdmin)return i.NextResponse.json({success:!1,error:"Acesso negado"},{status:403});let n={...o,updated_at:new Date().toISOString()};n.ai_suggested||(n.adjusted_by=n.adjusted_by??s.userId);let{data:c,error:u}=await t.from("collaborator_goals").update(n).eq("id",r).select().single();if(u)return i.NextResponse.json({success:!1,error:u.message},{status:500});return i.NextResponse.json({success:!0,data:c})}catch(t){let e=String(t?.message||t),s=e.includes("N\xe3o autorizado")?401:500;return i.NextResponse.json({success:!1,error:e},{status:s})}}let y=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/goals/route",pathname:"/api/goals",filename:"route",bundlePath:"app/api/goals/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\goals\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:N,staticGenerationAsyncStorage:R,serverHooks:b}=y,h="/api/goals/route";function _(){return(0,n.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:R})}}};var s=require("../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[89276,55972,54128,20958,40074],()=>t(80488));module.exports=r})();