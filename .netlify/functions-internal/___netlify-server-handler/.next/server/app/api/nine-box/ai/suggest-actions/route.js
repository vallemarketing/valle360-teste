"use strict";(()=>{var e={};e.id=27602,e.ids=[27602],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},31049:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>E,requestAsyncStorage:()=>x,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{POST:()=>_,dynamic:()=>m});var o=r(49303),a=r(88716),s=r(60670),i=r(87070),l=r(20344),u=r(71615),c=r(96263),p=r(52390),d=r(51547);let m="force-dynamic",y=c.KmV(["Q1","Q2","Q3","Q4","Q5","Q6","Q7","Q8","Q9"]),g=c.Ryn({cycle_id:c.Z_8().uuid().optional(),employee_id:c.Z_8().uuid(),quadrant:y.optional(),assessment_id:c.Z_8().uuid().optional(),extra_context:c.Z_8().optional().nullable()});async function _(e){try{let t=(0,u.cookies)(),r=(0,l.createRouteHandlerClient)({cookies:()=>t}),n=await (0,p.V)({supabase:r});if(!n.allowed)return i.NextResponse.json({error:n.reason||"Acesso negado"},{status:403});let o=g.parse(await e.json()),{data:a}=await r.from("employees").select("id, full_name, department, position, performance_score, metadata").eq("id",o.employee_id).maybeSingle(),s=o.quadrant??null;if(!s&&o.assessment_id){let{data:e}=await r.from("nine_box_results").select("quadrant").eq("assessment_id",o.assessment_id).maybeSingle();s=function(e){let t=String(e||"");return"Q1"===t||"Q2"===t||"Q3"===t||"Q4"===t||"Q5"===t||"Q6"===t||"Q7"===t||"Q8"===t||"Q9"===t?t:null}(e?.quadrant)}let c=`Voc\xea \xe9 um especialista em RH e desenvolvimento de talentos.
Gere um plano de a\xe7\xe3o (PDI) pr\xe1tico e mensur\xe1vel para um colaborador com base no quadrante do 9 Box.

Regras:
- Liste a\xe7\xf5es com: title, description, owner_role (ex: RH, L\xedder, Colaborador), due_in_days, success_metric.
- Evite a\xe7\xf5es gen\xe9ricas; prefira a\xe7\xf5es espec\xedficas.
- Retorne JSON.`,m=await (0,d.F)({task:"hr",json:!0,temperature:.35,maxTokens:1200,actorUserId:n.userId,entityType:"nine_box_ai_suggest_actions",entityId:o.assessment_id||null,messages:[{role:"system",content:c},{role:"user",content:`Retorne JSON no formato:
{
 "quadrant":"Q1",
 "actions":[{"title":"...","description":"...","owner_role":"...","due_in_days":30,"success_metric":"..."}],
 "notes":"..."
}

Dados:
${JSON.stringify({employee:a,quadrant:s,extra_context:o.extra_context||""})}`}]});return i.NextResponse.json({success:!0,output:m.json||null,raw:m.text})}catch(e){if(e?.name==="ZodError")return i.NextResponse.json({error:"Payload inv\xe1lido",details:e.errors},{status:400});return i.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let f=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/nine-box/ai/suggest-actions/route",pathname:"/api/nine-box/ai/suggest-actions",filename:"route",bundlePath:"app/api/nine-box/ai/suggest-actions/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\nine-box\\ai\\suggest-actions\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:x,staticGenerationAsyncStorage:h,serverHooks:w}=f,v="/api/nine-box/ai/suggest-actions/route";function E(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:h})}},90176:(e,t,r)=>{r.d(t,{t:()=>o});var n=r(54128);function o(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,n.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},51547:(e,t,r)=>{r.d(t,{F:()=>v,getProviderStatus:()=>w});var n=r(90176);function o(e){let t=e.match(/\{[\s\S]*\}|\[[\s\S]*\]/);if(!t)throw Error("Resposta n\xe3o cont\xe9m JSON");return JSON.parse(t[0])}function a(e){if(!e)return null;try{return JSON.parse(e)}catch{return null}}function s(e){return e?Array.isArray(e)?e.map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?[e.trim()].filter(Boolean):[]:[]}async function i(e){try{let t=(0,n.t)();await t.from("audit_logs").insert({user_id:e.userId||null,action:e.action,entity_type:e.entityType||"ai",entity_id:e.entityId||null,old_values:null,new_values:e.newValues,ip_address:null,user_agent:null,created_at:new Date().toISOString()})}catch{}}let l=null;async function u(){if(l&&Date.now()-l.fetchedAt<6e4)return{apiKey:l.apiKey,config:l.config};let e=null,t=null;try{let r=(0,n.t)(),{data:o}=await r.from("integration_configs").select("api_key, config").eq("integration_id","openrouter").single();e=o?.api_key||null,t=o?.config||null}catch{}return e=e||process.env.OPENROUTER_API_KEY||null,l={fetchedAt:Date.now(),apiKey:e,config:t},{apiKey:e,config:t}}function c(e){return e?"string"==typeof e?a(e):"object"==typeof e?e:null:null}async function p(e="general"){let t=process.env.OPENROUTER_MODEL;if(t)return[t].filter(Boolean);let{config:r}=await u(),n=r?.model?String(r.model).trim():"";if(n)return[n];let o=a(process.env.OPENROUTER_MODEL_POLICY_JSON),i=c(r?.model_policy)||c(r?.modelPolicy)||o||{default:["openrouter/auto"],general:["openrouter/auto"],analysis:["anthropic/claude-3.5-sonnet","openrouter/auto"],strategy:["anthropic/claude-3.5-sonnet","openrouter/auto"],kanban_insights:["anthropic/claude-3.5-sonnet","openrouter/auto"],kanban_message:["openai/gpt-4o","openrouter/auto"],copywriting:["openai/gpt-4o","openrouter/auto"],sales:["openai/gpt-4o","openrouter/auto"],sentiment:["google/gemini-1.5-pro","openrouter/auto"],classification:["google/gemini-1.5-pro","openrouter/auto"],hr:["anthropic/claude-3.5-sonnet","openrouter/auto"]},l=[...s(i[e]),...s(i.default),"openrouter/auto"],p=new Set,d=[];for(let e of l){let t=String(e).trim();!t||p.has(t)||(p.add(t),d.push(t))}return d.length?d:["openrouter/auto"]}async function d(){try{let e=(0,n.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","anthropic").single();if(t?.api_key)return t.api_key}catch{}return process.env.ANTHROPIC_API_KEY||null}async function m(){try{let e=(0,n.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","openai").single();if(t?.api_key)return t.api_key}catch{}return process.env.OPENAI_API_KEY||null}async function y(){try{let e=(0,n.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","gemini").single();if(t?.api_key)return t.api_key}catch{}return process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY||null}async function g(e,t,r){let n=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json","HTTP-Referer":process.env.NEXT_PUBLIC_APP_URL||"http://localhost","X-Title":"Valle 360"},body:JSON.stringify({model:t,messages:e.messages,temperature:e.temperature??.7,max_tokens:e.maxTokens??1024,response_format:e.json?{type:"json_object"}:void 0})}),o=await n.text();if(!n.ok)throw Error(`OpenRouter error (${n.status}): ${o.slice(0,500)}`);let a=JSON.parse(o),s=a?.choices?.[0]?.message?.content||"";return{provider:"openrouter",model:a?.model||t,text:s,usage:a?.usage}}async function _(e){let{apiKey:t}=await u();if(!t)throw Error("OPENROUTER_API_KEY n\xe3o configurada");let r=await p(e.task),n=Date.now(),a=[];for(let l of r)try{let a=await g(e,l,t);return await i({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:a.provider,model:a.model,ok:!0,ms:Date.now()-n,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json,openrouter_models_tried:r}}),e.json&&(a.json=o(a.text)),a}catch(t){var s;let e=t?.message||String(t);if(a.push({model:l,error:e}),!(!(s=function(e){let t=e.match(/OpenRouter error \\((\\d+)\\):/);if(!t?.[1])return null;let r=Number(t[1]);return Number.isFinite(r)?r:null}(e))||401!==s&&403!==s&&(429===s||408===s||s>=500&&s<=599||400===s&&/model|not found|no such|invalid/i.test(e))))break}let l=a.map(e=>`${e.model}: ${e.error}`).join(" | ");throw Error(`OpenRouter falhou em ${a.length} tentativa(s). ${l}`)}async function f(e){let t=await d();if(!t)throw Error("ANTHROPIC_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.ANTHROPIC_MODEL||"claude-3-5-sonnet-20241022"}(e.task),n=Date.now(),a=e.messages.find(e=>"system"===e.role)?.content,s=e.messages.filter(e=>"system"!==e.role).map(e=>`${e.role.toUpperCase()}: ${e.content}`).join("\n\n"),l=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":t,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:r,max_tokens:e.maxTokens??1024,temperature:e.temperature??.7,system:e.json?`${a||""}

Responda APENAS com um JSON v\xe1lido, sem texto extra.`:a,messages:[{role:"user",content:s}]})}),u=await l.text();if(!l.ok)throw Error(`Claude error (${l.status}): ${u.slice(0,500)}`);let c=JSON.parse(u),p=c?.content?.[0]?.text||"",m={provider:"claude",model:r,text:p,usage:c?.usage};return await i({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:m.provider,model:m.model,ok:!0,ms:Date.now()-n,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(m.json=o(p)),m}async function x(e){let t=await m();if(!t)throw Error("OPENAI_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.OPENAI_MODEL||"gpt-4o-mini"}(e.task),n=Date.now(),a=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:r,messages:e.messages,temperature:e.temperature??.7,max_tokens:e.maxTokens??1024,response_format:e.json?{type:"json_object"}:void 0})}),s=await a.text();if(!a.ok)throw Error(`OpenAI error (${a.status}): ${s.slice(0,500)}`);let l=JSON.parse(s),u=l?.choices?.[0]?.message?.content||"",c={provider:"openai",model:l?.model||r,text:u,usage:l?.usage};return await i({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:c.provider,model:c.model,ok:!0,ms:Date.now()-n,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(c.json=o(u)),c}async function h(e){let t=await y();if(!t)throw Error("GOOGLE_GEMINI_API_KEY/GOOGLE_CLOUD_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.GEMINI_MODEL||"gemini-1.5-flash"}(e.task),n=Date.now(),a=e.messages.find(e=>"system"===e.role)?.content,s=e.messages.filter(e=>"system"!==e.role).map(e=>`${e.role.toUpperCase()}: ${e.content}`).join("\n\n"),l=e.json?`${a||""}

Responda APENAS com um JSON v\xe1lido, sem texto extra.

${s}`:`${a||""}

${s}`,u=`https://generativelanguage.googleapis.com/v1beta/models/${r}:generateContent?key=${encodeURIComponent(t)}`,c=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:l}]}],generationConfig:{temperature:e.temperature??.7,maxOutputTokens:e.maxTokens??1024}})}),p=await c.text();if(!c.ok)throw Error(`Gemini error (${c.status}): ${p.slice(0,500)}`);let d=JSON.parse(p),m=d?.candidates?.[0]?.content?.parts?.map(e=>e.text).join("")||"",g={provider:"gemini",model:r,text:m,usage:d?.usageMetadata};return await i({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:g.provider,model:g.model,ok:!0,ms:Date.now()-n,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(g.json=o(m)),g}function w(){return{openrouter:!!process.env.OPENROUTER_API_KEY,claude:!!process.env.ANTHROPIC_API_KEY,openai:!!process.env.OPENAI_API_KEY,gemini:!!(process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY)}}async function v(e){let t=e.correlationId||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),r={...e,correlationId:t},n=[];for(let e of[{provider:"openrouter",fn:_},{provider:"claude",fn:f},{provider:"openai",fn:x},{provider:"gemini",fn:h}])try{return await e.fn(r)}catch(a){let o=a?.message||String(a);n.push({provider:e.provider,error:o}),await i({userId:r.actorUserId||null,action:"ai.request_failed",entityType:r.entityType||"ai",entityId:r.entityId||null,newValues:{provider:e.provider,ok:!1,error:o.slice(0,500),task:r.task||"general",correlation_id:t,json:!!r.json}})}let o=n.map(e=>`${e.provider}: ${e.error}`).join(" | ");throw Error(`Falha em todos os provedores. ${o}`)}},52390:(e,t,r)=>{async function n(e,t,r){try{let{data:n,error:o}=await e.rpc(t,r);if(o)return{ok:!1,error:o};return{ok:!0,data:n}}catch(e){return{ok:!1,error:e}}}function o(e){return Array.from(new Set(e.map(e=>String(e)).filter(Boolean)))}async function a(e){let t=e.supabase,{data:r}=await t.auth.getUser(),a=r.user?.id;if(!a)return{userId:"",isAdmin:!1,allowed:!1,reason:"N\xe3o autenticado",areaKeys:[]};let s=await n(t,"is_admin"),i=!!s.ok&&!!s.data;if(i)return{userId:a,isAdmin:i,allowed:!0,areaKeys:[]};let l=await n(t,"employee_area_keys");if(l.ok&&Array.isArray(l.data)){let e=o(l.data),t=e.includes("rh");return{userId:a,isAdmin:i,allowed:t,reason:t?void 0:"Acesso restrito: RH",areaKeys:e}}let{data:u}=await t.from("employees").select("areas, department, is_active").eq("user_id",a).maybeSingle(),c=o([...Array.isArray(u?.areas)?u.areas.map(String):[]]),p=c.includes("rh")||String(u?.department||"").toLowerCase().includes("rh");return{userId:a,isAdmin:i,allowed:p,reason:p?void 0:"Acesso restrito: RH",areaKeys:c}}r.d(t,{V:()=>a})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[89276,55972,54128,20958,96263],()=>r(31049));module.exports=n})();