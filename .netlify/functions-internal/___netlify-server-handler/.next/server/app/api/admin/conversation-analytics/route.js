"use strict";(()=>{var e={};e.id=69038,e.ids=[69038],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},63358:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>v,staticGenerationAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{GET:()=>d,PATCH:()=>u});var a=r(49303),n=r(88716),i=r(60670),o=r(87070),l=r(90176),c=r(17478);async function d(e){let t;let r=await (0,c.k)(e);if(!r.ok)return r.res;let{searchParams:s}=new URL(e.url),a=s.get("period")||"7d",n=(0,l.t)(),i=new Date;switch(a){case"30d":t=new Date(i.getTime()-2592e6);break;case"90d":t=new Date(i.getTime()-7776e6);break;default:t=new Date(i.getTime()-6048e5)}try{let{data:e,error:r}=await n.from("message_sentiment_analysis").select("sentiment, conversation_type, score, analyzed_at, sender_type").gte("analyzed_at",t.toISOString()).order("analyzed_at",{ascending:!1});if(r)return console.error("Erro ao buscar an\xe1lises:",r),o.NextResponse.json({success:!0,summary:{positive:0,neutral:0,negative:0,total:0},byType:[],bySender:[],trend:[],alerts:[],period:a,message:"Tabela de an\xe1lise ainda n\xe3o possui dados"});let s=e||[],i={positive:s.filter(e=>"positive"===e.sentiment).length,neutral:s.filter(e=>"neutral"===e.sentiment).length,negative:s.filter(e=>"negative"===e.sentiment).length,total:s.length},l={group:"Grupos",direct_team:"Equipe",direct_client:"Clientes"},c=["group","direct_team","direct_client"].map(e=>{let t=s.filter(t=>t.conversation_type===e),r=t.filter(e=>"positive"===e.sentiment).length,a=t.filter(e=>"neutral"===e.sentiment).length,n=t.filter(e=>"negative"===e.sentiment).length,i=t.length;return{type:e,label:l[e]||e,positive:r,neutral:a,negative:n,total:i,positivePercent:i>0?Math.round(r/i*100):0}}),d={client:"Clientes",collaborator:"Colaboradores",admin:"Administradores",super_admin:"Super Admin"},u=["client","collaborator","admin"].map(e=>{let t=s.filter(t=>t.sender_type===e),r=t.filter(e=>"positive"===e.sentiment).length,a=t.filter(e=>"neutral"===e.sentiment).length,n=t.filter(e=>"negative"===e.sentiment).length,i=t.length;return{type:e,label:d[e]||e,positive:r,neutral:a,negative:n,total:i,positivePercent:i>0?Math.round(r/i*100):0}}),p=new Map;s.forEach(e=>{let t=new Date(e.analyzed_at).toISOString().split("T")[0];p.has(t)||p.set(t,{positive:0,neutral:0,negative:0,scores:[]});let r=p.get(t);"positive"===e.sentiment?r.positive++:"neutral"===e.sentiment?r.neutral++:r.negative++,r.scores.push(e.score||0)});let g=Array.from(p.entries()).map(([e,t])=>({date:e,positive:t.positive,neutral:t.neutral,negative:t.negative,avgScore:t.scores.length>0?Math.round(t.scores.reduce((e,t)=>e+t,0)/t.scores.length*100)/100:0})).sort((e,t)=>e.date.localeCompare(t.date)),{data:m}=await n.from("sentiment_alerts").select("*").in("status",["pending","acknowledged"]).order("created_at",{ascending:!1}).limit(10),v=(m||[]).map(e=>({id:e.id,alertType:e.alert_type,severity:e.severity,title:e.title,description:e.description,conversationName:e.conversation_name||"Conversa",suggestedAction:e.suggested_action,status:e.status,createdAt:e.created_at}));return o.NextResponse.json({success:!0,summary:i,byType:c,bySender:u,trend:g,alerts:v,period:a,analyzedMessages:s.length})}catch(e){return console.error("[ConversationAnalytics] Erro:",e),o.NextResponse.json({success:!1,error:e.message||"Erro interno"},{status:500})}}async function u(e){let t=await (0,c.k)(e);if(!t.ok)return t.res;try{let{alertId:r,action:s}=await e.json();if(!r||!s)return o.NextResponse.json({error:"alertId e action s\xe3o obrigat\xf3rios"},{status:400});let a=(0,l.t)(),n=t.userId,i={};switch(s){case"acknowledge":i={status:"acknowledged",acknowledged_by:n,acknowledged_at:new Date().toISOString()};break;case"resolve":i={status:"resolved",resolved_at:new Date().toISOString()};break;case"dismiss":i={status:"dismissed"};break;default:return o.NextResponse.json({error:"A\xe7\xe3o inv\xe1lida"},{status:400})}let{error:c}=await a.from("sentiment_alerts").update(i).eq("id",r);if(c)throw c;return o.NextResponse.json({success:!0,message:`Alerta ${s}`})}catch(e){return console.error("[ConversationAnalytics] Erro ao atualizar alerta:",e),o.NextResponse.json({success:!1,error:e.message||"Erro interno"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/conversation-analytics/route",pathname:"/api/admin/conversation-analytics",filename:"route",bundlePath:"app/api/admin/conversation-analytics/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\conversation-analytics\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:v}=p,h="/api/admin/conversation-analytics/route";function y(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:m})}},90176:(e,t,r)=>{r.d(t,{t:()=>a});var s=r(54128);function a(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,s.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},17478:(e,t,r)=>{r.d(t,{k:()=>o});var s=r(87070),a=r(20344),n=r(71615),i=r(54128);async function o(e){let t=(0,n.cookies)(),r=(0,a.createRouteHandlerClient)({cookies:()=>t}),o=e.headers.get("authorization")||"",l=o.toLowerCase().startsWith("bearer ")?o.slice(7).trim():null,c=l?(0,i.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${l}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):r,{data:d}=await c.auth.getUser();if(!d.user?.id)return{ok:!1,res:s.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:u,error:p}=await c.rpc("is_admin");return p||!u?{ok:!1,res:s.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:d.user.id}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[89276,55972,54128,20958],()=>r(63358));module.exports=s})();