"use strict";(()=>{var e={};e.id=98239,e.ids=[98239],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},67819:(e,a,t)=>{t.r(a),t.d(a,{originalPathname:()=>S,patchFetch:()=>k,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>y});var r={};t.r(r),t.d(r,{POST:()=>_,dynamic:()=>m});var s=t(49303),i=t(88716),o=t(60670),n=t(87070),c=t(20344),l=t(71615),d=t(52955),u=t(29601),p=t(14399);let m="force-dynamic";async function _(e){try{var a;let t=(0,l.cookies)(),r=(0,c.createRouteHandlerClient)({cookies:()=>t}),s=await (0,d.U)({supabase:r});if(!s.allowed)return n.NextResponse.json({error:s.reason||"Acesso negado"},{status:403});let i=await e.json(),o=i?.client_id?String(i.client_id):null,m=i?.caption??i?.legenda??null,_=i?.collaborators??i?.colaboradores??null,f=String(i?.post_type||i?.type||"image"),g=i?.scheduled_at||i?.scheduledAt||null,y=Array.isArray(i?.media_urls)?i.media_urls:Array.isArray(i?.mediaUrls)?i.mediaUrls:[],w=String(i?.backend||"instagramback"),S=(a=i?.platforms)&&Array.isArray(a)?a.map(String).filter(Boolean):[],k=i?.channels||[],h=!!i?.is_draft,v=String(i?.approval_status||"approved"),A=!!i?.boost_requested,{data:x,error:b}=await r.from("instagram_posts").insert({external_id:null,client_id:o,post_type:f,caption:m,collaborators:_,status:h?"draft":"pending"===v?"pending_approval":g?"scheduled":"ready",scheduled_at:g,media_urls:y,created_by:s.userId,raw_payload:{...i,_source:"post-records"},platforms:S,channels:k,backend:w,is_draft:h,approval_status:v,boost_requested:A}).select("*").single();if(b)return n.NextResponse.json({error:b.message},{status:500});try{"pending"===v&&await (0,u._)(r,{title:"Post aguardando aprova\xe7\xe3o",message:"Um post foi enviado para aprova\xe7\xe3o na Central de Agendar Postagem.",link:"/app/social-media/upload",type:"workflow",metadata:{post_id:x.id,client_id:o,backend:w}}),A&&await (0,p.Q)({area:"Marketing",title:"Impulsionamento solicitado",message:"Um post foi marcado para impulsionar.",link:"/app/social-media/upload",type:"workflow",metadata:{post_id:x.id,client_id:o,backend:w}})}catch{}return n.NextResponse.json({success:!0,post:x})}catch(e){return n.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let f=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/social/post-records/route",pathname:"/api/social/post-records",filename:"route",bundlePath:"app/api/social/post-records/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\social\\post-records\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:w}=f,S="/api/social/post-records/route";function k(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:y})}},29601:(e,a,t)=>{async function r(e){let{data:a}=await e.from("user_profiles").select("user_id, user_type, is_active").in("user_type",["super_admin","admin"]).eq("is_active",!0);return(a||[]).map(e=>e.user_id).filter(Boolean).map(e=>String(e))}async function s(e,a){let t=await r(e);if(0===t.length)return;let s=t.map(e=>({user_id:e,title:a.title,message:a.message,type:a.type||"system",is_read:a.is_read??!1,link:a.link??null,metadata:a.metadata||{},created_at:new Date().toISOString()}));try{await e.from("notifications").insert(s)}catch{}}t.d(a,{_:()=>s})},14399:(e,a,t)=>{t.d(a,{Q:()=>i});var r=t(90176);function s(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}async function i(e){let a=(0,r.t)(),{data:t}=await a.from("employees").select("user_id, department, areas, is_active").eq("is_active",!0),i=(t||[]).filter(a=>a?.user_id&&function(e,a){let t=s(e),r=a.department?s(a.department):"",i=Array.isArray(a.areas)?a.areas.map(s):[];if(!t)return!1;if(r===t||i.includes(t)||r.includes(t)||t.includes(r)||i.some(e=>e.includes(t)||t.includes(e)))return!0;let o={operacao:["operacao","operacional","ops"],financeiro:["financeiro","finance","cobranca","cobran\xe7a"],comercial:["comercial","vendas","sales"],juridico:["juridico","juridico/compliance","compliance"],contratos:["contratos","contract"],notificacoes:["notificacoes","notificacoes-e-alertas","notificacoes/alertas"],rh:["rh","people","pessoas"]}[t]||[];return!!(o.length>0&&(o.some(e=>r.includes(e))||o.some(e=>i.some(a=>a.includes(e)))))}(e.area,a)).map(e=>String(e.user_id));if(0===i.length){let t={user_id:null,title:e.title,message:e.message,type:e.type||"workflow",is_read:!1,link:e.link??"/admin/fluxos",metadata:{...e.metadata||{},area:e.area,audience:"area"},created_at:new Date().toISOString()};try{await a.from("notifications").insert(t)}catch{}return}let o=i.map(a=>({user_id:a,title:e.title,message:e.message,type:e.type||"workflow",is_read:!1,link:e.link??"/colaborador/notificacoes",metadata:{...e.metadata||{},area:e.area,audience:"area"},created_at:new Date().toISOString()}));try{await a.from("notifications").insert(o)}catch{}}},90176:(e,a,t)=>{t.d(a,{t:()=>s});var r=t(54128);function s(){let e="https://ikjgsqtykkhqimypacro.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!a)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,r.eI)(e,a,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},52955:(e,a,t)=>{t.d(a,{U:()=>o});var r=t(57157);async function s(e,a,t){try{let{data:r,error:s}=await e.rpc(a,t);if(s)return{ok:!1,error:s};return{ok:!0,data:r}}catch(e){return{ok:!1,error:e}}}function i(e){return Array.from(new Set(e))}async function o(e){let a=e.supabase,{data:t}=await a.auth.getUser(),o=t.user?.id;if(!o)return{userId:"",isSuperAdmin:!1,isAdmin:!1,allowed:!1,reason:"N\xe3o autenticado",areaKeys:[]};let n=await s(a,"is_admin"),c=!!n.ok&&!!n.data,l=await s(a,"is_super_admin"),d=!!l.ok&&!!l.data;if(c||d)return{userId:o,isSuperAdmin:d,isAdmin:c,allowed:!0,areaKeys:[]};let u=await s(a,"employee_area_keys");if(u.ok&&Array.isArray(u.data)){let e=(u.data||[]).map(e=>String(e)),a=e.includes("social_media")||e.includes("head_marketing");return{userId:o,isSuperAdmin:d,isAdmin:c,allowed:a,reason:a?void 0:"Acesso restrito: necess\xe1rio Social Media ou Head Marketing",areaKeys:i(e)}}let{data:p}=await a.from("employees").select("department, area_of_expertise, areas, is_active").eq("user_id",o).maybeSingle(),m=[];p?.department&&m.push(String(p.department)),p?.area_of_expertise&&m.push(String(p.area_of_expertise)),Array.isArray(p?.areas)&&m.push(...p.areas.map(e=>String(e)));let _=i(m.map(e=>(0,r.IY)(e)).filter(Boolean).map(e=>e)),f=_.includes("social_media")||_.includes("head_marketing");return{userId:o,isSuperAdmin:d,isAdmin:c,allowed:f,reason:f?void 0:"Acesso restrito: necess\xe1rio Social Media ou Head Marketing",areaKeys:_}}}};var a=require("../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),r=a.X(0,[89276,55972,54128,20958,57157],()=>t(67819));module.exports=r})();