"use strict";(()=>{var e={};e.id=84437,e.ids=[84437],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},87421:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>x,patchFetch:()=>I,requestAsyncStorage:()=>m,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>k});var o={};t.r(o),t.d(o,{GET:()=>_});var n=t(49303),a=t(88716),i=t(60670),s=t(87070),c=t(90176);let l=process.env.LINKEDIN_CLIENT_ID||"",d=process.env.LINKEDIN_CLIENT_SECRET||"",p=process.env.LINKEDIN_REDIRECT_URI||`${process.env.NEXT_PUBLIC_APP_URL}/api/oauth/linkedin/callback`,u=process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000";async function _(e){let r=(0,c.t)();try{let t;let o=e.nextUrl.searchParams.get("code"),n=e.nextUrl.searchParams.get("state");if(e.nextUrl.searchParams.get("error")){let r=e.nextUrl.searchParams.get("error_description")||"Autoriza\xe7\xe3o negada";return s.NextResponse.redirect(`${u}/cliente/redes-sociais?error=${encodeURIComponent(r)}`)}if(!o||!n)return s.NextResponse.redirect(`${u}/cliente/redes-sociais?error=Par\xe2metros inv\xe1lidos`);try{t=JSON.parse(Buffer.from(n,"base64url").toString())}catch{return s.NextResponse.redirect(`${u}/cliente/redes-sociais?error=State inv\xe1lido`)}if(Date.now()-t.timestamp>6e5)return s.NextResponse.redirect(`${u}/cliente/redes-sociais?error=Sess\xe3o expirada`);let a=await fetch("https://www.linkedin.com/oauth/v2/accessToken",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:o,redirect_uri:p,client_id:l,client_secret:d})}),i=await a.json();if(!i.access_token)return console.error("LinkedIn token exchange failed:",i),s.NextResponse.redirect(`${u}/cliente/redes-sociais?error=Falha ao obter token`);let c=await fetch("https://api.linkedin.com/v2/userinfo",{headers:{Authorization:`Bearer ${i.access_token}`}}),_=await c.json();if(!_.sub)return console.error("LinkedIn user info failed:",_),s.NextResponse.redirect(`${u}/cliente/redes-sociais?error=Falha ao obter informa\xe7\xf5es do usu\xe1rio`);let h=new Date(Date.now()+1e3*i.expires_in).toISOString(),m={client_id:t.clientId,platform:"linkedin",account_id:_.sub,account_name:_.name,account_avatar:_.picture,access_token:i.access_token,refresh_token:i.refresh_token,token_expires_at:h,scopes:i.scope.split(" "),is_active:!0,connected_by:t.userId,connected_by_role:t.role},{error:k}=await r.from("client_social_connections").upsert(m,{onConflict:"client_id,platform,account_id"});if(k)return console.error("Error storing LinkedIn connection:",k),s.NextResponse.redirect(`${u}/cliente/redes-sociais?error=Erro ao salvar conex\xe3o`);return await r.from("social_connection_audit").insert({client_id:t.clientId,platform:"linkedin",account_id:_.sub,account_name:_.name,action:"connected",performed_by:t.userId,performed_by_role:t.role,metadata:{scopes:i.scope.split(" "),email:_.email}}),s.NextResponse.redirect(`${u}/cliente/${t.clientId}/redes-sociais?success=true&connected=1`)}catch(e){return console.error("LinkedIn OAuth callback error:",e),s.NextResponse.redirect(`${u}/cliente/redes-sociais?error=${encodeURIComponent(e.message||"Erro desconhecido")}`)}}let h=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/oauth/linkedin/callback/route",pathname:"/api/oauth/linkedin/callback",filename:"route",bundlePath:"app/api/oauth/linkedin/callback/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\oauth\\linkedin\\callback\\route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:k,serverHooks:f}=h,x="/api/oauth/linkedin/callback/route";function I(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:k})}},90176:(e,r,t)=>{t.d(r,{t:()=>n});var o=t(54128);function n(){let e="https://ikjgsqtykkhqimypacro.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!r)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,o.eI)(e,r,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[89276,55972,54128],()=>t(87421));module.exports=o})();