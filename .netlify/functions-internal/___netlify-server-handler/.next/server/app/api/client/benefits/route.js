"use strict";(()=>{var e={};e.id=17993,e.ids=[17993],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},24531:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>x,requestAsyncStorage:()=>_,routeModule:()=>f,serverHooks:()=>b,staticGenerationAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{GET:()=>p,POST:()=>m,dynamic:()=>u});var s=r(49303),i=r(88716),n=r(60670),o=r(87070),c=r(20344),d=r(71615),l=r(90176);let u="force-dynamic";async function p(e){try{let e=(0,d.cookies)(),t=(0,c.createRouteHandlerClient)({cookies:()=>e}),{data:r}=await t.auth.getUser(),a=r?.user;if(!a)return o.NextResponse.json({success:!1,error:"N\xe3o autorizado"},{status:401});let s=(0,l.t)(),{data:i,error:n}=await s.from("clients").select("id, company_name, nome_fantasia, referral_code").eq("user_id",a.id).maybeSingle();if(n||!i?.id)return o.NextResponse.json({success:!1,error:"Cliente n\xe3o encontrado"},{status:400});let u=i.referral_code;u||(u=(i.company_name||i.nome_fantasia||"CLIENT").replace(/[^a-zA-Z0-9]/g,"").substring(0,10).toUpperCase()+Math.random().toString(36).substring(2,6).toUpperCase(),await s.from("clients").update({referral_code:u}).eq("id",i.id));let p=[],m=0,f=0;try{let{data:e,error:t}=await s.from("client_referrals").select("*").eq("referrer_client_id",i.id).order("created_at",{ascending:!1});!t&&e&&(f=(p=e.map(e=>({id:String(e.id),referred_client_id:e.referred_client_id?String(e.referred_client_id):null,referred_email:String(e.referred_email||""),referred_name:e.referred_name?String(e.referred_name):null,status:e.status||"pending",created_at:String(e.created_at),earnings:Number(e.earnings||500)}))).filter(e=>"active"===e.status||"paid"===e.status).length,m=p.filter(e=>"pending"!==e.status).reduce((e,t)=>e+t.earnings,0))}catch(e){console.log("client_referrals table not found, using empty data")}let _=[];try{let{data:e,error:t}=await s.from("client_benefits").select("*").eq("active",!0).order("credits_required",{ascending:!0});!t&&e&&(_=e.map(e=>({id:String(e.id),name:String(e.name||""),description:String(e.description||""),credits_required:Number(e.credits_required||0),category:String(e.category||"general"),available:!0})))}catch(e){_=[{id:"1",name:"Consultoria Gratuita",description:"1 hora de consultoria estrat\xe9gica",credits_required:1e3,category:"service",available:!0},{id:"2",name:"Design Gr\xe1fico Extra",description:"2 artes adicionais no m\xeas",credits_required:500,category:"service",available:!0},{id:"3",name:"Upgrade de Plano",description:"1 m\xeas de plano premium",credits_required:2500,category:"premium",available:!1}]}let g="Bronze",b=0;try{let{data:e}=await s.from("client_gamification_scores").select("total_points, level").eq("client_id",i.id).maybeSingle();if(e?.total_points){let t=Number(e.total_points);t>1e4?(g="VIP",b=20):t>5e3?(g="Diamante",b=15):t>2e3?(g="Ouro",b=10):t>500?(g="Prata",b=5):(g="Bronze",b=0)}}catch(e){}return o.NextResponse.json({success:!0,referral_code:u,referral_url:`https://valle360.com/ref/${u}`,referrals:p,stats:{total_referrals:p.length,active_referrals:f,total_earnings:m},level:{name:g,discount:b},available_benefits:_})}catch(e){return console.error("Benefits API error:",e),o.NextResponse.json({success:!1,error:e?.message||"Erro interno"},{status:500})}}async function m(e){try{let t=(0,d.cookies)(),r=(0,c.createRouteHandlerClient)({cookies:()=>t}),{data:a}=await r.auth.getUser(),s=a?.user;if(!s)return o.NextResponse.json({success:!1,error:"N\xe3o autorizado"},{status:401});let{benefit_id:i}=await e.json();if(!i)return o.NextResponse.json({success:!1,error:"benefit_id \xe9 obrigat\xf3rio"},{status:400});let n=(0,l.t)(),{data:u}=await n.from("clients").select("id").eq("user_id",s.id).maybeSingle();if(!u?.id)return o.NextResponse.json({success:!1,error:"Cliente n\xe3o encontrado"},{status:400});let{data:p,error:m}=await n.from("client_benefits").select("*").eq("id",i).eq("active",!0).maybeSingle();if(m||!p)return o.NextResponse.json({success:!1,error:"Benef\xedcio n\xe3o encontrado"},{status:404});let f=Number(p.credits_required||0),{data:_}=await n.from("client_credits").select("balance").eq("client_id",u.id).maybeSingle(),g=Number(_?.balance||0);if(g<f)return o.NextResponse.json({success:!1,error:"Cr\xe9ditos insuficientes",required:f,available:g},{status:400});return await n.from("client_credits").update({balance:g-f,updated_at:new Date().toISOString()}).eq("client_id",u.id),await n.from("client_benefit_redemptions").insert({client_id:u.id,benefit_id:i,credits_used:f,status:"pending",created_at:new Date().toISOString()}),o.NextResponse.json({success:!0,message:"Benef\xedcio resgatado com sucesso!",new_balance:g-f})}catch(e){return console.error("Benefit redemption error:",e),o.NextResponse.json({success:!1,error:e?.message||"Erro interno"},{status:500})}}let f=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/client/benefits/route",pathname:"/api/client/benefits",filename:"route",bundlePath:"app/api/client/benefits/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\benefits\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:g,serverHooks:b}=f,S="/api/client/benefits/route";function x(){return(0,n.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:g})}},90176:(e,t,r)=>{r.d(t,{t:()=>s});var a=r(54128);function s(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,a.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958],()=>r(24531));module.exports=a})();