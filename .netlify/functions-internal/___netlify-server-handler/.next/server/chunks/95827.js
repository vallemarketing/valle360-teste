"use strict";exports.id=95827,exports.ids=[95827],exports.modules={90176:(e,t,a)=>{a.d(t,{t:()=>r});var i=a(54128);function r(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,i.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},17478:(e,t,a)=>{a.d(t,{k:()=>d});var i=a(87070),r=a(20344),n=a(71615),o=a(54128);async function d(e){let t=(0,n.cookies)(),a=(0,r.createRouteHandlerClient)({cookies:()=>t}),d=e.headers.get("authorization")||"",s=d.toLowerCase().startsWith("bearer ")?d.slice(7).trim():null,l=s?(0,o.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${s}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):a,{data:c}=await l.auth.getUser();if(!c.user?.id)return{ok:!1,res:i.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:u,error:_}=await l.rpc("is_admin");return _||!u?{ok:!1,res:i.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:c.user.id}}},4676:(e,t,a)=>{a.d(t,{K:()=>c});var i=a(90176);function r(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function n(e){let t=String(e||"").trim().toLowerCase();return t?"a_fazer"===t||"todo"===t||"backlog"===t?"demanda":t:null}function o(e){return String(e||"").trim().toLowerCase()||null}async function d(e){let t=(0,i.t)(),a=String(e?.board_id??e?.boardId??"").trim(),o=String(e?.column_id??e?.columnId??"").trim(),d=n(e?.stage_key??e?.stageKey);if(o&&r(o))try{let{data:e,error:a}=await t.from("kanban_columns").select("id, board_id").eq("id",o).maybeSingle();if(!a&&e?.id&&e?.board_id){let t=String(e.board_id);if(r(t))return{column_id:o,board_id:t}}}catch{}if(a&&r(a)&&d)try{let{data:e}=await t.from("kanban_columns").select("id").eq("board_id",a).eq("stage_key",d).maybeSingle(),i=e?.id?String(e.id):"";if(i&&r(i))return{column_id:i,board_id:a}}catch{}return a&&o&&r(a)&&r(o)?{board_id:a,column_id:o}:null}async function s(e){let t=(0,i.t)(),a=o(e.areaKey),d=n(e.stageKey),s=async e=>{try{let i=t.from("kanban_boards").select(e).limit(50);e.includes("is_active")&&(i=i.eq("is_active",!0));let r=a?await i.eq("area_key",a):await i;if(r.error)return null;return r.data||[]}catch{return null}},l=await s("id, area_key, is_active, created_at")||await s("id, area_key, created_at")||await s("id, area_key")||null,c=await (async()=>{try{let e=t.from("kanban_boards").select("id, is_active, created_at").eq("is_active",!0).order("created_at",{ascending:!0}).limit(50),a=await e;if(a.error)return null;return a.data||[]}catch{return null}})()||await (async()=>{try{let e=t.from("kanban_boards").select("id").limit(50),a=await e;if(a.error)return null;return a.data||[]}catch{return null}})(),u=(l&&l.length?l:c)||[],_=u.find(e=>e?.id&&(e?.is_active===!0||e?.is_active==null))||u.find(e=>e?.id)||null,m=_?.id?String(_.id):"";if(!m||!r(m))return null;if(!a&&d)try{let{data:e}=await t.from("kanban_columns").select("id, board_id").eq("stage_key",d).order("position",{ascending:!0}).limit(1),a=(e||[])[0],i=a?.id?String(a.id):"",n=a?.board_id?String(a.board_id):"";if(i&&n&&r(i)&&r(n))return{board_id:n,column_id:i}}catch{}let g=async e=>{try{let a=t.from("kanban_columns").select(e).eq("board_id",m).limit(80),i=e.includes("position")?await a.order("position",{ascending:!0}):await a;if(i.error)return null;return i.data||[]}catch{return null}},f=await g("id, board_id, name, position, stage_key")||await g("id, board_id, title, position, stage_key")||await g("id, board_id, name, position")||await g("id, board_id, title, position")||await g("id, board_id, name")||await g("id, board_id, title")||await g("id, board_id")||await g("id");if(!f||0===f.length)return null;let y=e=>String(e||"").toLowerCase(),b=e=>y(e?.name||e?.title||e?.stage_key),w=(d?f.find(e=>String(e?.stage_key||"").toLowerCase()===d):null)||f.find(e=>"demanda"===String(e?.stage_key||"").toLowerCase())||f.find(e=>b(e).includes("demanda"))||f.find(e=>b(e).includes("backlog"))||f.find(e=>b(e).includes("a fazer"))||f[0],k=w?.id?String(w.id):"";return k&&r(k)?{board_id:m,column_id:k}:null}async function l(){let e=(0,i.t)();async function t(t,a){try{let i=e.from("kanban_columns").select(t).limit(50),r=a?await i.order(a,{ascending:!0}):await i;if(r.error)return null;return r.data||[]}catch{return null}}let a=null;for(let e of[{select:"id, board_id, name, position, stage_key",orderBy:"position"},{select:"id, board_id, name, position",orderBy:"position"},{select:"id, board_id, name, stage_key"},{select:"id, board_id, name"},{select:"id, board_id"},{select:"id"}])if((a=await t(e.select,e.orderBy))&&a.length)break;if(!a||0===a.length)return null;let n=e=>String(e||"").toLowerCase(),o=e=>n(e?.name||e?.title||e?.stage_key),d=a.find(e=>o(e).includes("backlog"))||a.find(e=>o(e).includes("a fazer"))||a.find(e=>o(e).includes("demanda"))||a[0],s=d?.id?String(d.id):"",l=d?.board_id?String(d.board_id):"";if(!s||!r(s))return null;if(!l||!r(l)){try{let{data:t}=await e.from("kanban_boards").select("id").order("created_at",{ascending:!0}).limit(1),a=(t||[])[0],i=a?.id?String(a.id):"";if(i&&r(i))return{column_id:s,board_id:i}}catch{}return null}return{column_id:s,board_id:l}}async function c(e){let t=String(e.draftId||"").trim(),a=String(e.actorUserId||"").trim();if(!r(t))throw Error("draft_id inv\xe1lido");if(!r(a))throw Error("actorUserId inv\xe1lido");let c=(0,i.t)(),{data:u,error:_}=await c.from("ai_executive_action_drafts").select("*").eq("id",t).maybeSingle();if(_||!u)throw Error(_?.message||"Draft n\xe3o encontrado");if("draft"!==String(u.status))throw Error(`Draft n\xe3o est\xe1 em draft (status=${u.status})`);if(u.requires_external||!u.is_executable)throw Error("Este draft n\xe3o \xe9 execut\xe1vel automaticamente (externo ou bloqueado).");let m=String(u.action_type||"").trim(),g=u.action_payload||{},f=new Date().toISOString(),y={ok:!1,error:"A\xe7\xe3o n\xe3o executada"};try{if("create_kanban_task"===m){let e=String(g?.title||g?.name||"").trim(),t=g?.description!=null?String(g.description):null,i=String(g?.priority||"medium").toLowerCase(),u=g?.due_date?String(g.due_date):null;if(!e)throw Error("payload.title \xe9 obrigat\xf3rio para create_kanban_task");let _=function(e){let t=e?.metadata||e?.meta||{};return{areaKey:o(t?.area_key??t?.areaKey??e?.area_key??e?.areaKey),stageKey:n(t?.stage_key??t?.stageKey??e?.stage_key??e?.stageKey)}}(g),m=await d(g),b=m?null:await s({areaKey:_.areaKey,stageKey:_.stageKey}),w=m||b||await l();if(!w)throw Error("N\xe3o foi poss\xedvel determinar column_id/board_id do Kanban");let k=Array.isArray(g?.assigned_user_ids)?g.assigned_user_ids.map(e=>String(e)).filter(e=>r(e)):[],p=r(String(g?.assigned_to||""))?String(g.assigned_to):k.length?k[0]:null,h=(e=>{let t=String(e||"").toLowerCase();return["low","medium","high","urgent"].includes(t)?t:"baixa"===t?"low":"media"===t?"medium":"alta"===t?"high":"urgente"===t?"urgent":"medium"})(i),S="in_progress";try{let{data:e}=await c.from("kanban_columns").select("id, name, stage_key").eq("id",w.column_id).maybeSingle(),t=String(e?.stage_key||"").toLowerCase(),a=String(e?.name||"").toLowerCase(),i=t||a;a.includes("backlog")?S="backlog":a.includes("a fazer")?S="todo":a.includes("revis")?S="in_review":a.includes("conclu")||"finalizado"===i||i.includes("final")?S="done":a.includes("bloque")||i.includes("bloque")?S="blocked":a.includes("cancel")?S="cancelled":("demanda"===i||i.includes("lead"))&&(S="todo")}catch{}let x=0;try{let{data:e}=await c.from("kanban_tasks").select("position").eq("board_id",w.board_id).eq("column_id",w.column_id).order("position",{ascending:!1}).limit(1),t=(e||[])[0],a=Number(t?.position);x=Number.isFinite(a)?a+1:0}catch{x=0}let{data:v,error:I}=await c.from("kanban_tasks").insert({column_id:w.column_id,board_id:w.board_id,title:e,description:t,position:x,assigned_to:p,created_by:a,due_date:u,priority:h,status:S,updated_at:f,tags:[]}).select("id, board_id").single();if(I)throw I;y={ok:!0,entity_type:"kanban_tasks",entity_id:v?.id||null,board_id:v?.board_id||w.board_id}}else if("send_direct_message"===m){let e=String(g?.to_user_id||"").trim(),t=String(g?.text||g?.message||"").trim();if(!r(e))throw Error("payload.to_user_id inv\xe1lido");if(!t)throw Error("payload.text \xe9 obrigat\xf3rio");let{data:i,error:n}=await c.rpc("get_or_create_direct_conversation",{p_user_id_1:a,p_user_id_2:e,p_is_client_conversation:!1});if(n||!i)throw Error(n?.message||"Falha ao criar conversa direta");let{data:o,error:d}=await c.from("direct_messages").insert({conversation_id:i,from_user_id:a,body:t,message_type:"text"}).select("id, conversation_id").single();if(d||!o)throw Error(d?.message||"Falha ao enviar mensagem");y={ok:!0,entity_type:"direct_messages",entity_id:o.id,conversation_id:o.conversation_id}}else if("schedule_meeting"===m){let e=String(g?.title||"Reuni\xe3o executiva").trim(),a=String(g?.meeting_type||"review").trim(),i=Array.isArray(g?.participants)?g.participants.map(e=>String(e).toLowerCase()):[],r=g?.agenda??[],{data:n}=await c.from("ai_executives").select("id, role").in("role",i.length?i:["ceo","cfo","cmo","cto","coo","cco","chro"]),o=(n||[]).map(e=>String(e.id)),{data:d,error:s}=await c.from("ai_executive_meetings").insert({title:e,meeting_type:a,initiated_by:u.executive_id,trigger_reason:"action_draft",trigger_data:{draft_id:t},participants:o,agenda:r,status:"scheduled",priority:"normal",scheduled_at:f}).select("id").single();if(s)throw s;y={ok:!0,entity_type:"ai_executive_meetings",entity_id:d?.id||null}}else throw Error(`A\xe7\xe3o n\xe3o suportada para execu\xe7\xe3o: ${m}`);return await c.from("ai_executive_action_drafts").update({status:"executed",executed_at:f,execution_result:y}).eq("id",t),{ok:!0,executedAt:f,executionResult:y,draft:u}}catch(e){y={ok:!1,error:String(e?.message||"Falha")};try{await c.from("ai_executive_action_drafts").update({status:"failed",executed_at:f,execution_result:y}).eq("id",t)}catch{}return{ok:!1,executedAt:f,executionResult:y,draft:u}}}}};