"use strict";(()=>{var e={};e.id=8665,e.ids=[8665],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},11628:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>y,patchFetch:()=>x,requestAsyncStorage:()=>l,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var a={};s.r(a),s.d(a,{POST:()=>d,dynamic:()=>u});var r=s(49303),n=s(88716),o=s(60670),i=s(87070),c=s(17478),p=s(73701);let u="force-dynamic";async function d(e){let t;let s=await (0,c.k)(e);if(!s.ok)return s.res;if(!(process.env.WHATSAPP_PHONE_NUMBER_ID&&process.env.WHATSAPP_ACCESS_TOKEN))return i.NextResponse.json({success:!1,configured:!1,error:"WhatsApp n\xe3o configurado (WHATSAPP_PHONE_NUMBER_ID / WHATSAPP_ACCESS_TOKEN)"},{status:503});try{t=await e.json()}catch{return i.NextResponse.json({success:!1,error:"Body inv\xe1lido (JSON)"},{status:400})}let a=String(t?.toPhone||"").trim(),r=String(t?.text||"").trim();if(!a)return i.NextResponse.json({success:!1,error:"toPhone \xe9 obrigat\xf3rio"},{status:400});if(!r)return i.NextResponse.json({success:!1,error:"text \xe9 obrigat\xf3rio"},{status:400});let n=await (0,p.U3)({to:a,type:"text",text:r});return n.success?i.NextResponse.json({success:!0,configured:!0,messageId:n.messageId||null}):i.NextResponse.json({success:!1,configured:!0,error:n.error||"Falha ao enviar WhatsApp"},{status:502})}let m=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/outbound/whatsapp/route",pathname:"/api/admin/outbound/whatsapp",filename:"route",bundlePath:"app/api/admin/outbound/whatsapp/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\outbound\\whatsapp\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:l,staticGenerationAsyncStorage:g,serverHooks:h}=m,y="/api/admin/outbound/whatsapp/route";function x(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},17478:(e,t,s)=>{s.d(t,{k:()=>i});var a=s(87070),r=s(20344),n=s(71615),o=s(54128);async function i(e){let t=(0,n.cookies)(),s=(0,r.createRouteHandlerClient)({cookies:()=>t}),i=e.headers.get("authorization")||"",c=i.toLowerCase().startsWith("bearer ")?i.slice(7).trim():null,p=c?(0,o.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${c}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):s,{data:u}=await p.auth.getUser();if(!u.user?.id)return{ok:!1,res:a.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:d,error:m}=await p.rpc("is_admin");return m||!d?{ok:!1,res:a.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:u.user.id}}},73701:(e,t,s)=>{async function a(e){let t=function(){switch(process.env.WHATSAPP_PROVIDER||"meta"){case"evolution":return{provider:"evolution",apiUrl:process.env.EVOLUTION_API_URL||"https://api.evolution.com",accessToken:process.env.EVOLUTION_API_KEY||"",instanceName:process.env.EVOLUTION_INSTANCE_NAME||"valle360"};case"twilio":return{provider:"twilio",accessToken:process.env.TWILIO_AUTH_TOKEN||"",accountSid:process.env.TWILIO_ACCOUNT_SID||"",phoneNumberId:process.env.TWILIO_WHATSAPP_NUMBER||""};default:return{provider:"meta",apiUrl:"https://graph.facebook.com/v18.0",accessToken:process.env.WHATSAPP_ACCESS_TOKEN||"",phoneNumberId:process.env.WHATSAPP_PHONE_NUMBER_ID||""}}}();if(!t.accessToken)return console.warn("WhatsApp not configured"),{success:!1,error:"WhatsApp not configured"};try{switch(t.provider){case"meta":return await r(t,e);case"evolution":return await n(t,e);case"twilio":return await o(t,e);default:return{success:!1,error:"Unknown provider"}}}catch(e){return console.error("WhatsApp send error:",e),{success:!1,error:e.message}}}async function r(e,t){let s=`${e.apiUrl}/${e.phoneNumberId}/messages`,a={messaging_product:"whatsapp",recipient_type:"individual",to:i(t.to)};"text"===t.type?(a.type="text",a.text={preview_url:!0,body:t.text}):"template"===t.type?(a.type="template",a.template={name:t.template?.name,language:{code:t.template?.language||"pt_BR"},components:t.template?.components||[]}):"image"===t.type?(a.type="image",a.image={link:t.media?.url,caption:t.media?.caption}):"document"===t.type&&(a.type="document",a.document={link:t.media?.url,caption:t.media?.caption,filename:t.media?.filename});let r=await fetch(s,{method:"POST",headers:{Authorization:`Bearer ${e.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify(a)}),n=await r.json();return r.ok?{success:!0,messageId:n.messages?.[0]?.id}:{success:!1,error:n.error?.message||"Failed to send message"}}async function n(e,t){let s=`${e.apiUrl}/message`,a="",r={number:i(t.to)};"text"===t.type?(a=`${s}/sendText/${e.instanceName}`,r.textMessage={text:t.text}):"image"===t.type?(a=`${s}/sendMedia/${e.instanceName}`,r.mediaMessage={mediatype:"image",media:t.media?.url,caption:t.media?.caption}):"document"===t.type&&(a=`${s}/sendMedia/${e.instanceName}`,r.mediaMessage={mediatype:"document",media:t.media?.url,caption:t.media?.caption,fileName:t.media?.filename});let n=await fetch(a,{method:"POST",headers:{apikey:e.accessToken,"Content-Type":"application/json"},body:JSON.stringify(r)}),o=await n.json();return n.ok?{success:!0,messageId:o.key?.id}:{success:!1,error:o.message||"Failed to send message"}}async function o(e,t){let s=`https://api.twilio.com/2010-04-01/Accounts/${e.accountSid}/Messages.json`,a=new URLSearchParams;a.append("From",`whatsapp:${e.phoneNumberId}`),a.append("To",`whatsapp:+${i(t.to)}`),"text"===t.type?a.append("Body",t.text||""):t.media?.url&&(a.append("MediaUrl",t.media.url),t.media.caption&&a.append("Body",t.media.caption));let r=await fetch(s,{method:"POST",headers:{Authorization:"Basic "+Buffer.from(`${e.accountSid}:${e.accessToken}`).toString("base64"),"Content-Type":"application/x-www-form-urlencoded"},body:a.toString()}),n=await r.json();return r.ok?{success:!0,messageId:n.sid}:{success:!1,error:n.message||"Failed to send message"}}function i(e){let t=e.replace(/\D/g,"");return(10===t.length||11===t.length)&&(t="55"+t),t}s.d(t,{U3:()=>a})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958],()=>s(11628));module.exports=a})();