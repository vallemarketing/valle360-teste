"use strict";(()=>{var e={};e.id=81909,e.ids=[81909],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},5436:(e,r,a)=>{a.r(r),a.d(r,{originalPathname:()=>h,patchFetch:()=>w,requestAsyncStorage:()=>f,routeModule:()=>y,serverHooks:()=>x,staticGenerationAsyncStorage:()=>g});var t={};a.r(t),a.d(t,{POST:()=>_,dynamic:()=>c});var s=a(49303),o=a(88716),i=a(60670),n=a(87070),l=a(20344),d=a(71615),p=a(90176),m=a(30920),u=a(49805);let c="force-dynamic";async function _(e){try{let r=(0,d.cookies)(),a=(0,l.createRouteHandlerClient)({cookies:()=>r}),{data:t}=await a.auth.getUser(),s=t.user?.id;if(!s)return n.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:o,error:i}=await a.rpc("is_admin");if(i||!o)return n.NextResponse.json({error:"Acesso negado (admin)"},{status:403});let{nome:c,sobrenome:_,email:y,emailPessoal:f,telefone:g,senha:x,areas:h,dataNascimento:w,contatoEmergencia:v,telefoneEmergencia:b,chavePix:j,fotoUrl:q,nivelHierarquico:R}=await e.json(),$=(0,p.t)(),{data:k,error:A}=await $.auth.admin.createUser({email:y,password:x,email_confirm:!0,user_metadata:{full_name:`${c} ${_}`,user_type:"employee",role:"employee"}});if(A)return console.error("Erro ao criar no auth:",A),n.NextResponse.json({error:A.message},{status:400});let S=k.user.id,{data:N,error:C}=await $.from("users").insert({id:S,email:y,full_name:`${c} ${_}`,name:`${c} ${_}`,role:"employee",user_type:"employee",phone:g||null,account_status:"active",created_by:s,is_active:!0,email_verified:!0,two_factor_enabled:!1,last_login_at:null}).select().single();if(C)return console.error("Erro ao criar na tabela users:",C),await $.auth.admin.deleteUser(S),n.NextResponse.json({error:C.message},{status:400});let P={user_id:S,full_name:`${c} ${_}`,email:y,personal_email:f||null,phone:g,avatar:q||`https://api.dicebear.com/7.x/avataaars/svg?seed=${y}`,department:h[0]||"Geral",position:"lider"===R?"L\xedder":"Colaborador",area_of_expertise:h.join(", "),hire_date:new Date().toISOString().split("T")[0],birth_date:w||null,emergency_contact:v||null,emergency_phone:b||null,pix_key:j||null,is_active:!0,first_name:c,last_name:_,whatsapp:g||null,admission_date:new Date().toISOString().split("T")[0],areas:Array.isArray(h)?h:[],photo_url:q||null},T=null,U=null;{let e=await $.from("employees").insert(P).select().single();T=e.data,U=e.error}if(U&&String(U.message||"").toLowerCase().includes("personal_email")){let{personal_email:e,...r}=P,a=await $.from("employees").insert(r).select().single();T=a.data,U=a.error}if(U)return console.error("Erro ao criar employee:",U),await $.from("users").delete().eq("id",S),await $.auth.admin.deleteUser(S),n.NextResponse.json({error:U.message},{status:400});for(let e of[{name:"dashboard",description:"Acesso ao dashboard"},{name:"kanban",description:"Acesso ao Kanban"},{name:"messages",description:"Sistema de mensagens"},{name:"files",description:"Gerenciador de arquivos"}])await $.from("employee_permissions").insert({employee_id:T.id,permission_name:e.name,permission_description:e.description,is_active:!0});await $.from("user_profiles").upsert({id:S,user_id:S,email:y,full_name:`${c} ${_}`,user_type:"employee",role:"employee",is_active:!0,metadata:f?{personal_email:f}:void 0});let E=await (0,m.Kn)({eventType:"employee.created",entityType:"employee",entityId:T.id,actorUserId:s,payload:{employee_id:T.id,user_id:S,email:y}},$),O=await (0,u.Z)(E);return O.ok?await (0,m.ls)(E.id,$):await (0,m.bT)(E.id,O.error,$),console.log("âœ… Colaborador criado com sucesso:",y),n.NextResponse.json({success:!0,userId:S,employeeId:T.id,email:y,emailPessoal:f,event_status:O.ok?"processed":"error"})}catch(e){return console.error("Erro geral ao criar colaborador:",e),n.NextResponse.json({error:e.message||"Erro desconhecido"},{status:500})}}let y=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/create-employee/route",pathname:"/api/admin/create-employee",filename:"route",bundlePath:"app/api/admin/create-employee/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\create-employee\\route.ts",nextConfigOutput:"standalone",userland:t}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:x}=y,h="/api/admin/create-employee/route";function w(){return(0,i.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:g})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var a=e=>r(r.s=e),t=r.X(0,[89276,55972,54128,20958,40074,38823],()=>a(5436));module.exports=t})();