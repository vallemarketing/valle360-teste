"use strict";(()=>{var e={};e.id=12793,e.ids=[12793],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},51152:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>g,patchFetch:()=>v,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var r={};a.r(r),a.d(r,{POST:()=>c,dynamic:()=>l});var o=a(49303),s=a(88716),n=a(60670),i=a(54128),p=a(87070);let l="force-dynamic";async function c(e){try{let{token:t}=await e.json(),a="https://ikjgsqtykkhqimypacro.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!a||!r)return console.error("Service Role Key faltando para assinatura de contrato"),p.NextResponse.json({error:"Erro de configura\xe7\xe3o no servidor"},{status:500});let o=(0,i.eI)(a,r),{data:s,error:n}=await o.from("proposals").select("*").eq("magic_link_token",t).single();if(n||!s)return p.NextResponse.json({error:"Proposta inv\xe1lida ou expirada"},{status:404});if("accepted"===s.status)return p.NextResponse.json({message:"Proposta j\xe1 foi aceita anteriormente"});let l=null,{data:c}=await o.from("clients").select("id").eq("contact_email",s.client_email).single();if(c)l=c.id;else{let{data:e,error:t}=await o.from("clients").insert({company_name:s.client_name,contact_name:s.client_name,contact_email:s.client_email,status:"active"}).select().single();if(t)throw t;l=e.id}let{error:u}=await o.from("proposals").update({status:"accepted"}).eq("id",s.id);if(u)throw u;let{error:d}=await o.from("contracts").insert({proposal_id:s.id,client_id:l,title:`Contrato - ${s.client_name}`,start_date:new Date().toISOString(),value:s.total_value,payment_frequency:"monthly",active:!0,status:"active"});if(d)throw d;return p.NextResponse.json({success:!0})}catch(e){return console.error("Erro ao assinar proposta:",e),p.NextResponse.json({error:"Erro interno ao processar assinatura"},{status:500})}}let u=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/proposals/sign/route",pathname:"/api/proposals/sign",filename:"route",bundlePath:"app/api/proposals/sign/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\proposals\\sign\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:f}=u,g="/api/proposals/sign/route";function v(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128],()=>a(51152));module.exports=r})();