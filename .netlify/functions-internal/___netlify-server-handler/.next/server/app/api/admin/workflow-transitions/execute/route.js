"use strict";(()=>{var e={};e.id=11746,e.ids=[11746],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},26503:(e,a,i)=>{i.r(a),i.d(a,{originalPathname:()=>y,patchFetch:()=>v,requestAsyncStorage:()=>b,routeModule:()=>g,serverHooks:()=>k,staticGenerationAsyncStorage:()=>w});var t={};i.r(t),i.d(t,{POST:()=>f,dynamic:()=>_});var r=i(49303),n=i(88716),o=i(60670),d=i(87070),s=i(20344),l=i(71615),c=i(88783),u=i(29601);let _="force-dynamic";async function p(e,a){try{let{data:i}=await e.from("kanban_tasks").select("id, board_id, client_id").eq("reference_links->>workflow_transition_id",a).limit(1).maybeSingle();if(i?.id&&i?.board_id)return i}catch{}try{let{data:i}=await e.from("kanban_tasks").select("id, board_id, client_id").eq("metadata->>workflow_transition_id",a).limit(1).maybeSingle();if(i?.id&&i?.board_id)return i}catch{}return null}async function m(e,a){if(!a)return null;if(a.client_id)return String(a.client_id);if(a.clientId)return String(a.clientId);if(a.proposal_id){let{data:i}=await e.from("proposals").select("client_email").eq("id",a.proposal_id).maybeSingle(),t=i?.client_email?String(i.client_email):null;if(t){let{data:a}=await e.from("clients").select("id").or(`email.eq.${t},contact_email.eq.${t}`).limit(1).maybeSingle();if(a?.id)return String(a.id)}}if(a.invoice_id){let{data:i}=await e.from("invoices").select("client_id").eq("id",a.invoice_id).maybeSingle();if(i?.client_id)return String(i.client_id)}if(a.contract_id){let{data:i}=await e.from("contracts").select("client_id").eq("id",a.contract_id).maybeSingle();if(i?.client_id)return String(i.client_id)}return null}async function f(e){let a=(0,l.cookies)(),i=(0,s.createRouteHandlerClient)({cookies:()=>a}),{data:t}=await i.auth.getUser(),r=t.user?.id||null;if(!r)return d.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:n,error:o}=await i.rpc("is_admin");if(o||!n)return d.NextResponse.json({error:"Acesso negado (admin)"},{status:403});try{let a=await e.json(),t=a?.id;if(!t)return d.NextResponse.json({error:"id \xe9 obrigat\xf3rio"},{status:400});let{data:n,error:o}=await i.from("workflow_transitions").select("*").eq("id",t).single();if(o||!n)return d.NextResponse.json({error:"Transi\xe7\xe3o n\xe3o encontrada"},{status:404});let s=n.data_payload||{},l=String(n.status||"").toLowerCase(),_=function(e){if(!e)return{boardId:null,taskId:null};let a=e.kanban_board_id||e.board_id||null,i=e.kanban_task_id||e.task_id||null;return{boardId:a?String(a):null,taskId:i?String(i):null}}(s);if("completed"===l&&_.boardId&&_.taskId)return d.NextResponse.json({success:!0,task_id:_.taskId,board_id:_.boardId,client_id:s?.client_id??null,already_executed:!0});let f=await p(i,n.id);if(f?.id&&f?.board_id){let e=new Date().toISOString(),a={...s||{},kanban_task_id:String(f.id),kanban_board_id:String(f.board_id),executed_at:s?.executed_at||e,executed_by:s?.executed_by||r,client_id:s?.client_id??f?.client_id??null};if("pending"===l)await i.from("workflow_transitions").update({status:"completed",completed_at:e,error_message:null,data_payload:a}).eq("id",n.id);else try{await i.from("workflow_transitions").update({data_payload:a}).eq("id",n.id)}catch{}return d.NextResponse.json({success:!0,task_id:String(f.id),board_id:String(f.board_id),client_id:a.client_id??null,already_executed:!0})}if("pending"!==l)return d.NextResponse.json({error:"Apenas transi\xe7\xf5es pendentes podem ser executadas"},{status:400});let g=await m(i,s),b=g?await (0,c.bI)(i,g,r):await (0,c.yH)(i,r),w=function(e,a){let i=String(e?.trigger_event||"").toLowerCase(),t=e?.from_area||"",r=e?.to_area||"",n={client_id:a?.client_id||a?.clientId||null,proposal_id:a?.proposal_id||null,contract_id:a?.contract_id||null,invoice_id:a?.invoice_id||null,correlation_id:a?.correlation_id||null},o=[`Origem: ${t} → ${r}`,`Evento: ${e?.trigger_event}`,n.client_id?`Cliente: ${n.client_id}`:null,n.proposal_id?`Proposta: ${n.proposal_id}`:null,n.contract_id?`Contrato: ${n.contract_id}`:null,n.invoice_id?`Fatura: ${n.invoice_id}`:null,n.correlation_id?`Correlation: ${n.correlation_id}`:null].filter(Boolean).join("\n"),d=(()=>{try{return JSON.stringify(a||{},null,2)}catch{return""}})(),s=`${t} → ${r}: ${e?.trigger_event}`,l=e?.to_area||e?.from_area||"Operacao",c=function(e){let a=(e||"").toLowerCase();return a.includes("payment_failed")||a.includes("failed")?"urgent":a.includes("paid")?"high":(a.includes("created"),"medium")}(String(e?.trigger_event||"")),u="generic.workflow_transition",_=[];return"proposal.sent"===i?(s="Revisar proposta e preparar documenta\xe7\xe3o (Jur\xeddico)",l="Jur\xeddico",c="high",u="juridico.proposal_review",_=["Revisar escopo, prazos e cl\xe1usulas cr\xedticas","Validar dados do cliente e CNPJ/CPF (se aplic\xe1vel)","Preparar minuta/termos do contrato","Devolver para Contratos/Comercial com ajustes e riscos"]):"proposal.accepted"===i?(s="Gerar contrato e preparar assinatura (Contratos)",l="Contratos",c="high",u="contratos.contract_generation",_=["Gerar contrato a partir da proposta aceita","Conferir valores, datas, vencimento e escopo","Enviar para assinatura (DocuSign/Clicksign/etc.)","Atualizar status e anexos no sistema"]):"contract.created"===i?(s="Configurar cobran\xe7a inicial e acompanhar pagamento (Financeiro)",l="Financeiro",c="medium",u="financeiro.invoice_setup",_=["Confirmar contrato ativo e dados de cobran\xe7a","Validar fatura gerada / m\xe9todo de pagamento","Enviar comunica\xe7\xe3o de cobran\xe7a ao cliente (se necess\xe1rio)","Registrar pend\xeancia/risco (se houver)"]):"invoice.created"===i?(s="Iniciar onboarding operacional (Opera\xe7\xe3o)",l="Operacao",c="high",u="operacao.onboarding_start",_=["Agendar kickoff com cliente","Coletar acessos e briefing","Conectar integra\xe7\xf5es (Google/Meta/Pixel/WhatsApp)","Criar plano inicial e responsabilidades"]):"invoice.paid"===i?(s="Pagamento confirmado — iniciar execu\xe7\xe3o (Opera\xe7\xe3o)",l="Operacao",c="high",u="operacao.payment_confirmed",_=["Confirmar libera\xe7\xe3o de execu\xe7\xe3o (pagamento OK)","Priorizar setup e kickoff","Registrar in\xedcio de opera\xe7\xe3o e pr\xf3ximos marcos"]):"invoice.payment_failed"===i?(s="Falha no pagamento — acionar Financeiro/Comercial",l="Financeiro",c="urgent",u="financeiro.payment_failed",_=["Verificar motivo da falha no Stripe","Contatar cliente e oferecer alternativa","Atualizar status e pr\xf3ximos passos"]):"notifications.required"===i&&(s="Disparar notifica\xe7\xf5es e registrar confirma\xe7\xe3o (Notifica\xe7\xf5es)",l="Notificacoes",c="medium",u="notificacoes.dispatch_required",_=["Confirmar p\xfablico-alvo (cliente / time interno) e canal (in-app / email / WhatsApp)","Enviar mensagem padr\xe3o com link e IDs (cliente/proposta/contrato/fatura)","Registrar evid\xeancia e hor\xe1rio do envio"]),{title:s,description:`${o}`+(_.length?`

Checklist:
${_.map(e=>`- [ ] ${e}`).join("\n")}`:"")+`

Payload:
${d}`,status:"todo",priority:c,area:l,templateId:u}}(n,s),k=await (0,c.ID)(i,{boardId:b,clientId:g,title:w.title,description:w.description,status:w.status,priority:w.priority,area:w.area,createdBy:r,referenceLinks:{type:"workflow_transition",workflow_transition_id:n.id,from_area:n.from_area,to_area:n.to_area,trigger_event:n.trigger_event,payload:s,template_id:w.templateId}}),y=new Date().toISOString(),v={...s||{},kanban_task_id:k.id,kanban_board_id:k.board_id,executed_at:y,executed_by:r,client_id:g??s?.client_id??null};await i.from("workflow_transitions").update({status:"completed",completed_at:y,error_message:null,data_payload:v}).eq("id",n.id);try{await i.from("event_log").insert({event_type:"workflow_transition.executed_to_kanban",entity_type:"workflow_transition",entity_id:n.id,actor_user_id:r,payload:{transition_id:n.id,from_area:n.from_area,to_area:n.to_area,trigger_event:n.trigger_event,template_id:w.templateId,kanban_task_id:k.id,kanban_board_id:k.board_id,client_id:g,at:y,correlation_id:v?.correlation_id||null},correlation_id:function(e){if(!e)return null;let a=String(e);return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(a)?a:null}(v?.correlation_id),status:"processed",processed_at:y})}catch{}let x=`/admin/meu-kanban?boardId=${encodeURIComponent(k.board_id)}&taskId=${encodeURIComponent(k.id)}`;return await (0,u._)(i,{title:"Fluxo enviado para execu\xe7\xe3o",message:`Transi\xe7\xe3o "${n.from_area} → ${n.to_area}" virou tarefa no Kanban.`,type:"system",link:x,metadata:{workflow_transition_id:n.id,trigger_event:n.trigger_event,board_id:k.board_id,task_id:k.id,client_id:g},is_read:!1}),d.NextResponse.json({success:!0,task_id:k.id,board_id:k.board_id,client_id:g})}catch(e){return d.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let g=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/workflow-transitions/execute/route",pathname:"/api/admin/workflow-transitions/execute",filename:"route",bundlePath:"app/api/admin/workflow-transitions/execute/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\workflow-transitions\\execute\\route.ts",nextConfigOutput:"standalone",userland:t}),{requestAsyncStorage:b,staticGenerationAsyncStorage:w,serverHooks:k}=g,y="/api/admin/workflow-transitions/execute/route";function v(){return(0,o.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:w})}},29601:(e,a,i)=>{async function t(e){let{data:a}=await e.from("user_profiles").select("user_id, user_type, is_active").in("user_type",["super_admin","admin"]).eq("is_active",!0);return(a||[]).map(e=>e.user_id).filter(Boolean).map(e=>String(e))}async function r(e,a){let i=await t(e);if(0===i.length)return;let r=i.map(e=>({user_id:e,title:a.title,message:a.message,type:a.type||"system",is_read:a.is_read??!1,link:a.link??null,metadata:a.metadata||{},created_at:new Date().toISOString()}));try{await e.from("notifications").insert(r)}catch{}}i.d(a,{_:()=>r})},88783:(e,a,i)=>{async function t(e,a){let{data:i}=await e.from("kanban_columns").select("id,name,position").eq("board_id",a).order("position",{ascending:!0});i&&i.length>0||await e.from("kanban_columns").insert([{name:"Backlog",position:1,color:"#64748b"},{name:"A Fazer",position:2,color:"#f59e0b"},{name:"Em Progresso",position:3,color:"#3b82f6"},{name:"Em Revis\xe3o",position:4,color:"#8b5cf6"},{name:"Conclu\xeddo",position:5,color:"#22c55e"},{name:"Bloqueado",position:6,color:"#ef4444"},{name:"Cancelado",position:7,color:"#9ca3af"}].map(e=>({...e,board_id:a})))}async function r(e,a){let{data:i}=await e.from("kanban_boards").select("id").is("client_id",null).eq("name","Super Admin").limit(1).maybeSingle();if(i?.id)return await t(e,i.id),i.id;let{data:r,error:n}=await e.from("kanban_boards").insert({name:"Super Admin",description:"Quadro central do Admin",client_id:null,is_active:!0,created_by:a||null}).select("id").single();if(n)throw n;return await t(e,r.id),r.id}async function n(e,a,i){let{data:r}=await e.from("kanban_boards").select("id").eq("client_id",a).eq("name","Onboarding").limit(1).maybeSingle();if(r?.id)return await t(e,r.id),r.id;let{data:n,error:o}=await e.from("kanban_boards").insert({name:"Onboarding",description:"Fluxo inicial autom\xe1tico",client_id:a,is_active:!0,created_by:i||null}).select("id").single();if(o)throw o;return await t(e,n.id),n.id}async function o(e,a,i){let t=function(e){switch(e){case"backlog":return"Backlog";case"in_progress":return"Em Progresso";case"in_review":return"Em Revis\xe3o";case"done":return"Conclu\xeddo";case"blocked":return"Bloqueado";case"cancelled":return"Cancelado";default:return"A Fazer"}}(i),{data:r}=await e.from("kanban_columns").select("id").eq("board_id",a).eq("name",t).limit(1).maybeSingle();if(r?.id)return r.id;let{data:n}=await e.from("kanban_columns").select("id").eq("board_id",a).order("position",{ascending:!0}).limit(1).maybeSingle();if(!n?.id)throw Error("Board sem colunas");return n.id}async function d(e,a){let i=a.status||"todo",t=a.priority||"medium",r=await o(e,a.boardId,i),{data:n}=await e.from("kanban_tasks").select("position").eq("board_id",a.boardId).eq("column_id",r).order("position",{ascending:!1}).limit(1).maybeSingle(),d=Number(n?.position||0)+1,{data:s,error:l}=await e.from("kanban_tasks").insert({board_id:a.boardId,column_id:r,title:a.title,description:a.description||null,priority:t,status:i,position:d,client_id:a.clientId||null,area:a.area||null,created_by:a.createdBy||null,reference_links:a.referenceLinks||null,updated_at:new Date().toISOString()}).select("id, board_id").single();if(l)throw l;return s}i.d(a,{ID:()=>d,bI:()=>n,yH:()=>r})}};var a=require("../../../../../webpack-runtime.js");a.C(e);var i=e=>a(a.s=e),t=a.X(0,[89276,55972,54128,20958],()=>i(26503));module.exports=t})();