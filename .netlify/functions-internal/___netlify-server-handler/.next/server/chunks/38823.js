"use strict";exports.id=38823,exports.ids=[38823],exports.modules={30920:(e,t,i)=>{i.d(t,{Kn:()=>r,bT:()=>n,ls:()=>o});var a=i(90176);async function r(e,t){let i=t??(0,a.t)(),r=e.correlationId||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),{data:o,error:n}=await i.from("event_log").insert({event_type:e.eventType,entity_type:e.entityType||null,entity_id:e.entityId||null,actor_user_id:e.actorUserId||null,payload:e.payload||{},status:"pending",correlation_id:r}).select("*").single();if(n)throw n;return o}async function o(e,t){let i=t??(0,a.t)(),{error:r}=await i.from("event_log").update({status:"processed",processed_at:new Date().toISOString(),error_message:null}).eq("id",e);if(r)throw r}async function n(e,t,i){let r=i??(0,a.t)(),{error:o}=await r.from("event_log").update({status:"error",processed_at:new Date().toISOString(),error_message:t}).eq("id",e);if(o)throw o}},49805:(e,t,i)=>{i.d(t,{Z:()=>m});var a=i(90176),r=i(9792),o=i(29601),n=i(14399);async function d(e){let t=(0,a.t)(),i={...e.payload||{},source_event_id:e.sourceEventId||null,correlation_id:e.correlationId||null};if(e.sourceEventId){let{data:i}=await t.from("workflow_transitions").select("id").eq("from_area",e.fromArea).eq("to_area",e.toArea).eq("trigger_event",e.triggerEvent).eq("data_payload->>source_event_id",String(e.sourceEventId)).limit(1).maybeSingle();if(i?.id)return String(i.id)}let{data:r}=await t.from("workflow_transitions").insert({from_area:e.fromArea,to_area:e.toArea,status:"pending",trigger_event:e.triggerEvent,data_payload:i,created_by:e.createdBy||null}).select("id").single(),o=r?.id?String(r.id):null;try{await (0,n.Q)({area:e.toArea,title:`Nova demanda (${e.toArea})`,message:`H\xe1 uma nova transi\xe7\xe3o pendente para a sua \xe1rea. Evento: ${e.triggerEvent}.`,link:"/colaborador/kanban",metadata:{workflow_transition_id:o,trigger_event:e.triggerEvent,from_area:e.fromArea,to_area:e.toArea,correlation_id:e.correlationId||null,source_event_id:e.sourceEventId||null},type:"workflow"})}catch{}return o}async function c(e,t,i,r){let n=(0,a.t)();await (0,o._)(n,{title:e,message:t,type:"system",is_read:!1,link:r??null,metadata:i||{}})}function s(e){let t=new URLSearchParams;e.tab&&t.set("tab",e.tab),e.status&&t.set("status",e.status),e.q&&t.set("q",e.q);let i=t.toString();return`/admin/fluxos${i?`?${i}`:""}`}async function l(e,t){let i=(0,a.t)(),{data:r}=await i.from("clients").select("id").or(`email.eq.${t},contact_email.eq.${t}`).limit(1);if(r&&r.length>0)return r[0].id;let{data:o,error:n}=await i.from("clients").insert({company_name:e,contact_name:e,contact_email:t,email:t,status:"active",created_at:new Date().toISOString()}).select("id").single();if(n)throw n;return o.id}async function _(e,t){let i=(0,a.t)(),{data:r,error:o}=await i.from("kanban_boards").insert({name:"Onboarding",description:"Fluxo inicial autom\xe1tico",client_id:e,is_active:!0,created_by:t||null}).select("id").single();if(o)throw o;let{data:n,error:d}=await i.from("kanban_columns").insert([{name:"Backlog",position:1,color:"#64748b"},{name:"A Fazer",position:2,color:"#3b82f6"},{name:"Em Progresso",position:3,color:"#f59e0b"},{name:"Conclu\xeddo",position:4,color:"#22c55e"}].map(e=>({...e,board_id:r.id}))).select("id, position");if(d)throw d;let c=(n||[]).slice().sort((e,t)=>e.position-t.position)[0];if(c)return await i.from("kanban_tasks").insert([{title:"Reuni\xe3o de kickoff",description:"Agendar kickoff com o cliente",priority:"high"},{title:"Conectar integra\xe7\xf5es",description:"Google/Meta/WhatsApp/Pixel etc.",priority:"high"},{title:"Coletar acessos e briefing",description:"Documentos, contas, ativos",priority:"medium"}].map((i,a)=>({board_id:r.id,column_id:c.id,title:i.title,description:i.description,priority:i.priority,position:a+1,client_id:e,status:"todo",created_by:t||null}))),r.id}async function u(e,t){let i=(0,a.t)(),{data:r}=await i.from("kanban_boards").select("id").eq("client_id",e).eq("name","Onboarding").limit(1).maybeSingle();return r?.id?r.id:await _(e,t)}async function p(e){let t=(0,a.t)(),i=await u(e.clientId,e.createdBy),r=e.status||"todo",o=e.priority||"medium",n=function(e){switch(e){case"backlog":return"Backlog";case"in_progress":case"in_review":return"Em Progresso";case"done":return"Conclu\xeddo";default:return"A Fazer"}}(r),{data:d}=await t.from("kanban_columns").select("id").eq("board_id",i).eq("name",n).limit(1).maybeSingle(),c=d?.id?d.id:(await t.from("kanban_columns").select("id").eq("board_id",i).order("position",{ascending:!0}).limit(1).maybeSingle()).data?.id;if(!c)return;let{data:s}=await t.from("kanban_tasks").select("position").eq("board_id",i).eq("column_id",c).order("position",{ascending:!1}).limit(1).maybeSingle(),l=Number(s?.position||0)+1;await t.from("kanban_tasks").insert({board_id:i,column_id:c,title:e.title,description:e.description||null,priority:o,status:r,position:l,client_id:e.clientId,area:e.area||"Operacao",created_by:e.createdBy||null,reference_links:e.referenceLinks||null})}async function m(e){try{switch(e.event_type){case"client.created":return await d({fromArea:"Admin",toArea:"Operacao",triggerEvent:"client.created",payload:e.payload,createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id}),e.entity_id&&await u(e.entity_id,e.actor_user_id),await c("Novo cliente cadastrado","Cliente criado e onboarding iniciado.",{client_id:e.entity_id,correlation_id:e.correlation_id},s({tab:"transitions",status:"pending",q:e.entity_id||e.correlation_id||"client.created"})),{ok:!0};case"employee.created":await d({fromArea:"Admin",toArea:"RH",triggerEvent:"employee.created",payload:e.payload,createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id});try{let t=(0,a.t)(),i=e.entity_id,{data:o}=await t.from("employees").select("user_id, full_name, department, areas").eq("id",i).single(),n=o?.user_id;if(n){let e=Array.isArray(o?.areas)?o.areas[0]:o?.department,t=function(e){let t=(e||"").toLowerCase();return t.includes("social")?"social_media":t.includes("tr\xe1fego")||t.includes("trafego")?"trafego":t.includes("video")||t.includes("v\xeddeo")?"video_maker":t.includes("comercial")||t.includes("vendas")?"comercial":t.includes("rh")||t.includes("people")?"rh":(t.includes("web")||t.includes("design"),"designer")}(e);await r.n.createGoal(n,o?.full_name||"Colaborador",t,"monthly")}}catch{}return await c("Novo colaborador cadastrado","Colaborador criado e pronto para receber metas/fluxos.",{employee_id:e.entity_id,correlation_id:e.correlation_id},s({tab:"transitions",status:"pending",q:e.entity_id||e.correlation_id||"employee.created"})),{ok:!0};case"proposal.sent":return await d({fromArea:"Comercial",toArea:"Jur\xeddico",triggerEvent:"proposal.sent",payload:{...e.payload||{},proposal_id:e.entity_id},createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id}),await c("Proposta enviada","Proposta enviada ao cliente. Aguardando aceite.",{proposal_id:e.entity_id,correlation_id:e.correlation_id},s({tab:"transitions",status:"pending",q:e.entity_id||e.correlation_id||"proposal.sent"})),{ok:!0};case"proposal.rejected":return await d({fromArea:"Comercial",toArea:"Comercial",triggerEvent:"proposal.rejected",payload:{...e.payload||{},proposal_id:e.entity_id},createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id}),await c("Proposta rejeitada","O cliente rejeitou a proposta. Revisar abordagem e condi\xe7\xf5es.",{proposal_id:e.entity_id,correlation_id:e.correlation_id,...e.payload||{}},s({tab:"transitions",status:"pending",q:e.entity_id||e.correlation_id||"proposal.rejected"})),{ok:!0};case"proposal.accepted":{let t=e.entity_id;t&&await (0,a.t)().from("workflow_transitions").update({status:"completed",completed_at:new Date().toISOString(),error_message:null}).eq("trigger_event","proposal.sent").eq("status","pending").eq("data_payload->>proposal_id",String(t)),await d({fromArea:"Jur\xeddico",toArea:"Contratos",triggerEvent:"proposal.accepted",payload:{...e.payload||{},proposal_id:t},createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id});let i=(0,a.t)();if(t){let{data:a}=await i.from("proposals").select("id, client_name, client_email, total_value, status").eq("id",t).single();if(a?.client_email){let r=await l(a.client_name||a.client_email,a.client_email);await u(r,e.actor_user_id);let{data:o}=await i.from("contracts").select("id, client_id, monthly_value, due_day, start_date").eq("proposal_id",t).limit(1).maybeSingle(),n=o?.id?o:(await i.from("contracts").insert({client_id:r,proposal_id:t,status:"active",active:!0,start_date:new Date().toISOString().slice(0,10),end_date:null,monthly_value:a.total_value||0,due_day:5,created_at:new Date().toISOString()}).select("id, client_id, monthly_value, due_day, start_date").single()).data;if(!n?.id)throw Error("Falha ao obter/criar contrato");let c=new Date,s=c.toISOString().slice(0,10),_=Number(n?.due_day||5),p=new Date(c.getFullYear(),c.getMonth(),_).toISOString().slice(0,10),{data:m}=await i.from("invoices").select("id, invoice_number").eq("contract_id",n.id).eq("issue_date",s).limit(1).maybeSingle(),g=m?.invoice_number||`INV-${c.getFullYear()}${String(c.getMonth()+1).padStart(2,"0")}-${String(Math.floor(9e3*Math.random())+1e3)}`,f=m?.id?m:(await i.from("invoices").insert({contract_id:n.id,client_id:n.client_id,invoice_number:g,amount:n.monthly_value||0,issue_date:s,due_date:p,status:"pending",notes:"Fatura inicial gerada automaticamente a partir do aceite da proposta.",created_at:new Date().toISOString()}).select("id, invoice_number").single()).data;if(!f?.id)throw Error("Falha ao obter/criar fatura");let{data:y}=await i.from("financial_transactions").select("id").eq("invoice_id",f.id).limit(1).maybeSingle();y?.id||await i.from("financial_transactions").insert({transaction_type:"income",category:"subscription",amount:n.monthly_value||0,description:"Receita prevista - contrato ativo",transaction_date:s,invoice_id:f.id,client_id:n.client_id,payment_method:null,reference_number:g,status:"pending",created_by:e.actor_user_id,created_at:new Date().toISOString()}),await d({fromArea:"Contratos",toArea:"Financeiro",triggerEvent:"contract.created",payload:{proposal_id:t,contract_id:n.id,invoice_id:f.id,client_id:n.client_id},createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id}),await d({fromArea:"Financeiro",toArea:"Operacao",triggerEvent:"invoice.created",payload:{proposal_id:t,contract_id:n.id,invoice_id:f.id,client_id:n.client_id},createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id}),await d({fromArea:"Operacao",toArea:"Notificacoes",triggerEvent:"notifications.required",payload:{proposal_id:t,contract_id:n.id,invoice_id:f.id,client_id:n.client_id},createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id})}}return await c("Proposta aceita","Aceite confirmado. Pr\xf3ximo passo: Jur\xeddico → Contratos (e gera\xe7\xe3o autom\xe1tica de contrato/fatura quando poss\xedvel).",{proposal_id:t,correlation_id:e.correlation_id},s({tab:"transitions",status:"pending",q:t||e.correlation_id||"proposal.accepted"})),{ok:!0}}case"invoice.paid":{let t=(0,a.t)(),i=e.entity_id,r=e.payload||{};return i&&(await t.from("invoices").update({status:"paid",paid_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",i),await t.from("financial_transactions").update({status:"completed",payment_method:r.payment_method||r.collection_method||null,reference_number:r.stripe_invoice_id||r.invoice_number||null,updated_at:new Date().toISOString()}).eq("invoice_id",i)),await d({fromArea:"Financeiro",toArea:"Operacao",triggerEvent:"invoice.paid",payload:r,createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id}),await d({fromArea:"Operacao",toArea:"Notificacoes",triggerEvent:"notifications.required",payload:r,createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id}),await c("Fatura paga (Stripe)","Pagamento confirmado. Fluxo enviado para Opera\xe7\xe3o.",{invoice_id:i,client_id:r.client_id,stripe_invoice_id:r.stripe_invoice_id,correlation_id:e.correlation_id},s({tab:"transitions",status:"pending",q:i||String(r.stripe_invoice_id||"")||e.correlation_id||"invoice.paid"})),r.client_id&&await p({clientId:r.client_id,title:"Pagamento confirmado — iniciar opera\xe7\xe3o",description:"Stripe confirmou o pagamento. Iniciar onboarding operacional (integra\xe7\xf5es, kickoff, setup de campanhas).",status:"todo",priority:"high",area:"Operacao",referenceLinks:{type:"stripe",stripe_invoice_id:r.stripe_invoice_id,invoice_id:i,amount:r.amount,currency:r.currency},createdBy:e.actor_user_id}),{ok:!0}}case"invoice.payment_failed":{let t=(0,a.t)(),i=e.entity_id,r=e.payload||{};return i&&(await t.from("invoices").update({status:"payment_failed",updated_at:new Date().toISOString()}).eq("id",i),await t.from("financial_transactions").update({status:"failed",reference_number:r.stripe_invoice_id||r.invoice_number||null,updated_at:new Date().toISOString()}).eq("invoice_id",i)),await d({fromArea:"Financeiro",toArea:"Comercial",triggerEvent:"invoice.payment_failed",payload:r,createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id}),await d({fromArea:"Comercial",toArea:"Notificacoes",triggerEvent:"notifications.required",payload:r,createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id}),await c("Falha de pagamento (Stripe)","Pagamento falhou. A\xe7\xe3o necess\xe1ria do Financeiro/Comercial.",{invoice_id:i,client_id:r.client_id,stripe_invoice_id:r.stripe_invoice_id,correlation_id:e.correlation_id},s({tab:"transitions",status:"pending",q:i||String(r.stripe_invoice_id||"")||e.correlation_id||"invoice.payment_failed"})),r.client_id&&await p({clientId:r.client_id,title:"Falha no pagamento — acionar Financeiro/Comercial",description:"Stripe informou falha no pagamento. Verificar motivo, contatar cliente e definir pr\xf3ximo passo.",status:"todo",priority:"urgent",area:"Financeiro",referenceLinks:{type:"stripe",stripe_invoice_id:r.stripe_invoice_id,invoice_id:i,amount:r.amount,currency:r.currency},createdBy:e.actor_user_id}),{ok:!0}}case"contract.signed":{let t=(0,a.t)(),i=e.entity_id,r=e.payload||{};if(!i)return{ok:!1,error:"Missing contract_id"};await t.from("contracts").update({status:"active",active:!0,activated_at:new Date().toISOString(),signed_at:r.signed_at||new Date().toISOString(),signed_by:r.signed_by||null,signature_ip:r.signature_ip||null}).eq("id",i);let{data:o}=await t.from("contracts").select("*, clients(id, company_name, email, contact_name)").eq("id",i).single();if(!o)return{ok:!1,error:"Contract not found"};let n=o.client_id,l=o.monthly_value||o.total_value/(o.duration_months||12)||0,_=new Date,u=Number(o.due_day||10),m=new Date(_.getFullYear(),_.getMonth(),u);m<_&&m.setMonth(m.getMonth()+1),await t.from("invoices").insert({contract_id:i,client_id:n,amount:l,due_date:m.toISOString(),issue_date:_.toISOString(),status:"pending",description:"Primeira mensalidade",notes:"Gerada automaticamente ap\xf3s assinatura do contrato.",created_at:new Date().toISOString()}).select("id").single();let g=o.end_date?new Date(o.end_date):null,f=new Date(m);f.setMonth(f.getMonth()+1),await t.from("recurring_invoice_schedules").insert({contract_id:i,client_id:n,amount:l,frequency:"monthly",day_of_month:u,next_run:f.toISOString(),end_date:g?.toISOString()||null,is_active:!0,created_at:new Date().toISOString()});let y=o.services||[];for(let t of y){let a="string"==typeof t?t:t.name,r=function(e){let t=e.toLowerCase();return t.includes("social")||t.includes("redes")?"Social Media":t.includes("tr\xe1fego")||t.includes("trafego")||t.includes("ads")?"Tr\xe1fego":t.includes("design")||t.includes("visual")?"Design":t.includes("video")||t.includes("v\xeddeo")?"Video":t.includes("web")||t.includes("site")||t.includes("desenvolvimento")?"Desenvolvimento":t.includes("seo")?"SEO":t.includes("conte\xfado")||t.includes("conteudo")?"Conte\xfado":"Operacao"}(a);await p({clientId:n,title:`[NOVO] ${a} - ${o.clients?.company_name||"Cliente"}`,description:`Iniciar produ\xe7\xe3o do servi\xe7o conforme contrato assinado.

Cliente: ${o.clients?.company_name}
Contrato ID: ${i}`,status:"todo",priority:"high",area:r,createdBy:e.actor_user_id,referenceLinks:{type:"contract",contract_id:i,service_name:a}})}return await d({fromArea:"Jur\xeddico",toArea:"Financeiro",triggerEvent:"contract.signed",payload:{contract_id:i,client_id:n},createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id}),await d({fromArea:"Jur\xeddico",toArea:"Operacao",triggerEvent:"contract.signed",payload:{contract_id:i,client_id:n,services:y},createdBy:e.actor_user_id,sourceEventId:e.id,correlationId:e.correlation_id}),await c("Contrato Assinado",`Contrato de ${o.clients?.company_name||"cliente"} foi assinado digitalmente. Produ\xe7\xe3o iniciada.`,{contract_id:i,client_id:n,signed_by:r.signed_by,correlation_id:e.correlation_id},s({tab:"transitions",status:"pending",q:i||e.correlation_id||"contract.signed"})),{ok:!0}}default:return{ok:!0}}}catch(e){return{ok:!1,error:e?.message||"Falha ao processar evento"}}}},29601:(e,t,i)=>{async function a(e){let{data:t}=await e.from("user_profiles").select("user_id, user_type, is_active").in("user_type",["super_admin","admin"]).eq("is_active",!0);return(t||[]).map(e=>e.user_id).filter(Boolean).map(e=>String(e))}async function r(e,t){let i=await a(e);if(0===i.length)return;let r=i.map(e=>({user_id:e,title:t.title,message:t.message,type:t.type||"system",is_read:t.is_read??!1,link:t.link??null,metadata:t.metadata||{},created_at:new Date().toISOString()}));try{await e.from("notifications").insert(r)}catch{}}i.d(t,{_:()=>r})},14399:(e,t,i)=>{i.d(t,{Q:()=>o});var a=i(90176);function r(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}async function o(e){let t=(0,a.t)(),{data:i}=await t.from("employees").select("user_id, department, areas, is_active").eq("is_active",!0),o=(i||[]).filter(t=>t?.user_id&&function(e,t){let i=r(e),a=t.department?r(t.department):"",o=Array.isArray(t.areas)?t.areas.map(r):[];if(!i)return!1;if(a===i||o.includes(i)||a.includes(i)||i.includes(a)||o.some(e=>e.includes(i)||i.includes(e)))return!0;let n={operacao:["operacao","operacional","ops"],financeiro:["financeiro","finance","cobranca","cobran\xe7a"],comercial:["comercial","vendas","sales"],juridico:["juridico","juridico/compliance","compliance"],contratos:["contratos","contract"],notificacoes:["notificacoes","notificacoes-e-alertas","notificacoes/alertas"],rh:["rh","people","pessoas"]}[i]||[];return!!(n.length>0&&(n.some(e=>a.includes(e))||n.some(e=>o.some(t=>t.includes(e)))))}(e.area,t)).map(e=>String(e.user_id));if(0===o.length){let i={user_id:null,title:e.title,message:e.message,type:e.type||"workflow",is_read:!1,link:e.link??"/admin/fluxos",metadata:{...e.metadata||{},area:e.area,audience:"area"},created_at:new Date().toISOString()};try{await t.from("notifications").insert(i)}catch{}return}let n=o.map(t=>({user_id:t,title:e.title,message:e.message,type:e.type||"workflow",is_read:!1,link:e.link??"/colaborador/notificacoes",metadata:{...e.metadata||{},area:e.area,audience:"area"},created_at:new Date().toISOString()}));try{await t.from("notifications").insert(n)}catch{}}}};