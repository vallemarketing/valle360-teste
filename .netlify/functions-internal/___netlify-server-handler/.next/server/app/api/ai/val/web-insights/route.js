"use strict";(()=>{var e={};e.id=13136,e.ids=[13136],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},98158:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>_,requestAsyncStorage:()=>f,routeModule:()=>y,serverHooks:()=>x,staticGenerationAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{GET:()=>h,dynamic:()=>d});var a=r(49303),n=r(88716),i=r(60670),o=r(87070),c=r(20344),l=r(71615),u=r(90530),p=r(52019),m=r(90176);let d="force-dynamic";function g(e){let t=[];for(let r of e||[]){let e=String(r||"").trim();e&&/^https?:\/\//i.test(e)&&!t.includes(e)&&t.push(e)}return t}async function h(e){try{let e=(0,l.cookies)(),t=(0,c.createRouteHandlerClient)({cookies:()=>e}),{data:r}=await t.auth.getUser(),s=r?.user;if(!s)return o.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:a}=await t.from("user_profiles").select("user_type").or(`id.eq.${s.id},user_id.eq.${s.id}`).maybeSingle(),n=String(a?.user_type||"");if(!("client"===n||"cliente"===n))return o.NextResponse.json({success:!0,skip:!0});let i=null;{let e=(0,m.t)(),t=await e.from("clients").select("id, company_name, industry, segment, competitors, concorrentes").eq("user_id",s.id).maybeSingle();i=t.error?(await e.from("clients").select("id, company_name, industry").eq("user_id",s.id).maybeSingle()).data||null:t.data}let d=String(i?.company_name||""),h=String(i?.industry||""),y=String(i?.segment||""),f=Array.isArray(i?.competitors)?i.competitors.map(e=>String(e)).filter(Boolean):[],w="string"==typeof i?.concorrentes?String(i.concorrentes).split(/[\n,;]+/g).map(e=>e.trim()).filter(Boolean):[],x=[...f,...w],S=function(e){let t=String(e.companyName||"").trim(),r=String(e.industry||"").trim(),s=String(e.segment||"").trim(),a=(e.competitors||[]).map(e=>String(e).trim()).filter(Boolean).slice(0,6);return[`Fa\xe7a um resumo r\xe1pido e acion\xe1vel (\xfaltimos 30 dias) do setor/segmento: "${s||r||"marketing digital"}" no Brasil.`,t?`Empresa: ${t}.`:null,a.length?`Principais concorrentes: ${a.join(", ")}.`:null,"Formato obrigat\xf3rio:","- 5 bullets de insights (com contexto em 1 frase cada)","- 3 a\xe7\xf5es recomendadas para as pr\xf3ximas 2 semanas (bem pr\xe1ticas)","Requisitos:","- Responda em PT-BR.","- Seja objetivo (sem enrola\xe7\xe3o).","- Forne\xe7a fontes/URLs confi\xe1veis (cite URLs)."].filter(Boolean).join("\n")}({companyName:d,industry:h,segment:y,competitors:x});try{let e=await (0,u.y)({query:S});return o.NextResponse.json({success:!0,provider:"perplexity",message:e.answer,sources:g(e.sources).slice(0,12),generatedAt:new Date().toISOString()})}catch(e){try{let t=y||h||"marketing digital",r=await p.T.searchNews(`tend\xeancias ${t} Brasil`,8),s=g((r.results||[]).map(e=>e.url)).slice(0,12),a=r.answer&&String(r.answer).trim()||`Encontrei ${r.results?.length||0} fontes sobre "${t}". Abra as fontes abaixo para detalhes.`;return o.NextResponse.json({success:!0,provider:"tavily",message:a,sources:s,generatedAt:new Date().toISOString(),warning:String(e?.message||"perplexity_failed")})}catch(t){return o.NextResponse.json({success:!0,provider:"none",message:"Ainda n\xe3o consigo gerar insights com fontes neste ambiente (integra\xe7\xe3o de busca web n\xe3o configurada). Para ativar, conecte **Perplexity (Sonar)** em **Admin â†’ Integra\xe7\xf5es** (recomendado) ou configure `TAVILY_API_KEY`.",sources:[],generatedAt:new Date().toISOString(),warning:String(t?.message||e?.message||"web_insights_unavailable")})}}}catch(e){return console.error("Erro em /api/ai/val/web-insights:",e),o.NextResponse.json({error:"Erro ao gerar web insights",details:e?.message},{status:500})}}let y=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/ai/val/web-insights/route",pathname:"/api/ai/val/web-insights",filename:"route",bundlePath:"app/api/ai/val/web-insights/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\ai\\val\\web-insights\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:w,serverHooks:x}=y,S="/api/ai/val/web-insights/route";function _(){return(0,i.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:w})}},90176:(e,t,r)=>{r.d(t,{t:()=>a});var s=r(54128);function a(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,s.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},90530:(e,t,r)=>{r.d(t,{y:()=>n});var s=r(90176);async function a(){try{let e=(0,s.t)(),{data:t}=await e.from("integration_configs").select("api_key, config, status").eq("integration_id","perplexity").maybeSingle(),r=t?.api_key?String(t.api_key):null,a=String(t?.config?.model||"").trim()||"sonar";if(r)return{apiKey:r,model:a};return{apiKey:process.env.PERPLEXITY_API_KEY||null,model:a}}catch{return{apiKey:process.env.PERPLEXITY_API_KEY||null,model:"sonar"}}}async function n(e){let t=await a(),r=t.apiKey;if(!r)throw Error("PERPLEXITY_API_KEY n\xe3o configurada (db/env)");let s=String(e.model||t.model||"sonar").trim()||"sonar",n=e.timeoutMs??25e3,i=new AbortController,o=setTimeout(()=>i.abort(),n);try{let t=await fetch("https://api.perplexity.ai/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({model:s,temperature:.2,max_tokens:900,messages:[{role:"system",content:"Voc\xea \xe9 um mecanismo de pesquisa web. Responda em portugu\xeas do Brasil, de forma objetiva. Sempre que poss\xedvel, inclua fontes confi\xe1veis (URLs)."},{role:"user",content:e.query}]}),signal:i.signal}),a=await t.text();if(!t.ok)throw Error(`Perplexity error (${t.status}): ${a.slice(0,300)}`);let n=a?JSON.parse(a):{},o=n?.choices?.[0]?.message?.content||n?.choices?.[0]?.text||"",c=n?.citations||n?.choices?.[0]?.citations||n?.choices?.[0]?.message?.citations||n?.references,l=function(e){let t=[],r=e=>{if(e){if("string"==typeof e){let r=e.trim();r&&t.push(r);return}if("object"==typeof e){let r=e.url||e.link||e.href||e.source;"string"==typeof r&&r.trim()&&t.push(r.trim())}}};return Array.isArray(e)?e.forEach(r):r(e),Array.from(new Set(t))}(c);return!l.length&&(l=Array.from(new Set((o.match(/https?:\/\/[^\s)]+/g)||[]).map(e=>e.replace(/[.,;]+$/,""))))),{answer:String(o||"").trim(),sources:l}}finally{clearTimeout(o)}}},52019:(e,t,r)=>{r.d(t,{T:()=>a});class s{constructor(){this.apiKey=process.env.TAVILY_API_KEY||""}async request(e,t){if(!this.apiKey)throw Error("TAVILY_API_KEY n\xe3o configurada");let r=await fetch(`https://api.tavily.com${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:this.apiKey,...t})});if(!r.ok){let e=await r.text();throw Error(`Erro Tavily: ${r.status} - ${e}`)}return r.json()}async search(e){let t=Date.now(),r=await this.request("/search",{query:e.query,search_depth:e.searchDepth||"basic",include_answer:e.includeAnswer??!0,include_raw_content:e.includeRawContent??!1,max_results:e.maxResults||10,include_domains:e.includeDomains,exclude_domains:e.excludeDomains,topic:e.topic||"general"});return{query:e.query,answer:r.answer,results:r.results.map(e=>({title:e.title,url:e.url,content:e.content,rawContent:e.raw_content,score:e.score,publishedDate:e.published_date})),responseTime:Date.now()-t}}async extract(e){return(await this.request("/extract",{urls:e.urls})).results.map(e=>({url:e.url,rawContent:e.raw_content,error:e.error}))}async searchNews(e,t=10){return this.search({query:e,topic:"news",searchDepth:"advanced",maxResults:t,includeAnswer:!0})}async searchCompany(e){return this.search({query:`${e} empresa informa\xe7\xf5es contato site`,searchDepth:"advanced",maxResults:10,includeAnswer:!0})}async searchCompetitors(e,t,r){let s=`principais empresas ${e}`;return t&&(s+=` em ${t}`),r&&(s+=` exceto ${r}`),this.search({query:s,searchDepth:"advanced",maxResults:15,includeAnswer:!0})}async searchTrends(e){return this.search({query:`tend\xeancias ${e} 2024 2025 mercado brasil`,topic:"news",searchDepth:"advanced",maxResults:10,includeAnswer:!0})}async searchSocialMedia(e){return this.search({query:`${e} instagram facebook linkedin twitter site:instagram.com OR site:facebook.com OR site:linkedin.com`,searchDepth:"advanced",maxResults:10,includeDomains:["instagram.com","facebook.com","linkedin.com","twitter.com"]})}async searchReputation(e){return this.search({query:`${e} avalia\xe7\xe3o review reclama\xe7\xe3o opini\xe3o`,searchDepth:"advanced",maxResults:15,includeAnswer:!0,includeDomains:["reclameaqui.com.br","google.com/maps","trustpilot.com"]})}}let a=new s}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[89276,55972,54128,20958],()=>r(98158));module.exports=s})();