"use strict";(()=>{var e={};e.id=98797,e.ids=[98797],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},38745:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>S,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>_});var a={};i.r(a),i.d(a,{GET:()=>m,dynamic:()=>u});var r=i(49303),n=i(88716),o=i(60670),s=i(87070),l=i(20344),d=i(71615),c=i(90176);let u="force-dynamic";function p(e){let t=String(e?.message||"").toLowerCase();return"42P01"===String(e?.code||"")||t.includes("relation")||t.includes("does not exist")}async function m(e){try{let t=(0,d.cookies)(),i=(0,l.createRouteHandlerClient)({cookies:()=>t}),{data:a}=await i.auth.getUser(),r=a?.user;if(!r)return s.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let n=(0,c.t)(),{data:o,error:u}=await n.from("clients").select("id").eq("user_id",r.id).maybeSingle();if(u)return s.NextResponse.json({error:u.message},{status:500});let m=o?.id?String(o.id):null;if(!m)return s.NextResponse.json({error:"Cliente n\xe3o vinculado (clients.user_id)"},{status:400});let{searchParams:g}=new URL(e.url),f=Math.max(1,Math.min(20,Number(g.get("maxItems")||6)||6)),_=null;try{let e=new Date().toISOString(),{data:t,error:i}=await n.from("calendar_events").select("id,title,start_date,end_date,organizer_id,location,event_type").eq("client_id",m).gte("start_date",e).order("start_date",{ascending:!0}).limit(1).maybeSingle();if(i)throw i;if(t){let e=t.organizer_id?String(t.organizer_id):null,i=null,a=null;if(e){let[{data:t},{data:r}]=await Promise.all([n.from("user_profiles").select("full_name,role").eq("user_id",e).maybeSingle(),n.from("employees").select("role,position,department").eq("user_id",e).maybeSingle()]);i=t?.full_name?String(t.full_name):null,a=(r?.position?String(r.position):null)||(r?.role?String(r.role):null)||(t?.role?String(t.role):null)}let r=new Date(String(t.start_date));_={id:String(t.id),title:String(t.title||"Reuni\xe3o"),date:function(e){let t=new Intl.DateTimeFormat("pt-BR",{timeZone:"America/Sao_Paulo",day:"2-digit",month:"short"}).format(e).replace(" de "," ").replace(".","").split(" ").filter(Boolean),i=t[0]||"",a=(t[1]||"").slice(0,3);return`${i} ${a.charAt(0).toUpperCase()}${a.slice(1)}`}(r),time:new Intl.DateTimeFormat("pt-BR",{timeZone:"America/Sao_Paulo",hour:"2-digit",minute:"2-digit",hour12:!1}).format(r),with:i||"Equipe Valle",withRole:a||"Atendimento",href:"/cliente/agenda"}}}catch(e){p(e),_=null}let h=[],S=e=>{let t=e.createdAt,i=Date.now()-new Date(t).getTime();h.push({id:e.id,type:e.type,title:e.title,createdAt:t,time:function(e){let t=new Date(e),i=Date.now()-t.getTime(),a=Math.floor(i/6e4),r=Math.floor(i/36e5),n=Math.floor(i/864e5);return a<1?"Agora":a<60?`${a} min atr\xe1s`:r<24?`${r}h atr\xe1s`:`${n} dia${n>1?"s":""} atr\xe1s`}(t),read:i>864e5})};try{let{data:e,error:t}=await n.from("client_ai_insights").select("id,title,created_at").eq("client_id",m).order("created_at",{ascending:!1}).limit(f);if(t)throw t;for(let t of e||[])S({id:`insight:${t.id}`,type:"notification",title:t.title?`Novo insight: ${String(t.title)}`:"Novo insight dispon\xedvel",createdAt:String(t.created_at)})}catch(e){p(e)}try{let{data:e,error:t}=await n.from("files").select("id,file_name,created_at").eq("client_id",m).order("created_at",{ascending:!1}).limit(f);if(t)throw t;for(let t of e||[])S({id:`file:${t.id}`,type:"file",title:t.file_name?`Arquivo: ${String(t.file_name)}`:"Novo arquivo dispon\xedvel",createdAt:String(t.created_at)})}catch(e){p(e)}try{let{data:e,error:t}=await n.from("event_log").select("id,event_type,created_at,payload,status").order("created_at",{ascending:!1}).limit(60);if(t)throw t;for(let t of e||[]){let e=t.payload||{},i=String(e.client_id||e.clientId||"").trim();if(!i||i!==m)continue;let a=String(t.event_type||"").toLowerCase(),r="notification",n=String(t.event_type||"Atualiza\xe7\xe3o");a.startsWith("invoice.")?(r="notification",n="invoice.paid"===a?"Pagamento confirmado":"invoice.payment_failed"===a?"Falha no pagamento":"Atualiza\xe7\xe3o financeira"):a.includes("kanban")||a.includes("task")?(r="task",n="Atualiza\xe7\xe3o no Kanban"):a.includes("message")?(r="message",n="Nova mensagem"):(a.includes("approval")||a.includes("approved"))&&(r="approval",n="Aprova\xe7\xe3o registrada"),S({id:`event:${t.id}`,type:r,title:n,createdAt:String(t.created_at)})}}catch(e){p(e)}let v=new Map;for(let e of h)v.set(e.id,e);let y=Array.from(v.values()).sort((e,t)=>new Date(String(t.createdAt)).getTime()-new Date(String(e.createdAt)).getTime()).slice(0,f);return s.NextResponse.json({success:!0,nextMeeting:_,activities:y.map(({createdAt:e,...t})=>t)})}catch(e){return s.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let g=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/client/dashboard/feed/route",pathname:"/api/client/dashboard/feed",filename:"route",bundlePath:"app/api/client/dashboard/feed/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\dashboard\\feed\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:_,serverHooks:h}=g,S="/api/client/dashboard/feed/route";function v(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:_})}},90176:(e,t,i)=>{i.d(t,{t:()=>r});var a=i(54128);function r(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,a.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958],()=>i(38745));module.exports=a})();