"use strict";(()=>{var e={};e.id=88960,e.ids=[88960],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},97169:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>f,patchFetch:()=>g,requestAsyncStorage:()=>y,routeModule:()=>v,serverHooks:()=>_,staticGenerationAsyncStorage:()=>h});var r={};i.r(r),i.d(r,{GET:()=>m,dynamic:()=>d});var a=i(49303),n=i(88716),s=i(60670),o=i(87070),c=i(17478),u=i(90176);let d="force-dynamic";function l(e){if(null==e)return null;if("number"==typeof e&&Number.isFinite(e))return e;if("object"==typeof e&&e?.value!=null){let t=Number(e.value);return Number.isFinite(t)?t:null}let t=Number(e);return Number.isFinite(t)?t:null}function p(e,t){let i=(e||[]).filter(e=>String(e?.prediction_type||"")===t).map(e=>({r:e,v:l(e?.predicted_value)})).filter(e=>"number"==typeof e.v&&Number.isFinite(e.v));return i.sort((e,t)=>Number(t.v)-Number(e.v)),i[0]?.r||null}async function m(e){let t=await (0,c.k)(e);if(!t.ok)return t.res;let i=(0,u.t)();try{let{count:e}=await i.from("clients").select("*",{count:"exact",head:!0}),{count:t}=await i.from("clients").select("*",{count:"exact",head:!0}).or("status.eq.active,status.eq.ativo,is_active.eq.true"),{count:r}=await i.from("invoices").select("*",{count:"exact",head:!0}).is("paid_at",null),{data:a}=await i.from("contracts").select("monthly_value,status,active").limit(2e3),n=(a||[]).filter(e=>"active"===String(e.status||"").toLowerCase()||!0===e.active).reduce((e,t)=>e+Number(t.monthly_value||0),0),s=[];try{let{data:e}=await i.from("ml_predictions_log").select("id,prediction_type,predicted_probability,predicted_at,predicted_for_date,predicted_value").order("predicted_at",{ascending:!1}).limit(400);s=e||[]}catch{s=[]}let c={payment_risk:p(s,"payment_risk"),churn:p(s,"churn"),demand_capacity:p(s,"demand_capacity"),budget_overrun:p(s,"budget_overrun"),revenue:p(s,"revenue"),conversion:p(s,"conversion"),ltv:p(s,"ltv")},u=(e,t,i)=>{if(!e)return null;let r=l(e.predicted_value),a=Math.round(Number(e.predicted_probability||0));return{id:String(e.id),type:String(e.prediction_type||""),label:t,value:r,confidence:a,predicted_at:e.predicted_at||null,href:i}},d=[u(c.payment_risk,"Risco de Pagamento (top)","/admin/financeiro/clientes"),u(c.churn,"Risco de Churn (top)","/admin/analytics/preditivo"),u(c.demand_capacity,"Demanda vs Capacidade","/admin/analytics/preditivo"),u(c.budget_overrun,"Risco de Or\xe7amento (campanha)","/admin/analytics/preditivo"),u(c.revenue,"Forecast Receita","/admin/analytics/preditivo"),u(c.conversion,"Convers\xe3o (propostas/leads)","/admin/analytics/preditivo"),u(c.ltv,"LTV (estimativa)","/admin/analytics/preditivo")].filter(Boolean);return o.NextResponse.json({success:!0,kpis:{totalClients:e||0,activeClients:t||0,pendingInvoices:r||0,mrr:n},highlights:d,links:{analytics:"/admin/analytics/preditivo",intelligence:"/admin/centro-inteligencia",billing:"/admin/financeiro/clientes",machineLearning:"/admin/machine-learning"}})}catch(e){return o.NextResponse.json({success:!1,error:e?.message||"Erro interno"},{status:500})}}let v=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/executive/summary/route",pathname:"/api/admin/executive/summary",filename:"route",bundlePath:"app/api/admin/executive/summary/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\executive\\summary\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:_}=v,f="/api/admin/executive/summary/route";function g(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:h})}},90176:(e,t,i)=>{i.d(t,{t:()=>a});var r=i(54128);function a(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,r.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},17478:(e,t,i)=>{i.d(t,{k:()=>o});var r=i(87070),a=i(20344),n=i(71615),s=i(54128);async function o(e){let t=(0,n.cookies)(),i=(0,a.createRouteHandlerClient)({cookies:()=>t}),o=e.headers.get("authorization")||"",c=o.toLowerCase().startsWith("bearer ")?o.slice(7).trim():null,u=c?(0,s.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${c}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):i,{data:d}=await u.auth.getUser();if(!d.user?.id)return{ok:!1,res:r.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:l,error:p}=await u.rpc("is_admin");return p||!l?{ok:!1,res:r.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:d.user.id}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>i(97169));module.exports=r})();