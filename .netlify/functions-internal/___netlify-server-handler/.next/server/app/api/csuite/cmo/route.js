"use strict";(()=>{var e={};e.id=98222,e.ids=[98222],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},80409:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>I,requestAsyncStorage:()=>y,routeModule:()=>g,serverHooks:()=>_,staticGenerationAsyncStorage:()=>f});var o={};r.r(o),r.d(o,{GET:()=>d,POST:()=>m,dynamic:()=>p});var n=r(49303),a=r(88716),s=r(60670),i=r(87070),u=r(20344),l=r(71615),c=r(29235);let p="force-dynamic";async function d(e){try{let t=(0,l.cookies)(),r=(0,u.createServerComponentClient)({cookies:()=>t}),{data:{user:o}}=await r.auth.getUser();if(!o)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{searchParams:n}=new URL(e.url);switch(n.get("action")||"dashboard"){case"dashboard":let a=await (0,c.qI)();return i.NextResponse.json(a);case"segments":let s=await (0,c.C_)();return i.NextResponse.json(s);case"upsell":let p=await (0,c.K1)();return i.NextResponse.json(p);case"churn":let d=await (0,c.pL)();return i.NextResponse.json(d);default:return i.NextResponse.json({error:"A\xe7\xe3o inv\xe1lida"},{status:400})}}catch(e){return console.error("Erro na API CMO:",e),i.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}async function m(e){try{let t=(0,l.cookies)(),r=(0,u.createServerComponentClient)({cookies:()=>t}),{data:{user:o}}=await r.auth.getUser();if(!o)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let n=await e.json(),{action:a}=n;switch(a){case"chat":let{message:s,context:p}=n;if(!s)return i.NextResponse.json({error:"Mensagem obrigat\xf3ria"},{status:400});let d=await (0,c.ae)(s,p);return i.NextResponse.json({response:d});case"generate-retention-campaign":let m=await (0,c.pL)(),g=await (0,c.Mb)(m);return i.NextResponse.json(g);case"update-opportunity-status":let{opportunityId:y,status:f}=n;if(!y||!f)return i.NextResponse.json({error:"Dados incompletos"},{status:400});return await r.from("upsell_opportunities").update({status:f}).eq("id",y),i.NextResponse.json({success:!0});default:return i.NextResponse.json({error:"A\xe7\xe3o inv\xe1lida"},{status:400})}}catch(e){return console.error("Erro na API CMO:",e),i.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}let g=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/csuite/cmo/route",pathname:"/api/csuite/cmo",filename:"route",bundlePath:"app/api/csuite/cmo/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\csuite\\cmo\\route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:y,staticGenerationAsyncStorage:f,serverHooks:_}=g,h="/api/csuite/cmo/route";function I(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:f})}},90176:(e,t,r)=>{r.d(t,{t:()=>n});var o=r(54128);function n(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,o.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},51547:(e,t,r)=>{r.d(t,{F:()=>E,getProviderStatus:()=>x});var o=r(90176);function n(e){let t=e.match(/\{[\s\S]*\}|\[[\s\S]*\]/);if(!t)throw Error("Resposta n\xe3o cont\xe9m JSON");return JSON.parse(t[0])}function a(e){if(!e)return null;try{return JSON.parse(e)}catch{return null}}function s(e){return e?Array.isArray(e)?e.map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?[e.trim()].filter(Boolean):[]:[]}async function i(e){try{let t=(0,o.t)();await t.from("audit_logs").insert({user_id:e.userId||null,action:e.action,entity_type:e.entityType||"ai",entity_id:e.entityId||null,old_values:null,new_values:e.newValues,ip_address:null,user_agent:null,created_at:new Date().toISOString()})}catch{}}let u=null;async function l(){if(u&&Date.now()-u.fetchedAt<6e4)return{apiKey:u.apiKey,config:u.config};let e=null,t=null;try{let r=(0,o.t)(),{data:n}=await r.from("integration_configs").select("api_key, config").eq("integration_id","openrouter").single();e=n?.api_key||null,t=n?.config||null}catch{}return e=e||process.env.OPENROUTER_API_KEY||null,u={fetchedAt:Date.now(),apiKey:e,config:t},{apiKey:e,config:t}}function c(e){return e?"string"==typeof e?a(e):"object"==typeof e?e:null:null}async function p(e="general"){let t=process.env.OPENROUTER_MODEL;if(t)return[t].filter(Boolean);let{config:r}=await l(),o=r?.model?String(r.model).trim():"";if(o)return[o];let n=a(process.env.OPENROUTER_MODEL_POLICY_JSON),i=c(r?.model_policy)||c(r?.modelPolicy)||n||{default:["openrouter/auto"],general:["openrouter/auto"],analysis:["anthropic/claude-3.5-sonnet","openrouter/auto"],strategy:["anthropic/claude-3.5-sonnet","openrouter/auto"],kanban_insights:["anthropic/claude-3.5-sonnet","openrouter/auto"],kanban_message:["openai/gpt-4o","openrouter/auto"],copywriting:["openai/gpt-4o","openrouter/auto"],sales:["openai/gpt-4o","openrouter/auto"],sentiment:["google/gemini-1.5-pro","openrouter/auto"],classification:["google/gemini-1.5-pro","openrouter/auto"],hr:["anthropic/claude-3.5-sonnet","openrouter/auto"]},u=[...s(i[e]),...s(i.default),"openrouter/auto"],p=new Set,d=[];for(let e of u){let t=String(e).trim();!t||p.has(t)||(p.add(t),d.push(t))}return d.length?d:["openrouter/auto"]}async function d(){try{let e=(0,o.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","anthropic").single();if(t?.api_key)return t.api_key}catch{}return process.env.ANTHROPIC_API_KEY||null}async function m(){try{let e=(0,o.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","openai").single();if(t?.api_key)return t.api_key}catch{}return process.env.OPENAI_API_KEY||null}async function g(){try{let e=(0,o.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","gemini").single();if(t?.api_key)return t.api_key}catch{}return process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY||null}async function y(e,t,r){let o=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json","HTTP-Referer":process.env.NEXT_PUBLIC_APP_URL||"http://localhost","X-Title":"Valle 360"},body:JSON.stringify({model:t,messages:e.messages,temperature:e.temperature??.7,max_tokens:e.maxTokens??1024,response_format:e.json?{type:"json_object"}:void 0})}),n=await o.text();if(!o.ok)throw Error(`OpenRouter error (${o.status}): ${n.slice(0,500)}`);let a=JSON.parse(n),s=a?.choices?.[0]?.message?.content||"";return{provider:"openrouter",model:a?.model||t,text:s,usage:a?.usage}}async function f(e){let{apiKey:t}=await l();if(!t)throw Error("OPENROUTER_API_KEY n\xe3o configurada");let r=await p(e.task),o=Date.now(),a=[];for(let u of r)try{let a=await y(e,u,t);return await i({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:a.provider,model:a.model,ok:!0,ms:Date.now()-o,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json,openrouter_models_tried:r}}),e.json&&(a.json=n(a.text)),a}catch(t){var s;let e=t?.message||String(t);if(a.push({model:u,error:e}),!(!(s=function(e){let t=e.match(/OpenRouter error \\((\\d+)\\):/);if(!t?.[1])return null;let r=Number(t[1]);return Number.isFinite(r)?r:null}(e))||401!==s&&403!==s&&(429===s||408===s||s>=500&&s<=599||400===s&&/model|not found|no such|invalid/i.test(e))))break}let u=a.map(e=>`${e.model}: ${e.error}`).join(" | ");throw Error(`OpenRouter falhou em ${a.length} tentativa(s). ${u}`)}async function _(e){let t=await d();if(!t)throw Error("ANTHROPIC_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.ANTHROPIC_MODEL||"claude-3-5-sonnet-20241022"}(e.task),o=Date.now(),a=e.messages.find(e=>"system"===e.role)?.content,s=e.messages.filter(e=>"system"!==e.role).map(e=>`${e.role.toUpperCase()}: ${e.content}`).join("\n\n"),u=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":t,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:r,max_tokens:e.maxTokens??1024,temperature:e.temperature??.7,system:e.json?`${a||""}

Responda APENAS com um JSON v\xe1lido, sem texto extra.`:a,messages:[{role:"user",content:s}]})}),l=await u.text();if(!u.ok)throw Error(`Claude error (${u.status}): ${l.slice(0,500)}`);let c=JSON.parse(l),p=c?.content?.[0]?.text||"",m={provider:"claude",model:r,text:p,usage:c?.usage};return await i({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:m.provider,model:m.model,ok:!0,ms:Date.now()-o,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(m.json=n(p)),m}async function h(e){let t=await m();if(!t)throw Error("OPENAI_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.OPENAI_MODEL||"gpt-4o-mini"}(e.task),o=Date.now(),a=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:r,messages:e.messages,temperature:e.temperature??.7,max_tokens:e.maxTokens??1024,response_format:e.json?{type:"json_object"}:void 0})}),s=await a.text();if(!a.ok)throw Error(`OpenAI error (${a.status}): ${s.slice(0,500)}`);let u=JSON.parse(s),l=u?.choices?.[0]?.message?.content||"",c={provider:"openai",model:u?.model||r,text:l,usage:u?.usage};return await i({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:c.provider,model:c.model,ok:!0,ms:Date.now()-o,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(c.json=n(l)),c}async function I(e){let t=await g();if(!t)throw Error("GOOGLE_GEMINI_API_KEY/GOOGLE_CLOUD_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.GEMINI_MODEL||"gemini-1.5-flash"}(e.task),o=Date.now(),a=e.messages.find(e=>"system"===e.role)?.content,s=e.messages.filter(e=>"system"!==e.role).map(e=>`${e.role.toUpperCase()}: ${e.content}`).join("\n\n"),u=e.json?`${a||""}

Responda APENAS com um JSON v\xe1lido, sem texto extra.

${s}`:`${a||""}

${s}`,l=`https://generativelanguage.googleapis.com/v1beta/models/${r}:generateContent?key=${encodeURIComponent(t)}`,c=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:u}]}],generationConfig:{temperature:e.temperature??.7,maxOutputTokens:e.maxTokens??1024}})}),p=await c.text();if(!c.ok)throw Error(`Gemini error (${c.status}): ${p.slice(0,500)}`);let d=JSON.parse(p),m=d?.candidates?.[0]?.content?.parts?.map(e=>e.text).join("")||"",y={provider:"gemini",model:r,text:m,usage:d?.usageMetadata};return await i({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:y.provider,model:y.model,ok:!0,ms:Date.now()-o,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(y.json=n(m)),y}function x(){return{openrouter:!!process.env.OPENROUTER_API_KEY,claude:!!process.env.ANTHROPIC_API_KEY,openai:!!process.env.OPENAI_API_KEY,gemini:!!(process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY)}}async function E(e){let t=e.correlationId||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),r={...e,correlationId:t},o=[];for(let e of[{provider:"openrouter",fn:f},{provider:"claude",fn:_},{provider:"openai",fn:h},{provider:"gemini",fn:I}])try{return await e.fn(r)}catch(a){let n=a?.message||String(a);o.push({provider:e.provider,error:n}),await i({userId:r.actorUserId||null,action:"ai.request_failed",entityType:r.entityType||"ai",entityId:r.entityId||null,newValues:{provider:e.provider,ok:!1,error:n.slice(0,500),task:r.task||"general",correlation_id:t,json:!!r.json}})}let n=o.map(e=>`${e.provider}: ${e.error}`).join(" | ");throw Error(`Falha em todos os provedores. ${n}`)}},1926:(e,t,r)=>{r.d(t,{O:()=>s});var o=r(54128);let n="https://ikjgsqtykkhqimypacro.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI";n&&a||console.error("âŒ ERRO CR\xcdTICO: Vari\xe1veis de ambiente NEXT_PUBLIC_SUPABASE_URL ou NEXT_PUBLIC_SUPABASE_ANON_KEY n\xe3o encontradas!");let s=(0,o.eI)(n||"https://setup-missing.supabase.co",a||"setup-missing",{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[89276,55972,54128,20958,29235],()=>r(80409));module.exports=o})();