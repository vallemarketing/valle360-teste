"use strict";(()=>{var e={};e.id=55840,e.ids=[55840],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},77712:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>h,requestAsyncStorage:()=>x,routeModule:()=>m,serverHooks:()=>j,staticGenerationAsyncStorage:()=>f});var o={};r.r(o),r.d(o,{DELETE:()=>g,GET:()=>u,PATCH:()=>p,POST:()=>d});var s=r(49303),a=r(88716),n=r(60670),i=r(87070),c=r(20344),l=r(71615);async function u(e){let t=(0,c.createRouteHandlerClient)({cookies:l.cookies}),{data:{user:r},error:o}=await t.auth.getUser();if(o||!r)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{searchParams:s}=new URL(e.url),a=s.get("search")||"",n=s.get("category"),u=s.get("tags")?.split(",").filter(Boolean),d=parseInt(s.get("page")||"1"),p=parseInt(s.get("limit")||"20");try{let{data:e}=await t.from("clients").select("id").eq("user_id",r.id).single();if(!e)return i.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});let o=t.from("client_contacts").select("*",{count:"exact"}).eq("client_id",e.id).order("created_at",{ascending:!1});a&&(o=o.or(`name.ilike.%${a}%,email.ilike.%${a}%,instagram_handle.ilike.%${a}%`)),n&&(o=o.eq("category",n)),u&&u.length>0&&(o=o.overlaps("tags",u));let s=(d-1)*p;o=o.range(s,s+p-1);let{data:c,count:l,error:g}=await o;if(g)throw g;let{data:m}=await t.from("client_contact_tags").select("*").eq("client_id",e.id),{data:x}=await t.from("client_contacts").select("category").eq("client_id",e.id),f=x?.reduce((e,t)=>(e[t.category||"outros"]=(e[t.category||"outros"]||0)+1,e),{})||{};return i.NextResponse.json({success:!0,contacts:c||[],pagination:{page:d,limit:p,total:l||0,totalPages:Math.ceil((l||0)/p)},tags:m||[],stats:f})}catch(e){return console.error("Erro ao buscar contatos:",e),i.NextResponse.json({error:e.message},{status:500})}}async function d(e){let t=(0,c.createRouteHandlerClient)({cookies:l.cookies}),{data:{user:r},error:o}=await t.auth.getUser();if(o||!r)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});try{let{name:o,email:s,phone:a,instagram_handle:n,tags:c,category:l,notes:u}=await e.json(),{data:d}=await t.from("clients").select("id").eq("user_id",r.id).single();if(!d)return i.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});if(s||n){let e=t.from("client_contacts").select("id").eq("client_id",d.id);s&&(e=e.or(`email.eq.${s}`)),n&&(e=e.or(`instagram_handle.eq.${n}`));let{data:r}=await e.limit(1);if(r&&r.length>0)return i.NextResponse.json({error:"Contato j\xe1 existe com este email ou Instagram"},{status:409})}let{data:p,error:g}=await t.from("client_contacts").insert({client_id:d.id,name:o,email:s,phone:a,instagram_handle:n,tags:c||[],category:l||"lead",notes:u,source:"manual"}).select().single();if(g)throw g;return i.NextResponse.json({success:!0,contact:p})}catch(e){return console.error("Erro ao criar contato:",e),i.NextResponse.json({error:e.message},{status:500})}}async function p(e){let t=(0,c.createRouteHandlerClient)({cookies:l.cookies}),{data:{user:r},error:o}=await t.auth.getUser();if(o||!r)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});try{let{id:o,...s}=await e.json();if(!o)return i.NextResponse.json({error:"ID \xe9 obrigat\xf3rio"},{status:400});let{data:a}=await t.from("clients").select("id").eq("user_id",r.id).single();if(!a)return i.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});let{data:n,error:c}=await t.from("client_contacts").update(s).eq("id",o).eq("client_id",a.id).select().single();if(c)throw c;return i.NextResponse.json({success:!0,contact:n})}catch(e){return console.error("Erro ao atualizar contato:",e),i.NextResponse.json({error:e.message},{status:500})}}async function g(e){let t=(0,c.createRouteHandlerClient)({cookies:l.cookies}),{data:{user:r},error:o}=await t.auth.getUser();if(o||!r)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{searchParams:s}=new URL(e.url),a=s.get("id");if(!a)return i.NextResponse.json({error:"ID \xe9 obrigat\xf3rio"},{status:400});try{let{data:e}=await t.from("clients").select("id").eq("user_id",r.id).single();if(!e)return i.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});let{error:o}=await t.from("client_contacts").delete().eq("id",a).eq("client_id",e.id);if(o)throw o;return i.NextResponse.json({success:!0})}catch(e){return console.error("Erro ao remover contato:",e),i.NextResponse.json({error:e.message},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/client/contacts/route",pathname:"/api/client/contacts",filename:"route",bundlePath:"app/api/client/contacts/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\contacts\\route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:x,staticGenerationAsyncStorage:f,serverHooks:j}=m,R="/api/client/contacts/route";function h(){return(0,n.patchFetch)({serverHooks:j,staticGenerationAsyncStorage:f})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[89276,55972,54128,20958],()=>r(77712));module.exports=o})();