"use strict";(()=>{var e={};e.id=84370,e.ids=[84370],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},12746:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>x,patchFetch:()=>R,requestAsyncStorage:()=>y,routeModule:()=>k,serverHooks:()=>S,staticGenerationAsyncStorage:()=>b});var r={};a.r(r),a.d(r,{GET:()=>g,POST:()=>f,dynamic:()=>p});var s=a(49303),n=a(88716),i=a(60670),o=a(87070),c=a(71615),u=a(20344),d=a(54128),l=a(57157),m=a(14399);let p="force-dynamic";function _(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;return e&&t?(0,d.eI)(e,t,{auth:{persistSession:!1}}):null}async function f(e){let t;let a=(0,c.cookies)(),r=(0,u.createRouteHandlerClient)({cookies:()=>a}),{data:s,error:n}=await r.auth.getUser(),i=s?.user;if(n||!i)return o.NextResponse.json({success:!1,error:"N\xe3o autorizado"},{status:401});let d=_();if(!d)return o.NextResponse.json({success:!1,error:"SUPABASE_SERVICE_ROLE_KEY n\xe3o configurada no servidor"},{status:500});try{t=await e.json()}catch{return o.NextResponse.json({success:!1,error:"Body inv\xe1lido (JSON)"},{status:400})}let p=String(t?.title||"").trim(),f=String(t?.description||"").trim(),g=String(t?.observations||"").trim(),k=String(t?.serviceType||"").trim(),y=t?.dueDate?String(t.dueDate):null,b=t?.priority||"normal";if(!p)return o.NextResponse.json({success:!1,error:"T\xedtulo \xe9 obrigat\xf3rio"},{status:400});if(!k)return o.NextResponse.json({success:!1,error:"Tipo de servi\xe7o \xe9 obrigat\xf3rio"},{status:400});let{data:S,error:x}=await r.from("user_profiles").select("user_type, full_name, email").eq("user_id",i.id).maybeSingle();if(x)return o.NextResponse.json({success:!1,error:"Falha ao validar usu\xe1rio"},{status:500});let{data:R}=await r.rpc("is_admin");if(!R&&S?.user_type!=="client")return o.NextResponse.json({success:!1,error:"Acesso negado"},{status:403});let{data:w}=await d.from("clients").select("id, company_name, name, email").eq("user_id",i.id).maybeSingle(),h=w?.id||null;if(!h&&!R)return o.NextResponse.json({success:!1,error:"Cliente n\xe3o vinculado. Crie/associe um registro em `clients` para este usu\xe1rio."},{status:400});let j=(0,l.X6)(k),v=(0,l.en)(j).label,{data:E,error:q}=await d.from("kanban_boards").select("id, name, area_key").eq("area_key",j).maybeSingle();if(q||!E)return o.NextResponse.json({success:!1,error:"Board da \xe1rea n\xe3o encontrado"},{status:500});let{data:N,error:A}=await d.from("kanban_columns").select("id, stage_key").eq("board_id",E.id).eq("stage_key","demanda").maybeSingle();if(A||!N)return o.NextResponse.json({success:!1,error:'Coluna "Demanda" n\xe3o encontrada no board de destino'},{status:500});let C=function(e){switch(e){case"urgent":return"urgent";case"high":return"high";case"low":return"low";default:return"medium"}}(b),{data:U}=await d.from("kanban_tasks").select("position").eq("board_id",E.id).eq("column_id",N.id).order("position",{ascending:!1}).limit(1).maybeSingle(),P=Number(U?.position||0)+1,O=new Date().toISOString(),I=[f,g?`

Observa\xe7\xf5es do cliente:
${g}`:""].join("").trim(),B={source:"client_request",service_type:k,client_user_id:i.id,client_profile:{name:S?.full_name||null,email:S?.email||null},client:{id:h,company_name:w?.company_name||w?.name||null,email:w?.email||null},created_at:O},{data:L,error:D}=await d.from("kanban_tasks").insert({board_id:E.id,column_id:N.id,title:p,description:I||null,priority:C,status:"todo",tags:Array.from(new Set(["cliente",k])),due_date:y||null,client_id:h,area:j,reference_links:B,assigned_to:null,created_by:i.id,position:P,updated_at:O}).select("id, board_id, column_id, title").single();if(D||!L)return o.NextResponse.json({success:!1,error:D?.message||"Falha ao criar tarefa"},{status:500});try{await (0,m.Q)({area:v,title:"Nova solicita\xe7\xe3o do cliente",message:`Nova demanda: ${p}`,link:"/app/kanban",type:"client_request",metadata:{task_id:L.id,area_key:j,service_type:k}})}catch{}return o.NextResponse.json({success:!0,message:"Solicita\xe7\xe3o criada com sucesso",task:L,target:{area_key:j,board_id:E.id,column_id:N.id}})}async function g(e){let t=(0,c.cookies)(),a=(0,u.createRouteHandlerClient)({cookies:()=>t}),{data:r,error:s}=await a.auth.getUser(),n=r?.user;if(s||!n)return o.NextResponse.json({success:!1,error:"N\xe3o autorizado"},{status:401});let i=_();if(!i)return o.NextResponse.json({success:!1,error:"SUPABASE_SERVICE_ROLE_KEY n\xe3o configurada no servidor"},{status:500});let{searchParams:d}=new URL(e.url),l=d.get("mine"),{data:m}=await a.rpc("is_admin");if("1"===l&&!m){let{data:e}=await i.from("clients").select("id").eq("user_id",n.id).maybeSingle();if(!e?.id)return o.NextResponse.json({success:!0,tasks:[]});let{data:t}=await i.from("kanban_tasks").select(`
          id, title, description, due_date, created_at, updated_at, status, priority, tags, reference_links,
          board:kanban_boards ( id, area_key ),
          column:kanban_columns ( id, stage_key, sla_hours )
        `).eq("client_id",e.id).contains("reference_links",{source:"client_request"}).order("created_at",{ascending:!1});return o.NextResponse.json({success:!0,tasks:t||[]})}if(!m)return o.NextResponse.json({success:!1,error:"Acesso negado"},{status:403});let{data:p}=await i.from("kanban_tasks").select("id, title, client_id, board_id, column_id, created_at, reference_links").contains("reference_links",{source:"client_request"}).order("created_at",{ascending:!1}).limit(50);return o.NextResponse.json({success:!0,tasks:p||[]})}let k=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/kanban/card/route",pathname:"/api/kanban/card",filename:"route",bundlePath:"app/api/kanban/card/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\kanban\\card\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:y,staticGenerationAsyncStorage:b,serverHooks:S}=k,x="/api/kanban/card/route";function R(){return(0,i.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:b})}},14399:(e,t,a)=>{a.d(t,{Q:()=>n});var r=a(90176);function s(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}async function n(e){let t=(0,r.t)(),{data:a}=await t.from("employees").select("user_id, department, areas, is_active").eq("is_active",!0),n=(a||[]).filter(t=>t?.user_id&&function(e,t){let a=s(e),r=t.department?s(t.department):"",n=Array.isArray(t.areas)?t.areas.map(s):[];if(!a)return!1;if(r===a||n.includes(a)||r.includes(a)||a.includes(r)||n.some(e=>e.includes(a)||a.includes(e)))return!0;let i={operacao:["operacao","operacional","ops"],financeiro:["financeiro","finance","cobranca","cobran\xe7a"],comercial:["comercial","vendas","sales"],juridico:["juridico","juridico/compliance","compliance"],contratos:["contratos","contract"],notificacoes:["notificacoes","notificacoes-e-alertas","notificacoes/alertas"],rh:["rh","people","pessoas"]}[a]||[];return!!(i.length>0&&(i.some(e=>r.includes(e))||i.some(e=>n.some(t=>t.includes(e)))))}(e.area,t)).map(e=>String(e.user_id));if(0===n.length){let a={user_id:null,title:e.title,message:e.message,type:e.type||"workflow",is_read:!1,link:e.link??"/admin/fluxos",metadata:{...e.metadata||{},area:e.area,audience:"area"},created_at:new Date().toISOString()};try{await t.from("notifications").insert(a)}catch{}return}let i=n.map(t=>({user_id:t,title:e.title,message:e.message,type:e.type||"workflow",is_read:!1,link:e.link??"/colaborador/notificacoes",metadata:{...e.metadata||{},area:e.area,audience:"area"},created_at:new Date().toISOString()}));try{await t.from("notifications").insert(i)}catch{}}},90176:(e,t,a)=>{a.d(t,{t:()=>s});var r=a(54128);function s(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,r.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958,57157],()=>a(12746));module.exports=r})();