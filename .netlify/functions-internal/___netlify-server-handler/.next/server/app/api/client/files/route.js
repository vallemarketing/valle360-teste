"use strict";(()=>{var e={};e.id=99140,e.ids=[99140],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},35929:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>_,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m});var i={};r.r(i),r.d(i,{GET:()=>c,POST:()=>u});var s=r(49303),a=r(88716),n=r(60670),o=r(87070),l=r(20344),d=r(71615);async function c(e){try{let t=(0,l.createRouteHandlerClient)({cookies:d.cookies}),{data:{user:r}}=await t.auth.getUser();if(!r)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{data:i}=await t.from("user_profiles").select("client_id").eq("user_id",r.id).single();if(!i?.client_id)return o.NextResponse.json({error:"Client not found"},{status:404});let s=e.nextUrl.searchParams,a=s.get("folder")||"";s.get("type");let n=`clients/${i.client_id}`,c=a?`${n}/${a}`:n,{data:u,error:p}=await t.storage.from("client-files").list(c,{limit:100,sortBy:{column:"created_at",order:"desc"}});if(p){if(console.error("Error listing files:",p),p.message?.includes("not found"))return o.NextResponse.json({files:[],folders:[]});return o.NextResponse.json({error:"Failed to list files"},{status:500})}let f=u?.filter(e=>null===e.id)||[],m=u?.filter(e=>null!==e.id)||[],g=await Promise.all(m.map(async e=>{let{data:r}=await t.storage.from("client-files").createSignedUrl(`${c}/${e.name}`,3600);return{id:e.id,name:e.name,size:e.metadata?.size||0,mimeType:e.metadata?.mimetype||"application/octet-stream",createdAt:e.created_at,url:r?.signedUrl}})),{data:x}=await t.from("client_files").select("*").eq("client_id",i.client_id).order("created_at",{ascending:!1});return o.NextResponse.json({files:g,folders:f.map(e=>({name:e.name})),dbFiles:x||[],currentPath:c})}catch(e){return console.error("Error in client files API:",e),o.NextResponse.json({error:e.message||"Internal server error"},{status:500})}}async function u(e){try{let t=(0,l.createRouteHandlerClient)({cookies:d.cookies}),{data:{user:r}}=await t.auth.getUser();if(!r)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{data:i}=await t.from("user_profiles").select("client_id").eq("user_id",r.id).single();if(!i?.client_id)return o.NextResponse.json({error:"Client not found"},{status:404});let s=await e.formData(),a=s.get("file"),n=s.get("folder")||"uploads",c=s.get("description")||"";if(!a)return o.NextResponse.json({error:"No file provided"},{status:400});let u=`${Date.now()}-${a.name.replace(/[^a-zA-Z0-9.-]/g,"_")}`,p=`clients/${i.client_id}/${n}/${u}`,f=await a.arrayBuffer(),m=Buffer.from(f),{error:g}=await t.storage.from("client-files").upload(p,m,{contentType:a.type,upsert:!1});if(g)return console.error("Upload error:",g),o.NextResponse.json({error:"Failed to upload file"},{status:500});let{data:x}=await t.storage.from("client-files").createSignedUrl(p,3600),{data:_,error:y}=await t.from("client_files").insert({client_id:i.client_id,file_name:a.name,file_path:p,file_size:a.size,mime_type:a.type,folder:n,description:c,uploaded_by:r.id,created_at:new Date().toISOString()}).select().single();return y&&console.error("DB error:",y),o.NextResponse.json({success:!0,file:{id:_?.id,name:a.name,path:p,url:x?.signedUrl,size:a.size,mimeType:a.type}})}catch(e){return console.error("Error uploading file:",e),o.NextResponse.json({error:e.message||"Failed to upload file"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/client/files/route",pathname:"/api/client/files",filename:"route",bundlePath:"app/api/client/files/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\files\\route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:g}=p,x="/api/client/files/route";function _(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[89276,55972,54128,20958],()=>r(35929));module.exports=i})();