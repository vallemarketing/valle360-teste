"use strict";(()=>{var e={};e.id=87571,e.ids=[87571],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},77460:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>b,patchFetch:()=>A,requestAsyncStorage:()=>x,routeModule:()=>h,serverHooks:()=>w,staticGenerationAsyncStorage:()=>k});var r={};a.r(r),a.d(r,{GET:()=>f,POST:()=>y,dynamic:()=>p});var s=a(49303),o=a(88716),n=a(60670),i=a(87070),l=a(20344),c=a(71615),d=a(87008),u=a(52955);let p="force-dynamic";async function m(e){let{data:t,error:a}=await e.from("integration_configs").select("status, access_token, config").eq("integration_id","instagramback").maybeSingle();if(a)throw a;if(!t||"connected"!==t.status)throw Error("InstagramBack n\xe3o est\xe1 conectado");let r=String(t?.config?.baseUrl||"").trim(),s=String(t?.access_token||"").trim();if(!r)throw Error("InstagramBack: baseUrl n\xe3o configurado");if(!s)throw Error("InstagramBack: access_token n\xe3o configurado");return{baseUrl:r,accessToken:s}}function g(e){return e?Array.isArray(e)?e.map(String).filter(Boolean):"string"==typeof e?e.split(",").map(e=>e.trim()).filter(Boolean):[]:[]}function _(e){let t=String(e?.post_type||e?.type||e?.mediaType||"").toLowerCase();return t.includes("carousel")?"carousel":t.includes("video")?"video":"image"}async function f(e){try{let e=(0,c.cookies)(),t=(0,l.createRouteHandlerClient)({cookies:()=>e}),a=await (0,u.U)({supabase:t});if(!a.allowed)return i.NextResponse.json({error:a.reason||"Acesso negado"},{status:403});let{baseUrl:r,accessToken:s}=await m(t),o=(0,d.s)({baseUrl:r,accessToken:s}),n=await o.listPosts();try{let e=Array.isArray(n?.data)?n.data:Array.isArray(n)?n:[];if(e.length){let r=e.map(e=>({external_id:String(e?.id||e?._id||e?.external_id||""),post_type:_(e),caption:e?.caption??e?.legenda??null,collaborators:e?.collaborators??e?.colaboradores??null,status:e?.status??null,scheduled_at:e?.scheduled_at??e?.scheduledAt??null,media_urls:g(e?.media_urls??e?.mediaUrls??e?.carrossel??e?.urlimagem??e?.urlvideo),created_by:a.userId,raw_payload:e})).filter(e=>e.external_id);r.length&&await t.from("instagram_posts").upsert(r,{onConflict:"external_id"})}}catch{}return i.NextResponse.json({success:!0,posts:n})}catch(e){return i.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}async function y(e){try{let t=(0,c.cookies)(),a=(0,l.createRouteHandlerClient)({cookies:()=>t}),r=await (0,u.U)({supabase:a});if(!r.allowed)return i.NextResponse.json({error:r.reason||"Acesso negado"},{status:403});let s=await e.json(),{baseUrl:o,accessToken:n}=await m(a),p=(0,d.s)({baseUrl:o,accessToken:n}),f=await p.createPost(s);try{let e=f?.data??f,t=String(e?.id||e?._id||s?.id||""),o=s?.client_id?String(s.client_id):null,n=Array.isArray(s?.platforms)?s.platforms.map(String):[],i=s?.channels||[],l=!!s?.is_draft,c=String(s?.approval_status||"approved"),d=!!s?.boost_requested;await a.from("instagram_posts").upsert({external_id:t||null,client_id:o,post_type:_({...s,...e}),caption:e?.caption??s?.caption??s?.legenda??null,collaborators:e?.collaborators??s?.collaborators??s?.colaboradores??null,status:e?.status??s?.status??null,scheduled_at:e?.scheduled_at??e?.scheduledAt??s?.scheduled_at??s?.scheduledAt??null,media_urls:g(e?.media_urls??e?.mediaUrls??s?.media_urls??s?.mediaUrls??s?.carrossel??s?.urlimagem??s?.urlvideo),created_by:r.userId,raw_payload:e,platforms:n,channels:i,backend:"instagramback",is_draft:l,approval_status:c,boost_requested:d},{onConflict:"external_id"})}catch{}return i.NextResponse.json({success:!0,created:f})}catch(e){return i.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/social/instagramback/posts/route",pathname:"/api/social/instagramback/posts",filename:"route",bundlePath:"app/api/social/instagramback/posts/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\social\\instagramback\\posts\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:x,staticGenerationAsyncStorage:k,serverHooks:w}=h,b="/api/social/instagramback/posts/route";function A(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:k})}},87008:(e,t,a)=>{async function r(e,t,a={}){let r=function(e,t){let a=String(e||"").trim().replace(/\/+$/,""),r=t.startsWith("/")?t:`/${t}`;return a.endsWith("/api")?`${a}${r}`:`${a}/api${r}`}(e.baseUrl,t),s=await fetch(r,{...a,headers:{Authorization:`Bearer ${e.accessToken}`,"Content-Type":"application/json",...a.headers||{}},cache:"no-store"}),o=await s.text();if(!s.ok)throw Error(o||`Falha na requisi\xe7\xe3o (${s.status})`);try{return o?JSON.parse(o):null}catch{return o}}function s(e){return{me:()=>r(e,"/auth/me"),listPosts:()=>r(e,"/posts"),createPost:t=>r(e,"/posts",{method:"POST",body:JSON.stringify(t)}),updatePost:(t,a)=>r(e,`/posts/${encodeURIComponent(t)}`,{method:"PUT",body:JSON.stringify(a)}),deletePost:t=>r(e,`/posts/${encodeURIComponent(t)}`,{method:"DELETE"})}}a.d(t,{s:()=>s})},52955:(e,t,a)=>{a.d(t,{U:()=>n});var r=a(57157);async function s(e,t,a){try{let{data:r,error:s}=await e.rpc(t,a);if(s)return{ok:!1,error:s};return{ok:!0,data:r}}catch(e){return{ok:!1,error:e}}}function o(e){return Array.from(new Set(e))}async function n(e){let t=e.supabase,{data:a}=await t.auth.getUser(),n=a.user?.id;if(!n)return{userId:"",isSuperAdmin:!1,isAdmin:!1,allowed:!1,reason:"N\xe3o autenticado",areaKeys:[]};let i=await s(t,"is_admin"),l=!!i.ok&&!!i.data,c=await s(t,"is_super_admin"),d=!!c.ok&&!!c.data;if(l||d)return{userId:n,isSuperAdmin:d,isAdmin:l,allowed:!0,areaKeys:[]};let u=await s(t,"employee_area_keys");if(u.ok&&Array.isArray(u.data)){let e=(u.data||[]).map(e=>String(e)),t=e.includes("social_media")||e.includes("head_marketing");return{userId:n,isSuperAdmin:d,isAdmin:l,allowed:t,reason:t?void 0:"Acesso restrito: necess\xe1rio Social Media ou Head Marketing",areaKeys:o(e)}}let{data:p}=await t.from("employees").select("department, area_of_expertise, areas, is_active").eq("user_id",n).maybeSingle(),m=[];p?.department&&m.push(String(p.department)),p?.area_of_expertise&&m.push(String(p.area_of_expertise)),Array.isArray(p?.areas)&&m.push(...p.areas.map(e=>String(e)));let g=o(m.map(e=>(0,r.IY)(e)).filter(Boolean).map(e=>e)),_=g.includes("social_media")||g.includes("head_marketing");return{userId:n,isSuperAdmin:d,isAdmin:l,allowed:_,reason:_?void 0:"Acesso restrito: necess\xe1rio Social Media ou Head Marketing",areaKeys:g}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958,57157],()=>a(77460));module.exports=r})();