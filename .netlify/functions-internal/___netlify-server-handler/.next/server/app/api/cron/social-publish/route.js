"use strict";(()=>{var e={};e.id=71796,e.ids=[71796],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},43259:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>S,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>_,serverHooks:()=>w,staticGenerationAsyncStorage:()=>y});var s={};a.r(s),a.d(s,{GET:()=>h,POST:()=>g,dynamic:()=>p});var r=a(49303),o=a(88716),i=a(60670),n=a(87070),c=a(90176),u=a(63032),l=a(87881),d=a(17478);let p="force-dynamic";async function m(e){let t=Date.now(),a=(0,c.t)(),s=new Date().toISOString(),{data:r,error:o}=await a.from("instagram_posts").select("*").eq("backend","meta").eq("status","scheduled").eq("is_draft",!1).eq("approval_status","approved").lte("scheduled_at",s).order("scheduled_at",{ascending:!0}).limit(25);if(o)return await (0,l.m)({supabase:a,action:"social-publish",status:"error",durationMs:Date.now()-t,errorMessage:o.message}),n.NextResponse.json({success:!1,error:o.message},{status:500});if(!r||0===r.length)return await (0,l.m)({supabase:a,action:"social-publish",status:"ok",durationMs:Date.now()-t,responseData:{processed:0,published:0,failed:0}}),n.NextResponse.json({success:!0,processed:0,published:0,failed:0});let i=0,d=0;for(let e of r){await a.from("instagram_posts").update({status:"publishing"}).eq("id",e.id);let t=await (0,u.G)({post:e}),s=t.ok?"published":"failed";await a.from("instagram_posts").update({status:s,published_at:t.ok?new Date().toISOString():null,error_message:t.ok?null:t.error||"Falha ao publicar",raw_payload:{...e?.raw_payload,publish_results:t.results}}).eq("id",e.id),t.ok?i++:d++}return await (0,l.m)({supabase:a,action:"social-publish",status:0===d?"ok":"error",durationMs:Date.now()-t,responseData:{processed:r.length,published:i,failed:d},errorMessage:d?"Falhas ao publicar":null}),n.NextResponse.json({success:!0,processed:r.length,published:i,failed:d})}async function h(e){return(0,l.T)(e)||m(e)}async function g(e){let t=await (0,d.k)(e);return t.ok?m(e):t.res}let _=new r.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/cron/social-publish/route",pathname:"/api/cron/social-publish",filename:"route",bundlePath:"app/api/cron/social-publish/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\cron\\social-publish\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:y,serverHooks:w}=_,S="/api/cron/social-publish/route";function b(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:y})}},90176:(e,t,a)=>{a.d(t,{t:()=>r});var s=a(54128);function r(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,s.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},17478:(e,t,a)=>{a.d(t,{k:()=>n});var s=a(87070),r=a(20344),o=a(71615),i=a(54128);async function n(e){let t=(0,o.cookies)(),a=(0,r.createRouteHandlerClient)({cookies:()=>t}),n=e.headers.get("authorization")||"",c=n.toLowerCase().startsWith("bearer ")?n.slice(7).trim():null,u=c?(0,i.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${c}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):a,{data:l}=await u.auth.getUser();if(!l.user?.id)return{ok:!1,res:s.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:d,error:p}=await u.rpc("is_admin");return p||!d?{ok:!1,res:s.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:l.user.id}}},87881:(e,t,a)=>{a.d(t,{T:()=>r,m:()=>o});var s=a(87070);function r(e){let t=String(process.env.CRON_SECRET||"").trim(),a=String(e.headers.get("authorization")||"").trim();return t&&a===`Bearer ${t}`?null:"1"===String(e.headers.get("x-vercel-cron")||"").trim()||String(e.headers.get("user-agent")||"").toLowerCase().includes("vercel-cron")?null:s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}async function o(e){try{await e.supabase.from("integration_logs").insert({integration_id:"cron",action:e.action,status:e.status,request_data:e.requestData??null,response_data:e.responseData??null,error_message:e.errorMessage??null,duration_ms:Math.max(0,Math.floor(e.durationMs||0)),created_at:new Date().toISOString()})}catch{}}},22887:(e,t,a)=>{a.d(t,{F9:()=>r,nt:()=>o});let s="https://graph.facebook.com/v18.0";class r{constructor(e){this.accessToken=e.accessToken,this.adAccountId=e.adAccountId,this.businessAccountId=e.businessAccountId}async request(e,t={}){let a=new URL(`${s}${e}`);a.searchParams.set("access_token",this.accessToken);let r=await fetch(a.toString(),{...t,headers:{"Content-Type":"application/json",...t.headers}}),o=await r.json();if(o.error)throw Error(`Meta API Error: ${o.error.message}`);return o}async verifyToken(){return this.request("/debug_token",{method:"GET"})}async getMe(){return this.request("/me?fields=id,name,email")}async getInstagramAccount(e){return this.request(`/${e}?fields=instagram_business_account{id,username,followers_count,media_count}`)}async getInstagramInsights(e,t=["impressions","reach","profile_views"],a="day"){let s=t.join(",");return this.request(`/${e}/insights?metric=${s}&period=${a}`)}async getInstagramMedia(e,t=25){return this.request(`/${e}/media?fields=id,caption,media_type,media_url,thumbnail_url,timestamp,like_count,comments_count&limit=${t}`)}async createInstagramPost(e,t,a){let s=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify({image_url:t,caption:a})});return this.request(`/${e}/media_publish`,{method:"POST",body:JSON.stringify({creation_id:s.id})})}async createInstagramVideoPost(e,t,a){let s=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify({video_url:t,media_type:"VIDEO",caption:a})});return this.request(`/${e}/media_publish`,{method:"POST",body:JSON.stringify({creation_id:s.id})})}async createInstagramCarouselPost(e,t,a){let s=[];for(let a of t.slice(0,10)){let t=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify("video"===a.type?{video_url:a.url,media_type:"VIDEO",is_carousel_item:!0}:{image_url:a.url,is_carousel_item:!0})});s.push(t.id)}let r=await this.request(`/${e}/media`,{method:"POST",body:JSON.stringify({media_type:"CAROUSEL",caption:a,children:s.join(",")})});return this.request(`/${e}/media_publish`,{method:"POST",body:JSON.stringify({creation_id:r.id})})}async getAdCampaigns(e=["id","name","status","objective"]){if(!this.adAccountId)throw Error("Ad Account ID n\xe3o configurado");let t=e.join(",");return this.request(`/${this.adAccountId}/campaigns?fields=${t}`)}async getCampaignInsights(e,t="last_30d"){return this.request(`/${e}/insights?fields=impressions,clicks,spend,reach,cpc,cpm,ctr,conversions&date_preset=${t}`)}async getAdAccountInsights(e="last_30d"){if(!this.adAccountId)throw Error("Ad Account ID n\xe3o configurado");return this.request(`/${this.adAccountId}/insights?fields=impressions,clicks,spend,reach,actions&date_preset=${e}`)}async getPages(){return this.request("/me/accounts")}async createPagePost(e,t,a,r){let o={message:a};r&&(o.link=r);let i=new URL(`${s}/${e}/feed`);return i.searchParams.set("access_token",t),(await fetch(i.toString(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).json()}async createPagePhotoPost(e,t,a,r){let o=new URL(`${s}/${e}/photos`);o.searchParams.set("access_token",t);let i=new URLSearchParams;return i.set("url",a),r&&i.set("caption",r),i.set("published","true"),(await fetch(o.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i})).json()}async createPageVideoPost(e,t,a,r){let o=new URL(`${s}/${e}/videos`);o.searchParams.set("access_token",t);let i=new URLSearchParams;return i.set("file_url",a),r&&i.set("description",r),(await fetch(o.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i})).json()}async getPageInsights(e,t,a=["page_impressions","page_engaged_users","page_fans"],r="day"){let o=a.join(","),i=new URL(`${s}/${e}/insights`);return i.searchParams.set("access_token",t),i.searchParams.set("metric",o),i.searchParams.set("period",r),(await fetch(i.toString())).json()}}function o(e){return new r(e)}},63032:(e,t,a)=>{a.d(t,{G:()=>o});var s=a(90176),r=a(22887);async function o(e){var t;let a=(0,s.t)(),o=e.post||{},i=String(o.post_type||o.postType||"image"),n=String(o.caption||o.legenda||""),c=Array.isArray(o.media_urls)?o.media_urls.map(String):[],u=Array.isArray(t=o.channels)?t.map(e=>({account_id:String(e?.account_id||e?.accountId||e?.id||""),platform:String(e?.platform||"")})).filter(e=>e.account_id&&e.platform):[],l=e=>/\.(mp4|mov|m4v|webm)(\?|#|$)/i.test(e),d=[],p=!0,m=null;for(let e of u)try{let{data:t,error:s}=await a.from("social_connected_accounts").select("id, platform, external_account_id").eq("id",e.account_id).maybeSingle();if(s||!t)throw Error("Canal n\xe3o encontrado");let{data:o}=await a.from("social_connected_account_secrets").select("access_token, expires_at").eq("account_id",e.account_id).maybeSingle(),u=o?.access_token?String(o.access_token):"";if(!u)throw Error("Token ausente para este canal");if("instagram"===t.platform){let a=String(t.external_account_id),s=(0,r.nt)({accessToken:u});if("video"===i){if(!c[0])throw Error("media_urls[0] ausente");let t=await s.createInstagramVideoPost(a,c[0],n);d.push({platform:"instagram",account_id:e.account_id,ok:!0,result:t})}else if("carousel"===i){let t=c.slice(0,10).map(e=>({type:l(e)?"video":"image",url:e})),r=await s.createInstagramCarouselPost(a,t,n);d.push({platform:"instagram",account_id:e.account_id,ok:!0,result:r})}else{if(!c[0])throw Error("media_urls[0] ausente");let t=await s.createInstagramPost(a,c[0],n);d.push({platform:"instagram",account_id:e.account_id,ok:!0,result:t})}}else if("facebook"===t.platform){let a=String(t.external_account_id),s=(0,r.nt)({accessToken:u});if("video"===i){if(!c[0])throw Error("media_urls[0] ausente");let t=await s.createPageVideoPost(a,u,c[0],n);d.push({platform:"facebook",account_id:e.account_id,ok:!0,result:t})}else if("carousel"===i){if(!c[0])throw Error("media_urls[0] ausente");let t=await s.createPagePhotoPost(a,u,c[0],n);d.push({platform:"facebook",account_id:e.account_id,ok:!0,warning:"Carrossel Facebook: publicado apenas a primeira m\xeddia (suporte completo ser\xe1 adicionado).",result:t})}else if(c[0]){let t=await s.createPagePhotoPost(a,u,c[0],n);d.push({platform:"facebook",account_id:e.account_id,ok:!0,result:t})}else{let t=await s.createPagePost(a,u,n);d.push({platform:"facebook",account_id:e.account_id,ok:!0,result:t})}}else d.push({platform:t.platform,account_id:e.account_id,ok:!1,error:"Plataforma n\xe3o suportada no publish"}),p=!1}catch(a){p=!1;let t=a?.message||"Falha ao publicar";m=m||t,d.push({platform:e.platform,account_id:e.account_id,ok:!1,error:t})}return{ok:p,results:d,error:m}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[89276,55972,54128,20958],()=>a(43259));module.exports=s})();