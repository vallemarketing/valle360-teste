"use strict";(()=>{var e={};e.id=9754,e.ids=[9754],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},83781:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>h,patchFetch:()=>g,requestAsyncStorage:()=>m,routeModule:()=>_,serverHooks:()=>v,staticGenerationAsyncStorage:()=>y});var r={};i.r(r),i.d(r,{GET:()=>u,dynamic:()=>d});var a=i(49303),n=i(88716),s=i(60670),o=i(87070),l=i(90176),c=i(17478);let d="force-dynamic";function p(e){let t=Number(e);return Number.isFinite(t)?t:0}async function u(e){let t=await (0,c.k)(e);if(!t.ok)return t.res;let i=(0,l.t)(),{data:r}=await i.from("client_health_scores").select("client_id, client_name, overall_score, churn_probability, risk_level, last_calculated_at").order("churn_probability",{ascending:!1}).limit(10),{data:a}=await i.from("ml_predictions_log").select("id, prediction_type, prediction_target, target_id, predicted_probability, predicted_at, predicted_value, model_version").order("predicted_at",{ascending:!1}).limit(200),n=a||[],s=n.slice(0,60),d={},u=0;for(let e of s){let t=String(e.prediction_type||"unknown");d[t]=(d[t]||0)+1,p(e.predicted_probability)>=70&&(u+=1)}let _={latest_predictions:n.length,high_confidence_latest:u,types:d,risky_clients:(r||[]).length};return o.NextResponse.json({success:!0,summary:_,riskyClients:(r||[]).map(e=>({client_id:e.client_id,client_name:e.client_name,overall_score:p(e.overall_score),churn_probability:p(e.churn_probability),risk_level:e.risk_level,last_calculated_at:e.last_calculated_at})),predictions:n.map(e=>({id:e.id,type:e.prediction_type,target:e.prediction_target,target_id:e.target_id,probability:p(e.predicted_probability),predicted_at:e.predicted_at,model_version:e.model_version,predicted_value:e.predicted_value,value:function(e){if(e&&"object"==typeof e){let t=e.value,i=Number(t);return Number.isFinite(i)?i:t??null}let t=Number(e);return Number.isFinite(t)?t:e??null}(e.predicted_value),entity_name:e?.predicted_value&&"object"==typeof e.predicted_value?e.predicted_value.entity_name:null}))})}let _=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/analytics/preditivo/route",pathname:"/api/admin/analytics/preditivo",filename:"route",bundlePath:"app/api/admin/analytics/preditivo/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\analytics\\preditivo\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:y,serverHooks:v}=_,h="/api/admin/analytics/preditivo/route";function g(){return(0,s.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:y})}},90176:(e,t,i)=>{i.d(t,{t:()=>a});var r=i(54128);function a(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,r.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},17478:(e,t,i)=>{i.d(t,{k:()=>o});var r=i(87070),a=i(20344),n=i(71615),s=i(54128);async function o(e){let t=(0,n.cookies)(),i=(0,a.createRouteHandlerClient)({cookies:()=>t}),o=e.headers.get("authorization")||"",l=o.toLowerCase().startsWith("bearer ")?o.slice(7).trim():null,c=l?(0,s.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${l}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):i,{data:d}=await c.auth.getUser();if(!d.user?.id)return{ok:!1,res:r.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:p,error:u}=await c.rpc("is_admin");return u||!p?{ok:!1,res:r.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:d.user.id}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>i(83781));module.exports=r})();