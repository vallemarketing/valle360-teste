"use strict";(()=>{var e={};e.id=67680,e.ids=[67680],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},56265:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>f,patchFetch:()=>v,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>_,staticGenerationAsyncStorage:()=>h});var r={};a.r(r),a.d(r,{GET:()=>p,dynamic:()=>d});var s=a(49303),i=a(88716),o=a(60670),n=a(87070),l=a(17478),c=a(90176);let d="force-dynamic";function u(e){let t=String(e||"").toLowerCase();return t.includes("does not exist")||t.includes("relation")||t.includes("schema cache")||t.includes("could not find the table")}async function p(e){let t=await (0,l.k)(e);if(!t.ok)return t.res;let a=(0,c.t)(),r=new Date,s={employees_active:0,requests_pending:0,requests_approved_this_month:0,goals_active:0,goals_avg_progress:0,goals_at_risk:0,open_jobs:0},i=[];try{let e=await a.from("employees").select("id",{count:"exact",head:!0}).eq("is_active",!0);if(e.error){let e=await a.from("employees").select("id",{count:"exact",head:!0});if(e.error)throw e.error;s.employees_active=e.count||0}else s.employees_active=e.count||0}catch(e){if(!u(e?.message||""))throw e}try{let{data:e,error:t}=await a.from("collaborator_goals").select("collaborator_id, overall_progress, period_start, period_end, status").eq("status","active").limit(5e3);if(t)throw t;let i=Array.isArray(e)?e:[];if(s.goals_active=i.length,i.length){let e=i.reduce((e,t)=>e+Number(t?.overall_progress||0),0)/i.length;s.goals_avg_progress=Math.round(e);let t=i.filter(e=>{let t=e?.period_start?new Date(String(e.period_start)):null,a=e?.period_end?new Date(String(e.period_end)):null;if(!t||!a||isNaN(t.getTime())||isNaN(a.getTime()))return!1;let s=Math.max(1,(a.getTime()-t.getTime())/864e5),i=Math.min(s,Math.max(0,(r.getTime()-t.getTime())/864e5));return Number(e?.overall_progress||0)-i/s*100<-20}).length;s.goals_at_risk=t}}catch(e){if(!u(e?.message||""))throw e}try{let{data:e,error:t}=await a.from("kanban_tasks").select("id, created_at, reference_links").contains("reference_links",{source:"employee_request"}).order("created_at",{ascending:!1}).limit(1500);if(t)throw t;let i=new Date(`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}-01T00:00:00.000Z`),o=Array.isArray(e)?e:[],n=0,l=0;for(let e of o){let t=e?.reference_links||{},a=t?.request||{},r=String(a?.status||"").toLowerCase();"pending"===r&&(n+=1);let s=e?.created_at?new Date(String(e.created_at)):null;s&&!isNaN(s.getTime())&&s>=i&&"approved"===r&&(l+=1)}s.requests_pending=n,s.requests_approved_this_month=l}catch(e){if(!u(e?.message||""))throw e}try{let{count:e,error:t}=await a.from("job_openings").select("id",{count:"exact",head:!0}).eq("status","active");if(t)throw t;s.open_jobs=e||0}catch(e){if(!u(e?.message||""))throw e;s.open_jobs=0}s.requests_pending>0?i.push({severity:s.requests_pending>=10?"critical":"warning",title:"Solicita\xe7\xf5es pendentes",message:`Voc\xea tem ${s.requests_pending} solicita\xe7\xf5es de colaboradores pendentes (RH/Opera\xe7\xe3o).`,href:"/admin/solicitacoes"}):i.push({severity:"success",title:"Solicita\xe7\xf5es em dia",message:"Nenhuma solicita\xe7\xe3o pendente no momento.",href:"/admin/solicitacoes"}),s.goals_active>0?i.push({severity:s.goals_at_risk>0?"warning":"info",title:"Metas e progresso",message:`Progresso m\xe9dio das metas ativas: ${s.goals_avg_progress}%. Em risco: ${s.goals_at_risk}.`,href:"/admin/metas"}):i.push({severity:"info",title:"Metas ainda n\xe3o geradas",message:"Nenhuma meta ativa encontrada. Gere metas para come\xe7ar a acompanhar performance.",href:"/admin/metas"}),s.open_jobs>0&&i.push({severity:"info",title:"Vagas abertas",message:`Existem ${s.open_jobs} vagas ativas no momento.`,href:"/admin/rh/vagas"});let o=0===s.employees_active&&0===s.goals_active&&0===s.requests_pending&&0===s.requests_approved_this_month&&0===s.open_jobs?"Sem dados suficientes ainda (ou schema n\xe3o aplicado).":null;return n.NextResponse.json({success:!0,as_of:r.toISOString(),as_of_date:function(e){let t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${r}`}(r),totals:s,insights:i,note:o})}let m=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/rh/intelligence/summary/route",pathname:"/api/admin/rh/intelligence/summary",filename:"route",bundlePath:"app/api/admin/rh/intelligence/summary/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\rh\\intelligence\\summary\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:_}=m,f="/api/admin/rh/intelligence/summary/route";function v(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:h})}},90176:(e,t,a)=>{a.d(t,{t:()=>s});var r=a(54128);function s(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,r.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},17478:(e,t,a)=>{a.d(t,{k:()=>n});var r=a(87070),s=a(20344),i=a(71615),o=a(54128);async function n(e){let t=(0,i.cookies)(),a=(0,s.createRouteHandlerClient)({cookies:()=>t}),n=e.headers.get("authorization")||"",l=n.toLowerCase().startsWith("bearer ")?n.slice(7).trim():null,c=l?(0,o.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${l}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):a,{data:d}=await c.auth.getUser();if(!d.user?.id)return{ok:!1,res:r.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:u,error:p}=await c.rpc("is_admin");return p||!u?{ok:!1,res:r.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:d.user.id}}}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>a(56265));module.exports=r})();