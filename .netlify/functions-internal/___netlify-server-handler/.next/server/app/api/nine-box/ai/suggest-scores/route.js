"use strict";(()=>{var e={};e.id=66335,e.ids=[66335],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},76321:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>_,serverHooks:()=>h,staticGenerationAsyncStorage:()=>x});var n={};r.r(n),r.d(n,{POST:()=>g,dynamic:()=>m});var o=r(49303),a=r(88716),i=r(60670),s=r(87070),l=r(20344),u=r(71615),c=r(96263),p=r(52390),d=r(51547);let m="force-dynamic",y=c.Ryn({cycle_id:c.Z_8().uuid().optional(),assessment_id:c.Z_8().uuid().optional(),employee_id:c.Z_8().uuid(),extra_context:c.Z_8().optional().nullable()});async function g(e){try{let t=(0,u.cookies)(),r=(0,l.createRouteHandlerClient)({cookies:()=>t}),n=await (0,p.V)({supabase:r});if(!n.allowed)return s.NextResponse.json({error:n.reason||"Acesso negado"},{status:403});let o=y.parse(await e.json()),{data:a}=await r.from("employees").select("id, full_name, email, department, position, performance_score, manager_id, metadata").eq("id",o.employee_id).maybeSingle(),i=r.from("nine_box_criteria").select("id, axis, key, label, description, weight, cycle_id, is_active").eq("is_active",!0);i=o.cycle_id?i.or(`cycle_id.eq.${o.cycle_id},cycle_id.is.null`):i.is("cycle_id",null);let{data:c,error:m}=await i.order("axis",{ascending:!0}).order("weight",{ascending:!1}).limit(200);if(m)throw m;let g=`Voc\xea \xe9 um especialista de RH e avalia\xe7\xe3o de talentos.
Sua tarefa \xe9 sugerir notas (1 a 5) para crit\xe9rios do 9 Box (Desempenho/Potencial), como um copiloto.

Regras:
- Sugira uma nota por crit\xe9rio (inteiro 1..5).
- Retorne tamb\xe9m confidence (0..1), reason (curto) e evidences (lista curta).
- Se n\xe3o houver evid\xeancia suficiente, mantenha confidence baixa e explique.
- N\xc3O invente fatos.`,_={employee:a,criteria:c,extra_context:o.extra_context||"",scale:{min:1,max:5}},f=await (0,d.F)({task:"hr",json:!0,temperature:.2,maxTokens:1400,actorUserId:n.userId,entityType:"nine_box_ai_suggest_scores",entityId:o.assessment_id||null,messages:[{role:"system",content:g},{role:"user",content:`Retorne JSON no formato:
{
 "suggestions":[{"criterion_id":"uuid","axis":"performance|potential","key":"...","score":1,"confidence":0.0,"reason":"...","evidences":["..."]}],
 "notes":"observa\xe7\xf5es gerais"
}

Dados:
${JSON.stringify(_)}`}]});if(o.assessment_id&&f.json)try{let{data:e}=await r.from("nine_box_assessments").select("ai_payload").eq("id",o.assessment_id).maybeSingle(),t=e?.ai_payload||{};await r.from("nine_box_assessments").update({ai_payload:{...t,suggest_scores:f.json}}).eq("id",o.assessment_id)}catch{}return s.NextResponse.json({success:!0,output:f.json||null,raw:f.text})}catch(e){if(e?.name==="ZodError")return s.NextResponse.json({error:"Payload inv\xe1lido",details:e.errors},{status:400});return s.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let _=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/nine-box/ai/suggest-scores/route",pathname:"/api/nine-box/ai/suggest-scores",filename:"route",bundlePath:"app/api/nine-box/ai/suggest-scores/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\nine-box\\ai\\suggest-scores\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:x,serverHooks:h}=_,w="/api/nine-box/ai/suggest-scores/route";function v(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:x})}},90176:(e,t,r)=>{r.d(t,{t:()=>o});var n=r(54128);function o(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,n.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},51547:(e,t,r)=>{r.d(t,{F:()=>v,getProviderStatus:()=>w});var n=r(90176);function o(e){let t=e.match(/\{[\s\S]*\}|\[[\s\S]*\]/);if(!t)throw Error("Resposta n\xe3o cont\xe9m JSON");return JSON.parse(t[0])}function a(e){if(!e)return null;try{return JSON.parse(e)}catch{return null}}function i(e){return e?Array.isArray(e)?e.map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?[e.trim()].filter(Boolean):[]:[]}async function s(e){try{let t=(0,n.t)();await t.from("audit_logs").insert({user_id:e.userId||null,action:e.action,entity_type:e.entityType||"ai",entity_id:e.entityId||null,old_values:null,new_values:e.newValues,ip_address:null,user_agent:null,created_at:new Date().toISOString()})}catch{}}let l=null;async function u(){if(l&&Date.now()-l.fetchedAt<6e4)return{apiKey:l.apiKey,config:l.config};let e=null,t=null;try{let r=(0,n.t)(),{data:o}=await r.from("integration_configs").select("api_key, config").eq("integration_id","openrouter").single();e=o?.api_key||null,t=o?.config||null}catch{}return e=e||process.env.OPENROUTER_API_KEY||null,l={fetchedAt:Date.now(),apiKey:e,config:t},{apiKey:e,config:t}}function c(e){return e?"string"==typeof e?a(e):"object"==typeof e?e:null:null}async function p(e="general"){let t=process.env.OPENROUTER_MODEL;if(t)return[t].filter(Boolean);let{config:r}=await u(),n=r?.model?String(r.model).trim():"";if(n)return[n];let o=a(process.env.OPENROUTER_MODEL_POLICY_JSON),s=c(r?.model_policy)||c(r?.modelPolicy)||o||{default:["openrouter/auto"],general:["openrouter/auto"],analysis:["anthropic/claude-3.5-sonnet","openrouter/auto"],strategy:["anthropic/claude-3.5-sonnet","openrouter/auto"],kanban_insights:["anthropic/claude-3.5-sonnet","openrouter/auto"],kanban_message:["openai/gpt-4o","openrouter/auto"],copywriting:["openai/gpt-4o","openrouter/auto"],sales:["openai/gpt-4o","openrouter/auto"],sentiment:["google/gemini-1.5-pro","openrouter/auto"],classification:["google/gemini-1.5-pro","openrouter/auto"],hr:["anthropic/claude-3.5-sonnet","openrouter/auto"]},l=[...i(s[e]),...i(s.default),"openrouter/auto"],p=new Set,d=[];for(let e of l){let t=String(e).trim();!t||p.has(t)||(p.add(t),d.push(t))}return d.length?d:["openrouter/auto"]}async function d(){try{let e=(0,n.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","anthropic").single();if(t?.api_key)return t.api_key}catch{}return process.env.ANTHROPIC_API_KEY||null}async function m(){try{let e=(0,n.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","openai").single();if(t?.api_key)return t.api_key}catch{}return process.env.OPENAI_API_KEY||null}async function y(){try{let e=(0,n.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","gemini").single();if(t?.api_key)return t.api_key}catch{}return process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY||null}async function g(e,t,r){let n=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json","HTTP-Referer":process.env.NEXT_PUBLIC_APP_URL||"http://localhost","X-Title":"Valle 360"},body:JSON.stringify({model:t,messages:e.messages,temperature:e.temperature??.7,max_tokens:e.maxTokens??1024,response_format:e.json?{type:"json_object"}:void 0})}),o=await n.text();if(!n.ok)throw Error(`OpenRouter error (${n.status}): ${o.slice(0,500)}`);let a=JSON.parse(o),i=a?.choices?.[0]?.message?.content||"";return{provider:"openrouter",model:a?.model||t,text:i,usage:a?.usage}}async function _(e){let{apiKey:t}=await u();if(!t)throw Error("OPENROUTER_API_KEY n\xe3o configurada");let r=await p(e.task),n=Date.now(),a=[];for(let l of r)try{let a=await g(e,l,t);return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:a.provider,model:a.model,ok:!0,ms:Date.now()-n,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json,openrouter_models_tried:r}}),e.json&&(a.json=o(a.text)),a}catch(t){var i;let e=t?.message||String(t);if(a.push({model:l,error:e}),!(!(i=function(e){let t=e.match(/OpenRouter error \\((\\d+)\\):/);if(!t?.[1])return null;let r=Number(t[1]);return Number.isFinite(r)?r:null}(e))||401!==i&&403!==i&&(429===i||408===i||i>=500&&i<=599||400===i&&/model|not found|no such|invalid/i.test(e))))break}let l=a.map(e=>`${e.model}: ${e.error}`).join(" | ");throw Error(`OpenRouter falhou em ${a.length} tentativa(s). ${l}`)}async function f(e){let t=await d();if(!t)throw Error("ANTHROPIC_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.ANTHROPIC_MODEL||"claude-3-5-sonnet-20241022"}(e.task),n=Date.now(),a=e.messages.find(e=>"system"===e.role)?.content,i=e.messages.filter(e=>"system"!==e.role).map(e=>`${e.role.toUpperCase()}: ${e.content}`).join("\n\n"),l=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":t,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:r,max_tokens:e.maxTokens??1024,temperature:e.temperature??.7,system:e.json?`${a||""}

Responda APENAS com um JSON v\xe1lido, sem texto extra.`:a,messages:[{role:"user",content:i}]})}),u=await l.text();if(!l.ok)throw Error(`Claude error (${l.status}): ${u.slice(0,500)}`);let c=JSON.parse(u),p=c?.content?.[0]?.text||"",m={provider:"claude",model:r,text:p,usage:c?.usage};return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:m.provider,model:m.model,ok:!0,ms:Date.now()-n,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(m.json=o(p)),m}async function x(e){let t=await m();if(!t)throw Error("OPENAI_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.OPENAI_MODEL||"gpt-4o-mini"}(e.task),n=Date.now(),a=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:r,messages:e.messages,temperature:e.temperature??.7,max_tokens:e.maxTokens??1024,response_format:e.json?{type:"json_object"}:void 0})}),i=await a.text();if(!a.ok)throw Error(`OpenAI error (${a.status}): ${i.slice(0,500)}`);let l=JSON.parse(i),u=l?.choices?.[0]?.message?.content||"",c={provider:"openai",model:l?.model||r,text:u,usage:l?.usage};return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:c.provider,model:c.model,ok:!0,ms:Date.now()-n,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(c.json=o(u)),c}async function h(e){let t=await y();if(!t)throw Error("GOOGLE_GEMINI_API_KEY/GOOGLE_CLOUD_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.GEMINI_MODEL||"gemini-1.5-flash"}(e.task),n=Date.now(),a=e.messages.find(e=>"system"===e.role)?.content,i=e.messages.filter(e=>"system"!==e.role).map(e=>`${e.role.toUpperCase()}: ${e.content}`).join("\n\n"),l=e.json?`${a||""}

Responda APENAS com um JSON v\xe1lido, sem texto extra.

${i}`:`${a||""}

${i}`,u=`https://generativelanguage.googleapis.com/v1beta/models/${r}:generateContent?key=${encodeURIComponent(t)}`,c=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:l}]}],generationConfig:{temperature:e.temperature??.7,maxOutputTokens:e.maxTokens??1024}})}),p=await c.text();if(!c.ok)throw Error(`Gemini error (${c.status}): ${p.slice(0,500)}`);let d=JSON.parse(p),m=d?.candidates?.[0]?.content?.parts?.map(e=>e.text).join("")||"",g={provider:"gemini",model:r,text:m,usage:d?.usageMetadata};return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:g.provider,model:g.model,ok:!0,ms:Date.now()-n,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(g.json=o(m)),g}function w(){return{openrouter:!!process.env.OPENROUTER_API_KEY,claude:!!process.env.ANTHROPIC_API_KEY,openai:!!process.env.OPENAI_API_KEY,gemini:!!(process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY)}}async function v(e){let t=e.correlationId||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),r={...e,correlationId:t},n=[];for(let e of[{provider:"openrouter",fn:_},{provider:"claude",fn:f},{provider:"openai",fn:x},{provider:"gemini",fn:h}])try{return await e.fn(r)}catch(a){let o=a?.message||String(a);n.push({provider:e.provider,error:o}),await s({userId:r.actorUserId||null,action:"ai.request_failed",entityType:r.entityType||"ai",entityId:r.entityId||null,newValues:{provider:e.provider,ok:!1,error:o.slice(0,500),task:r.task||"general",correlation_id:t,json:!!r.json}})}let o=n.map(e=>`${e.provider}: ${e.error}`).join(" | ");throw Error(`Falha em todos os provedores. ${o}`)}},52390:(e,t,r)=>{async function n(e,t,r){try{let{data:n,error:o}=await e.rpc(t,r);if(o)return{ok:!1,error:o};return{ok:!0,data:n}}catch(e){return{ok:!1,error:e}}}function o(e){return Array.from(new Set(e.map(e=>String(e)).filter(Boolean)))}async function a(e){let t=e.supabase,{data:r}=await t.auth.getUser(),a=r.user?.id;if(!a)return{userId:"",isAdmin:!1,allowed:!1,reason:"N\xe3o autenticado",areaKeys:[]};let i=await n(t,"is_admin"),s=!!i.ok&&!!i.data;if(s)return{userId:a,isAdmin:s,allowed:!0,areaKeys:[]};let l=await n(t,"employee_area_keys");if(l.ok&&Array.isArray(l.data)){let e=o(l.data),t=e.includes("rh");return{userId:a,isAdmin:s,allowed:t,reason:t?void 0:"Acesso restrito: RH",areaKeys:e}}let{data:u}=await t.from("employees").select("areas, department, is_active").eq("user_id",a).maybeSingle(),c=o([...Array.isArray(u?.areas)?u.areas.map(String):[]]),p=c.includes("rh")||String(u?.department||"").toLowerCase().includes("rh");return{userId:a,isAdmin:s,allowed:p,reason:p?void 0:"Acesso restrito: RH",areaKeys:c}}r.d(t,{V:()=>a})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[89276,55972,54128,20958,96263],()=>r(76321));module.exports=n})();