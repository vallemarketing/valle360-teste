"use strict";(()=>{var e={};e.id=7783,e.ids=[7783],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},75957:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>y,patchFetch:()=>P,requestAsyncStorage:()=>g,routeModule:()=>_,serverHooks:()=>E,staticGenerationAsyncStorage:()=>m});var o={};t.r(o),t.d(o,{GET:()=>l,POST:()=>d,dynamic:()=>u});var a=t(49303),n=t(88716),s=t(60670),i=t(87070),c=t(20344),p=t(71615);let u="force-dynamic";async function l(e){try{let r=(0,p.cookies)(),t=(0,c.createRouteHandlerClient)({cookies:()=>r}),{data:{user:o},error:a}=await t.auth.getUser();if(a||!o)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:n,error:s}=await t.rpc("is_admin");if(s||!n)return i.NextResponse.json({error:"Acesso negado (admin)"},{status:403});let{searchParams:u}=new URL(e.url),l=u.get("id"),d=u.get("category"),h=t.from("integration_configs").select("integration_id, display_name, category, status, last_sync, error_message, config");l&&(h=h.eq("integration_id",l)),d&&(h=h.eq("category",d));let{data:_,error:g}=await h.order("display_name");if(g)return console.error("Erro ao buscar integra\xe7\xf5es:",g),i.NextResponse.json({error:"Erro ao buscar integra\xe7\xf5es"},{status:500});let m={openrouter:!!process.env.OPENROUTER_API_KEY,openai:!!process.env.OPENAI_API_KEY,anthropic:!!process.env.ANTHROPIC_API_KEY,gemini:!!(process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY),perplexity:!!process.env.PERPLEXITY_API_KEY,stripe:!!process.env.STRIPE_SECRET_KEY,sendgrid:!0,whatsapp:!!process.env.WHATSAPP_ACCESS_TOKEN},E=_.map(e=>{let r=!!m[e.integration_id],t="connected"===e.status;return{id:e.integration_id,name:e.display_name,category:e.category,status:e.status,connected:t||r,connectedVia:t?"db":r?"env":"none",lastSync:e.last_sync,error:e.error_message,config:e.config}}),y={total:E.length,connected:E.filter(e=>e.connected).length,disconnected:E.filter(e=>!e.connected).length,error:E.filter(e=>"error"===e.status).length};return i.NextResponse.json({success:!0,integrations:E,stats:y})}catch(e){return console.error("Erro ao buscar status:",e),i.NextResponse.json({error:"Erro interno do servidor",details:e.message},{status:500})}}async function d(e){try{let r=(0,p.cookies)(),t=(0,c.createRouteHandlerClient)({cookies:()=>r}),{data:{user:o},error:a}=await t.auth.getUser();if(a||!o)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:n,error:s}=await t.rpc("is_admin");if(s||!n)return i.NextResponse.json({error:"Acesso negado (admin)"},{status:403});let{integrationId:u}=await e.json();if(!u)return i.NextResponse.json({error:"ID da integra\xe7\xe3o \xe9 obrigat\xf3rio"},{status:400});let{data:l,error:d}=await t.from("integration_configs").select("*").eq("integration_id",u).single(),_=d?null:l,g=!!({openrouter:!!process.env.OPENROUTER_API_KEY,openai:!!process.env.OPENAI_API_KEY,anthropic:!!process.env.ANTHROPIC_API_KEY,gemini:!!(process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY),perplexity:!!process.env.PERPLEXITY_API_KEY,stripe:!!process.env.STRIPE_SECRET_KEY,sendgrid:!0,whatsapp:!!process.env.WHATSAPP_ACCESS_TOKEN})[u],m=_?.status==="connected";if(!m&&!g)return i.NextResponse.json({success:!0,healthy:!1,reason:_?"Integra\xe7\xe3o n\xe3o est\xe1 conectada":"Integra\xe7\xe3o n\xe3o configurada (db/env)"});let E=await h(u,_||{});return E.healthy||_?.status!=="connected"||await t.from("integration_configs").update({status:"error",error_message:E.error}).eq("integration_id",u),_&&await t.from("integration_logs").insert({integration_id:u,action:"health_check",status:E.healthy?"success":"error",error_message:E.error,duration_ms:E.responseTime,response_data:{connectedVia:m?"db":g?"env":"none"}}),i.NextResponse.json({success:!0,...E})}catch(e){return console.error("Erro no health check:",e),i.NextResponse.json({error:"Erro interno do servidor",details:e.message},{status:500})}}async function h(e,r){let t=Date.now();try{switch(e){case"perplexity":{let e=r.api_key||process.env.PERPLEXITY_API_KEY,o=String(r?.config?.model||"sonar").trim()||"sonar";if(!e)return{healthy:!1,error:"API Key n\xe3o configurada (db/env)",responseTime:Date.now()-t};let a=await fetch("https://api.perplexity.ai/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:o,messages:[{role:"user",content:"ping"}],max_tokens:8,temperature:0})}),n=await a.text().catch(()=>"");return{healthy:a.ok,error:a.ok?void 0:n.slice(0,200)||"Falha na autentica\xe7\xe3o",responseTime:Date.now()-t}}case"whatsapp":{let e=String(r?.access_token||process.env.WHATSAPP_ACCESS_TOKEN||"").trim(),o=e.toLowerCase().startsWith("bearer ")?e.slice(7).trim():e,a=String(r?.config?.phoneNumberId||process.env.WHATSAPP_PHONE_NUMBER_ID||"").trim();if(!o)return{healthy:!1,error:"Access Token n\xe3o configurado (db/env)",responseTime:Date.now()-t};if(!a)return{healthy:!1,error:"Phone Number ID n\xe3o configurado (config.phoneNumberId ou WHATSAPP_PHONE_NUMBER_ID)",responseTime:Date.now()-t};let n=`https://graph.facebook.com/v20.0/${encodeURIComponent(a)}?fields=verified_name,display_phone_number`,s=await fetch(n,{headers:{Authorization:`Bearer ${o}`}}),i=await s.text();return{healthy:s.ok,error:s.ok?void 0:i.slice(0,200)||"Falha na autentica\xe7\xe3o/Graph API",responseTime:Date.now()-t}}case"instagramback":{let e=r?.config?.baseUrl,o=r?.access_token,a=String(e||"").trim().replace(/\/+$/,"");if(!a)return{healthy:!1,error:"Base URL n\xe3o configurada (config.baseUrl)",responseTime:Date.now()-t};if(!o)return{healthy:!1,error:"Access Token n\xe3o configurado",responseTime:Date.now()-t};let n=a.endsWith("/api")?`${a}/auth/me`:`${a}/api/auth/me`,s=await fetch(n,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}}),i=await s.text();return{healthy:s.ok,error:s.ok?void 0:i.slice(0,200)||"Falha na autentica\xe7\xe3o",responseTime:Date.now()-t}}case"openrouter":{let e=r.api_key||process.env.OPENROUTER_API_KEY;if(!e)return{healthy:!1,error:"API Key n\xe3o configurada (db/env)"};try{let r=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","HTTP-Referer":process.env.NEXT_PUBLIC_APP_URL||"http://localhost","X-Title":"Valle 360"},body:JSON.stringify({model:"openrouter/auto",messages:[{role:"user",content:"ping"}],max_tokens:8,temperature:0})}),o=await r.text();return{healthy:r.ok,error:r.ok?void 0:o.slice(0,200)||"Falha na autentica\xe7\xe3o",responseTime:Date.now()-t}}catch(e){return{healthy:!1,error:e?.message||"Falha no health check",responseTime:Date.now()-t}}}case"anthropic":return{healthy:!!(r.api_key||process.env.ANTHROPIC_API_KEY),error:r.api_key||process.env.ANTHROPIC_API_KEY?void 0:"API Key n\xe3o configurada (db/env)",responseTime:Date.now()-t};case"gemini":return{healthy:!!(r.api_key||process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY),error:r.api_key||process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY?void 0:"API Key n\xe3o configurada (db/env)",responseTime:Date.now()-t};case"openai":if(!(r.api_key||process.env.OPENAI_API_KEY))return{healthy:!1,error:"API Key n\xe3o configurada (db/env)"};let o=await fetch("https://api.openai.com/v1/models",{headers:{Authorization:`Bearer ${r.api_key||process.env.OPENAI_API_KEY}`}});return{healthy:o.ok,error:o.ok?void 0:"Falha na autentica\xe7\xe3o",responseTime:Date.now()-t};case"stripe":if(!(r.api_key||process.env.STRIPE_SECRET_KEY))return{healthy:!1,error:"Secret Key n\xe3o configurada (db/env)"};let a=await fetch("https://api.stripe.com/v1/balance",{headers:{Authorization:`Bearer ${r.api_key||process.env.STRIPE_SECRET_KEY}`}});return{healthy:a.ok,error:a.ok?void 0:"Falha na autentica\xe7\xe3o",responseTime:Date.now()-t};case"sendgrid":return{healthy:!0,responseTime:Date.now()-t};default:let n=r.api_key||r.access_token;return{healthy:n,error:n?void 0:"Credenciais n\xe3o configuradas",responseTime:Date.now()-t}}}catch(e){return{healthy:!1,error:e.message,responseTime:Date.now()-t}}}let _=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/integrations/status/route",pathname:"/api/integrations/status",filename:"route",bundlePath:"app/api/integrations/status/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\integrations\\status\\route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:E}=_,y="/api/integrations/status/route";function P(){return(0,s.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:m})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[89276,55972,54128,20958],()=>t(75957));module.exports=o})();