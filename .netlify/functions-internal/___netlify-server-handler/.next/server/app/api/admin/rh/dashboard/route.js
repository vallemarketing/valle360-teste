"use strict";(()=>{var e={};e.id=67494,e.ids=[67494],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},32363:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>w,requestAsyncStorage:()=>h,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>_});var a={};r.r(a),r.d(a,{GET:()=>g,dynamic:()=>c});var i=r(49303),n=r(88716),s=r(60670),o=r(87070),l=r(17478),d=r(90176);let c="force-dynamic";function u(e){let t=String(e||"").toLowerCase();return t.includes("does not exist")||t.includes("relation")||t.includes("schema cache")||t.includes("could not find the table")}function m(e,t,r){return Math.max(t,Math.min(r,e))}async function g(e){let t=await (0,l.k)(e);if(!t.ok)return t.res;let r=(0,d.t)(),a=new Date,i=null;try{let{count:e,error:t}=await r.from("job_openings").select("id",{count:"exact",head:!0}).eq("status","active");if(t)throw t;i=e??0}catch(e){if(!u(e?.message||""))throw e;i=null}let n=[];try{let{data:e,error:t}=await r.from("employees").select("id,user_id,full_name,first_name,last_name,areas,photo_url,admission_date,created_at,is_active").order("created_at",{ascending:!1}).limit(800);if(t)throw t;n=e||[]}catch(e){if(!u(e?.message||""))throw e;n=[]}let s=new Map;for(let e of n)e?.user_id&&s.set(String(e.user_id),e);let c=[];try{let{data:e,error:t}=await r.from("collaborator_goals").select("id,collaborator_id,overall_progress,period_start,period_end,status,updated_at,created_at").eq("status","active").order("updated_at",{ascending:!1}).limit(5e3);if(t)throw t;c=e||[]}catch(e){if(!u(e?.message||""))throw e;c=[]}let g=new Map;for(let e of c){let t=String(e?.collaborator_id||"").trim();t&&!g.has(t)&&g.set(t,e)}let p=[];try{let{data:e,error:t}=await r.from("kanban_tasks").select(`
        id, title, created_at, created_by, reference_links,
        column:kanban_columns ( stage_key )
      `).contains("reference_links",{source:"employee_request"}).order("created_at",{ascending:!1}).limit(1500);if(t)throw t;p=e||[]}catch(e){if(!u(e?.message||""))throw e;p=[]}let h=Array.from(new Set(p.map(e=>String(e?.reference_links?.employee_request_id||"").trim()).filter(Boolean))),_=new Map;if(h.length>0)try{let{data:e,error:t}=await r.from("employee_requests").select("id,status").in("id",h);t||(_=new Map((e||[]).map(e=>[String(e.id),String(e.status||"").toLowerCase()])))}catch{}let f=new Map,S=new Date(a.getFullYear(),a.getMonth(),1),w=0,k=0,v=[];for(let e of p){let t=e?.reference_links||{},r=t?.request||{},a=String(e?.column?.stage_key||"").toLowerCase(),i=String(t?.employee_request_id||"").trim(),n=i?_.get(i):null,o=String(n&&String(n).trim()||String(r?.status||"").trim()||(a.includes("final")?"approved":a.includes("bloq")?"rejected":"pending")).toLowerCase();if("pending"===o){w+=1;let t=String(e?.created_by||"").trim();t&&f.set(t,(f.get(t)||0)+1);let a=t?s.get(t):null,i=a?.full_name||`${a?.first_name||""} ${a?.last_name||""}`.trim()||null;v.push({task_id:String(e?.id||""),name:i,type:String(r?.type||""),date:String(r?.start_date||"").slice(0,10)||String(e?.created_at||"").slice(0,10),status:o})}if("approved"===o){let t=e?.created_at?new Date(String(e.created_at)):null;t&&!isNaN(t.getTime())&&t>=S&&(k+=1)}}let x=n.map(e=>{let t=String(e?.id||""),r=String(e?.user_id||""),i=String(e?.full_name||`${e?.first_name||""} ${e?.last_name||""}`.trim()||"Colaborador"),n=e?.areas||[],s=(n||[]).join(", ").trim()||"Colaborador",o=function(e){let t=(e||[]).map(e=>String(e).toLowerCase());return t.some(e=>e.includes("design"))?"Design":t.some(e=>e.includes("social"))||t.some(e=>e.includes("trafego"))||t.some(e=>e.includes("video"))?"Marketing":t.some(e=>e.includes("finance"))?"Financeiro":t.some(e=>e.includes("rh"))?"RH":t.some(e=>e.includes("comercial"))?"Comercial":t.some(e=>e.includes("dev"))||t.some(e=>e.includes("tech"))?"Desenvolvimento":"Geral"}(n),l=e?.admission_date||e?.created_at||null,d=l?new Date(String(l)):new Date,c=String(e?.photo_url||"").trim()||`https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(i)}`,u=t?g.get(t):null,p=m(Math.round(Number(u?.overall_progress||0)),0,100),h=!1;if(u?.period_start&&u?.period_end){let e=new Date(String(u.period_start)),t=new Date(String(u.period_end));!isNaN(e.getTime())&&!isNaN(t.getTime())&&t.getTime()>e.getTime()&&(h=p-function(e,t,r){let a=Math.max(1,(r.getTime()-t.getTime())/864e5);return m((e.getTime()-t.getTime())/864e5,0,a)/a*100}(a,e,t)<-20)}let _=r?Number(f.get(r)||0):0,S=m(100-((h?35:0)+8*_),0,100),w=m(60+Math.round(.3*p)-6*_-(h?10:0),0,100),k=S<55||_>=3||h&&p<55?"high":S<75||_>=1||h?"medium":"low";return{id:t,userId:r,name:i,avatar:c,role:s,department:o,retentionScore:S,engagementScore:w,performanceScore:p,fitCultural:0,discProfile:{D:0,I:0,S:0,C:0},riskLevel:k,joinedAt:d.toISOString(),meta:{hasGoals:!!u,pendingRequests:_,behindSchedule:h}}}),b=n.filter(e=>e?.is_active===!0).length||n.length,y=x.length>0?Math.round(x.reduce((e,t)=>e+Number(t.engagementScore||0),0)/x.length):0,I=x.filter(e=>"high"===e.riskLevel).length,q=0===n.length&&0===c.length&&0===p.length?"Sem dados (ou schema ainda n\xe3o aplicado).":null,C=w>0?{title:"Prioridade do dia",message:`Voc\xea tem ${w} solicita\xe7\xf5es pendentes. ${I?`${I} colaboradores est\xe3o em alto risco.`:""}`.trim()}:{title:"RH em dia",message:I?`${I} colaboradores est\xe3o em alto risco. Revise metas e agende 1:1.`:"Nenhuma solicita\xe7\xe3o pendente no momento."};return o.NextResponse.json({success:!0,as_of:a.toISOString(),as_of_date:function(e){let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${a}`}(a),kpis:{employees_active:b,engagement_avg:y,high_risk:I,requests_pending:w,requests_approved_this_month:k,open_jobs:i},employees:x,pending_requests:v.slice(0,20),insight:C,note:q})}let p=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/rh/dashboard/route",pathname:"/api/admin/rh/dashboard",filename:"route",bundlePath:"app/api/admin/rh/dashboard/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\rh\\dashboard\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:_,serverHooks:f}=p,S="/api/admin/rh/dashboard/route";function w(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:_})}},90176:(e,t,r)=>{r.d(t,{t:()=>i});var a=r(54128);function i(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,a.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},17478:(e,t,r)=>{r.d(t,{k:()=>o});var a=r(87070),i=r(20344),n=r(71615),s=r(54128);async function o(e){let t=(0,n.cookies)(),r=(0,i.createRouteHandlerClient)({cookies:()=>t}),o=e.headers.get("authorization")||"",l=o.toLowerCase().startsWith("bearer ")?o.slice(7).trim():null,d=l?(0,s.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${l}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):r,{data:c}=await d.auth.getUser();if(!c.user?.id)return{ok:!1,res:a.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:u,error:m}=await d.rpc("is_admin");return m||!u?{ok:!1,res:a.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:c.user.id}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958],()=>r(32363));module.exports=a})();