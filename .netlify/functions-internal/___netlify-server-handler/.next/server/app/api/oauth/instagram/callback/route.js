"use strict";(()=>{var e={};e.id=26385,e.ids=[26385],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},89994:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>S,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>k});var a={};r.r(a),r.d(a,{GET:()=>_,dynamic:()=>l});var n=r(49303),o=r(88716),c=r(60670),i=r(87070),s=r(90176);let l="force-dynamic",u=process.env.INSTAGRAM_APP_ID,p=process.env.INSTAGRAM_APP_SECRET,d=process.env.NEXT_PUBLIC_APP_URL;function m(e,t){let r=(d?new URL(d).origin:new URL(e.url).origin).replace(/\/+$/,""),a=new URL("/cliente/redes/callback",r);return a.searchParams.set("platform",t.platform),a.searchParams.set("ok",t.ok?"1":"0"),t.error&&a.searchParams.set("error",t.error.slice(0,180)),a.toString()}async function _(e){try{if(!u||!p)return i.NextResponse.redirect(m(e,{platform:"instagram",ok:!1,error:"Credenciais do app n\xe3o configuradas"}));let{searchParams:t}=new URL(e.url),r=t.get("code"),a=t.get("state"),{clientId:n}=function(e){if(!e)return{clientId:null};try{let t=JSON.parse(e);return{clientId:t?.clientId?String(t.clientId):null}}catch{return{clientId:e}}}(a);if(!r)return i.NextResponse.redirect(m(e,{platform:"instagram",ok:!1,error:"C\xf3digo de autoriza\xe7\xe3o n\xe3o fornecido"}));if(!n)return i.NextResponse.redirect(m(e,{platform:"instagram",ok:!1,error:"client_id ausente no state"}));let o=(d||new URL(e.url).origin).replace(/\/+$/,""),c=`${o}/api/oauth/instagram/callback`,l=await fetch(`https://graph.facebook.com/v18.0/oauth/access_token?client_id=${encodeURIComponent(u)}&redirect_uri=${encodeURIComponent(c)}&client_secret=${encodeURIComponent(p)}&code=${encodeURIComponent(r)}`),_=await l.json();if(_?.error)return i.NextResponse.redirect(m(e,{platform:"instagram",ok:!1,error:_.error.message||"Erro ao obter token"}));let f=await fetch(`https://graph.facebook.com/v18.0/oauth/access_token?grant_type=fb_exchange_token&client_id=${encodeURIComponent(u)}&client_secret=${encodeURIComponent(p)}&fb_exchange_token=${encodeURIComponent(_.access_token)}`),g=await f.json();if(g?.error)return i.NextResponse.redirect(m(e,{platform:"instagram",ok:!1,error:g.error.message||"Erro token longa dura\xe7\xe3o"}));let k=Number(g.expires_in||0),h=k?new Date(Date.now()+1e3*k).toISOString():null,R=await fetch(`https://graph.facebook.com/v18.0/me/accounts?fields=id,name,access_token,picture&access_token=${encodeURIComponent(g.access_token)}`),S=await R.json(),b=(0,s.t)();for(let e of S?.data||[]){let t=String(e.id),r=e?.name?String(e.name):"Facebook Page",a=String(e.access_token||""),o=e?.picture?.data?.url?String(e.picture.data.url):null,{data:c,error:i}=await b.from("social_connected_accounts").upsert({client_id:n,platform:"facebook",external_account_id:t,username:null,display_name:r,profile_picture_url:o,status:"active",metadata:{}},{onConflict:"client_id,platform,external_account_id"}).select("id").single();if(i)throw i;await b.from("social_connected_account_secrets").upsert({account_id:c.id,access_token:a||null,token_type:"bearer",scopes:[],expires_at:h},{onConflict:"account_id"})}for(let e of S?.data||[]){let t=String(e.id),r=String(e.access_token||""),a=await fetch(`https://graph.facebook.com/v18.0/${encodeURIComponent(t)}?fields=instagram_business_account&access_token=${encodeURIComponent(r)}`),o=await a.json(),c=o?.instagram_business_account?.id?String(o.instagram_business_account.id):null;if(!c)continue;let i=await fetch(`https://graph.facebook.com/v18.0/${encodeURIComponent(c)}?fields=username,name,profile_picture_url&access_token=${encodeURIComponent(r)}`),s=await i.json(),l=s?.username?String(s.username):null,u=s?.name?String(s.name):l?`@${l}`:"Instagram",p=s?.profile_picture_url?String(s.profile_picture_url):null,{data:d,error:m}=await b.from("social_connected_accounts").upsert({client_id:n,platform:"instagram",external_account_id:c,username:l,display_name:u,profile_picture_url:p,status:"active",metadata:{page_id:t}},{onConflict:"client_id,platform,external_account_id"}).select("id").single();if(m)throw m;await b.from("social_connected_account_secrets").upsert({account_id:d.id,access_token:r||null,token_type:"bearer",scopes:[],expires_at:h},{onConflict:"account_id"})}return i.NextResponse.redirect(m(e,{platform:"instagram",ok:!0}))}catch(t){return i.NextResponse.redirect(m(e,{platform:"instagram",ok:!1,error:t?.message||"Erro no callback"}))}}let f=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/oauth/instagram/callback/route",pathname:"/api/oauth/instagram/callback",filename:"route",bundlePath:"app/api/oauth/instagram/callback/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\oauth\\instagram\\callback\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:k,serverHooks:h}=f,R="/api/oauth/instagram/callback/route";function S(){return(0,c.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:k})}},90176:(e,t,r)=>{r.d(t,{t:()=>n});var a=r(54128);function n(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,a.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128],()=>r(89994));module.exports=a})();