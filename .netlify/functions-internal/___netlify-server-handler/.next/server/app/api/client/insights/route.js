"use strict";(()=>{var e={};e.id=36291,e.ids=[36291],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},69169:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>E,patchFetch:()=>j,requestAsyncStorage:()=>b,routeModule:()=>v,serverHooks:()=>q,staticGenerationAsyncStorage:()=>A});var s={};r.r(s),r.d(s,{GET:()=>_,POST:()=>S,PUT:()=>R,dynamic:()=>m});var i=r(49303),n=r(88716),a=r(60670),o=r(87070),c=r(20344),l=r(71615),u=r(90176),d=r(90530),p=r(52019);let m="force-dynamic";function g(e=new Date){let t=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Sao_Paulo",year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(e),r=t.find(e=>"year"===e.type)?.value||"1970",s=t.find(e=>"month"===e.type)?.value||"01",i=t.find(e=>"day"===e.type)?.value||"01";return{start:new Date(`${r}-${s}-${i}T00:00:00-03:00`).toISOString(),end:new Date(`${r}-${s}-${i}T23:59:59-03:00`).toISOString()}}function h(e){let t=String(e?.message||"");return"42P01"===String(e?.code||"")||t.toLowerCase().includes("relation")||t.toLowerCase().includes("does not exist")}function y(e){let t=[];for(let r of e||[]){let e=String(r||"").trim();e&&/^https?:\/\//i.test(e)&&!t.includes(e)&&t.push(e)}return t}function f(e){return e?Array.isArray(e)?e.map(e=>String(e).trim()).filter(Boolean).slice(0,10):"string"==typeof e?e.split(/[\n,;]+/g).map(e=>e.trim()).filter(Boolean).slice(0,10):[]:[]}async function w(){let e=(0,l.cookies)(),t=(0,c.createRouteHandlerClient)({cookies:()=>e}),{data:r}=await t.auth.getUser();return r?.user||null}async function x(e){let t=(0,u.t)(),{data:r,error:s}=await t.from("clients").select("id, company_name, industry, segment, competitors, concorrentes").eq("user_id",e).maybeSingle();if(s)throw s;return r}async function _(e){let t=await w();if(!t)return o.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let r=new URL(e.url),s=r.searchParams.get("status"),i="1"===r.searchParams.get("today"),n=(0,u.t)(),a=await x(t.id);if(!a?.id)return o.NextResponse.json({success:!0,insights:[]});let c=n.from("client_ai_insights").select("id, type, priority, status, title, description, impact, action, sources, provider, created_at").eq("client_id",a.id).order("created_at",{ascending:!1}).limit(200);if(s&&(c=c.eq("status",String(s))),i){let{start:e,end:t}=g();c=c.gte("created_at",e).lte("created_at",t)}let{data:l,error:d}=await c;return d?h(d)?o.NextResponse.json({success:!0,insights:[],warning:"missing_table_client_ai_insights",instruction:"A tabela de insights ainda n\xe3o existe neste banco. Rode a migration `supabase/migrations/20260102000004_clients_rls_and_client_ai_insights.sql` no Supabase (SQL editor)."}):o.NextResponse.json({error:d.message},{status:500}):o.NextResponse.json({success:!0,insights:l||[]})}async function S(e){let t=await w();if(!t)return o.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let r=(0,u.t)(),s=await x(t.id);if(!s?.id)return o.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});let{start:i,end:n}=g();try{let e=await r.from("client_ai_insights").select("id",{count:"exact",head:!0}).eq("client_id",s.id).gte("created_at",i).lte("created_at",n);if(e?.error)throw e.error;let t=Number(e.count||0);if(t>0)return o.NextResponse.json({success:!0,skipped:!0,existingCount:t,date:i})}catch(e){}let a=[...f(s?.competitors),...f(s?.concorrentes)],c=function(e){let t=String(e.companyName||"").trim(),r=String(e.industry||"").trim(),s=String(e.segment||"").trim(),i=(e.competitors||[]).map(e=>String(e).trim()).filter(Boolean).slice(0,6);return[`Voc\xea \xe9 um analista de marketing. Gere insights pr\xe1ticos com base em pesquisa web recente (\xfaltimos 30 dias) para o segmento: "${s||r||"marketing digital"}" no Brasil.`,t?`Empresa: ${t}.`:null,i.length?`Concorrentes: ${i.join(", ")}.`:null,"","Responda ESTRITAMENTE em JSON (sem markdown), no formato: uma lista com 5 itens.","Cada item deve ter as chaves:",'- type: "oportunidade" | "melhoria" | "alerta" | "tendencia"','- priority: "alta" | "media" | "baixa"',"- title: string (curto)","- description: string (1-3 frases)",'- impact: string (ex: "+15% CTR", "reduz risco", etc)',"- action: string (a\xe7\xe3o objetiva)","- sources: string[] (URLs)"].filter(Boolean).join("\n")}({companyName:s.company_name,industry:s.industry,segment:s?.segment,competitors:a}),l="perplexity",m="",_=[];try{let e=await (0,d.y)({query:c,timeoutMs:25e3});m=e.answer,_=y(e.sources)}catch(r){l="tavily";let e=String(s?.segment||s.industry||"marketing digital"),t=await p.T.searchNews(`tend\xeancias ${e} Brasil`,8);m=String(t.answer||"").trim(),_=y((t.results||[]).map(e=>e.url))}let S=function(e){let t=String(e||""),r=t.indexOf("["),s=t.lastIndexOf("]");if(r<0||s<0||s<=r)return null;let i=t.slice(r,s+1);try{let e=JSON.parse(i);return Array.isArray(e)?e:null}catch{return null}}(m),R=new Date().toISOString(),v=(S&&S.length?S.slice(0,5):[{type:"tendencia",priority:"media",title:"Resumo do setor (com fontes)",description:m||"Veja fontes recentes do seu setor para identificar oportunidades.",impact:"Melhor decis\xe3o nas pr\xf3ximas 2 semanas",action:"Revisar as fontes e alinhar plano de conte\xfado/campanhas",sources:_}]).map(e=>{let t=Array.isArray(e?.sources)?y(e.sources.map(String)):[],r=y([...t||[],..._||[]]).slice(0,12);return{client_id:s.id,type:function(e){let t=String(e||"").toLowerCase();return t.includes("alert")?"alerta":t.includes("tend")?"tendencia":t.includes("melh")?"melhoria":"oportunidade"}(e?.type),priority:function(e){let t=String(e||"").toLowerCase();return t.startsWith("a")?"alta":t.startsWith("b")?"baixa":"media"}(e?.priority),status:"novo",title:String(e?.title||"Insight").slice(0,180),description:String(e?.description||"").slice(0,4e3),impact:e?.impact?String(e.impact).slice(0,500):null,action:e?.action?String(e.action).slice(0,1e3):null,sources:r,provider:l,raw:{generated_at:R,prompt:c,answer:m,base_sources:_,item:e}}}),{data:b,error:A}=await r.from("client_ai_insights").insert(v).select("id");return A?h(A)?o.NextResponse.json({error:"A tabela de insights ainda n\xe3o existe neste banco. Rode a migration `supabase/migrations/20260102000004_clients_rls_and_client_ai_insights.sql` no Supabase (SQL editor)."},{status:409}):o.NextResponse.json({error:A.message},{status:500}):o.NextResponse.json({success:!0,created:(b||[]).length})}async function R(e){let t=await w();if(!t)return o.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let r=await e.json().catch(()=>({})),s=String(r?.id||""),i=String(r?.status||"");if(!s)return o.NextResponse.json({error:"id \xe9 obrigat\xf3rio"},{status:400});if(!["novo","em_analise","implementado","ignorado"].includes(i))return o.NextResponse.json({error:"status inv\xe1lido"},{status:400});let n=(0,u.t)(),a=await x(t.id);if(!a?.id)return o.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});let{error:c}=await n.from("client_ai_insights").update({status:i,updated_at:new Date().toISOString()}).eq("id",s).eq("client_id",a.id);return c?o.NextResponse.json({error:c.message},{status:500}):o.NextResponse.json({success:!0})}let v=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/client/insights/route",pathname:"/api/client/insights",filename:"route",bundlePath:"app/api/client/insights/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\insights\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:b,staticGenerationAsyncStorage:A,serverHooks:q}=v,E="/api/client/insights/route";function j(){return(0,a.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:A})}},90176:(e,t,r)=>{r.d(t,{t:()=>i});var s=r(54128);function i(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,s.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},90530:(e,t,r)=>{r.d(t,{y:()=>n});var s=r(90176);async function i(){try{let e=(0,s.t)(),{data:t}=await e.from("integration_configs").select("api_key, config, status").eq("integration_id","perplexity").maybeSingle(),r=t?.api_key?String(t.api_key):null,i=String(t?.config?.model||"").trim()||"sonar";if(r)return{apiKey:r,model:i};return{apiKey:process.env.PERPLEXITY_API_KEY||null,model:i}}catch{return{apiKey:process.env.PERPLEXITY_API_KEY||null,model:"sonar"}}}async function n(e){let t=await i(),r=t.apiKey;if(!r)throw Error("PERPLEXITY_API_KEY n\xe3o configurada (db/env)");let s=String(e.model||t.model||"sonar").trim()||"sonar",n=e.timeoutMs??25e3,a=new AbortController,o=setTimeout(()=>a.abort(),n);try{let t=await fetch("https://api.perplexity.ai/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({model:s,temperature:.2,max_tokens:900,messages:[{role:"system",content:"Voc\xea \xe9 um mecanismo de pesquisa web. Responda em portugu\xeas do Brasil, de forma objetiva. Sempre que poss\xedvel, inclua fontes confi\xe1veis (URLs)."},{role:"user",content:e.query}]}),signal:a.signal}),i=await t.text();if(!t.ok)throw Error(`Perplexity error (${t.status}): ${i.slice(0,300)}`);let n=i?JSON.parse(i):{},o=n?.choices?.[0]?.message?.content||n?.choices?.[0]?.text||"",c=n?.citations||n?.choices?.[0]?.citations||n?.choices?.[0]?.message?.citations||n?.references,l=function(e){let t=[],r=e=>{if(e){if("string"==typeof e){let r=e.trim();r&&t.push(r);return}if("object"==typeof e){let r=e.url||e.link||e.href||e.source;"string"==typeof r&&r.trim()&&t.push(r.trim())}}};return Array.isArray(e)?e.forEach(r):r(e),Array.from(new Set(t))}(c);return!l.length&&(l=Array.from(new Set((o.match(/https?:\/\/[^\s)]+/g)||[]).map(e=>e.replace(/[.,;]+$/,""))))),{answer:String(o||"").trim(),sources:l}}finally{clearTimeout(o)}}},52019:(e,t,r)=>{r.d(t,{T:()=>i});class s{constructor(){this.apiKey=process.env.TAVILY_API_KEY||""}async request(e,t){if(!this.apiKey)throw Error("TAVILY_API_KEY n\xe3o configurada");let r=await fetch(`https://api.tavily.com${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:this.apiKey,...t})});if(!r.ok){let e=await r.text();throw Error(`Erro Tavily: ${r.status} - ${e}`)}return r.json()}async search(e){let t=Date.now(),r=await this.request("/search",{query:e.query,search_depth:e.searchDepth||"basic",include_answer:e.includeAnswer??!0,include_raw_content:e.includeRawContent??!1,max_results:e.maxResults||10,include_domains:e.includeDomains,exclude_domains:e.excludeDomains,topic:e.topic||"general"});return{query:e.query,answer:r.answer,results:r.results.map(e=>({title:e.title,url:e.url,content:e.content,rawContent:e.raw_content,score:e.score,publishedDate:e.published_date})),responseTime:Date.now()-t}}async extract(e){return(await this.request("/extract",{urls:e.urls})).results.map(e=>({url:e.url,rawContent:e.raw_content,error:e.error}))}async searchNews(e,t=10){return this.search({query:e,topic:"news",searchDepth:"advanced",maxResults:t,includeAnswer:!0})}async searchCompany(e){return this.search({query:`${e} empresa informa\xe7\xf5es contato site`,searchDepth:"advanced",maxResults:10,includeAnswer:!0})}async searchCompetitors(e,t,r){let s=`principais empresas ${e}`;return t&&(s+=` em ${t}`),r&&(s+=` exceto ${r}`),this.search({query:s,searchDepth:"advanced",maxResults:15,includeAnswer:!0})}async searchTrends(e){return this.search({query:`tend\xeancias ${e} 2024 2025 mercado brasil`,topic:"news",searchDepth:"advanced",maxResults:10,includeAnswer:!0})}async searchSocialMedia(e){return this.search({query:`${e} instagram facebook linkedin twitter site:instagram.com OR site:facebook.com OR site:linkedin.com`,searchDepth:"advanced",maxResults:10,includeDomains:["instagram.com","facebook.com","linkedin.com","twitter.com"]})}async searchReputation(e){return this.search({query:`${e} avalia\xe7\xe3o review reclama\xe7\xe3o opini\xe3o`,searchDepth:"advanced",maxResults:15,includeAnswer:!0,includeDomains:["reclameaqui.com.br","google.com/maps","trustpilot.com"]})}}let i=new s}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[89276,55972,54128,20958],()=>r(69169));module.exports=s})();