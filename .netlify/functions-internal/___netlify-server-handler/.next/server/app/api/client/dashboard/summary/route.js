"use strict";(()=>{var e={};e.id=69825,e.ids=[69825],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},51800:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>b,patchFetch:()=>A,requestAsyncStorage:()=>f,routeModule:()=>v,serverHooks:()=>S,staticGenerationAsyncStorage:()=>y});var s={};a.r(s),a.d(s,{GET:()=>h,dynamic:()=>m});var i=a(49303),n=a(88716),o=a(60670),r=a(87070),c=a(20344),l=a(71615),d=a(90176),u=a(14836);let m="force-dynamic";function g(e){let t=Number(e);return Number.isFinite(t)?t:0}function p(e){let t=String(e?.message||"").toLowerCase();return"42P01"===String(e?.code||"")||t.includes("relation")||t.includes("does not exist")}function _(e,t){return t?Math.round((e-t)/t*100):0}async function h(e){try{let t=(0,l.cookies)(),a=(0,c.createRouteHandlerClient)({cookies:()=>t}),{data:s}=await a.auth.getUser(),i=s?.user;if(!i)return r.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let n=(0,d.t)(),{data:o,error:m}=await n.from("clients").select("id, company_name, industry, segment, competitors, concorrentes").eq("user_id",i.id).maybeSingle();if(m)return r.NextResponse.json({error:m.message},{status:500});let h=o?.id?String(o.id):null;if(!h)return r.NextResponse.json({error:"Cliente n\xe3o vinculado (clients.user_id)"},{status:400});let{searchParams:v}=new URL(e.url),f=Number(v.get("days")||30),y=Math.max(1,Math.min(365,Number.isFinite(f)?Math.floor(f):30)),S=new Date;S.setDate(S.getDate()-(y-1));let b=function(e){let t=new Date(e);return t.setUTCHours(0,0,0,0),t.toISOString().slice(0,10)}(S),A=[],C={totals30:{impressions:0,reach:0,engaged:0,profile_views:0},deltas7:{impressions:0,reach:0,engaged:0,profile_views:0},available:!1};try{let{data:e,error:t}=await n.from("social_account_metrics_daily").select("metric_date, metrics").eq("client_id",h).gte("metric_date",b).order("metric_date",{ascending:!0}).limit(5e3);if(t)throw t;let a={};for(let t of e||[]){let e=String(t.metric_date),s=t.metrics||{};a[e]||={impressions:0,reach:0,engaged:0,profile_views:0},a[e].impressions+=g(s.impressions??s.page_impressions??0),a[e].reach+=g(s.reach??0),a[e].profile_views+=g(s.profile_views??0),a[e].engaged+=g(s.page_engaged_users??0)}let s=Object.keys(a).sort().map(e=>({date:e,...a[e]}));C.available=s.length>0;let i=s.slice(-30);C.totals30={impressions:i.reduce((e,t)=>e+g(t.impressions),0),reach:i.reduce((e,t)=>e+g(t.reach),0),engaged:i.reduce((e,t)=>e+g(t.engaged),0),profile_views:i.reduce((e,t)=>e+g(t.profile_views),0)};let o=s.slice(-14),r=o.slice(0,7),c=o.slice(7),l=(e,t)=>e.reduce((e,a)=>e+g(a[t]),0);C.deltas7={impressions:_(l(c,"impressions"),l(r,"impressions")),reach:_(l(c,"reach"),l(r,"reach")),engaged:_(l(c,"engaged"),l(r,"engaged")),profile_views:_(l(c,"profile_views"),l(r,"profile_views"))}}catch(e){p(e)?A.push("missing_table_social_account_metrics_daily"):A.push("social_metrics_failed")}let w={available:!1,totals:{total_spend:0,total_impressions:0,total_clicks:0,total_conversions:0,avg_roas:0}};try{let e=new Date().toISOString().slice(0,10),t=await u.U.generatePerformanceReport(h,"all",{start:b,end:e}),a=Array.isArray(t)?t:[],s=a.reduce((e,t)=>(e.total_spend+=g(t.total_spend),e.total_impressions+=g(t.total_impressions),e.total_clicks+=g(t.total_clicks),e.total_conversions+=g(t.total_conversions),e.avg_roas+=g(t.avg_roas),e.count+=1,e),{total_spend:0,total_impressions:0,total_clicks:0,total_conversions:0,avg_roas:0,count:0});w.available=a.length>0,w.totals={total_spend:s.total_spend,total_impressions:s.total_impressions,total_clicks:s.total_clicks,total_conversions:s.total_conversions,avg_roas:s.count?s.avg_roas/s.count:0}}catch{}let x={available:!1,total:0,new:0,latestTitles:[]};try{let{start:e,end:t}=function(e=new Date){let t=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Sao_Paulo",year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(e),a=t.find(e=>"year"===e.type)?.value||"1970",s=t.find(e=>"month"===e.type)?.value||"01",i=t.find(e=>"day"===e.type)?.value||"01";return{start:new Date(`${a}-${s}-${i}T00:00:00-03:00`).toISOString(),end:new Date(`${a}-${s}-${i}T23:59:59-03:00`).toISOString()}}(),{data:a,error:s}=await n.from("client_ai_insights").select("id, status, title, created_at").eq("client_id",h).gte("created_at",e).lte("created_at",t).order("created_at",{ascending:!1}).limit(50);if(s)throw s;let i=a||[];x.available=!0,x.total=i.length,x.new=i.filter(e=>"novo"===String(e.status)).length,x.latestTitles=i.slice(0,3).map(e=>String(e.title||"")).filter(Boolean)}catch(e){p(e)&&A.push("missing_table_client_ai_insights")}let R=Array.isArray(o?.competitors)?o.competitors.map(e=>String(e)).filter(Boolean):"string"==typeof o?.concorrentes?String(o.concorrentes).split(/[\n,;]+/g).map(e=>e.trim()).filter(Boolean):[],E={hasOpenInvoice:!1};try{let{data:e,error:t}=await n.from("invoices").select("id, amount, due_date, status").eq("client_id",h).in("status",["pending","overdue"]).order("due_date",{ascending:!0}).limit(1);if(t)throw t;let a=(e||[])[0];a&&(E={hasOpenInvoice:!0,invoice:{id:String(a.id),amount:Number(a.amount)||0,due_date:String(a.due_date),status:String(a.status)}})}catch(e){p(e)&&A.push("missing_table_invoices")}let I={impressions:{value:w.available?w.totals.total_impressions:C.totals30.impressions,change:C.deltas7.impressions},clicks:{value:w.available?w.totals.total_clicks:C.totals30.profile_views,change:w.available?0:C.deltas7.profile_views,label:w.available?"Cliques (ads)":"Visitas ao perfil (social)"},conversions:{value:w.available?w.totals.total_conversions:0,change:0},spend:{value:w.available?w.totals.total_spend:0,change:0},roi:{value:w.available?w.totals.avg_roas:0,change:0}};return r.NextResponse.json({success:!0,client:{id:h,company_name:String(o?.company_name||""),segment:String(o?.segment||""),industry:String(o?.industry||""),competitors_count:R.length},kpis:I,social:C,ads:w,insights:x,billing:E,warnings:A,generatedAt:new Date().toISOString()})}catch(e){return r.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let v=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/client/dashboard/summary/route",pathname:"/api/client/dashboard/summary",filename:"route",bundlePath:"app/api/client/dashboard/summary/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\dashboard\\summary\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:y,serverHooks:S}=v,b="/api/client/dashboard/summary/route";function A(){return(0,o.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:y})}},90176:(e,t,a)=>{a.d(t,{t:()=>i});var s=a(54128);function i(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,s.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},14836:(e,t,a)=>{a.d(t,{U:()=>n});var s=a(1926);class i{setMetaCredentials(e){this.metaAccessToken=e}setGoogleCredentials(e){this.googleCredentials=e}async getMetaAdAccounts(e){return[{id:"act_123456789",name:"Conta Principal",currency:"BRL",timezone:"America/Sao_Paulo",status:"active",spend_cap:5e4,amount_spent:12500,balance:37500}]}async getMetaCampaigns(e){return[{id:"camp_001",account_id:e,name:"Campanha Black Friday",objective:"CONVERSIONS",status:"ACTIVE",daily_budget:500,start_time:"2024-11-20T00:00:00",stop_time:"2024-11-30T23:59:59",created_time:"2024-11-15T10:00:00",insights:{impressions:125e3,clicks:4500,ctr:3.6,spend:3500,cpc:.78,cpm:28,conversions:180,cost_per_conversion:19.44,roas:4.2,reach:85e3,frequency:1.47,date_range:{start:"2024-11-20",end:"2024-11-27"}}},{id:"camp_002",account_id:e,name:"Remarketing - Carrinho Abandonado",objective:"CONVERSIONS",status:"ACTIVE",daily_budget:200,created_time:"2024-10-01T10:00:00",insights:{impressions:45e3,clicks:2200,ctr:4.89,spend:1400,cpc:.64,cpm:31.11,conversions:95,cost_per_conversion:14.74,roas:6.8,reach:12e3,frequency:3.75,date_range:{start:"2024-11-01",end:"2024-11-27"}}}]}async createMetaCampaign(e,t){return console.log(`[META] Criando campanha: ${t.name}`),{id:`camp_${Date.now()}`,account_id:e,name:t.name||"Nova Campanha",objective:t.objective||"CONVERSIONS",status:"PAUSED",daily_budget:t.daily_budget,created_time:new Date().toISOString()}}async updateMetaCampaignStatus(e,t){return console.log(`[META] Atualizando campanha ${e} para ${t}`),!0}async getGoogleAdAccounts(e){return[{id:"123-456-7890",name:"Conta Google Ads Principal",currency:"BRL",timezone:"America/Sao_Paulo",status:"ENABLED",budget:3e4,cost:8500}]}async getGoogleCampaigns(e){return[{id:"gcamp_001",account_id:e,name:"Search - Marca",type:"SEARCH",status:"ENABLED",budget:100,bidding_strategy:"TARGET_CPA",insights:{impressions:35e3,clicks:2800,ctr:8,spend:2100,cpc:.75,cpm:60,conversions:120,cost_per_conversion:17.5,roas:5.5,date_range:{start:"2024-11-01",end:"2024-11-27"}}},{id:"gcamp_002",account_id:e,name:"Performance Max",type:"PERFORMANCE_MAX",status:"ENABLED",budget:150,bidding_strategy:"MAXIMIZE_CONVERSIONS",insights:{impressions:18e4,clicks:5400,ctr:3,spend:4200,cpc:.78,cpm:23.33,conversions:210,cost_per_conversion:20,roas:4.8,date_range:{start:"2024-11-01",end:"2024-11-27"}}}]}async createGoogleCampaign(e,t){return console.log(`[GOOGLE] Criando campanha: ${t.name}`),{id:`gcamp_${Date.now()}`,account_id:e,name:t.name||"Nova Campanha",type:t.type||"SEARCH",status:"PAUSED",budget:t.budget||100,bidding_strategy:t.bidding_strategy||"MANUAL_CPC"}}async generatePerformanceReport(e,t,a){let s=[];if("meta"===t||"all"===t)for(let t of(await this.getMetaAdAccounts(e))){let e=await this.getMetaCampaigns(t.id),i=e.reduce((e,t)=>e+(t.insights?.spend||0),0),n=e.reduce((e,t)=>e+(t.insights?.impressions||0),0),o=e.reduce((e,t)=>e+(t.insights?.clicks||0),0),r=e.reduce((e,t)=>e+(t.insights?.conversions||0),0);s.push({account_id:t.id,account_name:t.name,platform:"meta",period:`${a.start} a ${a.end}`,total_spend:i,total_impressions:n,total_clicks:o,avg_ctr:n>0?o/n*100:0,avg_cpc:o>0?i/o:0,total_conversions:r,avg_roas:this.calculateAvgRoas(e),campaigns:e.map(e=>({id:e.id,name:e.name,spend:e.insights?.spend||0,impressions:e.insights?.impressions||0,clicks:e.insights?.clicks||0,conversions:e.insights?.conversions||0})),recommendations:this.generateRecommendations(e,"meta")})}if("google"===t||"all"===t)for(let t of(await this.getGoogleAdAccounts(e))){let e=await this.getGoogleCampaigns(t.id),i=e.reduce((e,t)=>e+(t.insights?.spend||0),0),n=e.reduce((e,t)=>e+(t.insights?.impressions||0),0),o=e.reduce((e,t)=>e+(t.insights?.clicks||0),0),r=e.reduce((e,t)=>e+(t.insights?.conversions||0),0);s.push({account_id:t.id,account_name:t.name,platform:"google",period:`${a.start} a ${a.end}`,total_spend:i,total_impressions:n,total_clicks:o,avg_ctr:n>0?o/n*100:0,avg_cpc:o>0?i/o:0,total_conversions:r,avg_roas:this.calculateAvgRoas(e),campaigns:e.map(e=>({id:e.id,name:e.name,spend:e.insights?.spend||0,impressions:e.insights?.impressions||0,clicks:e.insights?.clicks||0,conversions:e.insights?.conversions||0})),recommendations:this.generateRecommendations(e,"google")})}return s}async checkBudgetAlerts(e){let t=[];for(let a of(await this.getMetaAdAccounts(e))){let e=a.spend_cap?a.amount_spent/a.spend_cap*100:0;e>=90&&t.push({account_id:a.id,platform:"meta",alert_type:e>=100?"budget_depleted":"budget_low",message:e>=100?`Or\xe7amento da conta ${a.name} esgotado!`:`Or\xe7amento da conta ${a.name} em ${e.toFixed(0)}%`,threshold_value:a.spend_cap||0,current_value:a.amount_spent,created_at:new Date().toISOString(),acknowledged:!1})}for(let a of(await this.getGoogleAdAccounts(e))){let e=a.budget?a.cost/a.budget*100:0;e>=90&&t.push({account_id:a.id,platform:"google",alert_type:e>=100?"budget_depleted":"budget_low",message:e>=100?`Or\xe7amento da conta ${a.name} esgotado!`:`Or\xe7amento da conta ${a.name} em ${e.toFixed(0)}%`,threshold_value:a.budget||0,current_value:a.cost,created_at:new Date().toISOString(),acknowledged:!1})}return t.length>0&&await s.O.from("budget_alerts").insert(t),t}async sendRechargeNotification(e,t,a){try{let{data:i}=await s.O.from("clients").select("*").eq("id",e).single();if(!i)return!1;let n=i.user_id?String(i.user_id):null;return n&&await s.O.from("notifications").insert({user_id:n,type:"budget_recharge",title:"\uD83D\uDCB0 Recarga de Or\xe7amento Necess\xe1ria",message:`O or\xe7amento da sua conta de ${"meta"===a?"Meta Ads":"Google Ads"} est\xe1 baixo. Recarregue para manter suas campanhas ativas.`,link:"/cliente/financeiro",metadata:{client_id:e,account_id:t,platform:a},is_read:!1,created_at:new Date().toISOString()}),console.log(`[NOTIFICA\xc7\xc3O] Recarga enviada para ${i.email}`),!0}catch(e){return console.error("Erro ao enviar notifica\xe7\xe3o:",e),!1}}async analyzeCompetitorAds(e){return{total_ads:Math.floor(50*Math.random())+10,active_ads:Math.floor(20*Math.random())+5,ad_formats:{image:Math.floor(15*Math.random())+5,video:Math.floor(10*Math.random())+3,carousel:Math.floor(8*Math.random())+2},themes:["Promo\xe7\xe3o","Lan\xe7amento","Institucional","Depoimentos"],avg_duration_days:Math.floor(30*Math.random())+7}}calculateAvgRoas(e){let t=e.map(e=>e.insights?.roas).filter(e=>null!=e);return 0===t.length?0:t.reduce((e,t)=>e+t,0)/t.length}generateRecommendations(e,t){let a=[];for(let t of e)t.insights&&(t.insights.ctr<1&&a.push(`${t.name}: CTR baixo (${t.insights.ctr.toFixed(2)}%). Considere revisar criativos e segmenta\xe7\xe3o.`),t.insights.cpc>2&&a.push(`${t.name}: CPC elevado (R$ ${t.insights.cpc.toFixed(2)}). Teste novos p\xfablicos ou ajuste lances.`),t.insights.roas&&t.insights.roas<2&&a.push(`${t.name}: ROAS abaixo do ideal (${t.insights.roas.toFixed(1)}x). Revise funil de convers\xe3o.`),t.insights.frequency&&t.insights.frequency>3&&a.push(`${t.name}: Frequ\xeancia alta (${t.insights.frequency.toFixed(1)}). Expanda o p\xfablico ou pause para evitar fadiga.`));return 0===a.length&&a.push("✅ Campanhas com performance saud\xe1vel. Continue monitorando."),a.slice(0,5)}}let n=new i},1926:(e,t,a)=>{a.d(t,{O:()=>o});var s=a(54128);let i="https://ikjgsqtykkhqimypacro.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI";i&&n||console.error("❌ ERRO CR\xcdTICO: Vari\xe1veis de ambiente NEXT_PUBLIC_SUPABASE_URL ou NEXT_PUBLIC_SUPABASE_ANON_KEY n\xe3o encontradas!");let o=(0,s.eI)(i||"https://setup-missing.supabase.co",n||"setup-missing",{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[89276,55972,54128,20958],()=>a(51800));module.exports=s})();