"use strict";(()=>{var e={};e.id=67131,e.ids=[67131],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},55851:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>f,patchFetch:()=>h,requestAsyncStorage:()=>_,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>b});var n={};a.r(n),a.d(n,{POST:()=>m,dynamic:()=>u});var i=a(49303),r=a(88716),o=a(60670),s=a(87070),d=a(17478),c=a(90176),l=a(88783);let u="force-dynamic";async function m(e){let t;let a=await (0,d.k)(e);if(!a.ok)return a.res;let n=(0,c.t)();try{t=await e.json()}catch{return s.NextResponse.json({error:"Body inv\xe1lido (JSON)"},{status:400})}let{client_id:i,prediction_id:r,selected_actions:o=[],risk_level:u,churn_probability:m,days_until_churn:p,company_name:_,monthly_value:b}=t;if(!i)return s.NextResponse.json({error:"client_id \xe9 obrigat\xf3rio"},{status:400});if(!o||0===o.length)return s.NextResponse.json({error:"Selecione pelo menos uma a\xe7\xe3o"},{status:400});try{let{data:e,error:t}=await n.from("clients").select("id, company_name, contact_name, contact_email, monthly_value").eq("id",i).single();if(t||!e)return s.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});let{data:d}=await n.from("kanban_tasks").select("id, board_id").eq("reference_links->>source","churn_prediction").eq("reference_links->>client_id",i).gte("created_at",new Date(Date.now()-864e5).toISOString()).limit(1).maybeSingle();if(d?.id&&d?.board_id)return s.NextResponse.json({success:!0,already_executed:!0,task_id:d.id,board_id:d.board_id,kanban_url:`/admin/meu-kanban?boardId=${encodeURIComponent(String(d.board_id))}&taskId=${encodeURIComponent(String(d.id))}`});let c=await (0,l.yH)(n,a.userId),g=`ðŸš¨ Reten\xe7\xe3o: ${_||e.company_name||"Cliente"}`,f="critical"===u?"\uD83D\uDD34":"high"===u?"\uD83D\uDFE0":"\uD83D\uDFE1",h=[`${f} **A\xc7\xc3O DE RETEN\xc7\xc3O DE CLIENTE**`,"",`**Cliente:** ${_||e.company_name}`,`**Probabilidade de Churn:** ${m||0}%`,`**Dias at\xe9 Churn Estimado:** ${p||"N/A"}`,`**Valor Mensal em Risco:** R$ ${(b||e.monthly_value||0).toLocaleString("pt-BR")}`,`**N\xedvel de Risco:** ${u?.toUpperCase()||"N/A"}`,"","---","","**\uD83D\uDCCB A\xc7\xd5ES A EXECUTAR:**","",...o.map((e,t)=>`${t+1}. ${e}`),"","---","","**Contato:**",`- Nome: ${e.contact_name||"N/A"}`,`- Email: ${e.contact_email||"N/A"}`,"",`**â° Prazo:** ${p?`${p} dias`:"Urgente"}`,"",`Criado automaticamente pelo sistema de predi\xe7\xe3o de churn.`,`Criado por: ${a.userId}`,`Criado em: ${new Date().toLocaleString("pt-BR")}`].join("\n"),k=function(e){switch(e?.toLowerCase()){case"critical":return"urgent";case"high":return"high";case"medium":return"medium";default:return"low"}}(u),w=await (0,l.ID)(n,{boardId:c,clientId:i,title:g,description:h,status:"todo",priority:k,area:"admin",createdBy:a.userId,referenceLinks:{source:"churn_prediction",client_id:i,prediction_id:r||null,risk_level:u,churn_probability:m,created_via:"churn_action_modal"}});if(r)try{let{error:e}=await n.from("client_churn_predictions").update({intervention_status:"in_progress",intervention_started_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",r);e?console.warn("âš ï¸ Failed to update prediction status:",e):console.log("âœ… Prediction updated with intervention status")}catch(e){console.warn("âš ï¸ Failed to update prediction status:",e)}return s.NextResponse.json({success:!0,already_executed:!1,task_id:w.id,board_id:w.board_id,kanban_url:`/admin/meu-kanban?boardId=${encodeURIComponent(String(w.board_id))}&taskId=${encodeURIComponent(String(w.id))}`,task:w})}catch(e){return console.error("Error creating retention task:",e),s.NextResponse.json({error:e?.message||"Erro ao criar tarefa"},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/admin/predictions/actions/create/route",pathname:"/api/admin/predictions/actions/create",filename:"route",bundlePath:"app/api/admin/predictions/actions/create/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\predictions\\actions\\create\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:_,staticGenerationAsyncStorage:b,serverHooks:g}=p,f="/api/admin/predictions/actions/create/route";function h(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:b})}},90176:(e,t,a)=>{a.d(t,{t:()=>i});var n=a(54128);function i(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,n.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},17478:(e,t,a)=>{a.d(t,{k:()=>s});var n=a(87070),i=a(20344),r=a(71615),o=a(54128);async function s(e){let t=(0,r.cookies)(),a=(0,i.createRouteHandlerClient)({cookies:()=>t}),s=e.headers.get("authorization")||"",d=s.toLowerCase().startsWith("bearer ")?s.slice(7).trim():null,c=d?(0,o.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${d}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):a,{data:l}=await c.auth.getUser();if(!l.user?.id)return{ok:!1,res:n.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:u,error:m}=await c.rpc("is_admin");return m||!u?{ok:!1,res:n.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:l.user.id}}},88783:(e,t,a)=>{async function n(e,t){let{data:a}=await e.from("kanban_columns").select("id,name,position").eq("board_id",t).order("position",{ascending:!0});a&&a.length>0||await e.from("kanban_columns").insert([{name:"Backlog",position:1,color:"#64748b"},{name:"A Fazer",position:2,color:"#f59e0b"},{name:"Em Progresso",position:3,color:"#3b82f6"},{name:"Em Revis\xe3o",position:4,color:"#8b5cf6"},{name:"Conclu\xeddo",position:5,color:"#22c55e"},{name:"Bloqueado",position:6,color:"#ef4444"},{name:"Cancelado",position:7,color:"#9ca3af"}].map(e=>({...e,board_id:t})))}async function i(e,t){let{data:a}=await e.from("kanban_boards").select("id").is("client_id",null).eq("name","Super Admin").limit(1).maybeSingle();if(a?.id)return await n(e,a.id),a.id;let{data:i,error:r}=await e.from("kanban_boards").insert({name:"Super Admin",description:"Quadro central do Admin",client_id:null,is_active:!0,created_by:t||null}).select("id").single();if(r)throw r;return await n(e,i.id),i.id}async function r(e,t,a){let{data:i}=await e.from("kanban_boards").select("id").eq("client_id",t).eq("name","Onboarding").limit(1).maybeSingle();if(i?.id)return await n(e,i.id),i.id;let{data:r,error:o}=await e.from("kanban_boards").insert({name:"Onboarding",description:"Fluxo inicial autom\xe1tico",client_id:t,is_active:!0,created_by:a||null}).select("id").single();if(o)throw o;return await n(e,r.id),r.id}async function o(e,t,a){let n=function(e){switch(e){case"backlog":return"Backlog";case"in_progress":return"Em Progresso";case"in_review":return"Em Revis\xe3o";case"done":return"Conclu\xeddo";case"blocked":return"Bloqueado";case"cancelled":return"Cancelado";default:return"A Fazer"}}(a),{data:i}=await e.from("kanban_columns").select("id").eq("board_id",t).eq("name",n).limit(1).maybeSingle();if(i?.id)return i.id;let{data:r}=await e.from("kanban_columns").select("id").eq("board_id",t).order("position",{ascending:!0}).limit(1).maybeSingle();if(!r?.id)throw Error("Board sem colunas");return r.id}async function s(e,t){let a=t.status||"todo",n=t.priority||"medium",i=await o(e,t.boardId,a),{data:r}=await e.from("kanban_tasks").select("position").eq("board_id",t.boardId).eq("column_id",i).order("position",{ascending:!1}).limit(1).maybeSingle(),s=Number(r?.position||0)+1,{data:d,error:c}=await e.from("kanban_tasks").insert({board_id:t.boardId,column_id:i,title:t.title,description:t.description||null,priority:n,status:a,position:s,client_id:t.clientId||null,area:t.area||null,created_by:t.createdBy||null,reference_links:t.referenceLinks||null,updated_at:new Date().toISOString()}).select("id, board_id").single();if(c)throw c;return d}a.d(t,{ID:()=>s,bI:()=>r,yH:()=>i})}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[89276,55972,54128,20958],()=>a(55851));module.exports=n})();