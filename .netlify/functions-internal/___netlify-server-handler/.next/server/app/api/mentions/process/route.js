"use strict";(()=>{var e={};e.id=76231,e.ids=[76231],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},43922:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>q,patchFetch:()=>R,requestAsyncStorage:()=>k,routeModule:()=>v,serverHooks:()=>$,staticGenerationAsyncStorage:()=>w});var r={};s.r(r),s.d(r,{POST:()=>b,dynamic:()=>g,runtime:()=>f});var i=s(49303),a=s(88716),n=s(60670),o=s(87070),d=s(71615),c=s(20344),l=s(54128);let u=/@\{([0-9a-fA-F-]{36})\}/g;function p(e){return Array.from(new Set((function(e){let t;let s=String(e||""),r=[];for(;t=u.exec(s);){let e=t[1];r.push({userId:e,raw:t[0],index:t.index})}return r})(e).map(e=>e.userId)))}var m=s(46882);let g="force-dynamic",f="nodejs";function _(e){let t=(process.env.NEXT_PUBLIC_APP_URL||"").trim();return t?t.replace(/\/+$/,""):(e.headers.get("origin")||"").replace(/\/+$/,"")}async function y(e,t){if(!t)return null;let{data:s}=await e.from("user_profiles").select("email, id, user_id").eq("id",t).maybeSingle(),r=s?.email?String(s.email).trim():"";if(r)return r;let{data:i}=await e.from("user_profiles").select("email, id, user_id").eq("user_id",t).maybeSingle(),a=i?.email?String(i.email).trim():"";if(a)return a;let{data:n}=await e.from("employees").select("email").eq("user_id",t).maybeSingle(),o=n?.email?String(n.email).trim():"";if(o)return o;let{data:d}=await e.from("clients").select("email").eq("user_id",t).maybeSingle();return(d?.email?String(d.email).trim():"")||null}async function x(e,t){let{data:s}=await e.from("clients").select("id").eq("user_id",t).maybeSingle();return!!s?.id}async function h(e){let{service:t,request:s,toUserId:r,subject:i,text:a}=e,n=e.html||void 0,o=await y(t,r);if(!o)return{success:!1,skipped:!0,reason:"no_email"};let d=(process.env.SENDGRID_API_KEY||"").trim(),c=(process.env.SENDGRID_FROM_EMAIL||"").trim(),l=(process.env.SENDGRID_FROM_NAME||"").trim(),u=d,p=c||"noreply@valle360.com.br",g=l||"Valle 360";try{let{data:e}=await t.from("integration_configs").select("status, api_key, config").eq("integration_id","sendgrid").maybeSingle(),s=(e?.status==="connected"?String(e?.api_key||""):"").trim();s&&(u=s),e?.config?.fromEmail&&(p=String(e.config.fromEmail)),e?.config?.fromName&&(g=String(e.config.fromName))}catch{}u||(u="mailto");let f=(0,m.w2)({apiKey:u,fromEmail:p,fromName:g}),x=await f.sendEmail({to:[{email:o}],subject:i,text:a,html:n,categories:["valle360","mention"]});try{await t.from("integration_logs").insert({integration_id:"sendgrid",action:"send_mention",status:x.success?"success":"error",request_data:{to:1,toUserId:r},error_message:x.error,duration_ms:null,response_data:{origin:_(s)},created_at:new Date().toISOString()})}catch{}return{success:x.success,error:x.error}}async function S(e,t){let s={user_id:t.user_id,type:t.type,title:t.title,message:t.message,is_read:!1,created_at:new Date().toISOString()},r=await e.from("notifications").insert({...s,link:t.link??null,metadata:t.metadata??{}});if(!r.error)return{ok:!0};let i=await e.from("notifications").insert({...s,action_url:t.link??t.action_url??null});return i.error?{ok:!1,error:r.error?.message||i.error?.message||"Falha ao inserir notifica\xe7\xe3o"}:{ok:!0}}async function b(e){let t;let s=(0,d.cookies)(),r=(0,c.createRouteHandlerClient)({cookies:()=>s}),{data:i,error:a}=await r.auth.getUser(),n=i?.user;if(a||!n)return o.NextResponse.json({success:!1,error:"N\xe3o autorizado"},{status:401});let u=function(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;return e&&t?(0,l.eI)(e,t,{auth:{persistSession:!1}}):null}();if(!u)return o.NextResponse.json({success:!1,error:"SUPABASE_SERVICE_ROLE_KEY n\xe3o configurada no servidor"},{status:500});try{t=await e.json()}catch{return o.NextResponse.json({success:!1,error:"Body inv\xe1lido (JSON)"},{status:400})}let m=String(t?.entityType||"").trim(),g=String(t?.entityId||"").trim();if(!m||!g)return o.NextResponse.json({success:!1,error:"entityType e entityId s\xe3o obrigat\xf3rios"},{status:400});let f=new Date().toISOString(),y=_(e),b="",v={source:"mention",entity_type:m,entity_id:g},k=null,w=null;if("kanban_task_comment"===m){let{data:e,error:s}=await r.from("kanban_task_comments").select("id, task_id, user_id, comment, created_at").eq("id",g).single();if(s||!e)return o.NextResponse.json({success:!1,error:"Coment\xe1rio n\xe3o encontrado ou sem permiss\xe3o"},{status:404});b=String(e.comment||"");let i=String(e.task_id||t.taskId||"").trim();if(i){let{data:e}=await r.from("kanban_tasks").select("id, board_id, title").eq("id",i).maybeSingle();e?.id?(v.board_id=String(e.board_id||""),v.task_id=String(e.id),v.task_title=String(e.title||"")):v.task_id=i}k=v?.board_id&&v?.task_id?`/app/kanban?boardId=${encodeURIComponent(String(v.board_id))}&taskId=${encodeURIComponent(String(v.task_id))}`:"/app/kanban";let a=p(b);if(a.length>0){let{data:e}=await u.from("employees").select("user_id").eq("is_active",!0).in("user_id",a);w=(e||[]).map(e=>String(e.user_id))}else w=[]}if("direct_message"===m){let{data:e,error:s}=await r.from("direct_messages").select("id, conversation_id, from_user_id, body, created_at").eq("id",g).single();if(s||!e)return o.NextResponse.json({success:!1,error:"Mensagem n\xe3o encontrada ou sem permiss\xe3o"},{status:404});let i=String(e.conversation_id||t.conversationId||"").trim();if(!i)return o.NextResponse.json({success:!1,error:"conversationId ausente"},{status:400});let{data:a}=await r.from("direct_conversation_participants").select("id").eq("conversation_id",i).eq("user_id",n.id).eq("is_active",!0).maybeSingle();if(!a?.id)return o.NextResponse.json({success:!1,error:"Acesso negado"},{status:403});b=String(e.body||""),v.conversation_id=i,v.message_id=g;let{data:d}=await u.from("direct_conversation_participants").select("user_id").eq("conversation_id",i).neq("user_id",String(e.from_user_id||n.id)).maybeSingle();w=d?.user_id?[String(d.user_id)]:[],k="/app/mensagens"}if("group_message"===m){let{data:e,error:s}=await r.from("messages").select("id, group_id, from_user_id, body, created_at").eq("id",g).single();if(s||!e)return o.NextResponse.json({success:!1,error:"Mensagem n\xe3o encontrada ou sem permiss\xe3o"},{status:404});let i=String(e.group_id||t.groupId||"").trim();if(!i)return o.NextResponse.json({success:!1,error:"groupId ausente"},{status:400});let{data:a}=await r.from("group_participants").select("id").eq("group_id",i).eq("user_id",n.id).eq("is_active",!0).maybeSingle();if(!a?.id)return o.NextResponse.json({success:!1,error:"Acesso negado"},{status:403});b=String(e.body||""),v.group_id=i,v.message_id=g;let{data:d}=await u.from("group_participants").select("user_id").eq("group_id",i).eq("is_active",!0);w=(d||[]).map(e=>String(e.user_id)),k="/app/mensagens"}let $=p(b);if(0===$.length)return o.NextResponse.json({success:!0,processed:0,sentEmails:0});let q=new Set(w||[]),R=$.filter(e=>e&&e!==n.id).filter(e=>!w||q.has(e));if(0===R.length)return o.NextResponse.json({success:!0,processed:0,sentEmails:0});let E=[],I=0,j=function(e,t=140){let s=String(e||"").replace(/\s+/g," ").trim();return s.length<=t?s:s.slice(0,t-1)+"â€¦"}(b,160);for(let t of(v?.board_id&&v?.task_id,R))try{let s={...v,mentioned_by:n.id,mentioned_user_id:t,preview:j,created_at:f},r=k;if("direct_message"===m||"group_message"===m)try{r=await x(u,t)?"/cliente/mensagens":"/app/mensagens"}catch{r="/app/mensagens"}let i=await S(u,{user_id:t,type:"mention",title:"Voc\xea foi mencionado",message:j,link:r,metadata:s}),a=v?.board_id&&v?.task_id?`${y}/app/kanban?boardId=${encodeURIComponent(String(v.board_id))}&taskId=${encodeURIComponent(String(v.task_id))}`:r?`${y}${r.startsWith("/")?r:`/${r}`}`:y,o=`Voc\xea foi mencionado.

Mensagem: ${j}

Abrir: ${a}`,d=`
        <div style="font-family: Arial, sans-serif; line-height: 1.5;">
          <h2>Voc\xea foi mencionado</h2>
          <p><strong>Mensagem:</strong> ${j.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p>
          <p><a href="${a}">Abrir no Valle 360</a></p>
        </div>
      `,c=!!(await h({service:u,request:e,toUserId:t,subject:"Voc\xea foi mencionado na Valle 360",text:o,html:d})).success;c&&I++,E.push({userId:t,notified:i.ok,emailed:c,error:i.ok?void 0:i.error})}catch(e){E.push({userId:t,notified:!1,emailed:!1,error:e?.message||"Erro"})}return o.NextResponse.json({success:!0,processed:R.length,sentEmails:I,results:E})}let v=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/mentions/process/route",pathname:"/api/mentions/process",filename:"route",bundlePath:"app/api/mentions/process/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\mentions\\process\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:k,staticGenerationAsyncStorage:w,serverHooks:$}=v,q="/api/mentions/process/route";function R(){return(0,n.patchFetch)({serverHooks:$,staticGenerationAsyncStorage:w})}},46882:(e,t,s)=>{s.d(t,{Rp:()=>r,qC:()=>a,w2:()=>i});class r{constructor(e){this.apiKey=e.apiKey,this.fromEmail=e.fromEmail,this.fromName=e.fromName}async request(e,t={}){let s=await fetch(`https://api.sendgrid.com/v3${e}`,{...t,headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json",...t.headers}});if(202===s.status||200===s.status||201===s.status){let e=await s.text();return e?JSON.parse(e):{success:!0}}let r=await s.json();throw Error(r.errors?.[0]?.message||"Erro na API SendGrid")}async sendEmail(e){let t=Array.isArray(e.to)?e.to:[e.to],s=t[0]?.email||"",r=e.subject||"",i=(e.text||e.html||"").replace(/<[^>]+>/g,"").trim();return{success:!0,mailtoUrl:`mailto:${s}?subject=${encodeURIComponent(r)}&body=${encodeURIComponent(i)}`}}async sendBulkEmail(e,t){return{success:0,failed:e.length,errors:["Envio em lote n\xe3o suportado via mailto. Use envio manual."]}}async listTemplates(){return this.request("/templates?generations=dynamic")}async getTemplate(e){return this.request(`/templates/${e}`)}async getStats(e,t){let s=`/stats?start_date=${e}`;return t&&(s+=`&end_date=${t}`),this.request(s)}async getCategoryStats(e,t,s){let r=`/categories/${e}/stats?start_date=${t}`;return s&&(r+=`&end_date=${s}`),this.request(r)}async addContact(e,t){let s={email:e};t?.firstName&&(s.first_name=t.firstName),t?.lastName&&(s.last_name=t.lastName),t?.customFields&&(s.custom_fields=t.customFields);let r={contacts:[s]};return t?.listIds&&(r.list_ids=t.listIds),this.request("/marketing/contacts",{method:"PUT",body:JSON.stringify(r)})}async searchContacts(e){return this.request("/marketing/contacts/search",{method:"POST",body:JSON.stringify({query:e})})}async deleteContact(e){return this.request(`/marketing/contacts?ids=${e}`,{method:"DELETE"})}async getLists(){return this.request("/marketing/lists")}async createList(e){return this.request("/marketing/lists",{method:"POST",body:JSON.stringify({name:e})})}async addToSuppressionList(e,t){let s="unsubscribes"===t?"/asm/suppressions/global":`/suppression/${t}`;await this.request(s,{method:"POST",body:JSON.stringify({recipient_emails:e})})}async getSuppressionList(e){let t="unsubscribes"===e?"/asm/suppressions/global":`/suppression/${e}`;return this.request(t)}}function i(e){return new r(e)}let a={welcome:(e,t)=>({subject:`Bem-vindo \xe0 ${t}! ðŸŽ‰`,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h1 style="color: #4370d1;">Ol\xe1, ${e}!</h1>
        <p>Seja muito bem-vindo(a) \xe0 ${t}!</p>
        <p>Estamos muito felizes em ter voc\xea conosco. A partir de agora, voc\xea ter\xe1 acesso a todas as nossas ferramentas e recursos.</p>
        <p>Se precisar de ajuda, n\xe3o hesite em entrar em contato.</p>
        <p>Abra\xe7os,<br/>Equipe ${t}</p>
      </div>
    `}),notification:(e,t,s,r)=>({subject:e,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2 style="color: #333;">${e}</h2>
        <p>${t}</p>
        ${s?`
          <p style="margin-top: 20px;">
            <a href="${s}" style="background-color: #4370d1; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
              ${r||"Ver mais"}
            </a>
          </p>
        `:""}
      </div>
    `}),meetingScheduled:(e,t,s,r,i)=>({subject:`Reuni\xe3o Agendada - ${t} \xe0s ${s}`,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2 style="color: #4370d1;">Reuni\xe3o Confirmada! ðŸ“…</h2>
        <p>Ol\xe1 ${e},</p>
        <p>Sua reuni\xe3o foi agendada com sucesso.</p>
        <div style="background-color: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
          <p><strong>Data:</strong> ${t}</p>
          <p><strong>Hor\xe1rio:</strong> ${s}</p>
          ${i?`<p><strong>Descri\xe7\xe3o:</strong> ${i}</p>`:""}
        </div>
        <p>
          <a href="${r}" style="background-color: #4370d1; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
            Entrar na Reuni\xe3o
          </a>
        </p>
        <p style="color: #666; font-size: 12px; margin-top: 20px;">
          Adicione este evento ao seu calend\xe1rio para n\xe3o esquecer!
        </p>
      </div>
    `}),invoice:(e,t,s,r,i)=>({subject:`Fatura #${t} - Pagamento Pendente`,html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2 style="color: #333;">Fatura #${t}</h2>
        <p>Ol\xe1 ${e},</p>
        <p>Segue sua fatura para pagamento:</p>
        <div style="background-color: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
          <p><strong>Valor:</strong> ${s}</p>
          <p><strong>Vencimento:</strong> ${r}</p>
        </div>
        <p>
          <a href="${i}" style="background-color: #22c55e; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
            Pagar Agora
          </a>
        </p>
      </div>
    `})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>s(43922));module.exports=r})();