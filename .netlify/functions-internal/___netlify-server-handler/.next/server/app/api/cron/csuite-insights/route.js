"use strict";(()=>{var e={};e.id=22858,e.ids=[22858],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},34419:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>S,requestAsyncStorage:()=>y,routeModule:()=>x,serverHooks:()=>w,staticGenerationAsyncStorage:()=>v});var a={};r.r(a),r.d(a,{GET:()=>h,POST:()=>_,dynamic:()=>p});var s=r(49303),n=r(88716),i=r(60670),o=r(87070),c=r(90176),u=r(87881),l=r(17743),d=r(35311),g=r(17478);let p="force-dynamic";async function m(e){let t=0,r=[];for(let a of l.G){let s="cmo"===a,n=await (0,d.M)({role:a,actorUserId:e.actorUserId,includeMarket:s});t+=n.created,r.push({role:a,created:n.created,warning:n.warning||null})}return{created:t,perRole:r,requestData:e.requestData}}async function h(e){let t=Date.now(),r=(0,u.T)(e);if(r)return r;let a=(0,c.t)();try{let e=await m({actorUserId:null,requestData:{source:"cron"}});return await (0,u.m)({supabase:a,action:"csuite_insights",status:"ok",durationMs:Date.now()-t,requestData:e.requestData,responseData:{created:e.created,perRole:e.perRole}}),o.NextResponse.json({success:!0,created:e.created,perRole:e.perRole})}catch(e){return await (0,u.m)({supabase:a,action:"csuite_insights",status:"error",durationMs:Date.now()-t,requestData:{source:"cron"},responseData:null,errorMessage:String(e?.message||"erro")}),o.NextResponse.json({success:!1,error:String(e?.message||"erro")},{status:500})}}async function _(e){let t=Date.now(),r=(0,c.t)();try{let a=await (0,g.k)(e);if(!a.ok)return a.res;let s=await m({actorUserId:a.userId,requestData:{manual:!0,by:a.userId}});return await (0,u.m)({supabase:r,action:"csuite_insights",status:"ok",durationMs:Date.now()-t,requestData:s.requestData,responseData:{created:s.created,perRole:s.perRole}}),o.NextResponse.json({success:!0,created:s.created,perRole:s.perRole})}catch(e){return await (0,u.m)({supabase:r,action:"csuite_insights",status:"error",durationMs:Date.now()-t,requestData:{manual:!0},responseData:null,errorMessage:String(e?.message||"erro")}),o.NextResponse.json({success:!1,error:String(e?.message||"erro")},{status:500})}}let x=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/cron/csuite-insights/route",pathname:"/api/cron/csuite-insights",filename:"route",bundlePath:"app/api/cron/csuite-insights/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\cron\\csuite-insights\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:v,serverHooks:w}=x,f="/api/cron/csuite-insights/route";function S(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:v})}},87881:(e,t,r)=>{r.d(t,{T:()=>s,m:()=>n});var a=r(87070);function s(e){let t=String(process.env.CRON_SECRET||"").trim(),r=String(e.headers.get("authorization")||"").trim();return t&&r===`Bearer ${t}`?null:"1"===String(e.headers.get("x-vercel-cron")||"").trim()||String(e.headers.get("user-agent")||"").toLowerCase().includes("vercel-cron")?null:a.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}async function n(e){try{await e.supabase.from("integration_logs").insert({integration_id:"cron",action:e.action,status:e.status,request_data:e.requestData??null,response_data:e.responseData??null,error_message:e.errorMessage??null,duration_ms:Math.max(0,Math.floor(e.durationMs||0)),created_at:new Date().toISOString()})}catch{}}},35311:(e,t,r)=>{r.d(t,{M:()=>o});var a=r(90176),s=r(51547),n=r(31683);async function i(e){try{let t=(0,a.t)(),{data:r}=await t.from("ai_executive_insights").select("id").eq("executive_id",e.executiveId).eq("title",e.title).gte("created_at",e.sinceIso).limit(1);return(r||[]).length>0}catch{return!1}}async function o(e){let t=(0,a.t)(),{data:r}=await t.from("ai_executives").select("*").eq("role",e.role).maybeSingle();if(!r?.id)return{created:0,warning:`Executivo ${e.role} n\xe3o encontrado em ai_executives.`};let o=await (0,n.tJ)({role:e.role,actorUserId:e.actorUserId,includePredictions:!0,touchKnowledge:!!e.actorUserId}),c=e.includeMarket?await (0,n.kG)({executiveId:String(r.id),role:e.role,query:`Tend\xeancias e benchmarks relevantes para ${e.role.toUpperCase()} em ag\xeancia de marketing (Brasil). Foque em 2025/2026.`,purpose:`Gera\xe7\xe3o de insights de mercado (${e.role})`}):null,u=`${String(r.system_prompt||"").trim()}

${n.e$}

Voc\xea vai gerar INSIGHTS PROATIVOS em JSON para o executivo.
Regras: sem mocks, sem inventar n\xfameros. Se faltar dado, cite isso e proponha como coletar.
Formato de sa\xedda: um JSON v\xe1lido com a chave "insights" (array).`,l=(await (0,s.F)({task:(0,n.Ph)(e.role),json:!0,temperature:.35,maxTokens:1200,actorUserId:e.actorUserId,entityType:"ai_executive_insights_generate",entityId:e.role,messages:[{role:"system",content:u},{role:"user",content:[`Executivo: ${e.role.toUpperCase()} (${r.name} â€” ${r.title})`,`Contexto interno (JSON):
${JSON.stringify(o).slice(0,18e3)}`,c?`Contexto de mercado (Perplexity Sonar):
${c.answer}
Fontes:
${c.sources.join("\n")}`:null,"Gere de 3 a 6 insights com recommended_actions (CTAs consultivos).",`Cada insight deve incluir:
- insight_type (risk|opportunity|performance|strategy)
- category (financial|operational|marketing|customer|hr|tech|general)
- title
- description
- confidence_score (0.00-1.00)
- impact_level (low|medium|high|critical)
- urgency (low|medium|high)
- requires_discussion (boolean)
- recommended_actions: array de objetos {label, action_type, payload, requires_external, risk_level}
`,`action_type permitido:
- create_kanban_task (interno)
- send_direct_message (interno)
- schedule_meeting (interno)
- n8n_webhook (EXTERNO; requires_external=true)
- external_email (EXTERNO; requires_external=true)
`,"IMPORTANTE: nada executa automaticamente. Apenas sugira CTAs e payloads."].filter(Boolean).join("\n\n")}]})).json||{},d=Array.isArray(l?.insights)?l.insights:Array.isArray(l)?l:[],g=new Date(Date.now()-864e5).toISOString(),p=0;for(let e of d){let a=String(e?.title||"").trim(),s=String(e?.description||"").trim();if(!a||!s||await i({executiveId:String(r.id),title:a,sinceIso:g}))continue;let n=function(e){let t=Number(e);return Number.isFinite(t)?t>1?Math.max(0,Math.min(1,t/100)):Math.max(0,Math.min(1,t)):null}(e?.confidence_score),o={executive_id:r.id,insight_type:String(e?.insight_type||"strategy"),category:String(e?.category||"general"),title:a,description:s,supporting_data:e?.supporting_data??{},data_sources:e?.data_sources??[],confidence_score:n,impact_level:e?.impact_level?String(e.impact_level):null,urgency:e?.urgency?String(e.urgency):null,recommended_actions:e?.recommended_actions??[],requires_discussion:!!e?.requires_discussion,status:"new"};try{let{error:e}=await t.from("ai_executive_insights").insert(o);!e&&p++}catch{}}return{created:p,warning:null}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958,79263,44518],()=>r(34419));module.exports=a})();