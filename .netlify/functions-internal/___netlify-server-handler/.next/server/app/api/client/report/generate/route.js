"use strict";(()=>{var e={};e.id=95145,e.ids=[95145],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},78353:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>u,serverHooks:()=>_,staticGenerationAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{GET:()=>p,POST:()=>d});var n=r(49303),i=r(88716),o=r(60670),s=r(87070),l=r(20344),c=r(71615);async function d(e){let t=(0,l.createRouteHandlerClient)({cookies:c.cookies}),{data:{user:r},error:a}=await t.auth.getUser();if(a||!r)return s.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{report_type:n="monthly",start_date:i,end_date:o,include_sections:d=["overview","social","engagement","competitors","recommendations"]}=await e.json();try{let e;let{data:a,error:l}=await t.from("clients").select("id, company_name, segment, user_id").eq("user_id",r.id).single();if(l||!a)return s.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});let c=new Date,p=o?new Date(o):c;if(i)e=new Date(i);else switch(n){case"weekly":e=new Date(c.setDate(c.getDate()-7));break;case"quarterly":e=new Date(c.setMonth(c.getMonth()-3));break;default:e=new Date(c.setMonth(c.getMonth()-1))}let u={client:{name:a.company_name,segment:a.segment,period:{start:e.toISOString(),end:p.toISOString(),type:n}},generated_at:new Date().toISOString()};if(d.includes("overview")){let{data:r}=await t.from("post_approvals").select("*").eq("client_id",a.id).gte("created_at",e.toISOString()).lte("created_at",p.toISOString()),n=r?.filter(e=>"approved"===e.status).length||0,i=r?.filter(e=>"rejected"===e.status).length||0,o=r?.filter(e=>"pending"===e.status).length||0,s=r?.length||0;u.approvals={total:s,approved:n,rejected:i,pending:o,approval_rate:s>0?Math.round(n/s*100):0}}if(d.includes("social")){let{data:e}=await t.from("client_social_accounts").select("*").eq("client_id",a.id);u.social={accounts:e?.length||0,platforms:[...new Set(e?.map(e=>e.platform)||[])],metrics:{total_followers:e?.reduce((e,t)=>e+(t.followers_count||0),0)||0,total_posts:0,avg_engagement:0}}}if(d.includes("engagement")){let{data:r}=await t.from("social_metrics").select("*").eq("client_id",a.id).gte("date",e.toISOString().split("T")[0]).lte("date",p.toISOString().split("T")[0]).order("date",{ascending:!0}),n=r?.reduce((e,t)=>e+(t.likes||0),0)/(r?.length||1),i=r?.reduce((e,t)=>e+(t.comments||0),0)/(r?.length||1),o=r?.reduce((e,t)=>e+(t.reach||0),0)/(r?.length||1);u.engagement={average_likes:Math.round(n),average_comments:Math.round(i),average_reach:Math.round(o),trend:r?.length&&r.length>1?r[r.length-1]?.likes>r[0]?.likes?"up":"down":"stable",daily_data:r?.slice(-7)||[]}}if(d.includes("competitors")){let{data:e}=await t.from("client_competitors").select(`
          *,
          activities:competitor_activities(
            activity_type,
            likes_count,
            comments_count,
            is_viral,
            detected_at
          )
        `).eq("client_id",a.id).eq("is_active",!0);u.competitors={total_monitored:e?.length||0,competitors:e?.map(e=>({name:e.display_name,username:e.instagram_username,followers:e.followers_count,viral_posts:e.activities?.filter(e=>e.is_viral).length||0,total_activities:e.activities?.length||0}))||[]}}d.includes("recommendations")&&(u.recommendations=[{type:"engagement",priority:"high",title:"Aumentar frequ\xeancia de posts",description:"Baseado na an\xe1lise, recomendamos aumentar de 3 para 5 posts por semana."},{type:"content",priority:"medium",title:"Investir em Reels",description:"Reels t\xeam 2x mais alcance que posts est\xe1ticos no seu segmento."},{type:"timing",priority:"medium",title:"Melhor hor\xe1rio: 19h",description:"Seu p\xfablico est\xe1 mais ativo entre 18h e 21h."}]);let{data:m}=await t.from("client_goals").select("*").eq("client_id",a.id).eq("status","active");return u.goals=m?.map(e=>({title:e.title,type:e.goal_type,target:e.target_value,current:e.current_value,progress:Math.round(e.current_value/e.target_value*100),deadline:e.deadline}))||[],await t.from("client_reports").insert({client_id:a.id,report_type:n,period_start:e.toISOString(),period_end:p.toISOString(),data:u,created_by:r.id}),s.NextResponse.json({success:!0,report:u,download_url:null})}catch(e){return console.error("Erro ao gerar relat\xf3rio:",e),s.NextResponse.json({error:e.message},{status:500})}}async function p(e){let t=(0,l.createRouteHandlerClient)({cookies:c.cookies}),{data:{user:r},error:a}=await t.auth.getUser();if(a||!r)return s.NextResponse.json({error:"N\xe3o autorizado"},{status:401});try{let{data:e}=await t.from("clients").select("id").eq("user_id",r.id).single();if(!e)return s.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});let{data:a,error:n}=await t.from("client_reports").select("id, report_type, period_start, period_end, created_at").eq("client_id",e.id).order("created_at",{ascending:!1}).limit(10);if(n)throw n;return s.NextResponse.json({success:!0,reports:a})}catch(e){return console.error("Erro ao listar relat\xf3rios:",e),s.NextResponse.json({error:e.message},{status:500})}}let u=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/client/report/generate/route",pathname:"/api/client/report/generate",filename:"route",bundlePath:"app/api/client/report/generate/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\report\\generate\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:_}=u,h="/api/client/report/generate/route";function v(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:g})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958],()=>r(78353));module.exports=a})();