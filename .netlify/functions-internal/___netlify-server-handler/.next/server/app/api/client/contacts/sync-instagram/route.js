"use strict";(()=>{var e={};e.id=87016,e.ids=[87016],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},52374:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>x,requestAsyncStorage:()=>_,routeModule:()=>g,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var r={};a.r(r),a.d(r,{POST:()=>l});var s=a(49303),n=a(88716),o=a(60670),i=a(87070),c=a(20344),m=a(71615);async function l(e){let t=(0,c.createRouteHandlerClient)({cookies:m.cookies}),{data:{user:a},error:r}=await t.auth.getUser();if(r||!a)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});try{let{syncType:r}=await e.json(),{data:s}=await t.from("clients").select("id, instagram_access_token, instagram_user_id").eq("user_id",a.id).single();if(!s)return i.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});if(!s.instagram_access_token)return i.NextResponse.json({error:"Instagram n\xe3o conectado. Por favor, conecte sua conta primeiro."},{status:400});let{data:n,error:o}=await t.from("instagram_sync_logs").insert({client_id:s.id,sync_type:r,status:"processing"}).select().single();if(o)throw o;let c=0,m=null;try{switch(r){case"dms":c=await d(t,s.id,s.instagram_access_token,s.instagram_user_id);break;case"comments":c=await u(t,s.id,s.instagram_access_token,s.instagram_user_id);break;case"mentions":c=await p(t,s.id,s.instagram_access_token,s.instagram_user_id);break;default:throw Error("Tipo de sincroniza\xe7\xe3o inv\xe1lido")}}catch(e){m=e.message}if(await t.from("instagram_sync_logs").update({status:m?"failed":"completed",items_synced:c,error_message:m,completed_at:new Date().toISOString()}).eq("id",n.id),m)return i.NextResponse.json({success:!1,error:m,itemsSynced:c},{status:500});return i.NextResponse.json({success:!0,itemsSynced:c,message:`${c} contatos sincronizados com sucesso!`})}catch(e){return console.error("Erro ao sincronizar Instagram:",e),i.NextResponse.json({error:e.message},{status:500})}}async function d(e,t,a,r){let s=`https://graph.facebook.com/v18.0/${r}/conversations?platform=instagram&fields=participants,updated_time&access_token=${a}`,n=await fetch(s);if(!n.ok){let e=await n.json();throw Error(e.error?.message||"Erro ao buscar conversas")}let o=(await n.json()).data||[],i=0;for(let s of o)for(let n of s.participants?.data?.filter(e=>e.id!==r)||[]){let r=`https://graph.facebook.com/v18.0/${n.id}?fields=name,username,profile_pic&access_token=${a}`;try{let a=await fetch(r),o=await a.json(),{error:c}=await e.from("client_contacts").upsert({client_id:t,instagram_id:n.id,instagram_handle:o.username||null,name:o.name||o.username||"Instagram User",profile_picture_url:o.profile_pic||null,source:"instagram_dm",last_interaction_at:s.updated_time,category:"lead"},{onConflict:"client_id,instagram_id"});!c&&i++}catch(e){console.error("Erro ao buscar usu\xe1rio:",e)}}return i}async function u(e,t,a,r){let s=`https://graph.facebook.com/v18.0/${r}/media?fields=id,comments{from,timestamp}&limit=20&access_token=${a}`,n=await fetch(s);if(!n.ok){let e=await n.json();throw Error(e.error?.message||"Erro ao buscar posts")}let o=(await n.json()).data||[],i=0,c=new Set;for(let a of o)for(let r of a.comments?.data||[]){let a=r.from;if(!a||c.has(a.id))continue;c.add(a.id);let{error:s}=await e.from("client_contacts").upsert({client_id:t,instagram_id:a.id,instagram_handle:a.username||null,name:a.name||a.username||"Instagram User",source:"instagram_comment",last_interaction_at:r.timestamp,category:"lead"},{onConflict:"client_id,instagram_id"});!s&&i++}return i}async function p(e,t,a,r){let s=`https://graph.facebook.com/v18.0/${r}/tags?fields=id,username,timestamp,owner&access_token=${a}`,n=await fetch(s);if(!n.ok){let e=await n.json();throw Error(e.error?.message||"Erro ao buscar men\xe7\xf5es")}let o=(await n.json()).data||[],i=0;for(let a of o){let r=a.owner;if(!r)continue;let{error:s}=await e.from("client_contacts").upsert({client_id:t,instagram_id:r.id,instagram_handle:r.username||null,name:r.name||r.username||"Instagram User",source:"instagram_mention",last_interaction_at:a.timestamp,category:"lead"},{onConflict:"client_id,instagram_id"});!s&&i++}return i}let g=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/client/contacts/sync-instagram/route",pathname:"/api/client/contacts/sync-instagram",filename:"route",bundlePath:"app/api/client/contacts/sync-instagram/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\contacts\\sync-instagram\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:_,staticGenerationAsyncStorage:f,serverHooks:w}=g,h="/api/client/contacts/sync-instagram/route";function x(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>a(52374));module.exports=r})();