"use strict";(()=>{var e={};e.id=21466,e.ids=[21466],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},19715:(e,a,t)=>{t.r(a),t.d(a,{originalPathname:()=>h,patchFetch:()=>w,requestAsyncStorage:()=>S,routeModule:()=>k,serverHooks:()=>v,staticGenerationAsyncStorage:()=>b});var r={};t.r(r),t.d(r,{GET:()=>g,POST:()=>y,dynamic:()=>p});var i=t(49303),n=t(88716),s=t(60670),o=t(87070),l=t(71615),d=t(20344),c=t(54128),u=t(14399);let p="force-dynamic";function _(){let e="https://ikjgsqtykkhqimypacro.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY;return e&&a?(0,c.eI)(e,a,{auth:{persistSession:!1}}):null}function m(e,a){let t=new Date(e);return t.setHours(t.getHours()+a),t.toISOString()}function f(e,a=400){return o.NextResponse.json({success:!1,error:e},{status:a})}async function g(e){let a=(0,l.cookies)(),t=(0,d.createRouteHandlerClient)({cookies:()=>a}),{data:r,error:i}=await t.auth.getUser(),n=r?.user;if(i||!n)return f("N\xe3o autorizado",401);let s=_();if(!s)return f("SUPABASE_SERVICE_ROLE_KEY n\xe3o configurada no servidor",500);let{data:c}=await t.from("user_profiles").select("user_type").eq("user_id",n.id).maybeSingle(),{data:u}=await t.rpc("is_admin");if(!u&&c?.user_type!=="client")return f("Acesso negado",403);let{data:p}=await s.from("clients").select("id").eq("user_id",n.id).maybeSingle(),g=p?.id||null;if(!g&&!u)return f("Cliente n\xe3o vinculado (clients.user_id)",400);let{data:y}=await s.from("kanban_columns").select("id, sla_hours").eq("stage_key","aprovacao").limit(500),k=(y||[]).map(e=>String(e.id));if(0===k.length)return o.NextResponse.json({success:!0,approvals:[]});let{data:S}=await s.from("kanban_tasks").select(`
        id, title, description, board_id, column_id, due_date, created_at, updated_at, status, priority, tags, reference_links,
        board:kanban_boards ( id, area_key ),
        column:kanban_columns ( id, name, stage_key, position, sla_hours )
      `).eq("client_id",g).in("column_id",k).neq("status","cancelled").order("updated_at",{ascending:!0}),b=new Date().toISOString(),v=(S||[]).map(e=>{let a=(e.reference_links||{}).client_approval||{},t=a.requested_at||e.updated_at||e.created_at,r=Number(e?.column?.sla_hours||48),i=a.due_at||m(String(t),r),n=new Date(i).getTime()<new Date(b).getTime();return{id:e.id,title:e.title,description:e.description,board:e.board||null,column:e.column||null,requested_at:t,due_at:i,overdue:n,reference_links:e.reference_links||null}});return o.NextResponse.json({success:!0,approvals:v})}async function y(e){let a;let t=(0,l.cookies)(),r=(0,d.createRouteHandlerClient)({cookies:()=>t}),{data:i,error:n}=await r.auth.getUser(),s=i?.user;if(n||!s)return f("N\xe3o autorizado",401);let c=_();if(!c)return f("SUPABASE_SERVICE_ROLE_KEY n\xe3o configurada no servidor",500);let{data:p}=await r.from("user_profiles").select("user_type, full_name, email").eq("user_id",s.id).maybeSingle(),{data:g}=await r.rpc("is_admin");if(!g&&p?.user_type!=="client")return f("Acesso negado",403);try{a=await e.json()}catch{return f("Body inv\xe1lido (JSON)",400)}let y=String(a?.taskId||"").trim(),k=String(a?.action||"").trim(),S=String(a?.comment||"").trim();if(!y)return f("taskId obrigat\xf3rio",400);if("approve"!==k&&"request_changes"!==k)return f("action inv\xe1lida",400);if("request_changes"===k&&!S)return f("Descreva o que precisa ser ajustado",400);let{data:b}=await c.from("clients").select("id").eq("user_id",s.id).maybeSingle(),v=b?.id||null;if(!v&&!g)return f("Cliente n\xe3o vinculado (clients.user_id)",400);let{data:h,error:w}=await c.from("kanban_tasks").select("id, title, client_id, board_id, column_id, reference_links, assigned_to, created_by, created_at, updated_at").eq("id",y).maybeSingle();if(w||!h)return f("Tarefa n\xe3o encontrada",404);if(!g&&String(h.client_id)!==String(v))return f("Acesso negado",403);let{data:q}=await c.from("kanban_columns").select("id, board_id, stage_key, position, sla_hours, name").eq("id",h.column_id).maybeSingle();if(!q||"aprovacao"!==q.stage_key)return f("Esta tarefa n\xe3o est\xe1 aguardando aprova\xe7\xe3o",400);let{data:E}=await c.from("kanban_boards").select("id, name, area_key").eq("id",h.board_id).maybeSingle(),{data:A}=await c.from("kanban_columns").select("id, stage_key, position, name").eq("board_id",h.board_id).order("position",{ascending:!0}),x=A||[],j=Number(q.position||0),R=x.filter(e=>Number(e.position)>j);function C(e){return R.find(a=>e.includes(String(a.stage_key||"")))||x.find(a=>e.includes(String(a.stage_key||"")))}let I=null;if(!(I="approve"===k?C(["agendamento_publicacao","publicacao","enviar","lancamento"])||C(["finalizado"])||R[0]||null:C(["ajustes","ajustes_pos_aprovacao"])||x.find(e=>String(e.stage_key||"").includes("producao"))||x.find(e=>String(e.stage_key||"").includes("escopo"))||null))return f("N\xe3o encontrei coluna de destino para esta a\xe7\xe3o",500);let N=new Date().toISOString(),O=h.reference_links||{},P=O.client_approval||{},U=Number(q.sla_hours||48),D={action:k,comment:S||null,by_user_id:s.id,by_name:p?.full_name||null,by_email:p?.email||null,at:N,from_column_id:h.column_id,to_column_id:I.id},B={...P||{},requested_at:P.requested_at||h.updated_at||h.created_at||N,due_at:P.due_at||m(String(P.requested_at||h.updated_at||h.created_at||N),U),status:"approve"===k?"approved":"changes_requested",last_action_at:N,last_action_by:s.id,history:Array.isArray(P.history)?[...P.history,D]:[D]},L={...O,client_approval:B},{error:T}=await c.from("kanban_tasks").update({column_id:I.id,status:"approve"===k?"in_progress":"in_review",reference_links:L,updated_at:N}).eq("id",h.id);if(T)return f(T.message||"Falha ao atualizar tarefa",500);let $=h.assigned_to||h.created_by;try{$&&await c.from("notifications").insert({user_id:String($),type:"client_approval",title:"approve"===k?"Cliente aprovou":"Cliente solicitou ajustes",message:`${"approve"===k?"Aprovado":"Ajustes solicitados"}: ${h.title}${S?` — ${S}`:""}`,is_read:!1,link:"/app/kanban",metadata:{task_id:h.id,action:k,board_id:h.board_id,area_key:E?.area_key||null},created_at:N})}catch{}try{await (0,u.Q)({area:E?.name||String(E?.area_key||"Head de Marketing"),title:"approve"===k?"Cliente aprovou":"Cliente solicitou ajustes",message:`${h.title}${S?` — ${S}`:""}`,link:"/app/kanban",type:"client_approval",metadata:{task_id:h.id,action:k,area_key:E?.area_key||null}})}catch{}return o.NextResponse.json({success:!0})}let k=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/client/approvals/route",pathname:"/api/client/approvals",filename:"route",bundlePath:"app/api/client/approvals/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\approvals\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:S,staticGenerationAsyncStorage:b,serverHooks:v}=k,h="/api/client/approvals/route";function w(){return(0,s.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:b})}},14399:(e,a,t)=>{t.d(a,{Q:()=>n});var r=t(90176);function i(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}async function n(e){let a=(0,r.t)(),{data:t}=await a.from("employees").select("user_id, department, areas, is_active").eq("is_active",!0),n=(t||[]).filter(a=>a?.user_id&&function(e,a){let t=i(e),r=a.department?i(a.department):"",n=Array.isArray(a.areas)?a.areas.map(i):[];if(!t)return!1;if(r===t||n.includes(t)||r.includes(t)||t.includes(r)||n.some(e=>e.includes(t)||t.includes(e)))return!0;let s={operacao:["operacao","operacional","ops"],financeiro:["financeiro","finance","cobranca","cobran\xe7a"],comercial:["comercial","vendas","sales"],juridico:["juridico","juridico/compliance","compliance"],contratos:["contratos","contract"],notificacoes:["notificacoes","notificacoes-e-alertas","notificacoes/alertas"],rh:["rh","people","pessoas"]}[t]||[];return!!(s.length>0&&(s.some(e=>r.includes(e))||s.some(e=>n.some(a=>a.includes(e)))))}(e.area,a)).map(e=>String(e.user_id));if(0===n.length){let t={user_id:null,title:e.title,message:e.message,type:e.type||"workflow",is_read:!1,link:e.link??"/admin/fluxos",metadata:{...e.metadata||{},area:e.area,audience:"area"},created_at:new Date().toISOString()};try{await a.from("notifications").insert(t)}catch{}return}let s=n.map(a=>({user_id:a,title:e.title,message:e.message,type:e.type||"workflow",is_read:!1,link:e.link??"/colaborador/notificacoes",metadata:{...e.metadata||{},area:e.area,audience:"area"},created_at:new Date().toISOString()}));try{await a.from("notifications").insert(s)}catch{}}},90176:(e,a,t)=>{t.d(a,{t:()=>i});var r=t(54128);function i(){let e="https://ikjgsqtykkhqimypacro.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!a)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,r.eI)(e,a,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var a=require("../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),r=a.X(0,[89276,55972,54128,20958],()=>t(19715));module.exports=r})();