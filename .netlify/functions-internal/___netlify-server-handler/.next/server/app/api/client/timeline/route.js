"use strict";(()=>{var e={};e.id=15794,e.ids=[15794],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},73572:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>x,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>_});var r={};a.r(r),a.d(r,{GET:()=>d,POST:()=>u});var n=a(49303),i=a(88716),s=a(60670),o=a(87070),l=a(20344),c=a(71615);async function d(e){let t=(0,l.createRouteHandlerClient)({cookies:c.cookies}),{data:{user:a},error:r}=await t.auth.getUser();if(r||!a)return o.NextResponse.json({error:"N\xe3o autorizado"},{status:401});try{let{data:e}=await t.from("clients").select("id, created_at").eq("user_id",a.id).single();if(!e)return o.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});let{data:r,error:n}=await t.from("client_timeline_events").select("*").eq("client_id",e.id).order("event_date",{ascending:!0});n&&"PGRST116"!==n.code&&console.log("Tabela n\xe3o existe, gerando eventos autom\xe1ticos");let i=[];return i=r&&0!==r.length?r.map(e=>({id:e.id,date:e.event_date,title:e.title,description:e.description,type:e.event_type,metrics:e.metrics,image:e.image_url})):await m(t,e.id,e.created_at),o.NextResponse.json({success:!0,events:i})}catch(e){return console.error("Erro ao buscar timeline:",e),o.NextResponse.json({error:e.message},{status:500})}}async function u(e){let t=(0,l.createRouteHandlerClient)({cookies:c.cookies}),{data:{user:a},error:r}=await t.auth.getUser();if(r||!a)return o.NextResponse.json({error:"N\xe3o autorizado"},{status:401});try{let{title:r,description:n,type:i,date:s,metrics:l,imageUrl:c}=await e.json(),{data:d}=await t.from("clients").select("id").eq("user_id",a.id).single();if(!d)return o.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});let{data:u,error:m}=await t.from("client_timeline_events").insert({client_id:d.id,event_date:s,title:r,description:n,event_type:i,metrics:l||null,image_url:c||null}).select().single();if(m)throw m;return o.NextResponse.json({success:!0,event:u})}catch(e){return console.error("Erro ao criar evento:",e),o.NextResponse.json({error:e.message},{status:500})}}async function m(e,t,a){let r=[],n=new Date(a);r.push({id:"start",date:a,title:"In\xedcio da Parceria",description:"Come\xe7amos nossa jornada juntos! An\xe1lise inicial e defini\xe7\xe3o de estrat\xe9gia.",type:"milestone",metrics:await p(e,t,n)});let{data:i}=await e.from("marketing_campaigns").select("id, name, start_date, results").eq("client_id",t).order("start_date",{ascending:!0}).limit(5);if(i)for(let a of i)r.push({id:a.id,date:a.start_date,title:a.name,description:"Lan\xe7amento de nova campanha estrat\xe9gica.",type:"campaign",metrics:await p(e,t,new Date(a.start_date))});let{data:s}=await e.from("client_achievements").select("*").eq("client_id",t).order("earned_at",{ascending:!0});if(s)for(let e of s)r.push({id:e.id,date:e.earned_at,title:e.title,description:e.description,type:"achievement"});let{data:o}=await e.from("social_metrics_snapshots").select("*").eq("client_id",t).order("snapshot_date",{ascending:!0});if(o&&o.length>0){let e=o.filter((e,t)=>t%3==0);for(let t=1;t<e.length;t++){let a=e[t],n=e[t-1];r.push({id:`metrics-${t}`,date:a.snapshot_date,title:"Resultados do Trimestre",description:"Evolu\xe7\xe3o das m\xe9tricas no per\xedodo.",type:"metric",metrics:[{label:"Seguidores",before:n.followers_count||0,after:a.followers_count||0},{label:"Engajamento",before:n.engagement_rate||0,after:a.engagement_rate||0,unit:"%"},{label:"Alcance",before:n.reach_count||0,after:a.reach_count||0}]})}}return r.sort((e,t)=>new Date(e.date).getTime()-new Date(t.date).getTime()),r}async function p(e,t,a){let{data:r}=await e.from("social_metrics_snapshots").select("*").eq("client_id",t).lte("snapshot_date",a.toISOString()).order("snapshot_date",{ascending:!1}).limit(1).single();return r?[{label:"Seguidores",before:r.followers_count,after:r.followers_count},{label:"Engajamento",before:r.engagement_rate,after:r.engagement_rate,unit:"%"},{label:"Alcance",before:r.reach_count,after:r.reach_count}]:[{label:"Seguidores",before:0,after:0},{label:"Engajamento",before:0,after:0,unit:"%"},{label:"Alcance",before:0,after:0}]}let f=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/client/timeline/route",pathname:"/api/client/timeline",filename:"route",bundlePath:"app/api/client/timeline/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\timeline\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:_,serverHooks:h}=f,x="/api/client/timeline/route";function w(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:_})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>a(73572));module.exports=r})();