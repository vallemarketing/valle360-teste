"use strict";exports.id=72586,exports.ids=[72586],exports.modules={90176:(e,t,n)=>{n.d(t,{t:()=>a});var o=n(54128);function a(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,o.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},51547:(e,t,n)=>{n.d(t,{F:()=>O,getProviderStatus:()=>E});var o=n(90176);function a(e){let t=e.match(/\{[\s\S]*\}|\[[\s\S]*\]/);if(!t)throw Error("Resposta n\xe3o cont\xe9m JSON");return JSON.parse(t[0])}function r(e){if(!e)return null;try{return JSON.parse(e)}catch{return null}}function i(e){return e?Array.isArray(e)?e.map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?[e.trim()].filter(Boolean):[]:[]}async function s(e){try{let t=(0,o.t)();await t.from("audit_logs").insert({user_id:e.userId||null,action:e.action,entity_type:e.entityType||"ai",entity_id:e.entityId||null,old_values:null,new_values:e.newValues,ip_address:null,user_agent:null,created_at:new Date().toISOString()})}catch{}}let c=null;async function l(){if(c&&Date.now()-c.fetchedAt<6e4)return{apiKey:c.apiKey,config:c.config};let e=null,t=null;try{let n=(0,o.t)(),{data:a}=await n.from("integration_configs").select("api_key, config").eq("integration_id","openrouter").single();e=a?.api_key||null,t=a?.config||null}catch{}return e=e||process.env.OPENROUTER_API_KEY||null,c={fetchedAt:Date.now(),apiKey:e,config:t},{apiKey:e,config:t}}function p(e){return e?"string"==typeof e?r(e):"object"==typeof e?e:null:null}async function u(e="general"){let t=process.env.OPENROUTER_MODEL;if(t)return[t].filter(Boolean);let{config:n}=await l(),o=n?.model?String(n.model).trim():"";if(o)return[o];let a=r(process.env.OPENROUTER_MODEL_POLICY_JSON),s=p(n?.model_policy)||p(n?.modelPolicy)||a||{default:["openrouter/auto"],general:["openrouter/auto"],analysis:["anthropic/claude-3.5-sonnet","openrouter/auto"],strategy:["anthropic/claude-3.5-sonnet","openrouter/auto"],kanban_insights:["anthropic/claude-3.5-sonnet","openrouter/auto"],kanban_message:["openai/gpt-4o","openrouter/auto"],copywriting:["openai/gpt-4o","openrouter/auto"],sales:["openai/gpt-4o","openrouter/auto"],sentiment:["google/gemini-1.5-pro","openrouter/auto"],classification:["google/gemini-1.5-pro","openrouter/auto"],hr:["anthropic/claude-3.5-sonnet","openrouter/auto"]},c=[...i(s[e]),...i(s.default),"openrouter/auto"],u=new Set,m=[];for(let e of c){let t=String(e).trim();!t||u.has(t)||(u.add(t),m.push(t))}return m.length?m:["openrouter/auto"]}async function m(){try{let e=(0,o.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","anthropic").single();if(t?.api_key)return t.api_key}catch{}return process.env.ANTHROPIC_API_KEY||null}async function d(){try{let e=(0,o.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","openai").single();if(t?.api_key)return t.api_key}catch{}return process.env.OPENAI_API_KEY||null}async function g(){try{let e=(0,o.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","gemini").single();if(t?.api_key)return t.api_key}catch{}return process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY||null}async function y(e,t,n){let o=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json","HTTP-Referer":process.env.NEXT_PUBLIC_APP_URL||"http://localhost","X-Title":"Valle 360"},body:JSON.stringify({model:t,messages:e.messages,temperature:e.temperature??.7,max_tokens:e.maxTokens??1024,response_format:e.json?{type:"json_object"}:void 0})}),a=await o.text();if(!o.ok)throw Error(`OpenRouter error (${o.status}): ${a.slice(0,500)}`);let r=JSON.parse(a),i=r?.choices?.[0]?.message?.content||"";return{provider:"openrouter",model:r?.model||t,text:i,usage:r?.usage}}async function f(e){let{apiKey:t}=await l();if(!t)throw Error("OPENROUTER_API_KEY n\xe3o configurada");let n=await u(e.task),o=Date.now(),r=[];for(let c of n)try{let r=await y(e,c,t);return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:r.provider,model:r.model,ok:!0,ms:Date.now()-o,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json,openrouter_models_tried:n}}),e.json&&(r.json=a(r.text)),r}catch(t){var i;let e=t?.message||String(t);if(r.push({model:c,error:e}),!(!(i=function(e){let t=e.match(/OpenRouter error \\((\\d+)\\):/);if(!t?.[1])return null;let n=Number(t[1]);return Number.isFinite(n)?n:null}(e))||401!==i&&403!==i&&(429===i||408===i||i>=500&&i<=599||400===i&&/model|not found|no such|invalid/i.test(e))))break}let c=r.map(e=>`${e.model}: ${e.error}`).join(" | ");throw Error(`OpenRouter falhou em ${r.length} tentativa(s). ${c}`)}async function x(e){let t=await m();if(!t)throw Error("ANTHROPIC_API_KEY n\xe3o configurada");let n=function(e="general"){return process.env.ANTHROPIC_MODEL||"claude-3-5-sonnet-20241022"}(e.task),o=Date.now(),r=e.messages.find(e=>"system"===e.role)?.content,i=e.messages.filter(e=>"system"!==e.role).map(e=>`${e.role.toUpperCase()}: ${e.content}`).join("\n\n"),c=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":t,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:n,max_tokens:e.maxTokens??1024,temperature:e.temperature??.7,system:e.json?`${r||""}

Responda APENAS com um JSON v\xe1lido, sem texto extra.`:r,messages:[{role:"user",content:i}]})}),l=await c.text();if(!c.ok)throw Error(`Claude error (${c.status}): ${l.slice(0,500)}`);let p=JSON.parse(l),u=p?.content?.[0]?.text||"",d={provider:"claude",model:n,text:u,usage:p?.usage};return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:d.provider,model:d.model,ok:!0,ms:Date.now()-o,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(d.json=a(u)),d}async function h(e){let t=await d();if(!t)throw Error("OPENAI_API_KEY n\xe3o configurada");let n=function(e="general"){return process.env.OPENAI_MODEL||"gpt-4o-mini"}(e.task),o=Date.now(),r=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:n,messages:e.messages,temperature:e.temperature??.7,max_tokens:e.maxTokens??1024,response_format:e.json?{type:"json_object"}:void 0})}),i=await r.text();if(!r.ok)throw Error(`OpenAI error (${r.status}): ${i.slice(0,500)}`);let c=JSON.parse(i),l=c?.choices?.[0]?.message?.content||"",p={provider:"openai",model:c?.model||n,text:l,usage:c?.usage};return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:p.provider,model:p.model,ok:!0,ms:Date.now()-o,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(p.json=a(l)),p}async function _(e){let t=await g();if(!t)throw Error("GOOGLE_GEMINI_API_KEY/GOOGLE_CLOUD_API_KEY n\xe3o configurada");let n=function(e="general"){return process.env.GEMINI_MODEL||"gemini-1.5-flash"}(e.task),o=Date.now(),r=e.messages.find(e=>"system"===e.role)?.content,i=e.messages.filter(e=>"system"!==e.role).map(e=>`${e.role.toUpperCase()}: ${e.content}`).join("\n\n"),c=e.json?`${r||""}

Responda APENAS com um JSON v\xe1lido, sem texto extra.

${i}`:`${r||""}

${i}`,l=`https://generativelanguage.googleapis.com/v1beta/models/${n}:generateContent?key=${encodeURIComponent(t)}`,p=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:c}]}],generationConfig:{temperature:e.temperature??.7,maxOutputTokens:e.maxTokens??1024}})}),u=await p.text();if(!p.ok)throw Error(`Gemini error (${p.status}): ${u.slice(0,500)}`);let m=JSON.parse(u),d=m?.candidates?.[0]?.content?.parts?.map(e=>e.text).join("")||"",y={provider:"gemini",model:n,text:d,usage:m?.usageMetadata};return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:y.provider,model:y.model,ok:!0,ms:Date.now()-o,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(y.json=a(d)),y}function E(){return{openrouter:!!process.env.OPENROUTER_API_KEY,claude:!!process.env.ANTHROPIC_API_KEY,openai:!!process.env.OPENAI_API_KEY,gemini:!!(process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY)}}async function O(e){let t=e.correlationId||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),n={...e,correlationId:t},o=[];for(let e of[{provider:"openrouter",fn:f},{provider:"claude",fn:x},{provider:"openai",fn:h},{provider:"gemini",fn:_}])try{return await e.fn(n)}catch(r){let a=r?.message||String(r);o.push({provider:e.provider,error:a}),await s({userId:n.actorUserId||null,action:"ai.request_failed",entityType:n.entityType||"ai",entityId:n.entityId||null,newValues:{provider:e.provider,ok:!1,error:a.slice(0,500),task:n.task||"general",correlation_id:t,json:!!n.json}})}let a=o.map(e=>`${e.provider}: ${e.error}`).join(" | ");throw Error(`Falha em todos os provedores. ${a}`)}},72586:(e,t,n)=>{n.d(t,{It:()=>r,Jk:()=>c,ed:()=>i,i5:()=>a,pv:()=>l,y3:()=>s});var o=n(51547);async function a(e){let t=`Voc\xea \xe9 um consultor de neg\xf3cios s\xeanior especializado em ag\xeancias de marketing digital.
Analise os dados fornecidos e gere insights estrat\xe9gicos ACION\xc1VEIS.

Retorne um JSON com array "insights" contendo 5-8 insights:
{
  "insights": [
    {
      "id": "uuid \xfanico",
      "type": "opportunity" | "risk" | "trend" | "recommendation" | "alert",
      "priority": "critical" | "high" | "medium" | "low",
      "title": "T\xedtulo curto e impactante (max 60 chars)",
      "description": "Descri\xe7\xe3o detalhada do insight (2-3 frases)",
      "impact": "Impacto quantificado (ex: 'Potencial de R$ 50k/m\xeas')",
      "action": "A\xe7\xe3o espec\xedfica e execut\xe1vel",
      "actionType": "link" | "button" | "automation",
      "actionTarget": "/caminho/para/acao ou nome_do_botao",
      "metrics": { "chave": "valor" },
      "confidence": 0.0-1.0,
      "category": "financeiro" | "operacional" | "comercial" | "rh" | "cliente"
    }
  ]
}

Foque em:
1. Oportunidades de upsell/cross-sell
2. Clientes em risco de churn
3. Gargalos operacionais
4. Tend\xeancias de mercado
5. Otimiza\xe7\xe3o de receita`;try{return((await (0,o.F)({task:"strategy",json:!0,temperature:.7,maxTokens:1400,entityType:"ai_insights",entityId:null,messages:[{role:"system",content:t},{role:"user",content:`Dados para an\xe1lise:
${JSON.stringify(e,null,2)}`}]})).json||{}).insights||[]}catch(e){throw console.error("Erro ao gerar insights:",e),e}}async function r(e){let t=`Voc\xea \xe9 um especialista em Customer Success.
Analise os dados do cliente e retorne um JSON com:
{
  "healthScore": 0-100,
  "riskLevel": "low" | "medium" | "high" | "critical",
  "predictedChurn": 0.0-1.0 (probabilidade de churn nos pr\xf3ximos 90 dias),
  "insights": [
    {
      "id": "uuid",
      "type": "risk" | "opportunity" | "recommendation",
      "priority": "critical" | "high" | "medium" | "low",
      "title": "T\xedtulo",
      "description": "Descri\xe7\xe3o",
      "impact": "Impacto",
      "action": "A\xe7\xe3o recomendada",
      "confidence": 0.0-1.0,
      "category": "cliente"
    }
  ],
  "recommendations": ["Lista de 3-5 a\xe7\xf5es priorit\xe1rias"]
}`;try{return(await (0,o.F)({task:"analysis",json:!0,temperature:.5,maxTokens:1200,entityType:"client_health",entityId:e.clientId||null,messages:[{role:"system",content:t},{role:"user",content:JSON.stringify(e)}]})).json}catch(e){throw console.error("Erro ao analisar cliente:",e),e}}async function i(e){let t=`Voc\xea \xe9 um analista financeiro especializado em ag\xeancias.
Analise os dados e gere previs\xf5es para os pr\xf3ximos 6 meses.

Retorne um JSON com:
{
  "forecast": [
    { "month": "2024-01", "predicted": 150000, "confidence": 0.85 }
  ],
  "insights": [array de AIInsight focados em finan\xe7as],
  "risks": ["Lista de riscos financeiros identificados"],
  "opportunities": ["Lista de oportunidades de otimiza\xe7\xe3o"]
}`;try{return(await (0,o.F)({task:"analysis",json:!0,temperature:.5,maxTokens:1400,entityType:"financial_forecast",entityId:null,messages:[{role:"system",content:t},{role:"user",content:JSON.stringify(e)}]})).json}catch(e){throw console.error("Erro ao gerar previs\xe3o:",e),e}}async function s(e){let t=`Voc\xea \xe9 um social media expert.
Crie conte\xfado para ${e.platform}.
Especifica\xe7\xf5es: ${{instagram:"Post de Instagram com emojis, hashtags relevantes, max 2200 caracteres",linkedin:"Post profissional para LinkedIn, tom corporativo, 1300 caracteres ideal",facebook:"Post para Facebook, engajador, pode ser mais longo",twitter:"Tweet conciso, max 280 caracteres, impactante"}[e.platform]}

Retorne um JSON:
{
  "title": "T\xedtulo/Hook do post",
  "content": "Conte\xfado completo do post",
  "suggestions": ["3 varia\xe7\xf5es alternativas"],
  "hashtags": ["hashtags", "relevantes"],
  "callToAction": "CTA sugerido"
}`;try{return(await (0,o.F)({task:"copywriting",json:!0,temperature:.8,maxTokens:1200,entityType:"social_content",entityId:null,messages:[{role:"system",content:t},{role:"user",content:`Tema: ${e.topic}
Tom: ${e.tone}
Marca: ${e.clientBrand||"Gen\xe9rico"}
Palavras-chave: ${e.keywords?.join(", ")||"Nenhuma"}`}]})).json}catch(e){throw console.error("Erro ao gerar conte\xfado:",e),e}}async function c(e){let t=`Voc\xea \xe9 um especialista em comunica\xe7\xe3o corporativa.
Crie um ${{cobranca:"Email de cobran\xe7a educado mas firme",followup:"Email de follow-up para manter relacionamento",proposta:"Email apresentando proposta comercial",boas_vindas:"Email de boas-vindas para novo cliente",feedback:"Email solicitando feedback/NPS",upsell:"Email sugerindo servi\xe7os adicionais"}[e.type]}.
Tom: ${e.tone||"amigavel"}

Retorne um JSON:
{
  "subject": "Assunto do email (max 60 chars)",
  "body": "Corpo do email em HTML simples",
  "followUpSuggestion": "Sugest\xe3o de pr\xf3ximo passo"
}`;try{return(await (0,o.F)({task:"copywriting",json:!0,temperature:.7,maxTokens:1100,entityType:"email_generate",entityId:null,messages:[{role:"system",content:t},{role:"user",content:`Para: ${e.recipientName}${e.recipientCompany?` (${e.recipientCompany})`:""}
Contexto: ${e.context}`}]})).json}catch(e){throw console.error("Erro ao gerar email:",e),e}}async function l(e){let t=`Voc\xea \xe9 um especialista em RH e recrutamento.
Crie uma descri\xe7\xe3o de vaga atraente e completa.

Retorne um JSON:
{
  "title": "T\xedtulo otimizado da vaga",
  "description": "Descri\xe7\xe3o geral da posi\xe7\xe3o (2-3 par\xe1grafos)",
  "requirements": ["Lista de requisitos"],
  "responsibilities": ["Lista de responsabilidades"],
  "benefits": ["Lista de benef\xedcios"],
  "callToAction": "Frase de chamada para aplica\xe7\xe3o"
}`;try{return(await (0,o.F)({task:"hr",json:!0,temperature:.7,maxTokens:1400,entityType:"job_description",entityId:null,messages:[{role:"system",content:t},{role:"user",content:JSON.stringify(e)}]})).json}catch(e){throw console.error("Erro ao gerar vaga:",e),e}}n(61894)},61894:(e,t,n)=>{n.d(t,{su:()=>u});let o="https://language.googleapis.com";function a(){let e=process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY||process.env.GOOGLE_NLP_API_KEY;if(!e)throw Error("Google Cloud API Key n\xe3o configurada. Configure GOOGLE_GEMINI_API_KEY ou GOOGLE_CLOUD_API_KEY.");return e}async function r(e,t="pt-BR"){let n=a(),r=await fetch(`${o}/v2/documents:analyzeSentiment?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({document:{type:"PLAIN_TEXT",content:e,languageCode:t},encodingType:"UTF8"})});if(!r.ok){let e=await r.json();throw Error(`Google NLP Error: ${e.error?.message||r.statusText}`)}let i=await r.json();return{documentSentiment:{score:i.documentSentiment?.score||0,magnitude:i.documentSentiment?.magnitude||0},sentences:(i.sentences||[]).map(e=>({text:e.text?.content||"",sentiment:{score:e.sentiment?.score||0,magnitude:e.sentiment?.magnitude||0}})),language:i.languageCode||t}}async function i(e,t="pt-BR"){let n=a(),r=await fetch(`${o}/v1/documents:analyzeEntitySentiment?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({document:{type:"PLAIN_TEXT",content:e,language:t.split("-")[0]},encodingType:"UTF8"})});if(!r.ok){let e=await r.json();throw Error(`Google NLP Error: ${e.error?.message||r.statusText}`)}let i=await r.json();return{entities:(i.entities||[]).map(e=>({name:e.name,type:e.type||"UNKNOWN",salience:e.salience||0,metadata:e.metadata||{},mentions:(e.mentions||[]).map(t=>({text:t.text?.content||e.name,type:t.type||"TYPE_UNKNOWN",probability:1})),sentiment:{score:e.sentiment?.score||0,magnitude:e.sentiment?.magnitude||0}})),language:i.language||t}}async function s(e,t="pt-BR"){let n=a(),r=await fetch(`${o}/v1/documents:analyzeSyntax?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({document:{type:"PLAIN_TEXT",content:e,language:t.split("-")[0]},encodingType:"UTF8"})});if(!r.ok){let e=await r.json();throw Error(`Google NLP Error: ${e.error?.message||r.statusText}`)}let i=await r.json();return{tokens:(i.tokens||[]).map(e=>({text:e.text?.content||"",partOfSpeech:{tag:e.partOfSpeech?.tag||"UNKNOWN",voice:e.partOfSpeech?.voice||"VOICE_UNKNOWN",tense:e.partOfSpeech?.tense||"TENSE_UNKNOWN",mood:e.partOfSpeech?.mood||"",person:e.partOfSpeech?.person||"",number:e.partOfSpeech?.number||""},lemma:e.lemma||"",dependencyEdge:{headTokenIndex:e.dependencyEdge?.headTokenIndex||0,label:e.dependencyEdge?.label||""}})),sentences:(i.sentences||[]).map(e=>({text:e.text?.content||""})),language:i.language||t}}async function c(e,t="pt-BR"){let n=a();if(e.split(/\s+/).length<20)throw Error("Classifica\xe7\xe3o de texto requer pelo menos 20 palavras.");let r=await fetch(`${o}/v1/documents:classifyText?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({document:{type:"PLAIN_TEXT",content:e,language:t.split("-")[0]},classificationModelOptions:{v2Model:{contentCategoriesVersion:"V2"}}})});if(!r.ok){let e=await r.json();throw Error(`Google NLP Error: ${e.error?.message||r.statusText}`)}return{categories:((await r.json()).categories||[]).map(e=>({name:e.name,confidence:e.confidence||0})),language:t}}async function l(e,t={}){let n,o,a;let l=t.language||"pt-BR",[p,u]=await Promise.all([r(e,l),i(e,l)]);if(t.includeSyntax)try{n=await s(e,l)}catch(e){console.warn("Erro na an\xe1lise de sintaxe:",e)}if(t.includeClassification&&e.split(/\s+/).length>=20)try{o=await c(e,l)}catch(e){console.warn("Erro na classifica\xe7\xe3o:",e)}let m=p.documentSentiment.score;a=m>.25?"positive":m<-.25?"negative":"neutral";let d=u.entities.filter(e=>e.salience>.1).slice(0,5).map(e=>{let t;return t=e.sentiment?e.sentiment.score>.25?"positive":e.sentiment.score<-.25?"negative":"neutral":"unknown",{name:e.name,type:e.type,sentiment:t}}),g=o?.categories.filter(e=>e.confidence>.5).map(e=>e.name.split("/").pop()||e.name)||[],y=[];"positive"===a?y.push("O texto expressa sentimento predominantemente positivo"):"negative"===a&&y.push("O texto expressa sentimento predominantemente negativo - requer aten\xe7\xe3o");let f=d.filter(e=>"positive"===e.sentiment),x=d.filter(e=>"negative"===e.sentiment);return f.length>0&&y.push(`Men\xe7\xf5es positivas: ${f.map(e=>e.name).join(", ")}`),x.length>0&&y.push(`Men\xe7\xf5es negativas: ${x.map(e=>e.name).join(", ")}`),{sentiment:p,entities:u,syntax:n,classification:o,summary:{overallSentiment:a,mainEntities:d,topics:g,keyInsights:y}}}async function p(e,t="pt-BR"){let n;let o=[];for(let n=0;n<e.length;n+=5){let a=e.slice(n,n+5),s=await Promise.all(a.map(async e=>{let[n,o]=await Promise.all([r(e,t),i(e,t)]);return{text:e,sentiment:n,entities:o.entities}}));o.push(...s)}let a=o.map(e=>e.sentiment.documentSentiment.score),s=a.reduce((e,t)=>e+t,0)/a.length;n=s>.25?"positive":s<-.25?"negative":"neutral";let c=new Map;return o.forEach(e=>{e.entities.forEach(e=>{let t=e.name.toLowerCase(),n=c.get(t)||{count:0,totalSentiment:0};c.set(t,{count:n.count+1,totalSentiment:n.totalSentiment+(e.sentiment?.score||0)})})}),{results:o,aggregate:{averageScore:s,overallSentiment:n,topEntities:Array.from(c.entries()).map(([e,t])=>({name:e,count:t.count,avgSentiment:t.totalSentiment/t.count})).sort((e,t)=>t.count-e.count).slice(0,10)}}}let u={analyzeSentiment:r,analyzeEntities:async function(e,t="pt-BR"){let n=a(),r=await fetch(`${o}/v2/documents:analyzeEntities?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({document:{type:"PLAIN_TEXT",content:e,languageCode:t},encodingType:"UTF8"})});if(!r.ok){let e=await r.json();throw Error(`Google NLP Error: ${e.error?.message||r.statusText}`)}let i=await r.json();return{entities:(i.entities||[]).map(e=>({name:e.name,type:e.type||"UNKNOWN",salience:e.salience||0,metadata:e.metadata||{},mentions:(e.mentions||[]).map(t=>({text:t.text?.content||e.name,type:t.type||"TYPE_UNKNOWN",probability:t.probability||0})),sentiment:e.sentiment?{score:e.sentiment.score,magnitude:e.sentiment.magnitude}:void 0})),language:i.languageCode||t}},analyzeEntitySentiment:i,analyzeSyntax:s,classifyText:c,analyzeFullText:l,analyzeBatch:p}}};