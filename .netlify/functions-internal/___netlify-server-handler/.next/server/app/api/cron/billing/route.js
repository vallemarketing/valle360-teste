"use strict";(()=>{var e={};e.id=60401,e.ids=[60401],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},38170:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>_,patchFetch:()=>h,requestAsyncStorage:()=>y,routeModule:()=>m,serverHooks:()=>v,staticGenerationAsyncStorage:()=>g});var a={};n.r(a),n.d(a,{GET:()=>l});var r=n(49303),i=n(88716),o=n(60670),s=n(87070);let c=(0,n(54128).eI)("https://ikjgsqtykkhqimypacro.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),d=[{daysOverdue:0,type:"due_today",channel:"email"},{daysOverdue:3,type:"first_reminder",channel:"email"},{daysOverdue:7,type:"second_reminder",channel:"email"},{daysOverdue:15,type:"urgent_reminder",channel:"email_whatsapp"},{daysOverdue:30,type:"final_notice",channel:"email_whatsapp"}];async function l(e){try{if(e.headers.get("authorization")!==`Bearer ${process.env.CRON_SECRET}`&&process.env.CRON_SECRET)return s.NextResponse.json({error:"Unauthorized"},{status:401});let t=new Date;t.setHours(0,0,0,0),console.log("[CRON] Running billing automation");let n={dueTodayNotified:0,overdueProcessed:0,reminderssentEmail:0,remindersSentWhatsApp:0,errors:0},{data:a,error:r}=await c.from("invoices").select(`
        *,
        clients (
          id,
          company_name,
          email,
          phone,
          contact_name
        ),
        contracts (
          id,
          services
        )
      `).in("status",["pending","overdue"]).order("due_date",{ascending:!0});if(r)return console.error("Error fetching invoices:",r),s.NextResponse.json({error:"Failed to fetch invoices"},{status:500});if(!a||0===a.length)return console.log("[CRON] No pending invoices"),s.NextResponse.json({message:"No invoices to process",...n});for(let e of a)try{let a=new Date(e.due_date);a.setHours(0,0,0,0);let r=Math.floor((t.getTime()-a.getTime())/864e5);r>0&&"pending"===e.status&&await c.from("invoices").update({status:"overdue",days_overdue:r,updated_at:new Date().toISOString()}).eq("id",e.id);let i=d.find(e=>e.daysOverdue===r);if(!i)continue;let{data:o}=await c.from("billing_reminders").select("id").eq("invoice_id",e.id).eq("reminder_type",i.type).single();if(o)continue;let s=e.clients;if(!s)continue;let l=0,m=0;r>0&&(l=.02*e.amount,m=.01*e.amount*Math.ceil(r/30));let y=e.amount+l+m;i.channel.includes("email")&&s.email&&(await u({to:s.email,clientName:s.contact_name||s.company_name,invoiceId:e.id,amount:e.amount,lateFee:l,interest:m,totalDue:y,dueDate:a.toLocaleDateString("pt-BR"),daysOverdue:r,reminderType:i.type}),n.reminderssentEmail++),i.channel.includes("whatsapp")&&s.phone&&(await p({phone:s.phone,clientName:s.contact_name||s.company_name,amount:y,dueDate:a.toLocaleDateString("pt-BR"),reminderType:i.type}),n.remindersSentWhatsApp++),await c.from("billing_reminders").insert({invoice_id:e.id,client_id:s.id,reminder_type:i.type,channel:i.channel,sent_at:new Date().toISOString(),metadata:{daysOverdue:r,amount:e.amount,lateFee:l,interest:m,totalDue:y}}),0===r?n.dueTodayNotified++:n.overdueProcessed++}catch(t){console.error(`Error processing invoice ${e.id}:`,t),n.errors++}try{await c.from("cron_logs").insert({job_name:"billing_automation",run_at:new Date().toISOString(),status:0===n.errors?"success":"partial",result:n})}catch{}return console.log("[CRON] Billing complete:",n),s.NextResponse.json({success:!0,...n})}catch(e){return console.error("[CRON] Billing error:",e),s.NextResponse.json({error:e.message||"Cron job failed"},{status:500})}}async function u(e){let t={due_today:"Lembrete: Sua fatura vence hoje",first_reminder:`Aviso: Fatura em atraso (${e.daysOverdue} dias)`,second_reminder:`Importante: Fatura pendente h\xe1 ${e.daysOverdue} dias`,urgent_reminder:"Urgente: Regularize sua fatura em atraso",final_notice:`\xdaltimo aviso: Fatura pendente h\xe1 ${e.daysOverdue} dias`}[e.reminderType]||"Lembrete de fatura";await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/email/send`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to:e.to,subject:t,template:"billing_reminder",data:{clientName:e.clientName,invoiceId:e.invoiceId,amount:e.amount.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),lateFee:e.lateFee.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),interest:e.interest.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),totalDue:e.totalDue.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),dueDate:e.dueDate,daysOverdue:e.daysOverdue,paymentLink:`${process.env.NEXT_PUBLIC_APP_URL}/pay/${e.invoiceId}`}})}).catch(console.error)}async function p(e){let t={urgent_reminder:`Ol\xe1 ${e.clientName}! ðŸ“‹

Sua fatura de ${e.amount.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})} com vencimento em ${e.dueDate} est\xe1 pendente.

Por favor, regularize para evitar encargos.

D\xfavidas? Responda esta mensagem.`,final_notice:`âš ï¸ ${e.clientName}, \xfaltimo aviso!

Sua fatura de ${e.amount.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})} est\xe1 em atraso desde ${e.dueDate}.

Regularize imediatamente para evitar suspens\xe3o dos servi\xe7os.

Precisa de ajuda? Responda aqui.`}[e.reminderType];if(!t)return;let n=process.env.EVOLUTION_API_URL,a=process.env.EVOLUTION_API_KEY;n&&a&&await fetch(`${n}/message/sendText/Valle360`,{method:"POST",headers:{"Content-Type":"application/json",apikey:a},body:JSON.stringify({number:e.phone.replace(/\D/g,""),text:t})}).catch(console.error)}let m=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/cron/billing/route",pathname:"/api/cron/billing",filename:"route",bundlePath:"app/api/cron/billing/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\cron\\billing\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:g,serverHooks:v}=m,_="/api/cron/billing/route";function h(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:g})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[89276,55972,54128],()=>n(38170));module.exports=a})();