"use strict";exports.id=44518,exports.ids=[44518],exports.modules={51547:(e,t,r)=>{r.d(t,{F:()=>w,getProviderStatus:()=>v});var n=r(90176);function o(e){let t=e.match(/\{[\s\S]*\}|\[[\s\S]*\]/);if(!t)throw Error("Resposta n\xe3o cont\xe9m JSON");return JSON.parse(t[0])}function a(e){if(!e)return null;try{return JSON.parse(e)}catch{return null}}function i(e){return e?Array.isArray(e)?e.map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?[e.trim()].filter(Boolean):[]:[]}async function s(e){try{let t=(0,n.t)();await t.from("audit_logs").insert({user_id:e.userId||null,action:e.action,entity_type:e.entityType||"ai",entity_id:e.entityId||null,old_values:null,new_values:e.newValues,ip_address:null,user_agent:null,created_at:new Date().toISOString()})}catch{}}let c=null;async function l(){if(c&&Date.now()-c.fetchedAt<6e4)return{apiKey:c.apiKey,config:c.config};let e=null,t=null;try{let r=(0,n.t)(),{data:o}=await r.from("integration_configs").select("api_key, config").eq("integration_id","openrouter").single();e=o?.api_key||null,t=o?.config||null}catch{}return e=e||process.env.OPENROUTER_API_KEY||null,c={fetchedAt:Date.now(),apiKey:e,config:t},{apiKey:e,config:t}}function u(e){return e?"string"==typeof e?a(e):"object"==typeof e?e:null:null}async function d(e="general"){let t=process.env.OPENROUTER_MODEL;if(t)return[t].filter(Boolean);let{config:r}=await l(),n=r?.model?String(r.model).trim():"";if(n)return[n];let o=a(process.env.OPENROUTER_MODEL_POLICY_JSON),s=u(r?.model_policy)||u(r?.modelPolicy)||o||{default:["openrouter/auto"],general:["openrouter/auto"],analysis:["anthropic/claude-3.5-sonnet","openrouter/auto"],strategy:["anthropic/claude-3.5-sonnet","openrouter/auto"],kanban_insights:["anthropic/claude-3.5-sonnet","openrouter/auto"],kanban_message:["openai/gpt-4o","openrouter/auto"],copywriting:["openai/gpt-4o","openrouter/auto"],sales:["openai/gpt-4o","openrouter/auto"],sentiment:["google/gemini-1.5-pro","openrouter/auto"],classification:["google/gemini-1.5-pro","openrouter/auto"],hr:["anthropic/claude-3.5-sonnet","openrouter/auto"]},c=[...i(s[e]),...i(s.default),"openrouter/auto"],d=new Set,p=[];for(let e of c){let t=String(e).trim();!t||d.has(t)||(d.add(t),p.push(t))}return p.length?p:["openrouter/auto"]}async function p(){try{let e=(0,n.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","anthropic").single();if(t?.api_key)return t.api_key}catch{}return process.env.ANTHROPIC_API_KEY||null}async function m(){try{let e=(0,n.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","openai").single();if(t?.api_key)return t.api_key}catch{}return process.env.OPENAI_API_KEY||null}async function _(){try{let e=(0,n.t)(),{data:t}=await e.from("integration_configs").select("api_key").eq("integration_id","gemini").single();if(t?.api_key)return t.api_key}catch{}return process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY||null}async function f(e,t,r){let n=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json","HTTP-Referer":process.env.NEXT_PUBLIC_APP_URL||"http://localhost","X-Title":"Valle 360"},body:JSON.stringify({model:t,messages:e.messages,temperature:e.temperature??.7,max_tokens:e.maxTokens??1024,response_format:e.json?{type:"json_object"}:void 0})}),o=await n.text();if(!n.ok)throw Error(`OpenRouter error (${n.status}): ${o.slice(0,500)}`);let a=JSON.parse(o),i=a?.choices?.[0]?.message?.content||"";return{provider:"openrouter",model:a?.model||t,text:i,usage:a?.usage}}async function y(e){let{apiKey:t}=await l();if(!t)throw Error("OPENROUTER_API_KEY n\xe3o configurada");let r=await d(e.task),n=Date.now(),a=[];for(let c of r)try{let a=await f(e,c,t);return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:a.provider,model:a.model,ok:!0,ms:Date.now()-n,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json,openrouter_models_tried:r}}),e.json&&(a.json=o(a.text)),a}catch(t){var i;let e=t?.message||String(t);if(a.push({model:c,error:e}),!(!(i=function(e){let t=e.match(/OpenRouter error \\((\\d+)\\):/);if(!t?.[1])return null;let r=Number(t[1]);return Number.isFinite(r)?r:null}(e))||401!==i&&403!==i&&(429===i||408===i||i>=500&&i<=599||400===i&&/model|not found|no such|invalid/i.test(e))))break}let c=a.map(e=>`${e.model}: ${e.error}`).join(" | ");throw Error(`OpenRouter falhou em ${a.length} tentativa(s). ${c}`)}async function g(e){let t=await p();if(!t)throw Error("ANTHROPIC_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.ANTHROPIC_MODEL||"claude-3-5-sonnet-20241022"}(e.task),n=Date.now(),a=e.messages.find(e=>"system"===e.role)?.content,i=e.messages.filter(e=>"system"!==e.role).map(e=>`${e.role.toUpperCase()}: ${e.content}`).join("\n\n"),c=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":t,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:r,max_tokens:e.maxTokens??1024,temperature:e.temperature??.7,system:e.json?`${a||""}

Responda APENAS com um JSON v\xe1lido, sem texto extra.`:a,messages:[{role:"user",content:i}]})}),l=await c.text();if(!c.ok)throw Error(`Claude error (${c.status}): ${l.slice(0,500)}`);let u=JSON.parse(l),d=u?.content?.[0]?.text||"",m={provider:"claude",model:r,text:d,usage:u?.usage};return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:m.provider,model:m.model,ok:!0,ms:Date.now()-n,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(m.json=o(d)),m}async function h(e){let t=await m();if(!t)throw Error("OPENAI_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.OPENAI_MODEL||"gpt-4o-mini"}(e.task),n=Date.now(),a=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:r,messages:e.messages,temperature:e.temperature??.7,max_tokens:e.maxTokens??1024,response_format:e.json?{type:"json_object"}:void 0})}),i=await a.text();if(!a.ok)throw Error(`OpenAI error (${a.status}): ${i.slice(0,500)}`);let c=JSON.parse(i),l=c?.choices?.[0]?.message?.content||"",u={provider:"openai",model:c?.model||r,text:l,usage:c?.usage};return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:u.provider,model:u.model,ok:!0,ms:Date.now()-n,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(u.json=o(l)),u}async function x(e){let t=await _();if(!t)throw Error("GOOGLE_GEMINI_API_KEY/GOOGLE_CLOUD_API_KEY n\xe3o configurada");let r=function(e="general"){return process.env.GEMINI_MODEL||"gemini-1.5-flash"}(e.task),n=Date.now(),a=e.messages.find(e=>"system"===e.role)?.content,i=e.messages.filter(e=>"system"!==e.role).map(e=>`${e.role.toUpperCase()}: ${e.content}`).join("\n\n"),c=e.json?`${a||""}

Responda APENAS com um JSON v\xe1lido, sem texto extra.

${i}`:`${a||""}

${i}`,l=`https://generativelanguage.googleapis.com/v1beta/models/${r}:generateContent?key=${encodeURIComponent(t)}`,u=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:c}]}],generationConfig:{temperature:e.temperature??.7,maxOutputTokens:e.maxTokens??1024}})}),d=await u.text();if(!u.ok)throw Error(`Gemini error (${u.status}): ${d.slice(0,500)}`);let p=JSON.parse(d),m=p?.candidates?.[0]?.content?.parts?.map(e=>e.text).join("")||"",f={provider:"gemini",model:r,text:m,usage:p?.usageMetadata};return await s({userId:e.actorUserId||null,action:"ai.request",entityType:e.entityType||"ai",entityId:e.entityId||null,newValues:{provider:f.provider,model:f.model,ok:!0,ms:Date.now()-n,task:e.task||"general",correlation_id:e.correlationId,json:!!e.json}}),e.json&&(f.json=o(m)),f}function v(){return{openrouter:!!process.env.OPENROUTER_API_KEY,claude:!!process.env.ANTHROPIC_API_KEY,openai:!!process.env.OPENAI_API_KEY,gemini:!!(process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_CLOUD_API_KEY)}}async function w(e){let t=e.correlationId||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),r={...e,correlationId:t},n=[];for(let e of[{provider:"openrouter",fn:y},{provider:"claude",fn:g},{provider:"openai",fn:h},{provider:"gemini",fn:x}])try{return await e.fn(r)}catch(a){let o=a?.message||String(a);n.push({provider:e.provider,error:o}),await s({userId:r.actorUserId||null,action:"ai.request_failed",entityType:r.entityType||"ai",entityId:r.entityId||null,newValues:{provider:e.provider,ok:!1,error:o.slice(0,500),task:r.task||"general",correlation_id:t,json:!!r.json}})}let o=n.map(e=>`${e.provider}: ${e.error}`).join(" | ");throw Error(`Falha em todos os provedores. ${o}`)}},17478:(e,t,r)=>{r.d(t,{k:()=>s});var n=r(87070),o=r(20344),a=r(71615),i=r(54128);async function s(e){let t=(0,a.cookies)(),r=(0,o.createRouteHandlerClient)({cookies:()=>t}),s=e.headers.get("authorization")||"",c=s.toLowerCase().startsWith("bearer ")?s.slice(7).trim():null,l=c?(0,i.eI)("https://ikjgsqtykkhqimypacro.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",{global:{headers:{Authorization:`Bearer ${c}`}},auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}):r,{data:u}=await l.auth.getUser();if(!u.user?.id)return{ok:!1,res:n.NextResponse.json({error:"N\xe3o autorizado"},{status:401})};let{data:d,error:p}=await l.rpc("is_admin");return p||!d?{ok:!1,res:n.NextResponse.json({error:"Acesso negado (admin)"},{status:403})}:{ok:!0,userId:u.user.id}}},31683:(e,t,r)=>{r.d(t,{Ph:()=>u,e$:()=>l,kG:()=>c,tJ:()=>s});var n=r(90176),o=r(79263),a=r(90530);async function i(e){try{let t=await e();if(t?.error)return null;if(t&&"object"==typeof t&&"data"in t)return t.data;return t}catch(e){return function(e){let t=String(e||"").toLowerCase();t.includes("does not exist")||t.includes("relation")||t.includes("schema cache")||t.includes("could not find the table")}(e?.message||""),null}}async function s(e){let t=(0,n.t)(),r=new Date().toISOString(),a=[],s=e.includeEventLog??!0,c=e.includeKanban??!0,l=s?await i(()=>t.from("event_log").select("id, event_type, entity_type, entity_id, created_at, metadata").order("created_at",{ascending:!1}).limit(30)):[];s&&!l&&a.push("event_log");let u=c?await i(()=>t.from("kanban_tasks").select("id, title, status, priority, due_date, updated_at, created_at, board_id, column_id, area, client_id").order("updated_at",{ascending:!1}).limit(25)):[];c&&!u&&a.push("kanban_tasks");let d="cfo"===e.role?await i(()=>t.from("invoices").select("id, client_id, due_date, amount, status, created_at, paid_at").is("paid_at",null).order("due_date",{ascending:!0}).limit(30)):[];"cfo"!==e.role||d||a.push("invoices");let p="chro"===e.role?await i(()=>t.from("employee_requests").select("id, type, title, start_date, end_date, status, created_at, user_id").eq("status","pending").order("created_at",{ascending:!1}).limit(20)):[];"chro"!==e.role||p||a.push("employee_requests");let m=await i(()=>t.from("ai_executives").select("id, role, name, title").eq("role",e.role).maybeSingle()),_=m?.id?String(m.id):null;_||a.push("ai_executives");let f=_?await i(()=>t.from("ai_executive_knowledge").select("id, knowledge_type, category, key, value, confidence, source, valid_from, valid_until, times_referenced, updated_at").eq("executive_id",_).order("times_referenced",{ascending:!1,nullsFirst:!1}).order("updated_at",{ascending:!1}).limit(20)):[];if(_&&!f&&a.push("ai_executive_knowledge"),_&&!0===e.touchKnowledge&&Array.isArray(f)&&f.length)try{let e=f.slice(0,10);await Promise.all(e.filter(e=>e?.id).map(e=>t.from("ai_executive_knowledge").update({times_referenced:Number(e?.times_referenced||0)+1}).eq("id",String(e.id))))}catch{}let y=_?await i(()=>t.from("ai_executive_decisions").select("id, decision_type, category, title, status, rationale, lessons_learned, created_at, updated_at, meeting_id").eq("proposed_by",_).order("created_at",{ascending:!1}).limit(10)):[];_&&!y&&a.push("ai_executive_decisions");let g=_?await i(()=>t.from("ai_executive_web_searches").select("id, query, purpose, provider, model, sources, created_at").eq("executive_id",_).order("created_at",{ascending:!1}).limit(6)):[];_&&!g&&a.push("ai_executive_web_searches");let h=[];if(e.includePredictions??!0){let t=function(e){switch(e){case"cfo":return["payment_risk","revenue","ltv","churn"];case"cco":return["churn","payment_risk","ltv"];case"coo":return["demand_capacity","delay","budget_overrun"];case"cmo":return["conversion","churn","revenue"];case"cto":return["demand_capacity","performance"];case"chro":return["performance","demand_capacity"];default:return["payment_risk","churn","revenue","demand_capacity","budget_overrun","conversion"]}}(e.role),r=Math.max(0,Math.min(100,Number(e.predictionMinConfidence??55)));h=(await Promise.all(t.map(e=>o.t.getPredictions({type:e,min_confidence:r})))).flat().slice(0,60)}return{now:r,role:e.role,signals:{predictions:h},data:{executive:m?{id:_,role:m.role,name:m.name,title:m.title}:null,eventLog:l||[],recentTasks:u||[],overdueInvoices:d||[],pendingRequests:p||[],knowledge:f||[],recentDecisions:y||[],recentWebSearches:g||[]},missing:a}}async function c(e){try{let t=await (0,a.y)({query:e.query}),r=(0,n.t)(),o="sonar";try{await r.from("ai_executive_web_searches").insert({executive_id:e.executiveId,query:e.query,purpose:e.purpose,provider:"perplexity",model:o,answer:t.answer,sources:t.sources})}catch{}return{answer:t.answer,sources:t.sources,model:o}}catch(t){let e=String(t?.message||"indispon\xedvel");return{answer:`⚠️ Contexto de mercado indispon\xedvel agora (Perplexity Sonar): ${e}.
N\xe3o invente n\xfameros nem fontes; se precisar, pe\xe7a para configurar a integra\xe7\xe3o Perplexity (db/env).`,sources:[],model:"sonar"}}}let l=`MODO CONSULTIVO (IMPORTANTE):
- Voc\xea N\xc3O executa integra\xe7\xf5es com terceiros automaticamente.
- Voc\xea pode sugerir CTAs e rascunhos de a\xe7\xf5es, mas a execu\xe7\xe3o s\xf3 acontece ap\xf3s confirma\xe7\xe3o humana.
- N\xe3o invente n\xfameros. Se faltar dado, diga o que falta e proponha como coletar.
- Sempre entregue: (1) Diagn\xf3stico curto, (2) 3 a\xe7\xf5es priorit\xe1rias, (3) 1 alerta se houver, (4) como medir.`;function u(e){return"chro"===e?"hr":"cmo"===e||"ceo"===e?"strategy":"analysis"}},17743:(e,t,r)=>{r.d(t,{G:()=>n,U:()=>o});let n=["ceo","cfo","cmo","cto","coo","cco","chro"];function o(e){let t=String(e||"").trim().toLowerCase();return n.includes(t)?t:null}},90530:(e,t,r)=>{r.d(t,{y:()=>a});var n=r(90176);async function o(){try{let e=(0,n.t)(),{data:t}=await e.from("integration_configs").select("api_key, config, status").eq("integration_id","perplexity").maybeSingle(),r=t?.api_key?String(t.api_key):null,o=String(t?.config?.model||"").trim()||"sonar";if(r)return{apiKey:r,model:o};return{apiKey:process.env.PERPLEXITY_API_KEY||null,model:o}}catch{return{apiKey:process.env.PERPLEXITY_API_KEY||null,model:"sonar"}}}async function a(e){let t=await o(),r=t.apiKey;if(!r)throw Error("PERPLEXITY_API_KEY n\xe3o configurada (db/env)");let n=String(e.model||t.model||"sonar").trim()||"sonar",a=e.timeoutMs??25e3,i=new AbortController,s=setTimeout(()=>i.abort(),a);try{let t=await fetch("https://api.perplexity.ai/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({model:n,temperature:.2,max_tokens:900,messages:[{role:"system",content:"Voc\xea \xe9 um mecanismo de pesquisa web. Responda em portugu\xeas do Brasil, de forma objetiva. Sempre que poss\xedvel, inclua fontes confi\xe1veis (URLs)."},{role:"user",content:e.query}]}),signal:i.signal}),o=await t.text();if(!t.ok)throw Error(`Perplexity error (${t.status}): ${o.slice(0,300)}`);let a=o?JSON.parse(o):{},s=a?.choices?.[0]?.message?.content||a?.choices?.[0]?.text||"",c=a?.citations||a?.choices?.[0]?.citations||a?.choices?.[0]?.message?.citations||a?.references,l=function(e){let t=[],r=e=>{if(e){if("string"==typeof e){let r=e.trim();r&&t.push(r);return}if("object"==typeof e){let r=e.url||e.link||e.href||e.source;"string"==typeof r&&r.trim()&&t.push(r.trim())}}};return Array.isArray(e)?e.forEach(r):r(e),Array.from(new Set(t))}(c);return!l.length&&(l=Array.from(new Set((s.match(/https?:\/\/[^\s)]+/g)||[]).map(e=>e.replace(/[.,;]+$/,""))))),{answer:String(s||"").trim(),sources:l}}finally{clearTimeout(s)}}}};