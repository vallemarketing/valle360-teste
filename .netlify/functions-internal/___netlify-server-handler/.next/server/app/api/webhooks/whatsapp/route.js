"use strict";(()=>{var e={};e.id=85162,e.ids=[85162],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},70554:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>w,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>g,serverHooks:()=>_,staticGenerationAsyncStorage:()=>y});var r={};s.r(r),s.d(r,{GET:()=>c,POST:()=>m,dynamic:()=>d});var a=s(49303),n=s(88716),o=s(60670),i=s(87070),p=s(54128),u=s(39449);let d="force-dynamic";async function c(e){let{searchParams:t}=new URL(e.url),s=t.get("hub.mode"),r=t.get("hub.verify_token"),a=t.get("hub.challenge");if(!s||!r||!a)return i.NextResponse.json({error:"Par\xe2metros ausentes"},{status:400});let n="https://ikjgsqtykkhqimypacro.supabase.co",o=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!n||!o)return i.NextResponse.json({error:"Configura\xe7\xe3o inv\xe1lida"},{status:500});let d=(0,p.eI)(n,o),{data:c}=await d.from("integration_configs").select("webhook_secret").eq("integration_id","whatsapp").single(),m=c?.webhook_secret||process.env.WHATSAPP_VERIFY_TOKEN;if(!m)return i.NextResponse.json({error:"Verify token n\xe3o configurado"},{status:400});let h=(0,u.lW)(s,r,a,m);return h?new i.NextResponse(h,{status:200}):i.NextResponse.json({error:"Verifica\xe7\xe3o falhou"},{status:403})}async function m(e){try{let t="https://ikjgsqtykkhqimypacro.supabase.co",s=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!t||!s)return i.NextResponse.json({error:"Configura\xe7\xe3o inv\xe1lida"},{status:500});let r=(0,p.eI)(t,s),a=await e.json();if("whatsapp_business_account"!==a.object)return i.NextResponse.json({error:"Payload inv\xe1lido"},{status:400});let{messages:n,statuses:o}=(0,u.nw)(a);for(let e of n)await h(e,r);for(let e of o)await l(e,r);return await r.from("integration_logs").insert({integration_id:"whatsapp",action:"webhook_received",status:"success",request_data:{messagesCount:n.length,statusesCount:o.length}}),i.NextResponse.json({received:!0})}catch(e){return console.error("Erro no webhook WhatsApp:",e),i.NextResponse.json({error:"Erro interno",details:e.message},{status:500})}}async function h(e,t){try{let{data:s}=await t.from("whatsapp_conversations").select("id").eq("phone_number",e.from).single();if(!s){let{data:r}=await t.from("whatsapp_conversations").insert({phone_number:e.from,contact_name:e.name,status:"active",created_at:new Date().toISOString()}).select("id").single();s=r}await t.from("whatsapp_messages").insert({conversation_id:s?.id,whatsapp_message_id:e.id,direction:"incoming",type:e.type,content:"string"==typeof e.content?e.content:JSON.stringify(e.content),timestamp:e.timestamp.toISOString(),status:"received"}),await t.from("whatsapp_conversations").update({last_message:"string"==typeof e.content?e.content:"[M\xeddia]",last_message_at:e.timestamp.toISOString(),unread_count:t.raw("unread_count + 1")}).eq("id",s?.id)}catch(e){console.error("Erro ao processar mensagem:",e)}}async function l(e,t){try{await t.from("whatsapp_messages").update({status:e.status,status_updated_at:e.timestamp.toISOString(),error_message:e.error}).eq("whatsapp_message_id",e.messageId),"failed"===e.status&&e.error&&await t.from("integration_logs").insert({integration_id:"whatsapp",action:"message_failed",status:"error",error_message:e.error,request_data:{messageId:e.messageId,to:e.to}})}catch(e){console.error("Erro ao processar status:",e)}}let g=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/webhooks/whatsapp/route",pathname:"/api/webhooks/whatsapp",filename:"route",bundlePath:"app/api/webhooks/whatsapp/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\webhooks\\whatsapp\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:y,serverHooks:_}=g,w="/api/webhooks/whatsapp/route";function b(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:y})}},39449:(e,t,s)=>{s.d(t,{SP:()=>n,lW:()=>o,nw:()=>i});let r="https://graph.facebook.com/v18.0";class a{constructor(e){this.accessToken=e.accessToken,this.phoneNumberId=e.phoneNumberId,this.businessId=e.businessId}async request(e,t={}){let s=`${r}${e}`,a=await fetch(s,{...t,headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json",...t.headers}}),n=await a.json();if(n.error)throw Error(`WhatsApp API Error: ${n.error.message}`);return n}async sendTextMessage(e,t,s=!1){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"text",text:{preview_url:s,body:t}})})}async sendImage(e,t,s){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"image",image:{link:t,caption:s}})})}async sendDocument(e,t,s,r){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"document",document:{link:t,filename:s,caption:r}})})}async sendTemplate(e,t,s="pt_BR",r){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"template",template:{name:t,language:{code:s},components:r}})})}async sendInteractiveButtons(e,t,s,r,a){let n={type:"button",body:{text:t},action:{buttons:s.map(e=>({type:"reply",reply:{id:e.id,title:e.title}}))}};return r&&(n.header={type:"text",text:r}),a&&(n.footer={text:a}),this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"interactive",interactive:n})})}async sendInteractiveList(e,t,s,r,a,n){let o={type:"list",body:{text:t},action:{button:s,sections:r}};return a&&(o.header={type:"text",text:a}),n&&(o.footer={text:n}),this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:this.formatPhoneNumber(e),type:"interactive",interactive:o})})}async markAsRead(e){return this.request(`/${this.phoneNumberId}/messages`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",status:"read",message_id:e})})}async uploadMedia(e,t,s){let a;let n=new FormData;return e instanceof ArrayBuffer?a=e:(Array.isArray(e),a=new Uint8Array(e)),n.append("file",new Blob([a],{type:t}),s),n.append("messaging_product","whatsapp"),n.append("type",t),(await fetch(`${r}/${this.phoneNumberId}/media`,{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`},body:n})).json()}async getMediaUrl(e){return this.request(`/${e}`)}async listTemplates(){if(!this.businessId)throw Error("Business ID n\xe3o configurado");return this.request(`/${this.businessId}/message_templates`)}async getBusinessProfile(){return this.request(`/${this.phoneNumberId}/whatsapp_business_profile?fields=about,address,description,email,profile_picture_url,websites,vertical`)}async updateBusinessProfile(e){return this.request(`/${this.phoneNumberId}/whatsapp_business_profile`,{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",...e})})}formatPhoneNumber(e){let t=e.replace(/\D/g,"");return!t.startsWith("55")&&t.length<=11&&(t="55"+t),t}}function n(e){return new a(e)}function o(e,t,s,r){return"subscribe"===e&&t===r?s:null}function i(e){let t=[],s=[];for(let r of e.entry)for(let e of r.changes){let r=e.value;if(r.messages)for(let e of r.messages){let s=r.contacts?.find(t=>t.wa_id===e.from);t.push({from:e.from,name:s?.profile?.name,id:e.id,timestamp:new Date(1e3*parseInt(e.timestamp)),type:e.type,content:e.text?.body||e.image||e.document||e.button||e.interactive})}if(r.statuses)for(let e of r.statuses)s.push({messageId:e.id,status:e.status,timestamp:new Date(1e3*parseInt(e.timestamp)),to:e.recipient_id,error:e.errors?.[0]?.title})}return{messages:t,statuses:s}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[89276,55972,54128],()=>s(70554));module.exports=r})();