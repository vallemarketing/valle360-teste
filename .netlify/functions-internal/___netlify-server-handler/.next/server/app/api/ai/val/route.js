"use strict";(()=>{var e={};e.id=88934,e.ids=[88934],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},39191:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>k,patchFetch:()=>P,requestAsyncStorage:()=>x,routeModule:()=>b,serverHooks:()=>v,staticGenerationAsyncStorage:()=>w});var n={};a.r(n),a.d(n,{GET:()=>h,POST:()=>_,dynamic:()=>p});var s=a(49303),i=a(88716),r=a(60670),o=a(87070),l=a(20344),c=a(71615),u=a(51547),d=a(63576),m=a(90530);let p="force-dynamic";function g(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}function y(e){let t=[e.department?g(e.department):"",...Array.isArray(e.areas)?e.areas.map(e=>g(String(e))):[]].filter(Boolean).join(" ");return t.includes("comercial")||t.includes("vendas")?"comercial":t.includes("financeiro")||t.includes("finance")||t.includes("cobranca")||t.includes("cobran")?"financeiro":t.includes("rh")||t.includes("people")||t.includes("pessoas")?"rh":t.includes("juridico")||t.includes("compliance")?"juridico":t.includes("contratos")||t.includes("contract")?"contratos":t.includes("operacao")||t.includes("operacional")||t.includes("ops")?"operacao":t.includes("notificacao")||t.includes("alert")?"notificacoes":t.includes("trafego")||t.includes("ads")||t.includes("midia")||t.includes("m\xeddia")?"trafego":t.includes("social")?"social_media":t.includes("video")||t.includes("v\xeddeo")?"video_maker":t.includes("web")?"web_designer":t.includes("design")?"designer":"colaborador"}function f(e){let t=String(e||"").toLowerCase();return"comercial"===t?"sales":"rh"===t?"hr":"financeiro"===t||"trafego"===t?"analysis":"social_media"===t?"copywriting":"notificacoes"===t||"operacao"===t?"analysis":"super_admin"===t||"admin"===t?"strategy":"general"}async function _(e){try{let t;let a=(0,c.cookies)(),n=(0,l.createRouteHandlerClient)({cookies:()=>a}),{data:{user:s},error:i}=await n.auth.getUser();if(i||!s)return o.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{message:r,context:p,history:g}=await e.json();if(!r)return o.NextResponse.json({error:"Mensagem \xe9 obrigat\xf3ria"},{status:400});let{data:_}=await n.from("user_profiles").select("*").or(`id.eq.${s.id},user_id.eq.${s.id}`).maybeSingle(),h=_?.user_type||"employee",b=_?.full_name||s.email,x=_?.company_name,w=h;if("finance"===h&&(w="financeiro"),"hr"===h&&(w="rh"),"client"===h&&(w="cliente"),"employee"===h||"manager"===h){let{data:e}=await n.from("employees").select("department, areas").eq("user_id",s.id).maybeSingle();w=y({department:e?.department,areas:e?.areas})}let v=(0,d.my)(w),k={currentUser:b,userRole:w,currentDate:new Date().toLocaleDateString("pt-BR"),currentTime:new Date().toLocaleTimeString("pt-BR"),persona:v.name,...p};if(["super_admin","admin"].includes(w)){let[e,t,a,s]=await Promise.all([n.from("clients").select("id, company_name, contact_email").limit(20),n.from("tasks").select("*").in("status",["pending","in_progress"]).limit(10),n.from("sentiment_alerts").select("*").eq("status","pending").limit(5),n.from("contracts").select("monthly_value, status").eq("status","active")]);k={...k,totalClients:e.data?.length||0,recentClients:e.data?.slice(0,5).map(e=>e.company_name||e.contact_email)||[],pendingTasks:t.data?.length||0,pendingAlerts:a.data?.length||0,activeContracts:s.data?.length||0,monthlyRevenue:s.data?.reduce((e,t)=>e+(t.monthly_value||0),0)||0}}else if("comercial"===w){let[e,t]=await Promise.all([n.from("leads").select("*").in("status",["new","contacted","qualified"]).limit(10),n.from("proposals").select("*").eq("status","pending").limit(5)]);k={...k,activeLeads:e.data?.length||0,pendingProposals:t.data?.length||0}}else if("financeiro"===w){let[e,t]=await Promise.all([n.from("contracts").select("*").eq("status","active"),n.from("contracts").select("*").eq("status","pending_payment")]);k={...k,activeContracts:e.data?.length||0,pendingPayments:t.data?.length||0,totalPending:t.data?.reduce((e,t)=>e+(t.monthly_value||0),0)||0}}else if("cliente"===w){let e=null;{let t=await n.from("clients").select("id, company_name, industry, segment, competitors, concorrentes").eq("user_id",s.id).maybeSingle();e=t.error?(await n.from("clients").select("id, company_name, industry").eq("user_id",s.id).maybeSingle()).data||null:t.data}let t=e?.id,a=String(e?.industry||""),i=String(e?.segment||""),r=Array.isArray(e?.competitors)?e.competitors.map(e=>String(e)).filter(Boolean):"string"==typeof e?.concorrentes?String(e.concorrentes).split(/[\n,;]+/g).map(e=>e.trim()).filter(Boolean):[],[o,l]=await Promise.all([t?n.from("kanban_tasks").select("*").eq("client_id",t).limit(10):n.from("kanban_tasks").select("*").limit(0),n.from("messages").select("*").eq("recipient_id",s.id).eq("is_read",!1).limit(5)]);k={...k,myTasks:o.data?.length||0,unreadMessages:l.data?.length||0,companyName:e?.company_name||x,industry:a||void 0,segment:i||void 0,competitors:r}}else{let[e,t]=await Promise.all([n.from("tasks").select("*").eq("assigned_to",s.id).in("status",["pending","in_progress"]).limit(10),n.from("kanban_tasks").select("id, title, priority, due_date, status, column_id, kanban_columns!inner(name, stage_key)").eq("assigned_to",s.id).not("status","eq","done").order("priority",{ascending:!1}).order("due_date",{ascending:!0,nullsFirst:!1}).limit(15)]),a=(t.data||[]).map(e=>({id:e.id,title:e.title,priority:e.priority,dueDate:e.due_date,status:e.status,column:e.kanban_columns?.name,stage:e.kanban_columns?.stage_key})),i=a.find(e=>"critical"===e.priority||"high"===e.priority||e.dueDate&&new Date(e.dueDate)<=new Date(Date.now()+864e5));k={...k,myPendingTasks:e.data?.length||0,kanbanTasks:a.slice(0,5),totalKanbanTasks:a.length,urgentTask:i?{title:i.title,priority:i.priority,dueDate:i.dueDate,column:i.column}:null,suggestedNextTask:i?.title||a[0]?.title||null}}let P=(0,d.gn)(w,{userName:b,companyName:x,additionalContext:`Contexto do neg\xf3cio:
${JSON.stringify(k,null,2)}`}),S=[{role:"system",content:P}];g&&Array.isArray(g)&&g.slice(-10).forEach(e=>{S.push({role:"user"===e.role?"user":"assistant",content:"string"==typeof e.content?e.content:JSON.stringify(e.content)})}),S.push({role:"user",content:r});let q=null;if(function(e){let t=String(e||"");return/(\bpesquis|\bbusca\b|\binternet\b|\bweb\b|\bnot[ií]cia|\batualizad|\bfonte(s)?\b|\blink(s)?\b)/i.test(t)}(r))try{let e=await (0,m.y)({query:r});if(q=e||null,e?.answer){let t=(e.sources||[]).slice(0,8).map(e=>`- ${e}`).join("\n"),a=`Pesquisa web (Perplexity Sonar) — use como base:

${e.answer}

`+(t?`Fontes (URLs):
${t}

`:"")+`Instru\xe7\xf5es: se voc\xea usar essa pesquisa, inclua no final da sua resposta uma se\xe7\xe3o "Fontes:" com os links (1 por linha).`;S.splice(Math.max(1,S.length-1),0,{role:"system",content:a})}}catch(e){String(e?.message||"").includes("PERPLEXITY_API_KEY")&&S.splice(Math.max(1,S.length-1),0,{role:"system",content:"Observa\xe7\xe3o: o usu\xe1rio pediu busca web com fontes, mas Perplexity n\xe3o est\xe1 configurado (db/env). Se necess\xe1rio, responda instruindo a conectar em Admin → Integra\xe7\xf5es → Perplexity (Sonar)."})}try{t=(await (0,u.F)({task:f(w),json:!0,temperature:.7,maxTokens:1500,actorUserId:s.id,entityType:"val",entityId:null,messages:S})).json}catch(a){let e=String(a?.message||"");t=e.includes("OPENROUTER_API_KEY")||e.includes("OPENAI_API_KEY")||e.includes("n\xe3o configurada")||e.includes("nao configurada")||e.includes("n\xe3o configurado")||e.includes("nao configurado")?{message:"A IA ainda n\xe3o est\xe1 conectada neste ambiente. Para ativar agora, v\xe1 em **Admin → Integra\xe7\xf5es** e conecte **OpenRouter** (recomendado) ou **OpenAI**.\n\nDepois disso eu j\xe1 consigo responder e automatizar tarefas com a Val.",suggestions:["Abrir Integra\xe7\xf5es","Conectar OpenRouter","Conectar OpenAI"],actions:[{label:"Abrir Integra\xe7\xf5es",action:"open_link",params:{url:"/admin/integracoes"}}],mood:"alert"}:{message:"N\xe3o consegui estruturar a resposta em JSON agora. Pode tentar novamente com uma pergunta mais direta?",suggestions:[],actions:[],mood:"neutral"}}t.persona={name:v.name,title:v.title,emoji:v.emoji},q?.sources?.length&&(t.sources=q.sources.slice(0,12),t.web={sources:q.sources.slice(0,12)});try{await n.from("val_interactions").insert({user_id:s.id,user_type:w,message:r,response:t.message,persona:v.name,context:k})}catch{}return o.NextResponse.json({success:!0,message:t?.message,response:t,sources:t?.sources||void 0,timestamp:new Date().toISOString()})}catch(e){return console.error("Erro na API da Val:",e),o.NextResponse.json({error:"Erro ao processar mensagem",details:e.message},{status:500})}}async function h(e){try{let e=(0,c.cookies)(),t=(0,l.createRouteHandlerClient)({cookies:()=>e}),{data:{user:a},error:n}=await t.auth.getUser();if(n||!a)return o.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:s}=await t.from("user_profiles").select("user_type, full_name").or(`id.eq.${a.id},user_id.eq.${a.id}`).maybeSingle(),i=s?.user_type||"employee",r=i;if("finance"===i&&(r="financeiro"),"hr"===i&&(r="rh"),"client"===i&&(r="cliente"),"employee"===i||"manager"===i){let{data:e}=await t.from("employees").select("department, areas").eq("user_id",a.id).maybeSingle();r=y({department:e?.department,areas:e?.areas})}let m=(0,d.my)(r),p={};if(["super_admin","admin"].includes(r)){let[e,a,n]=await Promise.all([t.from("sentiment_alerts").select("*").eq("status","pending").limit(3),t.from("tasks").select("*").eq("status","overdue").limit(5),t.from("contracts").select("*").eq("status","pending_payment").limit(3)]);p={pendingAlerts:e.data?.length||0,overdueTasks:a.data?.length||0,pendingPayments:n.data?.length||0}}let g=(await (0,u.F)({task:f(r),json:!0,temperature:.8,maxTokens:400,actorUserId:a.id,entityType:"val_suggestions",entityId:null,messages:[{role:"system",content:`Voc\xea \xe9 a ${m.name}. Gere 2-3 sugest\xf5es proativas curtas e relevantes para um ${r}.
Retorne JSON: { "suggestions": [{ "icon": "emoji", "text": "sugest\xe3o curta", "priority": "high/medium/low", "action": "a\xe7\xe3o_sugerida" }] }`},{role:"user",content:JSON.stringify({...p,currentTime:new Date().toLocaleTimeString("pt-BR"),dayOfWeek:new Date().toLocaleDateString("pt-BR",{weekday:"long"})})}]})).json||{suggestions:[]};return o.NextResponse.json({success:!0,persona:{name:m.name,title:m.title,emoji:m.emoji},quickActions:m.quickActions,suggestions:g.suggestions||[]})}catch(e){return console.error("Erro ao buscar sugest\xf5es:",e),o.NextResponse.json({success:!0,suggestions:[{icon:"\uD83D\uDC4B",text:"Ol\xe1! Como posso ajudar voc\xea hoje?",priority:"low"}]})}}let b=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/ai/val/route",pathname:"/api/ai/val",filename:"route",bundlePath:"app/api/ai/val/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\ai\\val\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:x,staticGenerationAsyncStorage:w,serverHooks:v}=b,k="/api/ai/val/route";function P(){return(0,r.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:w})}},90530:(e,t,a)=>{a.d(t,{y:()=>i});var n=a(90176);async function s(){try{let e=(0,n.t)(),{data:t}=await e.from("integration_configs").select("api_key, config, status").eq("integration_id","perplexity").maybeSingle(),a=t?.api_key?String(t.api_key):null,s=String(t?.config?.model||"").trim()||"sonar";if(a)return{apiKey:a,model:s};return{apiKey:process.env.PERPLEXITY_API_KEY||null,model:s}}catch{return{apiKey:process.env.PERPLEXITY_API_KEY||null,model:"sonar"}}}async function i(e){let t=await s(),a=t.apiKey;if(!a)throw Error("PERPLEXITY_API_KEY n\xe3o configurada (db/env)");let n=String(e.model||t.model||"sonar").trim()||"sonar",i=e.timeoutMs??25e3,r=new AbortController,o=setTimeout(()=>r.abort(),i);try{let t=await fetch("https://api.perplexity.ai/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({model:n,temperature:.2,max_tokens:900,messages:[{role:"system",content:"Voc\xea \xe9 um mecanismo de pesquisa web. Responda em portugu\xeas do Brasil, de forma objetiva. Sempre que poss\xedvel, inclua fontes confi\xe1veis (URLs)."},{role:"user",content:e.query}]}),signal:r.signal}),s=await t.text();if(!t.ok)throw Error(`Perplexity error (${t.status}): ${s.slice(0,300)}`);let i=s?JSON.parse(s):{},o=i?.choices?.[0]?.message?.content||i?.choices?.[0]?.text||"",l=i?.citations||i?.choices?.[0]?.citations||i?.choices?.[0]?.message?.citations||i?.references,c=function(e){let t=[],a=e=>{if(e){if("string"==typeof e){let a=e.trim();a&&t.push(a);return}if("object"==typeof e){let a=e.url||e.link||e.href||e.source;"string"==typeof a&&a.trim()&&t.push(a.trim())}}};return Array.isArray(e)?e.forEach(a):a(e),Array.from(new Set(t))}(l);return!c.length&&(c=Array.from(new Set((o.match(/https?:\/\/[^\s)]+/g)||[]).map(e=>e.replace(/[.,;]+$/,""))))),{answer:String(o||"").trim(),sources:c}}finally{clearTimeout(o)}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[89276,55972,54128,20958,58658],()=>a(39191));module.exports=n})();