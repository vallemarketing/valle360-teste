"use strict";(()=>{var e={};e.id=45501,e.ids=[45501],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},76261:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>y,requestAsyncStorage:()=>h,routeModule:()=>v,serverHooks:()=>$,staticGenerationAsyncStorage:()=>b});var n={};a.r(n),a.d(n,{GET:()=>g,dynamic:()=>d});var i=a(49303),o=a(88716),r=a(60670),s=a(87070),l=a(54128);let d="force-dynamic",c=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI",u=(0,l.eI)("https://ikjgsqtykkhqimypacro.supabase.co",c||"setup-missing",{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}});async function m(e){let t=e.headers.get("authorization")||e.headers.get("Authorization"),a=t?.startsWith("Bearer ")?t.slice(7):null;if(!a)return null;let{data:{user:n}}=await u.auth.getUser(a);return n||null}async function p(e){let{data:t}=await u.from("user_profiles").select("role").eq("user_id",e).maybeSingle(),a=(t?.role||"").toLowerCase();return"admin"===a||"super_admin"===a}function _(e){let t=new Date(e),a=Date.now()-t.getTime(),n=Math.floor(a/6e4),i=Math.floor(a/36e5);return n<1?"Agora":n<60?`H\xe1 ${n} minutos`:i<24?`H\xe1 ${i} horas`:`H\xe1 ${Math.floor(a/864e5)} dias`}function f(e){if(e&&"object"==typeof e){let t=e.value,a=Number(t);return Number.isFinite(a)?a:t??null}let t=Number(e);return Number.isFinite(t)?t:e??null}async function g(e){let t=await m(e);if(!t)return s.NextResponse.json({error:"N\xe3o autorizado"},{status:401});if(!await p(t.id))return s.NextResponse.json({error:"Acesso negado (admin)"},{status:403});try{let{count:e}=await u.from("clients").select("*",{count:"exact",head:!0}),{count:t}=await u.from("clients").select("*",{count:"exact",head:!0}).or("status.eq.active,status.eq.ativo,is_active.eq.true"),{count:a}=await u.from("employees").select("*",{count:"exact",head:!0}),{count:n}=await u.from("employees").select("*",{count:"exact",head:!0}).eq("is_active",!0),{data:i}=await u.from("contracts").select("monthly_value,status,active").limit(500),o=(i||[]).filter(e=>"active"===String(e.status||"").toLowerCase()||!0===e.active).reduce((e,t)=>e+Number(t.monthly_value||0),0),{count:r}=await u.from("kanban_tasks").select("*",{count:"exact",head:!0}).in("status",["backlog","todo","in_progress","in_review","blocked"]),l=new Date;l.setHours(0,0,0,0);let{count:d}=await u.from("kanban_tasks").select("*",{count:"exact",head:!0}).eq("status","done").gte("updated_at",l.toISOString()),{count:c}=await u.from("event_log").select("*",{count:"exact",head:!0}).eq("status","pending"),{count:m}=await u.from("workflow_transitions").select("*",{count:"exact",head:!0}).eq("status","pending"),p=Number(r||0)+Number(c||0)+Number(m||0),g=Number(c||0)>0?"events":"transitions",{data:v}=await u.from("event_log").select("id,event_type,created_at,status,payload,entity_type,entity_id").order("created_at",{ascending:!1}).limit(20),h=(v||[]).filter(e=>!function(e){let t=String(e||"").toLowerCase();return!!(!t||t.startsWith("telemetry.")||t.startsWith("page_view")||t.startsWith("health."))||"workflow_transition.updated"===t}(String(e?.event_type||""))).map(e=>{let t=String(e?.event_type||"system.event"),a=function(e){let t=String(e?.event_type||"system.event"),a=t.toLowerCase(),n=e?.payload||{},i=function(e){let t=String(e||"").toLowerCase();return"processed"===t?"Processado":"pending"===t?"Pendente":"error"===t?"Erro":t||"—"}(e?.status),o=t,r=`Status: ${i}`,s="alert",l=`/admin/fluxos?tab=events&status=${encodeURIComponent(String(e?.status||"pending"))}&q=${encodeURIComponent(t)}`;if(a.startsWith("workflow_transition.")){s="task",l="/admin/fluxos?tab=transitions";let e=n?.from_area||n?.prev_to_area||n?.from_area_key,t=n?.to_area||n?.next_to_area||n?.to_area_key,d=n?.note?String(n.note):null;if("workflow_transition.executed_to_kanban"===a){o="Demanda enviada para o Kanban";let a=n?.kanban_task_id?String(n.kanban_task_id):null,s=n?.kanban_board_id?String(n.kanban_board_id):null;s&&a&&(l=`/admin/meu-kanban?boardId=${encodeURIComponent(s)}&taskId=${encodeURIComponent(a)}`),r=`${e&&t?`${e} → ${t}`:"Transi\xe7\xe3o executada"} • ${i}`}else"workflow_transition.rerouted"===a?(o="Demanda encaminhada",r=`${n?.prev_to_area||e||"—"} → ${n?.next_to_area||t||"—"}${d?` • Nota: ${d}`:""} • ${i}`):"workflow_transition.reopened"===a?(o="Demanda reaberta",r=`${t||e||"Transi\xe7\xe3o"}${d?` • Nota: ${d}`:""} • ${i}`):"workflow_transition.error_resolved"===a?(o="Erro do fluxo resolvido",r=`${t||e||"Transi\xe7\xe3o"}${d?` • Nota: ${d}`:""} • ${i}`):"workflow_transition.marked_error"===a?(o="Fluxo marcado com erro",r=`${t||e||"Transi\xe7\xe3o"}${d?` • Nota: ${d}`:""} • ${i}`):(o="workflow_transition.completed"===a?"Fluxo conclu\xeddo":"Atualiza\xe7\xe3o de fluxo",r=`${t||e||"Transi\xe7\xe3o"} • ${i}`)}if("invoice.paid"===a){s="money",o="Pagamento confirmado";let e=n?.invoice_number?String(n.invoice_number):null,t=n?.amount?Number(n.amount):null;r=`${e?`Fatura ${e}`:"Fatura paga"}${t?` • R$ ${t.toLocaleString("pt-BR")}`:""} • ${i}`,l="/admin/financeiro"}if("invoice.payment_failed"===a){s="money",o="Falha no pagamento";let e=n?.invoice_number?String(n.invoice_number):null;r=`${e?`Fatura ${e}`:"Fatura"} • ${i}`,l="/admin/financeiro"}if("proposal.sent"===a){s="task",o="Proposta enviada";let e=n?.client_name?String(n.client_name):null;r=`${e?`Cliente: ${e}`:"Proposta marcada como enviada"} • ${i}`,l="/admin/comercial/propostas"}if("proposal.accepted"===a){s="task",o="Proposta aceita";let e=n?.client_name?String(n.client_name):null;r=`${e?`Cliente: ${e}`:"Cliente aceitou a proposta"} • ${i}`,l="/admin/comercial/propostas"}if("proposal.rejected"===a){s="task",o="Proposta recusada";let e=n?.client_name?String(n.client_name):null;r=`${e?`Cliente: ${e}`:"Cliente recusou a proposta"} • ${i}`,l="/admin/comercial/propostas"}if("client.created"===a){s="user",o="Novo cliente cadastrado";let e=n?.email?String(n.email):null;r=`${e||"Cliente criado"} • ${i}`,l="/admin/clientes"}if("employee.created"===a){s="user",o="Novo colaborador cadastrado";let e=n?.email?String(n.email):null;r=`${e||"Colaborador criado"} • ${i}`,l="/admin/colaboradores"}return"brute_force_detected"===a&&(s="alert",o="Alerta de seguran\xe7a",r=`Tentativas suspeitas de login detectadas • ${i}`,l="/admin/monitoramento-sentimento"),{title:o,description:r,icon:s,link:l}}(e);return{id:e.id,type:t,title:a.title,description:a.description,time:_(e.created_at),icon:a.icon,link:a.link}}).slice(0,6);try{let{data:e}=await u.from("ml_predictions_log").select("id,prediction_type,predicted_probability,predicted_at,predicted_value").order("predicted_at",{ascending:!1}).limit(50),t=e||[],a=e=>t.filter(t=>String(t?.prediction_type||"")===e).map(e=>({p:e,v:f(e.predicted_value)})).filter(e=>"number"==typeof e.v&&Number.isFinite(e.v)).sort((e,t)=>Number(t.v)-Number(e.v))[0]?.p||null,n=a("churn"),i=a("payment_risk"),o=a("demand_capacity"),r=a("budget_overrun"),s=[],l=(e,t,a)=>({id:`ml_${String(e.id)}`,type:`ml.${String(e.prediction_type||"prediction")}`,title:t,description:a,time:_(e.predicted_at||e.created_at||new Date().toISOString()),icon:"alert",link:"/admin/analytics/preditivo"});if(i){let e=Number(f(i.predicted_value)||0);e>=70&&s.push(l(i,"Risco de pagamento elevado (ML)",`Risco: ${Math.round(e)}% • A\xe7\xe3o: cobrar no Financeiro`))}if(o){let e=Number(f(o.predicted_value)||0);e>=85&&s.push(l(o,"Capacidade cr\xedtica (ML)",`Utiliza\xe7\xe3o: ${Math.round(e)}% • Revisar prioridades/RH`))}if(r){let e=Number(f(r.predicted_value)||0);e>=80&&s.push(l(r,"Risco de or\xe7amento (campanha) (ML)",`Risco: ${Math.round(e)}% • Revisar budget`))}if(n){let e=Number(f(n.predicted_value)||0);e>=70&&s.push(l(n,"Risco de churn (ML)",`Probabilidade: ${Math.round(e)}% • Priorizar reten\xe7\xe3o`))}s.length>0&&(h=[...s.slice(0,2),...h].slice(0,6))}catch{}if(!h||0===h.length){let{data:e}=await u.from("audit_logs").select("id,action,created_at,new_values").order("created_at",{ascending:!1}).limit(6);h=(e||[]).map(e=>{let t=String(e.action||"audit"),a=e.new_values||{},n=t.includes("invoice")||t.includes("payment")?"money":t.includes("client")||t.includes("employee")?"user":t.includes("proposal")||t.includes("goal")?"task":"alert";return{id:e.id,type:t,title:t.startsWith("workflow_transition.")?"Atualiza\xe7\xe3o de fluxo":t,description:String(a.description||"Log de auditoria"),time:_(e.created_at),icon:n,link:"/admin/auditoria"}})}let{data:b}=await u.from("clients").select("id,company_name,nome_fantasia,razao_social,contact_name,contact_email,contact_phone,whatsapp,created_at,monthly_value").order("created_at",{ascending:!1}).limit(5),$=(b||[]).map(e=>{let t=e.company_name||e.nome_fantasia||e.razao_social||"Cliente",a=e.contact_name||t,n=e.contact_email||"",i=e.contact_phone||e.whatsapp||"",o=e.created_at?new Date(e.created_at):new Date,r=7>=Math.floor((Date.now()-o.getTime())/864e5)?"novo":"em_dia",s=Number(e.monthly_value||0);return{id:e.id,name:a,company:t,email:n,phone:i,status:r,projectStatus:"novo"===r?"Onboarding":"Ativo",nextDelivery:"",contractValue:s?`R$ ${s.toLocaleString("pt-BR")}/m\xeas`:"—"}});return s.NextResponse.json({stats:{totalClients:e||0,activeClients:t||0,totalEmployees:a||0,activeEmployees:n||0,monthlyRevenue:o,pendingTasks:p,completedTasksToday:d||0,avgClientSatisfaction:0},hub:{pending:{kanban:Number(r||0),events:Number(c||0),transitions:Number(m||0),total:p},preferredTab:g,links:{pending:`/admin/fluxos?tab=${g}&status=pending`}},recentActivity:h,activeClients:$})}catch(e){return s.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let v=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/dashboard/route",pathname:"/api/admin/dashboard",filename:"route",bundlePath:"app/api/admin/dashboard/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\dashboard\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:h,staticGenerationAsyncStorage:b,serverHooks:$}=v,w="/api/admin/dashboard/route";function y(){return(0,r.patchFetch)({serverHooks:$,staticGenerationAsyncStorage:b})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[89276,55972,54128],()=>a(76261));module.exports=n})();