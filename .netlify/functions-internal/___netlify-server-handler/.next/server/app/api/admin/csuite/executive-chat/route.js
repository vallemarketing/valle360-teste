"use strict";(()=>{var e={};e.id=4157,e.ids=[4157],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},18066:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>v,serverHooks:()=>f,staticGenerationAsyncStorage:()=>_});var s={};r.r(s),r.d(s,{POST:()=>x,dynamic:()=>p});var i=r(49303),n=r(88716),o=r(60670),a=r(87070),c=r(17478),u=r(90176),d=r(51547),l=r(31683),m=r(17743);let p="force-dynamic";async function x(e){let t;let r=await (0,c.k)(e);if(!r.ok)return r.res;try{t=await e.json()}catch{return a.NextResponse.json({success:!1,error:"Body inv\xe1lido (JSON)"},{status:400})}let s=(0,m.U)(t?.role),i=String(t?.message||"").trim(),n=t?.conversation_id?String(t.conversation_id):null,o=Array.isArray(t?.history)?t.history:[],p=!!t?.include_market;if(!s)return a.NextResponse.json({success:!1,error:"role inv\xe1lido"},{status:400});if(!i)return a.NextResponse.json({success:!1,error:"message vazio"},{status:400});let x=(0,u.t)(),{data:v}=await x.from("ai_executives").select("*").eq("role",s).maybeSingle();if(!v?.id)return a.NextResponse.json({success:!1,error:`Executivo ${s} n\xe3o encontrado em ai_executives. Rode a migration/seed.`},{status:400});let g=n;if(g){let{data:e}=await x.from("ai_executive_conversations").select("id, executive_id").eq("id",g).maybeSingle();e?.id&&String(e.executive_id)===String(v.id)||(g=null)}if(!g){let{data:e}=await x.from("ai_executive_conversations").insert({executive_id:v.id,user_id:r.userId,title:i.slice(0,80),context:{},status:"active"}).select("id").single();g=e?.id?String(e.id):null}if(!g)return a.NextResponse.json({success:!1,error:"Falha ao criar conversa"},{status:500});let _=await (0,l.tJ)({role:s,actorUserId:r.userId,includePredictions:!0,touchKnowledge:!0}),f=!function(e,t,r){if(r)return!0;let s=String(t||"").toLowerCase();return!!s&&(!!(s.includes("perplexity")||s.includes("sonar"))||!!["mercado","tend\xeancia","tendencias","benchmark","concorr","pre\xe7o","pricing","m\xe9dia","media","custo","roi"].some(e=>s.includes(e))||"cmo"===e&&(s.includes("campanha")||s.includes("tr\xe1fego")||s.includes("trafego")))}(s,i,p)?null:await (0,l.kG)({executiveId:String(v.id),role:s,query:i,purpose:`Suporte de mercado para chat (${s})`});try{await x.from("ai_executive_messages").insert({conversation_id:g,role:"user",content:i,metadata:{source:"ui"},data_sources_used:["internal_best_effort","ml_predictions_log"],web_searches:f?[{provider:"perplexity",model:f.model,sources:f.sources}]:[]})}catch{}let y=`${String(v.system_prompt||"").trim()}

${l.e$}`,h=(o||[]).slice(-12).map(e=>({role:e?.role,content:String(e?.content||"").slice(0,1200)})).filter(e=>"user"===e.role||"assistant"===e.role||"system"===e.role),S=Date.now();try{let e=await (0,d.F)({task:(0,l.Ph)(s),temperature:.4,maxTokens:950,actorUserId:r.userId,entityType:"ai_executive_chat",entityId:s,messages:[{role:"system",content:y},{role:"user",content:[`Executivo: ${s.toUpperCase()} (${v.name} — ${v.title})`,`Contexto interno (JSON):
${JSON.stringify(_).slice(0,18e3)}`,f?`Contexto de mercado (Perplexity Sonar):
${f.answer}
Fontes:
${f.sources.length?f.sources.join("\n"):"(sem fontes)"}

Regras adicionais (MUITO IMPORTANTE):
- Se "Fontes" estiver vazio, N\xc3O invente links nem n\xfameros.
- Se "Fontes" tiver URLs, cite 2–5 URLs explicitamente na resposta.
`:null,h.length?`Hist\xf3rico recente:
${JSON.stringify(h)}`:null,`Pergunta:
${i}`].filter(Boolean).join("\n\n")}]}),t=Date.now()-S,n=String(e.text||"").trim();f?.sources?.length&&!n.match(/https?:\/\//i)&&(n+=`

Fontes:
${f.sources.slice(0,6).join("\n")}`);try{await x.from("ai_executive_messages").insert({conversation_id:g,role:"assistant",content:n,metadata:{provider:e.provider,model:e.model},data_sources_used:["internal_best_effort","ml_predictions_log"],web_searches:f?[{provider:"perplexity",model:f.model,sources:f.sources}]:[],tokens_used:(e.usage,null),processing_time_ms:t})}catch{}try{await x.from("ai_executive_data_access_log").insert({executive_id:v.id,actor_user_id:r.userId,action:"chat",entity_type:"ai_executive_conversations",entity_id:g,details:{role:s,used_market:!!f,missing:_.missing}})}catch{}return a.NextResponse.json({success:!0,conversation_id:g,reply:n,provider:e.provider,model:e.model,market:f?{sources:f.sources}:null})}catch(r){let e=(0,d.getProviderStatus)(),t=e.openrouter||e.claude||e.openai||e.gemini?"N\xe3o consegui obter resposta do provedor de IA agora. Tente novamente em instantes.":"Integra\xe7\xf5es de IA n\xe3o est\xe3o configuradas. Configure em Integra\xe7\xf5es (OpenRouter/Claude/OpenAI/Gemini) para habilitar respostas autom\xe1ticas.";return a.NextResponse.json({success:!0,conversation_id:g,reply:`${t}

Se voc\xea quiser, me diga qual objetivo voc\xea quer atingir (ex.: reduzir churn, aumentar margem, destravar opera\xe7\xe3o) que eu estruturo um plano consultivo com CTAs.`,provider:null,model:null})}}let v=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/csuite/executive-chat/route",pathname:"/api/admin/csuite/executive-chat",filename:"route",bundlePath:"app/api/admin/csuite/executive-chat/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\csuite\\executive-chat\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:_,serverHooks:f}=v,y="/api/admin/csuite/executive-chat/route";function h(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:_})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[89276,55972,54128,20958,79263,44518],()=>r(18066));module.exports=s})();