"use strict";(()=>{var e={};e.id=75303,e.ids=[75303],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},28375:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>R,requestAsyncStorage:()=>k,routeModule:()=>b,serverHooks:()=>x,staticGenerationAsyncStorage:()=>j});var a={};r.r(a),r.d(a,{GET:()=>h,PATCH:()=>w,POST:()=>q,dynamic:()=>m});var n=r(49303),i=r(88716),s=r(60670),o=r(87070),l=r(71615),u=r(20344),d=r(54128),c=r(57157),p=r(14399);let m="force-dynamic";function _(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;return e&&t?(0,d.eI)(e,t,{auth:{persistSession:!1}}):null}async function f(e){try{let e=(0,l.cookies)(),t=(0,u.createRouteHandlerClient)({cookies:()=>e}),{data:r}=await t.auth.getUser();if(r?.user?.id)return{user:{id:r.user.id,email:r.user.email}}}catch{}let t=e.headers.get("authorization")||e.headers.get("Authorization"),r=t?.startsWith("Bearer ")?t.slice(7):null;if(!r)return{user:null};let a="https://ikjgsqtykkhqimypacro.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlramdzcXR5a2tocWlteXBhY3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTE4OTksImV4cCI6MjA3ODc4Nzg5OX0.vgVCpFIt-5ajFhcXg65dqrEw915pqW8fGZ8xgJxrnxI";if(!a||!n)return{user:null};let i=(0,d.eI)(a,n,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}}),{data:s,error:o}=await i.auth.getUser(r);return o||!s?.user?.id?{user:null}:{user:{id:s.user.id,email:s.user.email}}}async function g(e,t){try{let{data:r}=await e.from("user_profiles").select("user_type, role").eq("user_id",t).maybeSingle(),a=String(r?.user_type||"").toLowerCase(),n=String(r?.role||"").toLowerCase();return"super_admin"===a||"admin"===a||"super_admin"===n||"admin"===n}catch{return!1}}function y(e){switch(String(e)){case"vacation":return"F\xe9rias";case"dayoff":return"Folga / Day Off";case"home_office":return"Home Office";case"equipment":return"Equipamento";case"refund":return"Reembolso";default:return"Solicita\xe7\xe3o"}}async function S(e){try{let t=function(e){switch(e){case"home_office":return"home_office";case"dayoff":return"day_off";case"vacation":return"vacation";case"refund":return"reimbursement";default:return"other"}}(e.type),r=function(e){if(null==e)return null;if("number"==typeof e&&Number.isFinite(e))return e;let t=String(e).replace(/[^\d,.\-]/g,"").trim();if(!t)return null;let r=Number(t.includes(",")&&!t.includes(".")?t.replace(",","."):t);return Number.isFinite(r)?r:null}(e.amount),{data:a,error:n}=await e.service.from("employee_requests").insert({employee_id:e.employeeId,request_type:t,start_date:e.startDate||null,end_date:e.endDate||null,description:e.reason,amount:r,status:"pending"}).select("id").single();if(n||!a?.id)return null;return String(a.id)}catch{return null}}async function h(e){try{let{user:t}=await f(e);if(!t)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r=_();if(!r)return o.NextResponse.json({error:"SUPABASE_SERVICE_ROLE_KEY n\xe3o configurada no servidor"},{status:500});let{searchParams:a}=new URL(e.url),n="1"===a.get("all"),i=!!n&&await g(r,t.id);if(n&&!i)return o.NextResponse.json({error:"Acesso negado (admin)"},{status:403});let s=r.from("kanban_tasks").select(`
          id, title, created_at, updated_at, reference_links,
          created_by,
          column:kanban_columns ( stage_key )
        `).contains("reference_links",{source:"employee_request"}).order("created_at",{ascending:!1}).limit(200);n||(s=s.eq("created_by",t.id));let{data:l,error:u}=await s;if(u)return o.NextResponse.json({error:u.message},{status:500});let d=l||[],c=Array.from(new Set(d.map(e=>String(e?.reference_links?.employee_request_id||"").trim()).filter(Boolean))),p=new Map;if(c.length>0){let{data:e}=await r.from("employee_requests").select("id, status, approved_by, approved_at, rejection_reason").in("id",c);p=new Map((e||[]).map(e=>[String(e.id),e]))}let m=new Map;if(n){let e=Array.from(new Set(d.map(e=>String(e?.created_by||"")).filter(Boolean)));if(e.length>0){let{data:t}=await r.from("employees").select("user_id, full_name").in("user_id",e);m=new Map((t||[]).map(e=>[String(e.user_id),String(e.full_name||"").trim()]))}}let y=(l||[]).map(e=>{let t=e?.reference_links||{},r=t?.request||{},a=String(e?.column?.stage_key||"").toLowerCase(),i=String(t?.employee_request_id||"").trim()||null,s=i?p.get(i):null,o=String(s?.status||"").trim()||String(r?.status||"").trim()||(a.includes("final")?"approved":a.includes("bloq")?"rejected":"pending");return{id:String(e.id),type:String(r?.type||""),start_date:r?.start_date||null,end_date:r?.end_date||null,reason:r?.reason||null,amount:r?.amount||null,attachments:Array.isArray(r?.attachments)?r.attachments:[],status:o,employee_request_id:i,requester_name:n?m.get(String(e?.created_by||""))||null:void 0,created_at:e.created_at,title:String(e.title||"")}});return o.NextResponse.json({success:!0,requests:y,total:y.length})}catch(e){return console.error("Error fetching requests:",e),o.NextResponse.json({error:"Failed to fetch requests"},{status:500})}}async function q(e){try{let{user:t}=await f(e);if(!t)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r=_();if(!r)return o.NextResponse.json({error:"SUPABASE_SERVICE_ROLE_KEY n\xe3o configurada no servidor"},{status:500});let a=await e.json().catch(()=>null),n=String(a?.type||"").trim(),i=a?.start_date?String(a.start_date):"",s=a?.end_date?String(a.end_date):null,l=String(a?.reason||"").trim(),u=a?.amount!=null?String(a.amount):null,d=Array.isArray(a?.attachments)?a.attachments:[];if(!n||!i||!l)return o.NextResponse.json({error:"Campos obrigat\xf3rios: type, start_date, reason"},{status:400});let m=await g(r,t.id),h=null;if(m){let{data:e}=await r.from("employees").select("id, is_active, full_name").eq("user_id",t.id).maybeSingle();h=e?.id?String(e.id):null}else{let{data:e}=await r.from("employees").select("id, is_active, full_name").eq("user_id",t.id).maybeSingle();if(!e?.id)return o.NextResponse.json({error:"Acesso negado (colaborador)"},{status:403});h=String(e.id)}let q="rh",w=await r.from("kanban_boards").select("id, area_key, name").eq("area_key",q).maybeSingle();if(w?.data?.id||(q="operacao",w=await r.from("kanban_boards").select("id, area_key, name").eq("area_key",q).maybeSingle()),!w?.data?.id)return o.NextResponse.json({error:"Board de RH/Opera\xe7\xe3o n\xe3o encontrado"},{status:500});let{data:b}=await r.from("kanban_columns").select("id, stage_key").eq("board_id",w.data.id).eq("stage_key","demanda").maybeSingle();if(!b?.id)return o.NextResponse.json({error:'Coluna "Demanda" n\xe3o encontrada no board de destino'},{status:500});let{data:k}=await r.from("kanban_tasks").select("position").eq("board_id",w.data.id).eq("column_id",b.id).order("position",{ascending:!1}).limit(1).maybeSingle(),j=Number(k?.position||0)+1,x=new Date().toISOString(),v=`Solicita\xe7\xe3o (${y(n)}): ${i}${s?` → ${s}`:""}`,{data:R,error:E}=await r.from("kanban_tasks").insert({board_id:w.data.id,column_id:b.id,title:v,description:l,priority:"refund"===n?"high":"medium",status:"todo",tags:Array.from(new Set(["solicitacao","colaborador",n])),due_date:i||null,client_id:null,area:q,reference_links:{source:"employee_request",request:{type:n,start_date:i,end_date:s,reason:l,amount:u,attachments:d,status:"pending"},created_at:x},assigned_to:null,created_by:t.id,position:j,updated_at:x}).select("id, title, created_at, reference_links").single();if(E||!R)return o.NextResponse.json({error:E?.message||"Falha ao criar solicita\xe7\xe3o"},{status:500});let I=h?await S({service:r,employeeId:h,type:n,startDate:i,endDate:s,reason:l,amount:u}):null;if(I)try{let e=R.reference_links||{};await r.from("kanban_tasks").update({reference_links:{...e,employee_request_id:I},updated_at:new Date().toISOString()}).eq("id",R.id)}catch{}try{await (0,p.Q)({area:"rh",title:"Nova solicita\xe7\xe3o de colaborador",message:`${y(n)} • ${i}${s?` → ${s}`:""}`,link:"/admin/solicitacoes",metadata:{source:"employee_request",task_id:String(R.id),employee_request_id:I||null},type:"request"})}catch{}return o.NextResponse.json({success:!0,message:"Solicita\xe7\xe3o criada com sucesso",request:{id:String(R.id),title:String(R.title||v),type:n,start_date:i,end_date:s,reason:l,amount:u,attachments:d,status:"pending",employee_request_id:I,created_at:R.created_at},target:{area_key:q,board_id:w.data.id,column_id:b.id,board_label:(0,c.en)(q).label}})}catch(e){return console.error("Error creating request:",e),o.NextResponse.json({error:"Failed to create request"},{status:500})}}async function w(e){try{let{user:t}=await f(e);if(!t)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r=_();if(!r)return o.NextResponse.json({error:"SUPABASE_SERVICE_ROLE_KEY n\xe3o configurada no servidor"},{status:500});if(!await g(r,t.id))return o.NextResponse.json({error:"Acesso negado (admin)"},{status:403});let a=await e.json().catch(()=>null),n=String(a?.task_id||"").trim(),i=String(a?.status||"").trim(),s=String(a?.rejection_reason||"").trim()||null;if(!n||!i)return o.NextResponse.json({error:"Campos obrigat\xf3rios: task_id, status"},{status:400});if("rejected"===i&&(!s||s.length<10))return o.NextResponse.json({error:"Motivo da rejei\xe7\xe3o deve ter pelo menos 10 caracteres"},{status:400});let{data:l,error:u}=await r.from("kanban_tasks").select("id, created_by, reference_links").eq("id",n).maybeSingle();if(u||!l?.id)return o.NextResponse.json({error:"Solicita\xe7\xe3o n\xe3o encontrada"},{status:404});let d=l.reference_links||{};if("employee_request"!==String(d?.source||""))return o.NextResponse.json({error:"Este card n\xe3o \xe9 uma solicita\xe7\xe3o de colaborador"},{status:400});let c=String(d?.employee_request_id||"").trim()||null;if(!c){let{data:e}=await r.from("employees").select("id").eq("user_id",l.created_by).maybeSingle(),t=e?.id?String(e.id):null,a=d?.request||{};t&&(c=await S({service:r,employeeId:t,type:String(a?.type||"other"),startDate:String(a?.start_date||""),endDate:a?.end_date?String(a.end_date):null,reason:String(a?.reason||""),amount:a?.amount!=null?String(a.amount):null}))}if(c){let e="approved"===i?{status:"approved",approved_by:t.id,approved_at:new Date().toISOString(),rejection_reason:null}:{status:"rejected",approved_by:t.id,approved_at:new Date().toISOString(),rejection_reason:s};await r.from("employee_requests").update(e).eq("id",c)}let p={...d,employee_request_id:c,request:{...d?.request||{},status:i,rejection_reason:s,reviewed_by:t.id,reviewed_at:new Date().toISOString()}};await r.from("kanban_tasks").update({reference_links:p,updated_at:new Date().toISOString()}).eq("id",n);try{await r.from("notifications").insert({user_id:String(l.created_by),title:"approved"===i?"Solicita\xe7\xe3o aprovada":"Solicita\xe7\xe3o rejeitada",message:"approved"===i?"Sua solicita\xe7\xe3o foi aprovada.":`Sua solicita\xe7\xe3o foi rejeitada. Motivo: ${s}`,type:"request",is_read:!1,link:"/colaborador/solicitacoes",metadata:{source:"employee_request",task_id:n,employee_request_id:c},created_at:new Date().toISOString()})}catch{}return o.NextResponse.json({success:!0,task_id:n,employee_request_id:c,status:i})}catch(e){return o.NextResponse.json({error:e?.message||"Failed to update request"},{status:500})}}let b=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/requests/route",pathname:"/api/requests",filename:"route",bundlePath:"app/api/requests/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\requests\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:k,staticGenerationAsyncStorage:j,serverHooks:x}=b,v="/api/requests/route";function R(){return(0,s.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:j})}},14399:(e,t,r)=>{r.d(t,{Q:()=>i});var a=r(90176);function n(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}async function i(e){let t=(0,a.t)(),{data:r}=await t.from("employees").select("user_id, department, areas, is_active").eq("is_active",!0),i=(r||[]).filter(t=>t?.user_id&&function(e,t){let r=n(e),a=t.department?n(t.department):"",i=Array.isArray(t.areas)?t.areas.map(n):[];if(!r)return!1;if(a===r||i.includes(r)||a.includes(r)||r.includes(a)||i.some(e=>e.includes(r)||r.includes(e)))return!0;let s={operacao:["operacao","operacional","ops"],financeiro:["financeiro","finance","cobranca","cobran\xe7a"],comercial:["comercial","vendas","sales"],juridico:["juridico","juridico/compliance","compliance"],contratos:["contratos","contract"],notificacoes:["notificacoes","notificacoes-e-alertas","notificacoes/alertas"],rh:["rh","people","pessoas"]}[r]||[];return!!(s.length>0&&(s.some(e=>a.includes(e))||s.some(e=>i.some(t=>t.includes(e)))))}(e.area,t)).map(e=>String(e.user_id));if(0===i.length){let r={user_id:null,title:e.title,message:e.message,type:e.type||"workflow",is_read:!1,link:e.link??"/admin/fluxos",metadata:{...e.metadata||{},area:e.area,audience:"area"},created_at:new Date().toISOString()};try{await t.from("notifications").insert(r)}catch{}return}let s=i.map(t=>({user_id:t,title:e.title,message:e.message,type:e.type||"workflow",is_read:!1,link:e.link??"/colaborador/notificacoes",metadata:{...e.metadata||{},area:e.area,audience:"area"},created_at:new Date().toISOString()}));try{await t.from("notifications").insert(s)}catch{}}},90176:(e,t,r)=>{r.d(t,{t:()=>n});var a=r(54128);function n(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,a.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958,57157],()=>r(28375));module.exports=a})();