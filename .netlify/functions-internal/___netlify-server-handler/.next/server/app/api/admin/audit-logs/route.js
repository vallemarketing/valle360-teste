"use strict";(()=>{var e={};e.id=41877,e.ids=[41877],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},78787:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>_});var a={};r.r(a),r.d(a,{GET:()=>m,dynamic:()=>c});var s=r(49303),i=r(88716),n=r(60670),o=r(87070),u=r(20344),l=r(71615),d=r(90176);let c="force-dynamic";async function m(e){let t=(0,l.cookies)(),r=(0,u.createRouteHandlerClient)({cookies:()=>t}),{data:a}=await r.auth.getUser();if(!a.user?.id)return o.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:s,error:i}=await r.rpc("is_admin");if(i||!s)return o.NextResponse.json({error:"Acesso negado (admin)"},{status:403});try{let{searchParams:t}=new URL(e.url),r=Math.max(1,Math.min(500,Number(t.get("limit")||200))),a=(0,d.t)(),[{data:s,error:i},{data:n,error:u}]=await Promise.all([a.from("audit_logs").select("*").order("created_at",{ascending:!1}).limit(r),a.from("integration_logs").select("*").order("created_at",{ascending:!1}).limit(r)]);if(i)throw i;if(u)throw u;let l=Array.from(new Set((s||[]).map(e=>e.user_id).filter(Boolean))),{data:c}=l.length>0?await a.from("user_profiles").select("user_id,full_name,email,role").in("user_id",l):{data:[]},m=new Map((c||[]).map(e=>[e.user_id,e])),p=(s||[]).map(e=>{let t=e.new_values||{},r=e.user_id?m.get(e.user_id):null;return{id:e.id,timestamp:e.created_at,action:e.action,severity:function(e,t){let r=String(t?.severity||"").toLowerCase();return"info"===r||"warning"===r||"error"===r||"critical"===r?r:!1===(t?.success??t?.ok)||String(e||"").toLowerCase().includes("error")?"error":"info"}(e.action,t),userId:e.user_id||null,userEmail:r?.email||t.user_email||null,userName:r?.full_name||t.user_name||null,userRole:r?.role||t.user_role||null,targetType:e.entity_type||t.target_type||null,targetId:e.entity_id||t.target_id||null,targetName:t.target_name||t.targetName||null,description:t.description||t.message||e.action,metadata:t.metadata||t,ipAddress:e.ip_address||null,success:function(e,t){let r=t?.success??t?.ok;return"boolean"==typeof r?r:!String(e||"").toLowerCase().includes("error")}(e.action,t),errorMessage:t.errorMessage||t.error||null}}),g=(n||[]).map(e=>{let t="success"===String(e.status||"").toLowerCase();return{id:e.id,timestamp:e.created_at,action:`integration.${e.integration_id}.${e.action}`,severity:t?"info":"error",userId:null,userEmail:null,userName:null,userRole:"system",targetType:"integration",targetId:null,targetName:e.integration_id,description:`Integra\xe7\xe3o ${e.integration_id}: ${e.action} (${e.status})`,metadata:{integration_id:e.integration_id,action:e.action,status:e.status,duration_ms:e.duration_ms,request_data:e.request_data,response_data:e.response_data},ipAddress:null,success:t,errorMessage:e.error_message||null}}),_=[...p,...g].sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime());return o.NextResponse.json({logs:_.slice(0,r)})}catch(e){return o.NextResponse.json({error:e?.message||"Erro interno"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/audit-logs/route",pathname:"/api/admin/audit-logs",filename:"route",bundlePath:"app/api/admin/audit-logs/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\audit-logs\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:_,serverHooks:f}=p,x="/api/admin/audit-logs/route";function y(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:_})}},90176:(e,t,r)=>{r.d(t,{t:()=>s});var a=r(54128);function s(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,a.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[89276,55972,54128,20958],()=>r(78787));module.exports=a})();