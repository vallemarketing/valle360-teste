"use strict";(()=>{var e={};e.id=36460,e.ids=[36460],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},19659:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>w,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>_,serverHooks:()=>h,staticGenerationAsyncStorage:()=>x});var r={};s.r(r),s.d(r,{GET:()=>p,PATCH:()=>g,POST:()=>m,dynamic:()=>u});var a=s(49303),n=s(88716),o=s(60670),i=s(87070),l=s(20344),d=s(71615),c=s(90176);let u="force-dynamic";async function p(e){try{let t=(0,d.cookies)(),s=(0,l.createRouteHandlerClient)({cookies:()=>t}),{data:{user:r},error:a}=await s.auth.getUser();if(a||!r)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:n}=await s.rpc("is_admin");if(!n)return i.NextResponse.json({error:"Acesso negado (admin)"},{status:403});let o=(0,c.t)(),{searchParams:u}=new URL(e.url),p=u.get("status"),g=u.get("severity"),m=u.get("client_id"),_=parseInt(u.get("limit")||"50"),f=parseInt(u.get("offset")||"0"),x=o.from("sentiment_alerts").select("*, sentiment_analyses(*)",{count:"exact"}).order("created_at",{ascending:!1}).range(f,f+_-1);p&&(x=x.eq("status",p)),g&&(x=x.eq("severity",g)),m&&(x=x.eq("client_id",m));let{data:h,error:w,count:v}=await x;if(w)throw w;let[S,y,R]=await Promise.all([o.from("sentiment_alerts").select("id",{count:"exact",head:!0}).eq("status","pending"),o.from("sentiment_alerts").select("id",{count:"exact",head:!0}).eq("severity","critical").eq("status","pending"),o.from("sentiment_alerts").select("id",{count:"exact",head:!0}).eq("severity","high").eq("status","pending")]);return i.NextResponse.json({success:!0,data:h,stats:{pending:S.count||0,critical:y.count||0,high:R.count||0},pagination:{total:v,limit:_,offset:f,has_more:!!v&&f+_<v}})}catch(e){if(console.error("Erro ao buscar alertas:",e),function(e){let t=String(e||"").toLowerCase();return t.includes("does not exist")||t.includes("relation")||t.includes("schema cache")||t.includes("could not find the table")}(e?.message||""))return i.NextResponse.json({success:!0,data:[],stats:{pending:0,critical:0,high:0},pagination:{total:0,limit:50,offset:0,has_more:!1},note:"Schema de sentimento ainda n\xe3o foi aplicado no banco."});return i.NextResponse.json({error:"Erro interno",details:e.message},{status:500})}}async function g(e){try{let t=(0,d.cookies)(),s=(0,l.createRouteHandlerClient)({cookies:()=>t}),{data:{user:r},error:a}=await s.auth.getUser();if(a||!r)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:n}=await s.rpc("is_admin");if(!n)return i.NextResponse.json({error:"Acesso negado (admin)"},{status:403});let o=(0,c.t)(),{alert_id:u,action:p,resolution_notes:g}=await e.json();if(!u||!p)return i.NextResponse.json({error:"alert_id e action s\xe3o obrigat\xf3rios"},{status:400});let m={updated_at:new Date().toISOString()};switch(p){case"acknowledge":m.status="acknowledged",m.acknowledged_at=new Date().toISOString(),m.acknowledged_by=r.id;break;case"resolve":m.status="resolved",m.resolved_at=new Date().toISOString(),m.resolved_by=r.id,m.resolution_notes=g;break;case"dismiss":m.status="dismissed",m.resolved_at=new Date().toISOString(),m.resolved_by=r.id,m.resolution_notes=g||"Alerta descartado";break;default:return i.NextResponse.json({error:"A\xe7\xe3o inv\xe1lida. Use: acknowledge, resolve ou dismiss"},{status:400})}let{data:_,error:f}=await o.from("sentiment_alerts").update(m).eq("id",u).select().single();if(f)throw f;return i.NextResponse.json({success:!0,alert:_})}catch(e){return console.error("Erro ao atualizar alerta:",e),i.NextResponse.json({error:"Erro interno",details:e.message},{status:500})}}async function m(e){try{let t=(0,d.cookies)(),s=(0,l.createRouteHandlerClient)({cookies:()=>t}),{data:{user:r},error:a}=await s.auth.getUser();if(a||!r)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{data:n}=await s.rpc("is_admin");if(!n)return i.NextResponse.json({error:"Acesso negado (admin)"},{status:403});let o=(0,c.t)(),{action:u,alert_ids:p,filter:g}=await e.json();if(!u)return i.NextResponse.json({error:"action \xe9 obrigat\xf3rio"},{status:400});let m={updated_at:new Date().toISOString()};switch(u){case"acknowledge_all":m.status="acknowledged",m.acknowledged_at=new Date().toISOString(),m.acknowledged_by=r.id;break;case"resolve_all":m.status="resolved",m.resolved_at=new Date().toISOString(),m.resolved_by=r.id;break;case"dismiss_all":m.status="dismissed",m.resolved_at=new Date().toISOString(),m.resolved_by=r.id;break;default:return i.NextResponse.json({error:"A\xe7\xe3o inv\xe1lida"},{status:400})}let _=o.from("sentiment_alerts").update(m);p&&Array.isArray(p)?_=_.in("id",p):g?(g.status&&(_=_.eq("status",g.status)),g.severity&&(_=_.eq("severity",g.severity)),g.client_id&&(_=_.eq("client_id",g.client_id))):_=_.eq("status","pending");let{data:f,error:x,count:h}=await _.select();if(x)throw x;return i.NextResponse.json({success:!0,updated_count:f?.length||0,alerts:f})}catch(e){return console.error("Erro ao processar a\xe7\xe3o em lote:",e),i.NextResponse.json({error:"Erro interno",details:e.message},{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/sentiment/alerts/route",pathname:"/api/sentiment/alerts",filename:"route",bundlePath:"app/api/sentiment/alerts/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\sentiment\\alerts\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:x,serverHooks:h}=_,w="/api/sentiment/alerts/route";function v(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:x})}},90176:(e,t,s)=>{s.d(t,{t:()=>a});var r=s(54128);function a(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,r.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>s(19659));module.exports=r})();