"use strict";(()=>{var e={};e.id=88711,e.ids=[88711],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},6162:e=>{e.exports=require("worker_threads")},7223:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>g,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>m,serverHooks:()=>u,staticGenerationAsyncStorage:()=>h});var r={};o.r(r),o.d(r,{POST:()=>d});var a=o(49303),s=o(88716),n=o(60670),l=o(87070),i=o(90176),c=o(3370);async function d(e){try{let{clientId:t,startDate:o,endDate:r}=await e.json();if(!t||!o||!r)return l.NextResponse.json({error:"Missing required parameters"},{status:400});let a=(0,i.t)(),{data:s,error:n}=await a.from("clients").select("id, name, logo_url").eq("id",t).single();if(n||!s)return l.NextResponse.json({error:"Client not found"},{status:404});let{data:d}=await a.from("client_white_label").select("*").eq("client_id",t).single(),{data:m,error:p}=await a.from("scheduled_posts").select("*").eq("client_id",t).gte("scheduled_time",o).lte("scheduled_time",r);if(p)return console.error("Error fetching posts:",p),l.NextResponse.json({error:"Failed to fetch posts data"},{status:500});let h=m?.filter(e=>"published"===e.status)||[],u=m?.filter(e=>"scheduled"===e.status)||[],g={};h.forEach(e=>{let t=e.platform||"other";g[t]||(g[t]={posts:0,engagement:0,reach:0}),g[t].posts++,g[t].engagement+=e.metadata?.engagement||5*Math.random(),g[t].reach+=e.metadata?.reach||Math.floor(5e3*Math.random())}),Object.keys(g).forEach(e=>{let t=g[e];t.engagement=t.posts>0?t.engagement/t.posts:0});let f=h.sort((e,t)=>(t.metadata?.engagement||0)-(e.metadata?.engagement||0)).slice(0,5).map(e=>({id:e.id,caption:e.caption||"Sem legenda",platform:e.platform||"instagram",engagement:e.metadata?.engagement||5*Math.random(),reach:e.metadata?.reach||Math.floor(5e3*Math.random()),publishedAt:e.scheduled_time})),x={clientName:s.name,clientLogo:s.logo_url,period:{start:o,end:r},metrics:{totalPosts:m?.length||0,publishedPosts:h.length,scheduledPosts:u.length,engagementRate:h.length>0?h.reduce((e,t)=>e+(t.metadata?.engagement||5*Math.random()),0)/h.length:0,reach:h.reduce((e,t)=>e+(t.metadata?.reach||Math.floor(5e3*Math.random())),0),impressions:h.reduce((e,t)=>e+(t.metadata?.impressions||Math.floor(1e4*Math.random())),0),likes:h.reduce((e,t)=>e+(t.metadata?.likes||Math.floor(500*Math.random())),0),comments:h.reduce((e,t)=>e+(t.metadata?.comments||Math.floor(50*Math.random())),0),shares:h.reduce((e,t)=>e+(t.metadata?.shares||Math.floor(30*Math.random())),0),followers:5e3+Math.floor(1e4*Math.random()),followerGrowth:2.5+5*Math.random()},topPosts:f,platformBreakdown:g},F=d?{primaryColor:d.primary_color||"#4F46E5",secondaryColor:d.secondary_color||"#6B7280",logoUrl:d.logo_url,companyName:d.company_name||"Valle360",reportFooter:d.report_footer}:void 0,b=await (0,c.m)(x,F),C=await b.arrayBuffer(),S=Buffer.from(C).toString("base64");return l.NextResponse.json({success:!0,pdf:S,filename:`relatorio-${s.name.toLowerCase().replace(/\s+/g,"-")}-${o.slice(0,7)}.pdf`})}catch(e){return console.error("Error generating PDF report:",e),l.NextResponse.json({error:e.message||"Failed to generate report"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/reports/pdf/route",pathname:"/api/admin/reports/pdf",filename:"route",bundlePath:"app/api/admin/reports/pdf/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\admin\\reports\\pdf\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:h,serverHooks:u}=m,g="/api/admin/reports/pdf/route";function f(){return(0,n.patchFetch)({serverHooks:u,staticGenerationAsyncStorage:h})}},90176:(e,t,o)=>{o.d(t,{t:()=>a});var r=o(54128);function a(){let e="https://ikjgsqtykkhqimypacro.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin n\xe3o configurado (NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY).");return(0,r.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})}},3370:(e,t,o)=>{o.d(t,{U:()=>l,m:()=>a});var r=o(17817);async function a(e,t){let o=new r.kH({orientation:"portrait",unit:"mm",format:"a4"}),a=t?.primaryColor||"#4F46E5",l=t?.secondaryColor||"#6B7280",i=t?.companyName||"Valle360",c=o.internal.pageSize.getWidth(),d=o.internal.pageSize.getHeight(),m=c-40;function p(e){let t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:79,g:70,b:229}}let h=p(a),u=p(l);o.setFillColor(h.r,h.g,h.b),o.rect(0,0,c,60,"F"),o.setTextColor(255,255,255),o.setFontSize(28),o.setFont("helvetica","bold"),o.text(i,20,38),o.setFontSize(12),o.setFont("helvetica","normal"),o.text("Social Media Performance Report",20,50),o.setTextColor(h.r,h.g,h.b),o.setFontSize(24),o.setFont("helvetica","bold"),o.text(e.clientName,20,90),o.setTextColor(u.r,u.g,u.b),o.setFontSize(12),o.setFont("helvetica","normal"),o.text(`Per\xedodo: ${n(e.period.start)} - ${n(e.period.end)}`,20,100),o.setFontSize(10),o.text(`Gerado em: ${n(new Date().toISOString())}`,20,108);let g=130,f=(m-10)/3;[{label:"Posts Publicados",value:e.metrics.publishedPosts.toString()},{label:"Taxa de Engajamento",value:`${e.metrics.engagementRate.toFixed(1)}%`},{label:"Alcance Total",value:s(e.metrics.reach)}].forEach((e,t)=>{let r=20+t*(f+5);o.setFillColor(248,250,252),o.roundedRect(r,g,f,45,3,3,"F"),o.setTextColor(h.r,h.g,h.b),o.setFontSize(22),o.setFont("helvetica","bold"),o.text(e.value,r+f/2,g+22,{align:"center"}),o.setTextColor(u.r,u.g,u.b),o.setFontSize(9),o.setFont("helvetica","normal"),o.text(e.label,r+f/2,g+35,{align:"center"})}),o.setFontSize(8),o.setTextColor(u.r,u.g,u.b);let x=t?.reportFooter||`\xa9 ${new Date().getFullYear()} ${i}. Todos os direitos reservados.`;o.text(x,c/2,d-15,{align:"center"}),o.addPage(),o.setFillColor(h.r,h.g,h.b),o.rect(0,0,c,25,"F"),o.setTextColor(255,255,255),o.setFontSize(14),o.setFont("helvetica","bold"),o.text("M\xe9tricas Detalhadas",20,17),g=40,o.setTextColor(h.r,h.g,h.b),o.setFontSize(12),o.setFont("helvetica","bold"),o.text("Engajamento",20,g),g+=10;let F=[{label:"Curtidas",value:s(e.metrics.likes)},{label:"Coment\xe1rios",value:s(e.metrics.comments)},{label:"Compartilhamentos",value:s(e.metrics.shares)},{label:"Impress\xf5es",value:s(e.metrics.impressions)}],b=(m-10)/2;return F.forEach((e,t)=>{let r=20+t%2*(b+10),a=g+40*Math.floor(t/2);o.setFillColor(248,250,252),o.roundedRect(r,a,b,35,2,2,"F"),o.setTextColor(36,36,36),o.setFontSize(16),o.setFont("helvetica","bold"),o.text(e.value,r+10,a+18),o.setTextColor(u.r,u.g,u.b),o.setFontSize(9),o.setFont("helvetica","normal"),o.text(e.label,r+10,a+28)}),g+=40*Math.ceil(F.length/2)+15,o.setTextColor(h.r,h.g,h.b),o.setFontSize(12),o.setFont("helvetica","bold"),o.text("Audi\xeancia",20,g),g+=10,[{label:"Seguidores",value:s(e.metrics.followers)},{label:"Crescimento",value:`${e.metrics.followerGrowth>=0?"+":""}${e.metrics.followerGrowth}%`}].forEach((e,t)=>{let r=20+t*(b+10);o.setFillColor(248,250,252),o.roundedRect(r,g,b,35,2,2,"F"),o.setTextColor(36,36,36),o.setFontSize(16),o.setFont("helvetica","bold"),o.text(e.value,r+10,g+18),o.setTextColor(u.r,u.g,u.b),o.setFontSize(9),o.setFont("helvetica","normal"),o.text(e.label,r+10,g+28)}),g+=55,o.setTextColor(h.r,h.g,h.b),o.setFontSize(12),o.setFont("helvetica","bold"),o.text("Desempenho por Plataforma",20,g),g+=10,o.setFillColor(h.r,h.g,h.b),o.rect(20,g,m,10,"F"),o.setTextColor(255,255,255),o.setFontSize(9),o.setFont("helvetica","bold"),o.text("Plataforma",25,g+7),o.text("Posts",80,g+7),o.text("Engajamento",120,g+7),o.text("Alcance",165,g+7),g+=10,o.setFont("helvetica","normal"),Object.entries(e.platformBreakdown).forEach(([e,t],r)=>{let a=r%2==0?255:248;o.setFillColor(a,a,a),o.rect(20,g,m,10,"F"),o.setTextColor(36,36,36),o.text(e.charAt(0).toUpperCase()+e.slice(1),25,g+7),o.text(t.posts.toString(),80,g+7),o.text(`${t.engagement.toFixed(1)}%`,120,g+7),o.text(s(t.reach),165,g+7),g+=10}),e.topPosts.length>0&&(o.addPage(),o.setFillColor(h.r,h.g,h.b),o.rect(0,0,c,25,"F"),o.setTextColor(255,255,255),o.setFontSize(14),o.setFont("helvetica","bold"),o.text("Top Posts do Per\xedodo",20,17),g=40,e.topPosts.slice(0,5).forEach((e,t)=>{o.setFillColor(248,250,252),o.roundedRect(20,g,m,45,3,3,"F"),o.setFillColor(h.r,h.g,h.b),o.circle(35,g+15,8,"F"),o.setTextColor(255,255,255),o.setFontSize(12),o.setFont("helvetica","bold"),o.text(`${t+1}`,35,g+18,{align:"center"}),o.setTextColor(h.r,h.g,h.b),o.setFontSize(8),o.setFont("helvetica","bold"),o.text(e.platform.toUpperCase(),50,g+12),o.setTextColor(36,36,36),o.setFontSize(10),o.setFont("helvetica","normal");let r=e.caption.length>80?e.caption.slice(0,80)+"...":e.caption;o.text(r,50,g+22),o.setTextColor(u.r,u.g,u.b),o.setFontSize(8),o.text(`Engajamento: ${e.engagement}% | Alcance: ${s(e.reach)} | ${n(e.publishedAt)}`,50,g+35),g+=50})),o.setFontSize(8),o.setTextColor(u.r,u.g,u.b),o.text(t?.reportFooter||`\xa9 ${new Date().getFullYear()} ${i}`,c/2,d-15,{align:"center"}),o.output("blob")}function s(e){return e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString()}function n(e){return new Date(e).toLocaleDateString("pt-BR",{day:"2-digit",month:"short",year:"numeric"})}async function l(e,t,o){let r=await e.arrayBuffer(),a=Buffer.from(r).toString("base64");await fetch("/api/email/send-report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to:t,subject:`Relat\xf3rio de Performance - ${o}`,attachments:[{filename:`relatorio-${o.toLowerCase().replace(/\s+/g,"-")}.pdf`,content:a,contentType:"application/pdf"}]})})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,17817],()=>o(7223));module.exports=r})();