"use strict";(()=>{var e={};e.id=55101,e.ids=[55101],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},51677:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>_,serverHooks:()=>x,staticGenerationAsyncStorage:()=>g});var r={};a.r(r),a.d(r,{GET:()=>l});var n=a(49303),s=a(88716),o=a(60670),i=a(87070),c=a(20344),u=a(71615);async function l(e){try{let e=(0,c.createRouteHandlerClient)({cookies:u.cookies}),{data:{user:t}}=await e.auth.getUser();if(!t)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{data:a}=await e.from("user_profiles").select("client_id").eq("user_id",t.id).single();if(!a?.client_id)return i.NextResponse.json({error:"Client not found"},{status:404});let{data:r,error:n}=await e.from("client_ad_accounts").select("*").eq("client_id",a.client_id).eq("is_active",!0).order("connected_at",{ascending:!1});if(n)return console.error("Error fetching ad accounts:",n),i.NextResponse.json({error:"Failed to fetch accounts"},{status:500});let s=await Promise.all((r||[]).map(async t=>{let a=t.cached_metrics,r=t.metrics_updated_at?Date.now()-new Date(t.metrics_updated_at).getTime():1/0;return(!a||r>36e5)&&(a=await d(t),await e.from("client_ad_accounts").update({cached_metrics:a,metrics_updated_at:new Date().toISOString()}).eq("id",t.id)),{id:t.id,platform:t.platform,account_id:t.account_id,account_name:t.account_name,connected_at:t.connected_at,is_active:t.is_active,metrics:a}}));return i.NextResponse.json({accounts:s})}catch(e){return console.error("Error in ad accounts API:",e),i.NextResponse.json({error:e.message||"Internal server error"},{status:500})}}async function d(e){try{if("meta"===e.platform)return await p(e);if("google"===e.platform)return await m(e)}catch(t){console.error(`Failed to fetch metrics for ${e.platform}:`,t)}return null}async function p(e){let t=e.access_token_encrypted;if(!t)return null;try{let a=new Date,r=new Date(a.getTime()-2592e6),n=await fetch(`https://graph.facebook.com/v18.0/act_${e.account_id}/insights?fields=spend,impressions,clicks,actions&time_range={"since":"${r.toISOString().split("T")[0]}","until":"${a.toISOString().split("T")[0]}"}&access_token=${t}`),s=await n.json();if(s.data&&s.data[0]){let e=s.data[0],t=e.actions?.find(e=>"purchase"===e.action_type)?.value||0;return{spend:parseFloat(e.spend||0),impressions:parseInt(e.impressions||0),clicks:parseInt(e.clicks||0),conversions:parseInt(t)}}}catch(e){console.error("Meta Ads API error:",e)}return null}async function m(e){return null}let _=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/client/ad-accounts/route",pathname:"/api/client/ad-accounts",filename:"route",bundlePath:"app/api/client/ad-accounts/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\client\\ad-accounts\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:x}=_,h="/api/client/ad-accounts/route";function v(){return(0,o.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:g})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>a(51677));module.exports=r})();