"use strict";(()=>{var e={};e.id=30648,e.ids=[30648],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},95999:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>_,routeModule:()=>f,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m});var r={};o.r(r),o.d(r,{DELETE:()=>x,GET:()=>d,PATCH:()=>c,POST:()=>p});var s=o(49303),a=o(88716),n=o(60670),i=o(87070),u=o(20344),l=o(71615);async function d(e){let t=(0,u.createRouteHandlerClient)({cookies:l.cookies}),{data:{user:o},error:r}=await t.auth.getUser();if(r||!o)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{searchParams:s}=new URL(e.url),a=s.get("postId");if(!a)return i.NextResponse.json({error:"postId \xe9 obrigat\xf3rio"},{status:400});try{let{data:e,error:o}=await t.from("post_annotations").select(`
        *,
        user_profiles:author_id (
          full_name,
          avatar_url
        )
      `).eq("post_id",a).order("created_at",{ascending:!0});if(o)throw o;let r=e?.map(e=>({id:e.id,x:e.x_position,y:e.y_position,text:e.text,author:e.user_profiles?.full_name||"Usu\xe1rio",authorAvatar:e.user_profiles?.avatar_url,createdAt:e.created_at,resolved:e.resolved,color:e.color}))||[];return i.NextResponse.json({success:!0,annotations:r})}catch(e){return console.error("Erro ao buscar anota\xe7\xf5es:",e),i.NextResponse.json({error:e.message},{status:500})}}async function p(e){let t=(0,u.createRouteHandlerClient)({cookies:l.cookies}),{data:{user:o},error:r}=await t.auth.getUser();if(r||!o)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});try{let{postId:r,x:s,y:a,text:n,color:u}=await e.json();if(!r||void 0===s||void 0===a||!n)return i.NextResponse.json({error:"Campos obrigat\xf3rios faltando"},{status:400});let{data:l}=await t.from("user_profiles").select("full_name, avatar_url").eq("id",o.id).single(),{data:d,error:p}=await t.from("post_annotations").insert({post_id:r,author_id:o.id,x_position:s,y_position:a,text:n,color:u||"red"}).select().single();if(p)throw p;return i.NextResponse.json({success:!0,annotation:{id:d.id,x:d.x_position,y:d.y_position,text:d.text,author:l?.full_name||"Usu\xe1rio",authorAvatar:l?.avatar_url,createdAt:d.created_at,resolved:d.resolved,color:d.color}})}catch(e){return console.error("Erro ao criar anota\xe7\xe3o:",e),i.NextResponse.json({error:e.message},{status:500})}}async function c(e){let t=(0,u.createRouteHandlerClient)({cookies:l.cookies}),{data:{user:o},error:r}=await t.auth.getUser();if(r||!o)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});try{let{annotationId:o,resolved:r,text:s}=await e.json();if(!o)return i.NextResponse.json({error:"annotationId \xe9 obrigat\xf3rio"},{status:400});let a={updated_at:new Date().toISOString()};void 0!==r&&(a.resolved=r),void 0!==s&&(a.text=s);let{data:n,error:u}=await t.from("post_annotations").update(a).eq("id",o).select().single();if(u)throw u;return i.NextResponse.json({success:!0,annotation:n})}catch(e){return console.error("Erro ao atualizar anota\xe7\xe3o:",e),i.NextResponse.json({error:e.message},{status:500})}}async function x(e){let t=(0,u.createRouteHandlerClient)({cookies:l.cookies}),{data:{user:o},error:r}=await t.auth.getUser();if(r||!o)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let{searchParams:s}=new URL(e.url),a=s.get("annotationId");if(!a)return i.NextResponse.json({error:"annotationId \xe9 obrigat\xf3rio"},{status:400});try{let{data:e,error:r}=await t.from("post_annotations").select("author_id").eq("id",a).single();if(r)throw r;let{data:s}=await t.from("user_profiles").select("user_type").eq("id",o.id).single(),n=s?.user_type==="super_admin"||s?.user_type==="admin",u=e.author_id===o.id;if(!n&&!u)return i.NextResponse.json({error:"Sem permiss\xe3o para excluir"},{status:403});let{error:l}=await t.from("post_annotations").delete().eq("id",a);if(l)throw l;return i.NextResponse.json({success:!0})}catch(e){return console.error("Erro ao excluir anota\xe7\xe3o:",e),i.NextResponse.json({error:e.message},{status:500})}}let f=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/posts/annotations/route",pathname:"/api/posts/annotations",filename:"route",bundlePath:"app/api/posts/annotations/route"},resolvedPagePath:"C:\\Users\\User\\Downloads\\valle-360-main\\valle-360-main\\src\\app\\api\\posts\\annotations\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:_,staticGenerationAsyncStorage:m,serverHooks:g}=f,h="/api/posts/annotations/route";function v(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[89276,55972,54128,20958],()=>o(95999));module.exports=r})();